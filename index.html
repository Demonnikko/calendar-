<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>Illusionist OS</title>

  <!-- PWA-ish -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Illusionist OS">
  <link rel="apple-touch-icon" href="icon.png">
  <link rel="icon" type="image/png" href="icon.png">

  <!-- IMPORTANT: lock stable app height for iOS (prevents jump on modal/keyboard) -->
  <script>
    (function () {
      function setAppHeight() {
        const vv = window.visualViewport;
        const h = Math.round((vv && vv.height) ? vv.height : window.innerHeight);
        document.documentElement.style.setProperty('--app-h', h + 'px');
        document.documentElement.style.setProperty('--sheet-h', Math.round(h * 0.92) + 'px');
      }
      setAppHeight();
      window.addEventListener('resize', () => setTimeout(setAppHeight, 60), { passive: true });
      window.addEventListener('orientationchange', () => setTimeout(setAppHeight, 180), { passive: true });
      if (window.visualViewport) {
        window.visualViewport.addEventListener('resize', () => setTimeout(setAppHeight, 60), { passive: true });
        window.visualViewport.addEventListener('scroll', () => setTimeout(setAppHeight, 60), { passive: true });
      }
      document.addEventListener('DOMContentLoaded', setAppHeight, { passive: true });
    })();
  </script>

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;800&family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">

  <style>
    :root{
      --gold-primary:#f59e0b;
      --dark-bg:#050507;
      --card-surface:rgba(255,255,255,0.03);
      --card-border:rgba(255,255,255,0.06);

      --safe-top: env(safe-area-inset-top, 0px);
      --safe-bottom: env(safe-area-inset-bottom, 0px);

      --bottom-nav-h: 64px;
      --bottom-nav-gap: 12px;
      --bottom-nav-total: calc(var(--bottom-nav-h) + var(--bottom-nav-gap) + var(--safe-bottom));

      /* stable heights (set by JS) */
      --app-h: 100vh;
      --sheet-h: 92vh;
    }

    html, body{
      width:100%;
      height:100%;
      overflow:hidden;
      overscroll-behavior:none;
      background:var(--dark-bg);
      -webkit-text-size-adjust: 100%;
    }

    body{
      font-family:'Inter',sans-serif;
      color:#e2e8f0;
      margin:0;
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
    }

    h1,h2,h3,.font-display{ font-family:'Cinzel',serif; }

    /* Prevent iOS input zoom */
    input, select, textarea { font-size:16px; }

    .noise-overlay{
      position:fixed; inset:0;
      pointer-events:none; z-index:0; opacity:.03;
      background-image:url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.65' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)'/%3E%3C/svg%3E");
    }

    .glass-panel{
      background:linear-gradient(180deg, rgba(30,41,59,.72) 0%, rgba(15,23,42,.62) 100%);
      backdrop-filter:blur(24px);
      -webkit-backdrop-filter:blur(24px);
      border:1px solid rgba(255,255,255,.08);
      box-shadow:0 4px 30px rgba(0,0,0,.5), inset 0 0 0 1px rgba(255,255,255,.05);
    }

    ::-webkit-scrollbar{ width:4px; }
    ::-webkit-scrollbar-track{ background:transparent; }
    ::-webkit-scrollbar-thumb{ background:rgba(255,255,255,.1); border-radius:10px; }

    #bg-canvas{ position:fixed; inset:0; z-index:-1; }

    input[type="time"]::-webkit-calendar-picker-indicator,
    input[type="date"]::-webkit-calendar-picker-indicator{
      filter:invert(1);
      opacity:.5;
      cursor:pointer;
    }

    .is-hidden{ display:none !important; }

    .pb-safe{ padding-bottom: var(--safe-bottom); }
    .pt-safe{ padding-top: var(--safe-top); }

    .pb-under-nav{ padding-bottom: calc(var(--bottom-nav-total) + 18px) !important; }
    .mb-under-nav{ margin-bottom: calc(var(--bottom-nav-total) + 18px) !important; }

    button{ min-height:44px; }

    /* Calendar cells */
    .calendar-cell{
      position:relative;
      background:var(--card-surface);
      border:1px solid var(--card-border);
      border-radius:14px;
      overflow:hidden;
      transition:all .18s ease;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:flex-start;
      padding-top:7px;
      gap:6px;
    }
    .calendar-cell:active{ transform:scale(.99); }
    .calendar-cell.selected{
      border-color:rgba(245,158,11,.45);
      box-shadow:0 0 16px rgba(245,158,11,.12);
      background:rgba(245,158,11,.06);
    }
    .calendar-cell.today .date-number{
      background:linear-gradient(135deg,#fbbf24,#d97706);
      color:#000;
      font-weight:800;
      box-shadow:0 2px 5px rgba(245,158,11,.3);
    }

    .date-number{
      font-size:11px; font-weight:600; color:rgba(255,255,255,.62);
      width:22px; height:22px;
      display:flex; align-items:center; justify-content:center;
      border-radius:7px;
    }

    /* No words in calendar: only color markers */
    .calendar-markers{
      width:100%;
      display:flex;
      flex-direction:column;
      gap:4px;
      padding:0 6px 6px;
      align-items:stretch;
      justify-content:flex-start;
    }
    .event-marker{
      height:8px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.08);
      opacity:.95;
    }
    .event-marker:active{ transform:scale(.99); }

    .event-stage{ background:rgba(245,158,11,.25); border-color:rgba(245,158,11,.28); }
    .event-closeup{ background:rgba(168,85,247,.22); border-color:rgba(168,85,247,.26); }
    .event-kids{ background:rgba(16,185,129,.22); border-color:rgba(16,185,129,.26); }
    .event-concert{ background:rgba(59,130,246,.22); border-color:rgba(59,130,246,.26); }
    .event-rehearsal{ background:rgba(148,163,184,.18); border-color:rgba(148,163,184,.20); }

    .month-summary{
      margin-top:auto; margin-bottom:6px;
      background:linear-gradient(90deg,transparent,rgba(245,158,11,.10),transparent);
      border-top:1px solid rgba(245,158,11,.18);
      border-bottom:1px solid rgba(245,158,11,.18);
      padding:3px 0;
      font-size:8px;
      width:84%;
      text-align:center;
      text-transform:uppercase;
      font-weight:800;
      color:#fbbf24;
      letter-spacing:1.7px;
    }

    .confetti{ position:absolute; width:8px; height:8px; background-color:#f59e0b; animation:fall linear forwards; z-index:9999; }
    @keyframes fall{ to{ transform:translateY(100vh) rotate(720deg); opacity:0; } }

    #mobile-bottom-nav{
      position:fixed;
      left:16px;
      right:16px;
      height:64px;
      bottom: calc(var(--safe-bottom) + 0px);
      z-index:60;
    }

    #toast{
      position:fixed;
      left:16px;
      right:16px;
      top: calc(var(--safe-top) + 12px);
      z-index:300;
      transform: translateY(-12px);
      opacity:0;
      transition: all .25s ease;
      pointer-events:none;
    }
    #toast.show{
      transform: translateY(0);
      opacity:1;
    }

    .flash-highlight{
      outline: 2px solid rgba(245,158,11,.35);
      box-shadow: 0 0 0 3px rgba(245,158,11,.08);
      transition: all .2s ease;
    }

    select{
      background: rgba(0,0,0,.25);
      border: 1px solid rgba(255,255,255,.10);
      color: rgba(255,255,255,.9);
      outline: none;
    }
    select:focus{
      border-color: rgba(245,158,11,.35);
    }

    .act-row{
      display:grid;
      grid-template-columns: 40px 1fr 88px 30px;
      gap:8px;
      align-items:center;
      background:rgba(255,255,255,.03);
      border:1px solid rgba(255,255,255,.06);
      border-radius:12px;
      padding:10px;
      margin-bottom:10px;
    }

    /* Month navigator rows */
    .mn-row{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding:10px 12px;
      border-radius:14px;
      background: rgba(255,255,255,.04);
      border: 1px solid rgba(255,255,255,.06);
      cursor:pointer;
      transition: all .15s ease;
    }
    .mn-row:active{
      border-color: rgba(245,158,11,.28);
      background: rgba(245,158,11,.07);
      transform: scale(.995);
    }
    .mn-chip{
      font-size:9px;
      letter-spacing:.12em;
      text-transform:uppercase;
      font-weight:800;
      padding:4px 10px;
      border-radius:999px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
      color: rgba(226,232,240,.92);
      white-space:nowrap;
    }

    /* ---- FIX: prevent background jump/scroll on iOS when modal opens ---- */
    body.modal-open #view-dashboard,
    body.modal-open #calendar-grid{
      overflow: hidden !important;
      -webkit-overflow-scrolling: auto !important;
      overscroll-behavior: none !important;
    }

    /* make sheet use stable height */
    .bottom-sheet{
      height: var(--sheet-h);
    }
  </style>
</head>

<body class="pt-safe">

  <div class="noise-overlay"></div>
  <div class="fixed inset-0 bg-gradient-to-br from-indigo-900/20 via-transparent to-amber-900/10 pointer-events-none z-[-1]"></div>
  <canvas id="bg-canvas"></canvas>
  <div id="confetti-container" class="fixed inset-0 pointer-events-none z-[200]"></div>

  <div id="toast" class="glass-panel rounded-2xl px-4 py-3 flex items-center gap-3">
    <div class="w-9 h-9 rounded-xl bg-white/5 border border-white/10 flex items-center justify-center">
      <i data-lucide="sparkles" class="w-5 h-5 text-amber-400"></i>
    </div>
    <div class="min-w-0">
      <div class="text-[10px] text-slate-400 uppercase tracking-widest font-bold">Illusionist OS</div>
      <div id="toast-msg" class="text-sm text-white font-semibold truncate">...</div>
    </div>
  </div>

  <!-- APP SHELL (mobile only layout) -->
  <div id="app-shell"
       class="relative z-10 w-full flex flex-col px-4 pb-under-nav"
       style="height: var(--app-h);">

    <!-- HEADER -->
    <header class="flex justify-between items-center mt-2 mb-3 shrink-0 gap-2">
      <div class="flex items-center gap-3 overflow-hidden">
        <div class="relative w-11 h-11 flex-shrink-0 flex items-center justify-center rounded-2xl bg-[#0f0f13] border border-amber-500/20 shadow-[0_4px_12px_rgba(0,0,0,0.5)]">
          <div class="absolute inset-0 rounded-2xl bg-gradient-to-tr from-amber-500/10 to-transparent opacity-50"></div>
          <i data-lucide="calendar" class="relative z-10 w-6 h-6 text-amber-500 drop-shadow-[0_2px_4px_rgba(245,158,11,0.25)]"></i>
        </div>

        <div class="min-w-0 flex flex-col justify-center">
          <h1 class="text-[10px] font-bold text-transparent bg-clip-text bg-gradient-to-r from-amber-200 to-amber-600 truncate leading-tight tracking-widest font-display">
            ILLUSIONIST OS
          </h1>
          <span class="text-[9px] text-slate-500 font-bold tracking-[0.2em] uppercase leading-none mt-0.5">Calendar</span>
        </div>
      </div>

      <div class="flex items-center gap-2 flex-shrink-0">
        <div class="flex items-center glass-panel p-0.5 rounded-xl h-10">
          <button onclick="window.changeMonth(-1)" class="w-10 h-full flex items-center justify-center hover:bg-white/10 rounded-lg text-slate-300 active:scale-[0.98] transition">
            <i data-lucide="chevron-left" class="w-5 h-5"></i>
          </button>
          <button onclick="window.openMonthPicker()" id="current-month-display" class="px-3 text-center font-display font-bold text-sm whitespace-nowrap min-w-[110px] hover:text-amber-400 transition cursor-pointer"></button>
          <button onclick="window.changeMonth(1)" class="w-10 h-full flex items-center justify-center hover:bg-white/10 rounded-lg text-slate-300 active:scale-[0.98] transition">
            <i data-lucide="chevron-right" class="w-5 h-5"></i>
          </button>
        </div>

        <button onclick="window.goToToday()" class="w-10 h-10 flex items-center justify-center glass-panel rounded-xl text-slate-300 hover:text-amber-400 hover:border-amber-500/30 active:scale-[0.98] transition" title="Сегодня">
          <i data-lucide="calendar-clock" class="w-5 h-5"></i>
        </button>

        <button onclick="window.openSettings()" class="w-10 h-10 flex items-center justify-center glass-panel rounded-xl text-slate-300 hover:text-amber-400 hover:border-amber-500/30 active:scale-[0.98] transition">
          <i data-lucide="settings" class="w-5 h-5"></i>
        </button>
      </div>
    </header>

    <!-- CONTENT -->
    <div class="flex-1 overflow-hidden relative">

      <!-- CALENDAR VIEW -->
      <div id="view-calendar" class="h-full w-full absolute inset-0 flex flex-col">
        <div class="glass-panel rounded-2xl p-3 flex flex-col h-full overflow-hidden">
          <div class="grid grid-cols-7 mb-2 border-b border-white/5 pb-2">
            <div class="text-center text-slate-500 text-[10px] font-bold uppercase">Пн</div>
            <div class="text-center text-slate-500 text-[10px] font-bold uppercase">Вт</div>
            <div class="text-center text-slate-500 text-[10px] font-bold uppercase">Ср</div>
            <div class="text-center text-slate-500 text-[10px] font-bold uppercase">Чт</div>
            <div class="text-center text-slate-500 text-[10px] font-bold uppercase">Пт</div>
            <div class="text-center text-slate-500 text-[10px] font-bold uppercase">Сб</div>
            <div class="text-center text-slate-500 text-[10px] font-bold uppercase">Вс</div>
          </div>
          <div id="calendar-grid" class="grid grid-cols-7 gap-2 flex-1 auto-rows-fr overflow-y-auto pb-under-nav"></div>
        </div>
      </div>

      <!-- DASHBOARD VIEW -->
      <div id="view-dashboard" class="h-full w-full absolute inset-0 overflow-y-auto pb-under-nav is-hidden">
        <div class="flex flex-col gap-4">
          <!-- FINANCE CARD -->
          <div class="glass-panel rounded-2xl p-4">
            <div class="flex justify-between items-center mb-3">
              <h3 class="text-xs font-bold text-amber-500 uppercase tracking-widest flex items-center gap-2">
                <i data-lucide="layout-dashboard" class="w-4 h-4"></i> Финансы
              </h3>
            </div>

            <div class="text-center mb-3 relative">
              <span id="stat-profit" class="text-3xl font-display font-bold text-white tracking-tight">0</span>
              <span class="text-lg text-slate-500 font-display ml-1">₽</span>
              <div id="goal-badge" class="hidden absolute -top-2 -right-2 bg-gradient-to-r from-amber-400 to-yellow-300 text-black text-[9px] font-bold px-2 py-0.5 rounded-full shadow-lg animate-bounce">
                ЦЕЛЬ!
              </div>
            </div>

            <div class="mb-3">
              <div class="flex justify-between text-xs mb-1 text-slate-400">
                <span>Цель</span>
                <span id="goal-amount" class="cursor-pointer hover:text-white border-b border-dashed border-slate-600" onclick="window.editGoal()">200k ₽</span>
              </div>
              <div class="h-1.5 w-full bg-slate-800 rounded-full overflow-hidden relative">
                <div id="goal-progress" class="h-full bg-gradient-to-r from-amber-700 to-yellow-400 transition-all duration-1000" style="width: 0%"></div>
              </div>
            </div>

            <div class="flex justify-between text-xs text-slate-400 mb-3">
              <span id="goal-remaining">Осталось: 0 ₽</span>
              <span id="goal-pace">Темп: 0 ₽/д</span>
            </div>

            <div class="grid grid-cols-2 gap-2 text-center mb-4">
              <div class="bg-white/5 p-2 rounded-xl border border-white/10">
                <p class="text-[9px] text-slate-500 uppercase">Доход</p>
                <p id="stat-income" class="text-sm font-bold text-emerald-400">0</p>
              </div>
              <div class="bg-white/5 p-2 rounded-xl border border-white/10">
                <p class="text-[9px] text-slate-500 uppercase">Расход</p>
                <p id="stat-expense" class="text-sm font-bold text-red-400">0</p>
              </div>
            </div>

            <div class="pt-3 border-t border-white/5">
              <div class="flex justify-between items-center mb-3">
                <h3 class="text-xs font-bold text-amber-500 uppercase tracking-widest flex items-center gap-2">
                  <i data-lucide="bar-chart-2" class="w-4 h-4"></i> Типы событий
                </h3>
              </div>
              <div id="analytics-list" class="space-y-3"></div>
            </div>
          </div>

          <!-- DAY CARD -->
          <div class="glass-panel rounded-2xl flex flex-col min-h-[520px] overflow-hidden">
            <div class="p-4 border-b border-white/5 bg-slate-900/30">
              <div class="flex justify-between items-start gap-3">
                <div class="w-full min-w-0">
                  <h2 id="selected-date-big" class="text-3xl font-display font-bold text-white"></h2>
                  <p id="selected-weekday" class="text-amber-500 text-[10px] uppercase font-bold tracking-widest"></p>

                  <div id="jumper-wrap" class="mt-3 hidden">
                    <label class="block text-[9px] text-slate-500 uppercase font-bold tracking-widest mb-1">Быстрый переход (день)</label>
                    <select id="event-jumper" class="w-full rounded-xl px-3 py-2 text-sm">
                      <option value="">—</option>
                    </select>
                  </div>

                  <div id="month-nav-wrap" class="mt-4">
                    <div class="flex items-center justify-between">
                      <label class="block text-[9px] text-slate-500 uppercase font-bold tracking-widest mb-1">Навигатор месяца</label>
                      <div class="text-[9px] text-slate-500 font-mono" id="month-nav-count">0</div>
                    </div>

                    <div class="grid grid-cols-1 gap-2">
                      <div class="relative">
                        <input id="month-search" type="text" placeholder="Поиск: название, локация, клиент, доп..."
                          class="w-full bg-black/25 border border-white/10 rounded-xl pl-10 pr-3 py-3 text-white outline-none focus:border-amber-500/40">
                        <i data-lucide="search" class="w-4 h-4 text-slate-500 absolute left-3 top-1/2 -translate-y-1/2"></i>
                      </div>

                      <select id="month-filter" class="rounded-xl px-3 py-3">
                        <option value="all">Все типы</option>
                        <option value="stage">Сцена</option>
                        <option value="closeup">Микро</option>
                        <option value="kids">Дети</option>
                        <option value="concert">Концерт</option>
                        <option value="rehearsal">Репетиция</option>
                      </select>
                    </div>

                    <div id="month-results" class="mt-2 space-y-2 max-h-[220px] overflow-y-auto pr-1"></div>
                  </div>

                </div>
              </div>
            </div>

            <div id="events-list" class="flex-1 overflow-y-auto p-3 space-y-3 pb-under-nav"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- MOBILE BOTTOM NAV -->
  <div id="mobile-bottom-nav" class="bg-[#0f172a]/90 backdrop-blur-xl border border-white/10 rounded-2xl shadow-2xl flex items-center justify-between px-6">
    <button onclick="window.switchMobileTab('calendar')" id="nav-calendar" class="flex flex-col items-center justify-center gap-1 text-amber-400 w-16 transition-all duration-200">
      <i data-lucide="calendar" class="w-5 h-5"></i>
      <span class="text-[9px] font-bold tracking-wide">Календарь</span>
    </button>

    <button onclick="window.openModal(false)" class="relative -top-6 w-14 h-14 rounded-full bg-gradient-to-br from-amber-400 to-orange-600 text-white shadow-lg shadow-orange-500/40 flex items-center justify-center active:scale-95 transition border-4 border-[#050507]">
      <i data-lucide="plus" class="w-7 h-7"></i>
    </button>

    <button onclick="window.switchMobileTab('dashboard')" id="nav-dashboard" class="flex flex-col items-center justify-center gap-1 text-slate-500 w-16 transition-all duration-200">
      <i data-lucide="layout-list" class="w-5 h-5"></i>
      <span class="text-[9px] font-bold tracking-wide">Дашборд</span>
    </button>
  </div>

  <!-- EVENT MODAL -->
  <div id="event-modal" class="fixed inset-0 z-[100] hidden">
    <div class="absolute inset-0 bg-slate-950/90 backdrop-blur-sm" onclick="window.closeModal()"></div>

    <!-- sheet -->
    <div class="bottom-sheet absolute bottom-0 left-0 right-0 w-full bg-[#0f172a] border-t border-amber-500/20 rounded-t-3xl shadow-2xl flex flex-col overflow-hidden">

      <div class="p-4 border-b border-white/5 flex justify-between items-center bg-white/5 shrink-0">
        <h3 class="text-lg font-display font-bold text-white text-center w-full ml-8" id="modal-title">Новое Событие</h3>
        <button onclick="window.closeModal()" class="p-2 bg-white/5 rounded-full hover:bg-white/10 active:scale-[0.98] transition">
          <i data-lucide="x" class="w-5 h-5 text-slate-300"></i>
        </button>
      </div>

      <div class="flex p-1.5 bg-black/20 gap-1 mx-4 mt-4 rounded-xl shrink-0 justify-center">
        <button onclick="window.switchTab('info')" id="tab-btn-info" class="tab-active flex-1 py-2 text-[10px] font-bold uppercase rounded-xl transition">Инфо</button>
        <button onclick="window.switchTab('setlist')" id="tab-btn-setlist" class="flex-1 py-2 text-[10px] font-bold uppercase text-slate-500 rounded-xl transition">Доп</button>
        <button onclick="window.switchTab('finance')" id="tab-btn-finance" class="flex-1 py-2 text-[10px] font-bold uppercase text-slate-500 rounded-xl transition">Касса</button>
        <button onclick="window.switchTab('notes')" id="tab-btn-notes" class="flex-1 py-2 text-[10px] font-bold uppercase text-slate-500 rounded-xl transition">Заметки</button>
      </div>

      <div class="p-5 overflow-y-auto overflow-x-hidden flex-1 pb-under-nav">
        <div id="tab-info" class="space-y-4 max-w-xs mx-auto">

          <div class="grid grid-cols-5 gap-3">
            <button onclick="window.setType('stage')" id="type-stage" class="type-btn group relative p-3 rounded-2xl border border-amber-500 bg-amber-500/10 text-amber-400 flex flex-col items-center gap-2 overflow-hidden transition-all selected">
              <i data-lucide="star" class="w-5 h-5"></i>
              <span class="text-[9px] font-bold uppercase tracking-wider">Сцена</span>
            </button>

            <button onclick="window.setType('closeup')" id="type-closeup" class="type-btn group relative p-3 rounded-2xl border border-white/5 bg-white/5 text-slate-500 hover:bg-white/10 flex flex-col items-center gap-2 overflow-hidden transition-all">
              <i data-lucide="sparkles" class="w-5 h-5"></i>
              <span class="text-[9px] font-bold uppercase tracking-wider">Микро</span>
            </button>

            <button onclick="window.setType('kids')" id="type-kids" class="type-btn group relative p-3 rounded-2xl border border-white/5 bg-white/5 text-slate-500 hover:bg-white/10 flex flex-col items-center gap-2 overflow-hidden transition-all">
              <i data-lucide="rabbit" class="w-5 h-5"></i>
              <span class="text-[9px] font-bold uppercase tracking-wider">Дети</span>
            </button>

            <button onclick="window.setType('concert')" id="type-concert" class="type-btn group relative p-3 rounded-2xl border border-white/5 bg-white/5 text-slate-500 hover:bg-white/10 flex flex-col items-center gap-2 overflow-hidden transition-all">
              <i data-lucide="mic-2" class="w-5 h-5"></i>
              <span class="text-[9px] font-bold uppercase tracking-wider">Конц</span>
            </button>

            <button onclick="window.setType('rehearsal')" id="type-rehearsal" class="type-btn group relative p-3 rounded-2xl border border-white/5 bg-white/5 text-slate-500 hover:bg-white/10 flex flex-col items-center gap-2 overflow-hidden transition-all">
              <i data-lucide="hourglass" class="w-5 h-5"></i>
              <span class="text-[9px] font-bold uppercase tracking-wider">Реп</span>
            </button>
          </div>

          <input type="text" id="inp-title" placeholder="Название (напр. Свадьба)"
                 class="w-full bg-black/30 border border-white/10 rounded-2xl p-4 text-white text-lg focus:border-amber-500/50 outline-none transition-colors text-center font-bold">

          <div>
            <label class="text-[10px] text-slate-500 uppercase font-bold mb-1 block pl-1 text-center">Дата</label>
            <input type="date" id="inp-date"
                   class="w-full bg-black/30 border border-white/10 rounded-2xl p-3 text-white outline-none transition-colors focus:border-amber-500/50 text-center">
          </div>

          <div class="bg-white/5 rounded-2xl border border-white/10 p-3">
            <label class="text-[10px] text-amber-500 uppercase font-bold mb-2 block text-center">Тайминг Выступлений</label>
            <div id="schedule-list" class="space-y-2 mb-3"></div>
            <button onclick="window.addAct()" class="w-full py-3 rounded-xl bg-white/5 border border-white/10 text-sm text-slate-200 hover:bg-white/10 transition flex items-center justify-center gap-2 active:scale-[0.99]">
              <i data-lucide="plus" class="w-4 h-4"></i> Добавить выход
            </button>
          </div>

          <div>
            <label class="text-[10px] text-slate-500 uppercase font-bold mb-1 block pl-1 text-center">Локация</label>
            <input type="text" id="inp-location" placeholder="Ресторан..."
                   class="w-full bg-black/30 border border-white/10 rounded-2xl p-3 text-white outline-none transition-colors focus:border-amber-500/50 text-center">
          </div>

          <div class="grid grid-cols-1 gap-3 pt-2 border-t border-white/5">
            <input type="text" id="inp-client-name" placeholder="Имя Клиента"
                   class="w-full bg-black/30 border border-white/10 rounded-2xl p-3 text-white outline-none transition-colors focus:border-amber-500/50 text-center">
            <input type="tel" id="inp-client-phone" placeholder="Телефон"
                   class="w-full bg-black/30 border border-white/10 rounded-2xl p-3 text-white outline-none transition-colors focus:border-amber-500/50 text-center">
          </div>
        </div>

        <div id="tab-setlist" class="hidden space-y-3 max-w-xs mx-auto">
          <div class="text-center text-slate-400 text-xs">
            Добавь пункты “доп” (условия, реквизит, договор, дедлайны) — они будут видны на карточке события.
          </div>
          <div class="flex gap-2">
            <input type="text" id="inp-trick" placeholder="Пункт доп..."
                   class="flex-1 bg-black/30 border border-white/10 rounded-2xl p-3 text-white outline-none">
            <button onclick="window.addTrick()" class="bg-amber-600 px-4 rounded-2xl text-white active:scale-[0.98]">
              <i data-lucide="plus"></i>
            </button>
          </div>
          <ul id="setlist-container" class="space-y-2 text-sm text-slate-300 pb-4"></ul>
        </div>

        <div id="tab-finance" class="hidden space-y-4 max-w-xs mx-auto">
          <div class="p-3 bg-emerald-500/5 border border-emerald-500/20 rounded-2xl text-center">
            <label class="text-[10px] text-emerald-400 font-bold uppercase block mb-1">Общая стоимость</label>
            <input type="number" id="inp-income" placeholder="0"
                   class="w-full bg-transparent text-2xl font-mono text-white outline-none text-center"
                   oninput="window.calcBalanceFromAmount()">
          </div>

          <div class="grid grid-cols-2 gap-3">
            <div class="p-3 bg-white/5 border border-white/10 rounded-2xl text-center">
              <label class="text-[10px] text-slate-400 font-bold uppercase block mb-1">Предоплата</label>
              <input type="number" id="inp-prepay" placeholder="0"
                     class="w-full bg-transparent text-lg font-mono text-white outline-none text-center"
                     oninput="window.calcBalanceFromAmount()">
            </div>

            <div class="p-3 bg-white/5 border border-white/10 rounded-2xl text-center">
              <label class="text-[10px] text-slate-400 font-bold uppercase block mb-1">%</label>
              <input type="text" id="inp-prepay-percent" placeholder="0"
                     class="w-full bg-transparent text-lg font-mono text-amber-400 outline-none text-center"
                     inputmode="decimal" oninput="window.calcBalanceFromPercent()">
            </div>
          </div>

          <div class="p-3 bg-white/5 border border-white/10 rounded-2xl text-center flex flex-col justify-center">
            <label class="text-[10px] text-slate-400 font-bold uppercase block mb-0.5">Остаток</label>
            <span id="txt-balance" class="text-lg font-mono text-slate-500 font-bold">0</span>
          </div>

          <div class="p-3 bg-red-500/5 border border-red-500/20 rounded-2xl text-center">
            <label class="text-[10px] text-red-400 font-bold uppercase block mb-1">Расход</label>
            <input type="number" id="inp-expense" placeholder="0"
                   class="w-full bg-transparent text-xl font-mono text-white outline-none text-center">
          </div>
        </div>

        <div id="tab-notes" class="hidden max-w-xs mx-auto">
          <textarea id="inp-notes" placeholder="Заметки..."
                    class="w-full h-44 bg-black/30 border border-white/10 rounded-2xl p-3 text-white resize-none outline-none text-sm"></textarea>
        </div>
      </div>

      <div class="p-5 border-t border-white/5 bg-slate-900/80 pb-[calc(16px+var(--safe-bottom))] shrink-0 flex flex-col gap-3 items-center">
        <button onclick="window.saveEvent()" class="w-full max-w-xs py-3 rounded-2xl bg-gradient-to-r from-amber-500 to-orange-600 text-white font-bold shadow-lg text-lg active:scale-[0.99] transition">
          Сохранить
        </button>
        <button id="btn-delete" onclick="window.deleteEventFromModal()" class="w-full max-w-xs py-3 rounded-2xl border border-red-500/30 text-red-400 font-bold hover:bg-red-500/10 active:scale-[0.99] transition hidden">
          Удалить
        </button>
      </div>
    </div>
  </div>

  <!-- MONTH PICKER -->
  <div id="month-picker-modal" class="fixed inset-0 z-[130] hidden flex items-center justify-center p-4">
    <div class="absolute inset-0 bg-slate-950/90 backdrop-blur-sm" onclick="window.closeMonthPicker()"></div>
    <div class="relative w-full max-w-sm bg-[#0f172a] border border-amber-500/20 rounded-2xl shadow-2xl p-6 flex flex-col items-center">
      <div class="flex items-center justify-between w-full mb-6">
        <button onclick="window.changePickerYear(-1)" class="p-2 hover:bg-white/10 rounded-xl text-slate-300 active:scale-[0.98] transition">
          <i data-lucide="chevron-left" class="w-6 h-6"></i>
        </button>
        <span id="picker-year-display" class="text-2xl font-display font-bold text-white tracking-widest">2024</span>
        <button onclick="window.changePickerYear(1)" class="p-2 hover:bg-white/10 rounded-xl text-slate-300 active:scale-[0.98] transition">
          <i data-lucide="chevron-right" class="w-6 h-6"></i>
        </button>
      </div>
      <div class="grid grid-cols-3 gap-3 w-full">
        <button onclick="window.selectMonth(0)" class="month-btn p-3 rounded-2xl border border-white/5 bg-white/5 text-slate-300 hover:bg-amber-500/20 hover:border-amber-500/50 hover:text-amber-400 transition font-bold text-sm">ЯНВ</button>
        <button onclick="window.selectMonth(1)" class="month-btn p-3 rounded-2xl border border-white/5 bg-white/5 text-slate-300 hover:bg-amber-500/20 hover:border-amber-500/50 hover:text-amber-400 transition font-bold text-sm">ФЕВ</button>
        <button onclick="window.selectMonth(2)" class="month-btn p-3 rounded-2xl border border-white/5 bg-white/5 text-slate-300 hover:bg-amber-500/20 hover:border-amber-500/50 hover:text-amber-400 transition font-bold text-sm">МАР</button>
        <button onclick="window.selectMonth(3)" class="month-btn p-3 rounded-2xl border border-white/5 bg-white/5 text-slate-300 hover:bg-amber-500/20 hover:border-amber-500/50 hover:text-amber-400 transition font-bold text-sm">АПР</button>
        <button onclick="window.selectMonth(4)" class="month-btn p-3 rounded-2xl border border-white/5 bg-white/5 text-slate-300 hover:bg-amber-500/20 hover:border-amber-500/50 hover:text-amber-400 transition font-bold text-sm">МАЙ</button>
        <button onclick="window.selectMonth(5)" class="month-btn p-3 rounded-2xl border border-white/5 bg-white/5 text-slate-300 hover:bg-amber-500/20 hover:border-amber-500/50 hover:text-amber-400 transition font-bold text-sm">ИЮН</button>
        <button onclick="window.selectMonth(6)" class="month-btn p-3 rounded-2xl border border-white/5 bg-white/5 text-slate-300 hover:bg-amber-500/20 hover:border-amber-500/50 hover:text-amber-400 transition font-bold text-sm">ИЮЛ</button>
        <button onclick="window.selectMonth(7)" class="month-btn p-3 rounded-2xl border border-white/5 bg-white/5 text-slate-300 hover:bg-amber-500/20 hover:border-amber-500/50 hover:text-amber-400 transition font-bold text-sm">АВГ</button>
        <button onclick="window.selectMonth(8)" class="month-btn p-3 rounded-2xl border border-white/5 bg-white/5 text-slate-300 hover:bg-amber-500/20 hover:border-amber-500/50 hover:text-amber-400 transition font-bold text-sm">СЕН</button>
        <button onclick="window.selectMonth(9)" class="month-btn p-3 rounded-2xl border border-white/5 bg-white/5 text-slate-300 hover:bg-amber-500/20 hover:border-amber-500/50 hover:text-amber-400 transition font-bold text-sm">ОКТ</button>
        <button onclick="window.selectMonth(10)" class="month-btn p-3 rounded-2xl border border-white/5 bg-white/5 text-slate-300 hover:bg-amber-500/20 hover:border-amber-500/50 hover:text-amber-400 transition font-bold text-sm">НОЯ</button>
        <button onclick="window.selectMonth(11)" class="month-btn p-3 rounded-2xl border border-white/5 bg-white/5 text-slate-300 hover:bg-amber-500/20 hover:border-amber-500/50 hover:text-amber-400 transition font-bold text-sm">ДЕК</button>
      </div>
      <button onclick="window.closeMonthPicker()" class="mt-8 text-slate-500 text-xs hover:text-white transition">Закрыть</button>
    </div>
  </div>

  <!-- SETTINGS MODAL -->
  <div id="settings-modal" class="fixed inset-0 z-[140] hidden flex items-center justify-center p-4">
    <div class="absolute inset-0 bg-slate-950/90 backdrop-blur-sm" onclick="window.closeSettings()"></div>
    <div class="relative w-full max-w-md bg-[#0f172a] border border-amber-500/20 rounded-2xl shadow-2xl overflow-hidden">
      <div class="p-4 border-b border-white/5 bg-white/5 flex items-center justify-between">
        <div class="flex items-center gap-2">
          <i data-lucide="settings" class="w-5 h-5 text-amber-400"></i>
          <div class="font-display font-bold text-white tracking-widest">Настройки</div>
        </div>
        <button onclick="window.closeSettings()" class="p-2 bg-white/5 rounded-full hover:bg-white/10 active:scale-[0.98] transition">
          <i data-lucide="x" class="w-5 h-5 text-slate-300"></i>
        </button>
      </div>

      <div class="p-4 space-y-3 max-h-[70vh] overflow-y-auto">
        <button onclick="window.editGoal()" class="w-full glass-panel rounded-2xl p-3 flex items-center justify-between hover:border-amber-500/30 transition">
          <div class="flex items-center gap-3">
            <i data-lucide="target" class="w-5 h-5 text-amber-400"></i>
            <div>
              <div class="text-white font-semibold">Цель месяца</div>
              <div class="text-xs text-slate-400">Изменить сумму цели</div>
            </div>
          </div>
          <i data-lucide="chevron-right" class="w-5 h-5 text-slate-500"></i>
        </button>

        <button onclick="window.exportData()" class="w-full glass-panel rounded-2xl p-3 flex items-center justify-between hover:border-amber-500/30 transition">
          <div class="flex items-center gap-3">
            <i data-lucide="download" class="w-5 h-5 text-emerald-400"></i>
            <div>
              <div class="text-white font-semibold">Экспорт данных</div>
              <div class="text-xs text-slate-400">Скачать архив JSON</div>
            </div>
          </div>
          <i data-lucide="chevron-right" class="w-5 h-5 text-slate-500"></i>
        </button>

        <div class="glass-panel rounded-2xl p-3">
          <div class="flex items-center gap-3 mb-2">
            <i data-lucide="upload" class="w-5 h-5 text-blue-400"></i>
            <div>
              <div class="text-white font-semibold">Импорт данных</div>
              <div class="text-xs text-slate-400">Загрузить архив JSON</div>
            </div>
          </div>
          <input id="import-file" type="file" accept="application/json" class="w-full text-xs text-slate-400" onchange="window.importData(this)">
        </div>

        <button onclick="window.resetData()" class="w-full glass-panel rounded-2xl p-3 flex items-center justify-between hover:border-red-500/30 transition">
          <div class="flex items-center gap-3">
            <i data-lucide="trash-2" class="w-5 h-5 text-red-400"></i>
            <div>
              <div class="text-white font-semibold">Сбросить данные</div>
              <div class="text-xs text-slate-400">Удалит события и цель</div>
            </div>
          </div>
          <i data-lucide="chevron-right" class="w-5 h-5 text-slate-500"></i>
        </button>
      </div>

      <div class="p-4 border-t border-white/5 bg-slate-900/60 flex justify-end">
        <button onclick="window.closeSettings()" class="px-4 py-2 rounded-2xl bg-white/5 border border-white/10 text-slate-200 hover:bg-white/10 active:scale-[0.98] transition">Закрыть</button>
      </div>
    </div>
  </div>

  <!-- GOAL MODAL -->
  <div id="goal-modal" class="fixed inset-0 z-[150] hidden flex items-center justify-center p-4">
    <div class="absolute inset-0 bg-slate-950/90 backdrop-blur-sm" onclick="window.closeGoalModal()"></div>
    <div class="relative w-full max-w-sm bg-[#0f172a] border border-amber-500/20 rounded-2xl shadow-2xl p-5">
      <div class="flex items-center justify-between mb-4">
        <div class="flex items-center gap-2">
          <i data-lucide="target" class="w-5 h-5 text-amber-400"></i>
          <div class="font-display font-bold text-white tracking-widest">Цель месяца</div>
        </div>
        <button onclick="window.closeGoalModal()" class="p-2 bg-white/5 rounded-full hover:bg-white/10 active:scale-[0.98] transition">
          <i data-lucide="x" class="w-5 h-5 text-slate-300"></i>
        </button>
      </div>

      <label class="text-[10px] text-slate-400 uppercase font-bold mb-1 block">Сумма (₽)</label>
      <input id="goal-input" type="number" inputmode="numeric"
             class="w-full bg-black/30 border border-white/10 rounded-2xl p-3 text-white outline-none focus:border-amber-500/50 text-center text-xl font-mono"
             placeholder="200000">

      <div class="flex gap-2 mt-4">
        <button onclick="window.closeGoalModal()" class="flex-1 py-3 rounded-2xl bg-white/5 border border-white/10 text-slate-200 hover:bg-white/10 active:scale-[0.98] transition">Отмена</button>
        <button onclick="window.saveGoalFromModal()" class="flex-1 py-3 rounded-2xl bg-gradient-to-r from-amber-500 to-orange-600 text-white font-bold hover:scale-[1.01] active:scale-[0.99] transition">Сохранить</button>
      </div>
    </div>
  </div>

  <script>
    const MONTHS = ["Январь","Февраль","Март","Апрель","Май","Июнь","Июль","Август","Сентябрь","Октябрь","Ноябрь","Декабрь"];
    const TYPES = {
      stage:   { label:'Сцена',       color:'event-stage',    text:'text-amber-100',  icon:'star',      border:'border-amber-500',  bar:'bg-amber-500',  defDur: 60 },
      closeup: { label:'Микромагия',   color:'event-closeup',  text:'text-purple-100', icon:'sparkles',  border:'border-purple-500', bar:'bg-purple-500', defDur: 40 },
      kids:    { label:'Детское шоу',  color:'event-kids',     text:'text-emerald-100',icon:'rabbit',    border:'border-emerald-500',bar:'bg-emerald-500',defDur: 45 },
      concert: { label:'Концерт',      color:'event-concert',  text:'text-blue-100',   icon:'mic-2',     border:'border-blue-500',   bar:'bg-blue-500',   defDur: 90 },
      rehearsal:{label:'Репетиция',   color:'event-rehearsal', text:'text-slate-200',  icon:'hourglass', border:'border-slate-500',  bar:'bg-slate-500',  defDur: 120 }
    };

    const pad2 = (n)=>String(n).padStart(2,'0');
    const toISODateLocal = (d)=>`${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;

    const parseNum = (v) => {
      const s = String(v ?? '').replace(/\s/g,'').replace(',','.');
      const n = Number(s);
      return Number.isFinite(n) ? n : 0;
    };

    let currentDate = new Date();
    let selectedDate = new Date();
    let pickerYear = new Date().getFullYear();
    let events = [];
    let monthlyGoal = 200000;
    let goalCelebrated = false;

    let currentType = 'stage';
    let currentSetlist = [];
    let currentSchedule = [];
    let editingId = null;

    // ---- FIX: scroll lock state (prevents iOS jump when opening sheet) ----
    let __scrollLock = { dashTop: 0, calTop: 0 };

    function lockBackgroundScroll() {
      const dash = document.getElementById('view-dashboard');
      const cal = document.getElementById('calendar-grid');
      __scrollLock.dashTop = dash ? dash.scrollTop : 0;
      __scrollLock.calTop = cal ? cal.scrollTop : 0;

      document.body.classList.add('modal-open');
    }

    function unlockBackgroundScroll() {
      const dash = document.getElementById('view-dashboard');
      const cal = document.getElementById('calendar-grid');

      document.body.classList.remove('modal-open');

      if (dash) dash.scrollTop = __scrollLock.dashTop;
      if (cal) cal.scrollTop = __scrollLock.calTop;
    }

    function renderApp(){
      renderCalendar();
      renderSidebar();
      renderStats();
      renderAnalytics();
      renderMonthNavigator();
      lucide.createIcons();
    }

    function primaryTypeOfEvent(e){
      return (e.schedule && e.schedule[0] && e.schedule[0].type) ? e.schedule[0].type : (e.type || 'stage');
    }

    function renderCalendar(){
      const year = currentDate.getFullYear();
      const month = currentDate.getMonth();
      document.getElementById('current-month-display').innerText = `${MONTHS[month]} ${year}`;

      const daysInMonth = new Date(year, month+1, 0).getDate();
      const firstDayIndex = new Date(year, month, 1).getDay();
      const adjustedFirstDay = firstDayIndex === 0 ? 6 : firstDayIndex - 1;

      const grid = document.getElementById('calendar-grid');
      grid.innerHTML = '';

      for(let i=0;i<adjustedFirstDay;i++) grid.innerHTML += `<div></div>`;

      const selectedISO = toISODateLocal(selectedDate);
      const todayISO = toISODateLocal(new Date());

      for(let d=1; d<=daysInMonth; d++){
        const dateISO = `${year}-${pad2(month+1)}-${pad2(d)}`;
        const isSelected = dateISO === selectedISO;
        const isToday = dateISO === todayISO;
        const isLastDay = d === daysInMonth;

        const dayEvents = events.filter(e => e.dateISO === dateISO);
        const dayProfit = dayEvents.reduce((acc, curr) => acc + parseNum(curr.income), 0);

        let markersHtml = `<div class="calendar-markers">`;
        const sliceCount = 3;
        dayEvents.slice(0, sliceCount).forEach(e => {
          const tKey = primaryTypeOfEvent(e);
          const t = TYPES[tKey] || TYPES.stage;
          markersHtml += `
            <div
              class="event-marker ${t.color}"
              role="button"
              title="${t.label}"
              onclick="event.stopPropagation(); window.editEvent(${e.id});"
            ></div>`;
        });
        markersHtml += `</div>`;

        let profitHtml = dayProfit > 0
          ? `<span class="absolute top-1 right-1 text-[9px] text-emerald-400 bg-emerald-500/10 px-1.5 py-0.5 rounded-lg font-mono border border-emerald-500/15">+${(dayProfit/1000).toFixed(0)}k</span>`
          : '';

        let summaryHtml = '';
        if(isLastDay){
          summaryHtml = `<div class="month-summary">ИТОГ</div>`;
        }

        const cell = document.createElement('div');
        cell.className = `calendar-cell relative cursor-pointer aspect-[3/4] min-h-[76px] ${isSelected?'selected':''} ${isToday?'today':''}`;

        cell.onclick = () => {
          selectedDate = new Date(year, month, d);
          renderCalendar();
          renderSidebar();
          renderMonthNavigator();
          window.switchMobileTab('dashboard');
        };

        cell.innerHTML = `
          <div class="date-number">${d}</div>
          ${profitHtml}
          ${markersHtml}
          ${summaryHtml}
        `;
        grid.appendChild(cell);
      }
    }

    function flashCard(el){
      if(!el) return;
      el.classList.add('flash-highlight');
      setTimeout(()=> el.classList.remove('flash-highlight'), 950);
    }

    function renderSidebar(){
      const dateISO = toISODateLocal(selectedDate);
      document.getElementById('selected-date-big').innerText = selectedDate.getDate();
      document.getElementById('selected-weekday').innerText =
        selectedDate.toLocaleDateString('ru-RU', { weekday:'long', month:'long' });

      const list = document.getElementById('events-list');
      list.innerHTML = '';

      const dayEvents = events
        .filter(e => e.dateISO === dateISO)
        .sort((a,b) => (a.time || '').localeCompare(b.time || ''));

      const jumperWrap = document.getElementById('jumper-wrap');
      const jumper = document.getElementById('event-jumper');
      if(jumperWrap && jumper){
        if(dayEvents.length >= 2){
          jumperWrap.classList.remove('hidden');
          jumper.innerHTML = '';
          dayEvents.forEach(e=>{
            const opt = document.createElement('option');
            opt.value = String(e.id);
            const t = (e.time || (e.schedule?.[0]?.time) || '—');
            opt.textContent = `${t} • ${e.title || 'Событие'}`;
            jumper.appendChild(opt);
          });
          jumper.onchange = () => {
            const id = jumper.value;
            const target = document.getElementById(`event-card-${id}`);
            if(target){
              target.scrollIntoView({behavior:'smooth', block:'start'});
              flashCard(target);
            }
          };
        } else {
          jumperWrap.classList.add('hidden');
          jumper.innerHTML = '<option value="">—</option>';
          jumper.onchange = null;
        }
      }

      if(dayEvents.length === 0){
        list.innerHTML = `
          <div class="h-40 flex flex-col items-center justify-center text-slate-600 space-y-2 opacity-60">
            <i data-lucide="wand-2" class="w-10 h-10"></i><p class="text-sm">Нет шоу</p>
            <p class="text-xs text-slate-500">Нажми “+” чтобы создать</p>
          </div>`;
      } else {
        dayEvents.forEach(e => {
          const primaryType = primaryTypeOfEvent(e);
          const income = parseNum(e.income);
          const prepay = parseNum(e.prepay);

          const profitHtml = income > 0
            ? `<div class="flex items-center gap-1 text-emerald-400 text-xs font-mono font-bold"><i data-lucide="banknote" class="w-3 h-3"></i> +${income.toLocaleString()}</div>`
            : '';

          let scheduleBlock = '<div class="flex flex-col gap-1 mb-2">';
          if(e.schedule && e.schedule.length){
            e.schedule.forEach(act => {
              const cfg = TYPES[act.type] || TYPES.stage;
              const dur = parseNum(act.duration);
              scheduleBlock += `
                <div class="flex justify-between items-center text-xs">
                  <span class="flex items-center gap-1 text-slate-300">
                    <i data-lucide="${cfg.icon}" class="w-3 h-3 text-slate-500"></i> ${cfg.label}
                  </span>
                  <span class="font-mono text-amber-500">${act.time}</span>
                </div>
                <div class="text-[10px] text-slate-500 text-right -mt-1">${dur ? `⏱ ${dur} мин` : ''}</div>
              `;
            });
          }
          scheduleBlock += '</div>';

          let clientBlock = '';
          if(e.clientName || e.clientPhone){
            clientBlock = `<div class="mt-2 pt-2 border-t border-white/5 flex flex-col gap-1">`;
            if(e.clientName) clientBlock += `<div class="flex items-center gap-2 text-xs text-slate-300"><i data-lucide="user" class="w-3 h-3 text-slate-500"></i> ${e.clientName}</div>`;
            if(e.clientPhone) clientBlock += `<a href="tel:${e.clientPhone}" onclick="event.stopPropagation()" class="flex items-center gap-2 text-xs text-amber-400 hover:text-amber-300"><i data-lucide="phone" class="w-3 h-3"></i> ${e.clientPhone}</a>`;
            clientBlock += `</div>`;
          }

          let notesBlock = '';
          if(e.notes){
            notesBlock = `<div class="mt-2 text-xs text-slate-500 italic line-clamp-2 pl-4 border-l-2 border-white/10">${e.notes}</div>`;
          }

          let extraBlock = '';
          if(Array.isArray(e.setlist) && e.setlist.length){
            const joined = e.setlist.slice(0,6).join(' • ');
            extraBlock = `
              <div class="mt-2 text-xs text-slate-300 bg-white/5 border border-white/10 rounded-xl px-3 py-2">
                <div class="text-[9px] text-slate-500 uppercase font-bold tracking-widest mb-1">Доп</div>
                <div class="leading-snug">${joined}${e.setlist.length>6 ? ' …' : ''}</div>
              </div>
            `;
          }

          let balanceBlock = '';
          if(income > 0){
            const bal = income - prepay;
            if(bal > 0) balanceBlock = `<div class="text-[9px] text-amber-500/80 font-mono mt-1 text-right">Остаток: ${bal.toLocaleString()}</div>`;
            else if(prepay > 0) balanceBlock = `<div class="text-[9px] text-slate-500/80 font-mono mt-1 text-right">Оплачено</div>`;
          }

          const stripColor =
            primaryType === 'stage' ? 'bg-amber-500' :
            primaryType === 'closeup' ? 'bg-purple-500' :
            primaryType === 'kids' ? 'bg-emerald-500' :
            primaryType === 'concert' ? 'bg-blue-500' :
            'bg-slate-500';

          const el = document.createElement('div');
          el.id = `event-card-${e.id}`;
          el.className = 'group relative bg-white/5 rounded-2xl p-3 border border-white/10 hover:border-amber-500/30 transition cursor-pointer';
          el.onclick = () => window.editEvent(e.id);

          el.innerHTML = `
            <div class="absolute left-0 top-3 bottom-3 w-1 rounded-r ${stripColor}"></div>
            <div class="pl-3">
              ${scheduleBlock}
              <h4 class="text-white font-display font-semibold text-base leading-tight mb-1">${e.title}</h4>
              ${e.location ? `<div class="text-xs text-slate-400 flex items-center gap-1 mb-1"><i data-lucide="map-pin" class="w-3 h-3"></i> ${e.location}</div>` : ''}
              ${clientBlock}
              ${extraBlock}
              ${notesBlock}
              <div class="flex justify-between items-center pt-2 border-t border-white/5 mt-2">
                <div>
                  ${profitHtml}
                  ${balanceBlock}
                </div>
                <button onclick="event.stopPropagation(); window.deleteEvent('${e.id}')" class="text-slate-500 hover:text-red-400 p-1 active:scale-[0.98]">
                  <i data-lucide="trash-2" class="w-4 h-4"></i>
                </button>
              </div>
            </div>
          `;
          list.appendChild(el);
        });
      }

      lucide.createIcons();
    }

    function renderSetlist(){
      const ul = document.getElementById('setlist-container');
      if(currentSetlist.length === 0){
        ul.innerHTML = '<li class="text-center text-slate-600 text-xs italic py-4">Пока пусто</li>';
        return;
      }
      ul.innerHTML = '';
      currentSetlist.forEach((t, i) => {
        ul.innerHTML += `
          <li class="flex justify-between bg-white/5 p-2 rounded-xl border border-white/10">
            <span><span class="text-amber-500 mr-2">${i+1}.</span>${t}</span>
            <button onclick="currentSetlist.splice(${i},1); renderSetlist()" class="text-red-400 hover:text-white active:scale-[0.98]">
              <i data-lucide="x" class="w-3 h-3"></i>
            </button>
          </li>`;
      });
      lucide.createIcons();
    }

    function getMonthEvents(year, month1){
      return events.filter(e => {
        if(!e.dateISO) return false;
        const [y,m] = e.dateISO.split('-').map(Number);
        return y === year && m === month1;
      });
    }

    function renderStats(){
      const year = currentDate.getFullYear();
      const month1 = currentDate.getMonth() + 1;

      const monthEvents = getMonthEvents(year, month1);

      const income = monthEvents.reduce((acc,c)=>acc + parseNum(c.income), 0);
      const expense = monthEvents.reduce((acc,c)=>acc + parseNum(c.expense), 0);
      const profit = income - expense;

      document.getElementById('stat-profit').innerText = profit.toLocaleString();
      document.getElementById('stat-income').innerText = `+${income.toLocaleString()}`;
      document.getElementById('stat-expense').innerText = `-${expense.toLocaleString()}`;
      document.getElementById('goal-amount').innerText = `${(monthlyGoal/1000).toFixed(0)}k ₽`;

      const pct = monthlyGoal > 0 ? Math.min(100, Math.round((profit / monthlyGoal) * 100)) : 0;
      const goalBar = document.getElementById('goal-progress');

      if(pct >= 100){
        goalBar.className = "h-full bg-gradient-to-r from-emerald-400 to-green-500 transition-all duration-1000 animate-pulse";
        document.getElementById('goal-badge').classList.remove('hidden');
        if(!goalCelebrated){
          window.celebrateGoal();
          goalCelebrated = true;
        }
      } else {
        goalBar.className = "h-full bg-gradient-to-r from-amber-700 to-yellow-400 transition-all duration-1000";
        document.getElementById('goal-badge').classList.add('hidden');
        goalCelebrated = false;
      }
      goalBar.style.width = `${pct}%`;

      const remaining = Math.max(0, Math.round(monthlyGoal - profit));
      document.getElementById('goal-remaining').textContent = `Осталось: ${remaining.toLocaleString()} ₽`;

      const daysInMonth = new Date(year, currentDate.getMonth()+1, 0).getDate();
      const today = new Date();
      let daysLeft = daysInMonth;

      const isCurrentMonth = (today.getFullYear() === year && (today.getMonth()+1) === month1);
      const isPastMonth = (new Date(year, currentDate.getMonth(), 1) < new Date(today.getFullYear(), today.getMonth(), 1));

      if(isPastMonth){
        daysLeft = 0;
      } else if(isCurrentMonth){
        daysLeft = Math.max(0, daysInMonth - today.getDate());
      } else {
        daysLeft = daysInMonth;
      }

      const pace = (daysLeft > 0 && remaining > 0) ? Math.ceil(remaining / daysLeft) : 0;
      document.getElementById('goal-pace').textContent = `Темп: ${pace.toLocaleString()} ₽/д`;
    }

    function renderAnalytics(){
      const container = document.getElementById('analytics-list');
      if(!container) return;

      const year = currentDate.getFullYear();
      const month1 = currentDate.getMonth() + 1;

      const monthEvents = getMonthEvents(year, month1);

      const stats = {};
      Object.keys(TYPES).forEach(k => stats[k] = { count:0, income:0, ...TYPES[k] });
      let totalCount = 0;

      monthEvents.forEach(e => {
        const inc = parseNum(e.income);
        if(e.schedule && e.schedule.length){
          const prim = e.schedule[0].type;
          if(stats[prim]) stats[prim].income += inc;
          e.schedule.forEach(act => {
            if(stats[act.type]){
              stats[act.type].count++;
              totalCount++;
            }
          });
        } else {
          const t = e.type || 'stage';
          if(stats[t]){
            stats[t].count++;
            stats[t].income += inc;
            totalCount++;
          }
        }
      });

      container.innerHTML = '';
      if(totalCount === 0){
        container.innerHTML = '<div class="text-center text-slate-500 text-xs py-2">Нет данных за этот месяц</div>';
        return;
      }

      const sorted = Object.entries(stats)
        .map(([k,v]) => ({ key:k, ...v }))
        .sort((a,b)=> b.count - a.count);

      sorted.forEach(item => {
        if(item.count === 0) return;
        const pct = Math.round((item.count / totalCount) * 100);
        container.innerHTML += `
          <div class="flex flex-col gap-1">
            <div class="flex justify-between text-[10px] text-slate-300">
              <span class="flex items-center gap-1"><i data-lucide="${item.icon}" class="w-3 h-3 text-slate-400"></i> ${item.label}</span>
              <span class="font-mono opacity-80">${item.count} (${pct}%)</span>
            </div>
            <div class="h-1.5 w-full bg-white/5 rounded-full overflow-hidden">
              <div class="h-full ${item.bar || 'bg-slate-500'}" style="width:${pct}%"></div>
            </div>
            <div class="text-[8px] text-slate-500 text-right">
              ${item.income > 0 ? '+' + item.income.toLocaleString() + ' ₽' : ''}
            </div>
          </div>
        `;
      });
      lucide.createIcons();
    }

    function normalizeText(s){
      return String(s || '').toLowerCase().replace(/\s+/g,' ').trim();
    }
    function eventSearchBlob(e){
      const parts = [
        e.title, e.location, e.clientName, e.clientPhone, e.notes,
        Array.isArray(e.setlist) ? e.setlist.join(' ') : ''
      ];
      return normalizeText(parts.join(' '));
    }
    function formatDateShort(iso){
      const [y,m,d] = iso.split('-').map(Number);
      const dt = new Date(y, m-1, d);
      const dd = String(dt.getDate()).padStart(2,'0');
      const mm = String(dt.getMonth()+1).padStart(2,'0');
      return `${dd}.${mm}`;
    }
    function safeTime(e){
      return (e.time || (e.schedule?.[0]?.time) || '—');
    }
    function buildMonthIndex(){
      const year = currentDate.getFullYear();
      const month1 = currentDate.getMonth() + 1;
      return getMonthEvents(year, month1)
        .slice()
        .sort((a,b)=>{
          const da = a.dateISO.localeCompare(b.dateISO);
          if(da !== 0) return da;
          return safeTime(a).localeCompare(safeTime(b));
        })
        .map(e => {
          const t = primaryTypeOfEvent(e);
          const cfg = TYPES[t] || TYPES.stage;
          return {
            id: e.id,
            dateISO: e.dateISO,
            dateShort: formatDateShort(e.dateISO),
            time: safeTime(e),
            title: e.title || 'Событие',
            type: t,
            typeLabel: cfg.label,
            typeIcon: cfg.icon,
            search: eventSearchBlob(e),
          };
        });
    }

    function renderMonthNavigator(){
      const results = document.getElementById('month-results');
      const countEl = document.getElementById('month-nav-count');
      const inp = document.getElementById('month-search');
      const sel = document.getElementById('month-filter');
      if(!results || !inp || !sel) return;

      const q = normalizeText(inp.value);
      const filter = sel.value || 'all';

      const idx = buildMonthIndex();
      let filtered = idx;

      if(filter !== 'all') filtered = filtered.filter(x => x.type === filter);
      if(q) filtered = filtered.filter(x => x.search.includes(q));

      if(countEl) countEl.textContent = `${filtered.length}`;

      results.innerHTML = '';
      if(idx.length === 0){
        results.innerHTML = `<div class="text-center text-slate-500 text-xs py-2">В этом месяце событий нет</div>`;
        return;
      }
      if(filtered.length === 0){
        results.innerHTML = `<div class="text-center text-slate-500 text-xs py-2">Ничего не найдено</div>`;
        return;
      }

      filtered.slice(0, 12).forEach(x=>{
        const row = document.createElement('div');
        row.className = 'mn-row';
        row.onclick = () => window.jumpToEvent(x.id);

        row.innerHTML = `
          <div class="flex items-center gap-3 min-w-0">
            <div class="w-9 h-9 rounded-xl bg-white/5 border border-white/10 flex items-center justify-center shrink-0">
              <i data-lucide="${x.typeIcon}" class="w-4 h-4"></i>
            </div>
            <div class="min-w-0">
              <div class="text-white font-semibold truncate">${x.title}</div>
              <div class="text-[10px] text-slate-400 uppercase font-bold tracking-widest truncate">${x.typeLabel}</div>
            </div>
          </div>
          <div class="shrink-0"><span class="mn-chip">${x.dateShort} • ${x.time}</span></div>
        `;
        results.appendChild(row);
      });

      lucide.createIcons();
    }

    window.jumpToEvent = (id) => {
      const ev = events.find(e => e.id === Number(id));
      if(!ev || !ev.dateISO) return;

      const [y,m,d] = ev.dateISO.split('-').map(Number);
      selectedDate = new Date(y, m-1, d);
      currentDate = new Date(y, m-1, 1);

      window.switchMobileTab('dashboard');
      renderCalendar();
      renderSidebar();
      renderMonthNavigator();

      setTimeout(() => {
        const target = document.getElementById(`event-card-${id}`);
        if(target){
          target.scrollIntoView({behavior:'smooth', block:'start'});
          flashCard(target);
        }
      }, 120);
    };

    // schedule controls
    window.renderSchedule = () => {
      const list = document.getElementById('schedule-list');
      list.innerHTML = '';

      currentSchedule.forEach((item, index) => {
        const row = document.createElement('div');
        row.className = 'act-row';

        const typeKeys = Object.keys(TYPES);
        const currentTypeIdx = typeKeys.indexOf(item.type);
        const nextType = typeKeys[(currentTypeIdx + 1) % typeKeys.length];
        const cfg = TYPES[item.type] || TYPES.stage;

        row.innerHTML = `
          <button onclick="window.updateActType(${index}, '${nextType}')" class="w-8 h-8 rounded-xl bg-white/5 border border-white/10 flex items-center justify-center hover:bg-white/10 active:scale-[0.98] transition" title="${cfg.label}">
            <i data-lucide="${cfg.icon}" class="w-4 h-4 ${cfg.text}"></i>
          </button>

          <input type="time" value="${item.time}" onchange="window.updateActTime(${index}, this.value)" class="bg-transparent text-white text-sm font-mono text-center outline-none w-full">

          <input type="number" min="1" value="${parseNum(item.duration) || cfg.defDur}" onchange="window.updateActDuration(${index}, this.value)" class="bg-black/20 border border-white/10 rounded-xl px-2 py-2 text-white text-xs font-mono text-center outline-none w-full" title="Длительность, мин" placeholder="мин">

          <button onclick="window.removeAct(${index})" class="text-red-400 hover:text-white flex items-center justify-center active:scale-[0.98]">
            <i data-lucide="x" class="w-4 h-4"></i>
          </button>
        `;
        list.appendChild(row);
      });

      lucide.createIcons();
    };

    window.addAct = () => {
      const t = currentType || 'stage';
      const defDur = (TYPES[t]?.defDur) || 60;
      currentSchedule.push({ type: t, time: '19:00', duration: defDur });
      window.renderSchedule();
    };

    window.removeAct = (index) => {
      currentSchedule.splice(index, 1);
      window.renderSchedule();
    };

    window.updateActType = (index, newType) => {
      currentSchedule[index].type = newType;
      if(!parseNum(currentSchedule[index].duration)) currentSchedule[index].duration = TYPES[newType]?.defDur || 60;
      window.renderSchedule();
    };

    window.updateActTime = (index, newTime) => {
      currentSchedule[index].time = newTime;
    };

    window.updateActDuration = (index, newDur) => {
      currentSchedule[index].duration = Math.max(1, Math.round(parseNum(newDur)));
    };

    // month picker
    window.openMonthPicker = () => {
      pickerYear = currentDate.getFullYear();
      document.getElementById('picker-year-display').innerText = pickerYear;
      document.getElementById('month-picker-modal').classList.remove('hidden');
      window.highlightCurrentMonth();
      lucide.createIcons();
    };
    window.closeMonthPicker = () => document.getElementById('month-picker-modal').classList.add('hidden');
    window.changePickerYear = (delta) => {
      pickerYear += delta;
      document.getElementById('picker-year-display').innerText = pickerYear;
      window.highlightCurrentMonth();
    };
    window.selectMonth = (monthIndex) => {
      currentDate = new Date(pickerYear, monthIndex, 1);
      selectedDate = new Date(pickerYear, monthIndex, 1);
      renderApp();
      window.closeMonthPicker();
    };
    window.highlightCurrentMonth = () => {
      const btns = document.querySelectorAll('.month-btn');
      btns.forEach((btn, idx) => {
        if(pickerYear === currentDate.getFullYear() && idx === currentDate.getMonth()){
          btn.classList.add('bg-amber-500','text-black','border-amber-500');
          btn.classList.remove('bg-white/5','text-slate-300','border-white/5');
        } else {
          btn.classList.remove('bg-amber-500','text-black','border-amber-500');
          btn.classList.add('bg-white/5','text-slate-300','border-white/5');
        }
      });
    };

    function migrateEventsToISO(list){
      let changed = false;
      const out = (Array.isArray(list) ? list : []).map(ev => {
        const e = { ...ev };
        e.income = parseNum(e.income);
        e.expense = parseNum(e.expense);
        e.prepay = parseNum(e.prepay);

        if(!e.schedule){
          const t = e.type || 'stage';
          e.schedule = [{ type: t, time: e.time || '19:00', duration: TYPES[t]?.defDur || 60 }];
          changed = true;
        } else {
          e.schedule = e.schedule.map(a => ({
            type: a.type || 'stage',
            time: a.time || '19:00',
            duration: Math.max(1, Math.round(parseNum(a.duration) || (TYPES[a.type]?.defDur || 60)))
          }));
        }

        if(e.dateISO && /^\d{4}-\d{2}-\d{2}$/.test(e.dateISO)) return e;

        if(typeof e.date === 'string'){
          if(/^\d{4}-\d{2}-\d{2}$/.test(e.date)){
            e.dateISO = e.date;
            changed = true;
            return e;
          }
          const parsed = new Date(e.date);
          if(!isNaN(parsed)){
            e.dateISO = toISODateLocal(parsed);
            changed = true;
            return e;
          }
        }

        e.dateISO = e.dateISO || toISODateLocal(new Date());
        changed = true;
        return e;
      });

      return { out, changed };
    }

    function loadLocalData(){
      try{
        const rawEvents = JSON.parse(localStorage.getItem('illusionist_events') || '[]');
        const mig = migrateEventsToISO(rawEvents);
        events = mig.out;

        monthlyGoal = parseNum(JSON.parse(localStorage.getItem('illusionist_goal') || '200000')) || 200000;

        if(mig.changed) localStorage.setItem('illusionist_events', JSON.stringify(events));
      } catch(e){
        events = [];
      }
      renderApp();
    }

    // settings
    window.openSettings = () => {
      document.getElementById('settings-modal').classList.remove('hidden');
      lucide.createIcons();
    };
    window.closeSettings = () => document.getElementById('settings-modal').classList.add('hidden');

    window.resetData = () => {
      if(!confirm('Сбросить все данные?')) return;
      events = [];
      monthlyGoal = 200000;
      localStorage.removeItem('illusionist_events');
      localStorage.setItem('illusionist_goal', JSON.stringify(monthlyGoal));
      renderApp();
      window.showToast('Данные сброшены');
    };

    window.exportData = () => {
      const dateStr = new Date().toISOString().split('T')[0];
      const data = { events, goal: monthlyGoal, version: 'mobile-1.0' };
      const blob = new Blob([JSON.stringify(data, null, 2)], {type:'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `IllusionistOS_Calendar_Backup_${dateStr}.json`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      window.showToast('Архив скачан!');
    };

    window.importData = (input) => {
      const file = input.files[0];
      if(!file) return;
      const reader = new FileReader();
      reader.onload = (e) => {
        try{
          const data = JSON.parse(e.target.result);
          if(data.events){
            const mig = migrateEventsToISO(data.events);
            events = mig.out;
            localStorage.setItem('illusionist_events', JSON.stringify(events));
          }
          if(data.goal !== undefined){
            monthlyGoal = parseNum(data.goal) || monthlyGoal;
            localStorage.setItem('illusionist_goal', JSON.stringify(monthlyGoal));
          }
          renderApp();
          window.closeSettings();
          window.showToast('Данные восстановлены!');
        } catch(err){
          window.showToast('Ошибка файла');
        }
      };
      reader.readAsText(file);
    };

    window.editGoal = () => {
      document.getElementById('goal-input').value = monthlyGoal;
      document.getElementById('goal-modal').classList.remove('hidden');
      lucide.createIcons();
    };
    window.closeGoalModal = () => document.getElementById('goal-modal').classList.add('hidden');
    window.saveGoalFromModal = () => {
      const v = parseNum(document.getElementById('goal-input').value);
      if(v <= 0){
        window.showToast('Введите цель > 0');
        return;
      }
      monthlyGoal = Math.round(v);
      localStorage.setItem('illusionist_goal', JSON.stringify(monthlyGoal));
      renderStats();
      renderAnalytics();
      renderMonthNavigator();
      window.closeGoalModal();
      window.showToast('Цель обновлена');
    };

    window.changeMonth = (delta) => {
      const y = currentDate.getFullYear();
      const m = currentDate.getMonth();
      currentDate = new Date(y, m + delta, 1);
      selectedDate = new Date(currentDate.getFullYear(), currentDate.getMonth(), 1);
      renderApp();
    };

    window.goToToday = () => {
      const now = new Date();
      currentDate = new Date(now.getFullYear(), now.getMonth(), 1);
      selectedDate = now;
      renderApp();
      window.switchMobileTab('dashboard');
    };

    window.switchMobileTab = (tab) => {
      const calView = document.getElementById('view-calendar');
      const dashView = document.getElementById('view-dashboard');
      const calNav = document.getElementById('nav-calendar');
      const dashNav = document.getElementById('nav-dashboard');

      if(tab === 'calendar'){
        calView.classList.remove('is-hidden');
        dashView.classList.add('is-hidden');

        calNav.classList.add('text-amber-400');
        calNav.classList.remove('text-slate-500');
        dashNav.classList.remove('text-amber-400');
        dashNav.classList.add('text-slate-500');
      } else {
        calView.classList.add('is-hidden');
        dashView.classList.remove('is-hidden');

        dashNav.classList.add('text-amber-400');
        dashNav.classList.remove('text-slate-500');
        calNav.classList.remove('text-amber-400');
        calNav.classList.add('text-slate-500');
      }
      updateBottomNavMetrics();
    };

    // event modal
    window.openModal = (isEdit=false) => {
      // FIX: prevent iOS jump
      if (document.activeElement && document.activeElement.blur) document.activeElement.blur();
      lockBackgroundScroll();

      document.getElementById('event-modal').classList.remove('hidden');
      document.getElementById('modal-title').innerText = isEdit ? 'Редактировать' : 'Новое Событие';

      const dateInput = document.getElementById('inp-date');

      if(!isEdit){
        editingId = null;
        document.getElementById('btn-delete').classList.add('hidden');

        document.getElementById('inp-title').value = '';
        document.getElementById('inp-location').value = '';
        document.getElementById('inp-client-name').value = '';
        document.getElementById('inp-client-phone').value = '';
        document.getElementById('inp-income').value = '';
        document.getElementById('inp-prepay').value = '';
        document.getElementById('inp-prepay-percent').value = '';
        document.getElementById('inp-expense').value = '';
        document.getElementById('inp-notes').value = '';
        document.getElementById('txt-balance').innerText = '0';

        currentSetlist = [];
        currentType = 'stage';
        currentSchedule = [{ type:'stage', time:'19:00', duration: TYPES.stage.defDur }];

        dateInput.value = toISODateLocal(selectedDate);
      } else {
        document.getElementById('btn-delete').classList.remove('hidden');
      }

      window.renderSetlist();
      window.renderSchedule();
      window.switchTab('info');
      window.setType(currentType || 'stage');

      lucide.createIcons();
    };

    window.closeModal = () => {
      document.getElementById('event-modal').classList.add('hidden');
      unlockBackgroundScroll();
    };

    window.switchTab = (tab) => {
      ['info','setlist','finance','notes'].forEach(t => {
        document.getElementById(`tab-${t}`).classList.add('hidden');
        document.getElementById(`tab-btn-${t}`).className = "flex-1 py-2 text-[10px] font-bold uppercase text-slate-500 rounded-xl transition";
      });
      document.getElementById(`tab-${tab}`).classList.remove('hidden');
      document.getElementById(`tab-btn-${tab}`).className = "tab-active flex-1 py-2 text-[10px] font-bold uppercase rounded-xl transition";
    };

    window.setType = (type) => {
      currentType = type;
      document.querySelectorAll('.type-btn').forEach(b => {
        b.classList.remove('selected');
        b.classList.remove('border-amber-500','bg-amber-500/10','text-amber-400');
        b.classList.remove('border-purple-500','bg-purple-500/10','text-purple-400');
        b.classList.remove('border-emerald-500','bg-emerald-500/10','text-emerald-400');
        b.classList.remove('border-blue-500','bg-blue-500/10','text-blue-400');
        b.classList.remove('border-slate-500','bg-slate-500/10','text-slate-300');
        b.classList.add('border-white/5','bg-white/5','text-slate-500');
      });

      const activeBtn = document.getElementById(`type-${type}`);
      if(activeBtn){
        activeBtn.classList.add('selected');
        activeBtn.classList.remove('border-white/5','bg-white/5','text-slate-500');
        if(type === 'stage') activeBtn.classList.add('border-amber-500','bg-amber-500/10','text-amber-400');
        else if(type === 'closeup') activeBtn.classList.add('border-purple-500','bg-purple-500/10','text-purple-400');
        else if(type === 'kids') activeBtn.classList.add('border-emerald-500','bg-emerald-500/10','text-emerald-400');
        else if(type === 'concert') activeBtn.classList.add('border-blue-500','bg-blue-500/10','text-blue-400');
        else if(type === 'rehearsal') activeBtn.classList.add('border-slate-500','bg-slate-500/10','text-slate-300');
      }
    };

    window.addTrick = () => {
      const val = document.getElementById('inp-trick').value.trim();
      if(val){
        currentSetlist.push(val);
        document.getElementById('inp-trick').value = '';
        window.renderSetlist();
      }
    };

    window.editEvent = (id) => {
      const ev = events.find(e => e.id === id);
      if(!ev) return;

      editingId = id;

      document.getElementById('inp-title').value = ev.title || '';
      document.getElementById('inp-location').value = ev.location || '';
      document.getElementById('inp-client-name').value = ev.clientName || '';
      document.getElementById('inp-client-phone').value = ev.clientPhone || '';
      document.getElementById('inp-income').value = parseNum(ev.income) || '';
      document.getElementById('inp-prepay').value = parseNum(ev.prepay) || '';
      document.getElementById('inp-expense').value = parseNum(ev.expense) || '';
      document.getElementById('inp-notes').value = ev.notes || '';

      currentSetlist = Array.isArray(ev.setlist) ? ev.setlist : [];
      currentSchedule = (ev.schedule && ev.schedule.length)
        ? ev.schedule
        : [{ type: ev.type || 'stage', time: ev.time || '19:00', duration: TYPES[ev.type || 'stage']?.defDur || 60 }];
      currentType = currentSchedule[0].type || 'stage';

      document.getElementById('inp-date').value = ev.dateISO || toISODateLocal(new Date());

      window.calcBalanceFromAmount();
      window.openModal(true);
    };

    window.saveEvent = async () => {
      const title = document.getElementById('inp-title').value.trim();
      const dateISO = document.getElementById('inp-date').value;

      if(!title){ window.showToast('Введите название!'); return; }
      if(!dateISO){ window.showToast('Выберите дату!'); return; }
      if(currentSchedule.length === 0){ window.showToast('Добавьте хотя бы один выход!'); return; }

      const [y,m,d] = dateISO.split('-').map(Number);
      const eventDateObj = new Date(y, m-1, d);
      const primary = currentSchedule[0];

      const eventData = {
        title,
        time: primary.time,
        type: primary.type,
        schedule: currentSchedule.map(a => ({
          type: a.type,
          time: a.time,
          duration: Math.max(1, Math.round(parseNum(a.duration) || (TYPES[a.type]?.defDur || 60)))
        })),
        location: document.getElementById('inp-location').value,
        clientName: document.getElementById('inp-client-name').value,
        clientPhone: document.getElementById('inp-client-phone').value,
        income: Math.round(parseNum(document.getElementById('inp-income').value)),
        prepay: Math.round(parseNum(document.getElementById('inp-prepay').value)),
        expense: Math.round(parseNum(document.getElementById('inp-expense').value)),
        notes: document.getElementById('inp-notes').value,
        setlist: currentSetlist,
        dateISO
      };

      if(editingId){
        events = events.map(e => e.id === editingId ? { ...e, ...eventData } : e);
        window.showToast('Обновлено!');
      } else {
        events.push({ id: Date.now(), ...eventData });
        window.showToast('Магия создана!');
      }

      localStorage.setItem('illusionist_events', JSON.stringify(events));

      selectedDate = eventDateObj;
      currentDate = new Date(selectedDate.getFullYear(), selectedDate.getMonth(), 1);

      window.closeModal();
      renderApp();
      window.switchMobileTab('dashboard');
    };

    window.deleteEvent = (id) => {
      const numId = Number(id);
      if(!confirm('Удалить событие?')) return;
      events = events.filter(e => e.id !== numId);
      localStorage.setItem('illusionist_events', JSON.stringify(events));
      renderApp();
      window.showToast('Удалено');
    };

    window.deleteEventFromModal = () => {
      if(editingId){
        if(!confirm('Удалить это событие?')) return;
        events = events.filter(e => e.id !== editingId);
        localStorage.setItem('illusionist_events', JSON.stringify(events));
        renderApp();
        window.closeModal();
        window.showToast('Событие удалено');
      }
    };

    window.showToast = (msg) => {
      const t = document.getElementById('toast');
      const m = document.getElementById('toast-msg');
      if(!t || !m) return;

      m.innerText = msg;
      t.classList.add('show');
      clearTimeout(window.__toastTimer);
      window.__toastTimer = setTimeout(() => t.classList.remove('show'), 2800);
    };

    window.celebrateGoal = () => {
      const container = document.getElementById('confetti-container');
      const colors = ['#f59e0b','#10b981','#3b82f6','#8b5cf6','#f43f5e'];
      for(let i=0;i<50;i++){
        const el = document.createElement('div');
        el.className = 'confetti';
        el.style.left = Math.random() * 100 + 'vw';
        el.style.top = '-10px';
        el.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
        el.style.animationDuration = (Math.random() * 3 + 2) + 's';
        el.style.opacity = Math.random();
        container.appendChild(el);
        setTimeout(() => el.remove(), 5000);
      }
      window.showToast('🎉 Цель достигнута! Так держать!');
    };

    window.calcBalanceFromAmount = () => {
      const total = parseNum(document.getElementById('inp-income').value);
      const prepay = parseNum(document.getElementById('inp-prepay').value);

      if(total > 0){
        const percent = (prepay / total) * 100;
        document.getElementById('inp-prepay-percent').value = (Math.round(percent * 10) / 10).toString().replace('.', ',');
      } else {
        document.getElementById('inp-prepay-percent').value = '0';
      }
      window.updateBalanceDisplay(total, prepay);
    };

    window.calcBalanceFromPercent = () => {
      const total = parseNum(document.getElementById('inp-income').value);
      const percent = parseNum(document.getElementById('inp-prepay-percent').value);

      const prepay = Math.round(total * (percent / 100));
      document.getElementById('inp-prepay').value = prepay;
      window.updateBalanceDisplay(total, prepay);
    };

    window.updateBalanceDisplay = (total, prepay) => {
      const balance = total - prepay;
      const balEl = document.getElementById('txt-balance');
      if(!balEl) return;

      if(total > 0 && balance <= 0){
        balEl.innerText = "Оплачено";
        balEl.className = "text-lg font-mono text-slate-500 font-bold";
      } else {
        balEl.innerText = `${Math.max(0, balance).toLocaleString()} ₽`;
        balEl.className = "text-lg font-mono text-amber-400 font-bold";
      }
    };

    // background particles (unchanged)
    let particleRAF = null;
    let particleState = { running:false, ctx:null, canvas:null, particles:[] };

    function initParticles(){
      const reduce = window.matchMedia && window.matchMedia('(prefers-reduced-motion: reduce)').matches;
      if(reduce) return;

      const canvas = document.getElementById('bg-canvas');
      const ctx = canvas.getContext('2d');
      particleState.canvas = canvas;
      particleState.ctx = ctx;

      function resize(){
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
      }
      window.addEventListener('resize', resize);
      resize();

      particleState.particles = [];
      for(let i=0;i<60;i++){
        particleState.particles.push({
          x: Math.random()*canvas.width,
          y: Math.random()*canvas.height,
          size: Math.random()*2,
          speedX: Math.random()*0.5-0.25,
          speedY: Math.random()*0.5-0.25,
          color: Math.random()>0.5 ? '245, 158, 11' : '139, 92, 246',
          opacity: Math.random()*0.5
        });
      }

      function step(){
        if(!particleState.running) return;
        ctx.clearRect(0,0,canvas.width,canvas.height);

        particleState.particles.forEach(p => {
          p.x += p.speedX; p.y += p.speedY;
          if(p.x < 0 || p.x > canvas.width) p.speedX *= -1;
          if(p.y < 0 || p.y > canvas.height) p.speedY *= -1;

          ctx.beginPath();
          ctx.arc(p.x, p.y, p.size, 0, Math.PI*2);
          ctx.fillStyle = `rgba(${p.color}, ${p.opacity})`;
          ctx.fill();
        });

        particleRAF = requestAnimationFrame(step);
      }

      function start(){
        if(particleState.running) return;
        particleState.running = true;
        step();
      }

      function stop(){
        particleState.running = false;
        if(particleRAF) cancelAnimationFrame(particleRAF);
        particleRAF = null;
      }

      document.addEventListener('visibilitychange', () => {
        if(document.hidden) stop();
        else start();
      });

      start();
    }

    function updateBottomNavMetrics(){
      const nav = document.getElementById('mobile-bottom-nav');
      if(!nav) return;
      const rect = nav.getBoundingClientRect();
      const h = rect.height || 64;
      document.documentElement.style.setProperty('--bottom-nav-h', `${Math.round(h)}px`);
    }

    window.addEventListener('resize', updateBottomNavMetrics);
    window.addEventListener('orientationchange', () => setTimeout(updateBottomNavMetrics, 120));

    function bindMonthNavigatorInputs(){
      const inp = document.getElementById('month-search');
      const sel = document.getElementById('month-filter');
      if(inp && !inp.__bound){
        inp.__bound = true;
        inp.addEventListener('input', () => renderMonthNavigator());
      }
      if(sel && !sel.__bound){
        sel.__bound = true;
        sel.addEventListener('change', () => renderMonthNavigator());
      }
    }

    document.addEventListener('DOMContentLoaded', () => {
      loadLocalData();
      initParticles();
      updateBottomNavMetrics();
      bindMonthNavigatorInputs();
      lucide.createIcons();
      window.switchMobileTab('calendar');
    });
  </script>
</body>
</html>
