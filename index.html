<!DOCTYPE html>
<html lang="ru">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport"
    content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
  <title>Illusionist OS ‚Äî –£–º–Ω—ã–π –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä</title>

  <!-- PWA -->
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="Illusionist OS" />
  <meta name="theme-color" content="#050507" />



  <!-- Icons (iOS/Android/PWA) -->
  <!-- –û—Å–Ω–æ–≤–Ω–∞—è –∏–∫–æ–Ω–∫–∞ –¥–ª—è –±—Ä–∞—É–∑–µ—Ä–∞ -->
  <link rel="icon" type="image/png" sizes="32x32" href="icons/icon-32.png" />
  <link rel="icon" type="image/png" sizes="16x16" href="icons/icon-16.png" />

  <!-- Apple Touch Icons -->
  <link rel="apple-touch-icon" sizes="180x180" href="icons/icon-180.png" />
  <link rel="apple-touch-icon" sizes="167x167" href="icons/icon-167.png" />
  <link rel="apple-touch-icon" sizes="152x152" href="icons/icon-152.png" />
  <link rel="apple-touch-icon" sizes="120x120" href="icons/icon-120.png" />

  <!-- PWA Manifest -->
  <link rel="manifest" href="manifest.webmanifest" />
  <meta name="mobile-web-app-capable" content="yes" />
  <meta name="application-name" content="Illusionist OS" />

  <!-- DNS Prefetch & Preconnect –¥–ª—è –±—ã—Å—Ç—Ä–æ–π –∑–∞–≥—Ä—É–∑–∫–∏ -->
  <link rel="dns-prefetch" href="https://fonts.googleapis.com">
  <link rel="dns-prefetch" href="https://fonts.gstatic.com">
  <!-- –ò—Å–ø–æ–ª—å–∑—É–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–µ —Ñ–∞–π–ª—ã –¥–ª—è –æ—Ñ–ª–∞–π–Ω —Ä–∞–±–æ—Ç—ã -->
  <link rel="dns-prefetch" href="https://www.gstatic.com">
  <link rel="preconnect" href="https://www.gstatic.com" crossorigin>
  <link rel="dns-prefetch" href="https://calc76-default-rtdb.firebaseio.com">

  <!-- Fonts - –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–µ —Å–∏—Å—Ç–µ–º–Ω—ã–µ —à—Ä–∏—Ñ—Ç—ã (—Ä–∞–±–æ—Ç–∞—é—Ç –ë–ï–ó VPN –≤ –†–æ—Å—Å–∏–∏!) -->
  <style>
    /* –ü—Ä–µ–º–∏–∞–ª—å–Ω—ã–π —Å—Ç–µ–∫ —à—Ä–∏—Ñ—Ç–æ–≤ –±–µ–∑ –≤–Ω–µ—à–Ω–∏—Ö –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π */
    :root {
      --font-display: 'Georgia', 'Palatino Linotype', 'Book Antiqua', Palatino, 'Times New Roman', serif;
      --font-body: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Helvetica Neue', Arial, sans-serif;
      --font-mono: 'SF Mono', Monaco, 'Cascadia Code', 'Roboto Mono', Consolas, 'Courier New', monospace;
    }

    /* –°–ø–µ—Ü–∏–∞–ª—å–Ω–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞ –¥–ª—è iPhone 14 (390px width) */
    @media (min-width: 388px) and (max-width: 392px) {

      .btn-icon,
      .btn-qty {
        width: 52px !important;
        height: 52px !important;
      }

      .btn-del-mini {
        width: 48px !important;
        height: 48px !important;
      }

      .btn-add {
        min-height: 50px !important;
      }

      .form-input {
        min-height: 52px !important;
      }

      main {
        padding-left: max(16px, env(safe-area-inset-left)) !important;
        padding-right: max(16px, env(safe-area-inset-right)) !important;
      }
    }
  </style>

  <!-- Tailwind (–ª–æ–∫–∞–ª—å–Ω—ã–π —Ñ–∞–π–ª –¥–ª—è –æ—Ñ–ª–∞–π–Ω —Ä–∞–±–æ—Ç—ã) -->
  <link rel="preload" href="tailwind.min.js" as="script">
  <script src="tailwind.min.js"></script>

  <!-- Lucide (–ª–æ–∫–∞–ª—å–Ω—ã–π —Ñ–∞–π–ª –¥–ª—è –æ—Ñ–ª–∞–π–Ω —Ä–∞–±–æ—Ç—ã) -->
  <link rel="preload" href="lucide.min.js" as="script">
  <script src="lucide.min.js"></script>

  <!-- Critical CSS –¥–ª—è –º–≥–Ω–æ–≤–µ–Ω–Ω–æ–≥–æ —Ä–µ–Ω–¥–µ—Ä–∞ -->
  <style>
    body {
      margin: 0;
      padding: 0;
      background: #050507;
      font-family: system-ui, -apple-system, sans-serif
    }

    .hide {
      opacity: 0;
      pointer-events: none
    }

    .mini-chip {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 0.22rem 0.5rem;
      border-radius: 999px;
      font-size: 0.72rem;
      font-weight: 800;
      letter-spacing: 0.02em;
      border: 1px solid rgba(245, 158, 11, 0.25);
      background: rgba(245, 158, 11, 0.10);
      color: rgba(245, 158, 11, 0.95);
      transition: transform .12s ease, background .12s ease, border-color .12s ease;
      cursor: pointer;
      user-select: none;
      white-space: nowrap;
    }

    .mini-chip:hover {
      transform: translateY(-1px);
      background: rgba(245, 158, 11, 0.14);
      border-color: rgba(245, 158, 11, 0.35);
    }

    .mini-chip:active {
      transform: translateY(0px) scale(.98);
    }

    .mini-chip--ghost {
      background: rgba(255, 255, 255, 0.06);
      border-color: rgba(255, 255, 255, 0.12);
      color: rgba(226, 232, 240, 0.9);
    }
  </style>

  <!-- Styles -->
  <style>
    :root {
      --bg: #050507;
      --panel: rgba(255, 255, 255, .10);
      --panel2: rgba(255, 255, 255, .12);
      --stroke: rgba(255, 255, 255, .15);
      --gold: #f59e0b;
      --muted: #94a3b8;
      --text: #f1f5f9;
      --safe-top: env(safe-area-inset-top);
      --safe-bottom: env(safe-area-inset-bottom);
      --safe-left: env(safe-area-inset-left);
      --safe-right: env(safe-area-inset-right);
    }

    html,
    body {
      height: 100%;
      background: var(--bg);
      color: var(--text);
      overflow-x: hidden !important;
      max-width: 100vw !important;
      width: 100% !important;
      height: -webkit-fill-available;
      scroll-behavior: smooth;
      font-size: 16px;
    }

    *,
    *::before,
    *::after {
      box-sizing: border-box;
      max-width: 100%;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      overflow-x: hidden;
      min-height: 100vh;
      min-height: -webkit-fill-available;
      min-height: 100dvh;
      padding-top: var(--safe-top);
      padding-bottom: var(--safe-bottom);
      padding-left: var(--safe-left);
      padding-right: var(--safe-right);
      overscroll-behavior: none;
    }

    .font-cinzel {
      font-family: Georgia, 'Palatino Linotype', 'Book Antiqua', Palatino, 'Times New Roman', serif;
      font-weight: 600;
      letter-spacing: 0.05em;
    }

    .mono {
      font-family: 'SF Mono', Monaco, 'Cascadia Code', 'Roboto Mono', Consolas, 'Courier New', monospace;
    }

    .glass {
      background: var(--panel);
      border: 1px solid var(--stroke);
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
      box-shadow: 0 4px 24px rgba(0, 0, 0, 0.2), 0 0 0 1px rgba(255, 255, 255, 0.05) inset;
      overflow-x: hidden;
    }

    .glass-level-1 {
      box-shadow: 0 2px 12px rgba(0, 0, 0, 0.15), 0 0 0 1px rgba(255, 255, 255, 0.05) inset;
    }

    .glass-level-2 {
      box-shadow: 0 4px 24px rgba(0, 0, 0, 0.2), 0 0 0 1px rgba(255, 255, 255, 0.05) inset;
    }

    .glass-level-3 {
      box-shadow: 0 8px 40px rgba(0, 0, 0, 0.3), 0 0 0 1px rgba(255, 255, 255, 0.08) inset;
    }

    header {
      padding: 16px 20px;
      padding-top: calc(16px+env(safe-area-inset-top)) !important;
      padding-left: max(20px, env(safe-area-inset-left)) !important;
      padding-right: max(20px, env(safe-area-inset-right)) !important;
    }

    main {
      padding-left: max(16px, env(safe-area-inset-left)) !important;
      padding-right: max(16px, env(safe-area-inset-right)) !important;
      overflow-x: hidden !important;
    }

    .form-input {
      width: 100%;
      background: rgba(255, 255, 255, .08);
      border: 1.5px solid rgba(255, 255, 255, .12);
      border-radius: 14px;
      padding: 14px 16px;
      font-size: 15px;
      color: #e2e8f0;
      outline: none;
      transition: all 0.2s;
      min-height: 50px;
      -webkit-appearance: none;
      appearance: none;
    }

    .form-input:focus {
      border-color: rgba(245, 158, 11, .4);
      box-shadow: 0 0 0 4px rgba(245, 158, 11, .12);
      background: rgba(255, 255, 255, .10);
    }

    .form-input:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      background: rgba(255, 255, 255, .04);
    }

    .form-input::placeholder {
      color: #94a3b8;
    }

    @media (max-width:768px) {

      input[type="text"],
      input[type="number"],
      input[type="date"],
      input[type="time"],
      select,
      textarea {
        font-size: 16px !important;
      }
    }

    button {
      -webkit-user-select: none;
      user-select: none;
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
      cursor: pointer;
      transition: transform 0.2s cubic-bezier(0.34, 1.56, 0.64, 1),
        background 0.2s ease-out,
        box-shadow 0.2s ease-out;
      will-change: transform;
      backface-visibility: hidden;
      -webkit-backface-visibility: hidden;
    }

    .btn-gold {
      width: 100%;
      border-radius: 16px;
      padding: 14px 18px;
      font-size: 15px;
      font-weight: 800;
      letter-spacing: 0.02em;
      background: linear-gradient(135deg, rgba(245, 158, 11, .95), rgba(245, 158, 11, .75));
      color: #120a00;
      border: 1.5px solid rgba(245, 158, 11, .4);
      box-shadow: 0 12px 30px rgba(245, 158, 11, .2);
      min-height: 52px;
      animation: goldGlow 4s ease-in-out infinite;
    }

    .btn-gold:hover {
      filter: brightness(1.08);
      transform: translateY(-1px);
      box-shadow: 0 16px 40px rgba(245, 158, 11, .3), 0 0 20px rgba(245, 158, 11, .15);
    }

    .btn-gold:active {
      transform: translateY(0);
    }

    .btn-secondary {
      width: 100%;
      border-radius: 16px;
      padding: 14px 18px;
      font-size: 14px;
      font-weight: 700;
      background: rgba(255, 255, 255, .12);
      color: #f1f5f9;
      border: 1.5px solid rgba(255, 255, 255, .18);
      min-height: 52px;
    }

    .btn-secondary:hover {
      background: rgba(255, 255, 255, .16);
      border-color: rgba(255, 255, 255, .25);
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    }

    .btn-icon {
      width: 50px;
      height: 50px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 16px;
      background: rgba(255, 255, 255, .08);
      border: 1.5px solid rgba(255, 255, 255, .12);
      flex-shrink: 0;
    }

    .btn-icon:hover {
      background: rgba(255, 255, 255, .14);
      border-color: rgba(255, 255, 255, .22);
      transform: translateY(-2px) scale(1.02);
      box-shadow: 0 6px 16px rgba(0, 0, 0, 0.2);
    }

    .btn-icon:active {
      transform: translateY(0) scale(0.95);
    }

    .btn-qty {
      width: 50px;
      height: 50px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 14px;
      background: rgba(255, 255, 255, .08);
      border: 1.5px solid rgba(255, 255, 255, .12);
      flex-shrink: 0;
    }

    .btn-qty:hover {
      background: rgba(255, 255, 255, .14);
      border-color: rgba(245, 158, 11, .4);
      transform: scale(1.08);
      box-shadow: 0 6px 16px rgba(245, 158, 11, 0.2);
    }

    .btn-qty:active {
      transform: scale(0.95);
    }

    .btn-add {
      background: rgba(245, 158, 11, .16);
      border: 1.5px solid rgba(245, 158, 11, .30);
      color: rgba(245, 158, 11, 1);
      border-radius: 14px;
      padding: 12px 16px;
      font-size: 13px;
      font-weight: 700;
      letter-spacing: 0.02em;
      min-height: 48px;
    }

    .btn-add:hover {
      background: rgba(245, 158, 11, .24);
      border-color: rgba(245, 158, 11, .45);
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(245, 158, 11, 0.25);
    }

    .btn-add:active {
      transform: translateY(0) scale(0.97);
    }

    .btn-del-mini {
      background: rgba(239, 68, 68, .12);
      border: 1.5px solid rgba(239, 68, 68, .22);
      color: rgba(239, 68, 68, .95);
      border-radius: 12px;
      width: 44px;
      height: 44px;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }

    .btn-del-mini:hover {
      background: rgba(239, 68, 68, .2);
      border-color: rgba(239, 68, 68, .35);
    }

    .btn-data {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 12px 16px;
      border-radius: 14px;
      font-size: 13px;
      font-weight: 700;
      transition: all 0.2s;
      min-height: 48px;
    }

    .btn-export {
      background: rgba(34, 197, 94, 0.12);
      border: 1.5px solid rgba(34, 197, 94, 0.25);
      color: rgba(34, 197, 94, 0.95);
    }

    .btn-export:hover {
      background: rgba(34, 197, 94, 0.18);
    }

    .btn-import {
      background: rgba(59, 130, 246, 0.12);
      border: 1.5px solid rgba(59, 130, 246, 0.25);
      color: rgba(59, 130, 246, 0.95);
    }

    .btn-import:hover {
      background: rgba(59, 130, 246, 0.18);
    }

    .btn-backup {
      background: rgba(168, 85, 247, 0.12);
      border: 1.5px solid rgba(168, 85, 247, 0.25);
      color: rgba(168, 85, 247, 0.95);
    }

    .btn-backup:hover {
      background: rgba(168, 85, 247, 0.18);
    }

    #toast {
      position: fixed;
      top: calc(20px+env(safe-area-inset-top));
      left: 20px;
      right: 20px;
      z-index: 60;
      opacity: 0;
      transform: translateY(-12px);
      transition: opacity .3s ease, transform .3s ease;
      pointer-events: none;
    }

    #toast.show {
      opacity: 1;
      transform: translateY(0);
      pointer-events: auto;
    }

    @media (min-width:640px) {
      #toast {
        left: 50%;
        right: auto;
        width: 450px;
        max-width: calc(100vw - 40px);
        transform: translateX(-50%) translateY(-12px);
      }

      #toast.show {
        transform: translateX(-50%) translateY(0);
      }
    }

    #view-settings {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, .75);
      display: none;
      z-index: 40;
      overflow: hidden;
      padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
    }

    #view-settings.active {
      display: flex;
      align-items: center;
      justify-content: center;
    }

    #view-settings .panel {
      position: fixed !important;
      left: 0 !important;
      right: 0 !important;
      top: env(safe-area-inset-top) !important;
      bottom: env(safe-area-inset-bottom) !important;
      transform: translateZ(0) !important;
      -webkit-transform: translateZ(0) !important;
      width: 100% !important;
      max-width: 100% !important;
      max-height: none !important;
      margin: 0 !important;
      border-radius: 0 !important;
      overflow-y: auto !important;
      overflow-x: hidden !important;
      -webkit-overflow-scrolling: touch;
      overscroll-behavior: contain;
      /* –£–±–∏—Ä–∞–µ–º —Ç—è–∂—ë–ª—ã–π backdrop-filter ‚Äî –ø–∞–Ω–µ–ª—å –∏ —Ç–∞–∫ –ø–æ–ª–Ω–æ—ç–∫—Ä–∞–Ω–Ω–∞—è */
      backdrop-filter: none !important;
      -webkit-backdrop-filter: none !important;
      background: #000000 !important;
    }

    /* –û—Ç–∫–ª—é—á–∞–µ–º backdrop-filter —É –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏—Ö glass-—ç–ª–µ–º–µ–Ω—Ç–æ–≤ –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö */
    #view-settings .panel .glass {
      backdrop-filter: none !important;
      -webkit-backdrop-filter: none !important;
      background: rgba(0, 0, 0, 0.95) !important;
    }

    @media (min-width:768px) {
      #view-settings .panel {
        position: absolute !important;
        left: 50% !important;
        top: 50% !important;
        right: auto !important;
        bottom: auto !important;
        transform: translate(-50%, -50%) !important;
        width: min(920px, calc(100% - 48px)) !important;
        max-width: min(920px, calc(100% - 48px)) !important;
        max-height: calc(100vh - 48px - env(safe-area-inset-top) - env(safe-area-inset-bottom)) !important;
        border-radius: 24px !important;
      }
    }

    .admin-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: pointer;
      user-select: none;
      gap: 12px;
      padding: 8px 0;
    }

    .admin-content {
      max-height: 0;
      overflow: hidden;
      transition: max-height .35s ease;
      padding-top: 0;
    }

    .admin-content.open {
      max-height: 1800px;
      padding-top: 12px;
    }

    .edit-row {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 8px 0;
      flex-wrap: wrap;
    }

    .edit-input {
      background: rgba(255, 255, 255, .08);
      border: 1.5px solid rgba(255, 255, 255, .12);
      border-radius: 12px;
      padding: 10px 12px;
      font-size: 14px;
      color: #e2e8f0;
      outline: none;
      min-height: 44px;
      flex: 1;
      min-width: 0;
    }

    .edit-input:focus {
      border-color: rgba(245, 158, 11, .4);
      box-shadow: 0 0 0 3px rgba(245, 158, 11, .12);
    }

    .backup-slot {
      background: rgba(255, 255, 255, 0.05);
      border: 1.5px solid rgba(255, 255, 255, 0.1);
      border-radius: 12px;
      padding: 12px;
      cursor: pointer;
      transition: all 0.2s;
      min-height: 68px;
    }

    .backup-slot:hover {
      background: rgba(255, 255, 255, 0.08);
      border-color: rgba(245, 158, 11, 0.35);
      transform: translateY(-1px);
    }

    .backup-slot.empty {
      opacity: 0.3;
      cursor: default;
    }

    .backup-slot.empty:hover {
      background: rgba(255, 255, 255, 0.05);
      border-color: rgba(255, 255, 255, 0.1);
      transform: none;
    }

    .backup-status {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 11px;
      color: var(--muted);
    }

    .backup-dot {
      width: 7px;
      height: 7px;
      border-radius: 50%;
      background: #22c55e;
      animation: pulse 2s infinite;
    }

    .backup-dot.warning {
      background: #f59e0b;
    }

    .backup-dot.error {
      background: #ef4444;
    }

    @keyframes pulse {

      0%,
      100% {
        opacity: 1;
      }

      50% {
        opacity: 0.5;
      }
    }

    #cart-list>div {
      background: rgba(255, 255, 255, 0.08);
      border: 1.5px solid rgba(255, 255, 255, 0.12);
      border-left: 3px solid rgba(245, 158, 11, 0.3);
      border-radius: 16px;
      padding: 14px 16px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
      transition: transform 0.25s cubic-bezier(0.34, 1.56, 0.64, 1),
        background 0.2s ease-out,
        box-shadow 0.2s ease-out;
      will-change: transform;
      backface-visibility: hidden;
      -webkit-backface-visibility: hidden;
    }

    #cart-list>div:hover {
      background: rgba(255, 255, 255, 0.11);
      border-color: rgba(255, 255, 255, 0.16);
      border-left-color: rgba(245, 158, 11, 0.5);
      transform: translateX(4px);
      box-shadow: 0 6px 16px rgba(0, 0, 0, 0.2);
    }

    .template-card {
      background: rgba(245, 158, 11, 0.08);
      border: 1.5px solid rgba(245, 158, 11, 0.18);
      border-radius: 16px;
      padding: 14px 16px;
      cursor: pointer;
      transition: transform 0.25s cubic-bezier(0.34, 1.56, 0.64, 1),
        background 0.2s ease-out,
        box-shadow 0.2s ease-out;
      position: relative;
      overflow: hidden;
      min-height: 90px;
      will-change: transform;
      backface-visibility: hidden;
      -webkit-backface-visibility: hidden;
    }

    .template-card:hover {
      background: rgba(245, 158, 11, 0.14);
      border-color: rgba(245, 158, 11, 0.35);
      transform: translateY(-4px) scale(1.01);
      box-shadow: 0 12px 28px rgba(245, 158, 11, 0.2);
    }

    .template-card:active {
      transform: translateY(0) scale(0.98);
    }

    .template-card .template-name {
      font-size: 13px;
      font-weight: 700;
      color: #f59e0b;
      margin-bottom: 4px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .template-card .template-info {
      font-size: 11px;
      color: #64748b;
    }

    .template-card .template-price {
      font-size: 12px;
      font-weight: 800;
      color: #e2e8f0;
      font-family: "SF Mono", Monaco, "Cascadia Code", "Roboto Mono", Consolas, "Courier New", monospace;
      margin-top: 6px;
    }

    .template-card .template-delete {
      position: absolute;
      top: 8px;
      right: 8px;
      width: 28px;
      height: 28px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 8px;
      background: rgba(239, 68, 68, 0.15);
      color: rgba(239, 68, 68, 0.8);
      opacity: 0;
      transition: all 0.2s;
    }

    .template-card:hover .template-delete {
      opacity: 1;
    }

    .template-card .template-delete:hover {
      background: rgba(239, 68, 68, 0.3);
      color: #ef4444;
    }

    .rounding-btn {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 8px 12px;
      border-radius: 12px;
      background: rgba(255, 255, 255, 0.06);
      border: 1.5px solid rgba(255, 255, 255, 0.1);
      color: #94a3b8;
      font-size: 12px;
      font-weight: 600;
      font-family: "SF Mono", Monaco, "Cascadia Code", "Roboto Mono", Consolas, "Courier New", monospace;
      transition: all 0.2s;
      min-height: 42px;
    }

    .rounding-btn:hover {
      background: rgba(245, 158, 11, 0.12);
      border-color: rgba(245, 158, 11, 0.3);
      color: #f59e0b;
      transform: translateY(-1px);
    }

    .rounding-btn-main {
      background: rgba(245, 158, 11, 0.1);
      border-color: rgba(245, 158, 11, 0.25);
      color: #f59e0b;
      font-weight: 700;
    }

    .rounding-btn-main:hover {
      background: rgba(245, 158, 11, 0.18);
    }

    .rounding-btn-reset {
      width: 32px;
      height: 32px;
      padding: 0;
      border-radius: 8px;
      background: rgba(239, 68, 68, 0.12);
      border: 1.5px solid rgba(239, 68, 68, 0.22);
      color: rgba(239, 68, 68, 0.8);
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
    }

    .rounding-btn-reset:hover {
      background: rgba(239, 68, 68, 0.2);
      color: #ef4444;
    }

    .variant-card {
      background: rgba(255, 255, 255, 0.05);
      border: 1.5px solid rgba(255, 255, 255, 0.1);
      border-radius: 18px;
      padding: 18px 20px;
      cursor: pointer;
      transition: transform 0.25s cubic-bezier(0.34, 1.56, 0.64, 1),
        background 0.2s ease-out,
        box-shadow 0.25s ease-out;
      position: relative;
      min-height: 140px;
      will-change: transform;
      backface-visibility: hidden;
      -webkit-backface-visibility: hidden;
    }

    .variant-card:hover {
      background: rgba(255, 255, 255, 0.08);
      border-color: rgba(245, 158, 11, 0.35);
      transform: translateY(-4px) scale(1.01);
      box-shadow: 0 16px 36px rgba(0, 0, 0, 0.35);
    }

    .variant-card:active {
      transform: translateY(0) scale(0.98);
    }

    .variant-card.variant-base {
      border-color: rgba(100, 116, 139, 0.35);
    }

    .variant-card.variant-base:hover {
      border-color: rgba(100, 116, 139, 0.5);
    }

    .variant-card.variant-optimal {
      border-color: rgba(245, 158, 11, 0.35);
      background: rgba(245, 158, 11, 0.06);
    }

    .variant-card.variant-optimal:hover {
      border-color: rgba(245, 158, 11, 0.5);
      background: rgba(245, 158, 11, 0.12);
    }

    .variant-card.variant-premium {
      border-color: rgba(168, 85, 247, 0.35);
      background: rgba(168, 85, 247, 0.06);
    }

    .variant-card.variant-premium:hover {
      border-color: rgba(168, 85, 247, 0.5);
      background: rgba(168, 85, 247, 0.12);
    }

    .variant-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 10px;
    }

    .variant-badge {
      font-size: 10px;
      font-weight: 800;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      padding: 5px 10px;
      border-radius: 8px;
    }

    .variant-badge.badge-base {
      background: rgba(100, 116, 139, 0.25);
      color: #94a3b8;
    }

    .variant-badge.badge-optimal {
      background: rgba(245, 158, 11, 0.25);
      color: #f59e0b;
    }

    .variant-badge.badge-premium {
      background: rgba(168, 85, 247, 0.25);
      color: #a855f7;
    }

    .variant-price {
      font-size: 22px;
      font-weight: 800;
      font-family: "SF Mono", Monaco, "Cascadia Code", "Roboto Mono", Consolas, "Courier New", monospace;
    }

    .variant-price.price-base {
      color: #94a3b8;
    }

    .variant-price.price-optimal {
      color: #f59e0b;
    }

    .variant-price.price-premium {
      color: #a855f7;
    }

    .variant-items {
      font-size: 13px;
      color: #94a3b8;
      line-height: 1.6;
    }

    .variant-items li {
      padding: 4px 0;
      padding-left: 16px;
      position: relative;
    }

    .variant-items li::before {
      content: "‚Ä¢";
      position: absolute;
      left: 0;
      color: #64748b;
    }

    .variant-bonuses {
      margin-top: 10px;
      padding-top: 10px;
      border-top: 1px solid rgba(255, 255, 255, 0.08);
    }

    .variant-bonus-tag {
      display: inline-block;
      font-size: 10px;
      font-weight: 700;
      background: rgba(34, 197, 94, 0.18);
      color: #22c55e;
      padding: 4px 8px;
      border-radius: 6px;
      margin-right: 6px;
      margin-bottom: 6px;
    }

    .variant-copy-hint {
      position: absolute;
      top: 50%;
      right: 20px;
      transform: translateY(-50%);
      opacity: 0;
      transition: opacity 0.2s;
      color: #64748b;
      font-size: 12px;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .variant-card:hover .variant-copy-hint {
      opacity: 1;
    }

    .variant-recommended {
      position: absolute;
      top: -10px;
      right: 16px;
      font-size: 9px;
      font-weight: 800;
      text-transform: uppercase;
      background: linear-gradient(135deg, #f59e0b, #f97316);
      color: #000;
      padding: 4px 10px;
      border-radius: 6px;
      letter-spacing: 0.06em;
    }

    .animate-enter {
      animation: enter .25s ease both;
    }

    @keyframes iconPulse {

      0%,
      100% {
        transform: scale(1);
      }

      50% {
        transform: scale(1.05);
      }
    }

    @keyframes goldGlow {

      0%,
      100% {
        box-shadow: 0 12px 30px rgba(245, 158, 11, .2), 0 0 0 0 rgba(245, 158, 11, 0);
      }

      50% {
        box-shadow: 0 16px 40px rgba(245, 158, 11, .35), 0 0 25px rgba(245, 158, 11, .2);
      }
    }

    @keyframes enter {
      from {
        opacity: 0;
        transform: translateY(8px);
      }

      to {
        opacity: 1;
        transform: none;
      }
    }

    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateX(-12px) scale(0.95);
      }

      to {
        opacity: 1;
        transform: translateX(0) scale(1);
      }
    }

    .animate-slide-in {
      animation: slideIn 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
    }

    @keyframes fadeOut {
      0% {
        opacity: 1;
        transform: scale(1) translateX(0);
        filter: blur(0px) brightness(1);
      }

      30% {
        transform: scale(1.02) translateX(8px);
        filter: blur(0px) brightness(1.2);
      }

      100% {
        opacity: 0;
        transform: scale(0.92) translateX(30px);
        filter: blur(6px) brightness(0.3);
      }
    }

    .animate-fade-out {
      animation: fadeOut 0.4s ease-out forwards;
    }

    .round-pulse {
      animation: roundPulse 0.3s ease;
    }

    @keyframes roundPulse {
      0% {
        transform: scale(1);
      }

      50% {
        transform: scale(1.05);
      }

      100% {
        transform: scale(1);
      }
    }

    .error-input {
      border-color: #ef4444 !important;
      animation: shake 0.3s;
    }

    @keyframes shake {

      0%,
      100% {
        transform: translateX(0);
      }

      25% {
        transform: translateX(-5px);
      }

      75% {
        transform: translateX(5px);
      }
    }

    #bg-canvas {
      position: fixed;
      inset: 0;
      z-index: 0;
      pointer-events: none;
      opacity: 0.6;
    }

    #import-file-input {
      display: none;
    }

    .hidden {
      display: none !important;
    }

    @media (max-width:768px) {
      .lg\:grid-cols-2 {
        grid-template-columns: 1fr !important;
      }

      .lg\:col-span-2 {
        grid-column: span 1 !important;
      }
    }

    @media (max-width:640px) {
      .grid-cols-2.md\:grid-cols-4 {
        grid-template-columns: repeat(2, 1fr) !important;
      }

      .grid-cols-5 {
        grid-template-columns: repeat(3, 1fr) !important;
      }
    }

    @media (max-width:480px) {
      .glass.rounded-3xl {
        border-radius: 24px !important;
        padding: 20px !important;
      }

      header {
        padding: 12px 16px !important;
      }

      .btn-gold,
      .btn-secondary {
        padding: 12px 16px !important;
        font-size: 14px !important;
      }

      .edit-row {
        flex-wrap: wrap !important;
        gap: 8px !important;
      }

      .backup-slot {
        padding: 8px !important;
        min-height: 56px !important;
      }
    }

    @media (max-width:430px) {
      main {
        padding-left: 8px !important;
        padding-right: 8px !important;
      }

      .glass.rounded-3xl {
        padding: 16px !important;
      }

      .grid.gap-6 {
        gap: 12px !important;
      }

      .grid.gap-4 {
        gap: 8px !important;
      }

      * {
        max-width: 100%;
      }
    }

    @media (max-width:380px) {
      header .font-cinzel {
        font-size: 16px !important;
      }

      .backup-status {
        display: none !important;
      }

      main {
        padding-left: 4px !important;
        padding-right: 4px !important;
      }

      .glass.rounded-3xl {
        padding: 12px !important;
      }
    }

    @media (min-width:431px) {

      /* –ë–æ–ª—å—à–∏–µ —ç–∫—Ä–∞–Ω—ã (iPhone 14 Pro Max+, Galaxy Ultra) */
      main {
        padding-left: max(20px, env(safe-area-inset-left)) !important;
        padding-right: max(20px, env(safe-area-inset-right)) !important;
      }

      .glass.rounded-3xl {
        padding: 24px !important;
      }

      .btn-gold,
      .btn-secondary {
        min-height: 56px;
      }

      .btn-icon,
      .btn-qty {
        width: 52px;
        height: 52px;
      }

      .btn-del-mini {
        width: 48px;
        height: 48px;
      }
    }

    /* === DRAWER: –ë—ã—Å—Ç—Ä—ã–µ –æ—Ç–≤–µ—Ç—ã === */
    .drawer-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.6);
      backdrop-filter: blur(4px);
      z-index: 9000;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.3s ease, visibility 0.3s ease;
    }

    .drawer-overlay.open {
      opacity: 1;
      visibility: visible;
    }

    .drawer-panel {
      position: absolute;
      right: 0;
      top: 0;
      bottom: 0;
      width: 320px;
      max-width: 85vw;
      background: rgba(15, 15, 20, 0.95);
      backdrop-filter: blur(20px);
      border-left: 1px solid rgba(255, 255, 255, 0.1);
      display: flex;
      flex-direction: column;
      transform: translateX(100%);
      transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .drawer-overlay.open .drawer-panel {
      transform: translateX(0);
    }

    .drawer-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 16px 20px;
      padding-top: max(16px, env(safe-area-inset-top));
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .drawer-title {
      display: flex;
      align-items: center;
      gap: 10px;
      font-weight: 700;
      font-size: 16px;
      color: #fff;
    }

    .drawer-hint {
      padding: 12px 20px;
      font-size: 12px;
      color: rgba(255, 255, 255, 0.5);
      border-bottom: 1px solid rgba(255, 255, 255, 0.05);
    }

    .drawer-content {
      flex: 1;
      overflow-y: auto;
      padding: 16px;
      -webkit-overflow-scrolling: touch;
    }

    .drawer-content::-webkit-scrollbar {
      width: 4px;
    }

    .drawer-content::-webkit-scrollbar-thumb {
      background: rgba(255, 255, 255, 0.2);
      border-radius: 2px;
    }

    .drawer-footer {
      padding: 16px 20px;
      padding-bottom: max(16px, env(safe-area-inset-bottom));
      border-top: 1px solid rgba(255, 255, 255, 0.1);
    }

    .drawer-template-card {
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 12px;
      padding: 14px;
      margin-bottom: 10px;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .drawer-template-card:hover {
      background: rgba(255, 255, 255, 0.08);
      border-color: rgba(245, 158, 11, 0.3);
    }

    .drawer-template-card:active {
      transform: scale(0.98);
    }

    .drawer-template-name {
      font-weight: 600;
      font-size: 14px;
      color: #fff;
      margin-bottom: 6px;
    }

    .drawer-template-preview {
      font-size: 12px;
      color: rgba(255, 255, 255, 0.5);
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
      word-break: break-word;
      line-height: 1.4;
    }

    .drawer-template-actions {
      display: flex;
      gap: 8px;
      margin-top: 10px;
      justify-content: flex-end;
    }

    .drawer-empty {
      text-align: center;
      padding: 40px 20px;
      color: rgba(255, 255, 255, 0.4);
      font-size: 14px;
    }

    .drawer-empty-icon {
      font-size: 40px;
      margin-bottom: 12px;
    }

    /* –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä —Å–≤–∞–π–ø–∞ */
    .swipe-indicator {
      position: fixed;
      right: 0;
      top: 50%;
      transform: translateY(-50%);
      width: 4px;
      height: 60px;
      background: rgba(245, 158, 11, 0.3);
      border-radius: 4px 0 0 4px;
      z-index: 8999;
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    .swipe-indicator.visible {
      opacity: 1;
    }
  </style>
  <style>
    #premium-dialog-overlay {
      position: fixed;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 99999;
      background: rgba(0, 0, 0, .55);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      padding: 16px
    }

    #premium-dialog-overlay.active {
      display: flex
    }

    #premium-dialog {
      width: min(520px, 92vw);
      border-radius: 18px;
      overflow: hidden;
      background: linear-gradient(180deg, rgba(17, 24, 39, .92), rgba(2, 6, 23, .92));
      border: 1px solid rgba(245, 158, 11, .22);
      box-shadow: 0 20px 60px rgba(0, 0, 0, .55);
    }

    #premium-dialog .pd-head {
      display: flex;
      gap: 12px;
      align-items: flex-start;
      padding: 16px 16px 10px
    }

    #premium-dialog .pd-icon {
      flex: 0 0 auto;
      width: 42px;
      height: 42px;
      border-radius: 14px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(245, 158, 11, .12);
      border: 1px solid rgba(245, 158, 11, .25)
    }

    #premium-dialog .pd-title {
      font-weight: 700;
      color: #fff;
      font-size: 15px;
      line-height: 1.2;
      margin-top: 2px
    }

    #premium-dialog .pd-msg {
      color: rgba(226, 232, 240, .92);
      font-size: 13px;
      line-height: 1.35;
      margin-top: 6px;
      white-space: pre-wrap
    }

    #premium-dialog .pd-body {
      padding: 0 16px 12px
    }

    #premium-dialog .pd-input {
      width: 100%;
      margin-top: 10px;
      padding: 12px 12px;
      border-radius: 14px;
      background: rgba(2, 6, 23, .55);
      border: 1px solid rgba(148, 163, 184, .18);
      color: #fff;
      outline: none
    }

    #premium-dialog .pd-input:focus {
      border-color: rgba(245, 158, 11, .55);
      box-shadow: 0 0 0 3px rgba(245, 158, 11, .15)
    }

    #premium-dialog .pd-actions {
      display: flex;
      gap: 10px;
      justify-content: flex-end;
      padding: 12px 16px 16px
    }

    #premium-dialog .pd-btn {
      border-radius: 14px;
      padding: 10px 14px;
      font-size: 13px;
      font-weight: 600;
      border: 1px solid rgba(148, 163, 184, .18);
      background: rgba(15, 23, 42, .55);
      color: #fff;
      cursor: pointer
    }

    #premium-dialog .pd-btn:hover {
      transform: translateY(-1px)
    }

    #premium-dialog .pd-btn:active {
      transform: translateY(0)
    }

    #premium-dialog .pd-btn.ok {
      border-color: rgba(245, 158, 11, .35);
      background: linear-gradient(180deg, rgba(245, 158, 11, .28), rgba(245, 158, 11, .14))
    }

    #premium-dialog .pd-btn.danger {
      border-color: rgba(239, 68, 68, .35);
      background: linear-gradient(180deg, rgba(239, 68, 68, .22), rgba(239, 68, 68, .10))
    }

    #premium-dialog .pd-btn.ghost {
      background: rgba(15, 23, 42, .25)
    }
  </style>

  <style>
    /* Perf: –∏–∑–æ–ª—è—Ü–∏—è layout –¥–ª—è —Å–µ–∫—Ü–∏–π –Ω–∞—Å—Ç—Ä–æ–µ–∫ */
    #view-settings .panel .glass {
      contain: layout style paint;
    }
  </style>

  <!-- ============================================
     FIREBASE SDK
     ============================================ -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>

  <script>
    const FIREBASE_CONFIG = {
      apiKey: "AIzaSyBEL4XCzjmHaqu4RbTqNzEKPi2Vfc4LXSI",
      authDomain: "calc76.firebaseapp.com",
      databaseURL: "https://calc76-default-rtdb.firebaseio.com",
      projectId: "calc76",
      storageBucket: "calc76.firebasestorage.app",
      messagingSenderId: "972929668805",
      appId: "1:972929668805:web:de4aa4097f03b97d39c2ac"
    };

    window.firebaseDB = null;
    window.firebaseEnabled = false;

    function initFirebase() {
      if (typeof firebase === 'undefined') {
        window.firebaseEnabled = false;
        return;
      }
      try {
        if (!firebase.apps.length) {
          firebase.initializeApp(FIREBASE_CONFIG);
        }
        window.firebaseDB = firebase.database();
        window.firebaseEnabled = true;
        console.log('‚úÖ Firebase initialized');
      } catch (error) {
        window.firebaseEnabled = false;
        console.warn('‚ö†Ô∏è Firebase init failed:', error);
      }
    }

    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initFirebase);
    } else {
      initFirebase();
    }

    // –ì–ª–æ–±–∞–ª—å–Ω—ã–π fingerprint —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ (–¥–ª—è Firebase sync –º–µ–∂–¥—É –ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä–æ–º –∏ –ö–∞–ª–µ–Ω–¥–∞—Ä—ë–º)
    window.getDeviceFingerprint = function () {
      var nav = navigator;
      var scr = window.screen;
      var components = [nav.userAgent, nav.language, scr.colorDepth, scr.width + 'x' + scr.height];
      var hash = 0;
      var str = components.join('|');
      for (var i = 0; i < str.length; i++) {
        var c = str.charCodeAt(i);
        hash = ((hash << 5) - hash) + c;
        hash = hash & hash;
      }
      return 'DEV-' + Math.abs(hash).toString(36).toUpperCase();
    };
  </script>

</head>

<body class="min-h-screen">

  <!-- –°–¢–ê–ë–ò–õ–¨–ù–ê–Ø –ó–ê–°–¢–ê–í–ö–ê (–ù–ï –ü–†–´–ì–ê–ï–¢ –í PWA) -->
  <div id="simple-splash"
    style="position:fixed;top:0;left:0;width:100%;height:100%;background:#050507;display:flex;align-items:center;justify-content:center;z-index:999999;margin:0;padding:0;overflow:hidden;">
    <div style="text-align:center;max-width:90%;">
      <div
        style="width:120px;height:120px;margin:0 auto 24px;background:linear-gradient(135deg,rgba(245,158,11,0.15),rgba(251,191,36,0.08));border:2px solid rgba(245,158,11,0.3);border-radius:28px;display:flex;align-items:center;justify-content:center;animation:pulse 2s ease-in-out infinite;box-shadow:0 20px 60px rgba(245,158,11,0.2),0 0 0 1px rgba(255,255,255,0.05) inset;">
        <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="#f59e0b"
          stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <rect width="16" height="20" x="4" y="2" rx="2" />
          <line x1="8" x2="16" y1="6" y2="6" />
          <line x1="16" x2="16" y1="14" y2="18" />
          <path d="M16 10h.01" />
          <path d="M12 10h.01" />
          <path d="M8 10h.01" />
          <path d="M12 14h.01" />
          <path d="M8 14h.01" />
          <path d="M12 18h.01" />
          <path d="M8 18h.01" />
        </svg>
      </div>
      <h1
        style="font-family:Georgia,'Palatino Linotype','Book Antiqua',Palatino,'Times New Roman',serif;font-size:clamp(24px,7vw,36px);font-weight:700;background:linear-gradient(135deg,#f59e0b,#fbbf24);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;margin:0 0 6px 0;letter-spacing:4px;line-height:1.2;">
        ILLUSIONIST OS</h1>
      <p
        style="font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,'Helvetica Neue',Arial,sans-serif;font-size:clamp(9px,2.5vw,11px);color:rgba(148,163,184,0.75);letter-spacing:1.5px;text-transform:uppercase;margin:0 0 16px 0;line-height:1.4;">
        –£–º–Ω—ã–π –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –¥–ª—è –∞—Ä—Ç–∏—Å—Ç–æ–≤</p>
      <p style="font-size:clamp(10px,3vw,12px);color:rgba(148,163,184,0.5);letter-spacing:2px;line-height:1.4;">
        –ó–∞–≥—Ä—É–∑–∫–∞...</p>
    </div>
  </div>

  <!-- –†–ê–ù–ù–Ø–Ø –ü–†–û–í–ï–†–ö–ê: –µ—Å–ª–∏ –ª–∏—Ü–µ–Ω–∑–∏–∏ –Ω–µ—Ç –≤ localStorage, —Å—Ä–∞–∑—É —Å–∫—Ä—ã–≤–∞–µ–º –∑–∞—Å—Ç–∞–≤–∫—É -->
  <script>
    (function () {
      var lic = localStorage.getItem('illusionist_license');
      if (!lic) {
        var s = document.getElementById('simple-splash');
        if (s) s.style.display = 'none';
      }
    })();
  </script>

  <!-- –ë–õ–û–ö–ò–†–û–í–ö–ê –î–ï–°–ö–¢–û–ü–ê - –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –Ω–∞ –ü–ö -->
  <div id="desktop-block"
    style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:#050507;z-index:999998;align-items:center;justify-content:center;padding:40px 20px;">
    <div style="text-align:center;max-width:500px;">
      <div
        style="width:120px;height:120px;margin:0 auto 32px;background:linear-gradient(135deg,rgba(245,158,11,0.15),rgba(251,191,36,0.08));border:2px solid rgba(245,158,11,0.3);border-radius:28px;display:flex;align-items:center;justify-content:center;box-shadow:0 20px 60px rgba(245,158,11,0.2),0 0 0 1px rgba(255,255,255,0.05) inset;">
        <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="#f59e0b"
          stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <rect x="5" y="2" width="14" height="20" rx="2" ry="2"></rect>
          <line x1="12" y1="18" x2="12.01" y2="18"></line>
        </svg>
      </div>
      <h1
        style="font-family:Georgia,'Palatino Linotype','Book Antiqua',Palatino,'Times New Roman',serif;font-size:32px;font-weight:700;background:linear-gradient(135deg,#f59e0b,#fbbf24);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;margin:0 0 16px 0;letter-spacing:2px;">
        üì± –¢–æ–ª—å–∫–æ –¥–ª—è —Å–º–∞—Ä—Ç—Ñ–æ–Ω–æ–≤</h1>
      <p
        style="font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,'Helvetica Neue',Arial,sans-serif;font-size:18px;color:#94a3b8;line-height:1.6;margin:0 0 24px 0;">
        –≠—Ç–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–æ –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤.</p>
      <p
        style="font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,'Helvetica Neue',Arial,sans-serif;font-size:16px;color:#64748b;line-height:1.5;margin:0;">
        –û—Ç–∫—Ä–æ–π—Ç–µ —ç—Ç—É —Å—Ç—Ä–∞–Ω–∏—Ü—É –Ω–∞ —Å–≤–æ—ë–º<br><strong style="color:#f59e0b;">iPhone –∏–ª–∏ Android</strong> —Å–º–∞—Ä—Ç—Ñ–æ–Ω–µ.</p>
    </div>
  </div>

  <!-- –ú–ê–ì–ò–ß–ï–°–ö–ê–Ø –ê–ù–ò–ú–ê–¶–ò–Ø -->
  <div id="magic-welcome"
    style="position:fixed;inset:0;background:rgba(10,10,15,0.95);display:none;align-items:center;justify-content:center;z-index:999998;opacity:0;">
    <div style="text-align:center;">
      <div style="font-size:100px;margin-bottom:20px;animation:magic-spin 1s ease-out;">‚ú®</div>
      <h2
        style="font-family:'Cinzel',serif;font-size:32px;background:linear-gradient(135deg,#f59e0b,#fbbf24);-webkit-background-clip:text;-webkit-text-fill-color:transparent;margin:0 0 10px 0;">
        –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å</h2>
      <p style="font-family:'Cinzel',serif;font-size:20px;color:#f59e0b;">–≤ –º–∞–≥–∏—á–µ—Å–∫–æ–µ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–æ</p>
    </div>
  </div>

  <style>
    @keyframes pulse {

      0%,
      100% {
        transform: scale(1);
        opacity: 1
      }

      50% {
        transform: scale(1.05);
        opacity: 0.9
      }
    }

    @keyframes magic-spin {
      0% {
        transform: scale(0) rotate(0deg);
        opacity: 0
      }

      50% {
        transform: scale(1.2) rotate(180deg);
        opacity: 1
      }

      100% {
        transform: scale(1) rotate(360deg);
        opacity: 1
      }
    }
  </style>



  <input type="file" id="import-file-input" accept=".json,.backup" />
  <canvas id="bg-canvas"></canvas>

  <!-- ========== FLOATING CARDS –£–î–ê–õ–ï–ù–´ ========== -->

  <!-- ========== –°–¢–ê–†–ê–Ø –ó–ê–°–¢–ê–í–ö–ê –£–î–ê–õ–ï–ù–ê ========== -->

  <!-- ========== TOAST ========== -->
  <div id="toast">
    <div class="glass rounded-2xl px-5 py-4 shadow-xl">
      <div class="flex items-center gap-3">
        <i data-lucide="bell" class="w-5 h-5 text-amber-400"></i>
        <div id="toast-msg" class="text-base text-slate-200 font-semibold"></div>
      </div>
    </div>
  </div>

  <!-- ========== HEADER ========== -->
  <header id="app-header" class="relative z-10" style="display:none;">
    <div class="max-w-5xl mx-auto flex items-center justify-between">
      <div class="flex items-center gap-4">
        <div class="w-12 h-12 rounded-2xl glass flex items-center justify-center"
          style="animation: iconPulse 3s ease-in-out infinite;">
          <i data-lucide="calculator" class="w-6 h-6 text-amber-400"></i>
        </div>
        <div>
          <div class="font-cinzel text-white tracking-wide text-lg">Illusionist OS</div>
          <div class="flex items-center gap-2">
            <span class="text-sm text-slate-400 font-semibold">–£–º–Ω—ã–π –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä</span>
            <div id="backup-indicator" class="backup-status">
              <span class="backup-dot"></span>
              <span id="backup-status-text">–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ</span>
            </div>
          </div>
        </div>
      </div>

      <button id="btn-settings" class="btn-icon" aria-label="–ù–∞—Å—Ç—Ä–æ–π–∫–∏">
        <i data-lucide="settings" class="w-6 h-6 text-slate-200"></i>
      </button>
    </div>
  </header>

  <!-- ========== MAIN ========== -->
  <main id="app-main" class="relative z-10 px-4 pb-10" style="display:none;">
    <div class="max-w-5xl mx-auto mt-6 grid grid-cols-1 lg:grid-cols-2 gap-6">

      <!-- ========== LEFT PANEL ========== -->
      <section class="glass rounded-3xl p-6">
        <div class="flex items-center justify-between mb-4">
          <div class="text-lg font-extrabold text-white tracking-wide">–î–∞–Ω–Ω—ã–µ</div>
          <div id="holiday-alert"
            class="hidden text-xs font-extrabold text-amber-400 bg-amber-500/10 border border-amber-500/20 px-4 py-2 rounded-full">
            –ü—Ä–∞–∑–¥–Ω–∏–∫: x<span id="holiday-k">1</span>
          </div>
        </div>

        <!-- Date & Time -->
        <div class="grid grid-cols-2 gap-4 mb-4">
          <div>
            <label class="text-sm text-slate-400 font-bold mb-2 block">–î–∞—Ç–∞</label>
            <input type="date" id="inp-date" class="form-input" />
          </div>
          <div>
            <label class="text-sm text-slate-400 font-bold mb-2 block">–í—Ä–µ–º—è</label>
            <select id="inp-time-mode" class="form-input mb-2">
              <option value="time" selected>–£–∫–∞–∑–∞—Ç—å –≤—Ä–µ–º—è</option>
              <option value="none">–ë–µ–∑ –≤—Ä–µ–º–µ–Ω–∏</option>
            </select>
            <input type="time" id="inp-time" class="form-input" value="18:00" />
          </div>
        </div>
        <!-- Region & City -->
        <div class="grid grid-cols-2 gap-4 mb-4">
          <div>
            <label class="text-sm text-slate-400 font-bold mb-2 block">–†–µ–≥–∏–æ–Ω</label>
            <select id="inp-region" class="form-input"></select>
          </div>
          <div>
            <label class="text-sm text-slate-400 font-bold mb-2 block">–ì–æ—Ä–æ–¥</label>
            <select id="inp-city" class="form-input" disabled></select>
          </div>
        </div>

        <!-- Category & Service -->
        <div class="grid grid-cols-2 gap-4 mb-4">
          <div>
            <label class="text-sm text-slate-400 font-bold mb-2 block">–ö–∞—Ç–µ–≥–æ—Ä–∏—è</label>
            <select id="inp-cat" class="form-input"></select>
          </div>
          <div>
            <label class="text-sm text-slate-400 font-bold mb-2 block">–£—Å–ª—É–≥–∞</label>
            <select id="inp-svc" class="form-input" disabled></select>
          </div>
        </div>

        <!-- Quantity & Add Button -->
        <div class="flex items-center gap-4 mb-6">
          <div class="flex items-center gap-3">
            <button id="btn-qty-minus" class="btn-qty" aria-label="–ú–∏–Ω—É—Å">
              <i data-lucide="minus" class="w-6 h-6 text-slate-200"></i>
            </button>
            <div class="glass rounded-2xl px-5 py-3 text-base font-extrabold mono min-w-[60px] text-center">
              x<span id="svc-qty">1</span>
            </div>
            <button id="btn-qty-plus" class="btn-qty" aria-label="–ü–ª—é—Å">
              <i data-lucide="plus" class="w-6 h-6 text-slate-200"></i>
            </button>
          </div>

          <button id="btn-add-service" class="flex-1 btn-gold">
            <span class="flex items-center justify-center gap-2">
              <i data-lucide="plus-circle" class="w-5 h-5"></i>
              –î–æ–±–∞–≤–∏—Ç—å
            </span>
          </button>
        </div>

        <!-- Extras -->
        <div class="border-t border-white/10 pt-6">
          <div class="text-lg font-extrabold text-white mb-4">–î–æ–ø–ª–∞—Ç—ã</div>

          <div class="grid grid-cols-2 gap-4 mb-4">
            <div>
              <label class="text-sm text-slate-400 font-bold mb-2 block">–ù–∞–∑–≤–∞–Ω–∏–µ</label>
              <input id="inp-manual-name" class="form-input" placeholder="–ù–∞–ø—Ä. –ê—Ä–µ–Ω–¥–∞ –∑–∞–ª–∞" />
            </div>
            <div>
              <label class="text-sm text-slate-400 font-bold mb-2 block">–°—É–º–º–∞</label>
              <input id="inp-manual-price" type="number" class="form-input text-right mono" placeholder="0" />
            </div>
          </div>

          <div class="grid grid-cols-2 gap-4">
            <div>
              <label class="text-sm text-slate-400 font-bold mb-2 block">–ì–æ—Å—Ç–∏</label>
              <select id="inp-guests" class="form-input">
                <option value="0">–ë–µ–∑ –¥–æ–ø–ª–∞—Ç—ã</option>
                <option value="1000">+1 000 ‚ÇΩ</option>
                <option value="2000">+2 000 ‚ÇΩ</option>
                <option value="3000">+3 000 ‚ÇΩ</option>
              </select>
            </div>

            <div class="flex items-end">
              <div class="flex flex-col gap-2 w-full">
                <label
                  class="flex items-center gap-3 text-sm text-slate-200 font-bold bg-white/5 px-4 py-2 rounded-2xl w-full cursor-pointer hover:bg-white/10 transition">
                  <input type="checkbox" id="inp-tax" class="accent-amber-500 w-5 h-5" />
                  <span id="lbl-cashless">–û–ø–ª–∞—Ç–∞ –ø–æ –±–µ–∑–Ω–∞–ª—É</span>
                </label>
                <label
                  class="flex items-center gap-3 text-sm text-slate-200 font-bold bg-white/5 px-4 py-2 rounded-2xl w-full cursor-pointer hover:bg-white/10 transition">
                  <input type="checkbox" id="inp-agency" class="accent-amber-500 w-5 h-5" />
                  <div class="flex items-center justify-between w-full gap-2">
                    <span id="lbl-agency">–ö–æ–º–∏—Å—Å–∏—è –∞–≥–µ–Ω—Ç—Å—Ç–≤–∞</span>

                  </div>
                </label>

                <label
                  class="flex items-center gap-3 text-sm text-slate-200 font-bold bg-white/5 px-4 py-2 rounded-2xl w-full cursor-pointer hover:bg-white/10 transition">
                  <input type="checkbox" id="inp-show-bonuses" class="accent-amber-500 w-5 h-5" checked />
                  <span>–ü–æ–∫–∞–∑—ã–≤–∞—Ç—å –±–æ–Ω—É—Å—ã –≤ –ö–ü</span>
                </label>

                <label
                  class="flex items-center gap-3 text-sm text-slate-200 font-bold bg-white/5 px-4 py-2 rounded-2xl w-full cursor-pointer hover:bg-white/10 transition">
                  <input type="checkbox" id="inp-burn" class="accent-amber-500 w-5 h-5" />
                  <span id="lbl-burn">–ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –¥–µ–π—Å—Ç–≤—É–µ—Ç 48 —á–∞—Å–æ–≤</span>
                </label>

                <label
                  class="flex items-center gap-3 text-sm text-slate-200 font-bold bg-white/5 px-4 py-2 rounded-2xl w-full cursor-pointer hover:bg-white/10 transition">
                  <input type="checkbox" id="inp-show-links" class="accent-amber-500 w-5 h-5" checked />
                  <span>–ü–æ–∫–∞–∑—ã–≤–∞—Ç—å —Å—Å—ã–ª–∫–∏ –≤ –ö–ü</span>
                </label>
              </div>
            </div>

          </div>
        </div>

        <!-- Action Buttons -->
        <div class="mt-6 grid grid-cols-2 gap-3">
          <button id="btn-copy-prices" class="btn-secondary">
            <span class="flex items-center justify-center gap-2">
              <i data-lucide="list" class="w-5 h-5"></i>
              <span class="hidden sm:inline">–¶–µ–Ω—ã + –±–æ–Ω—É—Å—ã</span>
              <span class="sm:hidden">–¶–µ–Ω—ã</span>
            </span>
          </button>
          <button id="btn-copy-quote" class="btn-gold">
            <span class="flex items-center justify-center gap-2">
              <i data-lucide="copy" class="w-5 h-5"></i>
              <span class="hidden sm:inline">–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –ö–ü</span>
              <span class="sm:hidden">–ö–ü</span>
            </span>
          </button>
          <button id="btn-to-calendar" class="btn-secondary col-span-2">
            <span class="flex items-center justify-center gap-2">
              <i data-lucide="calendar-plus" class="w-5 h-5 text-amber-400"></i>
              <span>–ó–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å –≤ –∫–∞–ª–µ–Ω–¥–∞—Ä—å</span>
            </span>
          </button>
        </div>

        <div class="mt-3">
          <button id="btn-open-packages" class="btn-secondary w-full">
            <span class="flex items-center justify-center gap-2">
              <i data-lucide="package" class="w-5 h-5"></i>
              –ü–∞–∫–µ—Ç—ã
            </span>
          </button>
        </div>
      </section>

      <!-- ========== RIGHT PANEL ========== -->
      <section class="glass rounded-3xl p-6">
        <!-- Cart -->
        <div class="mb-4">
          <div class="flex items-center justify-between mb-4">
            <div class="text-lg font-extrabold text-white tracking-wide">–ö–æ—Ä–∑–∏–Ω–∞</div>
            <div id="discount-badge"
              class="hidden text-sm font-extrabold text-emerald-300 bg-emerald-500/10 border border-emerald-500/20 px-4 py-2 rounded-full animate-pulse">
              –°–∫–∏–¥–∫–∞ 10%
            </div>
          </div>

          <!-- Bulk operations panel -->
          <div id="bulk-actions-panel" class="hidden mb-4 p-3 bg-amber-500/10 border border-amber-500/20 rounded-xl">
            <div class="flex items-center justify-between">
              <div class="text-sm text-amber-300">
                <span id="selected-count">0</span> –≤—ã–±—Ä–∞–Ω–æ
              </div>
              <div class="flex gap-2">
                <button id="btn-select-all"
                  class="text-xs px-3 py-1.5 bg-white/5 hover:bg-white/10 border border-white/10 rounded-md text-slate-300 transition">
                  –í—ã–±—Ä–∞—Ç—å –≤—Å—ë
                </button>
                <button id="btn-deselect-all"
                  class="text-xs px-3 py-1.5 bg-white/5 hover:bg-white/10 border border-white/10 rounded-md text-slate-300 transition">
                  –°–Ω—è—Ç—å –≤—Å—ë
                </button>
                <button id="btn-delete-selected"
                  class="text-xs px-3 py-1.5 bg-red-500/20 hover:bg-red-500/30 border border-red-500/30 rounded-md text-red-300 transition">
                  <i data-lucide="trash-2" class="w-3.5 h-3.5 inline"></i>
                  –£–¥–∞–ª–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–µ
                </button>
              </div>
            </div>
          </div>

          <div id="cart-list" class="space-y-3"></div>

          <div id="cart-breakdown" class="space-y-2 mb-6"></div>

          <!-- Total -->
          <div class="border-t border-white/10 pt-6">
            <div class="flex items-baseline justify-between mb-4">
              <div class="text-slate-300 font-bold text-base">–ò—Ç–æ–≥–æ</div>
              <div id="total-sum" class="text-3xl font-extrabold text-amber-400 mono">0 ‚ÇΩ</div>
            </div>


            <!-- Bonuses -->
            <div>
              <div class="text-sm text-slate-400 font-bold mb-3">–ë–æ–Ω—É—Å—ã (—á—Ç–æ –ø–æ–ª—É—á–∞–µ—Ç –∫–ª–∏–µ–Ω—Ç)</div>
              <div id="bonus-list" class="flex flex-wrap gap-2 mb-4"></div>
            </div>

            <div class="text-sm text-slate-500 leading-relaxed">
              –ö–ª–∏–µ–Ω—Ç—É –≤–∞–∂–Ω–æ –∑–Ω–∞—Ç—å: <span class="text-slate-300 font-bold">—Å–∫–æ–ª—å–∫–æ</span> –∏
              <span class="text-slate-300 font-bold">—á—Ç–æ –æ–Ω –ø–æ–ª—É—á–∏—Ç</span>.
            </div>
          </div>
        </div>
      </section>

    </div>
  </main>

  <!-- ========== SETTINGS MODAL ========== -->
  <div id="view-settings" aria-hidden="true">
    <div class="panel glass p-6" style="position: relative;">

      <div class="flex items-center justify-between mb-6">
        <div>
          <div class="font-cinzel text-white text-xl mb-1">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</div>
          <div class="text-sm text-slate-400 font-semibold">–ê–¥–º–∏–Ω–∫–∞ –±–∞–∑—ã —Ü–µ–Ω ‚Ä¢ —Ä–µ–∫–≤–∏–∑–∏—Ç—ã ‚Ä¢ –±–æ–Ω—É—Å—ã</div>
        </div>
        <button id="btn-close-settings" class="btn-icon" aria-label="–ó–∞–∫—Ä—ã—Ç—å">
          <i data-lucide="x" class="w-6 h-6 text-slate-400"></i>
        </button>
      </div>


      <!-- PERSONAL INFO -->
      <div class="glass rounded-2xl p-5 mb-6 border-2 border-amber-500/20">
        <div class="flex items-center gap-3 mb-4">
          <i data-lucide="user" class="w-6 h-6 text-amber-400"></i>
          <span class="text-lg font-extrabold text-white">–ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ</span>
        </div>

        <div class="space-y-3">
          <div>
            <label class="block text-sm font-semibold text-slate-300 mb-2">
              –í–∞—à–µ –∏–º—è / –ü—Å–µ–≤–¥–æ–Ω–∏–º
            </label>
            <input type="text" id="personal-name" class="form-input" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ê–ª–µ–∫—Å–∞–Ω–¥—Ä –í–µ–ª–∏–∫–∏–π üé©"
              maxlength="100" />
            <div class="text-xs text-slate-500 mt-1">
              –ë—É–¥–µ—Ç –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è –≤ –ø–æ–¥–ø–∏—Å–∏ –ö–ü
            </div>
          </div>
        </div>
      </div>

      <!-- DATA MANAGEMENT -->
      <div class="glass rounded-2xl p-5 mb-6 border-2 border-emerald-500/20">
        <div class="flex items-center justify-between mb-4">
          <div class="flex items-center gap-3">
            <i data-lucide="database" class="w-6 h-6 text-emerald-400"></i>
            <span class="text-lg font-extrabold text-white">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã–º–∏</span>
          </div>
          <div class="text-xs text-slate-500 mono" id="db-version-display">v2.0</div>
        </div>

        <div class="grid grid-cols-3 gap-3 mb-5">
          <button id="btn-export-data" class="btn-data btn-export">
            <i data-lucide="download" class="w-5 h-5"></i>
            <span>–≠–∫—Å–ø–æ—Ä—Ç</span>
          </button>
          <button id="btn-import-data" class="btn-data btn-import">
            <i data-lucide="upload" class="w-5 h-5"></i>
            <span>–ò–º–ø–æ—Ä—Ç</span>
          </button>
          <button id="btn-create-backup" class="btn-data btn-backup">
            <i data-lucide="save" class="w-5 h-5"></i>
            <span>–ë—ç–∫–∞–ø</span>
          </button>
        </div>

        <div class="mb-4">
          <div class="text-sm text-slate-400 font-bold mb-3 flex items-center justify-between">
            <span>–ê–≤—Ç–æ–±—ç–∫–∞–ø—ã (5 —Å–ª–æ—Ç–æ–≤)</span>
            <span class="text-xs text-slate-500" id="last-backup-time">‚Äî</span>
          </div>
          <div class="grid grid-cols-5 gap-2" id="backup-slots-container"></div>
        </div>

        <div class="bg-white/5 rounded-xl p-4">
          <div class="flex items-center justify-between text-sm mb-3">
            <div class="flex items-center gap-2">
              <i data-lucide="shield-check" class="w-5 h-5 text-emerald-400"></i>
              <span class="text-slate-300 font-semibold">–¶–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö</span>
            </div>
            <span class="text-emerald-400 font-bold" id="data-integrity-status">OK</span>
          </div>
          <div class="grid grid-cols-3 gap-3 text-xs text-slate-500">
            <div>–£—Å–ª—É–≥: <span class="text-slate-300 font-bold" id="stats-services">0</span></div>
            <div>–†–µ–≥–∏–æ–Ω–æ–≤: <span class="text-slate-300 font-bold" id="stats-regions">0</span></div>
            <div>–ë–æ–Ω—É—Å–æ–≤: <span class="text-slate-300 font-bold" id="stats-bonuses">0</span></div>
          </div>
        </div>
      </div>

      <!-- Profile -->
      <div class="glass rounded-2xl p-5 mb-6">
        <div class="text-lg font-extrabold text-white mb-4">–ü—Ä–æ—Ñ–∏–ª—å</div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="text-sm text-slate-400 font-bold mb-2 block">–ë—Ä–æ–Ω—å (%)</label>
            <input id="cfg-deposit" type="number" class="form-input text-right mono" placeholder="30" />
          </div>

          <div>
            <label class="text-sm text-slate-400 font-bold mb-2 block">–û–ø–ª–∞—Ç–∞ –ø–æ –±–µ–∑–Ω–∞–ª—É (%)</label>
            <input id="cfg-cashless-percent" type="number" class="form-input text-right mono" placeholder="6" />
            <div class="text-xs text-slate-500 mt-2">–°—Ç–∞–≤–∫–∞ –Ω–∞—Ü–µ–Ω–∫–∏ –ø—Ä–∏ –æ–ø–ª–∞—Ç–µ –ø–æ –±–µ–∑–Ω–∞–ª—É (—á—Ç–æ–±—ã –∫–æ–º–ø–µ–Ω—Å–∏—Ä–æ–≤–∞—Ç—å
              –Ω–∞–ª–æ–≥–∏/—ç–∫–≤–∞–π—Ä–∏–Ω–≥).</div>
          </div>
          <div>
            <label class="text-sm text-slate-400 font-bold mb-2 block">–ö–æ–º–∏—Å—Å–∏—è –∞–≥–µ–Ω—Ç—Å—Ç–≤–∞ (%)</label>
            <input id="cfg-agency-percent" type="number" class="form-input text-right mono" placeholder="15" />
            <div class="text-xs text-slate-500 mt-2">–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è —Ä–∞—Å—á—ë—Ç–∞ ¬´–ß–µ–∫ –Ω–∞ —Ä—É–∫–∏¬ª –∏ ¬´–ß–µ–∫ –¥–ª—è –∫–ª–∏–µ–Ω—Ç–∞¬ª.</div>
          </div>

          <!-- –°–ö–ò–î–ö–ê –ó–ê –û–ë–™–Å–ú -->
          <div class="md:col-span-2 mt-4 pt-4 border-t border-white/10">
            <div class="flex items-center gap-3 mb-3">
              <i data-lucide="percent" class="w-5 h-5 text-emerald-400"></i>
              <span class="text-sm text-slate-400 font-bold">–°–∫–∏–¥–∫–∞ –∑–∞ –æ–±—ä—ë–º</span>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-3 mb-3">
              <div>
                <label class="flex items-center gap-2 cursor-pointer">
                  <input type="checkbox" id="cfg-bulk-discount-enabled" class="accent-emerald-500 w-5 h-5" />
                  <span class="text-sm text-slate-300 font-semibold">–í–∫–ª—é—á–∏—Ç—å —Å–∫–∏–¥–∫—É</span>
                </label>
              </div>

              <div>
                <label class="text-xs text-slate-500 font-semibold mb-1 block">–ü—Ä–æ—Ü–µ–Ω—Ç —Å–∫–∏–¥–∫–∏ (%)</label>
                <input id="cfg-bulk-discount-percent" type="number" class="form-input text-right mono" placeholder="10"
                  min="0" max="100" />
              </div>

              <div>
                <label class="text-xs text-slate-500 font-semibold mb-1 block">–ú–∏–Ω–∏–º—É–º —É—Å–ª—É–≥</label>
                <input id="cfg-bulk-discount-min" type="number" class="form-input text-right mono" placeholder="2"
                  min="1" max="100" />
              </div>
            </div>

            <div class="text-xs text-slate-500">
              –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è –∫–æ–≥–¥–∞ –∫–ª–∏–µ–Ω—Ç –∑–∞–∫–∞–∑—ã–≤–∞–µ—Ç –Ω–µ—Å–∫–æ–ª—å–∫–æ —É—Å–ª—É–≥. –ù–∞–ø—Ä–∏–º–µ—Ä: 10% —Å–∫–∏–¥–∫–∞ –ø—Ä–∏ –∑–∞–∫–∞–∑–µ –æ—Ç 2
              —É—Å–ª—É–≥.
            </div>
          </div>

          <!-- –°–ì–û–†–ê–Æ–©–ò–ô –ë–û–ù–£–° -->
          <div class="md:col-span-2">
            <div class="text-sm text-slate-400 font-bold mb-2 block">–°–≥–æ—Ä–∞—é—â–∏–π –±–æ–Ω—É—Å</div>
            <div class="grid grid-cols-1 md:grid-cols-4 gap-3">
              <div>
                <label class="text-xs text-slate-500 font-semibold mb-1 block">–ù–∞–∑–≤–∞–Ω–∏–µ</label>
                <input id="cfg-burn-title" type="text" class="form-input" placeholder="–ù–∞–ø—Ä. –ü–æ—è–≤–ª–µ–Ω–∏–µ –ì–µ–Ω–¥–∏—Ä–µ–∫—Ç–æ—Ä–∞"
                  maxlength="120" />
              </div>
              <div>
                <label class="text-xs text-slate-500 font-semibold mb-1 block">–°—Ç–∞—Ä–∞—è —Ü–µ–Ω–∞ (‚ÇΩ)</label>
                <input id="cfg-burn-price" type="number" class="form-input text-right mono" placeholder="15000" />
              </div>
              <div>
                <label class="text-xs text-slate-500 font-semibold mb-1 block">–ù–æ–≤–∞—è —Ü–µ–Ω–∞ (‚ÇΩ)</label>
                <input id="cfg-burn-discount-price" type="number" class="form-input text-right mono" placeholder="0" />
              </div>
              <div>
                <label class="text-xs text-slate-500 font-semibold mb-1 block">–°—Ä–æ–∫ (—á–∞—Å–æ–≤)</label>
                <input id="cfg-burn-hours" type="number" class="form-input text-right mono" placeholder="48" />
              </div>
            </div>
            <div class="text-xs text-slate-500 mt-2">
              <strong>–°—Ç–∞—Ä–∞—è —Ü–µ–Ω–∞</strong> ‚Äî –∑–∞—á—ë—Ä–∫–∏–≤–∞–µ—Ç—Å—è –≤ –ö–ü.
              <strong>–ù–æ–≤–∞—è —Ü–µ–Ω–∞</strong> ‚Äî –µ—Å–ª–∏ 0, —Ç–æ "–ë–ï–°–ü–õ–ê–¢–ù–û", –µ—Å–ª–∏ –±–æ–ª—å—à–µ 0, —Ç–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è —ç—Ç–∞ —Ü–µ–Ω–∞.
              <br>–ù–∞–ø—Ä–∏–º–µ—Ä: –°—Ç–∞—Ä–∞—è 15,000 ‚Üí –ù–æ–≤–∞—è 10,000 = —Å–∫–∏–¥–∫–∞ 5,000. –ò–ª–∏: –°—Ç–∞—Ä–∞—è 15,000 ‚Üí –ù–æ–≤–∞—è 0 = –ë–ï–°–ü–õ–ê–¢–ù–û.
            </div>
          </div>
        </div>
      </div>

      <!-- ACTIVATION STATUS -->
      <div class="glass rounded-2xl p-5 mb-6 border-2 border-amber-500/20">
        <div class="flex items-center gap-3 mb-4">
          <i data-lucide="key" class="w-6 h-6 text-amber-400"></i>
          <span class="text-lg font-extrabold text-white">–ê–∫—Ç–∏–≤–∞—Ü–∏—è</span>
        </div>

        <div class="bg-white/5 rounded-xl p-4 mb-4">
          <div class="flex items-center justify-between mb-3">
            <span class="text-sm text-slate-400 font-bold">–°—Ç–∞—Ç—É—Å –ª–∏—Ü–µ–Ω–∑–∏–∏</span>
            <span id="license-status-badge" class="text-sm font-bold">–ü—Ä–æ–≤–µ—Ä–∫–∞...</span>
          </div>

          <div class="text-xs text-slate-500 mb-2">–ö–ª—é—á –∞–∫—Ç–∏–≤–∞—Ü–∏–∏</div>
          <div id="license-key-display" class="font-mono text-sm text-slate-300 bg-black/20 rounded px-3 py-2">
            ‚Ä¢‚Ä¢‚Ä¢‚Ä¢-‚Ä¢‚Ä¢‚Ä¢‚Ä¢-‚Ä¢‚Ä¢‚Ä¢‚Ä¢-‚Ä¢‚Ä¢‚Ä¢‚Ä¢
          </div>
        </div>

        <button id="btn-reset-license-user"
          class="w-full btn-secondary bg-amber-500/10 border-amber-500/25 text-amber-300 hover:bg-amber-500/20">
          <i data-lucide="refresh-ccw" class="w-4 h-4"></i>
          <span>–°–±—Ä–æ—Å–∏—Ç—å –∞–∫—Ç–∏–≤–∞—Ü–∏—é</span>
        </button>

        <div class="text-xs text-slate-500 mt-3 text-center">
          –ü–æ—Å–ª–µ —Å–±—Ä–æ—Å–∞ –ø–æ—Ç—Ä–µ–±—É–µ—Ç—Å—è –≤–≤–µ—Å—Ç–∏ –∫–ª—é—á –∑–∞–Ω–æ–≤–æ
        </div>
      </div>

      <!-- Admin quick actions -->
      <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-6">
        <button id="btn-add-region" class="btn-add">+ –†–µ–≥–∏–æ–Ω</button>
        <button id="btn-add-category" class="btn-add">+ –ö–∞—Ç–µ–≥–æ—Ä–∏—è</button>
        <button id="btn-add-holiday" class="btn-add">+ –ü—Ä–∞–∑–¥–Ω–∏–∫</button>
        <button id="btn-add-range" class="btn-add">+ –ü–µ—Ä–∏–æ–¥</button>
        <button id="btn-add-bonus" class="btn-add">+ –ë–æ–Ω—É—Å</button>
        <button id="btn-add-payment" class="btn-add">+ –°–ø–æ—Å–æ–± –±—Ä–æ–Ω–∏</button>
        <button id="btn-add-link" class="btn-add">+ –°—Å—ã–ª–∫–∞</button>
        <button id="btn-reset-db" class="btn-add bg-red-500/10 border-red-500/25 text-red-300 hover:bg-red-500/20">–°–±—Ä–æ—Å
          –ë–î</button>
      </div>

      <!-- Admin sections -->
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-5 pb-6">
        <div class="glass rounded-2xl p-5">
          <div class="text-base font-extrabold text-white mb-3">–õ–æ–≥–∏—Å—Ç–∏–∫–∞</div>
          <div id="settings-travel-list" class="space-y-2"></div>
        </div>

        <div class="glass rounded-2xl p-5">
          <div class="text-base font-extrabold text-white mb-3">–£—Å–ª—É–≥–∏</div>
          <div id="settings-services-list" class="space-y-2"></div>
        </div>

        <div class="glass rounded-2xl p-5">
          <div class="text-base font-extrabold text-white mb-3">–ü—Ä–∞–∑–¥–Ω–∏—á–Ω—ã–µ –¥–∞—Ç—ã</div>
          <div id="settings-holidays-list" class="space-y-2"></div>
        </div>

        <div class="glass rounded-2xl p-5">
          <div class="text-base font-extrabold text-white mb-3">–ü—Ä–∞–∑–¥–Ω–∏—á–Ω—ã–µ –ø–µ—Ä–∏–æ–¥—ã</div>
          <div id="settings-ranges-list" class="space-y-2"></div>
        </div>

        <div class="glass rounded-2xl p-5">
          <div class="text-base font-extrabold text-white mb-3">–ë–æ–Ω—É—Å—ã</div>
          <div id="settings-bonuses-list" class="space-y-2"></div>
        </div>

        <div class="glass rounded-2xl p-5">
          <div class="text-base font-extrabold text-white mb-3">–ü—Ä–µ–¥–æ–ø–ª–∞—Ç–∞ –∏ –±—Ä–æ–Ω—å</div>
          <div id="settings-payments-list" class="space-y-2"></div>
        </div>

        <div class="glass rounded-2xl p-5 lg:col-span-2">
          <div class="text-base font-extrabold text-white mb-3">–°—Å—ã–ª–∫–∏</div>
          <div id="settings-links-list" class="space-y-2"></div>
        </div>

        <div class="glass rounded-2xl p-5 lg:col-span-2">
          <div class="text-base font-extrabold text-white mb-3">–®–∞–±–ª–æ–Ω—ã –ø–∞–∫–µ—Ç–æ–≤</div>
          <div class="text-sm text-slate-400 mb-3">1 —à–∞–±–ª–æ–Ω = 3 –ø–∞–∫–µ—Ç–∞ (–ë–∞–∑–æ–≤—ã–π, –û–ø—Ç–∏–º–∞–ª, –ü—Ä–µ–º–∏—É–º)</div>
          <button id="btn-create-template" class="btn-add w-full mb-3">+ –°–æ–∑–¥–∞—Ç—å —à–∞–±–ª–æ–Ω</button>
          <div id="package-templates-list" class="space-y-2"></div>
        </div>

        <!-- –ë–£–§–ï–† –ö–ü -->
        <div class="glass rounded-2xl p-5 lg:col-span-2">
          <div class="flex items-start justify-between gap-3 mb-3">
            <div>
              <div class="text-base font-extrabold text-white">–ë—É—Ñ–µ—Ä –ö–ü</div>
              <div class="text-sm text-slate-400">–°–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–µ –ö–ü –ø–æ—Å–ª–µ –Ω–∞–∂–∞—Ç–∏—è ¬´–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –ö–ü¬ª. –ú–æ–∂–Ω–æ –∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –∏
                —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å.</div>
            </div>
            <button id="btn-clear-kp-buffer" class="btn-icon" aria-label="–û—á–∏—Å—Ç–∏—Ç—å –±—É—Ñ–µ—Ä –ö–ü" title="–û—á–∏—Å—Ç–∏—Ç—å –±—É—Ñ–µ—Ä">
              <i data-lucide="trash-2" class="w-5 h-5"></i>
            </button>
          </div>
          <div id="kp-buffer-list" class="space-y-2"></div>
        </div>

      </div>
    </div>

    <!-- –ü–ª–∞–≤–∞—é—â–∞—è –∫–Ω–æ–ø–∫–∞ —Å–∫—Ä–æ–ª–ª–∞ (–≤–Ω–∏–∑/–≤–≤–µ—Ä—Ö) -->
    <button id="settings-scroll-toggle" style="
        position: fixed;
        bottom: calc(24px + env(safe-area-inset-bottom));
        right: 20px;
        z-index: 999;
        width: 48px;
        height: 48px;
        border-radius: 24px;
        background: linear-gradient(135deg, rgba(245,158,11,0.95) 0%, rgba(251,191,36,0.95) 100%);
        border: 2px solid rgba(245,158,11,0.3);
        box-shadow: 0 8px 24px rgba(245,158,11,0.4), 0 0 0 1px rgba(255,255,255,0.1) inset;
        cursor: pointer;
        display: none;
        align-items: center;
        justify-content: center;
        transition: transform 0.2s ease, box-shadow 0.2s ease;
      ">
      <svg id="scroll-toggle-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
        fill="none" stroke="white" stroke-width="3" stroke-linecap="round" stroke-linejoin="round">
        <path d="M12 5v14M5 12l7 7 7-7" />
      </svg>
    </button>
  </div>

  <!-- Scripts -->








  <script>


    /* === merged inline scripts (performance: fewer <script> tags) === */

    (function () {

      async function checkLicense() {

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ª–∏—Ü–µ–Ω–∑–∏—é (—Ñ—É–Ω–∫—Ü–∏—è checkActivation –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∞ –∫ —ç—Ç–æ–º—É –º–æ–º–µ–Ω—Ç—É)
        var hasLic = false;
        try {
          if (typeof checkActivation !== 'function') {
            return;
          }
          hasLic = await checkActivation();
        } catch (e) {
          console.error('License check error:', e);
          hasLic = false;
        }

        if (hasLic === true) {
          // –õ–∏—Ü–µ–Ω–∑–∏—è —É–∂–µ –µ—Å—Ç—å - –ø—Ä–æ—Å—Ç–æ –Ω–∏—á–µ–≥–æ –Ω–µ –¥–µ–ª–∞–µ–º, –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∑–∞–≥—Ä—É–∑–∏—Ç—Å—è
          // "–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å" –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –¢–û–õ–¨–ö–û –ø—Ä–∏ –ø–µ—Ä–≤–æ–π –∞–∫—Ç–∏–≤–∞—Ü–∏–∏
        }
        else {
          // –õ–∏—Ü–µ–Ω–∑–∏–∏ –Ω–µ—Ç –∏–ª–∏ –∏—Å—Ç–µ–∫–ª–∞ - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —ç–∫—Ä–∞–Ω –∞–∫—Ç–∏–≤–∞—Ü–∏–∏
          try {
            if (typeof showLicensePrompt !== 'function') {
              return;
            }
            showLicensePrompt(hasLic === 'expired' ? 'expired' : 'first');
          } catch (e) {
            console.error('Show prompt error:', e);
          }
        }
      }

      // –î–µ–ª–∞–µ–º checkLicense –≥–ª–æ–±–∞–ª—å–Ω–æ–π —á—Ç–æ–±—ã –º–æ–∂–Ω–æ –±—ã–ª–æ –≤—ã–∑–≤–∞—Ç—å –∏–∑ –ª—é–±–æ–≥–æ –º–µ—Å—Ç–∞
      window.checkLicense = checkLicense;

      function showMagic() {
        var m = document.getElementById('magic-welcome');
        if (!m) return;
        m.style.display = 'flex';
        setTimeout(function () { m.style.transition = 'opacity 0.8s'; m.style.opacity = '1' }, 50);
        setTimeout(function () { m.style.opacity = '0'; setTimeout(function () { m.remove() }, 800) }, 3000);
      }

      window.showMagicAfterActivation = showMagic;

      // ============================================
      // –ü–†–û–í–ï–†–ö–ê –£–°–¢–†–û–ô–°–¢–í–ê - –ë–õ–û–ö–ò–†–û–í–ö–ê –î–ï–°–ö–¢–û–ü–ê
      // ============================================
      function isMobileDevice() {
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º User Agent
        const ua = navigator.userAgent.toLowerCase();
        const isMobile = /android|webos|iphone|ipad|ipod|blackberry|iemobile|opera mini/i.test(ua);

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞–∑–º–µ—Ä —ç–∫—Ä–∞–Ω–∞ (–º–æ–±–∏–ª—å–Ω—ã–µ –æ–±—ã—á–Ω–æ < 768px)
        const isSmallScreen = window.innerWidth <= 768;

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º touch support
        const hasTouch = 'ontouchstart' in window || navigator.maxTouchPoints > 0;

        // –£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ —Å—á–∏—Ç–∞–µ—Ç—Å—è –º–æ–±–∏–ª—å–Ω—ã–º –µ—Å–ª–∏ —Ö–æ—Ç—è –±—ã 2 –∏–∑ 3 –∫—Ä–∏—Ç–µ—Ä–∏–µ–≤ –≤—ã–ø–æ–ª–Ω–µ–Ω—ã
        const mobileScore = [isMobile, isSmallScreen, hasTouch].filter(Boolean).length;
        return mobileScore >= 2;
      }

      function checkDevice() {
        if (!isMobileDevice()) {
          // –≠—Ç–æ –¥–µ—Å–∫—Ç–æ–ø - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –±–ª–æ–∫–∏—Ä–æ–≤–∫—É
          const desktopBlock = document.getElementById('desktop-block');
          const splash = document.getElementById('simple-splash');

          if (desktopBlock) {
            // –ü—Ä—è—á–µ–º –∑–∞—Å—Ç–∞–≤–∫—É
            if (splash) splash.style.display = 'none';

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –±–ª–æ–∫–∏—Ä–æ–≤–∫—É
            desktopBlock.style.display = 'flex';

            // –ë–ª–æ–∫–∏—Ä—É–µ–º –≤–µ—Å—å –æ—Å—Ç–∞–ª—å–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç
            document.body.style.overflow = 'hidden';

            return false; // –ë–ª–æ–∫–∏—Ä—É–µ–º –∑–∞–≥—Ä—É–∑–∫—É –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
          }
        }
        return true; // –†–∞–∑—Ä–µ—à–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É
      }

      // ============================================
      // –ó–ê–ü–£–°–ö –ü–û–°–õ–ï –ó–ê–ì–†–£–ó–ö–ò –°–¢–†–ê–ù–ò–¶–´
      // ============================================

      // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–∫–∞–∑–∞ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
      function showApp() {
        var header = document.getElementById('app-header');
        var main = document.getElementById('app-main');
        if (header) header.style.display = '';
        if (main) main.style.display = '';
      }
      window.showApp = showApp;

      window.addEventListener('load', async function () {
        // –ü–ï–†–í–´–ú –î–ï–õ–û–ú –ø—Ä–æ–≤–µ—Ä—è–µ–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ
        if (!checkDevice()) {
          return; // –ï—Å–ª–∏ –¥–µ—Å–∫—Ç–æ–ø - –Ω–µ –∑–∞–≥—Ä—É–∂–∞–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
        }

        var splash = document.getElementById('simple-splash');

        // –°–ù–ê–ß–ê–õ–ê –ø—Ä–æ–≤–µ—Ä—è–µ–º –ª–∏—Ü–µ–Ω–∑–∏—é (–ø–æ–∫–∞ –∑–∞—Å—Ç–∞–≤–∫–∞ –µ—â—ë –≤–∏–¥–Ω–∞)
        var hasLic = false;
        try {
          if (typeof checkActivation === 'function') {
            hasLic = await checkActivation();
          }
        } catch (e) {
          console.error('License check error:', e);
          hasLic = false;
        }

        if (hasLic === true) {
          // –õ–∏—Ü–µ–Ω–∑–∏—è –µ—Å—Ç—å - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–∞—Å—Ç–∞–≤–∫—É 2.5 —Å–µ–∫, –ø–æ—Ç–æ–º –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä
          setTimeout(function () {
            if (splash) {
              splash.style.opacity = '0';
              splash.style.transition = 'opacity 0.8s ease-out';
              setTimeout(function () {
                splash.remove();
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¢–û–õ–¨–ö–û –ø–æ—Å–ª–µ —É–¥–∞–ª–µ–Ω–∏—è –∑–∞—Å—Ç–∞–≤–∫–∏
                showApp();
              }, 800);
            }
          }, 2500);
        } else {
          // –õ–∏—Ü–µ–Ω–∑–∏–∏ –Ω–µ—Ç - –°–†–ê–ó–£ —É–±–∏—Ä–∞–µ–º –∑–∞—Å—Ç–∞–≤–∫—É –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —ç–∫—Ä–∞–Ω –∞–∫—Ç–∏–≤–∞—Ü–∏–∏
          // –ù–∏–∫–∞–∫–æ–π –∞–Ω–∏–º–∞—Ü–∏–∏, –Ω–∏–∫–∞–∫–æ–π –∑–∞–¥–µ—Ä–∂–∫–∏
          if (splash) {
            splash.remove();
          }
          if (typeof showLicensePrompt === 'function') {
            showLicensePrompt(hasLic === 'expired' ? 'expired' : 'first');
          }
        }
      });
    })();



    /* === Inlined from app.js === */
    /* ============================================
       ILLUSIONIST OS - APP.JS
       –û—Å–Ω–æ–≤–Ω–∞—è –ª–æ–≥–∏–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
       ============================================ */

    'use strict';

    // ============================================
    // –ö–û–ù–°–¢–ê–ù–¢–´ –ò –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø
    // ============================================
    const DB_VERSION = '2.0';
    const STORAGE_KEY = 'illusionist_calc_db';
    const BACKUP_KEY = 'illusionist_backups';
    const RESPONSE_TEMPLATES_KEY = 'illusionist_response_templates';
    const MAX_BACKUPS = 5;
    const AUTO_BACKUP_INTERVAL = 5 * 60 * 1000; // 5 –º–∏–Ω—É—Ç

    // ============================================
    // UTILITIES
    // ============================================
    const Utils = {
      escapeHtml: (text) => {
        if (!text) return '';
        const map = { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;' };
        return String(text).replace(/[&<>"']/g, (m) => map[m]);
      },

      sanitizeText: (text, maxLength = 1000) => {
        if (!text) return '';
        return String(text)
          .replace(/[\x00-\x1F\x7F]/g, '')
          .substring(0, maxLength)
          .trim();
      },

      sanitizeNumber: (value, min = 0, max = 999999, defaultValue = null) => {
        const num = parseInt(value, 10);
        if (isNaN(num)) return defaultValue !== null ? defaultValue : min;
        return Math.max(min, Math.min(max, num));
      },

      sanitizeFloat: (value, min = 0, max = 100, defaultValue = null) => {
        const num = parseFloat(value);
        if (isNaN(num)) return defaultValue !== null ? defaultValue : min;
        return Math.max(min, Math.min(max, num));
      },

      validateDateKey: (key) => {
        if (!key || typeof key !== 'string') return false;
        const regex = /^(0[1-9]|1[0-2])-(0[1-9]|[12][0-9]|3[01])$/;
        if (!regex.test(key)) return false;
        const [m, d] = key.split('-').map(Number);
        const daysInMonth = [31, 29, 31, 30, 31, 30, 31, 31, 30, 31, 30, 31];
        return d <= daysInMonth[m - 1];
      },

      parseMonthDay: (mmdd) => {
        const s = String(mmdd || '').trim();
        if (!Utils.validateDateKey(s)) return null;
        const [mm, dd] = s.split('-').map(n => parseInt(n, 10));
        return { mm, dd };
      },

      // –ö–†–ê–°–ò–í–û–ï –û–ö–†–£–ì–õ–ï–ù–ò–ï (–¥–µ–ª–∞–µ—Ç —á–∏—Å–ª–∞ –∫—Ä—É–≥–ª—ã–º–∏)
      prettyRound: (num) => {
        if (typeof num !== 'number' || isNaN(num)) return 0;
        return Math.round(num * 100) / 100;
      },

      formatPrice: (num) => {
        if (typeof num !== 'number' || isNaN(num)) return '0';
        return Math.round(num).toLocaleString('ru-RU');
      },

      formatPriceDisplay: (num) => {
        const pretty = Utils.formatPrice(num);
        return pretty.toLocaleString('ru-RU');
      },

      createElement: (tag, className = '', textContent = '') => {
        const el = document.createElement(tag);
        if (className) el.className = className;
        if (textContent) el.textContent = textContent;
        return el;
      },

      clearElement: (element) => {
        if (!element) return;
        while (element.firstChild) element.removeChild(element.firstChild);
      },

      addOption: (select, value, text) => {
        const option = document.createElement('option');
        option.value = value;
        option.textContent = text;
        select.appendChild(option);
      },

      copyToClipboard: async (text) => {
        if (!text) return false;
        if (navigator.clipboard && window.isSecureContext) {
          try {
            await navigator.clipboard.writeText(text);
            return true;
          } catch (err) {
            // Clipboard API failed, trying fallback...
          }
        }
        try {
          const textArea = document.createElement('textarea');
          textArea.value = text;
          textArea.style.position = 'fixed';
          textArea.style.top = '0';
          textArea.style.left = '-9999px';
          textArea.style.opacity = '0';
          textArea.setAttribute('readonly', '');
          document.body.appendChild(textArea);
          textArea.select();
          textArea.setSelectionRange(0, 99999);
          const successful = document.execCommand('copy');
          document.body.removeChild(textArea);
          return successful;
        } catch (err) {
          // Fallback clipboard failed
          return false;
        }
      },

      debounce: (func, wait = 300) => {
        let timeout;
        return function executedFunction(...args) {
          const later = () => {
            clearTimeout(timeout);
            func(...args);
          };
          clearTimeout(timeout);
          timeout = setTimeout(later, wait);
        };
      },

      throttle: (func, limit = 300) => {
        let inThrottle;
        return function (...args) {
          if (!inThrottle) {
            func.apply(this, args);
            inThrottle = true;
            setTimeout(() => inThrottle = false, limit);
          }
        };
      },

      formatDate: (dateString) => {
        if (!dateString) return '';
        try {
          const date = new Date(dateString + 'T00:00:00');
          if (isNaN(date.getTime())) return dateString;
          return date.toLocaleDateString('ru-RU', {
            day: 'numeric',
            month: 'long',
            weekday: 'short'
          });
        } catch (e) {
          return dateString;
        }
      },

      formatDateTime: (timestamp) => {
        if (!timestamp) return '‚Äî';
        try {
          const date = new Date(timestamp);
          return date.toLocaleString('ru-RU', {
            day: '2-digit',
            month: '2-digit',
            hour: '2-digit',
            minute: '2-digit'
          });
        } catch (e) {
          return '‚Äî';
        }
      },

      simpleHash: (str) => {
        let hash = 0;
        for (let i = 0; i < str.length; i++) {
          const char = str.charCodeAt(i);
          hash = ((hash << 5) - hash) + char;
          hash = hash & hash;
        }
        return Math.abs(hash).toString(16);
      },

      saveToStorage: (key, value) => {
        try {
          localStorage.setItem(key, JSON.stringify(value));
          return true;
        } catch (err) {
          return false;
        }
      },

      // –ö–µ—à –¥–ª—è localStorage
      _storageCache: new Map(),

      loadFromStorage: (key, defaultValue = null) => {
        try {
          // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–µ—à
          if (Utils._storageCache.has(key)) {
            return Utils._storageCache.get(key);
          }

          const item = localStorage.getItem(key);
          if (item === null) return defaultValue;

          const parsed = JSON.parse(item);
          Utils._storageCache.set(key, parsed);
          return parsed;
        } catch (err) {
          return defaultValue;
        }
      },

      saveToStorage: (key, value) => {
        try {
          localStorage.setItem(key, JSON.stringify(value));
          Utils._storageCache.set(key, value); // –û–±–Ω–æ–≤–ª—è–µ–º –∫–µ—à
          return true;
        } catch (err) {
          return false;
        }
      },

      isValidObject: (obj) => obj !== null && typeof obj === 'object' && !Array.isArray(obj),

      validateInput: (input, validator, errorClass = 'error-input') => {
        if (!input) return false;
        const isValid = validator(input.value);
        if (!isValid) {
          input.classList.add(errorClass);
          setTimeout(() => input.classList.remove(errorClass), 300);
        }
        return isValid;
      }
    };

    // ============================================
    // DEFAULT DATABASE
    // ============================================
    const DEFAULT_DB = {
      version: DB_VERSION,
      travel: {},  // –ü—É—Å—Ç–æ - –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–æ–±–∞–≤–∏—Ç —Å–≤–æ–∏ —Ä–µ–≥–∏–æ–Ω—ã –∏ –≥–æ—Ä–æ–¥–∞
      services: {},  // –ü—É—Å—Ç–æ - –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–æ–±–∞–≤–∏—Ç —Å–≤–æ–∏ —É—Å–ª—É–≥–∏
      holidays: {},  // –ü—É—Å—Ç–æ - –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–æ–±–∞–≤–∏—Ç —Å–≤–æ–∏ –ø—Ä–∞–∑–¥–Ω–∏–∫–∏
      holidayRanges: [],  // –ü—É—Å—Ç–æ - –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–æ–±–∞–≤–∏—Ç –¥–∏–∞–ø–∞–∑–æ–Ω—ã –ø—Ä–∞–∑–¥–Ω–∏–∫–æ–≤
      bonuses: [],  // –ü—É—Å—Ç–æ - –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–æ–±–∞–≤–∏—Ç —Å–≤–æ–∏ –±–æ–Ω—É—Å—ã
      payments: [],  // –ü—É—Å—Ç–æ - –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–æ–±–∞–≤–∏—Ç —Å–ø–æ—Å–æ–±—ã –æ–ø–ª–∞—Ç—ã
      links: [],  // –ü—É—Å—Ç–æ - –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–æ–±–∞–≤–∏—Ç —Å–≤–æ–∏ —Å—Å—ã–ª–∫–∏
      kpBuffer: [],
      packageTemplates: [],  // –ü—É—Å—Ç–æ - –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–æ–∑–¥–∞—Å—Ç –ø–∞–∫–µ—Ç—ã
      config: {
        performer: "",  // –ü—É—Å—Ç–æ - –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–≤–µ–¥—ë—Ç —Å–≤–æ—ë –∏–º—è
        deposit: 30,  // –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è –ø—Ä–µ–¥–æ–ø–ª–∞—Ç–∞ 30%
        cashlessPercent: 6,  // –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è –∫–æ–º–∏—Å—Å–∏—è –±–∞–Ω–∫–∞ 6%
        agencyPercent: 15,  // –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è –∫–æ–º–∏—Å—Å–∏—è –∞–≥–µ–Ω—Ç—Å—Ç–≤–∞ 15%
        burnBonusTitle: "",  // –ü—É—Å—Ç–æ - –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞—Å—Ç—Ä–æ–∏—Ç –∞–∫—Ü–∏—é
        burnBonusPrice: 0,  // 0 - –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É—Å—Ç–∞–Ω–æ–≤–∏—Ç —Ü–µ–Ω—É
        burnBonusDiscountPrice: 0,  // 0 - –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É—Å—Ç–∞–Ω–æ–≤–∏—Ç —Ü–µ–Ω—É —Å–æ —Å–∫–∏–¥–∫–æ–π
        burnHours: 48,  // –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ –≤—Ä–µ–º—è –∞–∫—Ü–∏–∏ 48 —á–∞—Å–æ–≤
        personalName: "",  // –ü—É—Å—Ç–æ
        enableBackgroundAnimation: false,  // –û—Ç–∫–ª—é—á–µ–Ω–æ –¥–ª—è —ç–∫–æ–Ω–æ–º–∏–∏ –±–∞—Ç–∞—Ä–µ–∏
        bulkDiscountEnabled: false,  // –í—ã–∫–ª—é—á–µ–Ω–æ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
        bulkDiscountPercent: 10,  // 10% —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è —Å–∫–∏–¥–∫–∞
        bulkDiscountMinServices: 2  // –û—Ç 2 —É—Å–ª—É–≥
      }
    };

    // ============================================
    // GLOBAL STATE
    // ============================================
    let DB = {};
    let State = {
      date: (function () {
        const d = new Date();
        const y = d.getFullYear();
        const m = String(d.getMonth() + 1).padStart(2, '0');
        const day = String(d.getDate()).padStart(2, '0');
        return `${y}-${m}-${day}`;
      })(),
      holidayK: 1,
      serviceQty: 1,
      cart: [], // –ö–∞–∂–¥–∞—è —É—Å–ª—É–≥–∞ —Å–æ–¥–µ—Ä–∂–∏—Ç: name, price, qty, city, region, cityName, regionName
      finalTotal: 0,
      expiringOffer: false,
      finalDetails: {
        servicesTotal: 0,
        discount: 0,
        travel: 0,
        manPrice: 0,
        guestPrice: 0,
        tax: 0,
        k: 1
      },
      activeBonuses: []
    };

    // ============================================
    // DATA MANAGER
    // ============================================
    const DataManager = {
      calculateChecksum: (data) => Utils.simpleHash(JSON.stringify(data)),

      validateData: (data) => {
        if (!data || typeof data !== 'object') {
          return { valid: false, error: '–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –¥–∞–Ω–Ω—ã—Ö' };
        }

        // –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –Ω–æ–≤—ã—Ö "–ø–æ–ª–Ω—ã—Ö" –±—ç–∫–∞–ø–æ–≤ (v2), –≥–¥–µ –¥–∞–Ω–Ω—ã–µ –ª–µ–∂–∞—Ç –≤ kv[STORAGE_KEY]
        let candidate = data;
        const isV2 = (candidate && typeof candidate === 'object' && candidate.__format === 'illusionist_os_backup_v2' && Utils.isValidObject(candidate.kv));

        if (isV2) {
          const rawDB = candidate.kv && candidate.kv[STORAGE_KEY];
          if (!rawDB || typeof rawDB !== 'string') {
            return { valid: false, error: '–í –±—ç–∫–∞–ø–µ –Ω–µ—Ç –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è' };
          }
          try {
            candidate = JSON.parse(rawDB);
          } catch {
            return { valid: false, error: '–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –≤ –±—ç–∫–∞–ø–µ –ø–æ–≤—Ä–µ–∂–¥–µ–Ω–∞' };
          }
        }

        const required = ['travel', 'services', 'holidays', 'bonuses', 'payments', 'links', 'config'];
        for (const key of required) {
          if (!(key in candidate)) {
            return { valid: false, error: `–û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –ø–æ–ª–µ: ${key}` };
          }
        }

        if (!Utils.isValidObject(candidate.travel)) {
          return { valid: false, error: '–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ travel' };
        }
        if (!Utils.isValidObject(candidate.services)) {
          return { valid: false, error: '–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ services' };
        }
        if (!Utils.isValidObject(candidate.holidays)) {
          return { valid: false, error: '–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ holidays' };
        }
        if (!Array.isArray(candidate.bonuses)) {
          return { valid: false, error: 'bonuses –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –º–∞—Å—Å–∏–≤–æ–º' };
        }
        if (!Array.isArray(candidate.payments)) {
          return { valid: false, error: 'payments –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –º–∞—Å—Å–∏–≤–æ–º' };
        }
        if (!Array.isArray(candidate.links)) {
          return { valid: false, error: 'links –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –º–∞—Å—Å–∏–≤–æ–º' };
        }
        if ('holidayRanges' in candidate && !Array.isArray(candidate.holidayRanges)) {
          return { valid: false, error: 'holidayRanges –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –º–∞—Å—Å–∏–≤–æ–º' };
        }

        return { valid: true };
      },

      exportData: () => {
        try {
          // –ü–µ—Ä–µ–¥ —ç–∫—Å–ø–æ—Ä—Ç–æ–º —Ñ–∏–∫—Å–∏—Ä—É–µ–º –≤—Å—ë, —á—Ç–æ –º–æ–≥–ª–æ "–∑–∞–≤–∏—Å–Ω—É—Ç—å" –≤ debounce (–≤–∫–ª—é—á–∞—è –ø—Ä–æ—Ñ–∏–ª—å)
          try {
            const pn = document.getElementById('personal-name');
            if (pn) {
              if (!DB.config) DB.config = {};
              DB.config.personalName = Utils.sanitizeText(pn.value, 100);
            }
          } catch (e) { }
          try { Storage.save(); } catch (e) { }

          // –ü–æ–ª–Ω—ã–π —ç–∫—Å–ø–æ—Ä—Ç: —Å–æ—Ö—Ä–∞–Ω—è–µ–º –≤—Å–µ –∫–ª—é—á–∏ localStorage, –æ—Ç–Ω–æ—Å—è—â–∏–µ—Å—è –∫ Illusionist OS
          const kv = {};
          for (let i = 0; i < localStorage.length; i++) {
            const k = localStorage.key(i);
            if (!k) continue;
            if (k.startsWith('illusionist_') || k === 'personal-name' || k === 'personalName' || k === 'illusionist_personal_name') {
              kv[k] = localStorage.getItem(k);
            }
          }

          // –ù–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ–º, —á—Ç–æ –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É–µ—Ç –≤ —ç–∫—Å–ø–æ—Ä—Ç–µ
          if (!kv[STORAGE_KEY]) {
            kv[STORAGE_KEY] = JSON.stringify(DB);
          }

          const cleanPayload = {
            __format: 'illusionist_os_backup_v2',
            dbVersion: DB_VERSION,
            kv
          };

          const exportData = {
            ...cleanPayload,
            exportedAt: new Date().toISOString(),
            checksum: DataManager.calculateChecksum(cleanPayload)
          };

          const blob = new Blob([JSON.stringify(exportData, null, 2)], {
            type: 'application/json'
          });
          const url = URL.createObjectURL(blob);

          const a = document.createElement('a');
          a.href = url;
          a.download = `illusionist-os-backup-${new Date().toISOString().slice(0, 10)}.json`;
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          URL.revokeObjectURL(url);

          App.showToast('–î–∞–Ω–Ω—ã–µ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã!');
          return true;
        } catch (err) {
          App.showToast('–û—à–∏–±–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞');
          return false;
        }
      },

      importData: (file) => new Promise((resolve, reject) => {
        const reader = new FileReader();

        reader.onload = async (e) => {
          try {
            const data = JSON.parse(e.target.result);
            const validation = DataManager.validateData(data);

            if (!validation.valid) {
              App.showToast(validation.error);
              reject(new Error(validation.error));
              return;
            }

            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ç—Ä–æ–ª—å–Ω–æ–π —Å—É–º–º—ã (–µ—Å–ª–∏ –µ—Å—Ç—å)
            if (data.checksum) {
              const { checksum, exportedAt, ...cleanData } = data;
              const calculated = DataManager.calculateChecksum(cleanData);
              if (checksum !== calculated) {
                if (!(await PremiumDialog.confirm({ message: '–ö–æ–Ω—Ç—Ä–æ–ª—å–Ω–∞—è —Å—É–º–º–∞ –Ω–µ —Å–æ–≤–ø–∞–¥–∞–µ—Ç. –î–∞–Ω–Ω—ã–µ –º–æ–≥–ª–∏ –±—ã—Ç—å –∏–∑–º–µ–Ω–µ–Ω—ã. –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å?', danger: true, okText: '–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å', cancelText: '–û—Ç–º–µ–Ω–∞', icon: 'alert-triangle' }))) {
                  reject(new Error('Cancelled'));
                  return;
                }
              }
            }

            const isV2 = (data && typeof data === 'object' && data.__format === 'illusionist_os_backup_v2' && Utils.isValidObject(data.kv));

            // –°–Ω–∏–º–æ–∫ —Ç–µ–∫—É—â–µ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è (—á—Ç–æ–±—ã –Ω–µ –ø–æ—Ç–µ—Ä—è—Ç—å –¥–∞–Ω–Ω—ã–µ –ø—Ä–∏ –∏–º–ø–æ—Ä—Ç–µ v2, –≥–¥–µ –º—ã –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤–µ—Å—å localStorage)
            const beforeBackup = {
              id: Date.now(),
              label: '–ü–µ—Ä–µ–¥ –∏–º–ø–æ—Ä—Ç–æ–º',
              timestamp: new Date().toISOString(),
              data: JSON.parse(JSON.stringify(DB)),
              checksum: DataManager.calculateChecksum(DB)
            };

            if (isV2) {
              const kv = data.kv || {};

              // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—Å–µ –∫–ª—é—á–∏, –∫—Ä–æ–º–µ BACKUP_KEY (–µ–≥–æ –∞–∫–∫—É—Ä–∞—Ç–Ω–æ —Å–º–µ—Ä–∂–∏–º –Ω–∏–∂–µ)
              for (const [k, v] of Object.entries(kv)) {
                if (k === BACKUP_KEY) continue;
                if (typeof v === 'string') {
                  try {
                    localStorage.setItem(k, v);
                  } catch (err) {
                  }
                }
              }

              // –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –±—ç–∫–∞–ø—ã –∏–∑ —Ñ–∞–π–ª–∞ –∏ –¥–æ–±–∞–≤–ª—è–µ–º –Ω–∞—à "–ü–µ—Ä–µ–¥ –∏–º–ø–æ—Ä—Ç–æ–º" —Å–≤–µ—Ä—Ö—É
              let importedBackups = [];
              try {
                const raw = kv[BACKUP_KEY];
                if (raw && typeof raw === 'string') {
                  const parsed = JSON.parse(raw);
                  importedBackups = Array.isArray(parsed) ? parsed : [];
                }
              } catch {
                importedBackups = [];
              }

              const merged = [beforeBackup, ...(importedBackups || [])].filter(Boolean).filter(b => b && typeof b === 'object');

              // –î–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è –ø–æ id
              const seen = new Set();
              const uniq = [];
              for (const b of merged) {
                const id = b && b.id;
                if (id == null) continue;
                if (seen.has(id)) continue;
                seen.add(id);
                uniq.push(b);
              }

              if (uniq.length > MAX_BACKUPS) uniq.length = MAX_BACKUPS;
              Utils.saveToStorage(BACKUP_KEY, uniq);

              // –ó–∞–≥—Ä—É–∂–∞–µ–º DB –∏–∑ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω–æ–≥–æ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞ –∏ –Ω–æ—Ä–º–∞–ª–∏–∑—É–µ–º –ø–æ–¥ —Ç–µ–∫—É—â—É—é –≤–µ—Ä—Å–∏—é
              Storage.load();
              Storage.save();

            } else {
              // –°—Ç–∞—Ä—ã–π —Ñ–æ—Ä–º–∞—Ç (legacy): —Ñ–∞–π–ª —Å–æ–¥–µ—Ä–∂–∏—Ç —Å–∞–º DB
              DataManager.createBackup('–ü–µ—Ä–µ–¥ –∏–º–ø–æ—Ä—Ç–æ–º');

              const { checksum, exportedAt, ...importedData } = data;

              DB = {
                ...JSON.parse(JSON.stringify(DEFAULT_DB)),
                ...importedData,
                version: DB_VERSION
              };


              // –ú–∏–≥—Ä–∞—Ü–∏—è –ø—Ä–æ—Ñ–∏–ª—è (–ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–æ–µ –∏–º—è) –¥–ª—è —Å—Ç–∞—Ä—ã—Ö —ç–∫—Å–ø–æ—Ä—Ç–æ–≤
              try {
                if (!DB.config) DB.config = { ...DEFAULT_DB.config };
                const hasName = typeof DB.config.personalName === 'string' && DB.config.personalName.trim().length > 0;
                if (!hasName) {
                  const legacyName =
                    (typeof importedData.personalName === 'string' ? importedData.personalName :
                      (typeof importedData.personal_name === 'string' ? importedData.personal_name : ''));
                  if (legacyName) DB.config.personalName = Utils.sanitizeText(legacyName, 100);
                }
              } catch (e) { }
              if (!Array.isArray(DB.holidayRanges)) {
                DB.holidayRanges = JSON.parse(JSON.stringify(DEFAULT_DB.holidayRanges));
              }

              Storage.save();
            }

            App.updateUI();
            Admin.render();
            DataManager.renderBackupSlots();
            DataManager.updateStats();

            App.showToast('–î–∞–Ω–Ω—ã–µ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã!');
            resolve(true);
          } catch (err) {
            App.showToast('–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è —Ñ–∞–π–ª–∞');
            reject(err);
          }
        };

        reader.onerror = () => {
          App.showToast('–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è —Ñ–∞–π–ª–∞');
          reject(new Error('File read error'));
        };

        reader.readAsText(file);
      }),

      createBackup: (label = null) => {
        try {
          const backups = Utils.loadFromStorage(BACKUP_KEY, []);
          const backup = {
            id: Date.now(),
            label: label || `–ë—ç–∫–∞–ø ${backups.length + 1}`,
            timestamp: new Date().toISOString(),
            data: JSON.parse(JSON.stringify(DB)),
            checksum: DataManager.calculateChecksum(DB)
          };

          backups.unshift(backup);
          if (backups.length > MAX_BACKUPS) backups.pop();

          Utils.saveToStorage(BACKUP_KEY, backups);
          DataManager.renderBackupSlots();
          App.showToast('–ë—ç–∫–∞–ø —Å–æ–∑–¥–∞–Ω!');
          return true;
        } catch (err) {
          App.showToast('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –±—ç–∫–∞–ø–∞');
          return false;
        }
      },

      restoreBackup: async (backupId) => {
        try {
          const backups = Utils.loadFromStorage(BACKUP_KEY, []);
          const backup = backups.find(b => b.id === backupId);

          if (!backup) {
            App.showToast('–ë—ç–∫–∞–ø –Ω–µ –Ω–∞–π–¥–µ–Ω');
            return false;
          }

          if (!(await PremiumDialog.confirm({ message: `–í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å "${backup.label}"?\n–¢–µ–∫—É—â–∏–µ –¥–∞–Ω–Ω—ã–µ –±—É–¥—É—Ç –∑–∞–º–µ–Ω–µ–Ω—ã.`, danger: true, okText: '–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å', cancelText: '–û—Ç–º–µ–Ω–∞', icon: 'alert-triangle' }))) {
            return false;
          }

          const calculated = DataManager.calculateChecksum(backup.data);
          if (backup.checksum !== calculated) {
            if (!(await PremiumDialog.confirm({ message: '–ö–æ–Ω—Ç—Ä–æ–ª—å–Ω–∞—è —Å—É–º–º–∞ –Ω–µ —Å–æ–≤–ø–∞–¥–∞–µ—Ç. –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å?', danger: true, okText: '–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å', cancelText: '–û—Ç–º–µ–Ω–∞', icon: 'alert-triangle' }))) {
              return false;
            }
          }

          DB = {
            ...JSON.parse(JSON.stringify(DEFAULT_DB)),
            ...backup.data,
            version: DB_VERSION
          };

          if (!Array.isArray(DB.holidayRanges)) {
            DB.holidayRanges = JSON.parse(JSON.stringify(DEFAULT_DB.holidayRanges));
          }

          Storage.save();
          App.updateUI();
          Admin.render();
          DataManager.updateStats();

          App.showToast('–î–∞–Ω–Ω—ã–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã!');
          return true;
        } catch (err) {
          App.showToast('–û—à–∏–±–∫–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è');
          return false;
        }
      },

      deleteBackup: async (backupId) => {
        try {
          let backups = Utils.loadFromStorage(BACKUP_KEY, []);
          backups = backups.filter(b => b.id !== backupId);
          Utils.saveToStorage(BACKUP_KEY, backups);
          DataManager.renderBackupSlots();
          App.showToast('–ë—ç–∫–∞–ø —É–¥–∞–ª—ë–Ω');
          return true;
        } catch (err) {
          return false;
        }
      },

      autoBackup: () => {
        const backups = Utils.loadFromStorage(BACKUP_KEY, []);
        const lastBackup = backups[0];

        if (lastBackup) {
          const currentChecksum = DataManager.calculateChecksum(DB);
          if (lastBackup.checksum === currentChecksum) return;
        }

        try {
          const backup = {
            id: Date.now(),
            label: '–ê–≤—Ç–æ–±—ç–∫–∞–ø',
            timestamp: new Date().toISOString(),
            data: JSON.parse(JSON.stringify(DB)),
            checksum: DataManager.calculateChecksum(DB)
          };

          const allBackups = Utils.loadFromStorage(BACKUP_KEY, []);
          allBackups.unshift(backup);
          if (allBackups.length > MAX_BACKUPS) allBackups.pop();
          Utils.saveToStorage(BACKUP_KEY, allBackups);

          DataManager.renderBackupSlots();
        } catch (err) {
        }
      },

      renderBackupSlots: () => {
        const container = document.getElementById('backup-slots-container');
        if (!container) return;

        const backups = Utils.loadFromStorage(BACKUP_KEY, []);
        Utils.clearElement(container);

        for (let i = 0; i < MAX_BACKUPS; i++) {
          const backup = backups[i];
          const slot = Utils.createElement('div', `backup-slot ${backup ? '' : 'empty'}`);

          if (backup) {
            slot.innerHTML = `
          <div class="text-xs font-bold text-amber-400 truncate">${Utils.escapeHtml(backup.label)}</div>
          <div class="text-[10px] text-slate-500">${Utils.formatDateTime(backup.timestamp)}</div>
        `;
            slot.title = `${backup.label}\n–ü—Ä–∞–≤—ã–π –∫–ª–∏–∫ ‚Äî —É–¥–∞–ª–∏—Ç—å`;
            slot.addEventListener('click', () => DataManager.restoreBackup(backup.id));
            slot.addEventListener('contextmenu', async (e) => {
              e.preventDefault();
              if (await PremiumDialog.confirm({ message: `–£–¥–∞–ª–∏—Ç—å "${backup.label}"?`, danger: true, okText: '–î–∞', cancelText: '–û—Ç–º–µ–Ω–∞', icon: 'shield-alert' })) {
                DataManager.deleteBackup(backup.id);
              }
            });
          } else {
            slot.innerHTML = `
          <div class="text-xs text-slate-600">–ü—É—Å—Ç–æ</div>
          <div class="text-[10px] text-slate-700">‚Äî</div>
        `;
          }

          container.appendChild(slot);
        }

        const lastBackupEl = document.getElementById('last-backup-time');
        if (lastBackupEl && backups[0]) {
          lastBackupEl.textContent = `–ü–æ—Å–ª–µ–¥–Ω–∏–π: ${Utils.formatDateTime(backups[0].timestamp)}`;
        } else if (lastBackupEl) {
          lastBackupEl.textContent = '‚Äî';
        }
      },

      updateStats: () => {
        const servicesCount = Object.values(DB.services || {}).reduce(
          (sum, cat) => sum + Object.keys(cat || {}).length,
          0
        );
        const regionsCount = Object.keys(DB.travel || {}).length;
        const bonusesCount = (DB.bonuses || []).length;

        const servicesEl = document.getElementById('stats-services');
        const regionsEl = document.getElementById('stats-regions');
        const bonusesEl = document.getElementById('stats-bonuses');
        const versionEl = document.getElementById('db-version-display');
        const integrityEl = document.getElementById('data-integrity-status');

        if (servicesEl) servicesEl.textContent = servicesCount;
        if (regionsEl) regionsEl.textContent = regionsCount;
        if (bonusesEl) bonusesEl.textContent = bonusesCount;
        if (versionEl) versionEl.textContent = `v${DB.version || DB_VERSION}`;

        if (integrityEl) {
          const isValid = DataManager.validateData(DB).valid;
          integrityEl.textContent = isValid ? 'OK' : '–û–®–ò–ë–ö–ê';
          integrityEl.className = isValid ? 'text-emerald-400 font-bold' : 'text-red-400 font-bold';
        }
      },

      updateBackupIndicator: (status = 'saved') => {
        const dot = document.querySelector('#backup-indicator .backup-dot');
        const text = document.getElementById('backup-status-text');
        if (!dot || !text) return;

        switch (status) {
          case 'saving':
            dot.className = 'backup-dot warning';
            text.textContent = '–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...';
            break;
          case 'saved':
            dot.className = 'backup-dot';
            text.textContent = '–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ';
            break;
          case 'error':
            dot.className = 'backup-dot error';
            text.textContent = '–û—à–∏–±–∫–∞!';
            break;
        }
      },

      init: () => {
        const fileInput = document.getElementById('import-file-input');
        if (fileInput) {
          fileInput.addEventListener('change', (e) => {
            if (e.target.files && e.target.files[0]) {
              DataManager.importData(e.target.files[0])
                .catch(() => { }) // –û—à–∏–±–∫–∞ —É–∂–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–∞ –≤ importData
                .finally(() => {
                  fileInput.value = '';
                });
            }
          });
        }

        document.getElementById('btn-export-data')?.addEventListener('click', DataManager.exportData);
        document.getElementById('btn-import-data')?.addEventListener('click', () => {
          document.getElementById('import-file-input')?.click();
        });
        document.getElementById('btn-create-backup')?.addEventListener('click', async () => {
          const label = await PremiumDialog.prompt({ title: '–ù–∞–∑–≤–∞–Ω–∏–µ –±—ç–∫–∞–ø–∞', defaultValue: `–ë—ç–∫–∞–ø ${new Date().toLocaleDateString('ru-RU')}`, okText: '–°–æ–∑–¥–∞—Ç—å', cancelText: '–û—Ç–º–µ–Ω–∞', icon: 'archive' });
          if (label !== null) DataManager.createBackup(label || undefined);
        });

        document.getElementById('btn-to-calendar')?.addEventListener('click', App.addToCalendar);
        DataManager.renderBackupSlots();
        DataManager.updateStats();
        DataManager.updateBackupIndicator('saved');

        setInterval(DataManager.autoBackup, AUTO_BACKUP_INTERVAL);
      }
    };

    // ============================================
    // STORAGE
    // ============================================
    const Storage = {
      save: () => {
        DataManager.updateBackupIndicator('saving');
        try {
          DB.version = DB_VERSION;
          localStorage.setItem(STORAGE_KEY, JSON.stringify(DB));
          DataManager.updateBackupIndicator('saved');
          DataManager.updateStats();
          return true;
        } catch (err) {
          DataManager.updateBackupIndicator('error');
          if (err.name === 'QuotaExceededError') {
            App.showToast('–•—Ä–∞–Ω–∏–ª–∏—â–µ –ø–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω–æ');
          }
          return false;
        }
      },

      load: () => {
        try {
          const stored = localStorage.getItem(STORAGE_KEY);
          if (!stored) {
            DB = JSON.parse(JSON.stringify(DEFAULT_DB));
            DB.version = DB_VERSION;
            DataManager.updateBackupIndicator('saved');
            return true;
          }

          const parsed = JSON.parse(stored);

          DB = {
            ...JSON.parse(JSON.stringify(DEFAULT_DB)),
            travel: Utils.isValidObject(parsed.travel) ? parsed.travel : DEFAULT_DB.travel,
            services: Utils.isValidObject(parsed.services) ? parsed.services : DEFAULT_DB.services,
            holidays: Utils.isValidObject(parsed.holidays) ? parsed.holidays : DEFAULT_DB.holidays,
            holidayRanges: Array.isArray(parsed.holidayRanges) ? parsed.holidayRanges : DEFAULT_DB.holidayRanges,
            bonuses: Array.isArray(parsed.bonuses) ? parsed.bonuses : DEFAULT_DB.bonuses,
            payments: Array.isArray(parsed.payments) ? parsed.payments : DEFAULT_DB.payments,
            links: Array.isArray(parsed.links) ? parsed.links : DEFAULT_DB.links,
            kpBuffer: Array.isArray(parsed.kpBuffer) ? parsed.kpBuffer : [],
            packageTemplates: Array.isArray(parsed.packageTemplates) ? parsed.packageTemplates : [],
            config: Utils.isValidObject(parsed.config) ? { ...DEFAULT_DB.config, ...parsed.config } : DEFAULT_DB.config,
            version: DB_VERSION
          };

          // –ú–∏–≥—Ä–∞—Ü–∏—è –ø—Ä–æ—Ñ–∏–ª—è (–ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–æ–µ –∏–º—è) ‚Äî –ø–æ–¥–¥–µ—Ä–∂–∫–∞ —Å—Ç–∞—Ä—ã—Ö –≤–µ—Ä—Å–∏–π/–±—ç–∫–∞–ø–æ–≤
          try {
            if (!DB.config) DB.config = { ...DEFAULT_DB.config };
            const hasName = typeof DB.config.personalName === 'string' && DB.config.personalName.trim().length > 0;

            if (!hasName) {
              let legacyName = '';
              // 1) –°—Ç–∞—Ä—ã–µ –ø–æ–ª—è –≤–Ω—É—Ç—Ä–∏ –±–∞–∑—ã (–µ—Å–ª–∏ –≤–¥—Ä—É–≥ –±—ã–ª–∏)
              if (typeof parsed.personalName === 'string') legacyName = parsed.personalName;
              else if (typeof parsed.personal_name === 'string') legacyName = parsed.personal_name;

              // 2) –°—Ç–∞—Ä—ã–µ –æ—Ç–¥–µ–ª—å–Ω—ã–µ –∫–ª—é—á–∏ localStorage
              if (!legacyName) {
                const legacyKeys = ['personal-name', 'personalName', 'illusionist_personal_name'];
                for (const k of legacyKeys) {
                  const raw = localStorage.getItem(k);
                  if (!raw) continue;
                  try {
                    const v = JSON.parse(raw);
                    if (typeof v === 'string' && v.trim()) { legacyName = v; break; }
                  } catch {
                    if (typeof raw === 'string' && raw.trim()) { legacyName = raw; break; }
                  }
                }
              }

              if (legacyName) DB.config.personalName = Utils.sanitizeText(legacyName, 100);
            }
          } catch (e) { }

          DataManager.updateBackupIndicator('saved');
          return true;
        } catch (err) {
          DB = JSON.parse(JSON.stringify(DEFAULT_DB));
          DB.version = DB_VERSION;
          DataManager.updateBackupIndicator('error');
          return false;
        }
      },

      reset: () => {
        try {
          localStorage.removeItem(STORAGE_KEY);
          DataManager.updateBackupIndicator('saved');
          return true;
        } catch (err) {
          DataManager.updateBackupIndicator('error');
          return false;
        }
      }
    };



    // ============================================
    // KP BUFFER (–°–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–µ –∫–æ–º–º–µ—Ä—á–µ—Å–∫–∏–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è)
    // ============================================
    const KPBuffer = {
      MAX_ITEMS: 25,
      // –ê–≤—Ç–æ-¬´—Å–∞–º–æ—É–≤–∞–∂–µ–Ω–∏–µ¬ª: –∑–∞–ø–∏—Å–∏, –∫–æ—Ç–æ—Ä—ã–º–∏ –¥–∞–≤–Ω–æ –Ω–µ –ø–æ–ª—å–∑–æ–≤–∞–ª–∏—Å—å, —É—Ö–æ–¥—è—Ç —Å–∞–º–∏
      TTL_DAYS: 30,
      TTL_MS: 30 * 24 * 60 * 60 * 1000,

      ensure: () => {
        if (!DB || typeof DB !== 'object') return;
        if (!Array.isArray(DB.kpBuffer)) DB.kpBuffer = [];
        // —Ç–∏—Ö–æ —á–∏—Å—Ç–∏–º —Å—Ç–∞—Ä—å—ë, –±–µ–∑ –ª–∏—à–Ω–∏—Ö —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–π –Ω–∞ –∫–∞–∂–¥–æ–º –≤—ã–∑–æ–≤–µ
        KPBuffer.prune(false);
      },

      prune: (save = true) => {
        try {
          if (!DB || typeof DB !== 'object') return;
          if (!Array.isArray(DB.kpBuffer)) DB.kpBuffer = [];

          const now = Date.now();
          const ttl = KPBuffer.TTL_MS;
          const before = DB.kpBuffer.length;

          DB.kpBuffer = DB.kpBuffer.filter((e) => {
            if (!e || typeof e !== 'object') return false;
            const stamp = e.lastUsedAt || e.touchedAt || e.createdAt;
            const t = stamp ? Date.parse(stamp) : NaN;
            if (!Number.isFinite(t)) return false;
            return (now - t) <= ttl;
          });

          if (save && DB.kpBuffer.length !== before) Storage.save();
        } catch (err) {
        }
      },

      _formatTs: (iso) => {
        try {
          const d = iso ? new Date(iso) : new Date();
          return new Intl.DateTimeFormat('ru-RU', {
            day: '2-digit', month: '2-digit', year: 'numeric',
            hour: '2-digit', minute: '2-digit'
          }).format(d);
        } catch {
          return '';
        }
      },

      _buildTitleFromState: () => {
        try {
          const parts = [];
          const dateStr = Utils.sanitizeText(State?.date || '', 32);
          if (dateStr) parts.push(dateStr);

          const timeMode = document.getElementById('inp-time-mode')?.value || 'time';
          const timeVal = Utils.sanitizeText(document.getElementById('inp-time')?.value || '', 16);
          if (timeMode !== 'none' && timeVal) parts.push(timeVal);

          const citySelect = document.getElementById('inp-city');
          const regionSelect = document.getElementById('inp-region');
          const city = citySelect?.value;
          const region = regionSelect?.value;

          const place = (city && city !== 'other') ? city : (region || '');
          if (place) parts.push(place);

          const firstSvc = (State?.cart || []).find(it => it && it.name && !String(it.name).startsWith('–ü–ê–ö–ï–¢:'));
          if (firstSvc?.name) parts.push(Utils.sanitizeText(firstSvc.name, 40));

          const title = parts.filter(Boolean).join(' ‚Ä¢ ');
          return title || `–ö–ü ‚Ä¢ ${KPBuffer._formatTs(new Date().toISOString())}`;
        } catch {
          return `–ö–ü ‚Ä¢ ${KPBuffer._formatTs(new Date().toISOString())}`;
        }
      },

      addFromText: (text, meta = {}) => {
        try {
          KPBuffer.ensure();

          const nowIso = new Date().toISOString();

          const safeText = String(text || '');
          if (!safeText.trim()) return;

          const entry = {
            id: String(Date.now()) + '_' + Math.random().toString(16).slice(2),
            createdAt: nowIso,
            lastUsedAt: nowIso,
            title: Utils.sanitizeText(meta.title || KPBuffer._buildTitleFromState(), 120),
            total: Utils.sanitizeNumber(meta.total ?? State?.finalTotal ?? 0, 0, 999999999, 0),
            itemsCount: Utils.sanitizeNumber(meta.itemsCount ?? (State?.cart || []).filter(it => it && it.name && !String(it.name).startsWith('–ü–ê–ö–ï–¢:')).length, 0, 99, 0),
            text: safeText
          };

          // –£–¥–∞–ª—è–µ–º –¥—É–±–ª–∏–∫–∞—Ç—ã (–ø–æ —Ç–µ–∫—Å—Ç—É) —á—Ç–æ–±—ã –±—É—Ñ–µ—Ä –Ω–µ –∑–∞—Å–æ—Ä—è–ª—Å—è
          DB.kpBuffer = (DB.kpBuffer || []).filter(e => e && e.text !== entry.text);

          DB.kpBuffer.unshift(entry);
          if (DB.kpBuffer.length > KPBuffer.MAX_ITEMS) DB.kpBuffer.length = KPBuffer.MAX_ITEMS;

          Storage.save();

          // –ï—Å–ª–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –æ—Ç–∫—Ä—ã—Ç—ã ‚Äî –æ–±–Ω–æ–≤–∏–º —Å–ø–∏—Å–æ–∫ —Å—Ä–∞–∑—É
          const settingsOpen = document.getElementById('view-settings')?.classList.contains('active');
          if (settingsOpen) KPBuffer.render();

        } catch (err) {
        }
      },

      remove: async (id) => {
        KPBuffer.ensure();
        const idx = (DB.kpBuffer || []).findIndex(e => e && e.id === id);
        if (idx < 0) return;

        const ok = await PremiumDialog.confirm({
          message: '–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ –ö–ü –∏–∑ –±—É—Ñ–µ—Ä–∞?',
          danger: true,
          okText: '–£–¥–∞–ª–∏—Ç—å',
          cancelText: '–û—Ç–º–µ–Ω–∞',
          icon: 'trash-2'
        });

        if (!ok) return;

        DB.kpBuffer.splice(idx, 1);
        Storage.save();
        KPBuffer.render();
        App.showToast('–£–¥–∞–ª–µ–Ω–æ');
      },

      copy: async (id) => {
        KPBuffer.ensure();
        const entry = (DB.kpBuffer || []).find(e => e && e.id === id);
        if (!entry) return;

        // –æ—Å–≤–µ–∂–∞–µ–º –∑–∞–ø–∏—Å—å (–∏ —Ç–µ–º —Å–∞–º—ã–º –ø—Ä–æ–¥–ª–µ–≤–∞–µ–º –µ–π –∂–∏–∑–Ω—å –≤ –±—É—Ñ–µ—Ä–µ)
        entry.lastUsedAt = new Date().toISOString();
        Storage.save();

        const ok = await Utils.copyToClipboard(entry.text || '');
        App.showToast(ok ? '–ö–ü —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!' : '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å');
      },

      edit: async (id) => {
        KPBuffer.ensure();
        const entry = (DB.kpBuffer || []).find(e => e && e.id === id);
        if (!entry) return;

        const updated = await PremiumDialog.prompt({
          title: '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ö–ü',
          message: '–ò—Å–ø—Ä–∞–≤—å—Ç–µ —Ç–µ–∫—Å—Ç (—ç–º–æ–¥–∑–∏ –∏ –æ—Ç—Å—Ç—É–ø—ã —Å–æ—Ö—Ä–∞–Ω—è—Ç—Å—è).',
          defaultValue: String(entry.text || ''),
          multiline: true,
          rows: 16,
          okText: '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å',
          cancelText: '–û—Ç–º–µ–Ω–∞',
          icon: 'file-text'
        });

        if (updated === null || updated === undefined) return;

        entry.text = String(updated);
        entry.lastUsedAt = new Date().toISOString();
        Storage.save();
        KPBuffer.render();
        App.showToast('–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ');
      },

      clearAll: async () => {
        KPBuffer.ensure();
        if (!(DB.kpBuffer || []).length) {
          App.showToast('–ë—É—Ñ–µ—Ä —É–∂–µ –ø—É—Å—Ç');
          return;
        }

        const ok = await PremiumDialog.confirm({
          message: '–û—á–∏—Å—Ç–∏—Ç—å –≤–µ—Å—å –±—É—Ñ–µ—Ä –ö–ü?',
          danger: true,
          okText: '–û—á–∏—Å—Ç–∏—Ç—å',
          cancelText: '–û—Ç–º–µ–Ω–∞',
          icon: 'trash-2'
        });

        if (!ok) return;

        DB.kpBuffer = [];
        Storage.save();
        KPBuffer.render();
        App.showToast('–û—á–∏—â–µ–Ω–æ');
      },

      render: () => {
        const el = document.getElementById('kp-buffer-list');
        if (!el) return;

        KPBuffer.ensure();
        KPBuffer.prune(true);
        el.innerHTML = '';

        const list = DB.kpBuffer || [];
        if (!list.length) {
          el.innerHTML = '<div class="text-slate-500 text-sm">–ü–æ–∫–∞ –ø—É—Å—Ç–æ. –°–≥–µ–Ω–µ—Ä–∏—Ä—É–π—Ç–µ –ö–ü ‚Äî –æ–Ω–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—Å—è –∑–¥–µ—Å—å.</div>';
          return;
        }

        list.forEach(entry => {
          if (!entry) return;

          const card = document.createElement('div');
          card.className = 'glass rounded-xl p-3';

          const title = Utils.escapeHtml(entry.title || '–ö–ü');
          const ts = KPBuffer._formatTs(entry.createdAt);
          const meta = [
            entry.itemsCount ? `–ü–æ–∑–∏—Ü–∏–∏: ${entry.itemsCount}` : '',
            (entry.total ? `–ò—Ç–æ–≥–æ: ${Utils.formatPrice(entry.total)} ‚ÇΩ` : '')
          ].filter(Boolean).join(' ‚Ä¢ ');

          card.innerHTML = `
        <div class="flex items-start justify-between gap-3">
          <div class="flex-1 min-w-0">
            <div class="font-bold text-slate-100 text-sm truncate">${title}</div>
            <div class="text-xs text-slate-400 mt-1 truncate">${Utils.escapeHtml(ts)}${meta ? ' ‚Ä¢ ' + Utils.escapeHtml(meta) : ''}</div>
          </div>
          <div class="flex gap-1 shrink-0">
            <button class="btn-icon" data-kp-copy="${Utils.escapeHtml(entry.id)}" title="–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å">
              <i data-lucide="copy" class="w-4 h-4"></i>
            </button>
            <button class="btn-icon" data-kp-edit="${Utils.escapeHtml(entry.id)}" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å">
              <i data-lucide="pencil" class="w-4 h-4"></i>
            </button>
            <button class="btn-icon" data-kp-del="${Utils.escapeHtml(entry.id)}" title="–£–¥–∞–ª–∏—Ç—å">
              <i data-lucide="trash-2" class="w-4 h-4"></i>
            </button>
          </div>
        </div>
      `;

          const copyBtn = card.querySelector('[data-kp-copy]');
          const editBtn = card.querySelector('[data-kp-edit]');
          const delBtn = card.querySelector('[data-kp-del]');

          if (copyBtn) copyBtn.addEventListener('click', () => KPBuffer.copy(entry.id));
          if (editBtn) editBtn.addEventListener('click', () => KPBuffer.edit(entry.id));
          if (delBtn) delBtn.addEventListener('click', () => KPBuffer.remove(entry.id));

          el.appendChild(card);
        });

        if (window.lucide) lucide.createIcons();
      }
    };

    // ============================================
    // APP - –û–°–ù–û–í–ù–ê–Ø –õ–û–ì–ò–ö–ê
    // ============================================
    const App = {
      init: () => {
        try {
          Storage.load();
          DataManager.init();

          App.migrateServicesNames();
          App.setupEventListeners();
          App.initProfileInputs();
          App.updateBurnLabel();
          App.updateUI();
          App.updateLicenseStatus();  // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –ª–∏—Ü–µ–Ω–∑–∏–∏

          const dateInput = document.getElementById('inp-date');
          if (dateInput) {
            dateInput.value = State.date;
            App.updateDate();
          }

          // –õ–µ–Ω–∏–≤–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –Ω–µ–ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω—ã—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤
          if (window.requestIdleCallback) {
            requestIdleCallback(() => {
              App.renderParticles();
              if (window.lucide) lucide.createIcons();
            }, { timeout: 2000 });
          } else {
            setTimeout(() => {
              App.renderParticles();
              if (window.lucide) lucide.createIcons();
            }, 100);
          }

          // App.startSplash(); // –£–î–ê–õ–ï–ù–û - –∏—Å–ø–æ–ª—å–∑—É–µ–º –Ω–æ–≤—É—é –∑–∞—Å—Ç–∞–≤–∫—É
          App.registerSWInline();

          DataManager.updateBackupIndicator('saved');

          // –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –≥–æ—Ç–æ–≤–æ –∫ —Ä–∞–±–æ—Ç–µ
        } catch (err) {
          App.showToast('–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏');
          DataManager.updateBackupIndicator('error');
        }
      },

      setupEventListeners: () => {
        // Settings modal
        document.getElementById('btn-settings')?.addEventListener('click', App.toggleSettings);
        document.getElementById('btn-close-settings')?.addEventListener('click', App.toggleSettings);
        document.getElementById('view-settings')?.addEventListener('click', (e) => {
          if (e.target && e.target.id === 'view-settings') App.toggleSettings();
        });

        // Date
        document.getElementById('inp-date')?.addEventListener('change', App.updateDate);

        // Time mode (–º–æ–∂–Ω–æ –≤—ã–±—Ä–∞—Ç—å "–ë–µ–∑ –≤—Ä–µ–º–µ–Ω–∏")
        const timeMode = document.getElementById('inp-time-mode');
        const timeInput = document.getElementById('inp-time');
        const applyTimeMode = () => {
          if (!timeMode || !timeInput) return;
          const mode = timeMode.value || 'time';
          const isNone = mode === 'none';
          timeInput.disabled = isNone;
          timeInput.style.display = isNone ? 'none' : '';
          if (isNone) {
            timeInput.value = '';
          } else if (!timeInput.value) {
            timeInput.value = '18:00';
          }
        };
        if (timeMode) {
          timeMode.addEventListener('change', () => {
            applyTimeMode();
            App.calc();
          });
          applyTimeMode();
        }

        // Region & City
        document.getElementById('inp-region')?.addEventListener('change', App.updateRegion);
        document.getElementById('inp-city')?.addEventListener('change', App.calc);

        // Category
        document.getElementById('inp-cat')?.addEventListener('change', App.updateCat);

        // Quantity
        document.getElementById('btn-qty-minus')?.addEventListener('click', () => App.changeQty(-1));
        document.getElementById('btn-qty-plus')?.addEventListener('click', () => App.changeQty(1));

        // Add service
        document.getElementById('btn-add-service')?.addEventListener('click', App.addService);

        // Copy buttons
        document.getElementById('btn-copy-prices')?.addEventListener('click', App.copyPriceList);
        document.getElementById('btn-copy-quote')?.addEventListener('click', App.copyQuote);

        // KP buffer
        document.getElementById('btn-clear-kp-buffer')?.addEventListener('click', () => KPBuffer.clearAll());

        // Bulk operations –∫–Ω–æ–ø–∫–∏
        document.getElementById('btn-select-all')?.addEventListener('click', App.selectAllCartItems);
        document.getElementById('btn-deselect-all')?.addEventListener('click', App.deselectAllCartItems);
        document.getElementById('btn-delete-selected')?.addEventListener('click', App.deleteSelectedCartItems);

        // Manual price
        const manualPriceInput = document.getElementById('inp-manual-price');
        if (manualPriceInput) {
          manualPriceInput.addEventListener('input', Utils.debounce(() => {
            const value = Utils.sanitizeNumber(manualPriceInput.value, 0, 999999);
            manualPriceInput.value = value || '';
            App.calc();
          }, 250));
        }

        // Guests & Tax
        document.getElementById('inp-guests')?.addEventListener('change', App.calc);
        document.getElementById('inp-tax')?.addEventListener('change', App.calc);

        document.getElementById('inp-agency')?.addEventListener('change', App.calc);
        document.getElementById('inp-agency')?.addEventListener('input', App.calc);

        // Admin buttons
        const bind = (id, fn) => {
          const el = document.getElementById(id);
          if (el) el.addEventListener('click', fn);
        };

        bind('btn-add-bonus', () => Admin.addBonus());
        bind('btn-add-region', () => Admin.addRegion());
        bind('btn-add-category', () => Admin.addCategory());
        bind('btn-add-holiday', () => Admin.addHoliday());
        bind('btn-add-range', () => Admin.addRange());
        bind('btn-add-payment', () => Admin.addPayment());
        bind('btn-add-link', () => Admin.addLink());
        bind('btn-reset-license-user', () => {

          // –î–≤–æ–π–Ω–æ–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
          if (confirm('‚ö†Ô∏è –°–±—Ä–æ—Å–∏—Ç—å –∞–∫—Ç–∏–≤–∞—Ü–∏—é?\n\n–ü–æ—Å–ª–µ —ç—Ç–æ–≥–æ –ø–æ—Ç—Ä–µ–±—É–µ—Ç—Å—è –∑–∞–Ω–æ–≤–æ –≤–≤–µ—Å—Ç–∏ –∫–ª—é—á –∞–∫—Ç–∏–≤–∞—Ü–∏–∏.')) {

            if (confirm('üîë –í—ã —Ç–æ—á–Ω–æ —É–≤–µ—Ä–µ–Ω—ã?\n\n–õ–∏—Ü–µ–Ω–∑–∏—è –±—É–¥–µ—Ç —É–¥–∞–ª–µ–Ω–∞, –∏ –≤—Å–µ –¥–∞–Ω–Ω—ã–µ –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ –±—É–¥—É—Ç —Å—Ç—ë—Ä—Ç—ã.\n\n–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å?')) {

              // –£–¥–∞–ª—è–µ–º –ª–∏—Ü–µ–Ω–∑–∏—é
              localStorage.removeItem('illusionist_license');

              // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –≤ UI
              App.updateLicenseStatus();

              // –ó–∞–∫—Ä—ã–≤–∞–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
              const settingsModal = document.getElementById('settings-modal');
              if (settingsModal) {
                settingsModal.classList.remove('show');
              }

              // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º toast
              App.showToast('‚úÖ –ê–∫—Ç–∏–≤–∞—Ü–∏—è —Å–±—Ä–æ—à–µ–Ω–∞! –ü–æ–∫–∞–∑—ã–≤–∞—é —ç–∫—Ä–∞–Ω –∞–∫—Ç–∏–≤–∞—Ü–∏–∏...');

              // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —ç–∫—Ä–∞–Ω –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ —á–µ—Ä–µ–∑ 1 —Å–µ–∫—É–Ω–¥—É
              setTimeout(() => {

                if (typeof window.showLicensePrompt === 'function') {
                  window.showLicensePrompt('first');
                } else if (typeof showLicensePrompt === 'function') {
                  showLicensePrompt('first');
                } else {
                  App.showToast('–û—à–∏–±–∫–∞! –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É –≤—Ä—É—á–Ω—É—é (F5).');
                }
              }, 1000);
            } else {
            }
          } else {
          }
        });
        bind('btn-reset-db', () => Admin.reset());
      },

      initProfileInputs: () => {
        const depositInput = document.getElementById('cfg-deposit');
        if (depositInput) {
          depositInput.value = DB.config?.deposit ?? 30;
          depositInput.addEventListener('input', Utils.debounce(() => {
            const value = Utils.sanitizeNumber(depositInput.value, 0, 100, 30);
            depositInput.value = value;
            DB.config.deposit = value;
            Storage.save();
            DataManager.updateStats();
          }, 350));
        }
        const cashlessInput = document.getElementById('cfg-cashless-percent');
        if (cashlessInput) {
          cashlessInput.value = DB.config?.cashlessPercent ?? 6;
          cashlessInput.addEventListener('input', Utils.debounce(() => {
            const value = Utils.sanitizeNumber(cashlessInput.value, 0, 100, 6);
            cashlessInput.value = value;
            DB.config.cashlessPercent = value;
            Storage.save();
            DataManager.updateStats();
            App.updatePercentLabels();
            App.calc();
          }, 350));
        }

        const agencyInput = document.getElementById('cfg-agency-percent');
        if (agencyInput) {
          agencyInput.value = DB.config?.agencyPercent ?? 15;
          agencyInput.addEventListener('input', Utils.debounce(() => {
            const value = Utils.sanitizeNumber(agencyInput.value, 0, 99, 15);
            agencyInput.value = value;
            DB.config.agencyPercent = value;
            Storage.save();
            DataManager.updateStats();
            App.updatePercentLabels();
            App.calc();
          }, 350));
        }

        // –°–ö–ò–î–ö–ê –ó–ê –û–ë–™–Å–ú
        const bulkEnabledCheckbox = document.getElementById('cfg-bulk-discount-enabled');
        if (bulkEnabledCheckbox) {
          bulkEnabledCheckbox.checked = DB.config?.bulkDiscountEnabled ?? true;
          bulkEnabledCheckbox.addEventListener('change', () => {
            DB.config.bulkDiscountEnabled = bulkEnabledCheckbox.checked;
            Storage.save();
            App.calc();
          });
        }

        const bulkPercentInput = document.getElementById('cfg-bulk-discount-percent');
        if (bulkPercentInput) {
          bulkPercentInput.value = DB.config?.bulkDiscountPercent ?? 10;
          bulkPercentInput.addEventListener('input', Utils.debounce(() => {
            const value = Utils.sanitizeNumber(bulkPercentInput.value, 0, 100, 10);
            bulkPercentInput.value = value;
            DB.config.bulkDiscountPercent = value;
            Storage.save();
            App.calc();
          }, 350));
        }

        const bulkMinInput = document.getElementById('cfg-bulk-discount-min');
        if (bulkMinInput) {
          bulkMinInput.value = DB.config?.bulkDiscountMinServices ?? 2;
          bulkMinInput.addEventListener('input', Utils.debounce(() => {
            const value = Utils.sanitizeNumber(bulkMinInput.value, 1, 100, 2);
            bulkMinInput.value = value;
            DB.config.bulkDiscountMinServices = value;
            Storage.save();
            App.calc();
          }, 350));
        }


        const burnTitleInput = document.getElementById('cfg-burn-title');
        if (burnTitleInput) {
          burnTitleInput.value = DB.config?.burnBonusTitle ?? "–ü–æ—è–≤–ª–µ–Ω–∏–µ –ì–µ–Ω–¥–∏—Ä–µ–∫—Ç–æ—Ä–∞";
          burnTitleInput.addEventListener('input', Utils.debounce(() => {
            const v = Utils.sanitizeText(burnTitleInput.value, 120) || "";
            burnTitleInput.value = v;
            DB.config.burnBonusTitle = v;
            Storage.save();
          }, 350));
        }

        const burnPriceInput = document.getElementById('cfg-burn-price');
        if (burnPriceInput) {
          burnPriceInput.value = DB.config?.burnBonusPrice ?? 15000;
          burnPriceInput.addEventListener('input', Utils.debounce(() => {
            const value = Utils.sanitizeNumber(burnPriceInput.value, 0, 99999999, 15000);
            burnPriceInput.value = value;
            DB.config.burnBonusPrice = value;
            Storage.save();
          }, 350));
        }

        const burnDiscountPriceInput = document.getElementById('cfg-burn-discount-price');
        if (burnDiscountPriceInput) {
          burnDiscountPriceInput.value = DB.config?.burnBonusDiscountPrice ?? 0;
          burnDiscountPriceInput.addEventListener('input', Utils.debounce(() => {
            const value = Utils.sanitizeNumber(burnDiscountPriceInput.value, 0, 99999999, 0);
            burnDiscountPriceInput.value = value;
            DB.config.burnBonusDiscountPrice = value;
            Storage.save();
          }, 350));
        }

        const burnHoursInput = document.getElementById('cfg-burn-hours');
        if (burnHoursInput) {
          burnHoursInput.value = DB.config?.burnHours ?? 48;
          burnHoursInput.addEventListener('input', Utils.debounce(() => {
            const value = Utils.sanitizeNumber(burnHoursInput.value, 1, 240, 48);
            burnHoursInput.value = value;
            DB.config.burnHours = value;
            Storage.save();
            App.updateBurnLabel();
          }, 350));
        }

        App.updatePercentLabels();

      },
      updatePercentLabels: () => {
        try {
          const cashlessPct = Utils.sanitizeNumber(DB.config?.cashlessPercent ?? 6, 0, 100, 6);
          const agencyPct = Utils.sanitizeNumber(DB.config?.agencyPercent ?? 15, 0, 99, 15);

          const cashlessLbl = document.getElementById('lbl-cashless');
          if (cashlessLbl) cashlessLbl.textContent = `–û–ø–ª–∞—Ç–∞ –ø–æ –±–µ–∑–Ω–∞–ª—É`;

          const agencyLbl = document.getElementById('lbl-agency');
          if (agencyLbl) agencyLbl.textContent = `–ö–æ–º–∏—Å—Å–∏—è –∞–≥–µ–Ω—Ç—Å—Ç–≤–∞`;
        } catch (e) {
          // silent
        }
      },

      updateBurnLabel: () => {
        try {
          const hours = Utils.sanitizeNumber(DB.config?.burnHours ?? 48, 1, 240, 48);
          const lbl = document.getElementById('lbl-burn');
          if (lbl) lbl.textContent = `–ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –¥–µ–π—Å—Ç–≤—É–µ—Ç ${hours} —á–∞—Å–æ–≤`;
        } catch (e) { }
      },
      migrateServicesNames: () => {
        try {
          if (!DB.services || !DB.services["–î–µ—Ç—Å–∫–∏–µ —à–æ—É"]) return;
          const oldKey = "–ò–Ω–¥–∏–≤. –¥–µ—Ç—Å–∫–æ–µ —à–æ—É";
          const newKey = "–ò–Ω–¥–∏–≤. –¥–µ—Ç—Å–∫–æ–µ —à–æ—É (30 –º–∏–Ω—É—Ç + –º–∞—Å—Ç–µ—Ä –∫–ª–∞—Å—Å 1 —á–∞—Å)";
          if (DB.services["–î–µ—Ç—Å–∫–∏–µ —à–æ—É"][oldKey] != null && DB.services["–î–µ—Ç—Å–∫–∏–µ —à–æ—É"][newKey] == null) {
            DB.services["–î–µ—Ç—Å–∫–∏–µ —à–æ—É"][newKey] = DB.services["–î–µ—Ç—Å–∫–∏–µ —à–æ—É"][oldKey];
            delete DB.services["–î–µ—Ç—Å–∫–∏–µ —à–æ—É"][oldKey];
            Storage.save();
          }
        } catch (err) {
        }
      },

      registerSWInline: () => {
        try {
          if (!('serviceWorker' in navigator)) return;

          // Register the external Service Worker for full offline support
          navigator.serviceWorker.register('sw.js')
            .then(reg => console.log('‚úÖ Service Worker Registered (Offline Ready)', reg))
            .catch(err => console.error('‚ùå Service Worker Error:', err));
        } catch (e) {
          console.error(e);
        }
      },

      // startSplash –£–î–ê–õ–ï–ù–ê - –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –Ω–æ–≤–∞—è —Å–∏—Å—Ç–µ–º–∞ –∑–∞–≥—Ä—É–∑–∫–∏

      updateUI: () => {
        try {
          // –ë–∞—Ç—á–∏–º DOM –æ–ø–µ—Ä–∞—Ü–∏–∏ —á–µ—Ä–µ–∑ RAF –¥–ª—è –ø–ª–∞–≤–Ω–æ—Å—Ç–∏
          requestAnimationFrame(() => {
            App.updateRegionSelect();
            App.updateCategorySelect();
            App.updateCat();

            requestAnimationFrame(() => {
              if (window.lucide) lucide.createIcons();
              DataManager.updateStats();
              DataManager.renderBackupSlots();
              Admin.render();
            });
          });
        } catch (err) {
        }
      },

      updateRegionSelect: () => {
        const regionSelect = document.getElementById('inp-region');
        if (!regionSelect) return;

        const currentValue = regionSelect.value;
        Utils.clearElement(regionSelect);
        Utils.addOption(regionSelect, '', '–í—ã–±–µ—Ä–∏—Ç–µ...');
        regionSelect.options[0].disabled = true;
        regionSelect.options[0].selected = true;

        if (DB.travel && Utils.isValidObject(DB.travel)) {
          Object.keys(DB.travel).sort().forEach(region => {
            Utils.addOption(regionSelect, region, region);
          });
        }

        if (currentValue && DB.travel?.[currentValue]) {
          regionSelect.value = currentValue;
        }
      },

      updateCategorySelect: () => {
        const catSelect = document.getElementById('inp-cat');
        if (!catSelect) return;

        const currentValue = catSelect.value;
        Utils.clearElement(catSelect);
        Utils.addOption(catSelect, '', '–í—ã–±–µ—Ä–∏—Ç–µ...');
        catSelect.options[0].disabled = true;
        catSelect.options[0].selected = true;

        if (DB.services && Utils.isValidObject(DB.services)) {
          Object.keys(DB.services).sort().forEach(category => {
            Utils.addOption(catSelect, category, category);
          });
        }

        if (currentValue && DB.services?.[currentValue]) {
          catSelect.value = currentValue;
        }
      },

      updateDate: () => {
        const dateInput = document.getElementById('inp-date');
        if (!dateInput) return;

        const val = dateInput.value;
        if (!val) return;

        try {
          State.date = val;
          const [y, m, d] = val.split('-').map(Number);
          if (!m || !d) return;

          const key = `${String(m).padStart(2, '0')}-${String(d).padStart(2, '0')}`;

          let k = (DB.holidays && DB.holidays[key]) ? Utils.sanitizeFloat(DB.holidays[key], 1, 10) : 1;

          if (k === 1 && DB.holidayRanges && Array.isArray(DB.holidayRanges)) {
            const md = m * 100 + d;
            for (let range of DB.holidayRanges) {
              if (!Utils.isValidObject(range)) continue;
              const start = (range.sm || 0) * 100 + (range.sd || 0);
              const end = (range.em || 0) * 100 + (range.ed || 0);
              const inRange = start <= end ? (md >= start && md <= end) : (md >= start || md <= end);
              if (inRange) {
                k = Utils.sanitizeFloat(range.k, 1, 10);
                break;
              }
            }
          }

          State.holidayK = k;

          const badge = document.getElementById('holiday-alert');
          const kSpan = document.getElementById('holiday-k');
          if (badge && kSpan) {
            if (k > 1) {
              badge.classList.remove('hidden');
              kSpan.textContent = k;
            } else {
              badge.classList.add('hidden');
            }
          }

          App.calc();
        } catch (err) {
        }
      },

      updateRegion: () => {
        const regionSelect = document.getElementById('inp-region');
        const citySelect = document.getElementById('inp-city');
        if (!regionSelect || !citySelect) return;

        const region = regionSelect.value;
        Utils.clearElement(citySelect);
        citySelect.disabled = false;

        if (region && DB.travel && DB.travel[region] && DB.travel[region].cities) {
          const cities = DB.travel[region].cities;
          Object.keys(cities).sort().forEach(city => {
            Utils.addOption(citySelect, city, city);
          });
          Utils.addOption(citySelect, 'other', '–î—Ä—É–≥–æ–π');
        } else {
          citySelect.disabled = true;
        }

        App.calc();
      },

      updateCat: () => {
        const catSelect = document.getElementById('inp-cat');
        const svcSelect = document.getElementById('inp-svc');
        if (!catSelect || !svcSelect) return;

        const category = catSelect.value;
        Utils.clearElement(svcSelect);
        svcSelect.disabled = false;

        if (category && DB.services && DB.services[category]) {
          const services = DB.services[category];
          Object.keys(services).sort().forEach(service => {
            Utils.addOption(svcSelect, service, service);
          });
        } else {
          svcSelect.disabled = true;
        }
      },

      changeQty: (delta) => {
        const qtySpan = document.getElementById('svc-qty');
        if (!qtySpan) return;

        let newQty = State.serviceQty + delta;
        newQty = Utils.sanitizeNumber(newQty, 1, 99);
        State.serviceQty = newQty;
        qtySpan.textContent = newQty;
      },

      addService: () => {
        const catSelect = document.getElementById('inp-cat');
        const svcSelect = document.getElementById('inp-svc');
        const regionSelect = document.getElementById('inp-region');
        const citySelect = document.getElementById('inp-city');

        if (!catSelect || !svcSelect) return;

        const cat = catSelect.value;
        const svc = svcSelect.value;

        if (!cat || !svc) {
          App.showToast('–í—ã–±–µ—Ä–∏—Ç–µ —É—Å–ª—É–≥—É!');
          return;
        }

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–µ–≥–∏–æ–Ω –∏ –≥–æ—Ä–æ–¥
        const region = regionSelect?.value || '';
        const city = citySelect?.value || '';

        if (!region || !city) {
          App.showToast('–í—ã–±–µ—Ä–∏—Ç–µ —Ä–µ–≥–∏–æ–Ω –∏ –≥–æ—Ä–æ–¥!');
          return;
        }

        const serviceData = DB.services?.[cat]?.[svc];

        // –ü–æ–¥–¥–µ—Ä–∂–∫–∞ —Å—Ç–∞—Ä–æ–≥–æ —Ñ–æ—Ä–º–∞—Ç–∞ (—á–∏—Å–ª–æ) –∏ –Ω–æ–≤–æ–≥–æ (–æ–±—ä–µ–∫—Ç)
        let basePrice, serviceDescription;
        if (typeof serviceData === 'number') {
          basePrice = serviceData;
          serviceDescription = '';
        } else if (typeof serviceData === 'object' && serviceData !== null) {
          basePrice = serviceData.price || 0;
          serviceDescription = serviceData.description || '';
        } else {
          App.showToast('–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è —É—Å–ª—É–≥–∞');
          return;
        }

        if (typeof basePrice !== 'number' || isNaN(basePrice) || basePrice < 0) {
          App.showToast('–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è —Ü–µ–Ω–∞ —É—Å–ª—É–≥–∏');
          return;
        }

        const regionName = regionSelect.options[regionSelect.selectedIndex]?.text || '';
        const cityName = citySelect.options[citySelect.selectedIndex]?.text || '';

        State.cart.push({
          name: Utils.sanitizeText(svc, 200),
          price: basePrice,
          qty: State.serviceQty,
          region: region,
          city: city,
          regionName: regionName,
          cityName: cityName === '–î—Ä—É–≥–æ–π –≥–æ—Ä–æ–¥' ? '–î—Ä—É–≥–æ–π' : cityName,
          description: serviceDescription  // –ë–µ—Ä—ë–º –∏–∑ –Ω–∞—Å—Ç—Ä–æ–µ–∫!
        });

        State.serviceQty = 1;
        const qtySpan = document.getElementById('svc-qty');
        if (qtySpan) qtySpan.textContent = 1;

        App.renderCart();
        App.calc();
        App.showToast('–£—Å–ª—É–≥–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∞');
      },

      removeService: (idx) => {
        if (idx >= 0 && idx < State.cart.length) {
          // –°–æ—Ö—Ä–∞–Ω—è–µ–º —ç–ª–µ–º–µ–Ω—Ç –¥–ª—è –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ undo
          const removedItem = { ...State.cart[idx] };
          const removedIndex = idx;

          // –ù–∞—Ö–æ–¥–∏–º —ç–ª–µ–º–µ–Ω—Ç –≤ DOM
          const cartList = document.getElementById('cart-list');
          if (cartList && cartList.children[idx]) {
            const element = cartList.children[idx];

            // –î–æ–±–∞–≤–ª—è–µ–º –∫–ª–∞—Å—Å –∞–Ω–∏–º–∞—Ü–∏–∏
            element.classList.add('animate-fade-out');

            // –ñ–¥—ë–º –æ–∫–æ–Ω—á–∞–Ω–∏—è –∞–Ω–∏–º–∞—Ü–∏–∏, –∑–∞—Ç–µ–º —É–¥–∞–ª—è–µ–º
            setTimeout(() => {
              State.cart.splice(idx, 1);
              App.renderCart();
              App.calc();

              // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º toast —Å –∫–Ω–æ–ø–∫–æ–π UNDO
              App.showToastWithUndo('–£—Å–ª—É–≥–∞ —É–¥–∞–ª–µ–Ω–∞', () => {
                // –§—É–Ω–∫—Ü–∏—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è
                State.cart.splice(removedIndex, 0, removedItem);
                App.renderCart();
                App.calc();
                App.showToast('‚úÖ –£—Å–ª—É–≥–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞');
              });
            }, 400); // 400ms = –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∞–Ω–∏–º–∞—Ü–∏–∏
          } else {
            // Fallback –µ—Å–ª–∏ —ç–ª–µ–º–µ–Ω—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω
            State.cart.splice(idx, 1);
            App.renderCart();
            App.calc();

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º toast —Å –∫–Ω–æ–ø–∫–æ–π UNDO
            App.showToastWithUndo('–£—Å–ª—É–≥–∞ —É–¥–∞–ª–µ–Ω–∞', () => {
              State.cart.splice(removedIndex, 0, removedItem);
              App.renderCart();
              App.calc();
              App.showToast('‚úÖ –£—Å–ª—É–≥–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞');
            });
          }
        }
      },

      renderCart: () => {
        const cartList = document.getElementById('cart-list');
        if (!cartList) return;

        Utils.clearElement(cartList);

        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º/—Å–∫—Ä—ã–≤–∞–µ–º –ø–∞–Ω–µ–ª—å bulk operations
        const bulkPanel = document.getElementById('bulk-actions-panel');
        if (bulkPanel) {
          bulkPanel.classList.toggle('hidden', State.cart.length === 0);
        }

        // –ì—Ä—É–ø–ø–∏—Ä—É–µ–º —É—Å–ª—É–≥–∏ –ø–æ –≥–æ—Ä–æ–¥–∞–º
        const cityGroups = {};
        State.cart.forEach((item, idx) => {
          const cityKey = `${item.region || 'unknown'}_${item.city || 'unknown'}`;
          if (!cityGroups[cityKey]) {
            cityGroups[cityKey] = {
              cityName: item.cityName || '–ì–æ—Ä–æ–¥ –Ω–µ —É–∫–∞–∑–∞–Ω',
              items: []
            };
          }
          cityGroups[cityKey].items.push({ item, idx });
        });

        const cityKeys = Object.keys(cityGroups);

        cityKeys.forEach((cityKey, groupIndex) => {
          const group = cityGroups[cityKey];

          // –†–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å –º–µ–∂–¥—É –≥–æ—Ä–æ–¥–∞–º–∏
          if (groupIndex > 0) {
            const separator = Utils.createElement('div', 'my-4 border-t-2 border-amber-500/20');
            cartList.appendChild(separator);
          }

          // –ó–∞–≥–æ–ª–æ–≤–æ–∫ –≥–æ—Ä–æ–¥–∞
          const cityHeader = Utils.createElement('div', 'px-2 py-2 mb-2');
          cityHeader.innerHTML = `<div class="text-sm font-bold text-amber-400">üìç ${Utils.escapeHtml(group.cityName)}</div>`;
          cartList.appendChild(cityHeader);

          // –£—Å–ª—É–≥–∏ —ç—Ç–æ–≥–æ –≥–æ—Ä–æ–¥–∞
          group.items.forEach(({ item, idx }) => {
            const total = Utils.prettyRound(item.price * item.qty * State.holidayK);

            const wrapper = Utils.createElement(
              'div',
              'animate-slide-in flex items-center gap-3 mb-2'
            );

            // –ß–µ–∫–±–æ–∫—Å –¥–ª—è bulk –æ–ø–µ—Ä–∞—Ü–∏–π
            const checkbox = Utils.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.className = 'cart-item-checkbox w-5 h-5 rounded border-2 border-amber-500/30 bg-white/5 checked:bg-amber-500 checked:border-amber-500 cursor-pointer transition flex-shrink-0';
            checkbox.dataset.index = idx;
            checkbox.addEventListener('change', () => App.updateBulkSelection());

            const contentDiv = Utils.createElement('div', 'flex-1 flex items-center justify-between gap-4');

            const leftDiv = Utils.createElement('div', 'flex-1 min-w-0');

            const nameDiv = Utils.createElement('div', 'text-base font-semibold text-white mb-1');
            nameDiv.textContent = item.name;

            if (item.qty > 1) {
              const qtySpan = Utils.createElement('span', 'text-amber-400 text-sm ml-2');
              qtySpan.textContent = `√ó${item.qty}`;
              nameDiv.appendChild(qtySpan);
            }

            const priceDiv = Utils.createElement('div', 'text-sm text-slate-400 mono');
            priceDiv.textContent = `${Utils.formatPrice(item.price)} ‚ÇΩ`;

            leftDiv.appendChild(nameDiv);

            // –û–ø–∏—Å–∞–Ω–∏–µ —É—Å–ª—É–≥–∏ (–µ—Å–ª–∏ –µ—Å—Ç—å)
            if (item.description && item.description.trim()) {
              const descDiv = Utils.createElement('div', 'text-xs text-slate-500 mt-1 italic');
              descDiv.textContent = item.description;
              leftDiv.appendChild(descDiv);
            }

            leftDiv.appendChild(priceDiv);

            const rightDiv = Utils.createElement('div', 'flex items-center gap-4 flex-shrink-0');

            const totalSpan = Utils.createElement('span', 'font-extrabold text-amber-400 text-base mono');
            totalSpan.textContent = `${Utils.formatPrice(total)} ‚ÇΩ`;
            rightDiv.appendChild(totalSpan);

            // –ö–Ω–æ–ø–∫–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
            const editBtn = Utils.createElement('button', 'text-slate-400 hover:text-amber-400 transition p-2');
            editBtn.innerHTML = '<i data-lucide="pencil" class="w-5 h-5"></i>';
            editBtn.title = '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –æ–ø–∏—Å–∞–Ω–∏–µ';
            editBtn.addEventListener('click', () => App.editServiceDescription(idx));
            rightDiv.appendChild(editBtn);

            // –ö–Ω–æ–ø–∫–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –¥–ª—è –ø–∞–∫–µ—Ç–æ–≤
            if (item.name.startsWith('–ü–ê–ö–ï–¢:')) {
              const editPkgBtn = Utils.createElement('button', 'text-slate-400 hover:text-amber-400 transition p-2');
              editPkgBtn.innerHTML = '<i data-lucide="package" class="w-5 h-5"></i>';
              editPkgBtn.title = '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–∞–∫–µ—Ç';
              editPkgBtn.addEventListener('click', () => App.editPackageInCart(idx));
              rightDiv.appendChild(editPkgBtn);
            }

            const delBtn = Utils.createElement('button', 'text-slate-500 hover:text-red-400 transition p-2');
            delBtn.innerHTML = '<i data-lucide="x" class="w-5 h-5"></i>';
            delBtn.addEventListener('click', () => App.removeService(idx));
            rightDiv.appendChild(delBtn);

            contentDiv.appendChild(leftDiv);
            contentDiv.appendChild(rightDiv);

            wrapper.appendChild(checkbox);
            wrapper.appendChild(contentDiv);
            cartList.appendChild(wrapper);
          });
        });

        if (window.lucide) lucide.createIcons();
      },

      updateBulkSelection: () => {
        const checkboxes = document.querySelectorAll('.cart-item-checkbox');
        const selected = Array.from(checkboxes).filter(cb => cb.checked);
        const selectedCount = document.getElementById('selected-count');

        if (selectedCount) {
          selectedCount.textContent = selected.length;
        }
      },

      selectAllCartItems: () => {
        const checkboxes = document.querySelectorAll('.cart-item-checkbox');
        checkboxes.forEach(cb => cb.checked = true);
        App.updateBulkSelection();
      },

      deselectAllCartItems: () => {
        const checkboxes = document.querySelectorAll('.cart-item-checkbox');
        checkboxes.forEach(cb => cb.checked = false);
        App.updateBulkSelection();
      },

      deleteSelectedCartItems: () => {
        const checkboxes = document.querySelectorAll('.cart-item-checkbox');
        const selectedIndices = Array.from(checkboxes)
          .map((cb, i) => cb.checked ? i : -1)
          .filter(i => i >= 0)
          .sort((a, b) => b - a); // –°–æ—Ä—Ç–∏—Ä—É–µ–º –≤ –æ–±—Ä–∞—Ç–Ω–æ–º –ø–æ—Ä—è–¥–∫–µ

        if (selectedIndices.length === 0) {
          App.showToast('‚ö†Ô∏è –í—ã–±–µ—Ä–∏—Ç–µ —É—Å–ª—É–≥–∏ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è');
          return;
        }

        const count = selectedIndices.length;

        // –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ
        if (confirm(`–£–¥–∞–ª–∏—Ç—å ${count} ${count === 1 ? '—É—Å–ª—É–≥—É' : count < 5 ? '—É—Å–ª—É–≥–∏' : '—É—Å–ª—É–≥'}?`)) {
          // –°–æ—Ö—Ä–∞–Ω—è–µ–º —É–¥–∞–ª—ë–Ω–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã –¥–ª—è undo
          const removedItems = selectedIndices.map(idx => ({
            item: { ...State.cart[idx] },
            index: idx
          }));

          // –£–¥–∞–ª—è–µ–º (–Ω–∞—á–∏–Ω–∞—è —Å –∫–æ–Ω—Ü–∞ —á—Ç–æ–±—ã –∏–Ω–¥–µ–∫—Å—ã –Ω–µ —Å–±–∏–≤–∞–ª–∏—Å—å)
          selectedIndices.forEach(idx => {
            State.cart.splice(idx, 1);
          });

          App.renderCart();
          App.calc();

          // Toast —Å UNDO
          App.showToastWithUndo(`–£–¥–∞–ª–µ–Ω–æ: ${count} ${count === 1 ? '—É—Å–ª—É–≥–∞' : count < 5 ? '—É—Å–ª—É–≥–∏' : '—É—Å–ª—É–≥'}`, () => {
            // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—Å–µ —ç–ª–µ–º–µ–Ω—Ç—ã
            removedItems.reverse().forEach(({ item, index }) => {
              State.cart.splice(index, 0, item);
            });
            App.renderCart();
            App.calc();
            App.showToast('‚úÖ –£—Å–ª—É–≥–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã');
          });
        }
      },

      renderBreakdown: () => {
        const wrap = document.getElementById('cart-breakdown');
        if (!wrap) return;

        Utils.clearElement(wrap);

        const d = State.finalDetails || {};
        const hasAnything = (State.cart && State.cart.length) || (State.finalTotal && State.finalTotal > 0);

        if (!hasAnything) return;

        const mkRow = (label, value, opts = {}) => {
          const { tone = 'default', sign = '+', subtle = false, deletable = false, onDelete = null } = opts;

          const row = Utils.createElement(
            'div',
            'flex items-center justify-between px-4 py-3 rounded-2xl bg-white/5 border border-white/10'
          );

          const left = Utils.createElement('div', 'min-w-0');
          const title = Utils.createElement('div', subtle ? 'text-xs text-slate-500 font-bold uppercase tracking-wider' : 'text-sm text-slate-200 font-bold');
          title.textContent = label;
          left.appendChild(title);

          const right = Utils.createElement('div', 'flex items-center gap-3 flex-shrink-0');

          const priceDiv = Utils.createElement('div', 'flex items-baseline gap-1');

          const s = Utils.createElement('span', 'text-xs text-slate-500 font-black');
          s.textContent = sign;
          if (sign === '') s.textContent = '';

          const val = Utils.createElement(
            'span',
            tone === 'total'
              ? 'text-base font-extrabold text-amber-400 mono'
              : tone === 'minus'
                ? 'text-base font-extrabold text-rose-300 mono'
                : 'text-base font-extrabold text-slate-100 mono'
          );
          val.textContent = `${Utils.formatPrice(Math.abs(value))} ‚ÇΩ`;

          if (sign !== '') priceDiv.appendChild(s);
          priceDiv.appendChild(val);
          right.appendChild(priceDiv);

          // –ö–Ω–æ–ø–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è (–µ—Å–ª–∏ deletable)
          if (deletable && onDelete) {
            const delBtn = Utils.createElement('button', 'text-slate-500 hover:text-red-400 transition p-2');
            delBtn.innerHTML = '<i data-lucide="x" class="w-4 h-4"></i>';
            delBtn.title = '–£–±—Ä–∞—Ç—å –∏–∑ —Ä–∞—Å—á—ë—Ç–∞';
            delBtn.addEventListener('click', onDelete);
            right.appendChild(delBtn);
          }

          row.appendChild(left);
          row.appendChild(right);
          wrap.appendChild(row);
        };

        // Header
        const header = Utils.createElement('div', 'text-xs text-slate-500 font-black uppercase tracking-wider px-1 mt-6');
        header.textContent = '–†–∞—Å—á—ë—Ç';
        wrap.appendChild(header);

        // ====== PACKAGE MODE ======
        if (d.isPackage) {
          // –û–±—â–∏–µ –¥–æ–ø—ã (–ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –µ—Å—Ç—å)
          if (d.k && d.k > 1) {
            const row = Utils.createElement('div', 'text-xs text-slate-500 font-bold px-1');
            row.textContent = `–ü—Ä–∞–∑–¥–Ω–∏—á–Ω—ã–π –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç: √ó${d.k}`;
            wrap.appendChild(row);
          }

          if (d.travel > 0) mkRow('–õ–æ–≥–∏—Å—Ç–∏–∫–∞', d.travel, {
            sign: '+',
            tone: 'default',
            deletable: true,
            onDelete: () => {
              const citySelect = document.getElementById('inp-city');
              if (citySelect) {
                citySelect.value = '';
                citySelect.dispatchEvent(new Event('change', { bubbles: true }));
              }
            }
          });
          if (d.guestPrice > 0) mkRow('–ì–æ—Å—Ç–∏', d.guestPrice, {
            sign: '+',
            tone: 'default',
            deletable: true,
            onDelete: () => {
              const guestsInput = document.getElementById('inp-guests');
              if (guestsInput) {
                guestsInput.value = 0;
                guestsInput.dispatchEvent(new Event('input', { bubbles: true }));
              }
            }
          });
          if (d.manPrice > 0) {
            const manName = Utils.sanitizeText(document.getElementById('inp-manual-name')?.value, 100) || '–î–æ–ø–æ–ª–Ω–µ–Ω–∏–µ';
            mkRow(manName, d.manPrice, {
              sign: '+',
              tone: 'default',
              deletable: true,
              onDelete: () => {
                const inp = document.getElementById('inp-manual-price');
                if (inp) {
                  inp.value = 0;
                  inp.dispatchEvent(new Event('input', { bubbles: true }));
                }
              }
            });
          }

          const section = Utils.createElement('div', 'mt-2 text-xs text-slate-500 font-black uppercase tracking-wider px-1');
          section.textContent = '–ò—Ç–æ–≥–∏ –ø–æ –≤–∞—Ä–∏–∞–Ω—Ç–∞–º';
          wrap.appendChild(section);

          const addVariant = (name, total, tax, agency) => {
            mkRow(name, total, { sign: '', tone: 'total' });
            if (d.useCashless && tax > 0) mkRow('‚Äî –û–ø–ª–∞—Ç–∞ –ø–æ –±–µ–∑–Ω–∞–ª—É', tax, {
              sign: '+',
              subtle: true,
              deletable: true,
              onDelete: () => {
                const checkbox = document.getElementById('inp-tax');
                if (checkbox) {
                  checkbox.checked = false;
                  checkbox.dispatchEvent(new Event('change', { bubbles: true }));
                }
              }
            });
            if (d.useAgency && agency > 0) mkRow('‚Äî –ö–æ–º–∏—Å—Å–∏—è –∞–≥–µ–Ω—Ç—Å—Ç–≤–∞', agency, {
              sign: '+',
              subtle: true,
              deletable: true,
              onDelete: () => {
                const checkbox = document.getElementById('inp-agency');
                if (checkbox) {
                  checkbox.checked = false;
                  checkbox.dispatchEvent(new Event('change', { bubbles: true }));
                }
              }
            });
          };

          addVariant('–ë–∞–∑–æ–≤—ã–π', d.basicTotal || 0, d.basicTax || 0, d.basicAgencyMarkup || 0);
          addVariant('–û–ø—Ç–∏–º–∞–ª', d.optimalTotal || 0, d.optimalTax || 0, d.optimalAgencyMarkup || 0);
          addVariant('–ü—Ä–µ–º–∏—É–º', d.premiumTotal || 0, d.premiumTax || 0, d.premiumAgencyMarkup || 0);

          return;
        }

        // ====== NORMAL MODE ======
        const preDiscount = Utils.prettyRound((d.servicesTotal || 0) + (d.discount || 0));
        if (preDiscount > 0) mkRow('–£—Å–ª—É–≥–∏', preDiscount, { sign: '+', tone: 'default' });
        if (d.discount > 0) mkRow('–°–∫–∏–¥–∫–∞', d.discount, { sign: '-', tone: 'minus' });
        if (d.travel > 0) mkRow('–õ–æ–≥–∏—Å—Ç–∏–∫–∞', d.travel, {
          sign: '+',
          tone: 'default',
          deletable: true,
          onDelete: () => {
            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –≥–æ—Ä–æ–¥ —á—Ç–æ–±—ã —É–±—Ä–∞—Ç—å –ª–æ–≥–∏—Å—Ç–∏–∫—É
            const citySelect = document.getElementById('inp-city');
            if (citySelect) {
              citySelect.value = '';
              citySelect.dispatchEvent(new Event('change', { bubbles: true }));
            }
          }
        });
        if (d.guestPrice > 0) mkRow('–ì–æ—Å—Ç–∏', d.guestPrice, {
          sign: '+',
          tone: 'default',
          deletable: true,
          onDelete: () => {
            const guestsInput = document.getElementById('inp-guests');
            if (guestsInput) {
              guestsInput.value = 0;
              guestsInput.dispatchEvent(new Event('input', { bubbles: true }));
            }
          }
        });
        if (d.manPrice > 0) {
          const manName = Utils.sanitizeText(document.getElementById('inp-manual-name')?.value, 100) || '–î–æ–ø–æ–ª–Ω–µ–Ω–∏–µ';
          mkRow(manName, d.manPrice, {
            sign: '+',
            tone: 'default',
            deletable: true,
            onDelete: () => {
              const inp = document.getElementById('inp-manual-price');
              if (inp) {
                inp.value = 0;
                inp.dispatchEvent(new Event('input', { bubbles: true }));
              }
            }
          });
        }
        if (d.useCashless && d.tax > 0) mkRow('–û–ø–ª–∞—Ç–∞ –ø–æ –±–µ–∑–Ω–∞–ª—É', d.tax, {
          sign: '+',
          tone: 'default',
          deletable: true,
          onDelete: () => {
            const checkbox = document.getElementById('inp-tax');
            if (checkbox) {
              checkbox.checked = false;
              checkbox.dispatchEvent(new Event('change', { bubbles: true }));
            }
          }
        });

        const baseBeforeAgency = d.useAgency ? Math.max(0, (State.finalTotal || 0) - (d.agencyMarkup || 0)) : (State.finalTotal || 0);
        if (d.useAgency && d.agencyMarkup > 0) {
          mkRow('–ü–æ–¥—ã—Ç–æ–≥ (–±–µ–∑ –∫–æ–º–∏—Å—Å–∏–∏)', baseBeforeAgency, { sign: '', tone: 'default' });
          mkRow('–ö–æ–º–∏—Å—Å–∏—è –∞–≥–µ–Ω—Ç—Å—Ç–≤–∞', d.agencyMarkup, {
            sign: '+',
            tone: 'default',
            deletable: true,
            onDelete: () => {
              const checkbox = document.getElementById('inp-agency');
              if (checkbox) {
                checkbox.checked = false;
                checkbox.dispatchEvent(new Event('change', { bubbles: true }));
              }
            }
          });
          mkRow('–ò—Ç–æ–≥–æ –¥–ª—è –∫–ª–∏–µ–Ω—Ç–∞', State.finalTotal || 0, { sign: '', tone: 'total' });
        } else {
          mkRow('–ò—Ç–æ–≥–æ', State.finalTotal || 0, { sign: '', tone: 'total' });
        }

        // –†–µ–Ω–¥–µ—Ä–∏–º –∏–∫–æ–Ω–∫–∏ Lucide –¥–ª—è –∫–Ω–æ–ø–æ–∫ —É–¥–∞–ª–µ–Ω–∏—è
        if (window.lucide) lucide.createIcons();
      },

      calc: () => {
        try {
          const k = State.holidayK || 1;

          // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –ø–∞–∫–µ—Ç–∞
          const packageItem = State.cart.find(item => item.name.startsWith('–ü–ê–ö–ï–¢:') && item.packageTemplate);

          if (packageItem && packageItem.packageTemplate) {
            // –†–ê–°–ß–Å–¢ –° –ü–ê–ö–ï–¢–û–ú
            const tpl = packageItem.packageTemplate;
            const regionSelect = document.getElementById('inp-region');
            const region = regionSelect ? regionSelect.value : '';

            // –õ–æ–≥–∏—Å—Ç–∏–∫–∞
            const citySelect = document.getElementById('inp-city');
            let travel = 0;
            if (regionSelect && citySelect) {
              const city = citySelect.value;
              if (region && city && DB.travel?.[region]) {
                if (city === 'other') {
                  travel = Utils.prettyRound((DB.travel[region].fee || 0) * (k > 1 ? 1.5 : 1));
                } else if (DB.travel[region].cities && DB.travel[region].cities[city]) {
                  const cityData = DB.travel[region].cities[city];
                  const baseTravel = typeof cityData === 'number' ? cityData : (cityData.price || 0);
                  travel = Utils.prettyRound(baseTravel * (k > 1 ? 1.5 : 1));
                }
              }
            }

            // –î–æ–ø–ª–∞—Ç—ã
            const manualPriceInput = document.getElementById('inp-manual-price');
            const manPrice = manualPriceInput ? Utils.sanitizeNumber(manualPriceInput.value, 0, 999999, 0) : 0;

            const guestsSelect = document.getElementById('inp-guests');
            const guestPrice = guestsSelect ? Utils.sanitizeNumber(guestsSelect.value, 0, 999999, 0) : 0;

            const taxCheckbox = document.getElementById('inp-tax');
            const useTax = taxCheckbox ? taxCheckbox.checked : false;

            // –°—á–∏—Ç–∞–µ–º 3 –≤–∞—Ä–∏–∞–Ω—Ç–∞ —Å —É—á—ë—Ç–æ–º –ø—Ä–∞–∑–¥–Ω–∏—á–Ω–æ–≥–æ –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç–∞
            const basicPrice = Utils.prettyRound(tpl.basic.price * k);
            const optimalPrice = Utils.prettyRound(tpl.optimal.price * k);
            const premiumPrice = Utils.prettyRound(tpl.premium.price * k);

            const extras = travel + manPrice + guestPrice;

            const basicPreTax = basicPrice + extras;
            const optimalPreTax = optimalPrice + extras;
            const premiumPreTax = premiumPrice + extras;


            const cashlessPct = Utils.sanitizeNumber(DB.config?.cashlessPercent ?? 6, 0, 100, 6);
            const agencyPct = Utils.sanitizeNumber(DB.config?.agencyPercent ?? 15, 0, 99, 15);

            const agencyCheckbox = document.getElementById('inp-agency');
            const useAgency = agencyCheckbox ? agencyCheckbox.checked : false;

            const burnCheckbox = document.getElementById('inp-burn');
            const useBurn = burnCheckbox ? burnCheckbox.checked : false;
            State.expiringOffer = useBurn;
            const basicTax = useTax ? Utils.prettyRound(basicPreTax * (cashlessPct / 100)) : 0;
            const optimalTax = useTax ? Utils.prettyRound(optimalPreTax * (cashlessPct / 100)) : 0;
            const premiumTax = useTax ? Utils.prettyRound(premiumPreTax * (cashlessPct / 100)) : 0;

            const basicSub = basicPreTax + basicTax;
            const optimalSub = optimalPreTax + optimalTax;
            const premiumSub = premiumPreTax + premiumTax;

            const toClient = (subTotal) => {
              if (!useAgency) return subTotal;
              const k = 1 + (agencyPct / 100);
              return Utils.prettyRound(subTotal * k);
            };

            const basicTotal = toClient(basicSub);
            const optimalTotal = toClient(optimalSub);
            const premiumTotal = toClient(premiumSub);

            const basicAgencyMarkup = useAgency ? Math.max(0, basicTotal - basicSub) : 0;
            const optimalAgencyMarkup = useAgency ? Math.max(0, optimalTotal - optimalSub) : 0;
            const premiumAgencyMarkup = useAgency ? Math.max(0, premiumTotal - premiumSub) : 0;


            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ State –¥–ª—è –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è
            State.finalTotal = basicTotal; // –î–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –±–∞–∑–æ–≤—ã–π
            State.finalDetails = {
              servicesTotal: 0,
              discount: 0,
              travel,
              manPrice,
              guestPrice,
              k,
              isPackage: true,
              packageTemplate: tpl,

              cashlessPercent: cashlessPct,
              useCashless: useTax,
              agencyPercent: agencyPct,
              useAgency,

              basicPrice,
              optimalPrice,
              premiumPrice,

              basicPreTax,
              optimalPreTax,
              premiumPreTax,

              basicTax,
              optimalTax,
              premiumTax,

              basicSub,
              optimalSub,
              premiumSub,

              basicAgencyMarkup,
              optimalAgencyMarkup,
              premiumAgencyMarkup,

              basicTotal,
              optimalTotal,
              premiumTotal
            };

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –¥–∏–∞–ø–∞–∑–æ–Ω –≤ –∏—Ç–æ–≥–µ
            const totalSumEl = document.getElementById('total-sum');
            if (totalSumEl) {
              totalSumEl.innerHTML = `
            ${useAgency ? `
              <div class="text-sm text-slate-400">–ë–∞–∑–æ–≤—ã–π:</div>
              <div class="text-sm text-slate-500">–ù–∞ —Ä—É–∫–∏: <span class="text-slate-200 font-bold mono">${Utils.formatPrice(basicPreTax)} ‚ÇΩ</span> ‚Ä¢ –ö–ª–∏–µ–Ω—Ç—É: <span class="text-slate-200 font-bold mono">${Utils.formatPrice(basicTotal)} ‚ÇΩ</span></div>

              <div class="text-sm text-slate-400 mt-2">–û–ø—Ç–∏–º–∞–ª:</div>
              <div class="text-sm text-slate-500">–ù–∞ —Ä—É–∫–∏: <span class="text-amber-400 font-extrabold mono">${Utils.formatPrice(optimalPreTax)} ‚ÇΩ</span> ‚Ä¢ –ö–ª–∏–µ–Ω—Ç—É: <span class="text-amber-400 font-extrabold mono">${Utils.formatPrice(optimalTotal)} ‚ÇΩ</span></div>

              <div class="text-sm text-slate-400 mt-2">–ü—Ä–µ–º–∏—É–º:</div>
              <div class="text-sm text-slate-500">–ù–∞ —Ä—É–∫–∏: <span class="text-purple-300 font-extrabold mono">${Utils.formatPrice(premiumPreTax)} ‚ÇΩ</span> ‚Ä¢ –ö–ª–∏–µ–Ω—Ç—É: <span class="text-purple-300 font-extrabold mono">${Utils.formatPrice(premiumTotal)} ‚ÇΩ</span></div>
            ` : `
              <div class="text-sm text-slate-400">–ë–∞–∑–æ–≤—ã–π:</div>
              <div class="text-2xl font-bold">${Utils.formatPrice(basicTotal)} ‚ÇΩ</div>
              <div class="text-sm text-slate-400 mt-2">–û–ø—Ç–∏–º–∞–ª:</div>
              <div class="text-xl font-bold text-amber-400">${Utils.formatPrice(optimalTotal)} ‚ÇΩ</div>
              <div class="text-sm text-slate-400 mt-2">–ü—Ä–µ–º–∏—É–º:</div>
              <div class="text-xl font-bold text-purple-400">${Utils.formatPrice(premiumTotal)} ‚ÇΩ</div>
            `}
`;
            }

            // –ù–ï –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –±–æ–Ω—É—Å—ã –¥–ª—è –ø–∞–∫–µ—Ç–æ–≤ (–æ–Ω–∏ —É–∂–µ –≤ –æ–ø–∏—Å–∞–Ω–∏–∏)
            const bonusListEl = document.getElementById('bonus-list');
            if (bonusListEl) Utils.clearElement(bonusListEl);

            return;
          }

          // –û–ë–´–ß–ù–´–ô –†–ê–°–ß–Å–¢ (–±–µ–∑ –ø–∞–∫–µ—Ç–∞)
          let servicesTotal = 0;

          State.cart.forEach(item => {
            if (typeof item.price === 'number' && typeof item.qty === 'number') {
              servicesTotal += item.price * item.qty * k;
            }
          });

          let discount = 0;
          const discountBadge = document.getElementById('discount-badge');

          // –°–ö–ò–î–ö–ê –ó–ê –û–ë–™–Å–ú (–∏–∑ –Ω–∞—Å—Ç—Ä–æ–µ–∫)
          const bulkEnabled = DB.config?.bulkDiscountEnabled ?? true;
          const bulkPercent = Utils.sanitizeNumber(DB.config?.bulkDiscountPercent ?? 10, 0, 100, 10);
          const bulkMinServices = Utils.sanitizeNumber(DB.config?.bulkDiscountMinServices ?? 2, 1, 100, 2);

          if (bulkEnabled && State.cart.length >= bulkMinServices) {
            discount = Utils.prettyRound(servicesTotal * (bulkPercent / 100));
            if (discountBadge) {
              discountBadge.textContent = `–°–∫–∏–¥–∫–∞ ${bulkPercent}%`;
              discountBadge.classList.remove('hidden');
            }
          } else {
            if (discountBadge) discountBadge.classList.add('hidden');
          }
          servicesTotal -= discount;

          const regionSelect = document.getElementById('inp-region');
          const citySelect = document.getElementById('inp-city');
          let travel = 0;

          if (regionSelect && citySelect) {
            const region = regionSelect.value;
            const city = citySelect.value;

            if (region && city && DB.travel?.[region]) {
              if (city === 'other') {
                travel = Utils.prettyRound((DB.travel[region].fee || 0) * (k > 1 ? 1.5 : 1));
              } else if (DB.travel[region].cities && DB.travel[region].cities[city] != null) {
                const cityData = DB.travel[region].cities[city];
                const baseTravel = typeof cityData === 'number' ? cityData : (cityData.price || 0);
                travel = Utils.prettyRound(baseTravel * (k > 1 ? 1.5 : 1));
              }
            }
          }

          const manualPriceInput = document.getElementById('inp-manual-price');
          const manPrice = manualPriceInput ? Utils.sanitizeNumber(manualPriceInput.value, 0, 999999, 0) : 0;

          const guestsSelect = document.getElementById('inp-guests');
          const guestPrice = guestsSelect ? Utils.sanitizeNumber(guestsSelect.value, 0, 999999, 0) : 0;

          const taxCheckbox = document.getElementById('inp-tax');
          const useTax = taxCheckbox ? taxCheckbox.checked : false;

          let preTax = servicesTotal + travel + manPrice + guestPrice;
          const cashlessPct = Utils.sanitizeNumber(DB.config?.cashlessPercent ?? 6, 0, 100, 6);
          const agencyPct = Utils.sanitizeNumber(DB.config?.agencyPercent ?? 15, 0, 99, 15);

          const agencyCheckbox = document.getElementById('inp-agency');
          const useAgency = agencyCheckbox ? agencyCheckbox.checked : false;

          const tax = useTax ? Utils.prettyRound(preTax * (cashlessPct / 100)) : 0;

          const subTotal = preTax + tax;

          const toClient = (sub) => {
            if (!useAgency) return sub;
            const k = 1 + (agencyPct / 100);
            return Utils.prettyRound(sub * k);
          };

          const total = toClient(subTotal);
          const agencyMarkup = useAgency ? Math.max(0, total - subTotal) : 0;

          // –í –∏—Ç–æ–≥–∞—Ö –∏ –±–æ–Ω—É—Å–∞—Ö –æ—Ä–∏–µ–Ω—Ç–∏—Ä—É–µ–º—Å—è –Ω–∞ —Å—É–º–º—É –¥–ª—è –∫–ª–∏–µ–Ω—Ç–∞
          State.finalTotal = total;

          // –î–µ—Ç–∞–ª–∏ –¥–ª—è –ö–ü/–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è
          State.finalDetails = {
            servicesTotal,
            discount,
            travel,
            manPrice,
            guestPrice,
            k,
            isPackage: false,

            cashlessPercent: cashlessPct,
            useCashless: useTax,
            tax,
            subTotal,

            agencyPercent: agencyPct,
            useAgency,
            agencyMarkup,

            total,
            preTax
          };

          const totalSumEl = document.getElementById('total-sum');
          if (totalSumEl) {
            if (State.finalDetails?.useAgency) {
              totalSumEl.innerHTML = `
            <div class="text-sm text-slate-400">–ß–µ–∫ –Ω–∞ —Ä—É–∫–∏:</div>
            <div class="text-2xl font-extrabold text-slate-100 mono">${Utils.formatPrice(State.finalDetails.preTax)} ‚ÇΩ</div>
            <div class="text-sm text-slate-400 mt-2">–ß–µ–∫ –¥–ª—è –∫–ª–∏–µ–Ω—Ç–∞:</div>
            <div class="text-3xl font-extrabold text-amber-400 mono">${Utils.formatPrice(State.finalTotal)} ‚ÇΩ</div>
          `;
            } else {
              totalSumEl.textContent = `${Utils.formatPrice(State.finalTotal)} ‚ÇΩ`;
            }
          }

          App.renderBreakdown();
          App.updateBonuses();

        } catch (err) {
        }
      },

      updateBonuses: () => {
        State.activeBonuses = App.getBonusesForTotal(State.finalTotal);
        const bonusListEl = document.getElementById('bonus-list');
        if (!bonusListEl) return;

        Utils.clearElement(bonusListEl);

        if (State.activeBonuses.length > 0) {
          State.activeBonuses.forEach(bonus => {
            const bonusDiv = Utils.createElement(
              'div',
              'inline-block bg-amber-500/10 text-amber-400 border border-amber-500/20 px-4 py-2 rounded-full text-sm font-bold uppercase tracking-wider animate-enter'
            );
            bonusDiv.textContent = bonus.text;
            bonusListEl.appendChild(bonusDiv);
          });
        }
      },

      getBonusesForTotal: (total) => {
        if (!DB.bonuses || !Array.isArray(DB.bonuses) || DB.bonuses.length === 0) return [];
        return DB.bonuses
          .filter(b => Utils.isValidObject(b) &&
            typeof b.threshold === 'number' &&
            !isNaN(b.threshold) &&
            typeof b.text === 'string' &&
            b.text.length > 0 &&
            total >= b.threshold)
          .slice()
          .sort((a, b) => (a.threshold || 0) - (b.threshold || 0));
      },


      copyPriceList: async () => {
        const catSelect = document.getElementById('inp-cat');
        if (!catSelect) return;

        const cat = catSelect.value;
        if (!cat || !DB.services || !DB.services[cat]) {
          App.showToast('–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é');
          return;
        }

        const services = DB.services[cat];
        if (!Utils.isValidObject(services) || Object.keys(services).length === 0) {
          App.showToast('–ö–∞—Ç–µ–≥–æ—Ä–∏—è –ø—É—Å—Ç–∞—è');
          return;
        }

        const depositPct = Utils.sanitizeNumber(DB.config?.deposit ?? 30, 0, 100, 30);
        const cashlessPct = Utils.sanitizeNumber(DB.config?.cashlessPercent ?? 6, 0, 100, 6);
        const agencyPct = Utils.sanitizeNumber(DB.config?.agencyPercent ?? 15, 0, 99, 15);

        // –¢–µ–∫—É—â–∏–µ —É—Å–ª–æ–≤–∏—è (–¥–ª—è —Ä–∞—Å—á—ë—Ç–∞ –∏—Ç–æ–≥–æ–≤—ã—Ö —Ü–µ–Ω)
        const k = State.holidayK || 1;

        // –õ–æ–≥–∏—Å—Ç–∏–∫–∞ (–ø–æ –≤—ã–±—Ä–∞–Ω–Ω—ã–º —Ä–µ–≥–∏–æ–Ω/–≥–æ—Ä–æ–¥)
        const regionSelect = document.getElementById('inp-region');
        const citySelect = document.getElementById('inp-city');
        let travel = 0;

        if (regionSelect && citySelect) {
          const region = regionSelect.value;
          const city = citySelect.value;
          if (region && city && DB.travel?.[region]) {
            if (city === 'other') {
              travel = Utils.prettyRound((DB.travel[region].fee || 0) * (k > 1 ? 1.5 : 1));
            } else if (DB.travel[region].cities && DB.travel[region].cities[city] != null) {
              const cityData = DB.travel[region].cities[city];
              const baseTravel = typeof cityData === 'number' ? cityData : (cityData.price || 0);
              travel = Utils.prettyRound(baseTravel * (k > 1 ? 1.5 : 1));
            }
          }
        }

        const manualPriceInput = document.getElementById('inp-manual-price');
        const manPrice = manualPriceInput ? Utils.sanitizeNumber(manualPriceInput.value, 0, 999999, 0) : 0;

        const guestsSelect = document.getElementById('inp-guests');
        const guestPrice = guestsSelect ? Utils.sanitizeNumber(guestsSelect.value, 0, 999999, 0) : 0;

        const taxCheckbox = document.getElementById('inp-tax');
        const useTax = taxCheckbox ? taxCheckbox.checked : false;

        const agencyCheckbox = document.getElementById('inp-agency');
        const useAgency = agencyCheckbox ? agencyCheckbox.checked : false;

        const computeFinal = (basePrice) => {
          const base = Utils.prettyRound(Utils.sanitizeNumber(basePrice, 0, 999999, 0) * k);
          let total = base + travel + manPrice + guestPrice;

          if (useTax) total += Utils.prettyRound(total * (cashlessPct / 100));
          if (useAgency) total += Utils.prettyRound(total * (agencyPct / 100));

          return Math.max(0, Utils.prettyRound(total));
        };

        let text = `–í–∞—à–µ –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ\n\n`;
        text += `üìå –§–æ—Ä–º–∞—Ç: ${cat}\n\n`;
        text += `–í–∞—Ä–∏–∞–Ω—Ç—ã –∏ –∏—Ç–æ–≥–æ–≤–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å (—É—Å–ª–æ–≤–∏—è —É–∂–µ —É—á—Ç–µ–Ω—ã):\n\n`;

        const lines = [];
        Object.keys(services).forEach((name) => {
          const raw = services[name];

          const safeName = Utils.sanitizeText(name, 120);
          if (!safeName) return;

          const basePrice = typeof raw === 'number'
            ? raw
            : (Utils.isValidObject(raw) ? Utils.sanitizeNumber(raw.price, 0, 999999, 0) : 0);

          const finalPrice = computeFinal(basePrice);
          if (!finalPrice) return;

          // –ë–æ–Ω—É—Å—ã: –æ–±—ä–µ–¥–∏–Ω—è–µ–º –±–æ–Ω—É—Å—ã —É—Å–ª—É–≥–∏ + –±–æ–Ω—É—Å—ã –ø–æ –ø–æ—Ä–æ–≥—É
          const perItemBonuses = (Utils.isValidObject(raw) && Array.isArray(raw.bonuses)) ? raw.bonuses : [];
          const thresholdBonuses = App.getBonusesForTotal(finalPrice).map(b => b.text);

          const allBonuses = []
            .concat(perItemBonuses)
            .concat(thresholdBonuses)
            .map(b => Utils.sanitizeText(b, 140))
            .filter(Boolean);

          const uniqBonuses = Array.from(new Set(allBonuses));
          const showBonuses = !!document.getElementById('inp-show-bonuses')?.checked;
          const bonusLine = (showBonuses && uniqBonuses.length)
            ? `\n  –ë–æ–Ω—É—Å—ã:\n${uniqBonuses.map(b => `    ‚úÖ ${b}`).join('\n')}`
            : '';

          lines.push(`‚Ä¢ ${safeName} ‚Äî ${Utils.formatPrice(finalPrice)} ‚ÇΩ${bonusLine}`);
        });

        if (!lines.length) {
          App.showToast('–ù–µ—Ç —Ü–µ–Ω –¥–ª—è –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è');
          return;
        }

        text += lines.join('\n\n') + '\n\n';
        text += `–ë—Ä–æ–Ω—å: ${depositPct}% (—Ñ–∏–∫—Å–∏—Ä—É–µ—Ç –¥–∞—Ç—É)\n\n`;

        // Expiring bonus (—Å–≥–æ—Ä–∞—é—â–∏–π –±–æ–Ω—É—Å)
        const burnEnabled = !!document.getElementById('inp-burn')?.checked;
        if (burnEnabled) {
          const hours = Utils.sanitizeNumber(DB.config?.burnHours ?? 48, 1, 240, 48);
          const bonusTitle = Utils.sanitizeText(DB.config?.burnBonusTitle ?? '', 120) || '–ë–æ–Ω—É—Å';
          const bonusPrice = Utils.sanitizeNumber(DB.config?.burnBonusPrice ?? 0, 0, 99999999, 0);
          const bonusDiscountPrice = Utils.sanitizeNumber(DB.config?.burnBonusDiscountPrice ?? 0, 0, 99999999, 0);
          const deadline = new Date(Date.now() + hours * 60 * 60 * 1000);

          // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –¥–∞—Ç—É –ò –í–†–ï–ú–Ø
          const deadlineDate = new Intl.DateTimeFormat('ru-RU', {
            day: '2-digit',
            month: '2-digit',
            year: 'numeric'
          }).format(deadline);

          const deadlineTime = new Intl.DateTimeFormat('ru-RU', {
            hour: '2-digit',
            minute: '2-digit',
            hour12: false
          }).format(deadline);

          // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–µ–∫—Å—Ç –Ω–æ–≤–æ–π —Ü–µ–Ω—ã –±–æ–Ω—É—Å–∞
          const newPriceText = bonusDiscountPrice === 0
            ? '–ë–ï–°–ü–õ–ê–¢–ù–û! üéÅ'
            : `${Utils.formatPrice(bonusDiscountPrice)} ‚ÇΩ`;

          // –ö–†–ê–°–ò–í–´–ô –ö–û–ú–ü–ê–ö–¢–ù–´–ô –ë–õ–û–ö –ê–ö–¶–ò–ò
          text += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n`;
          text += `üî• –ê–ö–¶–ò–Ø ‚Äî –£–°–ü–ï–ô –ó–ê–ë–†–û–ù–ò–†–û–í–ê–¢–¨!\n`;
          text += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n`;
          text += `${bonusTitle}\n`;
          text += `–û–±—ã—á–Ω–∞—è —Ü–µ–Ω–∞: ~~${Utils.formatPrice(bonusPrice)} ‚ÇΩ~~\n`;
          text += `–¶–µ–Ω–∞ –ø–æ –∞–∫—Ü–∏–∏: ${newPriceText}\n\n`;
          text += `‚è∞ –ê–∫—Ü–∏—è –¥–µ–π—Å—Ç–≤—É–µ—Ç –¥–æ: ${deadlineDate} ${deadlineTime}\n`;
          text += `   (–æ—Å—Ç–∞–ª–æ—Å—å ${hours} —á.)\n\n`;
          text += `üíé –ó–∞–±—Ä–æ–Ω–∏—Ä—É–π –¥–∞—Ç—É –°–ï–ô–ß–ê–° ‚Äî –ø–æ–ª—É—á–∏ –±–æ–Ω—É—Å –≤ –ø–æ–¥–∞—Ä–æ–∫!\n`;
          text += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n`;
        }

        const showLinks = !!document.getElementById('inp-show-links')?.checked;
        if (showLinks && Array.isArray(DB.links) && DB.links.length) {
          text += `–°—Å—ã–ª–∫–∏:\n`;
          DB.links.forEach(l => {
            if (Utils.isValidObject(l)) {
              const label = Utils.sanitizeText(l.label, 100);
              const url = Utils.sanitizeText(l.url, 500);
              if (label && url) text += `‚Ä¢ ${label}: ${url}\n`;
            }
          });
          text += `\n`;
        }

        if (Array.isArray(DB.payments) && DB.payments.length) {
          text += `–°–ø–æ—Å–æ–±—ã –ø—Ä–µ–¥–æ–ø–ª–∞—Ç—ã –∏ –±—Ä–æ–Ω–∏:\n`;
          DB.payments.forEach(p => {
            if (Utils.isValidObject(p)) {
              const title = Utils.sanitizeText(p.title, 80);
              const txt = Utils.sanitizeText(p.text, 240);
              if (title || txt) text += `‚Ä¢ ${title}${title && txt ? ': ' : ''}${txt}\n`;
            }
          });
          text += `\n`;
        }

        const personalName = Utils.sanitizeText(DB.config?.personalName || '', 100);
        if (personalName) {
          text += `–° —É–≤–∞–∂–µ–Ω–∏–µ–º, ${personalName}`;
        } else {
          const performer = Utils.sanitizeText(DB.config?.performer || 'Illusionist', 100);
          text += `–í–∞—à ${performer}`;
        }

        const success = await Utils.copyToClipboard(text);
        App.showToast(success ? '–¶–µ–Ω—ã —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω—ã!' : '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å');
      },


      copyQuote: async () => {
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ 1: –ï—Å—Ç—å –ª–∏ —É—Å–ª—É–≥–∏ –≤ –∫–æ—Ä–∑–∏–Ω–µ
        const hasServices = (State.cart || []).filter(it => it && it.name).length > 0;
        if (!hasServices) {
          await PremiumDialog.alert({
            message: '–î–æ–±–∞–≤—å—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω—É —É—Å–ª—É–≥—É –≤ –∫–æ—Ä–∑–∏–Ω—É!',
            okText: '–ü–æ–Ω—è—Ç–Ω–æ',
            icon: 'alert-triangle'
          });
          return;
        }

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ 2: –£–∫–∞–∑–∞–Ω –ª–∏ —Ä–µ–≥–∏–æ–Ω
        const region = document.getElementById('inp-region')?.value || '';
        if (!region) {
          await PremiumDialog.alert({
            message: '–í—ã–±–µ—Ä–∏—Ç–µ —Ä–µ–≥–∏–æ–Ω –ø–µ—Ä–µ–¥ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ–º –ö–ü!',
            okText: '–ü–æ–Ω—è—Ç–Ω–æ',
            icon: 'map-pin'
          });
          return;
        }

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ 3: –£–∫–∞–∑–∞–Ω –ª–∏ –≥–æ—Ä–æ–¥
        const city = document.getElementById('inp-city')?.value || '';
        if (!city) {
          await PremiumDialog.alert({
            message: '–í—ã–±–µ—Ä–∏—Ç–µ –≥–æ—Ä–æ–¥ –ø–µ—Ä–µ–¥ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ–º –ö–ü!',
            okText: '–ü–æ–Ω—è—Ç–Ω–æ',
            icon: 'map-pin'
          });
          return;
        }

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ 4: –ï—Å—Ç—å –ª–∏ –∏—Ç–æ–≥–æ–≤–∞—è —Å—É–º–º–∞
        if (!State.finalTotal || State.finalTotal <= 0) {
          App.showToast('–°—É–º–º–∞ 0 ‚ÇΩ');
          return;
        }

        const depositPct = Utils.sanitizeNumber(DB.config?.deposit ?? 30, 0, 100, 30);

        const dateRaw = document.getElementById('inp-date')?.value || '';
        const dateFmt = Utils.formatDate(dateRaw) || dateRaw || '–ø–æ —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏—é';

        const timeRaw = document.getElementById('inp-time')?.value || '';
        const timeFmt = timeRaw ? timeRaw : '–ø–æ —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏—é';

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–∫–æ–ª—å–∫–æ —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –≥–æ—Ä–æ–¥–æ–≤
        const uniqueCities = new Set(State.cart.map(item => `${item.region}_${item.city}`));
        const hasMultipleCities = uniqueCities.size > 1;

        const locationLine = hasMultipleCities ? '–Ω–µ—Å–∫–æ–ª—å–∫–æ –≥–æ—Ä–æ–¥–æ–≤' : (Utils.sanitizeText(city, 80) || '–ø–æ —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏—é');

        let text = `–í–∞—à–µ –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ\n\n`;
        text += `üìÖ –î–∞—Ç–∞: ${dateFmt}\n`;
        text += `‚è∞ –í—Ä–µ–º—è: ${timeFmt}\n`;
        text += `üìç –õ–æ–∫–∞—Ü–∏—è: ${locationLine}\n\n`;

        // ====== PACKAGE MODE ======
        if (State.finalDetails?.isPackage && State.finalDetails?.packageTemplate) {
          const tpl = State.finalDetails.packageTemplate;

          const variants = [
            { key: 'basic', title: 'üì¶ –í–∞—Ä–∏–∞–Ω—Ç 1: –ë–∞–∑–æ–≤—ã–π', total: State.finalDetails.basicTotal || 0, data: tpl.basic },
            { key: 'optimal', title: 'üì¶ –í–∞—Ä–∏–∞–Ω—Ç 2: –û–ø—Ç–∏–º–∞–ª', total: State.finalDetails.optimalTotal || 0, data: tpl.optimal },
            { key: 'premium', title: 'üì¶ –í–∞—Ä–∏–∞–Ω—Ç 3: –ü—Ä–µ–º–∏—É–º', total: State.finalDetails.premiumTotal || 0, data: tpl.premium },
          ];

          variants.forEach(v => {
            text += `${v.title}\n\n`;
            if (v.data?.description) text += `${Utils.sanitizeText(v.data.description, 500)}\n\n`;

            const showBonuses = !!document.getElementById('inp-show-bonuses')?.checked;
            if (showBonuses && Array.isArray(v.data?.bonuses) && v.data.bonuses.length) {
              text += `–ë–æ–Ω—É—Å—ã:\n`;
              v.data.bonuses.forEach(b => text += `  ‚úÖ ${Utils.sanitizeText(b, 160)}\n`);
              text += `\n`;
            }

            text += `–°—Ç–æ–∏–º–æ—Å—Ç—å: ${Utils.formatPrice(v.total)} ‚ÇΩ\n`;
            const dep = Utils.prettyRound(v.total * (depositPct / 100));
            text += `–ë—Ä–æ–Ω—å ${depositPct}%: ${Utils.formatPrice(dep)} ‚ÇΩ\n`;
            text += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n`;
          });

        } else {
          // ====== NORMAL MODE ======
          const kLine = State.holidayK || 1;
          const cartItems = (State.cart || []).filter(it => it && !String(it.name || '').startsWith('–ü–ê–ö–ï–¢:'));

          if (!cartItems.length) {
            App.showToast('–î–æ–±–∞–≤—å—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω—É —É—Å–ª—É–≥—É');
            return;
          }

          // –ì—Ä—É–ø–ø–∏—Ä—É–µ–º —É—Å–ª—É–≥–∏ –ø–æ –≥–æ—Ä–æ–¥–∞–º
          const cityGroups = {};
          cartItems.forEach(item => {
            const cityKey = `${item.region || 'unknown'}_${item.city || 'unknown'}`;
            if (!cityGroups[cityKey]) {
              cityGroups[cityKey] = {
                cityName: item.cityName || '–ì–æ—Ä–æ–¥ –Ω–µ —É–∫–∞–∑–∞–Ω',
                region: item.region,
                city: item.city,
                items: []
              };
            }
            cityGroups[cityKey].items.push(item);
          });

          const cityKeys = Object.keys(cityGroups);
          const hasMultipleCities = cityKeys.length > 1;

          // –û–±—â–∏–µ –¥–æ–ø–ª–∞—Ç—ã
          const manPrice = Utils.sanitizeNumber(document.getElementById('inp-manual-price')?.value, 0, 999999, 0);
          const guestPrice = Utils.sanitizeNumber(document.getElementById('inp-guests')?.value, 0, 999999, 0);
          const useTax = !!document.getElementById('inp-tax')?.checked;
          const useAgency = !!document.getElementById('inp-agency')?.checked;
          const cashlessPct = Utils.sanitizeNumber(DB.config?.cashlessPercent ?? 6, 0, 100, 6);
          const agencyPct = Utils.sanitizeNumber(DB.config?.agencyPercent ?? 15, 0, 99, 15);

          // –°–∫–∏–¥–∫–∞ –∑–∞ –æ–±—ä—ë–º
          const bulkEnabled = DB.config?.bulkDiscountEnabled ?? true;
          const bulkPercent = Utils.sanitizeNumber(DB.config?.bulkDiscountPercent ?? 10, 0, 100, 10);
          const bulkMinServices = Utils.sanitizeNumber(DB.config?.bulkDiscountMinServices ?? 2, 1, 100, 2);
          const hasDiscount = bulkEnabled && cartItems.length >= bulkMinServices;
          const discountFactor = hasDiscount ? (1 - bulkPercent / 100) : 1;

          // –í—ã—á–∏—Å–ª—è–µ–º –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –≥–æ—Ä–æ–¥–∞
          cityKeys.forEach(cityKey => {
            const group = cityGroups[cityKey];

            // –î–ª—è –∫–∞–∂–¥–æ–π —É—Å–ª—É–≥–∏ —Å—á–∏—Ç–∞–µ–º –ø–æ–ª–Ω—É—é —Ü–µ–Ω—É
            group.items.forEach(item => {
              // 1. –ë–∞–∑–æ–≤–∞—è —Ü–µ–Ω–∞ —É—Å–ª—É–≥–∏ —Å –ø—Ä–∞–∑–¥–Ω–∏–∫–∞–º–∏ –∏ —Å–∫–∏–¥–∫–æ–π
              let servicePrice = Utils.prettyRound(item.price * item.qty * kLine * discountFactor);

              // 2. –õ–æ–≥–∏—Å—Ç–∏–∫–∞
              let travel = 0;
              if (item.region && item.city && DB.travel?.[item.region]) {
                if (item.city === 'other') {
                  travel = Utils.prettyRound((DB.travel[item.region].fee || 0) * (kLine > 1 ? 1.5 : 1));
                } else if (DB.travel[item.region].cities && DB.travel[item.region].cities[item.city]) {
                  const cityData = DB.travel[item.region].cities[item.city];
                  const baseTravel = typeof cityData === 'number' ? cityData : (cityData.price || 0);
                  travel = Utils.prettyRound(baseTravel * (kLine > 1 ? 1.5 : 1));
                }
              }

              // 3. –î–æ–ø–ª–∞—Ç—ã (—Ä–∞–∑–¥–µ–ª–∏—Ç—å –Ω–∞ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —É—Å–ª—É–≥)
              const itemManPrice = Utils.prettyRound(manPrice / group.items.length);
              const itemGuestPrice = Utils.prettyRound(guestPrice / group.items.length);

              // 4. –ò—Ç–æ–≥–æ –¥–æ –Ω–∞–ª–æ–≥–∞
              const preTax = servicePrice + travel + itemManPrice + itemGuestPrice;

              // 5. –ë–µ–∑–Ω–∞–ª
              const tax = useTax ? Utils.prettyRound(preTax * (cashlessPct / 100)) : 0;

              // 6. –ü–æ–¥—ã—Ç–æ–≥
              const subTotal = preTax + tax;

              // 7. –ê–≥–µ–Ω—Ç—Å—Ç–≤–æ
              const total = useAgency ? Utils.prettyRound(subTotal * (1 + agencyPct / 100)) : subTotal;

              item.calculatedTotal = total;
            });

            // –û–±—â–∏–π –∏—Ç–æ–≥ –≥–æ—Ä–æ–¥–∞
            const total = group.items.reduce((sum, item) => sum + (item.calculatedTotal || 0), 0);
            const bonusTexts = App.getBonusesForTotal(total)
              .map(b => b?.text)
              .filter(Boolean)
              .map(t => Utils.sanitizeText(t, 160))
              .filter(Boolean);

            group.total = total;
            group.bonuses = Array.from(new Set(bonusTexts));
          });

          const showBonuses = !!document.getElementById('inp-show-bonuses')?.checked;

          // –§–æ—Ä–º–∏—Ä—É–µ–º —Ç–µ–∫—Å—Ç –ö–ü
          if (hasMultipleCities) {
            // –ú–£–õ–¨–¢–ò-–ì–û–†–û–î
            text += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n`;
            text += `–í–ê–†–ò–ê–ù–¢–´ –ü–û –ì–û–†–û–î–ê–ú:\n`;
            text += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n`;

            cityKeys.forEach((cityKey, index) => {
              const group = cityGroups[cityKey];

              text += `${index + 1}. ${group.cityName}\n\n`;

              // –£—Å–ª—É–≥–∏
              group.items.forEach(item => {
                const name = Utils.sanitizeText(item.name || '', 120);
                const qty = Utils.sanitizeNumber(item.qty || 1, 1, 99, 1);
                text += `‚Ä¢ ${name}${qty > 1 ? ` √ó${qty}` : ''}\n`;

                // –û–ø–∏—Å–∞–Ω–∏–µ —É—Å–ª—É–≥–∏ (–µ—Å–ª–∏ –µ—Å—Ç—å) - –°–†–ê–ó–£ –ü–û–°–õ–ï –ù–ê–ó–í–ê–ù–ò–Ø
                if (item.description && item.description.trim()) {
                  const desc = Utils.sanitizeText(item.description, 500);
                  text += `  ${desc}\n`;
                }
              });

              text += `\n`;
              text += `–°—Ç–æ–∏–º–æ—Å—Ç—å: ${Utils.formatPrice(group.total)} ‚ÇΩ\n`;

              // –ë–æ–Ω—É—Å—ã
              if (showBonuses && group.bonuses && group.bonuses.length) {
                text += `–ë–æ–Ω—É—Å—ã:\n`;
                group.bonuses.forEach(b => {
                  text += `  ‚úÖ ${b}\n`;
                });
              }

              const dep = Utils.prettyRound(group.total * (depositPct / 100));
              text += `–ë—Ä–æ–Ω—å ${depositPct}%: ${Utils.formatPrice(dep)} ‚ÇΩ\n`;

              if (index < cityKeys.length - 1) {
                text += `\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n`;
              }
            });

          } else {
            // –û–î–ò–ù –ì–û–†–û–î (—Å—Ç–∞—Ä–∞—è –ª–æ–≥–∏–∫–∞)
            const group = cityGroups[cityKeys[0]];

            group.items.forEach(item => {
              const name = Utils.sanitizeText(item.name || '', 120);
              const qty = Utils.sanitizeNumber(item.qty || 1, 1, 99, 1);
              const title = qty > 1 ? `${name} √ó${qty}` : name;
              const itemTotal = item.calculatedTotal || 0;
              const itemDep = Utils.prettyRound(itemTotal * (depositPct / 100));

              text += `${title}\n`;

              // –û–ø–∏—Å–∞–Ω–∏–µ —É—Å–ª—É–≥–∏ (–µ—Å–ª–∏ –µ—Å—Ç—å) - –°–†–ê–ó–£ –ü–û–°–õ–ï –ù–ê–ó–í–ê–ù–ò–Ø
              if (item.description && item.description.trim()) {
                const desc = Utils.sanitizeText(item.description, 500);
                text += `${desc}\n`;
              }

              text += `–°—Ç–æ–∏–º–æ—Å—Ç—å: ${Utils.formatPrice(itemTotal)} ‚ÇΩ\n`;
              text += `–ü—Ä–µ–¥–æ–ø–ª–∞—Ç–∞ ${depositPct}%: ${Utils.formatPrice(itemDep)} ‚ÇΩ\n`;
              text += `\n`;
            });

            if (showBonuses && group.bonuses && group.bonuses.length) {
              text += `–ë–æ–Ω—É—Å—ã:\n`;
              group.bonuses.forEach(b => {
                text += `  ‚úÖ ${b}\n`;
              });
              text += `\n`;
            }
          }
        }

        // Expiring bonus (—Å–≥–æ—Ä–∞—é—â–∏–π –±–æ–Ω—É—Å)
        const burnEnabled = !!document.getElementById('inp-burn')?.checked;
        if (burnEnabled) {
          const hours = Utils.sanitizeNumber(DB.config?.burnHours ?? 48, 1, 240, 48);
          const bonusTitle = Utils.sanitizeText(DB.config?.burnBonusTitle ?? '', 120) || '–ë–æ–Ω—É—Å';
          const bonusPrice = Utils.sanitizeNumber(DB.config?.burnBonusPrice ?? 0, 0, 99999999, 0);
          const bonusDiscountPrice = Utils.sanitizeNumber(DB.config?.burnBonusDiscountPrice ?? 0, 0, 99999999, 0);
          const deadline = new Date(Date.now() + hours * 60 * 60 * 1000);

          // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –¥–∞—Ç—É –ò –í–†–ï–ú–Ø
          const deadlineDate = new Intl.DateTimeFormat('ru-RU', {
            day: '2-digit',
            month: '2-digit',
            year: 'numeric'
          }).format(deadline);

          const deadlineTime = new Intl.DateTimeFormat('ru-RU', {
            hour: '2-digit',
            minute: '2-digit',
            hour12: false
          }).format(deadline);

          // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–µ–∫—Å—Ç –Ω–æ–≤–æ–π —Ü–µ–Ω—ã –±–æ–Ω—É—Å–∞
          const newPriceText = bonusDiscountPrice === 0
            ? '–ë–ï–°–ü–õ–ê–¢–ù–û! üéÅ'
            : `${Utils.formatPrice(bonusDiscountPrice)} ‚ÇΩ`;

          // –ö–†–ê–°–ò–í–´–ô –ö–û–ú–ü–ê–ö–¢–ù–´–ô –ë–õ–û–ö –ê–ö–¶–ò–ò
          text += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n`;
          text += `üî• –ê–ö–¶–ò–Ø ‚Äî –£–°–ü–ï–ô –ó–ê–ë–†–û–ù–ò–†–û–í–ê–¢–¨!\n`;
          text += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n`;
          text += `${bonusTitle}\n`;
          text += `–û–±—ã—á–Ω–∞—è —Ü–µ–Ω–∞: ~~${Utils.formatPrice(bonusPrice)} ‚ÇΩ~~\n`;
          text += `–¶–µ–Ω–∞ –ø–æ –∞–∫—Ü–∏–∏: ${newPriceText}\n\n`;
          text += `‚è∞ –ê–∫—Ü–∏—è –¥–µ–π—Å—Ç–≤—É–µ—Ç –¥–æ: ${deadlineDate} ${deadlineTime}\n`;
          text += `   (–æ—Å—Ç–∞–ª–æ—Å—å ${hours} —á.)\n\n`;
          text += `üíé –ó–∞–±—Ä–æ–Ω–∏—Ä—É–π –¥–∞—Ç—É –°–ï–ô–ß–ê–° ‚Äî –ø–æ–ª—É—á–∏ –±–æ–Ω—É—Å –≤ –ø–æ–¥–∞—Ä–æ–∫!\n`;
          text += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n`;
        }

        // Links
        const showLinks = !!document.getElementById('inp-show-links')?.checked;
        if (showLinks && Array.isArray(DB.links) && DB.links.length) {
          text += `–°—Å—ã–ª–∫–∏:\n`;
          DB.links.forEach(l => {
            if (Utils.isValidObject(l)) {
              const label = Utils.sanitizeText(l.label, 100);
              const url = Utils.sanitizeText(l.url, 500);
              if (label && url) text += `‚Ä¢ ${label}: ${url}\n`;
            }
          });
          text += `\n`;
        }

        // Payments
        if (Array.isArray(DB.payments) && DB.payments.length) {
          text += `–°–ø–æ—Å–æ–±—ã –ø—Ä–µ–¥–æ–ø–ª–∞—Ç—ã –∏ –±—Ä–æ–Ω–∏:\n`;
          DB.payments.forEach(p => {
            if (Utils.isValidObject(p)) {
              const title = Utils.sanitizeText(p.title, 80);
              const txt = Utils.sanitizeText(p.text, 240);
              if (title || txt) text += `‚Ä¢ ${title}${title && txt ? ': ' : ''}${txt}\n`;
            }
          });
          text += `\n`;
        }

        // Signature
        const personalName = Utils.sanitizeText(DB.config?.personalName || '', 100);
        if (personalName) {
          text += `–° —É–≤–∞–∂–µ–Ω–∏–µ–º, ${personalName}`;
        } else {
          const performer = Utils.sanitizeText(DB.config?.performer || 'Illusionist', 100);
          text += `–í–∞—à ${performer}`;
        }

        KPBuffer.addFromText(text, { total: State.finalTotal, itemsCount: (State.cart || []).filter(it => it && it.name && !String(it.name).startsWith('–ü–ê–ö–ï–¢:')).length });

        const success = await Utils.copyToClipboard(text);
        App.showToast(success ? '–ö–ü —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!' : '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å');
      },

      toggleSettings: () => {
        const modal = document.getElementById('view-settings');
        if (!modal) return;

        const isOpen = modal.classList.contains('active');

        if (!isOpen) {
          Admin.render();
          DataManager.renderBackupSlots();
          DataManager.updateStats();

          // –†–µ–Ω–¥–µ—Ä–∏–º —à–∞–±–ª–æ–Ω—ã –ø–∞–∫–µ—Ç–æ–≤ (–∏—Å–ø–æ–ª—å–∑—É–µ–º —Ñ—É–Ω–∫—Ü–∏—é —Å –∫–Ω–æ–ø–∫–æ–π —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è)
          if (typeof renderTemplatesAdmin === 'function') {
            renderTemplatesAdmin();
          }

          // –†–µ–Ω–¥–µ—Ä–∏–º –±—É—Ñ–µ—Ä –ö–ü
          KPBuffer.render();

          modal.classList.add('active');
          if (window.lucide) lucide.createIcons();
        } else {
          modal.classList.remove('active');
          App.updateUI();
        }
      },

      // === FIREBASE SYNC ===
      _syncEventToFirebase: async (event) => {
        if (!window.firebaseEnabled || !window.firebaseDB) {
          App._queueEventForSync(event);
          return { ok: false, reason: 'SDK –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω' };
        }
        try {
          const deviceKey = window.getDeviceFingerprint();
          const eventRef = window.firebaseDB.ref('sync/events/' + deviceKey + '/' + event.id);
          await eventRef.set({
            ...event,
            _source: 'calculator',
            _createdAt: new Date().toISOString()
          });
          return { ok: true };
        } catch (error) {
          console.error('‚ö†Ô∏è Firebase sync failed:', error);
          App._queueEventForSync(event);
          var msg = error.message || String(error);
          if (msg.includes('PERMISSION_DENIED')) {
            return { ok: false, reason: '–ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞ (–ø—Ä–∞–≤–∏–ª–∞ Firebase)' };
          }
          return { ok: false, reason: msg.substring(0, 60) };
        }
      },

      _queueEventForSync: (event) => {
        try {
          const queue = JSON.parse(localStorage.getItem('illusionist_sync_queue') || '[]');
          queue.push(event);
          localStorage.setItem('illusionist_sync_queue', JSON.stringify(queue));
        } catch (e) { }
      },

      _processSyncQueue: async () => {
        if (!window.firebaseEnabled || !window.firebaseDB) return;
        try {
          const queue = JSON.parse(localStorage.getItem('illusionist_sync_queue') || '[]');
          if (queue.length === 0) return;
          const remaining = [];
          for (const event of queue) {
            try {
              const deviceKey = window.getDeviceFingerprint();
              const eventRef = window.firebaseDB.ref('sync/events/' + deviceKey + '/' + event.id);
              await eventRef.set({ ...event, _source: 'calculator', _createdAt: new Date().toISOString() });
            } catch (e) {
              remaining.push(event);
            }
          }
          if (remaining.length === 0) {
            localStorage.removeItem('illusionist_sync_queue');
          } else {
            localStorage.setItem('illusionist_sync_queue', JSON.stringify(remaining));
          }
        } catch (e) { }
      },

      addToCalendar: async () => {
        if (!State.cart || State.cart.length === 0) {
          App.showToast('‚ö†Ô∏è –ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞');
          return;
        }

        const dateEl = document.getElementById('inp-date');
        const timeEl = document.getElementById('inp-time');
        const timeModeEl = document.getElementById('inp-time-mode');

        const dateVal = dateEl ? dateEl.value : '';
        const timeVal = (timeModeEl && timeModeEl.value === 'none') ? '12:00' : (timeEl ? timeEl.value : '12:00');

        if (!dateVal) {
          App.showToast('‚ö†Ô∏è –í—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É –¥–ª—è –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è');
          if (dateEl) dateEl.focus();
          return;
        }

        try {
          const eventId = Date.now();

          // –°–æ–±–∏—Ä–∞–µ–º –≥–æ—Ä–æ–¥ –∏ —Ä–µ–≥–∏–æ–Ω –∏–∑ –∫–æ—Ä–∑–∏–Ω—ã
          const firstWithCity = State.cart.find(i => i.cityName || i.regionName);
          const cityName = firstWithCity?.cityName || '';
          const regionName = firstWithCity?.regionName || '';
          const addressParts = [cityName, regionName].filter(Boolean);
          const address = addressParts.join(', ');

          // –§–æ—Ä–º–∏—Ä—É–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏—è ‚Äî —É—Å–ª—É–≥–∏ –∏–∑ –∫–æ—Ä–∑–∏–Ω—ã
          const serviceNames = State.cart.map(i => i.name).filter(Boolean);
          const title = serviceNames.length > 0
            ? serviceNames.slice(0, 3).join(', ') + (serviceNames.length > 3 ? ' –∏ –¥—Ä.' : '')
            : '–í—ã—Å—Ç—É–ø–ª–µ–Ω–∏–µ';

          // –ß–µ–∫–ª–∏—Å—Ç –∏–∑ —É—Å–ª—É–≥ –∫–æ—Ä–∑–∏–Ω—ã
          const checklist = State.cart.map(i => ({
            text: `${i.name}${i.qty > 1 ? ' x' + i.qty : ''} ‚Äî ${Utils.formatPrice(i.price)} ‚ÇΩ`,
            done: false
          }));

          // –ó–∞–º–µ—Ç–∫–∏ ‚Äî –ø–æ–¥—Ä–æ–±–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
          const servicesList = State.cart.map(i =>
            `‚Ä¢ ${i.name}${i.qty > 1 ? ' x' + i.qty : ''} ‚Äî ${Utils.formatPrice(i.price)} ‚ÇΩ` +
            (i.cityName ? ` (${i.cityName})` : '')
          ).join('\n');
          const notes = `–ò—Ç–æ–≥–æ: ${Utils.formatPrice(State.finalTotal)} ‚ÇΩ\n\n–£—Å–ª—É–≥–∏:\n${servicesList}`;

          // –°–æ–±—ã—Ç–∏–µ –≤ —Ñ–æ—Ä–º–∞—Ç–µ –∫–∞–ª–µ–Ω–¥–∞—Ä—è ILLUSIONIST OS
          const newEvent = {
            id: eventId,
            date: dateVal,
            time: timeVal || '12:00',
            title: title,
            type: 'rabbit',
            status: 'pending',
            location: cityName,
            address: address,
            client: '',
            phone: '',
            guests: 0,
            schedule: [{
              type: 'rabbit',
              time: timeVal || '12:00',
              duration: 60,
              checklist: checklist
            }],
            income: State.finalTotal || 0,
            prepay: 0,
            tax: 0,
            expenses: [],
            notes: notes
          };

          // –ó–∞–ø–∏—Å—ã–≤–∞–µ–º –≤ illusionist_events (—Ç–æ—Ç –∂–µ –∫–ª—é—á —á—Ç–æ –∏ –∫–∞–ª–µ–Ω–¥–∞—Ä—å)
          const existingData = localStorage.getItem('illusionist_events');
          let events = [];
          if (existingData) {
            try { events = JSON.parse(existingData); } catch (e) { }
          }
          if (!Array.isArray(events)) events = [];

          events.push(newEvent);
          localStorage.setItem('illusionist_events', JSON.stringify(events));

          // Firebase-—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è (–¥–ª—è –ø–µ—Ä–µ–¥–∞—á–∏ –≤ –ö–∞–ª–µ–Ω–¥–∞—Ä—å –Ω–∞ –¥—Ä—É–≥–æ–º –¥–æ–º–µ–Ω–µ)
          try {
            const result = await App._syncEventToFirebase(newEvent);
            if (result.ok) {
              App.showToast('‚úÖ –ó–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–æ –∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–æ!');
            } else {
              App.showToast('‚úÖ –ó–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–æ! ‚ö†Ô∏è ' + result.reason);
            }
          } catch (syncErr) {
            App.showToast('‚úÖ –ó–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–æ! ‚ö†Ô∏è ' + (syncErr.message || '–û—à–∏–±–∫–∞'));
          }

        } catch (e) {
          console.error('Calendar Save Error:', e);
          App.showToast('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏');
        }
      },

      showToast: (msg) => {
        const toast = document.getElementById('toast');
        const msgEl = document.getElementById('toast-msg');
        if (!toast || !msgEl) return;

        msgEl.textContent = Utils.sanitizeText(msg, 200);

        // –£–±–∏—Ä–∞–µ–º –∫–Ω–æ–ø–∫—É undo –µ—Å–ª–∏ –±—ã–ª–∞
        const existingUndo = toast.querySelector('.toast-undo-btn');
        if (existingUndo) existingUndo.remove();

        toast.classList.add('show');

        clearTimeout(App._toastTimer);
        App._toastTimer = setTimeout(() => toast.classList.remove('show'), 3000);
      },

      showToastWithUndo: (msg, undoCallback) => {
        const toast = document.getElementById('toast');
        const msgEl = document.getElementById('toast-msg');
        if (!toast || !msgEl) return;

        msgEl.textContent = Utils.sanitizeText(msg, 200);

        // –£–±–∏—Ä–∞–µ–º —Å—Ç–∞—Ä—É—é –∫–Ω–æ–ø–∫—É undo –µ—Å–ª–∏ –±—ã–ª–∞
        const existingUndo = toast.querySelector('.toast-undo-btn');
        if (existingUndo) existingUndo.remove();

        // –°–æ–∑–¥–∞—ë–º –∫–Ω–æ–ø–∫—É UNDO
        const undoBtn = document.createElement('button');
        undoBtn.className = 'toast-undo-btn';
        undoBtn.textContent = '–û—Ç–º–µ–Ω–∏—Ç—å';
        undoBtn.style.cssText = `
      margin-left: 16px;
      padding: 6px 12px;
      background: rgba(245,158,11,0.2);
      border: 1.5px solid rgba(245,158,11,0.4);
      border-radius: 6px;
      color: #f59e0b;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    `;

        undoBtn.addEventListener('mouseenter', () => {
          undoBtn.style.background = 'rgba(245,158,11,0.3)';
          undoBtn.style.borderColor = 'rgba(245,158,11,0.6)';
        });

        undoBtn.addEventListener('mouseleave', () => {
          undoBtn.style.background = 'rgba(245,158,11,0.2)';
          undoBtn.style.borderColor = 'rgba(245,158,11,0.4)';
        });

        undoBtn.addEventListener('click', () => {
          clearTimeout(App._toastTimer);
          toast.classList.remove('show');
          if (undoCallback) undoCallback();
        });

        // –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É –≤ toast
        const toastContent = toast.querySelector('.flex');
        if (toastContent) {
          toastContent.appendChild(undoBtn);
        }

        toast.classList.add('show');

        clearTimeout(App._toastTimer);
        App._toastTimer = setTimeout(() => {
          toast.classList.remove('show');
          // –£–¥–∞–ª—è–µ–º –∫–Ω–æ–ø–∫—É –ø–æ—Å–ª–µ —Å–∫—Ä—ã—Ç–∏—è
          setTimeout(() => {
            if (undoBtn.parentNode) undoBtn.remove();
          }, 500);
        }, 5000); // 5 —Å–µ–∫—É–Ω–¥ —á—Ç–æ–±—ã —É—Å–ø–µ—Ç—å –Ω–∞–∂–∞—Ç—å UNDO
      },

      editServiceDescription: async (idx) => {
        if (idx < 0 || idx >= State.cart.length) return;

        const item = State.cart[idx];
        if (!item) return;

        const currentDesc = item.description || '';

        const result = await PremiumDialog.prompt({
          title: `–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –æ–ø–∏—Å–∞–Ω–∏–µ`,
          message: `–£—Å–ª—É–≥–∞: ${item.name}`,
          defaultValue: currentDesc,
          placeholder: '–í–≤–µ–¥–∏—Ç–µ –æ–ø–∏—Å–∞–Ω–∏–µ —É—Å–ª—É–≥–∏...',
          okText: '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å',
          cancelText: '–û—Ç–º–µ–Ω–∞',
          multiline: true,
          icon: 'file-text'
        });

        if (result !== null && result !== undefined) {
          State.cart[idx].description = Utils.sanitizeText(result, 500);
          App.renderCart();
          App.showToast('–û–ø–∏—Å–∞–Ω–∏–µ –æ–±–Ω–æ–≤–ª–µ–Ω–æ');
        }
      },

      editPackageInCart: async (idx) => {
        if (idx < 0 || idx >= State.cart.length) return;

        const item = State.cart[idx];
        if (!item || !item.name.startsWith('–ü–ê–ö–ï–¢:')) return;

        // –ï—Å–ª–∏ –Ω–µ—Ç packageTemplate, —Å–æ–∑–¥–∞—ë–º –¥–µ—Ñ–æ–ª—Ç–Ω—ã–π
        let tpl = item.packageTemplate;
        if (!tpl) {
          const packageName = item.name.replace('–ü–ê–ö–ï–¢: ', '').trim() || '–ü–∞–∫–µ—Ç';
          tpl = {
            id: 'temp_' + Date.now(),
            name: packageName,
            basic: {
              name: packageName + ' ‚Äî –ë–∞–∑–æ–≤—ã–π',
              price: 50000,
              description: '',
              bonuses: []
            },
            optimal: {
              name: packageName + ' ‚Äî –û–ø—Ç–∏–º–∞–ª',
              price: 75000,
              description: '',
              bonuses: []
            },
            premium: {
              name: packageName + ' ‚Äî –ü—Ä–µ–º–∏—É–º',
              price: 120000,
              description: '',
              bonuses: []
            }
          };
          item.packageTemplate = tpl;
        }

        // –°–æ–∑–¥–∞—ë–º —Ñ–æ—Ä–º—É —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è (—Ç–∞–∫—É—é –∂–µ –∫–∞–∫ –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö)
        const overlay = document.createElement('div');
        overlay.className = 'fixed inset-0 bg-black/80 z-[9999] flex items-center justify-center p-4';
        overlay.style.backdropFilter = 'blur(8px)';

        const modal = document.createElement('div');
        modal.className = 'glass rounded-2xl p-6 max-w-2xl w-full max-h-[90vh] overflow-y-auto';

        modal.innerHTML = `
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-xl font-bold text-white">‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–∞–∫–µ—Ç–∞</h2>
        <button id="edit-close" class="text-slate-400 hover:text-white transition">
          <i data-lucide="x" class="w-6 h-6"></i>
        </button>
      </div>

      <div class="space-y-4">
        <!-- –ù–∞–∑–≤–∞–Ω–∏–µ -->
        <div>
          <label class="block text-sm font-bold text-amber-400 mb-2">–ù–∞–∑–≤–∞–Ω–∏–µ –ø–∞–∫–µ—Ç–∞</label>
          <input type="text" id="edit-name" value="${Utils.escapeHtml(tpl.name)}" 
            class="w-full bg-white/5 border-2 border-amber-500/30 rounded-xl px-4 py-3 text-white placeholder-slate-500 focus:border-amber-500 focus:outline-none transition">
        </div>

        <!-- –ë–ê–ó–û–í–´–ô -->
        <div class="border-t-2 border-amber-500/20 pt-4">
          <h3 class="text-lg font-bold text-amber-400 mb-3">üì¶ –ë–∞–∑–æ–≤—ã–π –ø–∞–∫–µ—Ç</h3>
          
          <label class="block text-sm font-bold text-white mb-2">–û–ø–∏—Å–∞–Ω–∏–µ</label>
          <textarea id="edit-basic-desc" rows="3" 
            class="w-full bg-white/5 border-2 border-amber-500/30 rounded-xl px-4 py-3 text-white placeholder-slate-500 focus:border-amber-500 focus:outline-none transition mb-3">${Utils.escapeHtml(tpl.basic.description || '')}</textarea>

          <label class="block text-sm font-bold text-white mb-2">–ë–æ–Ω—É—Å—ã (—á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é)</label>
          <input type="text" id="edit-basic-bonuses" value="${Utils.escapeHtml((tpl.basic.bonuses || []).join(', '))}" 
            class="w-full bg-white/5 border-2 border-amber-500/30 rounded-xl px-4 py-3 text-white placeholder-slate-500 focus:border-amber-500 focus:outline-none transition mb-3">

          <label class="block text-sm font-bold text-white mb-2">–¶–µ–Ω–∞ (‚ÇΩ)</label>
          <input type="number" id="edit-basic-price" value="${tpl.basic.price || 50000}" 
            class="w-full bg-white/5 border-2 border-amber-500/30 rounded-xl px-4 py-3 text-white placeholder-slate-500 focus:border-amber-500 focus:outline-none transition">
        </div>

        <!-- –û–ü–¢–ò–ú–ê–õ -->
        <div class="border-t-2 border-amber-500/20 pt-4">
          <h3 class="text-lg font-bold text-amber-400 mb-3">üì¶ –û–ø—Ç–∏–º–∞–ª –ø–∞–∫–µ—Ç</h3>
          
          <label class="block text-sm font-bold text-white mb-2">–û–ø–∏—Å–∞–Ω–∏–µ</label>
          <textarea id="edit-optimal-desc" rows="3" 
            class="w-full bg-white/5 border-2 border-amber-500/30 rounded-xl px-4 py-3 text-white placeholder-slate-500 focus:border-amber-500 focus:outline-none transition mb-3">${Utils.escapeHtml(tpl.optimal.description || '')}</textarea>

          <label class="block text-sm font-bold text-white mb-2">–ë–æ–Ω—É—Å—ã (—á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é)</label>
          <input type="text" id="edit-optimal-bonuses" value="${Utils.escapeHtml((tpl.optimal.bonuses || []).join(', '))}" 
            class="w-full bg-white/5 border-2 border-amber-500/30 rounded-xl px-4 py-3 text-white placeholder-slate-500 focus:border-amber-500 focus:outline-none transition mb-3">

          <label class="block text-sm font-bold text-white mb-2">–¶–µ–Ω–∞ (‚ÇΩ)</label>
          <input type="number" id="edit-optimal-price" value="${tpl.optimal.price || 75000}" 
            class="w-full bg-white/5 border-2 border-amber-500/30 rounded-xl px-4 py-3 text-white placeholder-slate-500 focus:border-amber-500 focus:outline-none transition">
        </div>

        <!-- –ü–†–ï–ú–ò–£–ú -->
        <div class="border-t-2 border-amber-500/20 pt-4">
          <h3 class="text-lg font-bold text-amber-400 mb-3">üì¶ –ü—Ä–µ–º–∏—É–º –ø–∞–∫–µ—Ç</h3>
          
          <label class="block text-sm font-bold text-white mb-2">–û–ø–∏—Å–∞–Ω–∏–µ</label>
          <textarea id="edit-premium-desc" rows="3" 
            class="w-full bg-white/5 border-2 border-amber-500/30 rounded-xl px-4 py-3 text-white placeholder-slate-500 focus:border-amber-500 focus:outline-none transition mb-3">${Utils.escapeHtml(tpl.premium.description || '')}</textarea>

          <label class="block text-sm font-bold text-white mb-2">–ë–æ–Ω—É—Å—ã (—á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é)</label>
          <input type="text" id="edit-premium-bonuses" value="${Utils.escapeHtml((tpl.premium.bonuses || []).join(', '))}" 
            class="w-full bg-white/5 border-2 border-amber-500/30 rounded-xl px-4 py-3 text-white placeholder-slate-500 focus:border-amber-500 focus:outline-none transition mb-3">

          <label class="block text-sm font-bold text-white mb-2">–¶–µ–Ω–∞ (‚ÇΩ)</label>
          <input type="number" id="edit-premium-price" value="${tpl.premium.price || 120000}" 
            class="w-full bg-white/5 border-2 border-amber-500/30 rounded-xl px-4 py-3 text-white placeholder-slate-500 focus:border-amber-500 focus:outline-none transition">
        </div>

        <!-- –ö–Ω–æ–ø–∫–∏ -->
        <div class="flex gap-3 pt-4">
          <button id="edit-cancel" class="flex-1 bg-slate-600 hover:bg-slate-500 text-white font-bold py-3 px-6 rounded-xl transition">
            –û—Ç–º–µ–Ω–∞
          </button>
          <button id="edit-save" class="flex-1 bg-gradient-to-r from-amber-500 to-orange-500 hover:from-amber-600 hover:to-orange-600 text-white font-bold py-3 px-6 rounded-xl transition">
            üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
          </button>
        </div>
      </div>
    `;

        overlay.appendChild(modal);
        document.body.appendChild(overlay);

        if (window.lucide) lucide.createIcons();

        // –ó–∞–∫—Ä—ã—Ç–∏–µ
        const closeForm = () => {
          overlay.remove();
        };

        document.getElementById('edit-close').addEventListener('click', closeForm);
        document.getElementById('edit-cancel').addEventListener('click', closeForm);
        overlay.addEventListener('click', (e) => {
          if (e.target === overlay) closeForm();
        });

        // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ
        document.getElementById('edit-save').addEventListener('click', async () => {
          const newName = document.getElementById('edit-name').value.trim();
          if (!newName) {
            App.showToast('‚ùå –í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ!');
            return;
          }

          const basicDesc = document.getElementById('edit-basic-desc').value.trim();
          const basicBonuses = document.getElementById('edit-basic-bonuses').value;
          const basicPrice = parseInt(document.getElementById('edit-basic-price').value) || 50000;

          const optimalDesc = document.getElementById('edit-optimal-desc').value.trim();
          const optimalBonuses = document.getElementById('edit-optimal-bonuses').value;
          const optimalPrice = parseInt(document.getElementById('edit-optimal-price').value) || 75000;

          const premiumDesc = document.getElementById('edit-premium-desc').value.trim();
          const premiumBonuses = document.getElementById('edit-premium-bonuses').value;
          const premiumPrice = parseInt(document.getElementById('edit-premium-price').value) || 120000;

          // –û–±–Ω–æ–≤–ª—è–µ–º —à–∞–±–ª–æ–Ω
          const updatedTemplate = {
            ...tpl,
            name: newName,
            basic: {
              name: newName + ' ‚Äî –ë–∞–∑–æ–≤—ã–π',
              price: basicPrice,
              description: basicDesc,
              bonuses: basicBonuses ? basicBonuses.split(',').map(b => b.trim()).filter(b => b) : []
            },
            optimal: {
              name: newName + ' ‚Äî –û–ø—Ç–∏–º–∞–ª',
              price: optimalPrice,
              description: optimalDesc,
              bonuses: optimalBonuses ? optimalBonuses.split(',').map(b => b.trim()).filter(b => b) : []
            },
            premium: {
              name: newName + ' ‚Äî –ü—Ä–µ–º–∏—É–º',
              price: premiumPrice,
              description: premiumDesc,
              bonuses: premiumBonuses ? premiumBonuses.split(',').map(b => b.trim()).filter(b => b) : []
            }
          };

          // –û–±–Ω–æ–≤–ª—è–µ–º –≤ –∫–æ—Ä–∑–∏–Ω–µ
          State.cart[idx].packageTemplate = updatedTemplate;
          State.cart[idx].name = `–ü–ê–ö–ï–¢: ${newName}`;

          // –°–ø—Ä–∞—à–∏–≤–∞–µ–º, —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –ª–∏ –≤ –±–∞–∑—É
          const saveToDb = await PremiumDialog.confirm({
            message: '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ –±–∞–∑—É —à–∞–±–ª–æ–Ω–æ–≤?\n\n‚úÖ –î–∞ ‚Äî –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω—è—Ç—Å—è –¥–ª—è –±—É–¥—É—â–∏—Ö –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–π\n‚ùå –ù–µ—Ç ‚Äî –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ç–æ–ª—å–∫–æ –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ –ö–ü',
            okText: '–î–∞',
            cancelText: '–ù–µ—Ç',
            icon: 'save'
          });

          if (saveToDb) {
            const dbTemplates = DB.packageTemplates || [];
            const dbIdx = dbTemplates.findIndex(t => t.id === tpl.id);
            if (dbIdx >= 0) {
              // –û–±–Ω–æ–≤–ª—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π
              dbTemplates[dbIdx] = updatedTemplate;
            } else {
              // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–π
              dbTemplates.push(updatedTemplate);
            }
            DB.packageTemplates = dbTemplates;
            Storage.save();
          }

          App.renderCart();
          App.calc();
          App.showToast('‚úÖ –ü–∞–∫–µ—Ç –æ–±–Ω–æ–≤–ª—ë–Ω!');
          closeForm();
        });
      },

      updateLicenseStatus: async () => {
        const statusBadge = document.getElementById('license-status-badge');
        const keyDisplay = document.getElementById('license-key-display');

        if (!statusBadge || !keyDisplay) return;

        try {
          // –ü—Ä–æ–≤–µ—Ä—è–µ–º –µ—Å—Ç—å –ª–∏ —Ñ—É–Ω–∫—Ü–∏—è checkActivation
          if (typeof checkActivation !== 'function') {
            statusBadge.textContent = '‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏';
            statusBadge.className = 'text-sm font-bold text-red-400';
            return;
          }

          const status = await checkActivation();

          if (status === true) {
            // –ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–∞
            statusBadge.textContent = '‚úÖ –ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–∞';
            statusBadge.className = 'text-sm font-bold text-emerald-400';

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–∞–º–∞—Å–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∫–ª—é—á
            const stored = localStorage.getItem('illusionist_license');
            if (stored) {
              try {
                const data = JSON.parse(atob(stored));
                const key = data.key || '';
                const parts = key.split('-');
                if (parts.length === 4) {
                  keyDisplay.textContent = `${parts[0]}-${parts[1]}-‚Ä¢‚Ä¢‚Ä¢‚Ä¢-‚Ä¢‚Ä¢‚Ä¢‚Ä¢`;
                } else {
                  keyDisplay.textContent = '‚Ä¢‚Ä¢‚Ä¢‚Ä¢-‚Ä¢‚Ä¢‚Ä¢‚Ä¢-‚Ä¢‚Ä¢‚Ä¢‚Ä¢-‚Ä¢‚Ä¢‚Ä¢‚Ä¢';
                }
              } catch (e) {
                keyDisplay.textContent = '‚Ä¢‚Ä¢‚Ä¢‚Ä¢-‚Ä¢‚Ä¢‚Ä¢‚Ä¢-‚Ä¢‚Ä¢‚Ä¢‚Ä¢-‚Ä¢‚Ä¢‚Ä¢‚Ä¢';
              }
            }
          } else if (status === 'expired') {
            // –ò—Å—Ç–µ–∫–ª–∞
            statusBadge.textContent = '‚è∞ –ò—Å—Ç–µ–∫–ª–∞';
            statusBadge.className = 'text-sm font-bold text-orange-400';
            keyDisplay.textContent = '–¢—Ä–µ–±—É–µ—Ç—Å—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ';
          } else {
            // –ù–µ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–∞
            statusBadge.textContent = '‚ùå –ù–µ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–∞';
            statusBadge.className = 'text-sm font-bold text-red-400';
            keyDisplay.textContent = '–¢—Ä–µ–±—É–µ—Ç—Å—è –∞–∫—Ç–∏–≤–∞—Ü–∏—è';
          }
        } catch (e) {
          statusBadge.textContent = '‚ö†Ô∏è –û—à–∏–±–∫–∞';
          statusBadge.className = 'text-sm font-bold text-red-400';
        }
      },

      renderParticles: () => {
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫—É –∞–Ω–∏–º–∞—Ü–∏–∏ —Ñ–æ–Ω–∞
        if (DB.config && DB.config.enableBackgroundAnimation === false) return;

        const canvas = document.getElementById('bg-canvas');
        if (!canvas) return;
        const ctx = canvas.getContext('2d');
        if (!ctx) return;

        let particles = [];
        const resize = () => {
          canvas.width = window.innerWidth;
          canvas.height = window.innerHeight;
        };
        window.addEventListener('resize', Utils.throttle(resize, 250));
        resize();

        for (let i = 0; i < 40; i++) {
          particles.push({
            x: Math.random() * canvas.width,
            y: Math.random() * canvas.height,
            r: Math.random() * 2,
            d: Math.random() * Math.PI * 2,
            s: Math.random() * 0.5 + 0.1,
            c: Math.random() > 0.5 ? '#f59e0b' : '#64748b'
          });
        }

        function animate() {
          ctx.clearRect(0, 0, canvas.width, canvas.height);
          particles.forEach(p => {
            p.x += Math.cos(p.d) * p.s;
            p.y += Math.sin(p.d) * p.s;

            if (p.x < 0) p.x = canvas.width;
            if (p.x > canvas.width) p.x = 0;
            if (p.y < 0) p.y = canvas.height;
            if (p.y > canvas.height) p.y = 0;

            ctx.beginPath();
            ctx.arc(p.x, p.y, p.r, 0, Math.PI * 2);
            ctx.fillStyle = p.c;
            ctx.globalAlpha = 0.3;
            ctx.fill();
          });
          requestAnimationFrame(animate);
        }
        animate();
      }
    };

    // ============================================
    // ADMIN
    // ============================================
    const Admin = {
      render: () => {
        try {
          Admin.renderPersonalInfo();
          Admin.renderTravel();
          Admin.renderServices();
          Admin.renderHolidays();
          Admin.renderRanges();
          Admin.renderBonuses();
          Admin.renderPayments();
          Admin.renderLinks();
          if (window.lucide) lucide.createIcons();
          DataManager.updateStats();
        } catch (err) {
        }
      },

      renderPersonalInfo: () => {
        const input = document.getElementById('personal-name');
        if (!input) return;

        input.value = DB.config?.personalName || '';

        input.addEventListener('input', Utils.debounce(() => {
          if (!DB.config) DB.config = {};
          DB.config.personalName = Utils.sanitizeText(input.value, 100);
          Storage.save();
        }, 500));
      },

      toggleSection: (headerElement) => {
        if (!headerElement) return;
        const content = headerElement.nextElementSibling;
        const icon = headerElement.querySelector('i');
        if (content) content.classList.toggle('open');
        if (icon) {
          icon.style.transform = content && content.classList.contains('open') ? 'rotate(180deg)' : 'rotate(0)';
        }
      },

      // ... (–ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ Admin –º–µ—Ç–æ–¥–æ–≤ –≤ —Å–ª–µ–¥—É—é—â–µ–π —á–∞—Å—Ç–∏)
    };

    // ============================================
    // BOOT
    // ============================================
    document.addEventListener('DOMContentLoaded', () => {
      App.init();
      // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞–∫–æ–ø–ª–µ–Ω–Ω—É—é –æ—á–µ—Ä–µ–¥—å —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
      setTimeout(() => App._processSyncQueue(), 3000);
    });




    /* === Inlined from admin.js === */
    /* ============================================
       ILLUSIONIST OS - ADMIN.JS
       –ú–µ—Ç–æ–¥—ã –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
       ============================================ */

    // –ü—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ Admin –æ–±—ä–µ–∫—Ç–∞
    Object.assign(Admin, {
      // ========== TRAVEL (–õ–û–ì–ò–°–¢–ò–ö–ê) ==========
      renderTravel: () => {
        const container = document.getElementById('settings-travel-list');
        if (!container) return;

        Utils.clearElement(container);

        if (!DB.travel || !Utils.isValidObject(DB.travel)) {
          container.textContent = '–ù–µ—Ç —Ä–µ–≥–∏–æ–Ω–æ–≤';
          return;
        }

        Object.keys(DB.travel).sort().forEach(region => {
          const regionData = DB.travel[region];
          if (!Utils.isValidObject(regionData)) return;

          const wrapper = Utils.createElement('div', 'bg-white/5 rounded-xl p-4 mb-3');

          const header = Utils.createElement('div', 'admin-header');
          header.addEventListener('click', function () {
            Admin.toggleSection(this);
          });

          const titleSpan = Utils.createElement('span', 'font-bold text-base text-amber-500');
          titleSpan.textContent = region;

          const iconEl = document.createElement('i');
          iconEl.setAttribute('data-lucide', 'chevron-down');
          iconEl.className = 'w-5 h-5 text-slate-500 transition-transform';

          header.appendChild(titleSpan);
          header.appendChild(iconEl);

          const content = Utils.createElement('div', 'admin-content');

          const feeRow = Admin.createFeeRow(region, regionData.fee || 0);
          content.appendChild(feeRow);

          if (Utils.isValidObject(regionData.cities)) {
            Object.keys(regionData.cities).sort().forEach(city => {
              const cityRow = Admin.createCityRow(region, city, regionData.cities[city]);
              content.appendChild(cityRow);
            });
          }

          const addCityBtn = Utils.createElement('button', 'btn-add mt-3 text-sm', '+ –ì–æ—Ä–æ–¥');
          addCityBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            Admin.addCity(region);
          });
          content.appendChild(addCityBtn);

          // –ö–Ω–æ–ø–∫–∞ –º–∞—Å—Å–æ–≤–æ–≥–æ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è
          const addCitiesBulkBtn = Utils.createElement('button', 'btn-secondary mt-2 text-sm w-full', '+ –î–æ–±–∞–≤–∏—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –≥–æ—Ä–æ–¥–æ–≤');
          addCitiesBulkBtn.innerHTML = '<i data-lucide="list-plus" class="w-4 h-4 inline mr-2"></i>–î–æ–±–∞–≤–∏—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –≥–æ—Ä–æ–¥–æ–≤';
          addCitiesBulkBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            Admin.addCitiesBulk(region);
          });
          content.appendChild(addCitiesBulkBtn);
          lucide.createIcons();

          const delRegionBtn = Utils.createElement(
            'button',
            'text-xs text-red-400 mt-4 w-full text-right opacity-60 hover:opacity-100 transition',
            '–£–¥–∞–ª–∏—Ç—å —Ä–µ–≥–∏–æ–Ω'
          );
          delRegionBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            Admin.delRegion(region);
          });
          content.appendChild(delRegionBtn);

          wrapper.appendChild(header);
          wrapper.appendChild(content);
          container.appendChild(wrapper);
        });
      },

      createFeeRow: (region, fee) => {
        const row = Utils.createElement('div', 'edit-row mb-4 pb-4 border-b border-white/5');
        const label = Utils.createElement('span', 'text-sm text-slate-400 flex-shrink-0 w-24', '–ë–∞–∑–∞:');
        const input = Utils.createElement('input', 'edit-input w-32 text-right mono');
        input.type = 'number';
        input.value = fee;
        input.min = '0';
        input.addEventListener('change', () => Admin.setRegionFee(region, input.value));
        row.appendChild(label);
        row.appendChild(input);
        return row;
      },

      createCityRow: (region, city, price) => {
        const row = Utils.createElement('div', 'edit-row ml-4');

        const nameInput = Utils.createElement('input', 'edit-input flex-1');
        nameInput.value = city;
        nameInput.maxLength = 100;
        nameInput.addEventListener('change', () => {
          const newName = Utils.sanitizeText(nameInput.value, 100);
          if (newName && newName !== city) Admin.renameCity(region, city, newName);
          else nameInput.value = city;
        });

        const priceInput = Utils.createElement('input', 'edit-input w-32 text-right mono');
        priceInput.type = 'number';
        priceInput.value = price;
        priceInput.min = '0';
        priceInput.addEventListener('change', () => Admin.setCityPrice(region, city, priceInput.value));

        const delBtn = Utils.createElement('button', 'btn-del-mini');
        delBtn.innerHTML = '<i data-lucide="trash-2" class="w-5 h-5"></i>';
        delBtn.addEventListener('click', () => Admin.delCity(region, city));

        row.appendChild(nameInput);
        row.appendChild(priceInput);
        row.appendChild(delBtn);
        return row;
      },

      addRegion: async () => {
        const name = await PremiumDialog.prompt({ title: '–ù–∞–∑–≤–∞–Ω–∏–µ —Ä–µ–≥–∏–æ–Ω–∞:', defaultValue: '', okText: '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å', cancelText: '–û—Ç–º–µ–Ω–∞', icon: 'edit-3' });
        if (!name) return;

        const sanitized = Utils.sanitizeText(name, 100);
        if (!sanitized) {
          App.showToast('–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –∏–º—è');
          return;
        }
        if (DB.travel[sanitized]) {
          App.showToast('–†–µ–≥–∏–æ–Ω —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç');
          return;
        }

        DB.travel[sanitized] = { fee: 0, cities: {} };
        Storage.save();
        Admin.render();
        App.updateUI();
      },

      delRegion: async (region) => {
        if (!(await PremiumDialog.confirm({ message: `–£–¥–∞–ª–∏—Ç—å —Ä–µ–≥–∏–æ–Ω "${region}"?`, danger: true, okText: '–î–∞', cancelText: '–û—Ç–º–µ–Ω–∞', icon: 'shield-alert' }))) return;
        delete DB.travel[region];
        Storage.save();
        Admin.render();
        App.updateUI();
      },

      setRegionFee: (region, value) => {
        if (!DB.travel[region]) return;
        DB.travel[region].fee = Utils.sanitizeNumber(value, 0);
        Storage.save();
      },

      addCity: async (region) => {
        if (!DB.travel[region]) return;
        const name = await PremiumDialog.prompt({ title: '–ù–∞–∑–≤–∞–Ω–∏–µ –≥–æ—Ä–æ–¥–∞:', defaultValue: '', okText: '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å', cancelText: '–û—Ç–º–µ–Ω–∞', icon: 'edit-3' });
        if (!name) return;

        const sanitized = Utils.sanitizeText(name, 100);
        if (!sanitized) {
          App.showToast('–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –∏–º—è');
          return;
        }

        DB.travel[region].cities[sanitized] = 0;
        Storage.save();
        Admin.render();
        App.updateUI();
      },

      // –ú–∞—Å—Å–æ–≤–æ–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –≥–æ—Ä–æ–¥–æ–≤
      addCitiesBulk: async (region) => {
        if (!DB.travel[region]) return;

        // –°–æ–∑–¥–∞—ë–º –º–æ–¥–∞–ª–∫—É –¥–ª—è –º–∞—Å—Å–æ–≤–æ–≥–æ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è
        const modal = document.createElement('div');
        modal.className = 'fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center z-50 p-4';
        modal.innerHTML = `
      <div class="glass rounded-3xl p-6 w-full max-w-2xl max-h-[80vh] overflow-y-auto">
        <div class="flex items-center justify-between mb-6">
          <div class="flex items-center gap-3">
            <div class="w-10 h-10 rounded-xl bg-amber-500/10 flex items-center justify-center">
              <i data-lucide="map-pin" class="w-5 h-5 text-amber-400"></i>
            </div>
            <div>
              <h3 class="text-lg font-bold text-white">–î–æ–±–∞–≤–∏—Ç—å –≥–æ—Ä–æ–¥–∞</h3>
              <p class="text-sm text-slate-400">–†–µ–≥–∏–æ–Ω: ${Utils.escapeHtml(region)}</p>
            </div>
          </div>
          <button class="btn-icon" data-action="close">
            <i data-lucide="x" class="w-5 h-5"></i>
          </button>
        </div>
        
        <div id="bulk-cities-list" class="space-y-3 mb-4"></div>
        
        <div class="flex gap-3">
          <button class="btn-secondary flex-1" data-action="add-row">
            <i data-lucide="plus" class="w-4 h-4"></i>
            –î–æ–±–∞–≤–∏—Ç—å –µ—â—ë
          </button>
          <button class="btn-gold flex-1" data-action="save">
            <i data-lucide="check" class="w-4 h-4"></i>
            –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤—Å–µ
          </button>
        </div>
      </div>
    `;

        document.body.appendChild(modal);
        lucide.createIcons();

        const list = modal.querySelector('#bulk-cities-list');
        let rowIndex = 0;

        // –§—É–Ω–∫—Ü–∏—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Å—Ç—Ä–æ–∫–∏
        const addRow = () => {
          const row = document.createElement('div');
          row.className = 'glass-level-1 rounded-xl p-3 flex gap-3 items-center';
          row.dataset.index = rowIndex++;
          row.innerHTML = `
        <div class="flex-1 grid grid-cols-2 gap-3">
          <input 
            type="text" 
            class="form-input" 
            placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –≥–æ—Ä–æ–¥–∞"
            data-field="name"
          />
          <input 
            type="number" 
            class="form-input" 
            placeholder="–¶–µ–Ω–∞ (‚ÇΩ)"
            min="0"
            step="100"
            value="0"
            data-field="price"
          />
        </div>
        <button class="btn-icon text-red-400 hover:bg-red-500/10" data-action="remove-row">
          <i data-lucide="trash-2" class="w-4 h-4"></i>
        </button>
      `;
          list.appendChild(row);
          lucide.createIcons();

          // –§–æ–∫—É—Å –Ω–∞ –ø–µ—Ä–≤—ã–π input
          row.querySelector('input[data-field="name"]').focus();
        };

        // –î–æ–±–∞–≤–ª—è–µ–º –ø–µ—Ä–≤—É—é —Å—Ç—Ä–æ–∫—É
        addRow();

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
        modal.addEventListener('click', (e) => {
          const btn = e.target.closest('button');
          if (!btn) return;

          const action = btn.dataset.action;

          if (action === 'close') {
            modal.remove();
          }

          if (action === 'add-row') {
            addRow();
          }

          if (action === 'remove-row') {
            const row = btn.closest('[data-index]');
            if (list.children.length > 1) {
              row.remove();
            } else {
              App.showToast('–î–æ–ª–∂–Ω–∞ –æ—Å—Ç–∞—Ç—å—Å—è —Ö–æ—Ç—è –±—ã –æ–¥–Ω–∞ —Å—Ç—Ä–æ–∫–∞');
            }
          }

          if (action === 'save') {
            const rows = list.querySelectorAll('[data-index]');
            let added = 0;

            rows.forEach(row => {
              const nameInput = row.querySelector('input[data-field="name"]');
              const priceInput = row.querySelector('input[data-field="price"]');

              const name = Utils.sanitizeText(nameInput.value.trim(), 100);
              const price = Utils.sanitizeNumber(priceInput.value, 0, 999999);

              if (name) {
                DB.travel[region].cities[name] = price;
                added++;
              }
            });

            if (added > 0) {
              Storage.save();
              Admin.render();
              App.updateUI();
              App.showToast(`‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–æ –≥–æ—Ä–æ–¥–æ–≤: ${added}`);
              modal.remove();
            } else {
              App.showToast('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω –≥–æ—Ä–æ–¥');
            }
          }
        });

        // Enter = –¥–æ–±–∞–≤–∏—Ç—å —Å—Ç—Ä–æ–∫—É
        list.addEventListener('keydown', (e) => {
          if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            addRow();
          }
        });
      },

      delCity: (region, city) => {
        if (!DB.travel[region] || !DB.travel[region].cities) return;
        delete DB.travel[region].cities[city];
        Storage.save();
        Admin.render();
        App.updateUI();
      },

      renameCity: (region, oldName, newName) => {
        if (!DB.travel[region] || !DB.travel[region].cities) return;
        if (oldName === newName) return;
        const price = DB.travel[region].cities[oldName];
        delete DB.travel[region].cities[oldName];
        DB.travel[region].cities[newName] = price;
        Storage.save();
        Admin.render();
        App.updateUI();
      },

      setCityPrice: (region, city, value) => {
        if (!DB.travel[region] || !DB.travel[region].cities) return;
        DB.travel[region].cities[city] = Utils.sanitizeNumber(value, 0);
        Storage.save();
      },

      // ========== SERVICES (–£–°–õ–£–ì–ò) ==========
      renderServices: () => {
        const container = document.getElementById('settings-services-list');
        if (!container) return;

        Utils.clearElement(container);

        if (!DB.services || !Utils.isValidObject(DB.services)) {
          container.textContent = '–ù–µ—Ç –∫–∞—Ç–µ–≥–æ—Ä–∏–π';
          return;
        }

        Object.keys(DB.services).sort().forEach(category => {
          const services = DB.services[category];
          if (!Utils.isValidObject(services)) return;

          const wrapper = Utils.createElement('div', 'bg-white/5 rounded-xl p-4 mb-3');

          const header = Utils.createElement('div', 'admin-header');
          header.addEventListener('click', function () {
            Admin.toggleSection(this);
          });

          const titleSpan = Utils.createElement('span', 'font-bold text-base text-purple-400');
          titleSpan.textContent = category;

          const iconEl = document.createElement('i');
          iconEl.setAttribute('data-lucide', 'chevron-down');
          iconEl.className = 'w-5 h-5 text-slate-500 transition-transform';

          header.appendChild(titleSpan);
          header.appendChild(iconEl);

          const content = Utils.createElement('div', 'admin-content');

          Object.keys(services).sort().forEach(service => {
            const serviceRow = Admin.createServiceRow(category, service, services[service]);
            content.appendChild(serviceRow);
          });

          const addSvcBtn = Utils.createElement('button', 'btn-add mt-3 text-sm', '+ –£—Å–ª—É–≥–∞');
          addSvcBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            Admin.addSvc(category);
          });
          content.appendChild(addSvcBtn);

          // –ö–Ω–æ–ø–∫–∞ –º–∞—Å—Å–æ–≤–æ–≥–æ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è
          const addServicesBulkBtn = Utils.createElement('button', 'btn-secondary mt-2 text-sm w-full', '+ –î–æ–±–∞–≤–∏—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ —É—Å–ª—É–≥');
          addServicesBulkBtn.innerHTML = '<i data-lucide="list-plus" class="w-4 h-4 inline mr-2"></i>–î–æ–±–∞–≤–∏—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ —É—Å–ª—É–≥';
          addServicesBulkBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            Admin.addServicesBulk(category);
          });
          content.appendChild(addServicesBulkBtn);
          lucide.createIcons();

          const delCatBtn = Utils.createElement(
            'button',
            'text-xs text-red-400 mt-4 w-full text-right opacity-60 hover:opacity-100 transition',
            '–£–¥–∞–ª–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é'
          );
          delCatBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            Admin.delCat(category);
          });
          content.appendChild(delCatBtn);

          wrapper.appendChild(header);
          wrapper.appendChild(content);
          container.appendChild(wrapper);
        });
      },

      createServiceRow: (category, service, serviceData) => {
        // –ü–æ–¥–¥–µ—Ä–∂–∫–∞ —Å—Ç–∞—Ä–æ–≥–æ —Ñ–æ—Ä–º–∞—Ç–∞ (—á–∏—Å–ª–æ) –∏ –Ω–æ–≤–æ–≥–æ (–æ–±—ä–µ–∫—Ç)
        const price = typeof serviceData === 'number' ? serviceData : (serviceData?.price || 0);
        const description = typeof serviceData === 'object' ? (serviceData?.description || '') : '';

        const wrapper = Utils.createElement('div', 'mb-3 ml-4');

        const row = Utils.createElement('div', 'edit-row');

        const nameInput = Utils.createElement('input', 'edit-input flex-1');
        nameInput.placeholder = '–ù–∞–∑–≤–∞–Ω–∏–µ —É—Å–ª—É–≥–∏';
        nameInput.value = service;
        nameInput.maxLength = 200;
        nameInput.addEventListener('change', () => {
          const newName = Utils.sanitizeText(nameInput.value, 200);
          if (newName && newName !== service) Admin.renameSvc(category, service, newName);
          else nameInput.value = service;
        });

        const priceInput = Utils.createElement('input', 'edit-input w-32 text-right mono');
        priceInput.type = 'number';
        priceInput.placeholder = '–¶–µ–Ω–∞';
        priceInput.value = price;
        priceInput.min = '0';
        priceInput.addEventListener('change', () => Admin.setSvcPrice(category, service, priceInput.value));

        const delBtn = Utils.createElement('button', 'btn-del-mini');
        delBtn.innerHTML = '<i data-lucide="trash-2" class="w-5 h-5"></i>';
        delBtn.addEventListener('click', () => Admin.delSvc(category, service));

        row.appendChild(nameInput);
        row.appendChild(priceInput);
        row.appendChild(delBtn);

        // –ü–æ–ª–µ –æ–ø–∏—Å–∞–Ω–∏—è
        const descRow = Utils.createElement('div', 'mt-2');
        const descTextarea = Utils.createElement('textarea', 'edit-input w-full');
        descTextarea.placeholder = '–û–ø–∏—Å–∞–Ω–∏–µ —É—Å–ª—É–≥–∏ (–±—É–¥–µ—Ç –ø–æ–∫–∞–∑–∞–Ω–æ –≤ –ö–ü)';
        descTextarea.value = description;
        descTextarea.rows = 2;
        descTextarea.maxLength = 500;
        descTextarea.style.resize = 'vertical';
        descTextarea.style.minHeight = '60px';
        descTextarea.addEventListener('change', () => {
          const newDesc = Utils.sanitizeText(descTextarea.value, 500);
          Admin.setSvcDescription(category, service, newDesc);
        });

        descRow.appendChild(descTextarea);

        wrapper.appendChild(row);
        wrapper.appendChild(descRow);

        return wrapper;
      },

      addCategory: async () => {
        const name = await PremiumDialog.prompt({ title: '–ù–∞–∑–≤–∞–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏:', defaultValue: '', okText: '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å', cancelText: '–û—Ç–º–µ–Ω–∞', icon: 'edit-3' });
        if (!name) return;

        const sanitized = Utils.sanitizeText(name, 100);
        if (!sanitized) {
          App.showToast('–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –∏–º—è');
          return;
        }
        if (DB.services[sanitized]) {
          App.showToast('–ö–∞—Ç–µ–≥–æ—Ä–∏—è —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç');
          return;
        }

        DB.services[sanitized] = {};
        Storage.save();
        Admin.render();
        App.updateUI();
      },

      delCat: async (category) => {
        if (!(await PremiumDialog.confirm({ message: `–£–¥–∞–ª–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é "${category}"?`, danger: true, okText: '–î–∞', cancelText: '–û—Ç–º–µ–Ω–∞', icon: 'shield-alert' }))) return;
        delete DB.services[category];
        Storage.save();
        Admin.render();
        App.updateUI();
      },

      addSvc: async (category) => {
        if (!DB.services[category]) return;
        const name = await PremiumDialog.prompt({ title: '–ù–∞–∑–≤–∞–Ω–∏–µ —É—Å–ª—É–≥–∏:', defaultValue: '', okText: '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å', cancelText: '–û—Ç–º–µ–Ω–∞', icon: 'edit-3' });
        if (!name) return;

        const sanitized = Utils.sanitizeText(name, 200);
        if (!sanitized) {
          App.showToast('–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –∏–º—è');
          return;
        }

        DB.services[category][sanitized] = 0;
        Storage.save();
        Admin.render();
        App.updateUI();
      },

      // –ú–∞—Å—Å–æ–≤–æ–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ —É—Å–ª—É–≥
      addServicesBulk: async (category) => {
        if (!DB.services[category]) return;

        // –°–æ–∑–¥–∞—ë–º –º–æ–¥–∞–ª–∫—É –¥–ª—è –º–∞—Å—Å–æ–≤–æ–≥–æ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è
        const modal = document.createElement('div');
        modal.className = 'fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center z-50 p-4';
        modal.innerHTML = `
      <div class="glass rounded-3xl p-6 w-full max-w-2xl max-h-[80vh] overflow-y-auto">
        <div class="flex items-center justify-between mb-6">
          <div class="flex items-center gap-3">
            <div class="w-10 h-10 rounded-xl bg-purple-500/10 flex items-center justify-center">
              <i data-lucide="sparkles" class="w-5 h-5 text-purple-400"></i>
            </div>
            <div>
              <h3 class="text-lg font-bold text-white">–î–æ–±–∞–≤–∏—Ç—å —É—Å–ª—É–≥–∏</h3>
              <p class="text-sm text-slate-400">–ö–∞—Ç–µ–≥–æ—Ä–∏—è: ${Utils.escapeHtml(category)}</p>
            </div>
          </div>
          <button class="btn-icon" data-action="close">
            <i data-lucide="x" class="w-5 h-5"></i>
          </button>
        </div>
        
        <div id="bulk-services-list" class="space-y-3 mb-4"></div>
        
        <div class="flex gap-3">
          <button class="btn-secondary flex-1" data-action="add-row">
            <i data-lucide="plus" class="w-4 h-4"></i>
            –î–æ–±–∞–≤–∏—Ç—å –µ—â—ë
          </button>
          <button class="btn-gold flex-1" data-action="save">
            <i data-lucide="check" class="w-4 h-4"></i>
            –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤—Å–µ
          </button>
        </div>
      </div>
    `;

        document.body.appendChild(modal);
        lucide.createIcons();

        const list = modal.querySelector('#bulk-services-list');
        let rowIndex = 0;

        // –§—É–Ω–∫—Ü–∏—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Å—Ç—Ä–æ–∫–∏
        const addRow = () => {
          const row = document.createElement('div');
          row.className = 'glass-level-1 rounded-xl p-3 flex gap-3 items-center';
          row.dataset.index = rowIndex++;
          row.innerHTML = `
        <div class="flex-1 grid grid-cols-2 gap-3">
          <input 
            type="text" 
            class="form-input" 
            placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —É—Å–ª—É–≥–∏"
            data-field="name"
          />
          <input 
            type="number" 
            class="form-input" 
            placeholder="–¶–µ–Ω–∞ (‚ÇΩ)"
            min="0"
            step="100"
            value="0"
            data-field="price"
          />
        </div>
        <button class="btn-icon text-red-400 hover:bg-red-500/10" data-action="remove-row">
          <i data-lucide="trash-2" class="w-4 h-4"></i>
        </button>
      `;
          list.appendChild(row);
          lucide.createIcons();

          // –§–æ–∫—É—Å –Ω–∞ –ø–µ—Ä–≤—ã–π input
          row.querySelector('input[data-field="name"]').focus();
        };

        // –î–æ–±–∞–≤–ª—è–µ–º –ø–µ—Ä–≤—É—é —Å—Ç—Ä–æ–∫—É
        addRow();

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
        modal.addEventListener('click', (e) => {
          const btn = e.target.closest('button');
          if (!btn) return;

          const action = btn.dataset.action;

          if (action === 'close') {
            modal.remove();
          }

          if (action === 'add-row') {
            addRow();
          }

          if (action === 'remove-row') {
            const row = btn.closest('[data-index]');
            if (list.children.length > 1) {
              row.remove();
            } else {
              App.showToast('–î–æ–ª–∂–Ω–∞ –æ—Å—Ç–∞—Ç—å—Å—è —Ö–æ—Ç—è –±—ã –æ–¥–Ω–∞ —Å—Ç—Ä–æ–∫–∞');
            }
          }

          if (action === 'save') {
            const rows = list.querySelectorAll('[data-index]');
            let added = 0;

            rows.forEach(row => {
              const nameInput = row.querySelector('input[data-field="name"]');
              const priceInput = row.querySelector('input[data-field="price"]');

              const name = Utils.sanitizeText(nameInput.value.trim(), 200);
              const price = Utils.sanitizeNumber(priceInput.value, 0, 999999);

              if (name) {
                DB.services[category][name] = price;
                added++;
              }
            });

            if (added > 0) {
              Storage.save();
              Admin.render();
              App.updateUI();
              App.showToast(`‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–æ —É—Å–ª—É–≥: ${added}`);
              modal.remove();
            } else {
              App.showToast('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω—É —É—Å–ª—É–≥—É');
            }
          }
        });

        // Enter = –¥–æ–±–∞–≤–∏—Ç—å —Å—Ç—Ä–æ–∫—É
        list.addEventListener('keydown', (e) => {
          if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            addRow();
          }
        });
      },

      delSvc: (category, service) => {
        if (!DB.services[category]) return;
        delete DB.services[category][service];
        Storage.save();
        Admin.render();
        App.updateUI();
      },

      renameSvc: (category, oldName, newName) => {
        if (!DB.services[category]) return;
        if (oldName === newName) return;
        const price = DB.services[category][oldName];
        delete DB.services[category][oldName];
        DB.services[category][newName] = price;
        Storage.save();
        Admin.render();
        App.updateUI();
      },

      setSvcPrice: (category, service, value) => {
        if (!DB.services[category]) return;

        const currentData = DB.services[category][service];
        const price = Utils.sanitizeNumber(value, 0);

        // –ï—Å–ª–∏ –¥–∞–Ω–Ω—ã–µ —É–∂–µ –æ–±—ä–µ–∫—Ç - –æ–±–Ω–æ–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ —Ü–µ–Ω—É
        if (typeof currentData === 'object' && currentData !== null) {
          DB.services[category][service].price = price;
        } else {
          // –ï—Å–ª–∏ –±—ã–ª–æ —á–∏—Å–ª–æ - —Å–æ–∑–¥–∞—ë–º –æ–±—ä–µ–∫—Ç —Å —Ü–µ–Ω–æ–π –∏ –ø—É—Å—Ç—ã–º –æ–ø–∏—Å–∞–Ω–∏–µ–º
          DB.services[category][service] = { price: price, description: '' };
        }

        Storage.save();
      },

      setSvcDescription: (category, service, description) => {
        if (!DB.services[category]) return;

        const currentData = DB.services[category][service];
        const desc = Utils.sanitizeText(description, 500);

        // –ï—Å–ª–∏ –¥–∞–Ω–Ω—ã–µ —É–∂–µ –æ–±—ä–µ–∫—Ç - –æ–±–Ω–æ–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –æ–ø–∏—Å–∞–Ω–∏–µ
        if (typeof currentData === 'object' && currentData !== null) {
          DB.services[category][service].description = desc;
        } else {
          // –ï—Å–ª–∏ –±—ã–ª–æ —á–∏—Å–ª–æ - —Å–æ–∑–¥–∞—ë–º –æ–±—ä–µ–∫—Ç —Å —Ç–µ–∫—É—â–µ–π —Ü–µ–Ω–æ–π –∏ –Ω–æ–≤—ã–º –æ–ø–∏—Å–∞–Ω–∏–µ–º
          const price = typeof currentData === 'number' ? currentData : 0;
          DB.services[category][service] = { price: price, description: desc };
        }

        Storage.save();
      },

      // ========== HOLIDAYS (–ü–†–ê–ó–î–ù–ò–ö–ò) ==========
      renderHolidays: () => {
        const container = document.getElementById('settings-holidays-list');
        if (!container) return;

        Utils.clearElement(container);

        if (!DB.holidays || !Utils.isValidObject(DB.holidays)) {
          container.textContent = '–ù–µ—Ç –ø—Ä–∞–∑–¥–Ω–∏—á–Ω—ã—Ö –¥–∞—Ç';
          return;
        }

        Object.keys(DB.holidays).sort().forEach(key => {
          container.appendChild(Admin.createHolidayRow(key, DB.holidays[key]));
        });
      },

      createHolidayRow: (key, value) => {
        const row = Utils.createElement('div', 'edit-row');

        const keyInput = Utils.createElement('input', 'edit-input w-32 text-center mono');
        keyInput.value = key;
        keyInput.placeholder = 'MM-DD';
        keyInput.maxLength = 5;
        keyInput.addEventListener('change', () => {
          const newKey = keyInput.value.trim();
          if (Utils.validateDateKey(newKey) && newKey !== key) {
            Admin.updateHolidayKey(key, newKey);
          } else {
            keyInput.value = key;
            if (!Utils.validateDateKey(newKey)) {
              Utils.validateInput(keyInput, () => false);
              App.showToast('–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –¥–∞—Ç—ã (MM-DD)');
            }
          }
        });

        const valInput = Utils.createElement('input', 'edit-input w-28 text-center text-amber-400 font-extrabold mono');
        valInput.type = 'number';
        valInput.value = value;
        valInput.min = '1';
        valInput.max = '10';
        valInput.step = '0.1';
        valInput.addEventListener('change', () => Admin.updateHolidayVal(key, valInput.value));

        const delBtn = Utils.createElement('button', 'btn-del-mini');
        delBtn.innerHTML = '<i data-lucide="trash-2" class="w-5 h-5"></i>';
        delBtn.addEventListener('click', () => Admin.delHoliday(key));

        row.appendChild(keyInput);
        row.appendChild(valInput);
        row.appendChild(delBtn);
        return row;
      },

      addHoliday: async () => {
        const date = await PremiumDialog.prompt({ title: '–î–∞—Ç–∞ (–ú–ú-–î–î):', defaultValue: '12-31', okText: '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å', cancelText: '–û—Ç–º–µ–Ω–∞', icon: 'edit-3' });
        if (!date) return;
        if (!Utils.validateDateKey(date)) {
          App.showToast('–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –¥–∞—Ç—ã (MM-DD)');
          return;
        }
        DB.holidays[date] = 1.5;
        Storage.save();
        Admin.render();
      },

      delHoliday: (key) => {
        delete DB.holidays[key];
        Storage.save();
        Admin.render();
      },

      updateHolidayKey: (oldKey, newKey) => {
        const value = DB.holidays[oldKey];
        delete DB.holidays[oldKey];
        DB.holidays[newKey] = value;
        Storage.save();
        Admin.render();
      },

      updateHolidayVal: (key, value) => {
        DB.holidays[key] = Utils.sanitizeFloat(value, 1, 10);
        Storage.save();
      },

      // ========== HOLIDAY RANGES (–ü–ï–†–ò–û–î–´) ==========
      renderRanges: () => {
        const container = document.getElementById('settings-ranges-list');
        if (!container) return;

        Utils.clearElement(container);

        if (!DB.holidayRanges || !Array.isArray(DB.holidayRanges) || DB.holidayRanges.length === 0) {
          container.textContent = '–ù–µ—Ç –ø–µ—Ä–∏–æ–¥–æ–≤';
          return;
        }

        DB.holidayRanges.forEach((range, index) => {
          container.appendChild(Admin.createRangeRow(range, index));
        });
      },

      createRangeRow: (range, index) => {
        const row = Utils.createElement('div', 'edit-row');

        const start = `${String(range.sm || 12).padStart(2, '0')}-${String(range.sd || 1).padStart(2, '0')}`;
        const end = `${String(range.em || 12).padStart(2, '0')}-${String(range.ed || 31).padStart(2, '0')}`;

        const startInput = Utils.createElement('input', 'edit-input w-28 text-center text-sm mono');
        startInput.value = start;
        startInput.maxLength = 5;
        startInput.addEventListener('change', () => Admin.updateRange(index, 'start', startInput.value));

        const arrow = Utils.createElement('span', 'text-slate-500 text-lg', '‚Üí');

        const endInput = Utils.createElement('input', 'edit-input w-28 text-center text-sm mono');
        endInput.value = end;
        endInput.maxLength = 5;
        endInput.addEventListener('change', () => Admin.updateRange(index, 'end', endInput.value));

        const kInput = Utils.createElement('input', 'edit-input w-24 text-center text-amber-400 font-extrabold mono');
        kInput.type = 'number';
        kInput.value = range.k || 1.5;
        kInput.min = '1';
        kInput.max = '10';
        kInput.step = '0.1';
        kInput.addEventListener('change', () => Admin.updateRange(index, 'k', kInput.value));

        const delBtn = Utils.createElement('button', 'btn-del-mini');
        delBtn.innerHTML = '<i data-lucide="trash-2" class="w-5 h-5"></i>';
        delBtn.addEventListener('click', () => Admin.delRange(index));

        row.appendChild(startInput);
        row.appendChild(arrow);
        row.appendChild(endInput);
        row.appendChild(kInput);
        row.appendChild(delBtn);
        return row;
      },

      addRange: async () => {
        const start = await PremiumDialog.prompt({ title: '–°—Ç–∞—Ä—Ç –ø–µ—Ä–∏–æ–¥–∞ (–ú–ú-–î–î):', defaultValue: '12-20', okText: '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å', cancelText: '–û—Ç–º–µ–Ω–∞', icon: 'edit-3' });
        if (!start) return;
        if (!Utils.validateDateKey(start)) {
          App.showToast('–ù–µ–≤–µ—Ä–Ω—ã–π —Å—Ç–∞—Ä—Ç (MM-DD)');
          return;
        }

        const end = await PremiumDialog.prompt({ title: '–ö–æ–Ω–µ—Ü –ø–µ—Ä–∏–æ–¥–∞ (–ú–ú-–î–î):', defaultValue: '12-30', okText: '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å', cancelText: '–û—Ç–º–µ–Ω–∞', icon: 'edit-3' });
        if (!end) return;
        if (!Utils.validateDateKey(end)) {
          App.showToast('–ù–µ–≤–µ—Ä–Ω—ã–π –∫–æ–Ω–µ—Ü (MM-DD)');
          return;
        }

        const kStr = await PremiumDialog.prompt({ title: '–ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç (–Ω–∞–ø—Ä–∏–º–µ—Ä 1.5):', defaultValue: '1.5', okText: '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å', cancelText: '–û—Ç–º–µ–Ω–∞', icon: 'edit-3' });
        if (kStr === null) return;
        const k = Utils.sanitizeFloat(kStr, 1, 10, 1.5);

        const s = Utils.parseMonthDay(start);
        const e = Utils.parseMonthDay(end);
        if (!s || !e) {
          App.showToast('–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –¥–∞—Ç—ã');
          return;
        }

        if (!Array.isArray(DB.holidayRanges)) DB.holidayRanges = [];
        DB.holidayRanges.push({ sm: s.mm, sd: s.dd, em: e.mm, ed: e.dd, k });
        Storage.save();
        Admin.render();
      },

      updateRange: (index, field, value) => {
        if (!Array.isArray(DB.holidayRanges) || !DB.holidayRanges[index]) return;
        const r = DB.holidayRanges[index];

        if (field === 'k') {
          r.k = Utils.sanitizeFloat(value, 1, 10, r.k || 1.5);
          Storage.save();
          return;
        }

        const md = Utils.parseMonthDay(value);
        if (!md) {
          App.showToast('–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç (MM-DD)');
          Admin.render();
          return;
        }

        if (field === 'start') {
          r.sm = md.mm;
          r.sd = md.dd;
        }
        if (field === 'end') {
          r.em = md.mm;
          r.ed = md.dd;
        }

        Storage.save();
        Admin.render();
      },

      delRange: (index) => {
        if (!Array.isArray(DB.holidayRanges)) return;
        DB.holidayRanges.splice(index, 1);
        Storage.save();
        Admin.render();
      },

      // ========== BONUSES (–ë–û–ù–£–°–´) ==========
      renderBonuses: () => {
        const container = document.getElementById('settings-bonuses-list');
        if (!container) return;

        Utils.clearElement(container);

        if (!Array.isArray(DB.bonuses) || DB.bonuses.length === 0) {
          container.innerHTML = `<div class="text-sm text-slate-500">–ù–µ—Ç –±–æ–Ω—É—Å–æ–≤</div>`;
          return;
        }

        DB.bonuses
          .slice()
          .sort((a, b) => (a.threshold || 0) - (b.threshold || 0))
          .forEach((bonus, idx) => {
            container.appendChild(Admin.createBonusRow(bonus, idx));
          });
      },

      createBonusRow: (bonus, idx) => {
        const row = Utils.createElement('div', 'edit-row');

        const thr = Utils.createElement('input', 'edit-input w-36 text-right mono');
        thr.type = 'number';
        thr.value = bonus.threshold ?? 0;
        thr.min = '0';
        thr.addEventListener('change', () => {
          DB.bonuses[idx].threshold = Utils.sanitizeNumber(thr.value, 0, 999999, 0);
          Storage.save();
          App.calc();
          Admin.renderBonuses();
        });

        const text = Utils.createElement('input', 'edit-input flex-1');
        text.value = bonus.text ?? '';
        text.maxLength = 200;
        text.addEventListener('change', () => {
          DB.bonuses[idx].text = Utils.sanitizeText(text.value, 200);
          Storage.save();
          App.calc();
          Admin.renderBonuses();
        });

        const delBtn = Utils.createElement('button', 'btn-del-mini');
        delBtn.innerHTML = '<i data-lucide="trash-2" class="w-5 h-5"></i>';
        delBtn.addEventListener('click', () => Admin.delBonus(idx));

        row.appendChild(thr);
        row.appendChild(text);
        row.appendChild(delBtn);
        return row;
      },

      addBonus: async () => {
        const thr = await PremiumDialog.prompt({ title: '–ü–æ—Ä–æ–≥ (‚ÇΩ):', defaultValue: '50000', okText: '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å', cancelText: '–û—Ç–º–µ–Ω–∞', icon: 'edit-3' });
        if (thr === null) return;
        const threshold = Utils.sanitizeNumber(thr, 0, 999999, 0);

        const text = await PremiumDialog.prompt({ title: '–¢–µ–∫—Å—Ç –±–æ–Ω—É—Å–∞:', defaultValue: '–ë–æ–Ω—É—Å –∫–ª–∏–µ–Ω—Ç—É', okText: '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å', cancelText: '–û—Ç–º–µ–Ω–∞', icon: 'edit-3' });
        if (!text) return;

        if (!Array.isArray(DB.bonuses)) DB.bonuses = [];
        DB.bonuses.push({
          threshold,
          text: Utils.sanitizeText(text, 200)
        });
        Storage.save();
        App.calc();
        Admin.renderBonuses();
      },

      delBonus: async (idx) => {
        if (!Array.isArray(DB.bonuses) || !DB.bonuses[idx]) return;
        if (!(await PremiumDialog.confirm({ message: '–£–¥–∞–ª–∏—Ç—å –±–æ–Ω—É—Å?', danger: true, okText: '–î–∞', cancelText: '–û—Ç–º–µ–Ω–∞', icon: 'shield-alert' }))) return;
        DB.bonuses.splice(idx, 1);
        Storage.save();
        App.calc();
        Admin.renderBonuses();
      },

      // ========== PAYMENTS (–†–ï–ö–í–ò–ó–ò–¢–´) ==========
      renderPayments: () => {
        const container = document.getElementById('settings-payments-list');
        if (!container) return;

        Utils.clearElement(container);

        if (!Array.isArray(DB.payments) || DB.payments.length === 0) {
          container.innerHTML = `<div class="text-sm text-slate-500">–ù–µ—Ç —Å–ø–æ—Å–æ–±–æ–≤ –±—Ä–æ–Ω–∏</div>`;
          return;
        }

        DB.payments.forEach((p, idx) => {
          container.appendChild(Admin.createPaymentRow(p, idx));
        });
      },

      createPaymentRow: (p, idx) => {
        const row = Utils.createElement('div', 'edit-row');

        const title = Utils.createElement('input', 'edit-input w-40');
        title.value = p.title ?? '';
        title.maxLength = 100;
        title.addEventListener('change', () => {
          DB.payments[idx].title = Utils.sanitizeText(title.value, 100);
          Storage.save();
        });

        const text = Utils.createElement('input', 'edit-input flex-1');
        text.value = p.text ?? '';
        text.maxLength = 500;
        text.addEventListener('change', () => {
          DB.payments[idx].text = Utils.sanitizeText(text.value, 500);
          Storage.save();
        });

        const delBtn = Utils.createElement('button', 'btn-del-mini');
        delBtn.innerHTML = '<i data-lucide="trash-2" class="w-5 h-5"></i>';
        delBtn.addEventListener('click', () => Admin.delPayment(idx));

        row.appendChild(title);
        row.appendChild(text);
        row.appendChild(delBtn);
        return row;
      },

      addPayment: async () => {
        const title = await PremiumDialog.prompt({ title: '–ù–∞–∑–≤–∞–Ω–∏–µ —Ä–µ–∫–≤–∏–∑–∏—Ç–æ–≤:', defaultValue: '–ü–µ—Ä–µ–≤–æ–¥', okText: '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å', cancelText: '–û—Ç–º–µ–Ω–∞', icon: 'edit-3' });
        if (!title) return;
        const text = await PremiumDialog.prompt({ title: '–¢–µ–∫—Å—Ç —Ä–µ–∫–≤–∏–∑–∏—Ç–æ–≤:', defaultValue: '–°–ë–ü / –∫–∞—Ä—Ç–∞: ...', okText: '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å', cancelText: '–û—Ç–º–µ–Ω–∞', icon: 'edit-3' });
        if (!text) return;

        if (!Array.isArray(DB.payments)) DB.payments = [];
        DB.payments.push({
          title: Utils.sanitizeText(title, 100),
          text: Utils.sanitizeText(text, 500)
        });
        Storage.save();
        Admin.renderPayments();
      },

      delPayment: async (idx) => {
        if (!Array.isArray(DB.payments) || !DB.payments[idx]) return;
        if (!(await PremiumDialog.confirm({ message: '–£–¥–∞–ª–∏—Ç—å —Ä–µ–∫–≤–∏–∑–∏—Ç—ã?', danger: true, okText: '–î–∞', cancelText: '–û—Ç–º–µ–Ω–∞', icon: 'shield-alert' }))) return;
        DB.payments.splice(idx, 1);
        Storage.save();
        Admin.renderPayments();
      },

      // ========== LINKS (–°–°–´–õ–ö–ò) ==========
      renderLinks: () => {
        const container = document.getElementById('settings-links-list');
        if (!container) return;

        Utils.clearElement(container);

        if (!Array.isArray(DB.links) || DB.links.length === 0) {
          container.innerHTML = `<div class="text-sm text-slate-500">–ù–µ—Ç —Å—Å—ã–ª–æ–∫</div>`;
          return;
        }

        DB.links.forEach((l, idx) => {
          container.appendChild(Admin.createLinkRow(l, idx));
        });
      },

      createLinkRow: (l, idx) => {
        const row = Utils.createElement('div', 'edit-row');

        const label = Utils.createElement('input', 'edit-input w-40');
        label.value = l.label ?? '';
        label.maxLength = 100;
        label.addEventListener('change', () => {
          DB.links[idx].label = Utils.sanitizeText(label.value, 100);
          Storage.save();
        });

        const url = Utils.createElement('input', 'edit-input flex-1 mono');
        url.value = l.url ?? '';
        url.maxLength = 500;
        url.addEventListener('change', () => {
          DB.links[idx].url = Utils.sanitizeText(url.value, 500);
          Storage.save();
        });

        const delBtn = Utils.createElement('button', 'btn-del-mini');
        delBtn.innerHTML = '<i data-lucide="trash-2" class="w-5 h-5"></i>';
        delBtn.addEventListener('click', () => Admin.delLink(idx));

        row.appendChild(label);
        row.appendChild(url);
        row.appendChild(delBtn);
        return row;
      },

      addLink: async () => {
        const label = await PremiumDialog.prompt({ title: '–ù–∞–∑–≤–∞–Ω–∏–µ —Å—Å—ã–ª–∫–∏:', defaultValue: '–ü–æ—Ä—Ç—Ñ–æ–ª–∏–æ', okText: '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å', cancelText: '–û—Ç–º–µ–Ω–∞', icon: 'edit-3' });
        if (!label) return;
        const url = await PremiumDialog.prompt({ title: 'URL:', defaultValue: 'https://', okText: '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å', cancelText: '–û—Ç–º–µ–Ω–∞', icon: 'edit-3' });
        if (!url) return;

        if (!Array.isArray(DB.links)) DB.links = [];
        DB.links.push({
          label: Utils.sanitizeText(label, 100),
          url: Utils.sanitizeText(url, 500)
        });
        Storage.save();
        Admin.renderLinks();
      },

      delLink: async (idx) => {
        if (!Array.isArray(DB.links) || !DB.links[idx]) return;
        if (!(await PremiumDialog.confirm({ message: '–£–¥–∞–ª–∏—Ç—å —Å—Å—ã–ª–∫—É?', danger: true, okText: '–î–∞', cancelText: '–û—Ç–º–µ–Ω–∞', icon: 'shield-alert' }))) return;
        DB.links.splice(idx, 1);
        Storage.save();
        Admin.renderLinks();
      },

      // ========== RESET ==========
      reset: async () => {
        const hard = await PremiumDialog.confirm({ message: '–°–±—Ä–æ—Å–∏—Ç—å –±–∞–∑—É —Ü–µ–Ω –Ω–∞ –¥–µ—Ñ–æ–ª—Ç?\n\nOK = –°–±—Ä–æ—Å–∏—Ç—å\n–û—Ç–º–µ–Ω–∞ = –û—Ç–º–µ–Ω–∞', danger: true, okText: '–î–∞', cancelText: '–û—Ç–º–µ–Ω–∞', icon: 'shield-alert' });
        if (!hard) return;

        try {
          DataManager.createBackup('–ü–µ—Ä–µ–¥ —Å–±—Ä–æ—Å–æ–º');
        } catch (e) { }

        DB = JSON.parse(JSON.stringify(DEFAULT_DB));
        DB.version = DB_VERSION;
        Storage.save();

        State.cart = [];
        State.finalTotal = 0;
        State.serviceQty = 1;

        App.updateUI();
        App.renderCart();
        App.calc();
        App.showToast('–ë–∞–∑–∞ —Å–±—Ä–æ—à–µ–Ω–∞');
      }
    });



    /* === Inlined from modules.js === */
    /* ============================================
       ILLUSIONIST OS - MODULES.JS
       –ú–æ–¥—É–ª–∏: Templates, Rounding, Variants
       ============================================ */

    'use strict';

    // ============================================
    // TEMPLATES MODULE
    // ============================================

    // ============================================
    // ROUNDING MODULE (DISABLED)
    // ============================================
    const Rounding = {
      state: { isApplied: false, originalTotal: 0, roundedTotal: 0, diff: 0 },
      clearStateSilently: () => { },
      updateUI: () => { },
      init: () => { }
    };

    // ============================================
    // VARIANTS MODULE
    // ============================================

    // ============================================
    // RESPONSE TEMPLATES MODULE
    // ============================================

    // –ó–∞–≥—Ä—É–∑–∫–∞ —à–∞–±–ª–æ–Ω–æ–≤ –æ—Ç–≤–µ—Ç–æ–≤
    function loadResponseTemplates() {
      const stored = localStorage.getItem(RESPONSE_TEMPLATES_KEY);
      if (!stored) return [];
      try {
        const parsed = JSON.parse(stored);
        return Array.isArray(parsed) ? parsed : [];
      } catch {
        return [];
      }
    }

    // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —à–∞–±–ª–æ–Ω–æ–≤ –æ—Ç–≤–µ—Ç–æ–≤
    function saveResponseTemplates(templates) {
      try {
        localStorage.setItem(RESPONSE_TEMPLATES_KEY, JSON.stringify(templates));
        return true;
      } catch {
        return false;
      }
    }

    // –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ —Å–ø–∏—Å–∫–∞ —à–∞–±–ª–æ–Ω–æ–≤ –æ—Ç–≤–µ—Ç–æ–≤
    function renderResponseTemplates() {
      const container = document.getElementById('response-templates-list');
      if (!container) return;

      const templates = loadResponseTemplates();
      Utils.clearElement(container);

      if (templates.length === 0) {
        const empty = Utils.createElement('div', 'text-sm text-slate-500 bg-white/5 border border-white/10 rounded-xl p-4 text-center');
        empty.textContent = '–ù–µ—Ç —à–∞–±–ª–æ–Ω–æ–≤. –°–æ–∑–¥–∞–π—Ç–µ –ø–µ—Ä–≤—ã–π!';
        container.appendChild(empty);
        return;
      }

      templates.forEach((tpl, idx) => {
        const card = Utils.createElement('div', 'bg-white/5 hover:bg-white/10 border border-white/10 rounded-xl p-4 transition cursor-pointer flex items-center justify-between group');

        const left = Utils.createElement('div', 'flex-1 min-w-0 overflow-hidden');
        const title = Utils.createElement('div', 'font-bold text-white truncate');
        title.textContent = tpl.name || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è';

        const preview = Utils.createElement('div', 'text-sm text-slate-400 mt-1');
        preview.style.display = '-webkit-box';
        preview.style.webkitLineClamp = '2';
        preview.style.webkitBoxOrient = 'vertical';
        preview.style.overflow = 'hidden';
        preview.style.wordBreak = 'break-word';
        preview.style.overflowWrap = 'break-word';
        preview.style.whiteSpace = 'pre-wrap';
        preview.textContent = tpl.text || '';

        left.appendChild(title);
        left.appendChild(preview);

        const right = Utils.createElement('div', 'flex items-center gap-2 ml-3 flex-shrink-0');

        const copyBtn = Utils.createElement('button', 'btn-icon opacity-0 group-hover:opacity-100 transition');
        copyBtn.innerHTML = '<i data-lucide="copy" class="w-4 h-4"></i>';
        copyBtn.title = '–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å';
        copyBtn.addEventListener('click', async (e) => {
          e.stopPropagation();
          const success = await Utils.copyToClipboard(tpl.text || '');
          App.showToast(success ? '–¢–µ–∫—Å—Ç —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω!' : '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å');
        });

        const editBtn = Utils.createElement('button', 'btn-icon opacity-0 group-hover:opacity-100 transition');
        editBtn.innerHTML = '<i data-lucide="pencil" class="w-4 h-4"></i>';
        editBtn.title = '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å';
        editBtn.addEventListener('click', async (e) => {
          e.stopPropagation();

          const updated = loadResponseTemplates();
          const i = updated.findIndex(t => t.id === tpl.id);
          if (i < 0) return;

          const current = updated[i] || {};
          const name = await PremiumDialog.prompt({ title: '–ù–∞–∑–≤–∞–Ω–∏–µ —à–∞–±–ª–æ–Ω–∞:', defaultValue: current.name || '', okText: '–î–∞–ª–µ–µ', cancelText: '–û—Ç–º–µ–Ω–∞', icon: 'edit-3' });
          if (!name) return;

          const text = await PremiumDialog.prompt({
            title: '–¢–µ–∫—Å—Ç –æ—Ç–≤–µ—Ç–∞:',
            defaultValue: current.text || '',
            okText: '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å',
            cancelText: '–û—Ç–º–µ–Ω–∞',
            icon: 'edit-3',
            multiline: true,
            rows: 8,
            placeholder: '–ú–æ–∂–Ω–æ –ø–∏—Å–∞—Ç—å —Å –∞–±–∑–∞—Ü–∞–º–∏, —Å–ø–∏—Å–∫–∞–º–∏ –∏ —ç–º–æ–¥–∑–∏ üôÇ\nTab = –æ—Ç—Å—Ç—É–ø\nCtrl/‚åò + Enter = —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å'
          });
          if (text === null) return;

          const cleanText = String(text).replace(/\s+$/, '');
          if (!cleanText.trim()) return;

          updated[i].name = String(name).trim();
          updated[i].text = cleanText;

          saveResponseTemplates(updated);
          renderResponseTemplates();
          App.showToast('–®–∞–±–ª–æ–Ω –æ–±–Ω–æ–≤–ª—ë–Ω');
        });

        const delBtn = Utils.createElement('button', 'btn-icon opacity-0 group-hover:opacity-100 transition');
        delBtn.innerHTML = '<i data-lucide="trash-2" class="w-4 h-4"></i>';
        delBtn.title = '–£–¥–∞–ª–∏—Ç—å';
        delBtn.addEventListener('click', async (e) => {
          e.stopPropagation();
          if (await PremiumDialog.confirm({ message: `–£–¥–∞–ª–∏—Ç—å —à–∞–±–ª–æ–Ω "${tpl.name}"?`, danger: true, okText: '–î–∞', cancelText: '–û—Ç–º–µ–Ω–∞', icon: 'shield-alert' })) {
            const updated = loadResponseTemplates();
            updated.splice(idx, 1);
            saveResponseTemplates(updated);
            renderResponseTemplates();
            App.showToast('–®–∞–±–ª–æ–Ω —É–¥–∞–ª—ë–Ω');
          }
        });

        right.appendChild(copyBtn);
        right.appendChild(editBtn);
        right.appendChild(delBtn);

        card.appendChild(left);
        card.appendChild(right);

        // –ö–ª–∏–∫ –ø–æ –∫–∞—Ä—Ç–æ—á–∫–µ = –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ
        card.addEventListener('click', async () => {
          const success = await Utils.copyToClipboard(tpl.text || '');
          App.showToast(success ? '–¢–µ–∫—Å—Ç —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω!' : '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å');
        });

        container.appendChild(card);
      });

      if (window.lucide) lucide.createIcons();
    }

    // –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ —à–∞–±–ª–æ–Ω–∞ –æ—Ç–≤–µ—Ç–∞
    async function createResponseTemplate() {
      const name = await PremiumDialog.prompt({ title: '–ù–∞–∑–≤–∞–Ω–∏–µ —à–∞–±–ª–æ–Ω–∞:', defaultValue: '', okText: '–î–∞–ª–µ–µ', cancelText: '–û—Ç–º–µ–Ω–∞', icon: 'edit-3' });
      if (!name) return;

      const text = await PremiumDialog.prompt({
        title: '–¢–µ–∫—Å—Ç –æ—Ç–≤–µ—Ç–∞:',
        defaultValue: '',
        okText: '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å',
        cancelText: '–û—Ç–º–µ–Ω–∞',
        icon: 'edit-3',
        multiline: true,
        rows: 8,
        placeholder: '–ú–æ–∂–Ω–æ –ø–∏—Å–∞—Ç—å —Å –∞–±–∑–∞—Ü–∞–º–∏, —Å–ø–∏—Å–∫–∞–º–∏ –∏ —ç–º–æ–¥–∑–∏ üôÇ\nTab = –æ—Ç—Å—Ç—É–ø\nCtrl/‚åò + Enter = —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å'
      });
      if (text === null) return;

      const cleanText = String(text).replace(/\s+$/, '');
      if (!cleanText.trim()) return;

      const templates = loadResponseTemplates();
      templates.push({
        id: Date.now(),
        name: String(name).trim(),
        text: cleanText
      });

      saveResponseTemplates(templates);
      renderResponseTemplates();
      App.showToast('–®–∞–±–ª–æ–Ω —Å–æ–∑–¥–∞–Ω!');
    }

    // ============================================
    // DRAWER: –ë–´–°–¢–†–´–ï –û–¢–í–ï–¢–´
    // ============================================
    const QuickResponsesDrawer = {
      drawer: null,
      panel: null,
      isOpen: false,
      touchStartX: 0,
      touchStartY: 0,
      touchCurrentX: 0,
      swipeThreshold: 50,
      edgeThreshold: 40, // px –æ—Ç –ø—Ä–∞–≤–æ–≥–æ –∫—Ä–∞—è –¥–ª—è –Ω–∞—á–∞–ª–∞ —Å–≤–∞–π–ø–∞

      init() {
        this.drawer = document.getElementById('quick-responses-drawer');
        this.panel = this.drawer?.querySelector('.drawer-panel');

        if (!this.drawer) return;

        // –ö–Ω–æ–ø–∫–∞ –∑–∞–∫—Ä—ã—Ç–∏—è
        const closeBtn = document.getElementById('drawer-close');
        closeBtn?.addEventListener('click', () => this.close());

        // –ö–Ω–æ–ø–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —à–∞–±–ª–æ–Ω–∞
        const addBtn = document.getElementById('drawer-add-template');
        addBtn?.addEventListener('click', async () => {
          await createResponseTemplate();
          this.renderTemplates();
        });

        // –ö–ª–∏–∫ –ø–æ overlay –∑–∞–∫—Ä—ã–≤–∞–µ—Ç drawer
        this.drawer.addEventListener('click', (e) => {
          if (e.target === this.drawer) this.close();
        });

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–≤–∞–π–ø-–∂–µ—Å—Ç–æ–≤
        this.setupSwipeGestures();

        // –ü–µ—Ä–≤–∏—á–Ω—ã–π —Ä–µ–Ω–¥–µ—Ä
        this.renderTemplates();

        // –ò–∫–æ–Ω–∫–∏
        if (window.lucide) lucide.createIcons();
      },

      setupSwipeGestures() {
        const screenWidth = window.innerWidth;

        // Touch start
        document.addEventListener('touchstart', (e) => {
          const touch = e.touches[0];
          this.touchStartX = touch.clientX;
          this.touchStartY = touch.clientY;
          this.touchCurrentX = touch.clientX;
        }, { passive: true });

        // Touch move
        document.addEventListener('touchmove', (e) => {
          if (!e.touches[0]) return;
          this.touchCurrentX = e.touches[0].clientX;
        }, { passive: true });

        // Touch end
        document.addEventListener('touchend', (e) => {
          const deltaX = this.touchCurrentX - this.touchStartX;
          const screenWidth = window.innerWidth;
          const startFromEdge = screenWidth - this.touchStartX <= this.edgeThreshold;

          // –°–≤–∞–π–ø –≤–ª–µ–≤–æ –æ—Ç –ø—Ä–∞–≤–æ–≥–æ –∫—Ä–∞—è ‚Äî –æ—Ç–∫—Ä—ã—Ç—å drawer
          if (startFromEdge && deltaX < -this.swipeThreshold && !this.isOpen) {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –Ω–µ —Å–≤–∞–π–ø–∏–º –≤–Ω—É—Ç—Ä–∏ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –∏–ª–∏ –º–æ–¥–∞–ª–∫–∏
            const settingsOpen = document.getElementById('view-settings')?.classList.contains('active');
            if (!settingsOpen) {
              this.open();
            }
          }

          // –°–≤–∞–π–ø –≤–ø—Ä–∞–≤–æ –≤–Ω—É—Ç—Ä–∏ drawer ‚Äî –∑–∞–∫—Ä—ã—Ç—å
          if (this.isOpen && deltaX > this.swipeThreshold) {
            this.close();
          }
        }, { passive: true });
      },

      open() {
        if (!this.drawer) return;
        this.drawer.classList.add('open');
        this.isOpen = true;
        this.renderTemplates();
        document.body.style.overflow = 'hidden';
      },

      close() {
        if (!this.drawer) return;
        this.drawer.classList.remove('open');
        this.isOpen = false;
        document.body.style.overflow = '';
      },

      toggle() {
        this.isOpen ? this.close() : this.open();
      },

      renderTemplates() {
        const container = document.getElementById('drawer-templates-list');
        if (!container) return;

        const templates = loadResponseTemplates();
        container.innerHTML = '';

        if (templates.length === 0) {
          container.innerHTML = `
            <div class="drawer-empty">
              <div class="drawer-empty-icon">üí¨</div>
              <div>–ù–µ—Ç —à–∞–±–ª–æ–Ω–æ–≤</div>
              <div style="font-size: 12px; margin-top: 8px;">–°–æ–∑–¥–∞–π—Ç–µ –ø–µ—Ä–≤—ã–π!</div>
            </div>
          `;
          return;
        }

        templates.forEach((tpl, idx) => {
          const card = document.createElement('div');
          card.className = 'drawer-template-card';

          const name = document.createElement('div');
          name.className = 'drawer-template-name';
          name.textContent = tpl.name || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è';

          const preview = document.createElement('div');
          preview.className = 'drawer-template-preview';
          preview.textContent = tpl.text || '';

          const actions = document.createElement('div');
          actions.className = 'drawer-template-actions';

          // –ö–Ω–æ–ø–∫–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
          const editBtn = document.createElement('button');
          editBtn.className = 'btn-icon';
          editBtn.innerHTML = '<i data-lucide="pencil" class="w-4 h-4"></i>';
          editBtn.title = '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å';
          editBtn.addEventListener('click', async (e) => {
            e.stopPropagation();
            await this.editTemplate(tpl.id);
          });

          // –ö–Ω–æ–ø–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è
          const delBtn = document.createElement('button');
          delBtn.className = 'btn-icon';
          delBtn.innerHTML = '<i data-lucide="trash-2" class="w-4 h-4"></i>';
          delBtn.title = '–£–¥–∞–ª–∏—Ç—å';
          delBtn.addEventListener('click', async (e) => {
            e.stopPropagation();
            if (await PremiumDialog.confirm({
              message: `–£–¥–∞–ª–∏—Ç—å —à–∞–±–ª–æ–Ω "${tpl.name}"?`,
              danger: true,
              okText: '–î–∞',
              cancelText: '–û—Ç–º–µ–Ω–∞',
              icon: 'shield-alert'
            })) {
              const updated = loadResponseTemplates();
              const i = updated.findIndex(t => t.id === tpl.id);
              if (i >= 0) {
                updated.splice(i, 1);
                saveResponseTemplates(updated);
                this.renderTemplates();
                App.showToast('–®–∞–±–ª–æ–Ω —É–¥–∞–ª—ë–Ω');
              }
            }
          });

          actions.appendChild(editBtn);
          actions.appendChild(delBtn);

          card.appendChild(name);
          card.appendChild(preview);
          card.appendChild(actions);

          // –ö–ª–∏–∫ –ø–æ –∫–∞—Ä—Ç–æ—á–∫–µ = –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ
          card.addEventListener('click', async () => {
            const success = await Utils.copyToClipboard(tpl.text || '');
            App.showToast(success ? '‚úÖ –°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!' : '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å');
          });

          container.appendChild(card);
        });

        if (window.lucide) lucide.createIcons();
      },

      async editTemplate(id) {
        const templates = loadResponseTemplates();
        const idx = templates.findIndex(t => t.id === id);
        if (idx < 0) return;

        const tpl = templates[idx];

        const name = await PremiumDialog.prompt({
          title: '–ù–∞–∑–≤–∞–Ω–∏–µ —à–∞–±–ª–æ–Ω–∞:',
          defaultValue: tpl.name || '',
          okText: '–î–∞–ª–µ–µ',
          cancelText: '–û—Ç–º–µ–Ω–∞',
          icon: 'edit-3'
        });
        if (!name) return;

        const text = await PremiumDialog.prompt({
          title: '–¢–µ–∫—Å—Ç –æ—Ç–≤–µ—Ç–∞:',
          defaultValue: tpl.text || '',
          okText: '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å',
          cancelText: '–û—Ç–º–µ–Ω–∞',
          icon: 'edit-3',
          multiline: true,
          rows: 8,
          placeholder: '–ú–æ–∂–Ω–æ –ø–∏—Å–∞—Ç—å —Å –∞–±–∑–∞—Ü–∞–º–∏, —Å–ø–∏—Å–∫–∞–º–∏ –∏ —ç–º–æ–¥–∑–∏ üôÇ'
        });
        if (text === null) return;

        const cleanText = String(text).replace(/\\s+$/, '');
        if (!cleanText.trim()) return;

        templates[idx].name = String(name).trim();
        templates[idx].text = cleanText;

        saveResponseTemplates(templates);
        this.renderTemplates();
        App.showToast('‚úÖ –®–∞–±–ª–æ–Ω –æ–±–Ω–æ–≤–ª—ë–Ω');
      }
    };

    // ============================================
    // INIT ALL MODULES
    // ============================================
    document.addEventListener('DOMContentLoaded', () => {
      Rounding.init();

      // –†–µ–Ω–¥–µ—Ä–∏–º —Å–ø–∏—Å–æ–∫ —à–∞–±–ª–æ–Ω–æ–≤ –ø–∞–∫–µ—Ç–æ–≤ –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö
      renderTemplatesAdmin();

      // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è drawer –±—ã—Å—Ç—Ä—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤ (—Å–≤–∞–π–ø —Å–ø—Ä–∞–≤–∞)
      QuickResponsesDrawer.init();

      // –ö–ù–û–ü–ö–ê "–ü–ê–ö–ï–¢–´" - –¥–æ–±–∞–≤–ª—è–µ—Ç –≤ –∫–æ—Ä–∑–∏–Ω—É
      const packagesBtn = document.getElementById('btn-open-packages');
      if (packagesBtn) {
        packagesBtn.addEventListener('click', async () => {
          const templates = DB.packageTemplates || [];

          if (templates.length === 0) {
            await PremiumDialog.alert({ message: '–ù–µ—Ç —à–∞–±–ª–æ–Ω–æ–≤!\n\n–°–æ–∑–¥–∞–π—Ç–µ —à–∞–±–ª–æ–Ω –≤ –ù–∞—Å—Ç—Ä–æ–π–∫–∞—Ö ‚Üí –®–∞–±–ª–æ–Ω—ã –ø–∞–∫–µ—Ç–æ–≤', okText: '–û–∫', icon: 'sparkles' });
            return;
          }

          // –§–æ—Ä–º–∏—Ä—É–µ–º —Å–ø–∏—Å–æ–∫ –¥–ª—è –≤—ã–±–æ—Ä–∞
          let message = '–í—ã–±–µ—Ä–∏—Ç–µ —à–∞–±–ª–æ–Ω:\n\n';
          templates.forEach((tpl, idx) => {
            message += `${idx + 1}. ${tpl.name}\n`;
          });
          message += '\n–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä:';

          const choice = await PremiumDialog.prompt({ title: '–í—ã–±–æ—Ä —à–∞–±–ª–æ–Ω–∞', message: message, defaultValue: '', okText: '–í—ã–±—Ä–∞—Ç—å', cancelText: '–û—Ç–º–µ–Ω–∞', icon: 'list' });
          if (!choice) return;

          const num = parseInt(choice);
          if (isNaN(num) || num < 1 || num > templates.length) {
            await PremiumDialog.alert({ message: '–ù–µ–≤–µ—Ä–Ω—ã–π –Ω–æ–º–µ—Ä!', okText: '–û–∫', icon: 'sparkles' });
            return;
          }

          const selectedTemplate = templates[num - 1];

          // –î–æ–±–∞–≤–ª—è–µ–º –≤ –∫–æ—Ä–∑–∏–Ω—É —Å–ø–µ—Ü–∏–∞–ª—å–Ω—É—é —É—Å–ª—É–≥—É –ü–ê–ö–ï–¢
          const packageItem = {
            name: `–ü–ê–ö–ï–¢: ${selectedTemplate.name}`,
            price: 0, // –¶–µ–Ω–∞ 0, —Ä–µ–∞–ª—å–Ω—ã–µ —Ü–µ–Ω—ã –±—É–¥—É—Ç –≤ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏
            qty: 1,
            packageTemplate: selectedTemplate // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å—Å—ã–ª–∫—É –Ω–∞ —à–∞–±–ª–æ–Ω
          };

          // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ—Ç –ª–∏ —É–∂–µ –ø–∞–∫–µ—Ç–∞ –≤ –∫–æ—Ä–∑–∏–Ω–µ
          const existingPackageIndex = State.cart.findIndex(item => item.name.startsWith('–ü–ê–ö–ï–¢:'));
          if (existingPackageIndex >= 0) {
            // –ó–∞–º–µ–Ω—è–µ–º —Å—Ç–∞—Ä—ã–π –ø–∞–∫–µ—Ç
            State.cart[existingPackageIndex] = packageItem;
            App.showToast('–ü–∞–∫–µ—Ç –∑–∞–º–µ–Ω—ë–Ω');
          } else {
            // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–π
            State.cart.push(packageItem);
            App.showToast('–ü–∞–∫–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω –≤ –∫–æ—Ä–∑–∏–Ω—É');
          }

          App.calc(); // –í–ê–ñ–ù–û! –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º –∫–æ—Ä–∑–∏–Ω—É
          App.updateUI();
        });
      }

      // –ì–ï–ù–ï–†–ê–¶–ò–Ø –¢–ï–ö–°–¢–ê –í–°–ï–• 3 –ü–ê–ö–ï–¢–û–í
      function generatePackagesText(tpl) {
        // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä–∞
        const region = document.getElementById('inp-region')?.value || '';
        const city = document.getElementById('inp-city')?.value || '';
        const dateRaw = document.getElementById('inp-date')?.value || '';
        const time = document.getElementById('inp-time')?.value || '';
        const dateFmt = Utils.formatDate(dateRaw) || dateRaw;

        // –†–µ–≥–∏–æ–Ω–∞–ª—å–Ω—ã–π –º–Ω–æ–∂–∏—Ç–µ–ª—å
        let regionMult = 1;
        if (region && DB.travel && DB.travel[region]) {
          regionMult = DB.travel[region].multiplier || 1;
        }

        // –õ–æ–≥–∏—Å—Ç–∏–∫–∞
        let logistics = 0;
        if (region && city && DB.travel && DB.travel[region] && DB.travel[region].cities) {
          const cityData = DB.travel[region].cities[city];
          if (cityData && typeof cityData.price === 'number') {
            logistics = cityData.price;
          }
        }

        let text = `–ü–ê–ö–ï–¢–´ –î–õ–Ø –ú–ï–†–û–ü–†–ò–Ø–¢–ò–Ø\n\n`;
        if (dateFmt) text += `–î–∞—Ç–∞: ${dateFmt}\n`;
        if (time) text += `–í—Ä–µ–º—è: ${time}\n`;
        if (region) text += `–†–µ–≥–∏–æ–Ω: ${region}\n`;
        if (city) text += `–ì–æ—Ä–æ–¥: ${city}\n`;
        text += `\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n`;

        // –ë–ê–ó–û–í–´–ô
        const basicPrice = Utils.prettyRound(tpl.basic.price * regionMult);
        const basicTotal = basicPrice + logistics;

        text += `üì¶ –í–ê–†–ò–ê–ù–¢ 1: –ë–ê–ó–û–í–´–ô\n\n`;
        if (tpl.basic.description) text += `${tpl.basic.description}\n\n`;
        if (tpl.basic.bonuses && tpl.basic.bonuses.length > 0) {
          text += `–ë–æ–Ω—É—Å—ã:\n`;
          tpl.basic.bonuses.forEach(b => {
            text += `‚úÖ ${b}\n`;
          });
          text += `\n`;
        }
        text += `–°—Ç–æ–∏–º–æ—Å—Ç—å –ø—Ä–æ–≥—Ä–∞–º–º—ã: ${Utils.formatPrice(basicPrice)} ‚ÇΩ\n`;
        if (logistics > 0) text += `–õ–æ–≥–∏—Å—Ç–∏–∫–∞: ${Utils.formatPrice(logistics)} ‚ÇΩ\n`;
        text += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n`;
        text += `–ò–¢–û–ì–û: ${Utils.formatPrice(basicTotal)} ‚ÇΩ\n\n`;
        text += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n`;

        // –û–ü–¢–ò–ú–ê–õ
        const optimalPrice = Utils.prettyRound(tpl.optimal.price * regionMult);
        const optimalTotal = optimalPrice + logistics;

        text += `üì¶ –í–ê–†–ò–ê–ù–¢ 2: –û–ü–¢–ò–ú–ê–õ\n\n`;
        if (tpl.optimal.description) text += `${tpl.optimal.description}\n\n`;
        if (tpl.optimal.bonuses && tpl.optimal.bonuses.length > 0) {
          text += `–ë–æ–Ω—É—Å—ã:\n`;
          tpl.optimal.bonuses.forEach(b => {
            text += `‚úÖ ${b}\n`;
          });
          text += `\n`;
        }
        text += `–°—Ç–æ–∏–º–æ—Å—Ç—å –ø—Ä–æ–≥—Ä–∞–º–º—ã: ${Utils.formatPrice(optimalPrice)} ‚ÇΩ\n`;
        if (logistics > 0) text += `–õ–æ–≥–∏—Å—Ç–∏–∫–∞: ${Utils.formatPrice(logistics)} ‚ÇΩ\n`;
        text += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n`;
        text += `–ò–¢–û–ì–û: ${Utils.formatPrice(optimalTotal)} ‚ÇΩ\n\n`;
        text += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n`;

        // –ü–†–ï–ú–ò–£–ú
        const premiumPrice = Utils.prettyRound(tpl.premium.price * regionMult);
        const premiumTotal = premiumPrice + logistics;

        text += `üì¶ –í–ê–†–ò–ê–ù–¢ 3: –ü–†–ï–ú–ò–£–ú\n\n`;
        if (tpl.premium.description) text += `${tpl.premium.description}\n\n`;
        if (tpl.premium.bonuses && tpl.premium.bonuses.length > 0) {
          text += `–ë–æ–Ω—É—Å—ã:\n`;
          tpl.premium.bonuses.forEach(b => {
            text += `‚úÖ ${b}\n`;
          });
          text += `\n`;
        }
        text += `–°—Ç–æ–∏–º–æ—Å—Ç—å –ø—Ä–æ–≥—Ä–∞–º–º—ã: ${Utils.formatPrice(premiumPrice)} ‚ÇΩ\n`;
        if (logistics > 0) text += `–õ–æ–≥–∏—Å—Ç–∏–∫–∞: ${Utils.formatPrice(logistics)} ‚ÇΩ\n`;
        text += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n`;
        text += `–ò–¢–û–ì–û: ${Utils.formatPrice(premiumTotal)} ‚ÇΩ\n\n`;

        const performer = Utils.sanitizeText(DB.config?.performer || 'Illusionist', 100);
        text += `–í–∞—à ${performer}`;

        return text;
      }

      // –†–ï–î–ê–ö–¢–ò–†–û–í–ê–ù–ò–ï –®–ê–ë–õ–û–ù–ê –í –ù–ê–°–¢–†–û–ô–ö–ê–•
      async function editTemplateInSettings(tpl) {
        const templates = DB.packageTemplates || [];
        const idx = templates.findIndex(t => t.id === tpl.id);
        if (idx < 0) {
          await PremiumDialog.alert({ message: '–®–∞–±–ª–æ–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω!', okText: '–û–∫', icon: 'alert-triangle' });
          return;
        }

        // –°–æ–∑–¥–∞—ë–º —Ñ–æ—Ä–º—É —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
        const overlay = document.createElement('div');
        overlay.className = 'fixed inset-0 bg-black/80 z-[9999] flex items-center justify-center p-4';
        overlay.style.backdropFilter = 'blur(8px)';

        const modal = document.createElement('div');
        modal.className = 'glass rounded-2xl p-6 max-w-2xl w-full max-h-[90vh] overflow-y-auto';

        modal.innerHTML = `
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-xl font-bold text-white">‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —à–∞–±–ª–æ–Ω–∞</h2>
        <button id="pkg-edit-close" class="text-slate-400 hover:text-white transition">
          <i data-lucide="x" class="w-6 h-6"></i>
        </button>
      </div>

      <div class="space-y-4">
        <!-- –ù–∞–∑–≤–∞–Ω–∏–µ -->
        <div>
          <label class="block text-sm font-bold text-amber-400 mb-2">–ù–∞–∑–≤–∞–Ω–∏–µ —à–∞–±–ª–æ–Ω–∞</label>
          <input type="text" id="pkg-edit-name" value="${Utils.escapeHtml(tpl.name)}" 
            class="w-full bg-white/5 border-2 border-amber-500/30 rounded-xl px-4 py-3 text-white placeholder-slate-500 focus:border-amber-500 focus:outline-none transition">
        </div>

        <!-- –ë–ê–ó–û–í–´–ô -->
        <div class="border-t-2 border-amber-500/20 pt-4">
          <h3 class="text-lg font-bold text-amber-400 mb-3">üì¶ –ë–∞–∑–æ–≤—ã–π –ø–∞–∫–µ—Ç</h3>
          
          <label class="block text-sm font-bold text-white mb-2">–û–ø–∏—Å–∞–Ω–∏–µ</label>
          <textarea id="pkg-edit-basic-desc" rows="3" 
            class="w-full bg-white/5 border-2 border-amber-500/30 rounded-xl px-4 py-3 text-white placeholder-slate-500 focus:border-amber-500 focus:outline-none transition mb-3">${Utils.escapeHtml(tpl.basic.description || '')}</textarea>

          <label class="block text-sm font-bold text-white mb-2">–ë–æ–Ω—É—Å—ã (—á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é)</label>
          <input type="text" id="pkg-edit-basic-bonuses" value="${Utils.escapeHtml((tpl.basic.bonuses || []).join(', '))}" 
            class="w-full bg-white/5 border-2 border-amber-500/30 rounded-xl px-4 py-3 text-white placeholder-slate-500 focus:border-amber-500 focus:outline-none transition mb-3">

          <label class="block text-sm font-bold text-white mb-2">–¶–µ–Ω–∞ (‚ÇΩ)</label>
          <input type="number" id="pkg-edit-basic-price" value="${tpl.basic.price || 50000}" 
            class="w-full bg-white/5 border-2 border-amber-500/30 rounded-xl px-4 py-3 text-white placeholder-slate-500 focus:border-amber-500 focus:outline-none transition">
        </div>

        <!-- –û–ü–¢–ò–ú–ê–õ -->
        <div class="border-t-2 border-amber-500/20 pt-4">
          <h3 class="text-lg font-bold text-amber-400 mb-3">üì¶ –û–ø—Ç–∏–º–∞–ª –ø–∞–∫–µ—Ç</h3>
          
          <label class="block text-sm font-bold text-white mb-2">–û–ø–∏—Å–∞–Ω–∏–µ</label>
          <textarea id="pkg-edit-optimal-desc" rows="3" 
            class="w-full bg-white/5 border-2 border-amber-500/30 rounded-xl px-4 py-3 text-white placeholder-slate-500 focus:border-amber-500 focus:outline-none transition mb-3">${Utils.escapeHtml(tpl.optimal.description || '')}</textarea>

          <label class="block text-sm font-bold text-white mb-2">–ë–æ–Ω—É—Å—ã (—á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é)</label>
          <input type="text" id="pkg-edit-optimal-bonuses" value="${Utils.escapeHtml((tpl.optimal.bonuses || []).join(', '))}" 
            class="w-full bg-white/5 border-2 border-amber-500/30 rounded-xl px-4 py-3 text-white placeholder-slate-500 focus:border-amber-500 focus:outline-none transition mb-3">

          <label class="block text-sm font-bold text-white mb-2">–¶–µ–Ω–∞ (‚ÇΩ)</label>
          <input type="number" id="pkg-edit-optimal-price" value="${tpl.optimal.price || 75000}" 
            class="w-full bg-white/5 border-2 border-amber-500/30 rounded-xl px-4 py-3 text-white placeholder-slate-500 focus:border-amber-500 focus:outline-none transition">
        </div>

        <!-- –ü–†–ï–ú–ò–£–ú -->
        <div class="border-t-2 border-amber-500/20 pt-4">
          <h3 class="text-lg font-bold text-amber-400 mb-3">üì¶ –ü—Ä–µ–º–∏—É–º –ø–∞–∫–µ—Ç</h3>
          
          <label class="block text-sm font-bold text-white mb-2">–û–ø–∏—Å–∞–Ω–∏–µ</label>
          <textarea id="pkg-edit-premium-desc" rows="3" 
            class="w-full bg-white/5 border-2 border-amber-500/30 rounded-xl px-4 py-3 text-white placeholder-slate-500 focus:border-amber-500 focus:outline-none transition mb-3">${Utils.escapeHtml(tpl.premium.description || '')}</textarea>

          <label class="block text-sm font-bold text-white mb-2">–ë–æ–Ω—É—Å—ã (—á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é)</label>
          <input type="text" id="pkg-edit-premium-bonuses" value="${Utils.escapeHtml((tpl.premium.bonuses || []).join(', '))}" 
            class="w-full bg-white/5 border-2 border-amber-500/30 rounded-xl px-4 py-3 text-white placeholder-slate-500 focus:border-amber-500 focus:outline-none transition mb-3">

          <label class="block text-sm font-bold text-white mb-2">–¶–µ–Ω–∞ (‚ÇΩ)</label>
          <input type="number" id="pkg-edit-premium-price" value="${tpl.premium.price || 120000}" 
            class="w-full bg-white/5 border-2 border-amber-500/30 rounded-xl px-4 py-3 text-white placeholder-slate-500 focus:border-amber-500 focus:outline-none transition">
        </div>

        <!-- –ö–Ω–æ–ø–∫–∏ -->
        <div class="flex gap-3 pt-4">
          <button id="pkg-edit-cancel" class="flex-1 bg-slate-600 hover:bg-slate-500 text-white font-bold py-3 px-6 rounded-xl transition">
            –û—Ç–º–µ–Ω–∞
          </button>
          <button id="pkg-edit-save" class="flex-1 bg-gradient-to-r from-amber-500 to-orange-500 hover:from-amber-600 hover:to-orange-600 text-white font-bold py-3 px-6 rounded-xl transition">
            üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
          </button>
        </div>
      </div>
    `;

        overlay.appendChild(modal);
        document.body.appendChild(overlay);

        if (window.lucide) lucide.createIcons();

        // –ó–∞–∫—Ä—ã—Ç–∏–µ
        const closeForm = () => {
          overlay.remove();
        };

        document.getElementById('pkg-edit-close').addEventListener('click', closeForm);
        document.getElementById('pkg-edit-cancel').addEventListener('click', closeForm);
        overlay.addEventListener('click', (e) => {
          if (e.target === overlay) closeForm();
        });

        // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ
        document.getElementById('pkg-edit-save').addEventListener('click', () => {
          const newName = document.getElementById('pkg-edit-name').value.trim();
          if (!newName) {
            App.showToast('‚ùå –í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ!');
            return;
          }

          const basicDesc = document.getElementById('pkg-edit-basic-desc').value.trim();
          const basicBonuses = document.getElementById('pkg-edit-basic-bonuses').value;
          const basicPrice = parseInt(document.getElementById('pkg-edit-basic-price').value) || 50000;

          const optimalDesc = document.getElementById('pkg-edit-optimal-desc').value.trim();
          const optimalBonuses = document.getElementById('pkg-edit-optimal-bonuses').value;
          const optimalPrice = parseInt(document.getElementById('pkg-edit-optimal-price').value) || 75000;

          const premiumDesc = document.getElementById('pkg-edit-premium-desc').value.trim();
          const premiumBonuses = document.getElementById('pkg-edit-premium-bonuses').value;
          const premiumPrice = parseInt(document.getElementById('pkg-edit-premium-price').value) || 120000;

          // –û–±–Ω–æ–≤–ª—è–µ–º —à–∞–±–ª–æ–Ω
          templates[idx] = {
            ...tpl,
            name: newName,
            basic: {
              name: newName + ' ‚Äî –ë–∞–∑–æ–≤—ã–π',
              price: basicPrice,
              description: basicDesc,
              bonuses: basicBonuses ? basicBonuses.split(',').map(b => b.trim()).filter(b => b) : []
            },
            optimal: {
              name: newName + ' ‚Äî –û–ø—Ç–∏–º–∞–ª',
              price: optimalPrice,
              description: optimalDesc,
              bonuses: optimalBonuses ? optimalBonuses.split(',').map(b => b.trim()).filter(b => b) : []
            },
            premium: {
              name: newName + ' ‚Äî –ü—Ä–µ–º–∏—É–º',
              price: premiumPrice,
              description: premiumDesc,
              bonuses: premiumBonuses ? premiumBonuses.split(',').map(b => b.trim()).filter(b => b) : []
            }
          };

          DB.packageTemplates = templates;
          Storage.save();
          renderTemplatesAdmin();
          App.showToast('‚úÖ –®–∞–±–ª–æ–Ω –æ–±–Ω–æ–≤–ª—ë–Ω!');
          closeForm();
        });
      }

      // –†–ï–ù–î–ï–† –°–ü–ò–°–ö–ê –®–ê–ë–õ–û–ù–û–í –í –ù–ê–°–¢–†–û–ô–ö–ê–•
      function renderTemplatesAdmin() {
        const container = document.getElementById('package-templates-list');
        if (!container) return;

        container.innerHTML = '';

        const templates = DB.packageTemplates || [];

        if (templates.length === 0) {
          container.innerHTML = '<div class="text-slate-500 text-sm">–ù–µ—Ç —à–∞–±–ª–æ–Ω–æ–≤</div>';
          return;
        }

        templates.forEach(tpl => {
          const card = document.createElement('div');
          card.className = 'glass rounded-xl p-3 mb-2';

          const wrapper = document.createElement('div');
          wrapper.className = 'flex justify-between items-start';

          // –õ–µ–≤–∞—è —á–∞—Å—Ç—å - –∏–Ω—Ñ–æ
          const infoDiv = document.createElement('div');
          infoDiv.className = 'flex-1';

          const nameDiv = document.createElement('div');
          nameDiv.className = 'font-bold text-amber-400 text-sm';
          nameDiv.textContent = tpl.name;

          const pricesDiv = document.createElement('div');
          pricesDiv.className = 'text-xs text-slate-300 mt-1';
          pricesDiv.textContent = `–ë–∞–∑–æ–≤—ã–π: ${Utils.formatPrice(tpl.basic.price)} ‚ÇΩ ‚Ä¢ –û–ø—Ç–∏–º–∞–ª: ${Utils.formatPrice(tpl.optimal.price)} ‚ÇΩ ‚Ä¢ –ü—Ä–µ–º–∏—É–º: ${Utils.formatPrice(tpl.premium.price)} ‚ÇΩ`;

          infoDiv.appendChild(nameDiv);
          infoDiv.appendChild(pricesDiv);

          // –ü—Ä–∞–≤–∞—è —á–∞—Å—Ç—å - –∫–Ω–æ–ø–∫–∏
          const buttonsDiv = document.createElement('div');
          buttonsDiv.className = 'flex gap-2';

          // –ö–Ω–æ–ø–∫–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
          const editBtn = document.createElement('button');
          editBtn.className = 'btn-icon';
          editBtn.title = '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å';
          const editIcon = document.createElement('i');
          editIcon.setAttribute('data-lucide', 'pencil');
          editIcon.className = 'w-4 h-4';
          editBtn.appendChild(editIcon);
          editBtn.addEventListener('click', async () => {
            await editTemplateInSettings(tpl);
          });

          // –ö–Ω–æ–ø–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è
          const delBtn = document.createElement('button');
          delBtn.className = 'btn-icon';
          delBtn.title = '–£–¥–∞–ª–∏—Ç—å';
          const delIcon = document.createElement('i');
          delIcon.setAttribute('data-lucide', 'trash-2');
          delIcon.className = 'w-4 h-4';
          delBtn.appendChild(delIcon);
          delBtn.addEventListener('click', async () => {
            if (await PremiumDialog.confirm({ message: `–£–¥–∞–ª–∏—Ç—å —à–∞–±–ª–æ–Ω "${tpl.name}"?`, danger: true, okText: '–î–∞', cancelText: '–û—Ç–º–µ–Ω–∞', icon: 'shield-alert' })) {
              const templates = DB.packageTemplates || [];
              const idx = templates.findIndex(t => t.id === tpl.id);
              if (idx >= 0) {
                templates.splice(idx, 1);
                DB.packageTemplates = templates;
                Storage.save();
                renderTemplatesAdmin();
                App.showToast('–£–¥–∞–ª–µ–Ω–æ');
              }
            }
          });

          buttonsDiv.appendChild(editBtn);
          buttonsDiv.appendChild(delBtn);

          wrapper.appendChild(infoDiv);
          wrapper.appendChild(buttonsDiv);
          card.appendChild(wrapper);

          container.appendChild(card);
        });

        if (window.lucide) lucide.createIcons();
      }

      // –ö–ù–û–ü–ö–ê –°–û–ó–î–ê–ù–ò–Ø –®–ê–ë–õ–û–ù–ê
      const createBtn = document.getElementById('btn-create-template');
      if (createBtn) {
        createBtn.addEventListener('click', async () => {
          const templateName = await PremiumDialog.prompt({ title: '–ù–∞–∑–≤–∞–Ω–∏–µ —à–∞–±–ª–æ–Ω–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä: –°–≤–∞–¥—å–±–∞, –í—ã–ø—É—Å–∫–Ω–æ–π, –ö–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤):', defaultValue: '', okText: '–î–∞–ª–µ–µ', cancelText: '–û—Ç–º–µ–Ω–∞', icon: 'edit-3' });
          if (!templateName || !templateName.trim()) {
            await PremiumDialog.alert({ message: '–û—Ç–º–µ–Ω–µ–Ω–æ', okText: '–û–∫', icon: 'sparkles' });
            return;
          }

          await PremiumDialog.alert({ message: '–°–µ–π—á–∞—Å –∑–∞–ø–æ–ª–Ω–∏–º 3 –ø–∞–∫–µ—Ç–∞: –ë–∞–∑–æ–≤—ã–π, –û–ø—Ç–∏–º–∞–ª, –ü—Ä–µ–º–∏—É–º', okText: '–û–∫', icon: 'sparkles' });

          // ===== –ë–ê–ó–û–í–´–ô =====
          await PremiumDialog.alert({ message: 'üì¶ –ë–ê–ó–û–í–´–ô –ü–ê–ö–ï–¢', okText: '–û–∫', icon: 'sparkles' });

          const basicDesc = await PremiumDialog.prompt({ title: '–ë–ê–ó–û–í–´–ô ‚Äî –û–ø–∏—Å–∞–Ω–∏–µ (—á—Ç–æ –≤—Ö–æ–¥–∏—Ç):\n\n–ù–∞–ø—Ä–∏–º–µ—Ä: –ú–∏–∫—Ä–æ–º–∞–≥–∏—è 60 –º–∏–Ω—É—Ç, —Ñ–æ–∫—É—Å—ã —Å –∫–∞—Ä—Ç–∞–º–∏', defaultValue: '', okText: '–î–∞–ª–µ–µ', cancelText: '–û—Ç–º–µ–Ω–∞', icon: 'edit-3' });
          if (basicDesc === null) return;

          const basicBonuses = await PremiumDialog.prompt({ title: '–ë–ê–ó–û–í–´–ô ‚Äî –ë–æ–Ω—É—Å—ã (—á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é):\n\n–ù–∞–ø—Ä–∏–º–µ—Ä: –ú–∏–Ω–∏-—Å—É–≤–µ–Ω–∏—Ä –≥–æ—Å—Ç—è–º', defaultValue: '', okText: '–î–∞–ª–µ–µ', cancelText: '–û—Ç–º–µ–Ω–∞', icon: 'edit-3' });

          const basicPrice = await PremiumDialog.prompt({ title: '–ë–ê–ó–û–í–´–ô ‚Äî –ë–∞–∑–æ–≤–∞—è —Ü–µ–Ω–∞ (‚ÇΩ):', defaultValue: '50000', okText: '–î–∞–ª–µ–µ', cancelText: '–û—Ç–º–µ–Ω–∞', icon: 'edit-3' });
          if (!basicPrice) return;

          // ===== –û–ü–¢–ò–ú–ê–õ =====
          await PremiumDialog.alert({ message: 'üì¶ –û–ü–¢–ò–ú–ê–õ –ü–ê–ö–ï–¢', okText: '–û–∫', icon: 'sparkles' });

          const optimalDesc = await PremiumDialog.prompt({ title: '–û–ü–¢–ò–ú–ê–õ ‚Äî –û–ø–∏—Å–∞–Ω–∏–µ (—á—Ç–æ –≤—Ö–æ–¥–∏—Ç):\n\n–ù–∞–ø—Ä–∏–º–µ—Ä: –ú–∏–∫—Ä–æ–º–∞–≥–∏—è 90 –º–∏–Ω—É—Ç, —Ñ–æ–∫—É—Å—ã —Å –∫–∞—Ä—Ç–∞–º–∏, —à–æ—É —Å –≥–æ–ª—É–±—è–º–∏', defaultValue: '', okText: '–î–∞–ª–µ–µ', cancelText: '–û—Ç–º–µ–Ω–∞', icon: 'edit-3' });
          if (optimalDesc === null) return;

          const optimalBonuses = await PremiumDialog.prompt({ title: '–û–ü–¢–ò–ú–ê–õ ‚Äî –ë–æ–Ω—É—Å—ã (—á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é):\n\n–ù–∞–ø—Ä–∏–º–µ—Ä: –ú–∏–Ω–∏-—Å—É–≤–µ–Ω–∏—Ä –≥–æ—Å—Ç—è–º, —Ñ–æ—Ç–æ/–≤–∏–¥–µ–æ —Å —Ñ–∏—à–∫–æ–π', defaultValue: '', okText: '–î–∞–ª–µ–µ', cancelText: '–û—Ç–º–µ–Ω–∞', icon: 'edit-3' });

          const optimalPrice = await PremiumDialog.prompt({ title: '–û–ü–¢–ò–ú–ê–õ ‚Äî –ë–∞–∑–æ–≤–∞—è —Ü–µ–Ω–∞ (‚ÇΩ):', defaultValue: '75000', okText: '–î–∞–ª–µ–µ', cancelText: '–û—Ç–º–µ–Ω–∞', icon: 'edit-3' });
          if (!optimalPrice) return;

          // ===== –ü–†–ï–ú–ò–£–ú =====
          await PremiumDialog.alert({ message: 'üì¶ –ü–†–ï–ú–ò–£–ú –ü–ê–ö–ï–¢', okText: '–û–∫', icon: 'sparkles' });

          const premiumDesc = await PremiumDialog.prompt({ title: '–ü–†–ï–ú–ò–£–ú ‚Äî –û–ø–∏—Å–∞–Ω–∏–µ (—á—Ç–æ –≤—Ö–æ–¥–∏—Ç):\n\n–ù–∞–ø—Ä–∏–º–µ—Ä: –ú–∏–∫—Ä–æ–º–∞–≥–∏—è 120 –º–∏–Ω—É—Ç, —Ñ–æ–∫—É—Å—ã —Å –∫–∞—Ä—Ç–∞–º–∏, —à–æ—É —Å –≥–æ–ª—É–±—è–º–∏, –ª–µ–≤–∏—Ç–∞—Ü–∏—è', defaultValue: '', okText: '–î–∞–ª–µ–µ', cancelText: '–û—Ç–º–µ–Ω–∞', icon: 'edit-3' });
          if (premiumDesc === null) return;

          const premiumBonuses = await PremiumDialog.prompt({ title: '–ü–†–ï–ú–ò–£–ú ‚Äî –ë–æ–Ω—É—Å—ã (—á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é):\n\n–ù–∞–ø—Ä–∏–º–µ—Ä: –í—Å–µ –≤–∫–ª—é—á–µ–Ω–æ, —Å—É–≤–µ–Ω–∏—Ä—ã –≤—Å–µ–º –≥–æ—Å—Ç—è–º', defaultValue: '', okText: '–î–∞–ª–µ–µ', cancelText: '–û—Ç–º–µ–Ω–∞', icon: 'edit-3' });

          const premiumPrice = await PremiumDialog.prompt({ title: '–ü–†–ï–ú–ò–£–ú ‚Äî –ë–∞–∑–æ–≤–∞—è —Ü–µ–Ω–∞ (‚ÇΩ):', defaultValue: '120000', okText: '–î–∞–ª–µ–µ', cancelText: '–û—Ç–º–µ–Ω–∞', icon: 'edit-3' });
          if (!premiumPrice) return;

          // –°–æ–±–∏—Ä–∞–µ–º –¥–∞–Ω–Ω—ã–µ
          const template = {
            id: 'tpl_' + Date.now(),
            name: templateName.trim(),
            basic: {
              name: templateName.trim() + ' ‚Äî –ë–∞–∑–æ–≤—ã–π',
              price: parseInt(basicPrice) || 50000,
              description: basicDesc.trim(),
              bonuses: basicBonuses ? basicBonuses.split(',').map(b => b.trim()).filter(b => b) : []
            },
            optimal: {
              name: templateName.trim() + ' ‚Äî –û–ø—Ç–∏–º–∞–ª',
              price: parseInt(optimalPrice) || 75000,
              description: optimalDesc.trim(),
              bonuses: optimalBonuses ? optimalBonuses.split(',').map(b => b.trim()).filter(b => b) : []
            },
            premium: {
              name: templateName.trim() + ' ‚Äî –ü—Ä–µ–º–∏—É–º',
              price: parseInt(premiumPrice) || 120000,
              description: premiumDesc.trim(),
              bonuses: premiumBonuses ? premiumBonuses.split(',').map(b => b.trim()).filter(b => b) : []
            }
          };

          // –°–æ—Ö—Ä–∞–Ω—è–µ–º
          if (!DB.packageTemplates) DB.packageTemplates = [];
          DB.packageTemplates.push(template);
          Storage.save();
          renderTemplatesAdmin();

          await PremiumDialog.alert({
            message: '‚úÖ –®–∞–±–ª–æ–Ω "' + templateName + '" —Å–æ–∑–¥–∞–Ω!\n\n' +
              'üì¶ –ë–∞–∑–æ–≤—ã–π: ' + Utils.formatPrice(template.basic.price) + ' ‚ÇΩ\n' +
              'üì¶ –û–ø—Ç–∏–º–∞–ª: ' + Utils.formatPrice(template.optimal.price) + ' ‚ÇΩ\n' +
              'üì¶ –ü—Ä–µ–º–∏—É–º: ' + Utils.formatPrice(template.premium.price) + ' ‚ÇΩ', okText: '–û–∫', icon: 'sparkles'
          });
        });
      }

      // –ö–ù–û–ü–ö–ê –°–û–ó–î–ê–ù–ò–Ø –®–ê–ë–õ–û–ù–ê –û–¢–í–ï–¢–ê
      const btnCreateResponse = document.getElementById('btn-create-response');
      if (btnCreateResponse) {
        btnCreateResponse.addEventListener('click', createResponseTemplate);
      }
    });




    /* ============================================
       PREMIUM DIALOG (replaces native prompt/confirm)
       ============================================ */
    window.PremiumDialog = (() => {
      let overlay, card, titleEl, msgEl, inputEl, textareaEl, activePromptEl, okBtn, cancelBtn, iconWrap;
      let resolver = null;
      let mode = 'confirm';

      const ensure = () => {
        if (overlay) return;

        overlay = document.createElement('div');
        overlay.id = 'premium-dialog-overlay';
        overlay.innerHTML = `
      <div id="premium-dialog" role="dialog" aria-modal="true">
        <div class="pd-head">
          <div class="pd-icon"><span id="pd-icon-inner"></span></div>
          <div class="pd-text">
            <div class="pd-title" id="pd-title"></div>
            <div class="pd-msg" id="pd-msg"></div>
          </div>
        </div>
        <div class="pd-body" id="pd-body"></div>
        <div class="pd-actions">
          <button class="pd-btn ghost" id="pd-cancel" type="button">–û—Ç–º–µ–Ω–∞</button>
          <button class="pd-btn ok" id="pd-ok" type="button">–û–∫</button>
        </div>
      </div>
    `;
        document.body.appendChild(overlay);

        card = overlay.querySelector('#premium-dialog');
        titleEl = overlay.querySelector('#pd-title');
        msgEl = overlay.querySelector('#pd-msg');
        okBtn = overlay.querySelector('#pd-ok');
        cancelBtn = overlay.querySelector('#pd-cancel');
        iconWrap = overlay.querySelector('#pd-icon-inner');

        const body = overlay.querySelector('#pd-body');

        inputEl = document.createElement('input');
        inputEl.className = 'pd-input';
        inputEl.type = 'text';
        inputEl.autocomplete = 'off';
        inputEl.autocapitalize = 'sentences';
        inputEl.spellcheck = false;

        // Multiline input for templates / long text
        textareaEl = document.createElement('textarea');
        textareaEl.className = 'pd-input';
        textareaEl.autocomplete = 'off';
        textareaEl.autocapitalize = 'sentences';
        textareaEl.spellcheck = false;
        textareaEl.rows = 7;
        textareaEl.style.resize = 'none';
        textareaEl.style.minHeight = '140px';
        textareaEl.style.whiteSpace = 'pre-wrap';

        // Tab = indentation inside textarea
        textareaEl.addEventListener('keydown', (e) => {
          if (e.key !== 'Tab') return;
          e.preventDefault();
          const start = textareaEl.selectionStart || 0;
          const end = textareaEl.selectionEnd || 0;
          const value = textareaEl.value || '';
          const insertText = '  ';
          textareaEl.value = value.slice(0, start) + insertText + value.slice(end);
          const pos = start + insertText.length;
          textareaEl.selectionStart = textareaEl.selectionEnd = pos;
        });

        const close = (value) => {
          overlay.classList.remove('active');
          document.body.style.overflow = '';
          document.removeEventListener('keydown', onKeyDown, true);

          const r = resolver;
          resolver = null;
          if (r) r(value);
        };

        const onKeyDown = (e) => {
          if (!overlay.classList.contains('active')) return;
          if (e.key === 'Escape') {
            e.preventDefault();
            close(mode === 'alert' ? true : (mode === 'prompt' ? null : false));
          }
          if (e.key === 'Enter') {
            if (mode === 'prompt') {
              const el = activePromptEl || inputEl;
              const isTextarea = el && el.tagName === 'TEXTAREA';
              // In textarea: Enter creates a new line; Ctrl/‚åò+Enter saves
              if (isTextarea && !(e.ctrlKey || e.metaKey)) return;

              e.preventDefault();
              close(el ? el.value : '');
            } else {
              e.preventDefault();
              close(true);
            }
          }
        };

        okBtn.addEventListener('click', () => {
          if (mode === 'prompt') close((activePromptEl || inputEl).value);
          else close(true);
        });

        cancelBtn.addEventListener('click', () => {
          close(mode === 'alert' ? true : (mode === 'prompt' ? null : false));
        });

        overlay.addEventListener('click', (e) => {
          if (e.target === overlay) cancelBtn.click();
        });

        // expose helpers
        ensure._body = body;
        ensure._close = close;
        ensure._onKeyDown = onKeyDown;
      };

      const setIcon = (name, danger) => {
        // Use lucide if present; otherwise fallback to simple symbol
        iconWrap.innerHTML = '';
        const span = document.createElement('span');
        span.style.display = 'inline-flex';
        span.style.alignItems = 'center';
        span.style.justifyContent = 'center';
        span.style.width = '22px';
        span.style.height = '22px';
        span.style.color = danger ? '#fecaca' : '#fde68a';

        if (window.lucide && typeof window.lucide.createIcons === 'function') {
          const i = document.createElement('i');
          i.setAttribute('data-lucide', name || (danger ? 'alert-triangle' : 'sparkles'));
          i.style.width = '22px';
          i.style.height = '22px';
          span.appendChild(i);
          iconWrap.appendChild(span);
          try { window.lucide.createIcons(); } catch (e) { }
        } else {
          span.textContent = danger ? '!' : '‚ú¶';
          iconWrap.appendChild(span);
        }
      };

      const open = (opts = {}) => {
        ensure();
        mode = opts.mode || 'confirm';

        titleEl.textContent = (opts.title ?? (mode === 'prompt' ? '–í–≤–µ–¥–∏—Ç–µ –∑–Ω–∞—á–µ–Ω–∏–µ' : '–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ'));
        msgEl.textContent = (opts.message ?? '');

        const danger = !!opts.danger;
        setIcon(opts.icon, danger);

        okBtn.textContent = opts.okText || (mode === 'prompt' ? '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å' : '–û–∫');
        cancelBtn.textContent = opts.cancelText || '–û—Ç–º–µ–Ω–∞';
        cancelBtn.style.display = (mode === 'alert') ? 'none' : 'inline-flex';

        okBtn.classList.remove('danger');
        okBtn.classList.add('ok');
        if (danger) okBtn.classList.add('danger');

        // body
        ensure._body.innerHTML = '';
        activePromptEl = null;
        if (mode === 'prompt') {
          const multiline = !!opts.multiline;
          activePromptEl = multiline ? textareaEl : inputEl;

          activePromptEl.value = (opts.defaultValue ?? '');
          activePromptEl.placeholder = (opts.placeholder ?? '');

          if (multiline) {
            activePromptEl.rows = (opts.rows ?? 7);
            if (opts.minHeight) activePromptEl.style.minHeight = String(opts.minHeight);
          }

          ensure._body.appendChild(activePromptEl);
        }

        overlay.classList.add('active');
        document.body.style.overflow = 'hidden';
        document.addEventListener('keydown', ensure._onKeyDown, true);

        // focus
        setTimeout(() => {
          try {
            if (mode === 'prompt') {
              const el = activePromptEl || inputEl;
              el.focus();
              // –°–Ω–∏–º–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ —á—Ç–æ–±—ã –º–æ–∂–Ω–æ –±—ã–ª–æ —Å—Ä–∞–∑—É —Å–∫—Ä–æ–ª–ª–∏—Ç—å
              if (el.setSelectionRange) {
                const len = (el.value || '').length;
                el.setSelectionRange(len, len);
              }
            } else {
              okBtn.focus();
            }
          } catch (e) { }
        }, 0);

        return new Promise((resolve) => { resolver = resolve; });
      };

      const confirm = (opts) => open({ ...(typeof opts === 'string' ? { message: opts } : opts), mode: 'confirm' });
      const prompt = (opts) => open({ ...(typeof opts === 'string' ? { title: opts } : opts), mode: 'prompt' });
      const alert = async (opts) => { await open({ ...(typeof opts === 'string' ? { message: opts } : opts), mode: 'alert', okText: (opts && opts.okText) || '–û–∫' }); return true; };

      return { open, confirm, prompt, alert };
    })();




    // ============================================
    // –õ–ò–¶–ï–ù–ó–ò–û–ù–ù–ê–Ø –ó–ê–©–ò–¢–ê
    // ============================================

    (function () {
      'use strict';

      // –§—É–Ω–∫—Ü–∏—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Ö–µ—à–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
      function getDeviceId() {
        const nav = navigator;
        const screen = window.screen;

        const components = [
          nav.userAgent,
          nav.language,
          screen.colorDepth,
          screen.width + 'x' + screen.height,
        ];

        let hash = 0;
        const str = components.join('|');
        for (let i = 0; i < str.length; i++) {
          const char = str.charCodeAt(i);
          hash = ((hash << 5) - hash) + char;
          hash = hash & hash;
        }

        return 'DEV-' + Math.abs(hash).toString(36).toUpperCase();
      }

      // –§—É–Ω–∫—Ü–∏—è –ø–æ–ª—É—á–µ–Ω–∏—è Installation ID
      function getInstallationId() {
        const storageKey = 'illusionist_install_id';
        let installId = localStorage.getItem(storageKey);

        if (!installId) {
          // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –Ω–æ–≤—ã–π Installation ID
          const timestamp = Date.now().toString(36);
          const random = Math.random().toString(36).substring(2, 14);
          installId = 'INST-' + (timestamp + random).toUpperCase();
          localStorage.setItem(storageKey, installId);
          console.log('üÜï Generated new Installation ID:', installId);
        }

        return installId;
      }

      // –§—É–Ω–∫—Ü–∏—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –ª–∏—Ü–µ–Ω–∑–∏–æ–Ω–Ω–æ–≥–æ –∫–ª—é—á–∞
      function validateLicense(key) {
        if (!key || key.length !== 19) return false;

        const parts = key.split('-');
        if (parts.length !== 4) return false;

        const check = parts[3];
        const data = parts.slice(0, 3).join('');

        let sum = 0;
        for (let i = 0; i < data.length; i++) {
          sum += data.charCodeAt(i);
        }

        const expected = (sum % 10000).toString(36).toUpperCase().padStart(4, '0');
        return check === expected;
      }

      // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–∫—Ç–∏–≤–∞—Ü–∏–∏
      // ============================================
      // DEMO MODE - –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
      // ============================================
      // –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ true —á—Ç–æ–±—ã –í–°–ï–ì–î–ê –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å —ç–∫—Ä–∞–Ω –∞–∫—Ç–∏–≤–∞—Ü–∏–∏
      // –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ false –¥–ª—è –Ω–æ—Ä–º–∞–ª—å–Ω–æ–π —Ä–∞–±–æ—Ç—ã (production)
      const DEMO_MODE = false;  // ‚úÖ PRODUCTION - –Ω–æ—Ä–º–∞–ª—å–Ω–∞—è —Ä–∞–±–æ—Ç–∞

      // ============================================
      // –ü–†–û–í–ï–†–ö–ê –ê–ö–¢–ò–í–ê–¶–ò–ò (—Å Firebase)
      // ============================================
      async function checkActivation() {
        // –ï—Å–ª–∏ DEMO MODE - –≤—Å–µ–≥–¥–∞ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º false (–Ω–µ—Ç –ª–∏—Ü–µ–Ω–∑–∏–∏)
        if (DEMO_MODE) {
          return false;
        }

        const stored = localStorage.getItem('illusionist_license');

        if (stored) {
          try {
            const data = JSON.parse(atob(stored));

            if (!validateLicense(data.key)) {
              console.log('‚ùå Invalid license format');
              return false;
            }

            // –û–ù–õ–ê–ô–ù –ü–†–û–í–ï–†–ö–ê —á–µ—Ä–µ–∑ Firebase (–µ—Å–ª–∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω)
            if (window.firebaseEnabled && window.firebaseDB) {
              try {
                const keyRef = window.firebaseDB.ref('licenses/' + data.key.replace(/[\.#$\[\]]/g, '-'));
                const snapshot = await keyRef.once('value');
                const firebaseData = snapshot.val();

                if (!firebaseData) {
                  console.log('‚ùå License key not found in database');
                  return false;
                }

                if (!firebaseData.activated) {
                  console.log('‚ö†Ô∏è License not activated yet');
                  return false;
                }

                // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è
                const activated = new Date(firebaseData.activatedDate);
                const now = new Date();
                const daysDiff = (now - activated) / (1000 * 60 * 60 * 24);

                if (daysDiff > 365) {
                  console.log('‚è∞ License expired');
                  return 'expired';
                }

                console.log('‚úÖ License valid (Firebase)');
                return true;

              } catch (firebaseError) {
                console.error('‚ö†Ô∏è Firebase check failed, falling back to local:', firebaseError);
                // –ï—Å–ª–∏ Firebase –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω, –ø—Ä–æ–≤–µ—Ä—è–µ–º –ª–æ–∫–∞–ª—å–Ω–æ
              }
            }

            // –õ–û–ö–ê–õ–¨–ù–ê–Ø –ü–†–û–í–ï–†–ö–ê (–µ—Å–ª–∏ Firebase –æ—Ç–∫–ª—é—á–µ–Ω –∏–ª–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω)
            const activated = new Date(data.activated);
            const now = new Date();
            const daysDiff = (now - activated) / (1000 * 60 * 60 * 24);

            if (daysDiff > 365) {
              console.log('‚è∞ License expired (local)');
              return 'expired';
            }

            console.log('‚úÖ License valid (local)');
            return true;
          } catch (e) {
            console.error('‚ùå Error checking activation:', e);
            return false;
          }
        }

        console.log('‚ö†Ô∏è No license found');
        return false;
      }

      // ============================================
      // –ê–ö–¢–ò–í–ê–¶–ò–Ø –õ–ò–¶–ï–ù–ó–ò–ò (—Å Firebase)
      // ============================================
      async function activateLicense(key) {
        if (!validateLicense(key)) {
          return { success: false, error: '–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –∫–ª—é—á–∞' };
        }

        const deviceId = getDeviceId();
        const installId = getInstallationId();

        // –û–ù–õ–ê–ô–ù –ê–ö–¢–ò–í–ê–¶–ò–Ø —á–µ—Ä–µ–∑ Firebase (–µ—Å–ª–∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω)
        if (window.firebaseEnabled && window.firebaseDB) {
          try {
            const keyRef = window.firebaseDB.ref('licenses/' + key.replace(/[\.#$\[\]]/g, '-'));
            const snapshot = await keyRef.once('value');
            const existingData = snapshot.val();

            if (!existingData) {
              return {
                success: false,
                error: '–ö–ª—é—á –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö.\n–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç—å –∫–ª—é—á–∞ –∏–ª–∏ –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –ø—Ä–æ–¥–∞–≤—Ü—É.'
              };
            }

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º: –∫–ª—é—á —É–∂–µ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω?
            if (existingData.activated) {
              // –ü—Ä–æ–≤–µ—Ä—è–µ–º: —ç—Ç–æ —Ç–æ –∂–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ?
              if (existingData.deviceId === deviceId) {
                // –ü–µ—Ä–µ–∞–∫—Ç–∏–≤–∞—Ü–∏—è –Ω–∞ —Ç–æ–º –∂–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ - OK
                console.log('‚úÖ Re-activation on same device');
              } else {
                // –ü–æ–ø—ã—Ç–∫–∞ –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ –Ω–∞ –¥—Ä—É–≥–æ–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ!
                return {
                  success: false,
                  error: '–≠—Ç–æ—Ç –∫–ª—é—á —É–∂–µ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω –Ω–∞ –¥—Ä—É–≥–æ–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ!\n\n–ö–∞–∂–¥—ã–π –∫–ª—é—á —Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ –Ω–∞ –æ–¥–Ω–æ–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ.'
                };
              }
            }

            // –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º –∫–ª—é—á
            await keyRef.update({
              activated: true,
              deviceId: deviceId,
              installId: installId,
              activatedDate: new Date().toISOString(),
              lastCheck: new Date().toISOString()
            });

            console.log('‚úÖ License activated in Firebase');

          } catch (firebaseError) {
            console.error('‚ö†Ô∏è Firebase activation failed:', firebaseError);
            return {
              success: false,
              error: '–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —Å–µ—Ä–≤–µ—Ä—É.\n–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç-—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ.'
            };
          }
        } else {
          console.warn('‚ö†Ô∏è Firebase not enabled, activating locally only');
        }

        // –õ–û–ö–ê–õ–¨–ù–û–ï –°–û–•–†–ê–ù–ï–ù–ò–ï
        const data = {
          key: key,
          device: deviceId,
          install: installId,
          activated: new Date().toISOString()
        };

        const encoded = btoa(JSON.stringify(data));
        localStorage.setItem('illusionist_license', encoded);

        console.log('‚úÖ License activated locally');
        return { success: true };
      }

      // UI –¥–ª—è –≤–≤–æ–¥–∞ –∫–ª—é—á–∞
      function showLicensePrompt(reason) {
        const overlay = document.createElement('div');
        overlay.id = 'license-overlay';
        overlay.style.cssText = `
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.95);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 999999;
      font-family: 'Inter', -apple-system, sans-serif;
    `;

        const box = document.createElement('div');
        box.style.cssText = `
      background: linear-gradient(135deg, rgba(26,26,46,0.98), rgba(15,15,25,0.98));
      border: 2px solid rgba(245,158,11,0.5);
      border-radius: 16px;
      padding: 32px;
      max-width: 400px;
      width: 90%;
      text-align: center;
      box-shadow: 0 20px 60px rgba(0,0,0,0.5);
    `;

        const title = document.createElement('h2');
        title.textContent = reason === 'expired' ? '–ü—Ä–æ–¥–ª–µ–Ω–∏–µ –ª–∏—Ü–µ–Ω–∑–∏–∏' : '–ê–∫—Ç–∏–≤–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è';
        title.style.cssText = `
      font-family: 'Cinzel', serif;
      font-size: 24px;
      background: linear-gradient(135deg, #f59e0b, #fbbf24);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      margin-bottom: 16px;
    `;

        const subtitle = document.createElement('p');
        subtitle.textContent = reason === 'expired'
          ? '–í–∞—à–∞ –ª–∏—Ü–µ–Ω–∑–∏—è –∏—Å—Ç–µ–∫–ª–∞. –í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤—ã–π –∫–ª—é—á.'
          : '–í–≤–µ–¥–∏—Ç–µ –ª–∏—Ü–µ–Ω–∑–∏–æ–Ω–Ω—ã–π –∫–ª—é—á –¥–ª—è –∞–∫—Ç–∏–≤–∞—Ü–∏–∏';
        subtitle.style.cssText = `
      color: rgba(148,163,184,0.8);
      margin-bottom: 24px;
      font-size: 14px;
    `;

        const input = document.createElement('input');
        input.type = 'text';
        input.placeholder = 'XXXX-XXXX-XXXX-XXXX';
        input.maxLength = 19;
        input.style.cssText = `
      width: 100%;
      padding: 12px 16px;
      border: 1px solid rgba(245,158,11,0.3);
      background: rgba(0,0,0,0.3);
      color: #f8fafc;
      border-radius: 8px;
      font-size: 16px;
      font-family: monospace;
      text-align: center;
      text-transform: uppercase;
      margin-bottom: 16px;
    `;

        input.addEventListener('input', function (e) {
          let value = e.target.value.replace(/[^A-Z0-9]/gi, '').toUpperCase();
          let formatted = '';
          for (let i = 0; i < value.length && i < 16; i++) {
            if (i > 0 && i % 4 === 0) formatted += '-';
            formatted += value[i];
          }
          e.target.value = formatted;
        });

        const button = document.createElement('button');
        button.textContent = '–ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å';
        button.style.cssText = `
      width: 100%;
      padding: 12px;
      background: linear-gradient(135deg, #f59e0b, #fbbf24);
      border: none;
      border-radius: 8px;
      color: #0a0a0f;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.2s;
    `;

        const error = document.createElement('div');
        error.style.cssText = `
      color: #ef4444;
      font-size: 14px;
      margin-top: 12px;
      min-height: 20px;
    `;

        button.addEventListener('click', async () => {
          const key = input.value.trim();

          // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É
          button.textContent = '‚è≥ –ü—Ä–æ–≤–µ—Ä–∫–∞...';
          button.disabled = true;
          input.disabled = true;

          try {
            const result = await activateLicense(key);

            if (result.success) {
              // –£—Å–ø–µ—Ö!
              button.textContent = '‚úÖ –ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–æ!';
              button.style.background = 'linear-gradient(135deg, #22c55e, #16a34a)';
              button.style.color = '#fff';

              // –ó–∞–¥–µ—Ä–∂–∫–∞ 1.5—Å —á—Ç–æ–±—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–≤–∏–¥–µ–ª "–ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–æ!"
              setTimeout(function () {
                // –ü–ª–∞–≤–Ω–æ —É–±–∏—Ä–∞–µ–º –æ–∫–Ω–æ –∞–∫—Ç–∏–≤–∞—Ü–∏–∏
                overlay.style.transition = 'opacity 0.6s';
                overlay.style.opacity = '0';

                setTimeout(function () {
                  document.body.removeChild(overlay);

                  // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–∞–≥–∏—á–µ—Å–∫—É—é –∞–Ω–∏–º–∞—Ü–∏—é
                  if (typeof window.showMagicAfterActivation === 'function') {
                    window.showMagicAfterActivation();
                  }

                  // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –ø–æ—Å–ª–µ –º–∞–≥–∏—á–µ—Å–∫–æ–π –∞–Ω–∏–º–∞—Ü–∏–∏ (—á–µ—Ä–µ–∑ 3 —Å–µ–∫)
                  setTimeout(function () {
                    if (typeof window.showApp === 'function') {
                      window.showApp();
                    }
                  }, 3000);
                }, 600);
              }, 1500);

            } else {
              // –û—à–∏–±–∫–∞ –∞–∫—Ç–∏–≤–∞—Ü–∏–∏
              button.textContent = 'üîë –ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å';
              button.disabled = false;
              input.disabled = false;

              error.textContent = result.error || '–ù–µ–≤–µ—Ä–Ω—ã–π –∫–ª—é—á';
              input.style.borderColor = '#ef4444';
              setTimeout(() => {
                input.style.borderColor = 'rgba(245,158,11,0.3)';
              }, 2000);
            }
          } catch (err) {
            // –û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–µ–ø—Ä–µ–¥–≤–∏–¥–µ–Ω–Ω—ã—Ö –æ—à–∏–±–æ–∫
            console.error('Activation error:', err);
            button.textContent = 'üîë –ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å';
            button.disabled = false;
            input.disabled = false;
            error.textContent = '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.';
            input.style.borderColor = '#ef4444';
            setTimeout(() => {
              input.style.borderColor = 'rgba(245,158,11,0.3)';
            }, 2000);
          }
        });

        input.addEventListener('keypress', (e) => {
          if (e.key === 'Enter') button.click();
        });

        box.appendChild(title);
        box.appendChild(subtitle);
        box.appendChild(input);
        box.appendChild(button);
        box.appendChild(error);
        overlay.appendChild(box);
        document.body.appendChild(overlay);

        input.focus();
      }

      // –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º —Ñ—É–Ω–∫—Ü–∏–∏ –≤ –≥–ª–æ–±–∞–ª—å–Ω—É—é –æ–±–ª–∞—Å—Ç—å –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∏–∑ –¥—Ä—É–≥–∏—Ö —Å–∫—Ä–∏–ø—Ç–æ–≤
      window.showLicensePrompt = showLicensePrompt;
      window.checkActivation = checkActivation;
      window.activateLicense = activateLicense;


      // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–∏—Ü–µ–Ω–∑–∏–∏ —É–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –∑–∞—Å—Ç–∞–≤–∫–æ–π (—Å–º. —Å–∫—Ä–∏–ø—Ç –≤ –Ω–∞—á–∞–ª–µ body)

    })();
  </script>

  <!-- –°–∫—Ä–∏–ø—Ç –¥–ª—è –∫–Ω–æ–ø–∫–∏ –ø—Ä–æ–∫—Ä—É—Ç–∫–∏ –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö -->
  <script>
    (function () {
      const settingsPanel = document.querySelector('#view-settings .panel');
      const toggleBtn = document.getElementById('settings-scroll-toggle');
      const icon = document.getElementById('scroll-toggle-icon');

      if (!settingsPanel || !toggleBtn) return;

      // SVG –ø—É—Ç–∏ –¥–ª—è —Å—Ç—Ä–µ–ª–æ–∫
      const arrowDownPath = '<path d="M12 5v14"/><path d="m19 12-7 7-7-7"/>';
      const arrowUpPath = '<path d="M12 19V5"/><path d="m5 12 7-7 7 7"/>';

      var direction = 'down'; // —Ç–µ–∫—É—â–µ–µ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
      var ticking = false;

      function updateIcon() {
        var scrollTop = settingsPanel.scrollTop;

        if (scrollTop > 150) {
          if (direction !== 'up') {
            direction = 'up';
            icon.innerHTML = arrowUpPath;
          }
        } else {
          if (direction !== 'down') {
            direction = 'down';
            icon.innerHTML = arrowDownPath;
          }
        }
        ticking = false;
      }

      // –°–ª—É—à–∞–µ–º —Å–∫—Ä–æ–ª–ª –ø–∞–Ω–µ–ª–∏ ‚Äî throttle —á–µ—Ä–µ–∑ rAF (1 —Ä–∞–∑ –∑–∞ –∫–∞–¥—Ä)
      settingsPanel.addEventListener('scroll', function () {
        if (!ticking) {
          ticking = true;
          requestAnimationFrame(updateIcon);
        }
      }, { passive: true });

      // –ö–ª–∏–∫ ‚Äî –ø—Ä–æ–∫—Ä—É—Ç–∫–∞ –≤–≤–µ—Ä—Ö –∏–ª–∏ –≤–Ω–∏–∑
      toggleBtn.addEventListener('click', function () {
        if (direction === 'down') {
          settingsPanel.scrollTo({ top: settingsPanel.scrollHeight, behavior: 'smooth' });
        } else {
          settingsPanel.scrollTo({ top: 0, behavior: 'smooth' });
        }
      });

      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º/—Å–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏/–∑–∞–∫—Ä—ã—Ç–∏–∏ –Ω–∞—Å—Ç—Ä–æ–µ–∫
      const viewSettings = document.getElementById('view-settings');
      const observer = new MutationObserver(() => {
        const isOpen = viewSettings.classList.contains('active');
        if (isOpen) {
          // –°–±—Ä–æ—Å –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏
          settingsPanel.scrollTop = 0;
          direction = 'down';
          icon.innerHTML = arrowDownPath;
          toggleBtn.style.display = 'flex';
          if (window.lucide) lucide.createIcons();
        } else {
          toggleBtn.style.display = 'none';
        }
      });

      observer.observe(viewSettings, {
        attributes: true,
        attributeFilter: ['class']
      });
    })();

    // ============================================
    // –¢–ê–ö–¢–ò–õ–¨–ù–ê–Ø –í–ò–ë–†–ê–¶–ò–Ø –î–õ–Ø UI –ö–ù–û–ü–û–ö
    // ============================================
    (function() {
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–¥–µ—Ä–∂–∫—É Vibration API
      const isVibrationSupported = 'vibrate' in navigator;

      // –ü–∞—Ç—Ç–µ—Ä–Ω—ã –≤–∏–±—Ä–∞—Ü–∏–∏ (–≤ –º–∏–ª–ª–∏—Å–µ–∫—É–Ω–¥–∞—Ö)
      const HAPTIC = {
        light: 15,       // –õ–µ–≥–∫–∞—è –≤–∏–±—Ä–∞—Ü–∏—è
        medium: 25,      // –°—Ä–µ–¥–Ω—è—è –≤–∏–±—Ä–∞—Ü–∏—è
        strong: 40,      // –°–∏–ª—å–Ω–∞—è –≤–∏–±—Ä–∞—Ü–∏—è
        success: [15, 50, 15],  // –ü–∞—Ç—Ç–µ—Ä–Ω —É—Å–ø–µ—Ö–∞ (–¥–≤–∞ –±—ã—Å—Ç—Ä—ã—Ö –∏–º–ø—É–ª—å—Å–∞)
        error: [10, 50, 10, 50, 10]  // –ü–∞—Ç—Ç–µ—Ä–Ω –æ—à–∏–±–∫–∏
      };

      // –ì–ª–∞–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –≤–∏–±—Ä–∞—Ü–∏–∏
      window.hapticFeedback = function(type = 'medium') {
        if (!isVibrationSupported) return;
        const pattern = HAPTIC[type] || HAPTIC.medium;
        navigator.vibrate(pattern);
      };

      // –ñ–¥–µ–º –∑–∞–≥—Ä—É–∑–∫–∏ DOM
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initHaptics);
      } else {
        initHaptics();
      }

      function initHaptics() {
        console.log('‚úÖ UI Haptic feedback initialized', { supported: isVibrationSupported });

        // –í–ê–ñ–ù–û: –ü–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª—è–µ–º App.showToast —á—Ç–æ–±—ã –¥–æ–±–∞–≤–∏—Ç—å –≤–∏–±—Ä–∞—Ü–∏—é
        if (window.App && window.App.showToast) {
          const originalShowToast = window.App.showToast;

          window.App.showToast = function(message, duration) {
            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø –≤–∏–±—Ä–∞—Ü–∏–∏ –ø–æ —Å–æ–æ–±—â–µ–Ω–∏—é
            if (message.includes('—Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ') || message.includes('–¥–æ–±–∞–≤–ª–µ–Ω–∞') || message.includes('–≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞')) {
              hapticFeedback('success');  // –£—Å–ø–µ—à–Ω–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ - –¥–≤–∞ –∏–º–ø—É–ª—å—Å–∞
            } else if (message.includes('–û—à–∏–±–∫–∞') || message.includes('‚ùå')) {
              hapticFeedback('error');  // –û—à–∏–±–∫–∞ - –ø–∞—Ç—Ç–µ—Ä–Ω
            } else if (message.includes('–£–¥–∞–ª–µ–Ω–æ') || message.includes('—É–¥–∞–ª–µ–Ω–∞')) {
              hapticFeedback('medium');  // –£–¥–∞–ª–µ–Ω–∏–µ - –æ–¥–∏–Ω–æ—á–Ω–∞—è —Å—Ä–µ–¥–Ω—è—è
            } else {
              hapticFeedback('light');  // –û—Å—Ç–∞–ª—å–Ω–æ–µ - –ª–µ–≥–∫–∞—è
            }

            // –í—ã–∑—ã–≤–∞–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é
            return originalShowToast.call(this, message, duration);
          };
        }

        // –î–æ–±–∞–≤–ª—è–µ–º –≤–∏–±—Ä–∞—Ü–∏—é –Ω–∞ –∫–Ω–æ–ø–∫—É "–ó–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å –≤ –∫–∞–ª–µ–Ω–¥–∞—Ä—å"
        const calendarBtn = document.getElementById('btn-to-calendar');
        if (calendarBtn) {
          calendarBtn.addEventListener('click', () => {
            hapticFeedback('strong');  // –°–∏–ª—å–Ω–∞—è –≤–∏–±—Ä–∞—Ü–∏—è –¥–ª—è –≤–∞–∂–Ω–æ–≥–æ –¥–µ–π—Å—Ç–≤–∏—è
          });
        }

        // –î–æ–±–∞–≤–ª—è–µ–º –≤–∏–±—Ä–∞—Ü–∏—é –Ω–∞ –≤—Å–µ –∫–Ω–æ–ø–∫–∏ —Å –∫–ª–∞—Å—Å–æ–º btn-primary (–≥–ª–∞–≤–Ω—ã–µ –∫–Ω–æ–ø–∫–∏)
        document.querySelectorAll('.btn-primary').forEach(btn => {
          btn.addEventListener('click', () => {
            hapticFeedback('medium');
          });
        });

        // –î–æ–±–∞–≤–ª—è–µ–º –≤–∏–±—Ä–∞—Ü–∏—é –Ω–∞ –≤—Å–µ –∫–Ω–æ–ø–∫–∏ —Å –∫–ª–∞—Å—Å–æ–º btn-secondary
        document.querySelectorAll('.btn-secondary').forEach(btn => {
          btn.addEventListener('click', () => {
            hapticFeedback('light');
          });
        });

        // –î–æ–±–∞–≤–ª—è–µ–º –≤–∏–±—Ä–∞—Ü–∏—é –Ω–∞ –∫–Ω–æ–ø–∫–∏ —É–¥–∞–ª–µ–Ω–∏—è (—Å –∏–∫–æ–Ω–∫–æ–π trash)
        document.querySelectorAll('[data-lucide="trash-2"]').forEach(icon => {
          const button = icon.closest('button');
          if (button) {
            button.addEventListener('click', () => {
              hapticFeedback('medium');
            });
          }
        });
      }

      console.log('üì≥ Haptic feedback module loaded');
    })();
  </script>

  <!-- DRAWER: –ë—ã—Å—Ç—Ä—ã–µ –æ—Ç–≤–µ—Ç—ã (—Å–≤–∞–π–ø —Å–ø—Ä–∞–≤–∞) -->
  <div id="quick-responses-drawer" class="drawer-overlay">
    <div class="drawer-panel">
      <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ -->
      <div class="drawer-header">
        <div class="drawer-title">
          <i data-lucide="message-square-text" class="w-5 h-5 text-amber-400"></i>
          <span>–ë—ã—Å—Ç—Ä—ã–µ –æ—Ç–≤–µ—Ç—ã</span>
        </div>
        <button id="drawer-close" class="btn-icon" aria-label="–ó–∞–∫—Ä—ã—Ç—å">
          <i data-lucide="x" class="w-5 h-5"></i>
        </button>
      </div>

      <!-- –ü–æ–¥—Å–∫–∞–∑–∫–∞ -->
      <div class="drawer-hint">
        –ù–∞–∂–º–∏—Ç–µ –Ω–∞ —à–∞–±–ª–æ–Ω –¥–ª—è –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è
      </div>

      <!-- –°–ø–∏—Å–æ–∫ —à–∞–±–ª–æ–Ω–æ–≤ -->
      <div id="drawer-templates-list" class="drawer-content"></div>

      <!-- –ö–Ω–æ–ø–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è -->
      <div class="drawer-footer">
        <button id="drawer-add-template" class="btn-gold w-full">
          <i data-lucide="plus" class="w-4 h-4 mr-2"></i>
          –î–æ–±–∞–≤–∏—Ç—å —à–∞–±–ª–æ–Ω
        </button>
      </div>
    </div>
  </div>

</body>

</html>
<style>
  @media (min-width:388px) and (max-width:392px) {

    /* –°–ø–µ—Ü–∏–∞–ª—å–Ω–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞ –¥–ª—è iPhone 14 (390px) */
    .btn-icon,
    .btn-qty {
      width: 52px !important;
      height: 52px !important;
    }
  }
</style>