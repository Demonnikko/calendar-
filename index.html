<!DOCTYPE html>
<html lang="ru">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport"
    content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>–ö–∞–ª–µ–Ω–¥–∞—Ä—å</title>

  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="–ö–∞–ª–µ–Ω–¥–∞—Ä—å">
  <meta name="theme-color" content="#050507">
  <meta name="mobile-web-app-capable" content="yes">

  <!-- DNS Prefetch & Preconnect –¥–ª—è –±—ã—Å—Ç—Ä–æ–π –∑–∞–≥—Ä—É–∑–∫–∏ -->
  <link rel="dns-prefetch" href="https://www.gstatic.com">
  <link rel="preconnect" href="https://www.gstatic.com" crossorigin>
  <link rel="dns-prefetch" href="https://calc76-default-rtdb.firebaseio.com">

  <!-- Preload –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö —Ä–µ—Å—É—Ä—Å–æ–≤ -->
  <link rel="preload" href="tailwind.min.js" as="script">
  <link rel="preload" href="lucide.min.js" as="script">

  <!-- PWA Manifest -->
  <link rel="manifest" href="manifest.json">

  <!-- Apple Touch Icons -->
  <link rel="apple-touch-icon" href="icons/icon-152.png">
  <link rel="apple-touch-icon" sizes="72x72" href="icons/icon-72.png">
  <link rel="apple-touch-icon" sizes="96x96" href="icons/icon-96.png">
  <link rel="apple-touch-icon" sizes="128x128" href="icons/icon-128.png">
  <link rel="apple-touch-icon" sizes="144x144" href="icons/icon-144.png">
  <link rel="apple-touch-icon" sizes="152x152" href="icons/icon-152.png">
  <link rel="apple-touch-icon" sizes="180x180" href="icons/icon-192.png">
  <link rel="apple-touch-icon" sizes="192x192" href="icons/icon-192.png">
  <link rel="apple-touch-icon" sizes="512x512" href="icons/icon-512.png">

  <!-- Favicon -->
  <link rel="icon" type="image/png" sizes="32x32" href="icons/icon-72.png">
  <link rel="icon" type="image/png" sizes="16x16" href="icons/icon-72.png">

  <script src="tailwind.min.js"></script>
  <script src="lucide.min.js"></script>

  <!-- Firebase SDK - –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∞—è –∑–∞–≥—Ä—É–∑–∫–∞, –Ω–µ –±–ª–æ–∫–∏—Ä—É–µ—Ç –æ—Ñ—Ñ–ª–∞–π–Ω -->
  <script>
    // ============================================
    // FIREBASE CONFIGURATION
    // ============================================
    const FIREBASE_CONFIG = {
      apiKey: "AIzaSyBEL4XCzjmHaqu4RbTqNzEKPi2Vfc4LXSI",
      authDomain: "calc76.firebaseapp.com",
      databaseURL: "https://calc76-default-rtdb.firebaseio.com",
      projectId: "calc76",
      storageBucket: "calc76.firebasestorage.app",
      messagingSenderId: "972929668805",
      appId: "1:972929668805:web:de4aa4097f03b97d39c2ac"
    };

    window.firebaseDB = null;
    window.firebaseEnabled = false;

    function loadFirebaseSDK() {
      return new Promise(function (resolve) {
        var timeout = setTimeout(function () { resolve(false); }, 5000);
        var s1 = document.createElement('script');
        s1.src = 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js';
        s1.onload = function () {
          var s2 = document.createElement('script');
          s2.src = 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js';
          s2.onload = function () { clearTimeout(timeout); resolve(true); };
          s2.onerror = function () { clearTimeout(timeout); resolve(false); };
          document.head.appendChild(s2);
        };
        s1.onerror = function () { clearTimeout(timeout); resolve(false); };
        document.head.appendChild(s1);
      });
    }

    function initFirebase() {
      if (typeof firebase === 'undefined') {
        window.firebaseEnabled = false;
        console.log('üì¥ Firebase SDK –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω - —Ä–∞–±–æ—Ç–∞–µ–º –æ—Ñ—Ñ–ª–∞–π–Ω');
        return;
      }

      try {
        if (!firebase.apps.length) {
          firebase.initializeApp(FIREBASE_CONFIG);
        }
        window.firebaseDB = firebase.database();
        window.firebaseEnabled = true;
      } catch (error) {
        window.firebaseEnabled = false;
      }
    }

    loadFirebaseSDK().then(function (loaded) {
      initFirebase();
    });
  </script>

  <style>
    :root {
      --bg: #000000;
      --panel: rgba(255, 255, 255, .10);
      --panel2: rgba(255, 255, 255, .12);
      --stroke: rgba(255, 255, 255, .15);
      --gold: #f59e0b;
      --muted: #94a3b8;
      --text: #f1f5f9;
      --safe-top: env(safe-area-inset-top);
      --safe-bottom: env(safe-area-inset-bottom);
      --safe-left: env(safe-area-inset-left);
      --safe-right: env(safe-area-inset-right);
      --font-display: Georgia, 'Palatino Linotype', 'Book Antiqua', Palatino, 'Times New Roman', serif;
      --font-body: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Helvetica Neue', Arial, sans-serif;
      --font-mono: 'SF Mono', Monaco, 'Cascadia Code', 'Roboto Mono', Consolas, 'Courier New', monospace;
    }

    *,
    *::before,
    *::after {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      max-width: 100%;
    }

    html,
    body {
      height: 100%;
      background: var(--bg);
      color: var(--text);
      overflow-x: hidden !important;
      max-width: 100vw !important;
      width: 100% !important;
      height: -webkit-fill-available;
      scroll-behavior: smooth;
      font-size: 16px;
    }

    body {
      font-family: var(--font-body);
      overflow-x: hidden;
      min-height: 100vh;
      min-height: -webkit-fill-available;
      min-height: 100dvh;
      padding: 0;
      margin: 0;
      overscroll-behavior: none;
      -webkit-tap-highlight-color: transparent;
      -webkit-user-select: none;
      user-select: none;
      position: relative;
      background: #000000;
    }

    /* Hide ALL app content until fully loaded */
    #calendar-tab,
    #dashboard-tab,
    #bottom-nav,
    header {
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.4s ease-out, visibility 0.4s ease-out;
    }

    /* Show content only when app is fully loaded */
    body.app-ready #calendar-tab,
    body.app-ready #dashboard-tab,
    body.app-ready #bottom-nav,
    body.app-ready header {
      opacity: 1;
      visibility: visible;
    }

    /* Touch optimization */
    * {
      -webkit-touch-callout: none;
      -webkit-tap-highlight-color: transparent;
    }

    input,
    textarea {
      -webkit-user-select: text;
      user-select: text;
    }

    h1,
    h2,
    h3 {
      font-family: var(--font-display);
      font-weight: 600;
      letter-spacing: 0.05em;
    }


    /* TAB SYSTEM */
    .tab-content {
      display: none;
      position: fixed;
      top: var(--safe-top);
      left: var(--safe-left);
      right: var(--safe-right);
      bottom: var(--safe-bottom);
      width: auto;
      height: auto;
      z-index: 1;
    }

    .tab-content.active {
      display: flex;
      flex-direction: column;
    }

    /* PREMIUM GLASS PANEL */
    .glass-panel {
      background: transparent;
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
      border: 1.5px solid rgba(245, 158, 11, 0.2);
      box-shadow: none;
      border-radius: 24px;
      position: relative;
      overflow-x: hidden;
    }

    /* HEADER */
    .calendar-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 16px 20px;
      border-bottom: 1px solid rgba(245, 158, 11, 0.1);
      background: linear-gradient(180deg, rgba(245, 158, 11, 0.03) 0%, transparent 100%);
    }

    /* Header Icon (like calculator) */
    .header-icon {
      width: 48px;
      height: 48px;
      border-radius: 16px;
      position: relative;
      background:
        radial-gradient(120% 120% at 30% 20%, rgba(245, 158, 11, .22) 0%, rgba(245, 158, 11, 0) 55%),
        radial-gradient(120% 120% at 70% 80%, rgba(168, 85, 247, .18) 0%, rgba(168, 85, 247, 0) 55%),
        rgba(10, 10, 14, .88);
      border: 1px solid rgba(245, 158, 11, .22);
      box-shadow:
        0 10px 28px rgba(0, 0, 0, .55),
        inset 0 0 0 1px rgba(255, 255, 255, .05);
      overflow: hidden;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }

    .header-icon::after {
      content: "";
      position: absolute;
      inset: -40%;
      background: conic-gradient(from 120deg, rgba(245, 158, 11, .0), rgba(245, 158, 11, .18), rgba(168, 85, 247, .12), rgba(245, 158, 11, .0));
      filter: blur(10px);
      opacity: .55;
      transform: rotate(18deg);
    }

    .header-icon .inner {
      position: absolute;
      inset: 7px;
      border-radius: 12px;
      background: rgba(255, 255, 255, .03);
      border: 1px solid rgba(255, 255, 255, .06);
    }

    .header-icon i {
      position: relative;
      z-index: 2;
      width: 24px;
      height: 24px;
      color: rgba(245, 158, 11, .95);
      filter: drop-shadow(0 6px 14px rgba(245, 158, 11, .20));
      stroke-width: 2.2;
    }

    .month-title {
      font-family: Georgia, 'Palatino Linotype', 'Book Antiqua', Palatino, 'Times New Roman', serif;
      font-size: 24px;
      font-weight: 800;
      background: linear-gradient(135deg, #f59e0b 0%, #fb923c 50%, #ea580c 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      letter-spacing: 0.02em;
      white-space: nowrap;
      text-shadow: 0 0 30px rgba(245, 158, 11, 0.3);
    }

    .header-btn {
      width: 44px;
      height: 44px;
      background: rgba(245, 158, 11, 0.08);
      border: 1px solid rgba(245, 158, 11, 0.15);
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      color: rgba(245, 158, 11, 0.9);
    }

    .header-btn:hover {
      background: rgba(255, 255, 255, .14);
      border-color: rgba(255, 255, 255, .22);
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    .header-btn:active {
      transform: translateY(0);
    }


    /* CALENDAR CONTAINER */
    .calendar-container {
      padding: 8px;
      padding-bottom: 20px;
      flex: 1;
      overflow-y: auto;
      overflow-x: hidden;
      -webkit-overflow-scrolling: touch;
      overscroll-behavior: contain;
      min-height: 0;
      position: relative;
      will-change: scroll-position;
      transform: translateZ(0);
      -webkit-transform: translateZ(0);
    }

    .calendar-container::-webkit-scrollbar {
      width: 4px;
    }

    .calendar-container::-webkit-scrollbar-track {
      background: rgba(255, 255, 255, 0.02);
      border-radius: 4px;
    }

    .calendar-container::-webkit-scrollbar-thumb {
      background: linear-gradient(180deg, rgba(245, 158, 11, 0.3), rgba(245, 158, 11, 0.15));
      border-radius: 4px;
    }

    /* DAY HEADERS */
    .day-headers {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 6px;
      margin-bottom: 12px;
      padding: 0 4px;
    }

    .day-header {
      text-align: center;
      font-size: 11px;
      font-weight: 700;
      color: rgba(245, 158, 11, 0.6);
      text-transform: uppercase;
      padding: 8px 0;
      letter-spacing: 0.08em;
    }

    /* CALENDAR GRID */
    .calendar-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: clamp(6px, 1.8vh, 18px);
      margin-bottom: 12px;
    }

    .calendar-cell {
      aspect-ratio: 1;
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.03) 0%, rgba(255, 255, 255, 0.01) 100%);
      border: 1px solid rgba(245, 158, 11, 0.08);
      border-radius: clamp(12px, 2vw, 16px);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      padding-top: clamp(6px, 1vh, 10px);
      gap: 2px;
      cursor: pointer;
      transition: transform 0.25s cubic-bezier(0.34, 1.56, 0.64, 1),
        background 0.3s ease-out,
        border-color 0.3s ease-out,
        box-shadow 0.3s ease-out;
      position: relative;
      overflow: hidden;
      will-change: transform;
      backface-visibility: hidden;
      -webkit-backface-visibility: hidden;
      contain: layout style;
    }

    .calendar-cell::before {
      content: '';
      position: absolute;
      inset: 0;
      background: radial-gradient(circle at 50% 0%, rgba(245, 158, 11, 0.08), transparent 70%);
      opacity: 0;
      transition: opacity 0.3s;
    }

    .calendar-cell:hover::before {
      opacity: 1;
    }

    .calendar-cell:hover {
      background: linear-gradient(135deg, rgba(245, 158, 11, 0.08) 0%, rgba(245, 158, 11, 0.03) 100%);
      border-color: rgba(245, 158, 11, 0.25);
      transform: translateY(-2px);
      box-shadow: 0 8px 24px rgba(245, 158, 11, 0.15);
    }

    .calendar-cell.today {
      border-color: rgba(245, 158, 11, 0.5);
      background: linear-gradient(135deg, rgba(245, 158, 11, 0.12) 0%, rgba(245, 158, 11, 0.06) 100%);
      box-shadow:
        0 0 20px rgba(245, 158, 11, 0.25),
        inset 0 0 20px rgba(245, 158, 11, 0.08);
    }

    .calendar-cell.today .date-number {
      background: linear-gradient(135deg, #f59e0b, #fb923c);
      color: #000;
      font-weight: 900;
      box-shadow: 0 4px 12px rgba(245, 158, 11, 0.4);
    }

    .calendar-cell.selected {
      border-color: rgba(245, 158, 11, 0.6);
      background: linear-gradient(135deg, rgba(245, 158, 11, 0.15) 0%, rgba(245, 158, 11, 0.08) 100%);
    }

    .calendar-cell.longpress-active {
      border-color: rgba(245, 158, 11, 0.7);
      background: linear-gradient(135deg, rgba(245, 158, 11, 0.2) 0%, rgba(245, 158, 11, 0.1) 100%);
      box-shadow: 0 0 0 3px rgba(245, 158, 11, 0.25);
      transform: scale(0.92);
      transition: transform 0.15s ease, box-shadow 0.15s ease, background 0.15s ease;
    }

    .date-number {
      font-size: 12px;
      font-weight: 700;
      color: rgba(255, 255, 255, 0.7);
      width: 26px;
      height: 26px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 8px;
      transition: all 0.3s;
    }

    .event-dots {
      display: flex;
      gap: 2px;
      flex-wrap: wrap;
      justify-content: center;
      max-width: 90%;
    }

    .event-dot {
      width: 5px;
      height: 5px;
      border-radius: 50%;
      box-shadow: 0 0 6px currentColor;
    }

    .event-label {
      font-size: 8px;
      font-weight: 800;
      text-transform: uppercase;
      padding: 3px 6px;
      border-radius: 6px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      width: 90%;
      text-align: center;
      letter-spacing: 0.03em;
      backdrop-filter: blur(8px);
    }

    .event-stage {
      background: rgba(245, 158, 11, 0.2);
      color: #f59e0b;
      border: 1px solid rgba(245, 158, 11, 0.3);
      box-shadow: 0 0 12px rgba(245, 158, 11, 0.2);
    }

    .event-closeup {
      background: rgba(168, 85, 247, 0.2);
      color: #c084fc;
      border: 1px solid rgba(168, 85, 247, 0.3);
      box-shadow: 0 0 12px rgba(168, 85, 247, 0.2);
    }

    .event-kids {
      background: rgba(16, 185, 129, 0.2);
      color: #34d399;
      border: 1px solid rgba(16, 185, 129, 0.3);
      box-shadow: 0 0 12px rgba(16, 185, 129, 0.2);
    }

    .event-concert {
      background: rgba(59, 130, 246, 0.2);
      color: #60a5fa;
      border: 1px solid rgba(59, 130, 246, 0.3);
      box-shadow: 0 0 12px rgba(59, 130, 246, 0.2);
    }

    .event-rehearsal {
      background: rgba(148, 163, 184, 0.2);
      color: #cbd5e1;
      border: 1px solid rgba(148, 163, 184, 0.3);
      box-shadow: 0 0 12px rgba(148, 163, 184, 0.15);
    }

    /* DAY LIST */
    .day-list {
      margin-top: 24px;
      padding-top: 24px;
      border-top: 1px solid rgba(245, 158, 11, 0.1);
    }

    .day-list-header {
      font-size: 12px;
      font-weight: 800;
      color: rgba(245, 158, 11, 0.8);
      text-transform: uppercase;
      margin-bottom: 16px;
      letter-spacing: 0.1em;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .day-list-header::before {
      content: '';
      width: 4px;
      height: 16px;
      background: linear-gradient(180deg, #f59e0b, #fb923c);
      border-radius: 2px;
      box-shadow: 0 0 8px rgba(245, 158, 11, 0.5);
    }

    .day-list-row {
      display: flex;
      align-items: center;
      gap: 14px;
      padding: 16px;
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.04) 0%, rgba(255, 255, 255, 0.02) 100%);
      border: 1px solid rgba(245, 158, 11, 0.1);
      border-radius: 16px;
      margin-bottom: 10px;
      cursor: pointer;
      transition: transform 0.25s cubic-bezier(0.34, 1.56, 0.64, 1),
        background 0.3s ease-out,
        border-color 0.3s ease-out,
        box-shadow 0.3s ease-out;
      position: relative;
      overflow: hidden;
      will-change: transform;
      backface-visibility: hidden;
      -webkit-backface-visibility: hidden;
      contain: layout style;
    }

    .day-list-row::before {
      content: '';
      position: absolute;
      left: 0;
      top: 0;
      bottom: 0;
      width: 3px;
      background: linear-gradient(180deg, var(--accent-color), transparent);
      opacity: 0;
      transition: opacity 0.3s;
    }

    .day-list-row:hover::before {
      opacity: 1;
    }

    .day-list-row:hover {
      background: linear-gradient(135deg, rgba(245, 158, 11, 0.08) 0%, rgba(245, 158, 11, 0.04) 100%);
      border-color: rgba(245, 158, 11, 0.25);
      transform: translateX(4px);
      box-shadow: 0 8px 24px rgba(245, 158, 11, 0.12);
    }

    .day-list-dot {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      flex-shrink: 0;
      box-shadow: 0 0 12px currentColor;
    }

    .day-list-info {
      flex: 1;
      min-width: 0;
    }

    .day-list-title {
      font-size: 14px;
      font-weight: 700;
      color: #fff;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      margin-bottom: 4px;
    }

    .day-list-subtitle {
      font-size: 12px;
      color: rgba(245, 158, 11, 0.7);
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .day-list-time {
      font-size: 13px;
      font-weight: 900;
      background: linear-gradient(135deg, #f59e0b, #fb923c);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      font-family: 'JetBrains Mono', monospace;
      flex-shrink: 0;
    }

    /* DASHBOARD */
    .dashboard-container {
      padding: 12px 16px;
      padding-top: 8px;
      padding-bottom: 120px;
      height: 100%;
      overflow-y: auto;
      overflow-x: hidden;
      -webkit-overflow-scrolling: touch;
      overscroll-behavior: contain;
      will-change: scroll-position;
      transform: translateZ(0);
      -webkit-transform: translateZ(0);
    }

    .dashboard-container::-webkit-scrollbar {
      width: 4px;
    }

    .dashboard-container::-webkit-scrollbar-track {
      background: rgba(255, 255, 255, 0.02);
    }

    .dashboard-container::-webkit-scrollbar-thumb {
      background: linear-gradient(180deg, rgba(245, 158, 11, 0.3), rgba(245, 158, 11, 0.15));
      border-radius: 4px;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
      margin-bottom: 24px;
    }

    .stat-card {
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.05) 0%, rgba(255, 255, 255, 0.02) 100%);
      border: 1px solid rgba(245, 158, 11, 0.12);
      border-radius: 20px;
      padding: 20px;
      position: relative;
      overflow: hidden;
    }

    .stat-card::before {
      content: '';
      position: absolute;
      top: 0;
      right: 0;
      width: 100px;
      height: 100px;
      background: radial-gradient(circle, rgba(245, 158, 11, 0.1), transparent 70%);
      pointer-events: none;
    }

    .stat-label {
      font-size: 11px;
      font-weight: 700;
      text-transform: uppercase;
      color: rgba(245, 158, 11, 0.7);
      letter-spacing: 0.1em;
      margin-bottom: 8px;
    }

    .stat-value {
      font-size: 28px;
      font-weight: 900;
      background: linear-gradient(135deg, #f59e0b, #fb923c);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      font-family: 'JetBrains Mono', monospace;
    }

    .stat-icon {
      position: absolute;
      top: 16px;
      right: 16px;
      color: rgba(245, 158, 11, 0.2);
      width: 32px;
      height: 32px;
    }

    /* MODALS */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.9);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.35s cubic-bezier(0.4, 0, 0.2, 1),
        visibility 0.35s cubic-bezier(0.4, 0, 0.2, 1);
      padding: 20px 0;
      will-change: opacity;
    }

    .modal-overlay.show {
      opacity: 1;
      visibility: visible;
    }

    body.modal-open {
      overflow: hidden !important;
      touch-action: none;
    }

    .modal-content {
      position: fixed;
      top: env(safe-area-inset-top);
      left: env(safe-area-inset-left);
      right: env(safe-area-inset-right);
      bottom: env(safe-area-inset-bottom);
      width: auto;
      height: auto;
      background: #000;
      transform: scale(0.95) translateZ(0);
      transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1),
        opacity 0.3s ease-out;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      will-change: transform, opacity;
      backface-visibility: hidden;
      -webkit-backface-visibility: hidden;
    }

    .modal-overlay.show .modal-content {
      transform: scale(1) translateZ(0);
    }

    #confirm-modal.show .modal-content {
      transform: scale(1) !important;
    }

    /* –¶–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –º–æ–¥–∞–ª–∫–∏ (confirm, preview, type-picker) */
    #confirm-modal .modal-content,
    #preview-modal .modal-content,
    #type-picker-modal .modal-content {
      position: relative;
      top: auto;
      left: auto;
      right: auto;
      bottom: auto;
      width: auto;
      height: auto;
      max-height: 85vh;
      border-radius: 24px;
      border: 1px solid rgba(245, 158, 11, 0.2);
      box-shadow: 0 8px 40px rgba(0, 0, 0, 0.8);
    }

    .modal-header {
      padding: 16px 20px;
      border-bottom: 1px solid rgba(245, 158, 11, 0.1);
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: #000;
      flex-shrink: 0;
    }

    .modal-title {
      font-family: Georgia, 'Palatino Linotype', 'Book Antiqua', Palatino, 'Times New Roman', serif;
      font-size: 22px;
      font-weight: 800;
      background: linear-gradient(135deg, #f59e0b, #fb923c);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .modal-close,
    .close-btn {
      width: 40px;
      height: 40px;
      background: rgba(245, 158, 11, 0.08);
      border: 1px solid rgba(245, 158, 11, 0.15);
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      color: rgba(245, 158, 11, 0.9);
      transition: all 0.3s;
    }

    .modal-close:hover,
    .close-btn:hover {
      background: rgba(245, 158, 11, 0.15);
      border-color: rgba(245, 158, 11, 0.35);
      transform: rotate(90deg);
    }

    .modal-body {
      flex: 1;
      overflow-y: auto;
      overflow-x: hidden;
      padding: 16px 20px 40px;
      -webkit-overflow-scrolling: touch;
      overscroll-behavior: contain;
    }

    .modal-body::-webkit-scrollbar {
      width: 4px;
    }

    .modal-body::-webkit-scrollbar-track {
      background: rgba(255, 255, 255, 0.02);
    }

    .modal-body::-webkit-scrollbar-thumb {
      background: linear-gradient(180deg, rgba(245, 158, 11, 0.3), rgba(245, 158, 11, 0.15));
      border-radius: 4px;
    }

    /* TABS IN MODAL */
    .modal-tabs {
      display: flex;
      gap: 8px;
      margin-bottom: 24px;
      padding: 6px;
      background: rgba(255, 255, 255, 0.02);
      border-radius: 16px;
      border: 1px solid rgba(245, 158, 11, 0.08);
    }

    .modal-tab {
      flex: 1;
      padding: 12px 16px;
      background: transparent;
      border: 1px solid transparent;
      border-radius: 12px;
      font-size: 13px;
      font-weight: 700;
      color: rgba(255, 255, 255, 0.5);
      cursor: pointer;
      transition: all 0.3s;
      text-align: center;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .modal-tab:hover {
      color: rgba(245, 158, 11, 0.8);
      background: rgba(245, 158, 11, 0.05);
    }

    .modal-tab.active {
      background: linear-gradient(135deg, rgba(245, 158, 11, 0.15) 0%, rgba(245, 158, 11, 0.08) 100%);
      border-color: rgba(245, 158, 11, 0.25);
      color: #f59e0b;
      box-shadow: 0 4px 16px rgba(245, 158, 11, 0.15);
    }

    .tab-panel {
      display: none;
    }

    .tab-panel.active {
      display: block;
    }

    /* FORM ELEMENTS */
    .form-section {
      margin-bottom: 24px;
      padding-bottom: 20px;
      border-bottom: 1px solid rgba(245, 158, 11, 0.1);
    }

    .form-section:last-of-type {
      border-bottom: none;
      margin-bottom: 16px;
    }

    .form-section-title {
      font-size: 14px;
      font-weight: 800;
      color: #f59e0b;
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
      user-select: none;
      padding: 10px 12px;
      margin: -10px -12px 16px -12px;
      border-radius: 10px;
      transition: background 0.2s ease;
    }

    .form-section-title:hover {
      background: rgba(245, 158, 11, 0.1);
    }

    .form-section-title:active {
      background: rgba(245, 158, 11, 0.15);
    }

    .form-section-title .chevron {
      margin-left: auto;
      width: 18px;
      height: 18px;
      transition: transform 0.3s ease;
      opacity: 0.6;
    }

    .form-section.collapsed .form-section-title .chevron {
      transform: rotate(-90deg);
    }

    .form-section-content {
      overflow: hidden;
      transition: max-height 0.3s ease, opacity 0.25s ease;
      max-height: 2000px;
      opacity: 1;
    }

    .form-section.collapsed .form-section-content {
      max-height: 0;
      opacity: 0;
    }

    .form-group {
      margin-bottom: 16px;
    }

    .form-label {
      display: block;
      font-size: 12px;
      font-weight: 700;
      text-transform: uppercase;
      color: rgba(245, 158, 11, 0.8);
      margin-bottom: 10px;
      letter-spacing: 0.08em;
    }

    .form-input,
    .form-textarea,
    .form-select {
      width: 100%;
      background: rgba(255, 255, 255, .08);
      border: 1.5px solid rgba(255, 255, 255, .12);
      border-radius: 14px;
      padding: 14px 16px;
      font-size: 15px;
      color: #e2e8f0;
      outline: none;
      transition: all 0.2s;
      min-height: 50px;
      -webkit-appearance: none;
      appearance: none;
      font-family: var(--font-body);
    }

    .form-input:focus,
    .form-textarea:focus,
    .form-select:focus {
      border-color: rgba(245, 158, 11, .4);
      box-shadow: 0 0 0 4px rgba(245, 158, 11, .12);
      background: rgba(255, 255, 255, .10);
    }

    .form-input::placeholder,
    .form-textarea::placeholder {
      color: #94a3b8;
    }

    .form-textarea {
      min-height: 100px;
      resize: vertical;
    }

    /* TYPE SELECTOR */
    .type-selector {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 10px;
      margin-bottom: 20px;
    }

    .type-button {
      aspect-ratio: 1;
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.04) 0%, rgba(255, 255, 255, 0.02) 100%);
      border: 1px solid rgba(245, 158, 11, 0.08);
      border-radius: 14px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 6px;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      color: rgba(255, 255, 255, 0.5);
      padding: 12px;
    }

    .type-button:hover {
      border-color: rgba(245, 158, 11, 0.25);
      background: linear-gradient(135deg, rgba(245, 158, 11, 0.08) 0%, rgba(245, 158, 11, 0.04) 100%);
      transform: translateY(-2px);
    }

    .type-button.active {
      border-color: rgba(245, 158, 11, 0.4);
      background: linear-gradient(135deg, rgba(245, 158, 11, 0.15) 0%, rgba(245, 158, 11, 0.08) 100%);
      color: var(--type-color);
      box-shadow: 0 4px 20px rgba(245, 158, 11, 0.2);
    }

    .type-button i {
      width: 24px;
      height: 24px;
    }

    .type-label {
      font-size: 9px;
      font-weight: 800;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    /* SCHEDULE */
    .schedule-section {
      margin-bottom: 24px;
    }

    .schedule-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 16px;
    }

    .schedule-title {
      font-size: 13px;
      font-weight: 800;
      text-transform: uppercase;
      color: rgba(245, 158, 11, 0.8);
      letter-spacing: 0.08em;
    }

    .schedule-add {
      padding: 8px 16px;
      background: linear-gradient(135deg, rgba(245, 158, 11, 0.15) 0%, rgba(245, 158, 11, 0.08) 100%);
      border: 1px solid rgba(245, 158, 11, 0.25);
      border-radius: 10px;
      color: #f59e0b;
      font-size: 12px;
      font-weight: 800;
      cursor: pointer;
      transition: all 0.3s;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .schedule-add:hover {
      background: linear-gradient(135deg, rgba(245, 158, 11, 0.25) 0%, rgba(245, 158, 11, 0.15) 100%);
      transform: translateY(-1px);
      box-shadow: 0 4px 16px rgba(245, 158, 11, 0.25);
    }

    .schedule-list {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .schedule-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 14px;
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.04) 0%, rgba(255, 255, 255, 0.02) 100%);
      border: 1px solid rgba(245, 158, 11, 0.1);
      border-radius: 14px;
      transition: all 0.3s;
    }

    .schedule-item:hover {
      border-color: rgba(245, 158, 11, 0.2);
      background: linear-gradient(135deg, rgba(245, 158, 11, 0.06) 0%, rgba(245, 158, 11, 0.03) 100%);
    }

    .schedule-type-btn {
      width: 44px;
      height: 44px;
      background: rgba(245, 158, 11, 0.08);
      border: 1px solid rgba(245, 158, 11, 0.15);
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.3s;
      flex-shrink: 0;
    }

    .schedule-type-btn:hover {
      transform: scale(1.1);
      box-shadow: 0 4px 16px currentColor;
    }

    .schedule-type-btn i {
      width: 20px;
      height: 20px;
    }

    .schedule-inputs {
      flex: 1;
      display: flex;
      gap: 8px;
    }

    .schedule-inputs input {
      padding: 10px 12px;
      background: rgba(255, 255, 255, 0.04);
      border: 1px solid rgba(245, 158, 11, 0.12);
      border-radius: 10px;
      color: #fff;
      font-size: 14px;
      font-weight: 600;
      font-family: 'JetBrains Mono', monospace;
    }

    .schedule-duration {
      width: 70px;
      padding: 10px 12px;
      background: rgba(255, 255, 255, 0.04);
      border: 1px solid rgba(245, 158, 11, 0.12);
      border-radius: 10px;
      color: #fff;
      font-size: 14px;
      font-weight: 600;
      text-align: center;
      font-family: 'JetBrains Mono', monospace;
    }

    .schedule-remove {
      width: 36px;
      height: 36px;
      background: rgba(239, 68, 68, 0.1);
      border: 1px solid rgba(239, 68, 68, 0.2);
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      color: #ef4444;
      transition: all 0.3s;
      flex-shrink: 0;
    }

    .schedule-remove:hover {
      background: rgba(239, 68, 68, 0.2);
      border-color: rgba(239, 68, 68, 0.4);
      transform: scale(1.1);
    }

    /* BALANCE DISPLAY */
    .balance-group {
      background: linear-gradient(135deg, rgba(245, 158, 11, 0.12) 0%, rgba(245, 158, 11, 0.06) 100%);
      border: 1px solid rgba(245, 158, 11, 0.25);
      border-radius: 16px;
      padding: 20px;
      margin-top: 20px;
    }

    .balance-label {
      font-size: 12px;
      font-weight: 700;
      text-transform: uppercase;
      color: rgba(245, 158, 11, 0.8);
      margin-bottom: 8px;
      letter-spacing: 0.08em;
    }

    .balance-value {
      font-size: 32px;
      font-weight: 900;
      background: linear-gradient(135deg, #f59e0b, #fb923c);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      font-family: 'JetBrains Mono', monospace;
    }

    /* BUTTONS */
    .btn-primary {
      width: 100%;
      border-radius: 16px;
      padding: 14px 18px;
      font-size: 15px;
      font-weight: 800;
      letter-spacing: 0.02em;
      background: linear-gradient(135deg, rgba(245, 158, 11, .95), rgba(245, 158, 11, .75));
      color: #120a00;
      border: 1.5px solid rgba(245, 158, 11, .4);
      box-shadow: 0 12px 30px rgba(245, 158, 11, .2);
      min-height: 52px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .btn-primary:hover {
      filter: brightness(1.08);
      transform: translateY(-1px);
      box-shadow: 0 16px 40px rgba(245, 158, 11, .3), 0 0 20px rgba(245, 158, 11, .15);
    }

    .btn-primary:active {
      transform: translateY(0);
    }

    .btn-secondary {
      width: 100%;
      border-radius: 16px;
      padding: 14px 18px;
      font-size: 14px;
      font-weight: 700;
      background: rgba(255, 255, 255, .12);
      color: #f1f5f9;
      border: 1.5px solid rgba(255, 255, 255, .18);
      min-height: 52px;
      cursor: pointer;
      transition: all 0.2s;
      margin: 0;
    }

    .btn-secondary:hover {
      background: rgba(255, 255, 255, .16);
      border-color: rgba(255, 255, 255, .25);
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    }

    .btn-danger {
      width: 100%;
      border-radius: 16px;
      padding: 14px 18px;
      font-size: 14px;
      font-weight: 700;
      background: rgba(239, 68, 68, .12);
      border: 1.5px solid rgba(239, 68, 68, 0.3);
      min-height: 52px;
      color: #ef4444;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      cursor: pointer;
      transition: all 0.3s;
      margin: 0;
    }

    .btn-danger:hover {
      background: linear-gradient(135deg, rgba(239, 68, 68, 0.25) 0%, rgba(239, 68, 68, 0.15) 100%);
      border-color: rgba(239, 68, 68, 0.5);
    }

    /* BOTTOM NAV - –†–ê–ó–î–ï–õ–Å–ù–ù–´–ï –ö–ù–û–ü–ö–ò */
    #bottom-nav {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      z-index: 100;
      padding: 0 20px;
      padding-bottom: max(24px, env(safe-area-inset-bottom, 0px));
      background: transparent;
      pointer-events: none;
      transform: translateY(100px);
      opacity: 0;
      transition: transform 0.35s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.25s ease-out;
      will-change: transform, opacity;
    }

    #bottom-nav.visible {
      transform: translateY(0);
      opacity: 1;
    }

    .nav-inner {
      pointer-events: all;
      display: flex;
      align-items: flex-end;
      justify-content: space-between;
      gap: 0;
      position: relative;
      width: 100%;
      max-width: 240px;
      margin: 0 auto;
    }

    .nav-item {
      width: 64px;
      height: 64px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: transparent;
      border: 2px solid rgba(245, 158, 11, 0.25);
      border-radius: 50%;
      color: rgba(148, 163, 184, 0.8);
      cursor: pointer;
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
    }

    .nav-item:hover {
      transform: translateY(-3px);
      border-color: rgba(245, 158, 11, 0.4);
      color: rgba(245, 158, 11, 0.9);
    }

    .nav-item.active {
      border-color: rgba(245, 158, 11, 0.6);
      color: #f59e0b;
      transform: translateY(-3px);
    }

    /* FAB - —Ü–µ–Ω—Ç—Ä–∞–ª—å–Ω–∞—è –∫–Ω–æ–ø–∫–∞ */
    .nav-item:nth-child(2) {
      width: 72px;
      height: 72px;
      background: linear-gradient(135deg, #f59e0b, #d97706);
      border: none;
      margin-bottom: 16px;
      box-shadow: 0 4px 20px rgba(245, 158, 11, 0.4);
      color: #000;
    }

    .nav-item:nth-child(2) i {
      width: 32px;
      height: 32px;
      stroke-width: 2.5px;
    }

    .nav-item:nth-child(2):hover {
      transform: translateY(-6px) scale(1.08);
      box-shadow: 0 6px 28px rgba(245, 158, 11, 0.5);
    }

    .nav-item:nth-child(2):active {
      transform: translateY(-4px) scale(1.02);
    }

    .nav-item i {
      width: 26px;
      height: 26px;
      transition: all 0.3s;
    }

    .nav-item:nth-child(2) i {
      width: 36px;
      height: 36px;
    }

    .nav-item.active i {
      filter: drop-shadow(0 0 8px currentColor);
    }

    .nav-label {
      font-size: 10px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }


    /* TOAST */
    #toast {
      position: fixed;
      bottom: calc(100px + env(safe-area-inset-bottom, 0px));
      left: 50%;
      transform: translateX(-50%) translateY(20px);
      padding: 16px 24px;
      background: linear-gradient(135deg, rgba(20, 25, 35, 0.97) 0%, rgba(10, 15, 25, 0.99) 100%);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border: 1px solid rgba(245, 158, 11, 0.3);
      border-radius: 16px;
      color: #f59e0b;
      font-size: 14px;
      font-weight: 700;
      z-index: 10000;
      box-shadow:
        0 8px 32px rgba(0, 0, 0, 0.6),
        0 0 40px rgba(245, 158, 11, 0.2);
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      pointer-events: none;
      opacity: 0;
      visibility: hidden;
    }

    #toast.show {
      transform: translateX(-50%) translateY(0);
      opacity: 1;
      visibility: visible;
    }

    /* MONTH PICKER */
    .month-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 12px;
      margin: 24px 0;
    }

    .month-btn {
      padding: 16px;
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.04) 0%, rgba(255, 255, 255, 0.02) 100%);
      border: 1px solid rgba(245, 158, 11, 0.08);
      border-radius: 14px;
      color: rgba(255, 255, 255, 0.7);
      font-size: 14px;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.3s;
      text-align: center;
    }

    .month-btn:hover {
      background: linear-gradient(135deg, rgba(245, 158, 11, 0.08) 0%, rgba(245, 158, 11, 0.04) 100%);
      border-color: rgba(245, 158, 11, 0.25);
      color: #f59e0b;
      transform: translateY(-2px);
    }

    .month-btn.active {
      background: linear-gradient(135deg, rgba(245, 158, 11, 0.15) 0%, rgba(245, 158, 11, 0.08) 100%);
      border-color: rgba(245, 158, 11, 0.4);
      color: #f59e0b;
      box-shadow: 0 4px 20px rgba(245, 158, 11, 0.2);
    }

    /* COLOR PICKER */
    .color-btn {
      width: 100%;
      aspect-ratio: 1;
      border-radius: 12px;
      border: 2px solid rgba(255, 255, 255, 0.1);
      cursor: pointer;
      transition: all 0.3s;
      position: relative;
    }

    .color-btn:hover {
      transform: scale(1.1);
      border-color: rgba(255, 255, 255, 0.3);
    }

    .color-btn.selected {
      border-color: #fff;
      border-width: 3px;
      box-shadow: 0 0 20px currentColor;
    }

    .color-btn.selected::after {
      content: '‚úì';
      position: absolute;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #000;
      font-size: 18px;
      font-weight: 900;
      text-shadow: 0 0 4px rgba(255, 255, 255, 0.8);
    }

    /* ICON PICKER */
    .icon-btn {
      aspect-ratio: 1;
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.04), rgba(255, 255, 255, 0.02));
      border: 1px solid rgba(245, 158, 11, 0.1);
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.3s;
      color: rgba(255, 255, 255, 0.6);
    }

    .icon-btn:hover {
      background: linear-gradient(135deg, rgba(245, 158, 11, 0.08), rgba(245, 158, 11, 0.04));
      border-color: rgba(245, 158, 11, 0.25);
      color: #f59e0b;
      transform: scale(1.05);
    }

    .icon-btn.selected {
      background: linear-gradient(135deg, rgba(245, 158, 11, 0.15), rgba(245, 158, 11, 0.08));
      border-color: rgba(245, 158, 11, 0.4);
      color: #f59e0b;
      box-shadow: 0 4px 16px rgba(245, 158, 11, 0.3);
    }

    .icon-btn i {
      width: 20px;
      height: 20px;
    }

    .year-selector {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 24px;
      margin-bottom: 24px;
      padding: 20px;
      background: linear-gradient(135deg, rgba(245, 158, 11, 0.08) 0%, rgba(245, 158, 11, 0.04) 100%);
      border: 1px solid rgba(245, 158, 11, 0.15);
      border-radius: 16px;
    }

    .year-btn {
      width: 44px;
      height: 44px;
      background: rgba(245, 158, 11, 0.1);
      border: 1px solid rgba(245, 158, 11, 0.2);
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      color: #f59e0b;
      transition: all 0.3s;
    }

    .year-btn:hover {
      background: rgba(245, 158, 11, 0.2);
      border-color: rgba(245, 158, 11, 0.35);
      transform: scale(1.1);
    }

    .year-display {
      font-size: 28px;
      font-weight: 900;
      background: linear-gradient(135deg, #f59e0b, #fb923c);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      font-family: 'JetBrains Mono', monospace;
      min-width: 120px;
      text-align: center;
    }

    /* MEDIA QUERIES */
    @media (max-width: 768px) {

      input[type="text"],
      input[type="number"],
      input[type="date"],
      input[type="time"],
      select,
      textarea {
        font-size: 16px !important;
      }
    }

    @media (max-width: 480px) {
      .glass-panel {
        border-radius: 24px !important;
        padding: 20px !important;
      }

      .calendar-header {
        padding: 12px 16px !important;
      }

      .btn-secondary {
        padding: 12px 16px !important;
        font-size: 14px !important;
      }

      .modal-header {
        padding: 20px 16px;
      }

      .modal-body {
        padding: 20px 16px;
      }
    }

    @media (max-width: 430px) {
      .glass-panel {
        padding: 16px !important;
      }

      .calendar-grid {
        gap: 6px;
      }

      .schedule-item {
        padding: 12px;
        gap: 10px;
      }

      .day-list-row {
        padding: 14px 12px;
      }
    }

    @media (max-width: 380px) {
      .calendar-header .month-title {
        font-size: 20px !important;
      }

      .glass-panel {
        padding: 14px !important;
      }

      .calendar-grid {
        gap: 5px;
      }

      .date-number {
        font-size: 11px;
        width: 24px;
        height: 24px;
      }

      .event-dot {
        width: 5px;
        height: 5px;
      }

      .event-label {
        font-size: 7px;
      }

      .header-btn {
        width: 40px;
        height: 40px;
        min-width: 40px;
      }

      .schedule-type-btn {
        width: 42px;
        height: 42px;
        min-width: 42px;
      }

      .day-list-row {
        padding: 14px;
      }

      .calendar-cell {
        min-width: 40px;
        min-height: 40px;
      }
    }

    @media (min-width: 431px) {

      /* –ë–æ–ª—å—à–∏–µ —ç–∫—Ä–∞–Ω—ã (iPhone 14 Pro Max+, Galaxy Ultra) */
      .glass-panel {
        padding: 24px !important;
      }

      .btn-secondary {
        min-height: 56px;
      }

      .header-btn {
        width: 52px;
        height: 52px;
      }

      .schedule-type-btn {
        width: 48px;
        height: 48px;
      }
    }

    /* Landscape orientation warning for very small screens */
    @media (max-height: 500px) and (orientation: landscape) {
      body::before {
        content: '';
        position: fixed;
        inset: 0;
        background: rgba(5, 5, 7, 0.95);
        z-index: 99998;
        backdrop-filter: blur(10px);
      }

      body::after {
        content: 'üì± –ü–æ–≤–µ—Ä–Ω–∏—Ç–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–æ';
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        z-index: 99999;
        color: #f59e0b;
        font-size: 18px;
        font-weight: 800;
        text-align: center;
        font-family: Georgia, 'Palatino Linotype', 'Book Antiqua', Palatino, 'Times New Roman', serif;
        text-shadow: 0 0 30px rgba(245, 158, 11, 0.5);
      }
    }

    /* MAGIC HAT CELEBRATION */
    #celebration-container {
      position: fixed;
      inset: 0;
      pointer-events: none;
      z-index: 10001;
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      transition: opacity 0.3s;
    }

    #celebration-container.show {
      opacity: 1;
    }

    .magic-hat {
      position: relative;
      width: 120px;
      height: 120px;
      transform: scale(0) rotateY(180deg);
      transition: transform 0.8s cubic-bezier(0.34, 1.56, 0.64, 1);
    }

    .magic-hat.show {
      transform: scale(1) rotateY(0deg);
    }

    /* Hat Top (cylinder) */
    .hat-top {
      position: absolute;
      bottom: 80px;
      left: 50%;
      transform: translateX(-50%);
      width: 100px;
      height: 90px;
      background: linear-gradient(180deg, #1a1a1a 0%, #000 100%);
      border-radius: 10px 10px 0 0;
      border: 3px solid #2a2a2a;
      box-shadow:
        0 -5px 20px rgba(0, 0, 0, 0.8),
        inset 0 2px 10px rgba(255, 255, 255, 0.1);
    }

    .hat-top::before {
      content: '';
      position: absolute;
      top: 10px;
      left: 10%;
      width: 30%;
      height: 40%;
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.2), transparent);
      border-radius: 50%;
      filter: blur(8px);
    }

    /* Hat Brim */
    .hat-brim {
      position: absolute;
      bottom: 70px;
      left: 50%;
      transform: translateX(-50%);
      width: 180px;
      height: 40px;
      background: linear-gradient(180deg, #1a1a1a 0%, #000 50%, #0a0a0a 100%);
      border-radius: 50%;
      border: 3px solid #2a2a2a;
      box-shadow:
        0 10px 40px rgba(0, 0, 0, 0.9),
        inset 0 -5px 15px rgba(0, 0, 0, 0.5),
        inset 0 2px 10px rgba(255, 255, 255, 0.1);
    }

    .hat-brim::after {
      content: '';
      position: absolute;
      inset: 8px;
      background: radial-gradient(ellipse at center, rgba(245, 158, 11, 0.1), transparent 70%);
      border-radius: 50%;
    }

    /* Gold Ribbon */
    .hat-ribbon {
      position: absolute;
      bottom: 78px;
      left: 50%;
      transform: translateX(-50%);
      width: 110px;
      height: 15px;
      background: linear-gradient(90deg, #ea580c, #f59e0b, #fb923c, #ea580c);
      background-size: 200% 100%;
      border-radius: 3px;
      box-shadow:
        0 2px 8px rgba(245, 158, 11, 0.6),
        inset 0 1px 2px rgba(255, 255, 255, 0.3);
      animation: ribbonShine 2s linear infinite;
    }

    @keyframes ribbonShine {
      0% {
        background-position: 200% center;
      }

      100% {
        background-position: -200% center;
      }
    }

    /* Sparkle particles */
    .sparkle {
      position: absolute;
      width: 8px;
      height: 8px;
      background: radial-gradient(circle, #fff, #f59e0b);
      border-radius: 50%;
      box-shadow:
        0 0 10px #f59e0b,
        0 0 20px #f59e0b,
        0 0 30px rgba(245, 158, 11, 0.5);
      animation: sparkleFountain linear forwards;
      pointer-events: none;
    }

    @keyframes sparkleFountain {
      0% {
        transform: translate(0, 0) scale(1);
        opacity: 1;
      }

      100% {
        transform: translate(var(--tx), var(--ty)) scale(0);
        opacity: 0;
      }
    }

    /* Star particles */
    .star-particle {
      position: absolute;
      font-size: 20px;
      animation: starFountain linear forwards;
      filter: drop-shadow(0 0 8px currentColor);
    }

    @keyframes starFountain {
      0% {
        transform: translate(0, 0) rotate(0deg) scale(0);
        opacity: 1;
      }

      50% {
        opacity: 1;
        transform: translate(var(--tx), var(--ty)) rotate(var(--rotate)) scale(1);
      }

      100% {
        transform: translate(var(--tx), calc(var(--ty) + 50px)) rotate(var(--rotate)) scale(0.5);
        opacity: 0;
      }
    }

    /* Goal message */
    .goal-message {
      position: absolute;
      top: 20%;
      left: 50%;
      transform: translateX(-50%) translateY(50px);
      text-align: center;
      opacity: 0;
      transition: all 0.8s cubic-bezier(0.34, 1.56, 0.64, 1);
      padding: 24px 36px;
      background: linear-gradient(135deg, rgba(0, 0, 0, 0.85) 0%, rgba(10, 10, 14, 0.9) 100%);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border-radius: 24px;
      border: 2px solid rgba(245, 158, 11, 0.4);
      box-shadow:
        0 20px 60px rgba(0, 0, 0, 0.8),
        0 0 80px rgba(245, 158, 11, 0.3),
        inset 0 1px 0 rgba(255, 255, 255, 0.1);
    }

    .goal-message::before {
      content: '';
      position: absolute;
      inset: -2px;
      background: linear-gradient(135deg, transparent, rgba(245, 158, 11, 0.2), transparent);
      border-radius: 24px;
      z-index: -1;
      animation: borderGlow 3s linear infinite;
    }

    @keyframes borderGlow {

      0%,
      100% {
        opacity: 0.5;
      }

      50% {
        opacity: 1;
      }
    }

    .goal-message.show {
      transform: translateX(-50%) translateY(0);
      opacity: 1;
    }

    .goal-message-title {
      font-family: Georgia, 'Palatino Linotype', 'Book Antiqua', Palatino, 'Times New Roman', serif;
      font-size: 32px;
      font-weight: 900;
      background: linear-gradient(135deg, #f59e0b 0%, #fbbf24 25%, #f59e0b 50%, #fbbf24 75%, #f59e0b 100%);
      background-size: 200% 100%;
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      animation: goldShimmer 3s linear infinite;
      filter: drop-shadow(0 4px 12px rgba(245, 158, 11, 0.8)) drop-shadow(0 0 40px rgba(245, 158, 11, 0.6));
      margin-bottom: 12px;
      letter-spacing: 0.05em;
      text-shadow: none;
    }

    @keyframes goldShimmer {
      0% {
        background-position: 200% center;
      }

      100% {
        background-position: -200% center;
      }
    }

    .goal-message-subtitle {
      font-size: 18px;
      font-weight: 700;
      color: #fff;
      text-shadow:
        0 0 30px rgba(245, 158, 11, 1),
        0 4px 8px rgba(0, 0, 0, 0.8),
        0 0 15px rgba(245, 158, 11, 0.8);
      animation: subtitlePulse 2s ease-in-out infinite;
      letter-spacing: 0.08em;
    }

    @keyframes subtitlePulse {

      0%,
      100% {
        transform: scale(1);
        filter: drop-shadow(0 0 20px rgba(245, 158, 11, 0.8));
      }

      50% {
        transform: scale(1.05);
        filter: drop-shadow(0 0 30px rgba(245, 158, 11, 1));
      }
    }

    /* Magic glow around hat */
    .magic-glow {
      position: absolute;
      inset: -40px;
      background: radial-gradient(ellipse at center, rgba(245, 158, 11, 0.3), transparent 70%);
      border-radius: 50%;
      animation: glowPulse 2s ease-in-out infinite;
    }

    @keyframes glowPulse {

      0%,
      100% {
        transform: scale(1);
        opacity: 0.5;
      }

      50% {
        transform: scale(1.2);
        opacity: 0.8;
      }
    }

    /* SPLASH SCREEN */
    #splash-screen {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      width: 100vw;
      height: 100vh;
      height: 100dvh;
      z-index: 99999;
      background: #000000;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      opacity: 1;
      transition: opacity 0.5s ease-out;
      overflow: hidden;
      padding: 0;
      margin: 0;
    }

    #splash-screen.hide {
      opacity: 0;
      pointer-events: none;
    }

    #splash-screen.hidden {
      display: none !important;
    }

    .splash-icon {
      width: 120px;
      height: 120px;
      border-radius: 28px;
      position: relative;
      background: #000000;
      border: 2px solid rgba(245, 158, 11, 0.2);
      box-shadow:
        0 20px 60px rgba(0, 0, 0, 0.6),
        0 8px 20px rgba(245, 158, 11, 0.1),
        inset 0 1px 0 rgba(255, 255, 255, 0.1);
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 40px;
    }

    .splash-icon i,
    .splash-icon svg {
      position: relative;
      z-index: 10;
      width: 64px;
      height: 64px;
      color: #f59e0b;
      filter: drop-shadow(0 4px 12px rgba(245, 158, 11, 0.3));
    }

    .splash-title {
      font-family: Georgia, 'Palatino Linotype', 'Book Antiqua', Palatino, 'Times New Roman', serif;
      font-size: 32px;
      font-weight: 900;
      background: linear-gradient(135deg, #f59e0b, #f59e0b, #f59e0b);
      background-size: 200% 100%;
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      margin-bottom: 12px;
      letter-spacing: 0.1em;
      text-transform: uppercase;
      animation: titleShimmer 3s linear infinite;
    }

    @keyframes titleShimmer {
      0% {
        background-position: 200% center;
      }

      100% {
        background-position: -200% center;
      }
    }

    .splash-subtitle {
      font-size: 15px;
      font-weight: 700;
      color: rgba(245, 158, 11, 0.7);
      letter-spacing: 0.15em;
      text-transform: uppercase;
      margin-bottom: 32px;
    }

    .splash-tagline {
      font-size: 14px;
      font-weight: 400;
      color: rgba(148, 163, 184, 0.6);
      font-style: italic;
      letter-spacing: 0.05em;
    }

    .splash-loader {
      width: 40px;
      height: 40px;
      border: 3px solid rgba(245, 158, 11, 0.1);
      border-top-color: #f59e0b;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-top: 40px;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    @keyframes magic-spin {
      0% {
        transform: scale(0) rotate(0deg);
        opacity: 0;
      }

      50% {
        transform: scale(1.2) rotate(180deg);
        opacity: 1;
      }

      100% {
        transform: scale(1) rotate(360deg);
        opacity: 1;
      }
    }

    @keyframes wand-spin {
      0% {
        transform: scale(0) rotate(0deg);
        opacity: 0;
      }

      50% {
        transform: scale(1.2) rotate(360deg);
        opacity: 1;
      }

      100% {
        transform: scale(1) rotate(720deg);
        opacity: 1;
      }
    }

    @keyframes sparkle-pulse {

      0%,
      100% {
        opacity: 0.4;
        transform: scale(1);
      }

      50% {
        opacity: 1;
        transform: scale(1.3);
      }
    }
  </style>

  <script>
    // ============================================
    // LICENSE SYSTEM
    // ============================================
    const DEMO_MODE = false;

    function getDeviceId() {
      let id = localStorage.getItem('illusionist_device_id');
      if (!id) {
        id = 'device_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        localStorage.setItem('illusionist_device_id', id);
      }
      return id;
    }

    // –î–µ—Ç–µ—Ä–º–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–π fingerprint ‚Äî —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å –ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä–æ–º –¥–ª—è Firebase-—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
    function getBrowserFingerprint() {
      var nav = navigator;
      var scr = window.screen;
      var components = [nav.userAgent, nav.language, scr.colorDepth, scr.width + 'x' + scr.height];
      var hash = 0;
      var str = components.join('|');
      for (var i = 0; i < str.length; i++) {
        var char = str.charCodeAt(i);
        hash = ((hash << 5) - hash) + char;
        hash = hash & hash;
      }
      return 'DEV-' + Math.abs(hash).toString(36).toUpperCase();
    }

    function getInstallationId() {
      let id = localStorage.getItem('illusionist_install_id');
      if (!id) {
        id = 'install_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        localStorage.setItem('illusionist_install_id', id);
      }
      return id;
    }

    function validateLicense(key) {
      return /^[A-Z0-9]{4}-[A-Z0-9]{4}-[A-Z0-9]{4}-[A-Z0-9]{4}$/.test(key);
    }

    async function checkActivation() {
      if (DEMO_MODE) return false;

      // –ï—Å–ª–∏ —Ç–æ–ª—å–∫–æ —á—Ç–æ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–ª–∏ –∏ –∞–Ω–∏–º–∞—Ü–∏—è –ø–æ–∫–∞–∑–∞–Ω–∞ - —Å—Ä–∞–∑—É true
      const justActivated = localStorage.getItem('illusionist_welcome_shown');
      if (justActivated) {
        localStorage.removeItem('illusionist_welcome_shown');
        return true;
      }

      const stored = localStorage.getItem('illusionist_calendar_license');
      if (stored) {
        try {
          const data = JSON.parse(atob(stored));

          if (!validateLicense(data.key)) {
            return false;
          }
          if (window.firebaseEnabled && window.firebaseDB) {
            try {
              const keyRef = window.firebaseDB.ref('licenses/' + data.key.replace(/[\.#$\[\]]/g, '-'));
              const snapshot = await keyRef.once('value');
              const firebaseData = snapshot.val();

              if (!firebaseData || !firebaseData.activated) {
                return false;
              }

              const currentDevice = getDeviceId();
              if (firebaseData.deviceId !== currentDevice) {
                return false;
              }

              if (firebaseData.expiresAt) {
                const expiryDate = new Date(firebaseData.expiresAt);
                const now = new Date();
                if (now > expiryDate) {
                  return 'expired';
                }
              }

              return true;
            } catch (firebaseError) {
              // Firebase check failed, fallback to local
            }
          }

          const currentDevice = getDeviceId();
          if (data.device !== currentDevice) {
            return false;
          }

          if (data.expiresAt) {
            const expiryDate = new Date(data.expiresAt);
            const now = new Date();
            if (now > expiryDate) {
              return 'expired';
            }
          }

          return true;
        } catch (e) {
          return false;
        }
      }

      return false;
    }

    async function activateLicense(key) {
      if (!validateLicense(key)) {
        return { success: false, error: '–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –∫–ª—é—á–∞' };
      }

      const deviceId = getDeviceId();
      const installId = getInstallationId();

      if (window.firebaseEnabled && window.firebaseDB) {
        try {
          const keyRef = window.firebaseDB.ref('licenses/' + key.replace(/[\.#$\[\]]/g, '-'));
          const snapshot = await keyRef.once('value');
          const existingData = snapshot.val();

          if (!existingData) {
            return {
              success: false,
              error: '–ö–ª—é—á –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö.\n–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç—å –∫–ª—é—á–∞ –∏–ª–∏ –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –ø—Ä–æ–¥–∞–≤—Ü—É.'
            };
          }

          if (existingData.activated) {
            if (existingData.deviceId !== deviceId) {
              return {
                success: false,
                error: '–≠—Ç–æ—Ç –∫–ª—é—á —É–∂–µ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω –Ω–∞ –¥—Ä—É–≥–æ–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ!\n\n–ö–∞–∂–¥—ã–π –∫–ª—é—á —Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ –Ω–∞ –æ–¥–Ω–æ–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ.'
              };
            }
          }

          // –í—ã—á–∏—Å–ª—è–µ–º –¥–∞—Ç—É –∏—Å—Ç–µ—á–µ–Ω–∏—è –Ω–∞ –æ—Å–Ω–æ–≤–µ expiryDays
          const updateData = {
            activated: true,
            deviceId: deviceId,
            installId: installId,
            activatedDate: new Date().toISOString(),
            lastCheck: new Date().toISOString()
          };

          // –ï—Å–ª–∏ –≤ –∫–ª—é—á–µ –µ—Å—Ç—å —Å—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è - –≤—ã—á–∏—Å–ª—è–µ–º –¥–∞—Ç—É –∏—Å—Ç–µ—á–µ–Ω–∏—è
          if (existingData.expiryDays && existingData.expiryDays < 999999) {
            const expiryDate = new Date();
            expiryDate.setDate(expiryDate.getDate() + existingData.expiryDays);
            updateData.expiresAt = expiryDate.toISOString();
          }

          await keyRef.update(updateData);

        } catch (firebaseError) {
          return {
            success: false,
            error: '–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —Å–µ—Ä–≤–µ—Ä—É.\n–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç-—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ.'
          };
        }
      }

      const data = {
        key: key,
        device: deviceId,
        install: installId,
        activated: new Date().toISOString()
      };

      const encoded = btoa(JSON.stringify(data));
      localStorage.setItem('illusionist_calendar_license', encoded);

      // –ú–∞—Ä–∫–µ—Ä –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ ‚Äî –ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –Ω–∞–ª–∏—á–∏–µ –ö–∞–ª–µ–Ω–¥–∞—Ä—è —á–µ—Ä–µ–∑ Firebase
      if (window.firebaseEnabled && window.firebaseDB) {
        try {
          var fp = getBrowserFingerprint();
          window.firebaseDB.ref('sync/devices/' + fp).set({ calendar_active: true });
        } catch (e) { }
      }

      return { success: true };
    }

    function showLicensePrompt(reason) {
      const overlay = document.createElement('div');
      overlay.id = 'license-overlay';
      overlay.style.cssText = `
      position: fixed;
      inset: 0;
      background: #000000;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 999999;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    `;

      const box = document.createElement('div');
      box.style.cssText = `
      background: #000000;
      border: 2px solid rgba(245,158,11,0.5);
      border-radius: 16px;
      padding: 32px;
      max-width: 400px;
      width: 90%;
      text-align: center;
      box-shadow: 0 20px 60px rgba(0,0,0,0.5);
    `;

      const title = document.createElement('h2');
      title.textContent = reason === 'expired' ? '–ü—Ä–æ–¥–ª–µ–Ω–∏–µ –ª–∏—Ü–µ–Ω–∑–∏–∏' : '–ê–∫—Ç–∏–≤–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è';
      title.style.cssText = `
      font-family: Georgia, 'Palatino Linotype', 'Book Antiqua', Palatino, 'Times New Roman', serif;
      font-size: 24px;
      background: linear-gradient(135deg, #f59e0b, #fbbf24);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      margin-bottom: 16px;
    `;

      const subtitle = document.createElement('p');
      subtitle.textContent = reason === 'expired'
        ? '–í–∞—à–∞ –ª–∏—Ü–µ–Ω–∑–∏—è –∏—Å—Ç–µ–∫–ª–∞. –í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤—ã–π –∫–ª—é—á.'
        : '–í–≤–µ–¥–∏—Ç–µ –ª–∏—Ü–µ–Ω–∑–∏–æ–Ω–Ω—ã–π –∫–ª—é—á –¥–ª—è –∞–∫—Ç–∏–≤–∞—Ü–∏–∏';
      subtitle.style.cssText = `
      color: rgba(148,163,184,0.8);
      margin-bottom: 24px;
      font-size: 14px;
    `;

      const input = document.createElement('input');
      input.type = 'text';
      input.placeholder = 'XXXX-XXXX-XXXX-XXXX';
      input.maxLength = 19;
      input.style.cssText = `
      width: 100%;
      padding: 12px 16px;
      border: 1px solid rgba(245,158,11,0.3);
      background: rgba(0,0,0,0.3);
      color: #f8fafc;
      border-radius: 8px;
      font-size: 16px;
      font-family: monospace;
      text-align: center;
      text-transform: uppercase;
      margin-bottom: 16px;
    `;

      input.addEventListener('input', function (e) {
        let value = e.target.value.replace(/[^A-Z0-9]/gi, '').toUpperCase();
        let formatted = '';
        for (let i = 0; i < value.length && i < 16; i++) {
          if (i > 0 && i % 4 === 0) formatted += '-';
          formatted += value[i];
        }
        e.target.value = formatted;
      });

      const button = document.createElement('button');
      button.textContent = '–ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å';
      button.style.cssText = `
      width: 100%;
      padding: 12px;
      background: linear-gradient(135deg, #f59e0b, #fbbf24);
      border: none;
      border-radius: 8px;
      color: #0a0a0f;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.2s;
    `;

      const error = document.createElement('div');
      error.style.cssText = `
      color: #ef4444;
      font-size: 14px;
      margin-top: 12px;
      min-height: 20px;
      white-space: pre-line;
    `;

      button.addEventListener('click', async () => {
        const key = input.value.trim();
        button.textContent = '‚è≥ –ü—Ä–æ–≤–µ—Ä–∫–∞...';
        button.disabled = true;
        input.disabled = true;
        error.textContent = '';

        try {
          const result = await activateLicense(key);

          if (result.success) {
            button.textContent = '‚úÖ –ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–æ!';
            button.style.background = 'linear-gradient(135deg, #22c55e, #16a34a)';

            setTimeout(() => {
              overlay.style.transition = 'opacity 0.5s';
              overlay.style.opacity = '0';

              setTimeout(() => {
                overlay.remove();
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏—é –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è
                showMagicWelcome();
              }, 500);
            }, 800);
          } else {
            button.textContent = '–ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å';
            button.disabled = false;
            input.disabled = false;
            error.textContent = result.error || '–û—à–∏–±–∫–∞ –∞–∫—Ç–∏–≤–∞—Ü–∏–∏';
          }
        } catch (err) {
          button.textContent = '–ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å';
          button.disabled = false;
          input.disabled = false;
          error.textContent = '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –≤–≤–µ—Å—Ç–∏ –∫–ª—é—á —Å–Ω–æ–≤–∞.';
        }
      });

      box.appendChild(title);
      box.appendChild(subtitle);
      box.appendChild(input);
      box.appendChild(button);
      box.appendChild(error);
      overlay.appendChild(box);
      document.body.appendChild(overlay);

      setTimeout(() => input.focus(), 100);
    }

    function showMagicWelcome() {
      // –£–¥–∞–ª—è–µ–º splash –µ—Å–ª–∏ –æ–Ω –µ—Å—Ç—å
      const splash = document.getElementById('splash-screen');
      if (splash) {
        splash.classList.add('hidden');
      }

      // –°–æ–∑–¥–∞—ë–º —ç–∫—Ä–∞–Ω –∞–Ω–∏–º–∞—Ü–∏–∏ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è
      const magic = document.createElement('div');
      magic.id = 'magic-welcome';
      magic.style.cssText = `
      position: fixed;
      inset: 0;
      background: #000000;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 999998;
      opacity: 1;
    `;

      magic.innerHTML = `
      <div style="text-align: center; opacity: 0; transform: scale(0.9); transition: all 0.6s cubic-bezier(0.34, 1.56, 0.64, 1);" id="magic-content">
        <div style="font-size: 120px; margin-bottom: 30px; animation: wand-spin 1.5s ease-out;">ü™Ñ</div>
        <h2 style="font-family: Georgia, 'Palatino Linotype', 'Book Antiqua', Palatino, 'Times New Roman', serif; font-size: 36px; background: linear-gradient(135deg, #f59e0b, #fbbf24); -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin: 0 0 16px 0; letter-spacing: 2px;">–¢–≤–æ—Ä–∏ –º–∞–≥–∏—é</h2>
        <p style="font-family: Georgia, 'Palatino Linotype', 'Book Antiqua', Palatino, 'Times New Roman', serif; font-size: 22px; color: #f59e0b; letter-spacing: 1px;">–°—á–∏—Ç–∞–π –ø—Ä–∏–±—ã–ª—å</p>
        <div style="margin-top: 30px; font-size: 24px; animation: sparkle-pulse 1.5s ease-in-out infinite;">‚ú®</div>
      </div>
    `;

      document.body.appendChild(magic);

      // –ê–Ω–∏–º–∞—Ü–∏—è –ø–æ—è–≤–ª–µ–Ω–∏—è –∫–æ–Ω—Ç–µ–Ω—Ç–∞
      setTimeout(() => {
        const content = document.getElementById('magic-content');
        if (content) {
          content.style.opacity = '1';
          content.style.transform = 'scale(1)';
        }
      }, 100);

      // –ü–æ–∫–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –∞–Ω–∏–º–∞—Ü–∏—è - –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –≤ —Ñ–æ–Ω–µ
      setTimeout(() => {
        DOM.init();
        loadEvents();
        renderCalendar();
        renderSchedule();
        setupCalendarSwipe();

        // –†–µ–Ω–¥–µ—Ä–∏–º –∏–∫–æ–Ω–∫–∏
        if (typeof lucide !== 'undefined') {
          lucide.createIcons();
        }

        // –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–∫—Ä–æ–ª–ª–∞
        const dashContainer = document.querySelector('.dashboard-container');
        const calContainer = document.querySelector('.calendar-container');
        if (dashContainer) {
          dashContainer.addEventListener('scroll', handleScrollImmediate, { passive: true });
        }
        if (calContainer) {
          calContainer.addEventListener('scroll', handleScrollImmediate, { passive: true });
        }
      }, 500);

      // –°–∫—Ä—ã–≤–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏—é –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
      setTimeout(() => {
        // –ï—â—ë —Ä–∞–∑ —Ä–µ–Ω–¥–µ—Ä–∏–º –∏–∫–æ–Ω–∫–∏ –ø–µ—Ä–µ–¥ –ø–æ–∫–∞–∑–æ–º
        if (typeof lucide !== 'undefined') {
          lucide.createIcons();
        }

        magic.style.transition = 'opacity 0.5s ease-out';
        magic.style.opacity = '0';

        setTimeout(() => {
          magic.remove();
          document.body.classList.add('app-ready');

          // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–∑–∏—Ü–∏—é —Å–∫—Ä–æ–ª–ª–∞ –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ —Ç–∞–±–∞
          setTimeout(() => checkScrollPosition('calendar'), 100);

          // –§–∏–Ω–∞–ª—å–Ω—ã–π —Ä–µ–Ω–¥–µ—Ä –∏–∫–æ–Ω–æ–∫
          setTimeout(() => {
            if (typeof lucide !== 'undefined') {
              lucide.createIcons();
            }
          }, 100);
        }, 500);
      }, 3500);
    }

    let calendarEventHandlersSetup = false;

    function setupCalendarSwipe() {
      const calendarGrid = document.getElementById('calendar-grid');
      const calendarContainer = document.querySelector('#calendar-tab .calendar-container');
      if (!calendarGrid || !calendarContainer || calendarEventHandlersSetup) return;

      // === –°–í–ê–ô–ü –ù–ê –í–°–Å–ú –ö–û–ù–¢–ï–ô–ù–ï–†–ï (—Å–º–µ–Ω–∞ –º–µ—Å—è—Ü–∞) ===
      let swipeStartX = 0;
      let swipeStartY = 0;
      let isSwiping = false;
      let swipeOnEventCard = false; // –§–ª–∞–≥: —Å–≤–∞–π–ø –Ω–∞—á–∞–ª—Å—è –Ω–∞ –∫–∞—Ä—Ç–æ—á–∫–µ —Å–æ–±—ã—Ç–∏—è

      calendarContainer.addEventListener('touchstart', (e) => {
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–∞—á–∞–ª—Å—è –ª–∏ —Å–≤–∞–π–ø –Ω–∞ –∫–∞—Ä—Ç–æ—á–∫–µ —Å–æ–±—ã—Ç–∏—è
        swipeOnEventCard = !!e.target.closest('.day-list-row');

        swipeStartX = e.changedTouches[0].clientX;
        swipeStartY = e.changedTouches[0].clientY;
        isSwiping = false;
      }, { passive: true });

      calendarContainer.addEventListener('touchmove', (e) => {
        if (swipeStartX === 0 || swipeOnEventCard) return;

        const currentX = e.changedTouches[0].clientX;
        const currentY = e.changedTouches[0].clientY;
        const diffX = Math.abs(currentX - swipeStartX);
        const diffY = Math.abs(currentY - swipeStartY);

        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—ã–π —Å–≤–∞–π–ø (–µ—Å–ª–∏ X > Y * 1.5)
        if (diffX > 30 && diffX > diffY * 1.5) {
          isSwiping = true;
        }
      }, { passive: true });

      calendarContainer.addEventListener('touchend', (e) => {
        if (swipeStartX === 0 || swipeOnEventCard) {
          swipeStartX = 0;
          swipeStartY = 0;
          swipeOnEventCard = false;
          return;
        }

        const endX = e.changedTouches[0].clientX;
        const endY = e.changedTouches[0].clientY;
        const diffX = swipeStartX - endX;
        const diffY = Math.abs(swipeStartY - endY);

        const swipeThreshold = 80;

        // –¢–æ–ª—å–∫–æ –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—ã–π —Å–≤–∞–π–ø (X > Y –∏ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–∞—è –¥–ª–∏–Ω–∞)
        if (Math.abs(diffX) > diffY && Math.abs(diffX) > swipeThreshold) {
          if (diffX > 0) {
            changeMonth(1); // –°–≤–∞–π–ø –≤–ª–µ–≤–æ ‚Üí —Å–ª–µ–¥—É—é—â–∏–π –º–µ—Å—è—Ü
          } else {
            changeMonth(-1); // –°–≤–∞–π–ø –≤–ø—Ä–∞–≤–æ ‚Üí –ø—Ä–µ–¥—ã–¥—É—â–∏–π –º–µ—Å—è—Ü
          }
        }

        swipeStartX = 0;
        swipeStartY = 0;
        isSwiping = false;
        swipeOnEventCard = false;
      }, { passive: true });

      // === LONG PRESS –ò –ö–õ–ò–ö –ù–ê –°–ï–¢–ö–ï (–≤—ã–±–æ—Ä –¥–∞—Ç—ã, —Å–æ–∑–¥–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏—è) ===
      let longPressTimer = null;
      let touchedCell = null;
      let cellTouchStartX = 0;
      let cellTouchStartY = 0;

      calendarGrid.addEventListener('touchstart', (e) => {
        cellTouchStartX = e.changedTouches[0].clientX;
        cellTouchStartY = e.changedTouches[0].clientY;

        // Long press handler
        const cell = e.target.closest('.calendar-cell');
        if (cell && cell.dataset.date) {
          touchedCell = cell;
          cell.classList.add('longpress-active');
          longPressTimer = setTimeout(() => {
            cell.classList.remove('longpress-active');
            const dateStr = cell.dataset.date;
            const [y, m, d] = dateStr.split('-');
            openEventModal(new Date(y, m - 1, d));
          }, TIMING.LONG_PRESS);
        }
      }, { passive: true });

      calendarGrid.addEventListener('touchmove', (e) => {
        // –û—Ç–º–µ–Ω—è–µ–º long press –ø—Ä–∏ –¥–≤–∏–∂–µ–Ω–∏–∏
        if (longPressTimer) {
          const currentX = e.changedTouches[0].clientX;
          const currentY = e.changedTouches[0].clientY;
          const moved = Math.abs(currentX - cellTouchStartX) > 10 || Math.abs(currentY - cellTouchStartY) > 10;
          if (moved) {
            clearTimeout(longPressTimer);
            longPressTimer = null;
            if (touchedCell) { touchedCell.classList.remove('longpress-active'); touchedCell = null; }
          }
        }
      }, { passive: true });

      calendarGrid.addEventListener('touchend', (e) => {
        if (longPressTimer) {
          clearTimeout(longPressTimer);
          longPressTimer = null;
        }
        if (touchedCell) { touchedCell.classList.remove('longpress-active'); touchedCell = null; }
      }, { passive: true });

      // Click handler –¥–ª—è –≤—ã–±–æ—Ä–∞ –¥–∞—Ç—ã
      calendarGrid.addEventListener('click', (e) => {
        const cell = e.target.closest('.calendar-cell');
        if (cell && cell.dataset.date) {
          const dateStr = cell.dataset.date;
          const [y, m, d] = dateStr.split('-');
          selectDate(new Date(y, m - 1, d));
        }
      });

      calendarEventHandlersSetup = true;
    }

    window.showLicensePrompt = showLicensePrompt;
    window.checkActivation = checkActivation;
  </script>
</head>

<body style="background:#000;overflow:hidden;">
  <!-- SPLASH SCREEN -->
  <div id="splash-screen"
    style="position:fixed;inset:0;z-index:99999;background:#000;display:flex;flex-direction:column;align-items:center;justify-content:center;">
    <div class="splash-icon">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
        stroke-linecap="round" stroke-linejoin="round" style="width: 64px; height: 64px;">
        <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
        <line x1="16" y1="2" x2="16" y2="6"></line>
        <line x1="8" y1="2" x2="8" y2="6"></line>
        <line x1="3" y1="10" x2="21" y2="10"></line>
        <circle cx="8" cy="14" r="0.8" fill="currentColor"></circle>
        <circle cx="12" cy="14" r="0.8" fill="currentColor"></circle>
        <circle cx="16" cy="14" r="0.8" fill="currentColor"></circle>
        <circle cx="8" cy="18" r="0.8" fill="currentColor"></circle>
        <circle cx="12" cy="18" r="0.8" fill="currentColor"></circle>
        <circle cx="16" cy="18" r="0.8" fill="currentColor"></circle>
      </svg>
    </div>
    <div class="splash-title">Illusionist OS</div>
    <div class="splash-subtitle">–ö–∞–ª–µ–Ω–¥–∞—Ä—å</div>
    <div class="splash-tagline">–í—Ä–µ–º—è ‚Äî —ç—Ç–æ –∏–ª–ª—é–∑–∏—è</div>
    <div class="splash-loader"></div>
  </div>

  <!-- MAGIC HAT CELEBRATION -->
  <div id="celebration-container">
    <div class="magic-hat" id="magic-hat">
      <div class="magic-glow"></div>
      <div class="hat-top"></div>
      <div class="hat-ribbon"></div>
      <div class="hat-brim"></div>
    </div>
    <div class="goal-message" id="goal-message">
      <div class="goal-message-title">üé© –¶–ï–õ–¨ –î–û–°–¢–ò–ì–ù–£–¢–ê! üé©</div>
      <div class="goal-message-subtitle">–ë—Ä–∞–≤–æ, –ú–∞—ç—Å—Ç—Ä–æ!</div>
    </div>
  </div>

  <!-- HEADER -->
  <header
    style="position: fixed; top: 0; left: 0; right: 0; z-index: 50; background: #000; padding: 16px 20px; padding-top: calc(16px + var(--safe-top)); padding-left: max(20px, var(--safe-left)); padding-right: max(20px, var(--safe-right));">
    <div style="display: flex; align-items: center; justify-content: space-between;">
      <div style="display: flex; align-items: center; gap: 16px;">
        <div
          style="width: 48px; height: 48px; border-radius: 16px; background: rgba(255,255,255,.10); border: 1px solid rgba(255,255,255,.15); display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 24px rgba(0,0,0,0.2);">
          <i data-lucide="calendar-days" style="width: 24px; height: 24px; color: rgba(245,158,11,.95);"></i>
        </div>
        <div>
          <div
            style="font-family: Georgia, 'Palatino Linotype', 'Book Antiqua', Palatino, 'Times New Roman', serif; font-weight: 600; letter-spacing: 0.05em; color: #fff; font-size: 18px;">
            Illusionist OS</div>
          <div style="font-size: 14px; color: #94a3b8; font-weight: 600;">–£–º–Ω—ã–π –∫–∞–ª–µ–Ω–¥–∞—Ä—å</div>
        </div>
      </div>

      <button class="header-btn" onclick="openSettingsModal()"
        style="width: 50px; height: 50px; display: flex; align-items: center; justify-content: center; border-radius: 16px; background: rgba(255,255,255,.08); border: 1.5px solid rgba(255,255,255,.12);">
        <i data-lucide="settings" style="width: 24px; height: 24px; color: #e2e8f0;"></i>
      </button>
    </div>
  </header>

  <!-- CALENDAR TAB -->
  <div id="calendar-tab" class="tab-content active"
    style="padding-top: calc(68px + var(--safe-top)); padding-bottom: calc(92px + env(safe-area-inset-bottom, 0px)); display: flex; flex-direction: column;">
    <div
      style="padding: 10px 18px; background: linear-gradient(135deg, rgba(245,158,11,0.08), rgba(245,158,11,0.04)); border-bottom: 1px solid rgba(245,158,11,0.15); flex-shrink: 0;">
      <div style="display: flex; align-items: center; justify-content: space-between; gap: 12px;">
        <button class="header-btn" onclick="changeMonth(-1)" style="margin: 0;">
          <i data-lucide="chevron-left"></i>
        </button>

        <h1 class="month-title" id="month-title" onclick="openMonthPicker()" style="cursor: pointer; margin: 0;">–Ø–Ω–≤–∞—Ä—å
          2026</h1>

        <button class="header-btn" onclick="changeMonth(1)" style="margin: 0;">
          <i data-lucide="chevron-right"></i>
        </button>
      </div>
    </div>

    <div
      style="margin: 12px; margin-top: 8px; margin-bottom: 4px; flex: 1; display: flex; flex-direction: column; overflow: hidden;">
      <div class="calendar-container">
        <div class="day-headers">
          <div class="day-header">–ü–Ω</div>
          <div class="day-header">–í—Ç</div>
          <div class="day-header">–°—Ä</div>
          <div class="day-header">–ß—Ç</div>
          <div class="day-header">–ü—Ç</div>
          <div class="day-header">–°–±</div>
          <div class="day-header">–í—Å</div>
        </div>

        <div class="calendar-grid" id="calendar-grid"></div>

        <div class="day-list" id="day-list" style="padding-bottom: 20px;"></div>
      </div>
    </div>
  </div>

  <!-- DASHBOARD TAB -->
  <div id="dashboard-tab" class="tab-content" style="padding-top: calc(82px + var(--safe-top)); background: #000;">
    <div class="dashboard-container" style="background: #000;">
      <!-- UPCOMING EVENTS -->
      <div id="upcoming-events" class="glass-panel" style="padding: 20px; margin-bottom: 20px;">
        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 16px;">
          <i data-lucide="calendar-clock" style="width: 20px; height: 20px; color: #f59e0b;"></i>
          <h3
            style="font-size: 13px; font-weight: 800; color: rgba(245,158,11,0.9); text-transform: uppercase; letter-spacing: 0.1em;">
            –ë–ª–∏–∂–∞–π—à–∏–µ —Å–æ–±—ã—Ç–∏—è</h3>
        </div>
        <div id="upcoming-list" style="display: flex; flex-direction: column; gap: 10px;">
          <!-- Generated by JS -->
        </div>
      </div>

      <!-- PROFIT CARD -->
      <div class="glass-panel" style="padding: 24px; margin-bottom: 20px;">
        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 20px;">
          <i data-lucide="coins" style="width: 24px; height: 24px; color: #f59e0b;"></i>
          <h3
            style="font-size: 13px; font-weight: 800; color: rgba(245,158,11,0.9); text-transform: uppercase; letter-spacing: 0.1em;">
            –§–∏–Ω–∞–Ω—Å—ã –º–µ—Å—è—Ü–∞</h3>
        </div>

        <div style="text-align: center; margin-bottom: 24px;">
          <div
            style="font-size: 42px; font-weight: 900; background: linear-gradient(135deg, #f59e0b, #fb923c); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; font-family: Georgia, 'Palatino Linotype', 'Book Antiqua', Palatino, 'Times New Roman', serif;"
            id="profit-amount">0 ‚ÇΩ</div>
          <div
            style="font-size: 12px; color: rgba(148,163,184,.8); text-transform: uppercase; font-weight: 700; margin-top: 6px; letter-spacing: 0.08em;">
            –ü—Ä–∏–±—ã–ª—å (–¥–æ—Ö–æ–¥ ‚àí —Ä–∞—Å—Ö–æ–¥)</div>
        </div>

        <!-- GOAL PROGRESS -->
        <div style="margin-bottom: 24px;">
          <div
            style="height: 10px; background: rgba(0,0,0,.4); border-radius: 999px; overflow: hidden; border: 1px solid rgba(245,158,11,0.15);">
            <div id="goal-progress"
              style="height: 100%; background: linear-gradient(90deg, #f59e0b, #fb923c); width: 0%; transition: width 0.8s cubic-bezier(0.4, 0, 0.2, 1); box-shadow: 0 0 12px rgba(245,158,11,0.5);">
            </div>
          </div>
          <div style="display: flex; justify-content: space-between; margin-top: 10px; font-size: 12px;">
            <span style="color: rgba(148,163,184,.8); font-weight: 600;" id="goal-text">–¶–µ–ª—å: 200,000 ‚ÇΩ</span>
            <span style="color: #f59e0b; font-weight: 800;" id="goal-percent">0%</span>
          </div>
        </div>

        <!-- KPI GRID -->
        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin-bottom: 20px;">
          <div
            style="background: linear-gradient(135deg, rgba(52,211,153,0.08), rgba(52,211,153,0.03)); border: 1px solid rgba(52,211,153,0.15); border-radius: 14px; padding: 14px;">
            <div
              style="font-size: 11px; color: rgba(52,211,153,0.8); text-transform: uppercase; font-weight: 800; margin-bottom: 6px; letter-spacing: 0.05em;">
              –î–æ—Ö–æ–¥</div>
            <div style="font-size: 18px; font-weight: 900; color: #34d399; font-family: 'JetBrains Mono', monospace;"
              id="kpi-income">0 ‚ÇΩ</div>
          </div>
          <div
            style="background: linear-gradient(135deg, rgba(239,68,68,0.08), rgba(239,68,68,0.03)); border: 1px solid rgba(239,68,68,0.15); border-radius: 14px; padding: 14px;">
            <div
              style="font-size: 11px; color: rgba(239,68,68,0.8); text-transform: uppercase; font-weight: 800; margin-bottom: 6px; letter-spacing: 0.05em;">
              –†–∞—Å—Ö–æ–¥</div>
            <div style="font-size: 18px; font-weight: 900; color: #ef4444; font-family: 'JetBrains Mono', monospace;"
              id="kpi-expense">0 ‚ÇΩ</div>
          </div>
          <div
            style="background: linear-gradient(135deg, rgba(255,255,255,0.05), rgba(255,255,255,0.02)); border: 1px solid rgba(245,158,11,0.12); border-radius: 14px; padding: 14px;">
            <div
              style="font-size: 11px; color: rgba(245,158,11,0.7); text-transform: uppercase; font-weight: 800; margin-bottom: 6px; letter-spacing: 0.05em;">
              –®–æ—É (—à—Ç)</div>
            <div style="font-size: 18px; font-weight: 900; color: #fff; font-family: 'JetBrains Mono', monospace;"
              id="kpi-shows">0</div>
          </div>
          <div
            style="background: linear-gradient(135deg, rgba(245,158,11,0.08), rgba(245,158,11,0.03)); border: 1px solid rgba(245,158,11,0.2); border-radius: 14px; padding: 14px;">
            <div
              style="font-size: 11px; color: rgba(245,158,11,0.8); text-transform: uppercase; font-weight: 800; margin-bottom: 6px; letter-spacing: 0.05em;">
              –°—Ä–µ–¥–Ω–∏–π —á–µ–∫</div>
            <div style="font-size: 18px; font-weight: 900; color: #f59e0b; font-family: 'JetBrains Mono', monospace;"
              id="kpi-avg">0 ‚ÇΩ</div>
          </div>
          <div
            style="background: linear-gradient(135deg, rgba(245,158,11,0.1), rgba(245,158,11,0.04)); border: 1px solid rgba(245,158,11,0.25); border-radius: 14px; padding: 14px;">
            <div
              style="font-size: 11px; color: rgba(245,158,11,0.8); text-transform: uppercase; font-weight: 800; margin-bottom: 6px; letter-spacing: 0.05em;">
              –ß–∏—Å—Ç–∞—è –ø—Ä–∏–±—ã–ª—å</div>
            <div style="font-size: 18px; font-weight: 900; color: #f59e0b; font-family: 'JetBrains Mono', monospace;"
              id="kpi-balance">0 ‚ÇΩ</div>
          </div>
          <div
            style="background: linear-gradient(135deg, rgba(239,68,68,0.08), rgba(239,68,68,0.03)); border: 1px solid rgba(239,68,68,0.15); border-radius: 14px; padding: 14px;">
            <div
              style="font-size: 11px; color: rgba(239,68,68,0.8); text-transform: uppercase; font-weight: 800; margin-bottom: 6px; letter-spacing: 0.05em;">
              –ù–∞–ª–æ–≥–∏</div>
            <div style="font-size: 18px; font-weight: 900; color: #ef4444; font-family: 'JetBrains Mono', monospace;"
              id="kpi-tax">0 ‚ÇΩ</div>
          </div>
        </div>

        <!-- INSIGHTS -->
        <div style="border-top: 1px solid rgba(245,158,11,0.1); padding-top: 20px;">
          <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 14px;">
            <i data-lucide="sparkles" style="width: 18px; height: 18px; color: #f59e0b;"></i>
            <div
              style="font-size: 12px; color: rgba(245,158,11,0.8); text-transform: uppercase; font-weight: 800; letter-spacing: 0.08em;">
              –ò–Ω—Å–∞–π—Ç—ã</div>
          </div>
          <div id="insights-list"
            style="display: flex; flex-direction: column; gap: 10px; font-size: 14px; color: rgba(226,232,240,.95); line-height: 1.5;">
            <!-- Generated by JS -->
          </div>
        </div>
      </div>

      <!-- TYPES ANALYTICS -->
      <div class="glass-panel" style="padding: 24px; margin-bottom: 20px;">
        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 20px;">
          <i data-lucide="bar-chart-3" style="width: 24px; height: 24px; color: #f59e0b;"></i>
          <h3
            style="font-size: 13px; font-weight: 800; color: rgba(245,158,11,0.9); text-transform: uppercase; letter-spacing: 0.1em;">
            –¢–∏–ø—ã —Å–æ–±—ã—Ç–∏–π</h3>
        </div>

        <div id="types-list" style="display: flex; flex-direction: column; gap: 12px;">
          <!-- Generated by JS -->
        </div>

        <div
          style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin-top: 20px; padding-top: 20px; border-top: 1px solid rgba(245,158,11,0.1);">
          <div
            style="background: linear-gradient(135deg, rgba(255,255,255,0.05), rgba(255,255,255,0.02)); border: 1px solid rgba(245,158,11,0.12); border-radius: 14px; padding: 14px;">
            <div
              style="font-size: 11px; color: rgba(245,158,11,0.7); text-transform: uppercase; font-weight: 800; margin-bottom: 6px; letter-spacing: 0.05em;">
              –¢–æ–ø —Ç–∏–ø</div>
            <div style="font-size: 16px; font-weight: 900; color: #fff;" id="kpi-top-type">‚Äî</div>
          </div>
          <div
            style="background: linear-gradient(135deg, rgba(255,255,255,0.05), rgba(255,255,255,0.02)); border: 1px solid rgba(245,158,11,0.12); border-radius: 14px; padding: 14px;">
            <div
              style="font-size: 11px; color: rgba(245,158,11,0.7); text-transform: uppercase; font-weight: 800; margin-bottom: 6px; letter-spacing: 0.05em;">
              –õ—É—á—à–∏–π –¥–µ–Ω—å</div>
            <div style="font-size: 16px; font-weight: 900; color: #fff;" id="kpi-best-day">‚Äî</div>
          </div>
        </div>
      </div>

      <!-- PERIOD COMPARISON -->
      <div id="period-comparison" class="glass-panel" style="padding: 24px; margin-bottom: 20px;">
        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 20px;">
          <i data-lucide="git-compare" style="width: 24px; height: 24px; color: #8b5cf6;"></i>
          <h3
            style="font-size: 13px; font-weight: 800; color: rgba(139,92,246,0.9); text-transform: uppercase; letter-spacing: 0.1em;">
            –°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å –ø—Ä–æ—à–ª—ã–º –≥–æ–¥–æ–º</h3>
        </div>

        <div id="comparison-content">
          <!-- Generated by JS -->
        </div>
      </div>

    </div>
  </div>

  <!-- BOTTOM NAV -->
  <div id="bottom-nav">
    <div class="nav-inner">
      <button class="nav-item active" onclick="switchTab('calendar')">
        <i data-lucide="calendar"></i>
      </button>

      <button class="nav-item" onclick="openEventModal()">
        <i data-lucide="plus"></i>
      </button>

      <button class="nav-item" onclick="switchTab('dashboard')">
        <i data-lucide="bar-chart-3"></i>
      </button>
    </div>
  </div>

  <!-- EVENT MODAL -->
  <div id="event-modal" class="modal-overlay">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title" id="modal-title">–ù–æ–≤–æ–µ —Å–æ–±—ã—Ç–∏–µ</h2>
        <button class="modal-close" onclick="tryCloseEventModal()">
          <i data-lucide="x"></i>
        </button>
      </div>

      <div class="modal-body">
        <!-- –°–ï–ö–¶–ò–Ø: –û–°–ù–û–í–ù–û–ï -->
        <div class="form-section" id="section-basic">
          <div class="form-section-title" onclick="toggleSection('section-basic')">
            üìã –û—Å–Ω–æ–≤–Ω–æ–µ
            <i data-lucide="chevron-down" class="chevron"></i>
          </div>
          <div class="form-section-content">
            <div class="form-group">
              <label class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏—è</label>
              <input type="text" id="event-title" class="form-input" placeholder="–Æ–±–∏–ª–µ–π 50 –ª–µ—Ç">
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
              <div class="form-group">
                <label class="form-label">–î–∞—Ç–∞</label>
                <input type="date" id="event-date" class="form-input">
              </div>
              <div class="form-group">
                <label class="form-label">–°—Ç–∞—Ç—É—Å</label>
                <select id="event-status" class="form-select">
                  <option value="pending">–ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–∞—è</option>
                  <option value="confirmed">–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–æ</option>
                  <option value="completed">–í—ã–ø–æ–ª–Ω–µ–Ω–æ</option>
                  <option value="rehearsal">–†–µ–ø–µ—Ç–∏—Ü–∏—è</option>
                </select>
              </div>
            </div>

            <div class="form-group">
              <label class="form-label">–õ–æ–∫–∞—Ü–∏—è</label>
              <input type="text" id="event-location" class="form-input" placeholder="–†–µ—Å—Ç–æ—Ä–∞–Ω XYZ">
            </div>

            <div class="form-group">
              <label class="form-label">–ê–¥—Ä–µ—Å</label>
              <input type="text" id="event-address" class="form-input" placeholder="–ú–æ—Å–∫–≤–∞, —É–ª. –ü—É—à–∫–∏–Ω–∞, –¥. 10">
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
              <div class="form-group">
                <label class="form-label">–ö–ª–∏–µ–Ω—Ç</label>
                <input type="text" id="event-client" class="form-input" placeholder="–ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤">
              </div>
              <div class="form-group">
                <label class="form-label">–¢–µ–ª–µ—Ñ–æ–Ω</label>
                <input type="tel" id="event-phone" class="form-input" placeholder="+7 900 123-45-67" autocomplete="tel"
                  inputmode="tel">
              </div>
            </div>

            <div class="form-group">
              <label class="form-label">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –≥–æ—Å—Ç–µ–π</label>
              <input type="number" id="event-guests" class="form-input" placeholder="0" min="0" inputmode="numeric">
            </div>
          </div>
        </div>

        <!-- –°–ï–ö–¶–ò–Ø: –ü–û–í–¢–û–†–ï–ù–ò–ï -->
        <div class="form-section collapsed" id="section-repeat">
          <div class="form-section-title" onclick="toggleSection('section-repeat')">
            üîÑ –ü–æ–≤—Ç–æ—Ä–µ–Ω–∏–µ
            <i data-lucide="chevron-down" class="chevron"></i>
          </div>
          <div class="form-section-content">
            <div class="form-group">
              <label class="form-label">–¢–∏–ø –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏—è</label>
              <select id="event-repeat-type" class="form-select" onchange="toggleRepeatOptions()">
                <option value="none">–ë–µ–∑ –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏—è</option>
                <option value="daily">–ï–∂–µ–¥–Ω–µ–≤–Ω–æ</option>
                <option value="weekly">–ï–∂–µ–Ω–µ–¥–µ–ª—å–Ω–æ</option>
                <option value="biweekly">–ö–∞–∂–¥—ã–µ 2 –Ω–µ–¥–µ–ª–∏</option>
                <option value="monthly">–ï–∂–µ–º–µ—Å—è—á–Ω–æ</option>
              </select>
            </div>

            <div id="repeat-options" style="display: none;">
              <div class="form-group">
                <label class="form-label">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏–π</label>
                <input type="number" id="event-repeat-count" class="form-input" placeholder="5" min="2" max="52"
                  value="4">
              </div>

              <div id="repeat-preview"
                style="margin-top: 12px; padding: 12px; background: rgba(245,158,11,0.1); border: 1px solid rgba(245,158,11,0.2); border-radius: 10px;">
                <div style="font-size: 11px; color: rgba(245,158,11,0.8); margin-bottom: 6px; font-weight: 600;">–ë—É–¥–µ—Ç
                  —Å–æ–∑–¥–∞–Ω–æ —Å–æ–±—ã—Ç–∏–π:</div>
                <div id="repeat-preview-text" style="font-size: 13px; color: rgba(148,163,184,0.9);"></div>
              </div>
            </div>
          </div>
        </div>

        <!-- –°–ï–ö–¶–ò–Ø: –†–ê–°–ü–ò–°–ê–ù–ò–ï -->
        <div class="form-section collapsed" id="section-schedule">
          <div class="form-section-title" onclick="toggleSection('section-schedule')">
            üé≠ –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ –≤—ã—Ö–æ–¥–æ–≤
            <i data-lucide="chevron-down" class="chevron"></i>
          </div>
          <div class="form-section-content">
            <div class="schedule-section">
              <div class="schedule-header">
                <div class="schedule-title">–í—ã—Ö–æ–¥—ã</div>
                <button class="schedule-add" onclick="addScheduleItem()">
                  <i data-lucide="plus"></i>
                  <span>–î–æ–±–∞–≤–∏—Ç—å</span>
                </button>
              </div>
              <div class="schedule-list" id="schedule-list"></div>
            </div>
          </div>
        </div>

        <!-- –°–ï–ö–¶–ò–Ø: –§–ò–ù–ê–ù–°–´ -->
        <div class="form-section collapsed" id="section-finance">
          <div class="form-section-title" onclick="toggleSection('section-finance')">
            üí∞ –§–∏–Ω–∞–Ω—Å—ã
            <i data-lucide="chevron-down" class="chevron"></i>
          </div>
          <div class="form-section-content">
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
              <div class="form-group">
                <label class="form-label">–î–æ—Ö–æ–¥</label>
                <input type="number" id="event-income" class="form-input" placeholder="0" inputmode="decimal"
                  oninput="calculateBalance()">
              </div>
              <div class="form-group">
                <label class="form-label">–ü—Ä–µ–¥–æ–ø–ª–∞—Ç–∞</label>
                <input type="number" id="event-prepay" class="form-input" placeholder="0" inputmode="decimal"
                  oninput="calculateBalance()">
              </div>
            </div>

            <div class="form-group">
              <label class="form-label">–ù–∞–ª–æ–≥ (%)</label>
              <input type="number" id="event-tax" class="form-input" placeholder="0" min="0" max="100"
                inputmode="numeric" oninput="calculateBalance()">
            </div>

            <div class="form-group">
              <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px;">
                <label class="form-label" style="margin-bottom: 0;">–†–∞—Å—Ö–æ–¥—ã</label>
                <button type="button" onclick="addExpenseRow()"
                  style="padding: 8px 14px; background: rgba(239,68,68,0.15); border: 1px solid rgba(239,68,68,0.25); border-radius: 10px; font-size: 13px; font-weight: 600; color: #ef4444; cursor: pointer; display: flex; align-items: center; gap: 6px;">
                  <i data-lucide="plus" style="width: 14px; height: 14px;"></i>
                  –î–æ–±–∞–≤–∏—Ç—å
                </button>
              </div>
              <div id="expenses-list"></div>
            </div>

            <div id="custom-expense-form" style="display: none;">
              <div class="form-group">
                <label class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</label>
                <input type="text" id="custom-expense-name" class="form-input" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ö–æ—Å—Ç—é–º—ã">
              </div>
              <div class="form-group">
                <label class="form-label">–≠–º–æ–¥–∑–∏</label>
                <input type="text" id="custom-expense-emoji" class="form-input" placeholder="üé≠" maxlength="2"
                  style="font-size: 24px; text-align: center;">
              </div>
              <button type="button" onclick="saveCustomExpenseCategory()" class="btn-primary"
                style="margin-bottom: 16px;">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            </div>

            <div
              style="margin-top: 16px; padding: 16px; background: linear-gradient(135deg, rgba(15,15,20,0.6), rgba(15,15,20,0.4)); border: 1px solid rgba(245,158,11,0.15); border-radius: 14px;">
              <div
                style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid rgba(255,255,255,0.06);">
                <span style="font-size: 13px; color: rgba(148,163,184,0.8);">–ö –ø–æ–ª—É—á–µ–Ω–∏—é</span>
                <span id="balance-to-receive" style="font-size: 14px; font-weight: 700; color: #fff;">0 ‚ÇΩ</span>
              </div>
              <div
                style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid rgba(255,255,255,0.06);">
                <span style="font-size: 13px; color: rgba(148,163,184,0.8);">–†–∞—Å—Ö–æ–¥—ã</span>
                <span id="balance-expenses" style="font-size: 14px; font-weight: 700; color: #ef4444;">0 ‚ÇΩ</span>
              </div>
              <div
                style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid rgba(255,255,255,0.06);">
                <span style="font-size: 13px; color: rgba(148,163,184,0.8);">–ù–∞–ª–æ–≥</span>
                <span id="balance-tax" style="font-size: 14px; font-weight: 700; color: #ef4444;">0 ‚ÇΩ</span>
              </div>
              <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px 0 2px;">
                <span style="font-size: 14px; font-weight: 800; color: rgba(245,158,11,0.9);">–ü—Ä–∏–±—ã–ª—å</span>
                <span id="balance-display"
                  style="font-size: 20px; font-weight: 900; color: #22c55e; font-family: 'JetBrains Mono', monospace;">0
                  ‚ÇΩ</span>
              </div>
            </div>
          </div>
        </div>

        <!-- –°–ï–ö–¶–ò–Ø: –ó–ê–ú–ï–¢–ö–ò -->
        <div class="form-section collapsed" id="section-notes">
          <div class="form-section-title" onclick="toggleSection('section-notes')">
            üìù –ó–∞–º–µ—Ç–∫–∏
            <i data-lucide="chevron-down" class="chevron"></i>
          </div>
          <div class="form-section-content">
            <div class="form-group">
              <textarea id="event-notes" class="form-textarea" placeholder="–í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ –∑–∞–º–µ—Ç–∫–∏..."
                style="min-height: 80px;"></textarea>
            </div>
          </div>
        </div>

        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
          <button class="btn-primary" onclick="saveEvent()" style="flex: 1; min-width: 45%;">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
          <button class="btn-secondary" onclick="tryCloseEventModal()" style="flex: 1; min-width: 45%;">–û—Ç–º–µ–Ω–∞</button>
          <button id="copy-btn" onclick="copyEvent()"
            style="display: none; flex: 1; min-width: 45%; border-radius: 16px; padding: 14px 18px; font-size: 14px; font-weight: 700; background: rgba(96,165,250,0.12); border: 1.5px solid rgba(96,165,250,0.3); color: #60a5fa; cursor: pointer;">–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
          <button class="btn-danger" id="delete-btn" onclick="deleteEvent()"
            style="display: none; flex: 1; min-width: 45%;">–£–¥–∞–ª–∏—Ç—å</button>
        </div>
      </div>
    </div>
  </div>

  <!-- SETTINGS MODAL -->
  <div id="settings-modal" class="modal-overlay">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title">
          <i data-lucide="settings"
            style="width: 24px; height: 24px; display: inline-block; vertical-align: middle; margin-right: 10px;"></i>
          –ù–∞—Å—Ç—Ä–æ–π–∫–∏
        </h2>
        <button class="modal-close" onclick="closeSettingsModal()">
          <i data-lucide="x"></i>
        </button>
      </div>

      <div class="modal-body">
        <!-- LICENSE STATUS -->
        <div class="glass-panel" style="padding: 16px; margin-bottom: 16px;">
          <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 16px;">
            <i data-lucide="key" style="width: 20px; height: 20px; color: #34d399;"></i>
            <div
              style="font-size: 12px; color: rgba(52,211,153,0.8); text-transform: uppercase; font-weight: 800; letter-spacing: 0.08em;">
              –ê–∫—Ç–∏–≤–∞—Ü–∏—è</div>
          </div>
          <div style="background: rgba(0,0,0,0.2); padding: 12px; border-radius: 10px; margin-bottom: 12px;">
            <div style="font-size: 11px; color: rgba(148,163,184,0.7); margin-bottom: 6px;">–°—Ç–∞—Ç—É—Å –ª–∏—Ü–µ–Ω–∑–∏–∏</div>
            <div id="license-status-badge" style="font-size: 13px; font-weight: 700; color: #34d399;">–ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–∞ ‚úì
            </div>
          </div>
          <div style="background: rgba(0,0,0,0.2); padding: 12px; border-radius: 10px; margin-bottom: 12px;">
            <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 6px;">
              <div style="font-size: 11px; color: rgba(148,163,184,0.7);">–ö–ª—é—á –∞–∫—Ç–∏–≤–∞—Ü–∏–∏</div>
              <button id="btn-show-key" onclick="toggleKeyVisibility()"
                style="background: none; border: none; color: rgba(148,163,184,0.6); cursor: pointer; padding: 2px; display: flex; align-items: center;">
                <i data-lucide="eye" id="key-eye-icon" style="width: 16px; height: 16px;"></i>
              </button>
            </div>
            <div id="license-key-display"
              style="font-family: monospace; font-size: 12px; color: rgba(148,163,184,0.9);">****-****-****-****</div>
          </div>
          <button id="btn-reset-license" onclick="resetLicense()"
            style="width: 100%; padding: 12px; background: rgba(239,68,68,0.1); border: 1px solid rgba(239,68,68,0.25); border-radius: 10px; color: #ef4444; font-weight: 700; cursor: pointer; font-size: 13px;">–°–±—Ä–æ—Å–∏—Ç—å
            –∞–∫—Ç–∏–≤–∞—Ü–∏—é</button>
        </div>

        <!-- GOAL SETTING -->
        <div class="glass-panel" style="padding: 16px; margin-bottom: 16px;">
          <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 16px;">
            <i data-lucide="target" style="width: 20px; height: 20px; color: #f59e0b;"></i>
            <div
              style="font-size: 12px; color: rgba(245,158,11,0.8); text-transform: uppercase; font-weight: 800; letter-spacing: 0.08em;">
              –¶–µ–ª—å –º–µ—Å—è—Ü–∞</div>
          </div>
          <input type="number" id="goal-input" class="form-input" placeholder="200000" inputmode="numeric"
            style="margin-bottom: 12px;">
          <button onclick="saveGoal()" class="btn-primary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ü–µ–ª—å</button>
        </div>

        <!-- CUSTOM TYPES -->
        <div class="glass-panel" style="padding: 16px; margin-bottom: 16px;">
          <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px;">
            <div style="display: flex; align-items: center; gap: 10px;">
              <i data-lucide="shapes" style="width: 20px; height: 20px; color: #f59e0b;"></i>
              <div
                style="font-size: 12px; color: rgba(245,158,11,0.8); text-transform: uppercase; font-weight: 800; letter-spacing: 0.08em;">
                –¢–∏–ø—ã —Å–æ–±—ã—Ç–∏–π</div>
            </div>
            <button onclick="openTypeEditor()"
              style="padding: 8px 14px; background: linear-gradient(135deg, rgba(245,158,11,0.15), rgba(245,158,11,0.08)); border: 1px solid rgba(245,158,11,0.25); border-radius: 10px; color: #f59e0b; font-size: 11px; font-weight: 800; cursor: pointer; display: flex; align-items: center; gap: 6px; text-transform: uppercase; letter-spacing: 0.05em;">
              <i data-lucide="plus" style="width: 14px; height: 14px;"></i>
              <span>–î–æ–±–∞–≤–∏—Ç—å</span>
            </button>
          </div>

          <div id="custom-types-list" style="display: flex; flex-direction: column; gap: 10px;">
            <!-- Generated by JS -->
          </div>
        </div>

        <!-- EXPORT/IMPORT -->
        <div class="glass-panel" style="padding: 16px; margin-bottom: 16px;">
          <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 12px;">
            <i data-lucide="database" style="width: 20px; height: 20px; color: #f59e0b;"></i>
            <div
              style="font-size: 12px; color: rgba(245,158,11,0.8); text-transform: uppercase; font-weight: 800; letter-spacing: 0.08em;">
              –†–µ–∑–µ—Ä–≤–Ω—ã–µ –∫–æ–ø–∏–∏</div>
          </div>
          <button onclick="exportData()"
            style="width: 100%; padding: 14px; background: linear-gradient(135deg, rgba(52,211,153,0.15), rgba(52,211,153,0.08)); border: 1px solid rgba(52,211,153,0.25); border-radius: 12px; color: #34d399; font-weight: 800; cursor: pointer; margin-bottom: 12px; display: flex; align-items: center; justify-content: center; gap: 8px; text-transform: uppercase; font-size: 13px; letter-spacing: 0.05em; transition: all 0.3s;">
            <i data-lucide="download" style="width: 18px; height: 18px;"></i>
            –≠–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö
          </button>
          <label
            style="display: block; width: 100%; padding: 14px; background: linear-gradient(135deg, rgba(96,165,250,0.15), rgba(96,165,250,0.08)); border: 1px solid rgba(96,165,250,0.25); border-radius: 12px; color: #60a5fa; font-weight: 800; cursor: pointer; text-align: center; text-transform: uppercase; font-size: 13px; letter-spacing: 0.05em; transition: all 0.3s;">
            <i data-lucide="upload"
              style="width: 18px; height: 18px; display: inline-block; vertical-align: middle; margin-right: 8px;"></i>
            –ò–º–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö
            <input type="file" id="import-file" accept="application/json" onchange="importData(this)"
              style="display: none;">
          </label>
        </div>

        <!-- RESET -->
        <div class="glass-panel" style="padding: 16px;">
          <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 12px;">
            <i data-lucide="trash-2" style="width: 20px; height: 20px; color: #ef4444;"></i>
            <div
              style="font-size: 12px; color: rgba(239,68,68,0.8); text-transform: uppercase; font-weight: 800; letter-spacing: 0.08em;">
              –û–ø–∞—Å–Ω–∞—è –∑–æ–Ω–∞</div>
          </div>
          <button onclick="resetData()"
            style="width: 100%; padding: 14px; background: linear-gradient(135deg, rgba(239,68,68,0.15), rgba(239,68,68,0.08)); border: 1px solid rgba(239,68,68,0.3); border-radius: 12px; color: #ef4444; font-weight: 800; cursor: pointer; text-transform: uppercase; font-size: 13px; letter-spacing: 0.05em; transition: all 0.3s; margin-bottom: 12px;">
            <i data-lucide="alert-triangle"
              style="width: 18px; height: 18px; display: inline-block; vertical-align: middle; margin-right: 8px;"></i>
            –°–±—Ä–æ—Å–∏—Ç—å –≤—Å–µ –¥–∞–Ω–Ω—ã–µ
          </button>
          <button onclick="resetCelebrations()"
            style="width: 100%; padding: 14px; background: linear-gradient(135deg, rgba(245,158,11,0.15), rgba(245,158,11,0.08)); border: 1px solid rgba(245,158,11,0.25); border-radius: 12px; color: #f59e0b; font-weight: 800; cursor: pointer; text-transform: uppercase; font-size: 13px; letter-spacing: 0.05em; transition: all 0.3s;">
            <i data-lucide="sparkles"
              style="width: 18px; height: 18px; display: inline-block; vertical-align: middle; margin-right: 8px;"></i>
            –°–±—Ä–æ—Å–∏—Ç—å –∞–Ω–∏–º–∞—Ü–∏–∏
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- MONTH PICKER MODAL -->
  <div id="month-picker-modal" class="modal-overlay">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title">–í—ã–±–æ—Ä –º–µ—Å—è—Ü–∞</h2>
        <button class="modal-close" onclick="closeMonthPicker()">
          <i data-lucide="x"></i>
        </button>
      </div>

      <div class="modal-body">
        <div class="year-selector">
          <button class="year-btn" onclick="changePickerYear(-1)">
            <i data-lucide="chevron-left"></i>
          </button>
          <div class="year-display" id="picker-year">2026</div>
          <button class="year-btn" onclick="changePickerYear(1)">
            <i data-lucide="chevron-right"></i>
          </button>
        </div>

        <div class="month-grid">
          <button class="month-btn" onclick="selectMonth(0)">–Ø–Ω–≤</button>
          <button class="month-btn" onclick="selectMonth(1)">–§–µ–≤</button>
          <button class="month-btn" onclick="selectMonth(2)">–ú–∞—Ä</button>
          <button class="month-btn" onclick="selectMonth(3)">–ê–ø—Ä</button>
          <button class="month-btn" onclick="selectMonth(4)">–ú–∞–π</button>
          <button class="month-btn" onclick="selectMonth(5)">–ò—é–Ω</button>
          <button class="month-btn" onclick="selectMonth(6)">–ò—é–ª</button>
          <button class="month-btn" onclick="selectMonth(7)">–ê–≤–≥</button>
          <button class="month-btn" onclick="selectMonth(8)">–°–µ–Ω</button>
          <button class="month-btn" onclick="selectMonth(9)">–û–∫—Ç</button>
          <button class="month-btn" onclick="selectMonth(10)">–ù–æ—è</button>
          <button class="month-btn" onclick="selectMonth(11)">–î–µ–∫</button>
        </div>
      </div>
    </div>
  </div>

  <!-- TYPE EDITOR MODAL -->
  <div id="type-editor-modal" class="modal-overlay">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title" id="type-editor-title">–ù–æ–≤—ã–π —Ç–∏–ø —Å–æ–±—ã—Ç–∏—è</h2>
        <button class="modal-close" onclick="closeTypeEditor()">
          <i data-lucide="x"></i>
        </button>
      </div>

      <div class="modal-body">
        <div class="form-group">
          <label class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ —Ç–∏–ø–∞</label>
          <input type="text" id="type-name" class="form-input" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ö–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤">
        </div>

        <div class="form-group">
          <label class="form-label">–¶–≤–µ—Ç</label>
          <div style="display: grid; grid-template-columns: repeat(6, 1fr); gap: 10px;">
            <button class="color-btn" data-color="#f59e0b" onclick="selectColor('#f59e0b')"
              style="background: #f59e0b;"></button>
            <button class="color-btn" data-color="#c084fc" onclick="selectColor('#c084fc')"
              style="background: #c084fc;"></button>
            <button class="color-btn" data-color="#34d399" onclick="selectColor('#34d399')"
              style="background: #34d399;"></button>
            <button class="color-btn" data-color="#60a5fa" onclick="selectColor('#60a5fa')"
              style="background: #60a5fa;"></button>
            <button class="color-btn" data-color="#ef4444" onclick="selectColor('#ef4444')"
              style="background: #ef4444;"></button>
            <button class="color-btn" data-color="#f97316" onclick="selectColor('#f97316')"
              style="background: #f97316;"></button>
            <button class="color-btn" data-color="#ec4899" onclick="selectColor('#ec4899')"
              style="background: #ec4899;"></button>
            <button class="color-btn" data-color="#8b5cf6" onclick="selectColor('#8b5cf6')"
              style="background: #8b5cf6;"></button>
            <button class="color-btn" data-color="#10b981" onclick="selectColor('#10b981')"
              style="background: #10b981;"></button>
            <button class="color-btn" data-color="#3b82f6" onclick="selectColor('#3b82f6')"
              style="background: #3b82f6;"></button>
            <button class="color-btn" data-color="#cbd5e1" onclick="selectColor('#cbd5e1')"
              style="background: #cbd5e1;"></button>
            <button class="color-btn" data-color="#64748b" onclick="selectColor('#64748b')"
              style="background: #64748b;"></button>
          </div>
        </div>

        <div class="form-group">
          <label class="form-label">–ò–∫–æ–Ω–∫–∞</label>
          <div id="icon-grid"
            style="display: grid; grid-template-columns: repeat(6, 1fr); gap: 8px; max-height: 300px; overflow-y: auto; padding: 4px;">
            <!-- Icons will be generated by JS -->
          </div>
        </div>

        <button onclick="saveCustomType()" class="btn-primary" style="margin-bottom: 12px;">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        <button onclick="closeTypeEditor()" class="btn-secondary" style="margin-bottom: 12px;">–û—Ç–º–µ–Ω–∞</button>
        <button id="delete-type-btn" onclick="deleteCustomType()" class="btn-danger"
          style="display: none; margin-top: 20px;">–£–¥–∞–ª–∏—Ç—å —Ç–∏–ø</button>
      </div>
    </div>
  </div>

  <!-- TOAST -->
  <div id="toast">
    <span id="toast-msg"></span>
  </div>

  <!-- CONFIRM MODAL -->
  <div id="confirm-modal" class="modal-overlay" style="align-items: center; justify-content: center;">
    <div
      style="width: 90%; max-width: 340px; background: rgba(15,15,20,0.98); backdrop-filter: blur(40px); -webkit-backdrop-filter: blur(40px); border: 1.5px solid rgba(239,68,68,0.3); border-radius: 24px; box-shadow: 0 20px 60px rgba(0,0,0,0.8), 0 0 40px rgba(239,68,68,0.1); padding: 24px;">
      <div style="text-align: center; margin-bottom: 16px;">
        <div
          style="width: 56px; height: 56px; margin: 0 auto 16px; background: rgba(239,68,68,0.15); border: 1.5px solid rgba(239,68,68,0.3); border-radius: 16px; display: flex; align-items: center; justify-content: center;">
          <i data-lucide="trash-2" style="width: 28px; height: 28px; color: #ef4444;"></i>
        </div>
        <h2 id="confirm-title" style="font-size: 18px; font-weight: 800; color: #fff; margin: 0;">–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ</h2>
      </div>
      <p id="confirm-message"
        style="color: rgba(255,255,255,0.7); font-size: 14px; line-height: 1.6; text-align: center; margin: 0 0 20px;">
      </p>
      <div style="display: flex; gap: 10px;">
        <button id="confirm-no"
          style="flex: 1; height: 48px; border-radius: 14px; font-size: 14px; font-weight: 700; background: rgba(255,255,255,0.08); border: 1.5px solid rgba(255,255,255,0.15); color: #fff; cursor: pointer;">–û—Ç–º–µ–Ω–∞</button>
        <button id="confirm-yes"
          style="flex: 1; height: 48px; border-radius: 14px; font-size: 14px; font-weight: 700; background: rgba(239,68,68,0.2); border: 1.5px solid rgba(239,68,68,0.4); color: #ef4444; cursor: pointer;">–£–¥–∞–ª–∏—Ç—å</button>
      </div>
    </div>
  </div>

  <!-- TYPE PICKER MODAL -->
  <div id="type-picker-modal" class="modal-overlay" style="align-items: center; justify-content: center;"
    onclick="if(event.target===this)closeTypePicker()">
    <div id="type-picker-sheet"
      style="width: 90%; max-width: 340px; background: rgba(15,15,20,0.98); backdrop-filter: blur(40px); -webkit-backdrop-filter: blur(40px); border: 1.5px solid rgba(245,158,11,0.2); border-radius: 28px; box-shadow: 0 20px 60px rgba(0,0,0,0.8), 0 0 80px rgba(245,158,11,0.08); padding: 24px; transform: scale(0.9); opacity: 0; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);">
      <div style="text-align: center; margin-bottom: 20px;">
        <div
          style="font-size: 14px; font-weight: 800; text-transform: uppercase; letter-spacing: 0.1em; background: linear-gradient(135deg, #f59e0b, #fb923c); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;">
          –¢–∏–ø —Å–æ–±—ã—Ç–∏—è</div>
      </div>
      <div id="type-picker-list" style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px;">
        <!-- Generated by JS -->
      </div>
    </div>
  </div>

  <!-- EVENT PREVIEW MODAL -->
  <div id="preview-modal" class="modal-overlay">
    <div class="modal-content" style="max-width: 500px;">
      <div class="modal-header">
        <h2 class="modal-title">–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä</h2>
        <button class="close-btn" onclick="closePreview()">
          <i data-lucide="x"></i>
        </button>
      </div>
      <div class="modal-body" id="preview-content">
        <!-- Generated by JS -->
      </div>
    </div>
  </div>

  <div id="category-manager-modal" class="modal-overlay" style="align-items: center;">
    <div class="modal-content" style="max-width: 500px;">
      <div class="modal-header">
        <h2 class="modal-title">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º–∏</h2>
        <button class="close-btn" onclick="closeCategoryManager()">
          <i data-lucide="x"></i>
        </button>
      </div>
      <div class="modal-body" id="category-manager-content">
        <!-- Generated by JS -->
      </div>
    </div>
  </div>

  <script>
    // ==========================================
    // PARTICLES
    // ==========================================
    // Particles disabled for cleaner design

    // ==========================================
    // DATA
    // ==========================================
    // Available icons for selection

    // –ü–æ–ª–Ω—ã–π —Å–ø–∏—Å–æ–∫ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∫–Ω–æ–ø–æ–∫ (PNG –∏–∫–æ–Ω–æ–∫)
    // –ò–º–µ–Ω–∞ —Ñ–∞–π–ª–æ–≤ –±–µ–∑ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è .png
    const AVAILABLE_ICONS = [
      'bag', 'black-cat', 'broomstick', 'candle', 'candy', 'card-game',
      'chalice-2', 'chalice', 'costume', 'crown', 'crystal-glass', 'crystal',
      'curtains', 'dove', 'dream', 'eye-jar', 'fairy', 'fortune-teller',
      'genie-lamp', 'genie', 'ghost', 'giftbox-2', 'giftbox', 'guillotine',
      'halloween', 'hand', 'handcuffs', 'horse-car', 'juggling-ball', 'key',
      'knife', 'lock', 'magic-book', 'magic-box', 'magic-carpet', 'magic-dust',
      'magic-hat', 'magic-mirror-2', 'magic-mirror', 'magic-pot', 'magic-potion',
      'magic-show', 'magic-spell-2', 'magic-spell', 'magic-trick-2',
      'magic-trick-3', 'magic-trick-4', 'magic-trick', 'magic-wand-2',
      'magic-wand', 'magician', 'mortar', 'oil-lamp', 'owl', 'palmistry',
      'paper-scroll', 'papyrus', 'pendant', 'poker-cards', 'potion',
      'prediction', 'ring', 'sandglass', 'skull-2', 'skull', 'spell-book',
      'storytelling', 'sword', 'table-lamp', 'tapestry', 'tickets',
      'treasure-chest', 'witch-broom', 'witch-hat'
    ];

    // Default types (8 –æ—Å–Ω–æ–≤–Ω—ã—Ö) —Å –ø—Ä–∏–≤—è–∑–∫–æ–π –∫ –Ω–æ–≤—ã–º –∏–∫–æ–Ω–∫–∞–º
    const DEFAULT_TYPES = {
      rabbit: { label: '–ò–ª–ª—é–∑–∏–æ–Ω', color: '#f59e0b', image: 'icons/events/magician.png' },
      kids: { label: '–î–µ—Ç—Å–∫–∏–π –ø—Ä–∞–∑–¥–Ω–∏–∫', color: '#f472b6', image: 'icons/events/candy.png' },
      corporate: { label: '–ö–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤', color: '#3b82f6', image: 'icons/events/chalice.png' },
      wedding: { label: '–°–≤–∞–¥—å–±–∞', color: '#e879f9', image: 'icons/events/ring.png' },
      vip: { label: 'VIP', color: '#fbbf24', image: 'icons/events/crown.png' },
      workshop: { label: '–ú–∞—Å—Ç–µ—Ä-–∫–ª–∞—Å—Å', color: '#0ea5e9', image: 'icons/events/magic-book.png' },
      rehearsal_type: { label: '–†–µ–ø–µ—Ç–∏—Ü–∏—è', color: '#94a3b8', image: 'icons/events/magic-mirror.png' }, // –ó–µ—Ä–∫–∞–ª–æ –¥–ª—è —Ä–µ–ø–µ—Ç–∏—Ü–∏–π
      other: { label: '–î—Ä—É–≥–æ–µ', color: '#6b7280', image: 'icons/events/magic-dust.png' }
    };

    // AVAILABLE_ICONS –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –¥–ª—è –≤—ã–±–æ—Ä–∞ –∏–∫–æ–Ω–∫–∏ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏/—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏ —Ç–∏–ø–∞

    // Custom types storage
    let customTypes = {};

    // Get combined types (default + custom - hidden)
    function getTypes() {
      const hiddenTypes = customTypes._hidden || [];
      const result = {};

      // Add non-hidden default types
      Object.keys(DEFAULT_TYPES).forEach(key => {
        if (!hiddenTypes.includes(key)) {
          result[key] = DEFAULT_TYPES[key];
        }
      });

      // Add custom types (excluding _hidden meta key)
      Object.keys(customTypes).forEach(key => {
        if (key !== '_hidden' && key !== '_shown' && key !== '_migrated') {
          result[key] = customTypes[key];
        }
      });

      return result;
    }

    // Dynamic TYPES object
    const TYPES = new Proxy({}, {
      get(target, prop) {
        const allTypes = getTypes();
        return allTypes[prop] || DEFAULT_TYPES.rabbit || { label: '–°–æ–±—ã—Ç–∏–µ', color: '#f59e0b', image: 'icons/events/magician.png' };
      }
    });

    const MONTH_NAMES = [
      '–Ø–Ω–≤–∞—Ä—å', '–§–µ–≤—Ä–∞–ª—å', '–ú–∞—Ä—Ç', '–ê–ø—Ä–µ–ª—å', '–ú–∞–π', '–ò—é–Ω—å',
      '–ò—é–ª—å', '–ê–≤–≥—É—Å—Ç', '–°–µ–Ω—Ç—è–±—Ä—å', '–û–∫—Ç—è–±—Ä—å', '–ù–æ—è–±—Ä—å', '–î–µ–∫–∞–±—Ä—å'
    ];

    let EXPENSE_CATEGORIES = {
      fuel: { label: '–¢–æ–ø–ª–∏–≤–æ', emoji: 'üõ¢Ô∏è', color: '#ef4444' },
      props: { label: '–†–µ–∫–≤–∏–∑–∏—Ç', emoji: 'ü™Ñ', color: '#f59e0b' },
      rent: { label: '–ê—Ä–µ–Ω–¥–∞', emoji: 'üè†', color: '#8b5cf6' },
      food: { label: '–ü–∏—Ç–∞–Ω–∏–µ', emoji: 'üçΩÔ∏è', color: '#22c55e' },
      transport: { label: '–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç', emoji: 'üöó', color: '#3b82f6' },
      equipment: { label: '–û–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ', emoji: 'üì¶', color: '#ec4899' },
      advertising: { label: '–†–µ–∫–ª–∞–º–∞', emoji: 'üì¢', color: '#f97316' },
      other: { label: '–î—Ä—É–≥–æ–µ', emoji: 'üìå', color: '#64748b' }
    };

    function loadCustomExpenseCategories() {
      const stored = localStorage.getItem('illusionist_expense_categories');
      if (stored) {
        try {
          const savedCategories = JSON.parse(stored);
          EXPENSE_CATEGORIES = savedCategories;
        } catch (e) {
          showToast('‚ö†Ô∏è –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–π —Ä–∞—Å—Ö–æ–¥–æ–≤');
        }
      }
    }

    function saveCustomExpenseCategories() {
      safeLocalStorageSet('illusionist_expense_categories', JSON.stringify(EXPENSE_CATEGORIES));
    }

    let currentDate = new Date();
    let selectedDate = new Date();
    let events = [];

    // –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è: –¥–µ–±–∞—É–Ω—Å –¥–ª—è lucide.createIcons()
    let lucideIconsTimeout = null;
    function refreshIcons() {
      if (typeof lucide === 'undefined') return;
      if (lucideIconsTimeout) clearTimeout(lucideIconsTimeout);
      lucideIconsTimeout = setTimeout(() => {
        lucide.createIcons();
      }, 16); // ~1 –∫–∞–¥—Ä –ø—Ä–∏ 60fps
    }
    let schedule = [{ type: 'rabbit', time: '19:00', duration: 60 }];
    let expenses = []; // –ù–æ–≤—ã–π –º–∞—Å—Å–∏–≤ —Ä–∞—Å—Ö–æ–¥–æ–≤ –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ —Å–æ–±—ã—Ç–∏—è
    let editingEventId = null;
    let formDirty = false;
    let storedLicenseKey = '';
    let keyVisible = false;
    let currentView = 'calendar';
    let pickerYear = new Date().getFullYear();
    let currentType = 'rabbit';
    let monthlyGoal = 200000;
    let editingTypeKey = null;
    let selectedColor = '#f59e0b';
    let selectedIcon = 'sparkles';
    let isRendering = false;

    // Constants
    const TIMING = {
      LONG_PRESS: 500,
      RENDER_DELAY: 100,
      SPLASH_DURATION: 2000,
      SPLASH_FADE: 600,
      SWIPE_THRESHOLD: 100,
      SWIPE_CALL_TRIGGER: 60,
      SWIPE_EDIT_TRIGGER: 130,
      SWIPE_DELETE_TRIGGER: 70
    };

    // DOM cache
    const DOM = {
      eventModal: null,
      confirmModal: null,
      calendarGrid: null,
      dayList: null,
      bottomNav: null,
      init() {
        this.eventModal = document.getElementById('event-modal');
        this.confirmModal = document.getElementById('confirm-modal');
        this.calendarGrid = document.getElementById('calendar-grid');
        this.dayList = document.getElementById('day-list');
        this.bottomNav = document.getElementById('bottom-nav');
      }
    };

    // ==========================================
    // SANITIZATION
    // ==========================================
    function escapeHtml(text) {
      if (!text) return '';
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function escapeOnclick(str) {
      return String(str).replace(/\\/g, '\\\\').replace(/'/g, "\\'").replace(/"/g, '&quot;').replace(/</g, '\\x3c').replace(/>/g, '\\x3e');
    }

    function sanitizeImportKeys(obj) {
      if (!obj || typeof obj !== 'object') return {};
      const safe = {};
      Object.keys(obj).forEach(key => {
        if (/^[a-zA-Z0-9_]+$/.test(key)) {
          safe[key] = obj[key];
        }
      });
      return safe;
    }

    // ==========================================
    // STORAGE
    // ==========================================
    function safeLocalStorageSet(key, value) {
      try {
        localStorage.setItem(key, value);
        return true;
      } catch (e) {
        if (e.name === 'QuotaExceededError') {
          showToast('‚ö†Ô∏è –•—Ä–∞–Ω–∏–ª–∏—â–µ –∑–∞–ø–æ–ª–Ω–µ–Ω–æ! –£–¥–∞–ª–∏—Ç–µ —Å—Ç–∞—Ä—ã–µ —Å–æ–±—ã—Ç–∏—è');
          return false;
        }
        return false;
      }
    }

    function saveEvents() {
      safeLocalStorageSet('illusionist_events', JSON.stringify(events));
    }

    function loadEvents() {
      const stored = localStorage.getItem('illusionist_events');
      if (stored) {
        try {
          events = JSON.parse(stored);

          // –ú–∏–≥—Ä–∞—Ü–∏—è: –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º —Å—Ç–∞—Ä—ã–µ —Å–æ–±—ã—Ç–∏—è —Å –æ–¥–Ω–∏–º —Ä–∞—Å—Ö–æ–¥–æ–º –≤ –º–∞—Å—Å–∏–≤
          let migrated = false;
          events.forEach(event => {
            if (event.expense && !event.expenses) {
              event.expenses = [{
                amount: event.expense,
                category: event.expenseCategory || '',
                note: ''
              }];
              delete event.expense;
              delete event.expenseCategory;
              migrated = true;
            }
            if (!event.expenses) {
              event.expenses = [];
            }
          });
          if (migrated) saveEvents();

        } catch (e) {
          events = [];
          showToast('‚ö†Ô∏è –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ–±—ã—Ç–∏–π');
        }
      }

      const savedGoal = localStorage.getItem('illusionist_goal');
      if (savedGoal) {
        monthlyGoal = parseFloat(savedGoal) || 200000;
      }

      const savedTypes = localStorage.getItem('illusionist_custom_types');
      if (savedTypes) {
        try {
          customTypes = JSON.parse(savedTypes);
        } catch (e) {
          customTypes = {};
          showToast('‚ö†Ô∏è –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–∏–ø–æ–≤');
        }
      }

      loadCustomExpenseCategories();
    }

    // –ò–º–ø–æ—Ä—Ç —Å–æ–±—ã—Ç–∏–π –∏–∑ –ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä–∞ —á–µ—Ä–µ–∑ Firebase (–æ–¥–Ω–æ—Ä–∞–∑–æ–≤—ã–π + —Ä–µ–∞–ª—Ç–∞–π–º)
    var _firebaseSyncListenerActive = false;

    function _mergeFirebaseEvents(syncedEvents) {
      if (!syncedEvents) return;
      var existingIds = new Set(events.map(function (e) { return e.id; }));
      var importCount = 0;

      Object.values(syncedEvents).forEach(function (se) {
        if (existingIds.has(se.id)) return;
        var clean = Object.assign({}, se);
        delete clean._source;
        delete clean._createdAt;
        if (!clean.expenses) clean.expenses = [];
        events.push(clean);
        existingIds.add(clean.id);
        importCount++;
      });

      if (importCount > 0) {
        saveEvents();
        renderCalendar();
        renderSchedule();
        showToast('üìÖ –ò–º–ø–æ—Ä—Ç –∏–∑ –ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä–∞: ' + importCount);
      }
    }

    async function importEventsFromFirebase() {
      if (!window.firebaseEnabled || !window.firebaseDB) {
        console.warn('‚ö†Ô∏è Firebase –Ω–µ –¥–æ—Å—Ç—É–ø–µ–Ω –¥–ª—è –∏–º–ø–æ—Ä—Ç–∞. enabled:', window.firebaseEnabled, 'db:', !!window.firebaseDB);
        return;
      }
      try {
        var deviceKey = getBrowserFingerprint();
        console.log('üîç Firebase import: deviceKey =', deviceKey);
        var syncRef = window.firebaseDB.ref('sync/events/' + deviceKey);

        // –û–¥–Ω–æ—Ä–∞–∑–æ–≤–æ–µ —á—Ç–µ–Ω–∏–µ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        var snapshot = await syncRef.once('value');
        _mergeFirebaseEvents(snapshot.val());

        // –†–µ–∞–ª—Ç–∞–π–º-—Å–ª—É—à–∞—Ç–µ–ª—å –¥–ª—è –º–≥–Ω–æ–≤–µ–Ω–Ω–æ–≥–æ –ø–æ–ª—É—á–µ–Ω–∏—è –Ω–æ–≤—ã—Ö —Å–æ–±—ã—Ç–∏–π
        if (!_firebaseSyncListenerActive) {
          syncRef.on('value', function (snap) {
            _mergeFirebaseEvents(snap.val());
          });
          _firebaseSyncListenerActive = true;
          console.log('‚úÖ Firebase realtime listener activated');
        }
      } catch (e) {
        console.error('‚ö†Ô∏è Firebase import failed:', e);
      }
    }

    // –£–¥–∞–ª–µ–Ω–∏–µ —Å–æ–±—ã—Ç–∏—è –∏–∑ Firebase (—á—Ç–æ–±—ã –æ–Ω–æ –Ω–µ –≤–æ–∑–≤—Ä–∞—â–∞–ª–æ—Å—å –ø—Ä–∏ –∏–º–ø–æ—Ä—Ç–µ)
    async function deleteEventFromFirebase(eventId) {
      if (!window.firebaseEnabled || !window.firebaseDB) {
        console.log('Firebase –Ω–µ –¥–æ—Å—Ç—É–ø–µ–Ω –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è —Å–æ–±—ã—Ç–∏—è:', eventId);
        return;
      }
      try {
        const deviceKey = getBrowserFingerprint();
        const eventRef = window.firebaseDB.ref('sync/events/' + deviceKey + '/' + eventId);
        await eventRef.remove();
        console.log('‚úÖ –°–æ–±—ã—Ç–∏–µ —É–¥–∞–ª–µ–Ω–æ –∏–∑ Firebase:', eventId);
      } catch (e) {
        console.error('‚ö†Ô∏è –û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –∏–∑ Firebase:', e);
      }
    }

    // –£–¥–∞–ª–µ–Ω–∏–µ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö —Å–æ–±—ã—Ç–∏–π –∏–∑ Firebase (–¥–ª—è —Å–µ—Ä–∏–∏)
    async function deleteMultipleEventsFromFirebase(eventIds) {
      if (!window.firebaseEnabled || !window.firebaseDB) return;
      for (const eventId of eventIds) {
        await deleteEventFromFirebase(eventId);
      }
    }

    function saveGoalToStorage() {
      safeLocalStorageSet('illusionist_goal', monthlyGoal.toString());
    }

    function saveCustomTypes() {
      safeLocalStorageSet('illusionist_custom_types', JSON.stringify(customTypes));
    }

    // ==========================================
    // CUSTOM CONFIRM
    // ==========================================
    function customConfirm(message, onYes) {
      document.getElementById('confirm-message').textContent = message;

      const yesBtn = document.getElementById('confirm-yes');
      const noBtn = document.getElementById('confirm-no');

      // –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤
      const newYesBtn = yesBtn.cloneNode(true);
      const newNoBtn = noBtn.cloneNode(true);
      yesBtn.parentNode.replaceChild(newYesBtn, yesBtn);
      noBtn.parentNode.replaceChild(newNoBtn, noBtn);

      const cleanup = () => {
        document.getElementById('confirm-modal').classList.remove('show');
      };

      newYesBtn.onclick = () => {
        cleanup();
        onYes();
      };

      newNoBtn.onclick = cleanup;

      document.getElementById('confirm-modal').classList.add('show');
    }

    // ==========================================
    // TAB SWITCHING
    // ==========================================
    function switchTab(tab) {
      currentView = tab;

      document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
      document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));

      if (tab === 'calendar') {
        document.getElementById('calendar-tab').classList.add('active');
        document.querySelector('[onclick="switchTab(\'calendar\')"]').classList.add('active');
        renderCalendar();

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–∑–∏—Ü–∏—é —Å–∫—Ä–æ–ª–ª–∞ –ø–æ—Å–ª–µ —Ä–µ–Ω–¥–µ—Ä–∞
        setTimeout(() => checkScrollPosition('calendar'), 100);
      } else if (tab === 'dashboard') {
        document.getElementById('dashboard-tab').classList.add('active');
        document.querySelector('[onclick="switchTab(\'dashboard\')"]').classList.add('active');
        renderDashboard();

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–∑–∏—Ü–∏—é —Å–∫—Ä–æ–ª–ª–∞ –ø–æ—Å–ª–µ —Ä–µ–Ω–¥–µ—Ä–∞
        setTimeout(() => checkScrollPosition('dashboard'), 100);
      }
    }

    // ==========================================
    // CALENDAR RENDERING
    // ==========================================
    function renderCalendar() {
      if (isRendering) return;
      isRendering = true;

      try {
        const year = currentDate.getFullYear();
        const month = currentDate.getMonth();

        document.getElementById('month-title').textContent = `${MONTH_NAMES[month]} ${year}`;

        const firstDay = new Date(year, month, 1);
        const lastDay = new Date(year, month + 1, 0);
        const startDay = firstDay.getDay() || 7;

        const grid = DOM.calendarGrid || document.getElementById('calendar-grid');
        grid.innerHTML = '';

        // Empty cells before first day
        for (let i = 1; i < startDay; i++) {
          const cell = document.createElement('div');
          cell.className = 'calendar-cell';
          cell.style.opacity = '0.3';
          grid.appendChild(cell);
        }

        // Days of month
        const today = new Date();
        const todayStr = formatDate(today);

        for (let day = 1; day <= lastDay.getDate(); day++) {
          const date = new Date(year, month, day);
          const dateStr = formatDate(date);
          const dayEvents = events.filter(e => e.date === dateStr);

          const cell = document.createElement('div');
          cell.className = 'calendar-cell';
          cell.dataset.date = dateStr;

          if (dateStr === todayStr) {
            cell.classList.add('today');
          }

          if (dateStr === formatDate(selectedDate)) {
            cell.classList.add('selected');
          }

          const dateNum = document.createElement('div');
          dateNum.className = 'date-number';
          dateNum.textContent = day;
          cell.appendChild(dateNum);

          if (dayEvents.length > 0) {
            const dotsContainer = document.createElement('div');
            dotsContainer.className = 'event-dots';

            dayEvents.slice(0, 3).forEach(event => {
              const dot = document.createElement('div');
              dot.className = 'event-dot';
              if (event.status === 'pending') {
                dot.style.background = '#f59e0b';
              } else if (event.status === 'confirmed') {
                dot.style.background = '#22c55e';
              } else if (event.status === 'completed') {
                dot.style.background = '#3b82f6';
              } else if (event.status === 'rehearsal') {
                dot.style.background = '#94a3b8';
              } else if (event.status === 'cancelled') {
                dot.style.background = '#ef4444';
              }
              dotsContainer.appendChild(dot);
            });

            cell.appendChild(dotsContainer);
          }

          grid.appendChild(cell);
        }

        renderDayList();
      } finally {
        isRendering = false;
      }
    }

    function renderDayList() {
      const container = DOM.dayList || document.getElementById('day-list');
      const dateStr = formatDate(selectedDate);
      const dayEvents = events.filter(e => e.date === dateStr);

      if (dayEvents.length === 0) {
        container.innerHTML = `
          <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 24px 16px; gap: 12px;">
            <div style="width: 48px; height: 48px; border-radius: 14px; background: rgba(245,158,11,0.08); border: 1.5px dashed rgba(245,158,11,0.3); display: flex; align-items: center; justify-content: center;">
              <i data-lucide="plus" style="width: 24px; height: 24px; color: rgba(245,158,11,0.6);"></i>
            </div>
            <div style="font-size: 13px; color: rgba(148,163,184,0.7); text-align: center; line-height: 1.5;">
              –ù–µ—Ç —Å–æ–±—ã—Ç–∏–π –Ω–∞ —ç—Ç—É –¥–∞—Ç—É.<br>
              <span style="color: rgba(245,158,11,0.7); font-weight: 600; cursor: pointer;" onclick="openEventModal(selectedDate)">–î–æ–±–∞–≤–∏—Ç—å —Å–æ–±—ã—Ç–∏–µ</span>
            </div>
          </div>
        `;
        lucide.createIcons();
        return;
      }

      container.innerHTML = `
        <div class="day-list-header">
          –°–æ–±—ã—Ç–∏—è –Ω–∞ ${selectedDate.getDate()} ${MONTH_NAMES[selectedDate.getMonth()].toLowerCase()}
        </div>
      `;

      dayEvents.forEach(event => {
        const typeInfo = TYPES[event.type] || TYPES.rabbit;
        const statusColor = event.status === 'confirmed' ? '#22c55e' : event.status === 'pending' ? '#f59e0b' : event.status === 'completed' ? '#3b82f6' : event.status === 'rehearsal' ? '#94a3b8' : '#ef4444';
        const eventDate = parseEventDate(event.date);

        const row = document.createElement('div');
        row.className = 'day-list-row';
        row.style.setProperty('--accent-color', typeInfo.color);

        row.innerHTML = `
          <div class="event-type-icon" style="width: 44px; height: 44px; border-radius: 12px; background: ${typeInfo.color}20; border: 1.5px solid ${typeInfo.color}40; display: flex; align-items: center; justify-content: center; flex-shrink: 0; cursor: pointer;">
            ${typeInfo.image ? `<img src="${typeInfo.image}" style="width: 26px; height: 26px; object-fit: contain;">` : `<img src="icons/events/magician.png" style="width: 22px; height: 22px; object-fit: contain;">`}
          </div>
          <div class="day-list-info" style="flex: 1;">
            <div class="day-list-title">${escapeHtml(event.title)}</div>
            <div class="day-list-subtitle">
              <i data-lucide="map-pin" style="width: 14px; height: 14px;"></i>
              <span>${escapeHtml(event.location) || '–ù–µ —É–∫–∞–∑–∞–Ω–æ'}</span>
            </div>
          </div>
          ${event.address ? `
          <button class="nav-btn event-nav-btn" style="width: 40px; height: 40px; padding: 0; margin-right: 8px; flex-shrink: 0; pointer-events: none; opacity: 0;" title="–ü–æ—Å—Ç—Ä–æ–∏—Ç—å –º–∞—Ä—à—Ä—É—Ç">
            <i data-lucide="navigation" style="width: 20px; height: 20px;"></i>
          </button>
          ` : ''}
          <div style="display: flex; flex-direction: column; align-items: flex-end; gap: 6px;">
            <div class="day-list-time">${escapeHtml(event.time) || '‚Äî'}</div>
            <div style="width: 8px; height: 8px; border-radius: 50%; background: ${statusColor}; box-shadow: 0 0 8px ${statusColor};"></div>
          </div>
        `;

        // –¢–∞–ø –Ω–∞ –∏–∫–æ–Ω–∫—É —Ç–∏–ø–∞ ‚Üí –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä
        const typeIcon = row.querySelector('.event-type-icon');
        typeIcon.addEventListener('click', (e) => {
          e.stopPropagation();
          showEventPreview(event);
        });

        // –¢–∞–ø –Ω–∞ –æ—Å—Ç–∞–ª—å–Ω—É—é –æ–±–ª–∞—Å—Ç—å ‚Üí –Ω–∞–≤–∏–≥–∞—Ü–∏—è
        row.addEventListener('click', (e) => {
          if (!e.target.closest('.event-type-icon') && event.address) {
            openNavigation(event.address, e);
          }
        });

        // –î–æ–±–∞–≤–ª—è–µ–º swipe (–≤–ø—Ä–∞–≤–æ - –∑–≤–æ–Ω–æ–∫, –≤–ª–µ–≤–æ - —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ)
        addSwipeToCall(row, event);

        container.appendChild(row);
      });

      // –ü–æ–¥—Å–∫–∞–∑–∫–∞ –¥–ª—è —Å–≤–∞–π–ø–∞ (–ø–æ–∫–∞–∑—ã–≤–∞–µ–º –æ–¥–∏–Ω —Ä–∞–∑)
      if (!localStorage.getItem('swipe_hint_shown')) {
        const hint = document.createElement('div');
        hint.style.cssText = 'display: flex; align-items: center; justify-content: center; gap: 8px; padding: 10px 16px; margin-top: 4px;';
        hint.innerHTML = `<span style="font-size: 12px; color: rgba(148,163,184,0.5); display: flex; align-items: center; gap: 6px;"><i data-lucide="move-horizontal" style="width: 14px; height: 14px;"></i> –°–≤–∞–π–ø –ø–æ —Å–æ–±—ã—Ç–∏—é –¥–ª—è –¥–µ–π—Å—Ç–≤–∏–π</span>`;
        container.appendChild(hint);
        localStorage.setItem('swipe_hint_shown', '1');
      }

      // –î–æ–±–∞–≤–ª—è–µ–º –∏—Ç–æ–≥–æ–≤—É—é –∫–∞—Ä—Ç–æ—á–∫—É –∑–∞ –º–µ—Å—è—Ü (—Ç–æ–ª—å–∫–æ –≤ –ø–æ—Å–ª–µ–¥–Ω–∏–π –¥–µ–Ω—å –º–µ—Å—è—Ü–∞)
      const year = selectedDate.getFullYear();
      const month = selectedDate.getMonth();
      const selectedDay = selectedDate.getDate();
      const lastDayOfMonth = new Date(year, month + 1, 0).getDate();

      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏—Ç–æ–≥–∏ –º–µ—Å—è—Ü–∞ —Ç–æ–ª—å–∫–æ –≤ –ø–æ—Å–ª–µ–¥–Ω–∏–π –¥–µ–Ω—å –º–µ—Å—è—Ü–∞ (31, 30, 28/29)
      if (selectedDay === lastDayOfMonth) {
        const monthEvents = events.filter(e => {
          const eventDate = parseEventDate(e.date);
          return eventDate.getFullYear() === year && eventDate.getMonth() === month;
        });

        const totalIncome = monthEvents.reduce((sum, e) => sum + (e.income || 0), 0);
        const totalExpense = monthEvents.reduce((sum, e) => {
          const expensesSum = e.expenses ? e.expenses.reduce((s, exp) => s + (exp.amount || 0), 0) : 0;
          return sum + expensesSum;
        }, 0);
        const profit = totalIncome - totalExpense;

        const summaryCard = document.createElement('div');
        summaryCard.className = 'day-list-row';
        summaryCard.style.cssText = `
          background: linear-gradient(135deg, rgba(245,158,11,0.15), rgba(245,158,11,0.08));
          border: 1.5px solid rgba(245,158,11,0.3);
          margin-top: 16px;
          cursor: pointer;
        `;

        summaryCard.innerHTML = `
          <div style="width: 44px; height: 44px; border-radius: 12px; background: linear-gradient(135deg, #f59e0b, #d97706); display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
            <i data-lucide="bar-chart-3" style="width: 22px; height: 22px; color: white;"></i>
          </div>
          <div style="flex: 1;">
            <div style="font-size: 15px; font-weight: 700; color: #fff;">–ò—Ç–æ–≥–∏ –∑–∞ ${MONTH_NAMES[month]}</div>
            <div style="font-size: 13px; color: rgba(245,158,11,0.9); margin-top: 2px;">–ù–∞–∂–º–∏ –¥–ª—è –ø–æ–¥—Ä–æ–±–Ω–æ–π —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏</div>
          </div>
          <div style="display: flex; flex-direction: column; align-items: flex-end; gap: 4px;">
            <div style="font-size: 16px; font-weight: 800; color: ${profit >= 0 ? '#22c55e' : '#ef4444'};">${profit.toLocaleString('ru-RU')} ‚ÇΩ</div>
            <div style="font-size: 11px; color: rgba(148,163,184,0.7);">${monthEvents.length} —Å–æ–±—ã—Ç–∏–π</div>
          </div>
        `;

        summaryCard.addEventListener('click', () => showMonthSummary(year, month));
        container.appendChild(summaryCard);
      }

      // –î–æ–±–∞–≤–ª—è–µ–º –∏—Ç–æ–≥–æ–≤—É—é –∫–∞—Ä—Ç–æ—á–∫—É –∑–∞ –≥–æ–¥ (—Ç–æ–ª—å–∫–æ 31 –¥–µ–∫–∞–±—Ä—è)
      if (selectedDay === 31 && month === 11) {
        const yearEvents = events.filter(e => {
          const eventDate = parseEventDate(e.date);
          return eventDate.getFullYear() === year;
        });

        const yearIncome = yearEvents.reduce((sum, e) => sum + (e.income || 0), 0);
        const yearExpense = yearEvents.reduce((sum, e) => {
          const expensesSum = e.expenses ? e.expenses.reduce((s, exp) => s + (exp.amount || 0), 0) : 0;
          return sum + expensesSum;
        }, 0);
        const yearProfit = yearIncome - yearExpense;

        const yearCard = document.createElement('div');
        yearCard.className = 'day-list-row';
        yearCard.style.cssText = `
          background: linear-gradient(135deg, rgba(147,51,234,0.15), rgba(147,51,234,0.08));
          border: 1.5px solid rgba(147,51,234,0.4);
          margin-top: 12px;
          cursor: pointer;
        `;

        yearCard.innerHTML = `
          <div style="width: 44px; height: 44px; border-radius: 12px; background: linear-gradient(135deg, #9333ea, #7e22ce); display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
            <i data-lucide="trophy" style="width: 22px; height: 22px; color: white;"></i>
          </div>
          <div style="flex: 1;">
            <div style="font-size: 15px; font-weight: 700; color: #fff;">–ò—Ç–æ–≥–∏ –∑–∞ ${year} –≥–æ–¥</div>
            <div style="font-size: 13px; color: rgba(147,51,234,0.9); margin-top: 2px;">–ù–∞–∂–º–∏ –¥–ª—è –ø–æ–ª–Ω–æ–π —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏</div>
          </div>
          <div style="display: flex; flex-direction: column; align-items: flex-end; gap: 4px;">
            <div style="font-size: 16px; font-weight: 800; color: ${yearProfit >= 0 ? '#22c55e' : '#ef4444'};">${yearProfit.toLocaleString('ru-RU')} ‚ÇΩ</div>
            <div style="font-size: 11px; color: rgba(148,163,184,0.7);">${yearEvents.length} —Å–æ–±—ã—Ç–∏–π</div>
          </div>
        `;

        yearCard.addEventListener('click', () => showYearSummary(year));
        container.appendChild(yearCard);
      }

      requestAnimationFrame(() => lucide.createIcons());
    }

    // ==========================================
    // DASHBOARD
    // ==========================================
    function renderUpcomingEvents() {
      const container = document.getElementById('upcoming-list');
      const today = new Date();
      today.setHours(0, 0, 0, 0);

      const upcoming = events
        .filter(e => parseEventDate(e.date) >= today)
        .sort((a, b) => parseEventDate(a.date) - parseEventDate(b.date))
        .slice(0, 5);

      if (upcoming.length === 0) {
        container.innerHTML = '<div style="text-align: center; padding: 16px; color: rgba(148,163,184,0.5); font-size: 13px;">–ù–µ—Ç –ø—Ä–µ–¥—Å—Ç–æ—è—â–∏—Ö —Å–æ–±—ã—Ç–∏–π</div>';
        return;
      }

      container.innerHTML = upcoming.map(event => {
        const typeInfo = getTypes()[event.type] || getTypes()[Object.keys(getTypes())[0]] || { label: '–°–æ–±—ã—Ç–∏–µ', color: '#f59e0b', image: 'icons/events/magician.png' };
        const eventDate = parseEventDate(event.date);
        const isToday = eventDate.toDateString() === today.toDateString();
        const tomorrow = new Date(today);
        tomorrow.setDate(tomorrow.getDate() + 1);
        const isTomorrow = eventDate.toDateString() === tomorrow.toDateString();

        let dateText = eventDate.toLocaleDateString('ru-RU', { day: 'numeric', month: 'short' });
        if (isToday) dateText = '–°–µ–≥–æ–¥–Ω—è';
        if (isTomorrow) dateText = '–ó–∞–≤—Ç—Ä–∞';

        return `
          <div style="display: flex; align-items: center; gap: 12px; padding: 12px; background: rgba(255,255,255,0.03); border: 1px solid rgba(245,158,11,0.1); border-radius: 12px; cursor: pointer;" onclick="editEvent(${event.id})">
            <div style="width: 40px; height: 40px; border-radius: 10px; background: ${typeInfo.color}15; border: 1px solid ${typeInfo.color}30; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
              ${typeInfo.image ? `<img src="${typeInfo.image}" style="width: 24px; height: 24px; object-fit: contain;">` : `<img src="icons/events/magician.png" style="width: 20px; height: 20px; object-fit: contain;">`}
            </div>
            <div style="flex: 1; min-width: 0;">
              <div style="font-size: 14px; font-weight: 700; color: #fff; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${escapeHtml(event.title)}</div>
              <div style="font-size: 12px; color: rgba(148,163,184,0.7);">${event.time || ''} ${event.location ? '‚Ä¢ ' + escapeHtml(event.location) : ''}</div>
            </div>
            <div style="text-align: right; flex-shrink: 0;">
              <div style="font-size: 12px; font-weight: 700; color: ${isToday ? '#22c55e' : isTomorrow ? '#f59e0b' : 'rgba(148,163,184,0.8)'};">${dateText}</div>
              ${event.income ? '<div style="font-size: 11px; color: #22c55e;">' + event.income.toLocaleString('ru-RU') + ' ‚ÇΩ</div>' : ''}
            </div>
          </div>
        `;
      }).join('');

      lucide.createIcons();
    }

    function renderDashboard() {
      const year = currentDate.getFullYear();
      const month = currentDate.getMonth();

      const monthEvents = events.filter(e => {
        const eventDate = parseEventDate(e.date);
        return eventDate.getFullYear() === year && eventDate.getMonth() === month;
      });

      // –†–µ–ø–µ—Ç–∏—Ü–∏–∏ –Ω–µ —Å—á–∏—Ç–∞—é—Ç—Å—è –∑–∞ —à–æ—É, —Ç–æ–ª—å–∫–æ –∑–∞ –≤—ã—Ö–æ–¥—ã
      const totalShows = monthEvents.filter(e => e.status !== 'rehearsal').reduce((sum, e) => sum + (e.schedule?.length || 1), 0);
      const totalIncome = monthEvents.reduce((sum, e) => sum + (e.income || 0), 0);
      const totalExpense = monthEvents.reduce((sum, e) => {
        const expensesSum = e.expenses ? e.expenses.reduce((s, exp) => s + (exp.amount || 0), 0) : 0;
        return sum + expensesSum;
      }, 0);
      const totalPrepay = monthEvents.reduce((sum, e) => sum + (e.prepay || 0), 0);
      const totalTax = monthEvents.reduce((sum, e) => {
        const taxAmount = ((e.income || 0) * (e.tax || 0)) / 100;
        return sum + taxAmount;
      }, 0);
      const profit = totalIncome - totalExpense;
      const avgCheck = monthEvents.length > 0 ? Math.round(totalIncome / monthEvents.length) : 0;
      const netProfit = totalIncome - totalExpense - totalTax;

      // Update KPIs
      document.getElementById('profit-amount').textContent = `${Math.round(profit).toLocaleString('ru-RU')} ‚ÇΩ`;
      document.getElementById('kpi-income').textContent = `${Math.round(totalIncome).toLocaleString('ru-RU')} ‚ÇΩ`;
      document.getElementById('kpi-expense').textContent = `${Math.round(totalExpense).toLocaleString('ru-RU')} ‚ÇΩ`;
      const rehearsalCount = monthEvents.filter(e => e.status === 'rehearsal').length;
      if (totalShows > 0 && rehearsalCount > 0) {
        document.getElementById('kpi-shows').textContent = `${totalShows} —à–æ—É, ${rehearsalCount} —Ä–µ–ø`;
      } else if (totalShows > 0) {
        document.getElementById('kpi-shows').textContent = `${totalShows} —à–æ—É`;
      } else if (rehearsalCount > 0) {
        document.getElementById('kpi-shows').textContent = `${rehearsalCount} —Ä–µ–ø`;
      } else {
        document.getElementById('kpi-shows').textContent = '0';
      }
      document.getElementById('kpi-avg').textContent = `${avgCheck.toLocaleString('ru-RU')} ‚ÇΩ`;
      document.getElementById('kpi-balance').textContent = `${Math.round(netProfit).toLocaleString('ru-RU')} ‚ÇΩ`;
      document.getElementById('kpi-tax').textContent = `${Math.round(totalTax).toLocaleString('ru-RU')} ‚ÇΩ`;

      // Goal progress
      const goalPercent = monthlyGoal > 0 ? Math.min(Math.round((profit / monthlyGoal) * 100), 100) : 0;
      document.getElementById('goal-progress').style.width = `${goalPercent}%`;
      document.getElementById('goal-percent').textContent = `${goalPercent}%`;
      document.getElementById('goal-text').textContent = `–¶–µ–ª—å: ${monthlyGoal.toLocaleString('ru-RU')} ‚ÇΩ`;

      // Render upcoming events
      renderUpcomingEvents();

      // Check if goal achieved (100% or more) and trigger celebration
      if (monthlyGoal > 0 && profit >= monthlyGoal) {
        const celebrationKey = `goal-celebration-${year}-${month}`;
        const hasSeenCelebration = localStorage.getItem(celebrationKey);

        if (!hasSeenCelebration) {
          setTimeout(() => {
            triggerMagicHatCelebration();
            localStorage.setItem(celebrationKey, 'true');
          }, 800);
        }
      }

      // Insights
      const insights = [];
      if (monthEvents.length > 0) {
        insights.push(`üìä –í —ç—Ç–æ–º –º–µ—Å—è—Ü–µ ${monthEvents.length} —Å–æ–±—ã—Ç–∏–π (${totalShows} –≤—ã—Ö–æ–¥–æ–≤)`);

        if (profit > 0) {
          insights.push(`üí∞ –ü—Ä–∏–±—ã–ª—å —Å–æ—Å—Ç–∞–≤–∏–ª–∞ ${Math.round(profit).toLocaleString('ru-RU')} ‚ÇΩ`);
        }

        if (avgCheck > 0) {
          insights.push(`üìà –°—Ä–µ–¥–Ω–∏–π —á–µ–∫: ${avgCheck.toLocaleString('ru-RU')} ‚ÇΩ`);
        }

        const remainingBalance = totalIncome - totalPrepay;
        if (remainingBalance > 0) {
          insights.push(`üí≥ –û—Å—Ç–∞–ª–æ—Å—å —Å–æ–±—Ä–∞—Ç—å ${Math.round(remainingBalance).toLocaleString('ru-RU')} ‚ÇΩ`);
        }

        const profitMargin = totalIncome > 0 ? Math.round((profit / totalIncome) * 100) : 0;
        if (profitMargin > 0) {
          insights.push(`üìä –ú–∞—Ä–∂–∏–Ω–∞–ª—å–Ω–æ—Å—Ç—å: ${profitMargin}%`);
        }
      } else {
        insights.push('üìÖ –í —ç—Ç–æ–º –º–µ—Å—è—Ü–µ –ø–æ–∫–∞ –Ω–µ—Ç —Å–æ–±—ã—Ç–∏–π');
      }

      const insightsList = document.getElementById('insights-list');
      insightsList.innerHTML = insights.map(i => `<div>${i}</div>`).join('');

      // Type analytics - —Å—á–∏—Ç–∞–µ–º —Ç–æ–ª—å–∫–æ —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ —Ç–∏–ø—ã —Å–æ–±—ã—Ç–∏–π
      const typeStats = {};
      monthEvents.forEach(event => {
        // –ë–µ—Ä—ë–º –æ—Å–Ω–æ–≤–Ω–æ–π —Ç–∏–ø —Å–æ–±—ã—Ç–∏—è (–ø–µ—Ä–≤—ã–π show –≤ schedule –∏–ª–∏ event.type)
        let mainType = 'rabbit';

        if (event.schedule && event.schedule.length > 0) {
          mainType = event.schedule[0].type || 'rabbit';
        } else {
          mainType = event.type || 'rabbit';
        }

        if (!typeStats[mainType]) {
          typeStats[mainType] = { count: 0, income: 0 };
        }

        typeStats[mainType].count++;
        typeStats[mainType].income += event.income || 0;
      });

      const typesList = document.getElementById('types-list');
      typesList.innerHTML = '';

      Object.keys(typeStats).sort((a, b) => typeStats[b].count - typeStats[a].count).forEach(type => {
        const allTypes = getTypes();
        const typeInfo = allTypes[type] || allTypes[Object.keys(allTypes)[0]];
        const stats = typeStats[type];
        const percent = monthEvents.length > 0 ? Math.round((stats.count / monthEvents.length) * 100) : 0;

        const div = document.createElement('div');
        div.style.cssText = 'background: linear-gradient(135deg, rgba(255,255,255,0.04), rgba(255,255,255,0.02)); border: 1px solid rgba(245,158,11,0.1); border-radius: 14px; padding: 14px;';
        div.innerHTML = `
          <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px;">
            <div style="display: flex; align-items: center; gap: 10px;">
              ${typeInfo.image ? `<img src="${typeInfo.image}" style="width: 20px; height: 20px; object-fit: contain;">` : `<img src="icons/events/magician.png" style="width: 20px; height: 20px; object-fit: contain;">`}
              <span style="font-size: 14px; font-weight: 700; color: #fff;">${escapeHtml(typeInfo.label)}</span>
            </div>
            <span style="font-size: 13px; font-weight: 800; color: ${typeInfo.color}; font-family: 'JetBrains Mono', monospace;">${stats.count}</span>
          </div>
          <div style="height: 6px; background: rgba(0,0,0,0.3); border-radius: 999px; overflow: hidden; margin-bottom: 8px;">
            <div style="height: 100%; background: ${typeInfo.color}; width: ${percent}%; transition: width 0.5s;"></div>
          </div>
          <div style="display: flex; justify-content: space-between; font-size: 11px; color: rgba(148,163,184,0.8);">
            <span>${percent}% –æ—Ç –≤—Å–µ—Ö</span>
            <span>${Math.round(stats.income).toLocaleString('ru-RU')} ‚ÇΩ</span>
          </div>
        `;
        typesList.appendChild(div);
      });

      // Top type
      const sortedTypes = Object.keys(typeStats).sort((a, b) => typeStats[b].count - typeStats[a].count);
      if (sortedTypes.length > 0) {
        const topType = sortedTypes[0];
        const allTypes = getTypes();
        document.getElementById('kpi-top-type').textContent = allTypes[topType]?.label || topType;
      } else {
        document.getElementById('kpi-top-type').textContent = '‚Äî';
      }

      // Best day (highest income day)
      const dayIncomes = {};
      monthEvents.forEach(event => {
        const day = parseEventDate(event.date).getDate();
        if (!dayIncomes[day]) dayIncomes[day] = 0;
        dayIncomes[day] += event.income || 0;
      });

      const bestDay = Object.keys(dayIncomes).sort((a, b) => dayIncomes[b] - dayIncomes[a])[0];
      if (bestDay) {
        document.getElementById('kpi-best-day').textContent = `${bestDay} ${MONTH_NAMES[month]}`;
      } else {
        document.getElementById('kpi-best-day').textContent = '‚Äî';
      }

      // Render period comparison
      renderPeriodComparison();

      lucide.createIcons();
    }

    // ==========================================
    // PERIOD COMPARISON
    // ==========================================
    function renderPeriodComparison() {
      const container = document.getElementById('comparison-content');
      if (!container) return;

      const year = currentDate.getFullYear();
      const month = currentDate.getMonth();
      const lastYear = year - 1;

      // –¢–µ–∫—É—â–∏–π –º–µ—Å—è—Ü
      const currentMonthEvents = events.filter(e => {
        const eventDate = parseEventDate(e.date);
        return eventDate.getFullYear() === year && eventDate.getMonth() === month;
      });

      // –¢–æ—Ç –∂–µ –º–µ—Å—è—Ü –ø—Ä–æ—à–ª–æ–≥–æ –≥–æ–¥–∞
      const lastYearEvents = events.filter(e => {
        const eventDate = parseEventDate(e.date);
        return eventDate.getFullYear() === lastYear && eventDate.getMonth() === month;
      });

      // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ç–µ–∫—É—â–µ–≥–æ –º–µ—Å—è—Ü–∞
      const currentIncome = currentMonthEvents.reduce((sum, e) => sum + (e.income || 0), 0);
      const currentExpense = currentMonthEvents.reduce((sum, e) => {
        return sum + (e.expenses ? e.expenses.reduce((s, exp) => s + (exp.amount || 0), 0) : 0);
      }, 0);
      const currentProfit = currentIncome - currentExpense;
      const currentCount = currentMonthEvents.length;
      const currentShows = currentMonthEvents.filter(e => e.status !== 'rehearsal').reduce((sum, e) => sum + (e.schedule?.length || 1), 0);

      // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø—Ä–æ—à–ª–æ–≥–æ –≥–æ–¥–∞
      const lastIncome = lastYearEvents.reduce((sum, e) => sum + (e.income || 0), 0);
      const lastExpense = lastYearEvents.reduce((sum, e) => {
        return sum + (e.expenses ? e.expenses.reduce((s, exp) => s + (exp.amount || 0), 0) : 0);
      }, 0);
      const lastProfit = lastIncome - lastExpense;
      const lastCount = lastYearEvents.length;
      const lastShows = lastYearEvents.filter(e => e.status !== 'rehearsal').reduce((sum, e) => sum + (e.schedule?.length || 1), 0);

      // –†–∞—Å—á—ë—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π
      const incomeChange = lastIncome > 0 ? Math.round(((currentIncome - lastIncome) / lastIncome) * 100) : (currentIncome > 0 ? 100 : 0);
      const profitChange = lastProfit !== 0 ? Math.round(((currentProfit - lastProfit) / Math.abs(lastProfit)) * 100) : (currentProfit > 0 ? 100 : 0);
      const countChange = lastCount > 0 ? Math.round(((currentCount - lastCount) / lastCount) * 100) : (currentCount > 0 ? 100 : 0);

      // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è
      const formatChange = (change, suffix = '%') => {
        if (change > 0) return `<span style="color: #22c55e;">+${change}${suffix}</span>`;
        if (change < 0) return `<span style="color: #ef4444;">${change}${suffix}</span>`;
        return `<span style="color: rgba(148,163,184,0.7);">0${suffix}</span>`;
      };

      // –ï—Å–ª–∏ –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö –∑–∞ –ø—Ä–æ—à–ª—ã–π –≥–æ–¥
      if (lastYearEvents.length === 0 && currentMonthEvents.length === 0) {
        container.innerHTML = `
          <div style="text-align: center; padding: 20px; color: rgba(148,163,184,0.5); font-size: 13px;">
            –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è
          </div>
        `;
        return;
      }

      container.innerHTML = `
        <div style="display: grid; grid-template-columns: 1fr auto 1fr; gap: 12px; align-items: center; margin-bottom: 16px;">
          <div style="text-align: center; padding: 12px; background: rgba(139,92,246,0.1); border: 1px solid rgba(139,92,246,0.2); border-radius: 12px;">
            <div style="font-size: 11px; color: rgba(139,92,246,0.8); margin-bottom: 4px;">${MONTH_NAMES[month]} ${lastYear}</div>
            <div style="font-size: 18px; font-weight: 800; color: #fff;">${lastProfit.toLocaleString('ru-RU')} ‚ÇΩ</div>
            <div style="font-size: 11px; color: rgba(148,163,184,0.6);">${lastCount} —Å–æ–±—ã—Ç–∏–π</div>
          </div>
          <div style="display: flex; flex-direction: column; align-items: center; gap: 4px;">
            <i data-lucide="arrow-right" style="width: 20px; height: 20px; color: rgba(139,92,246,0.6);"></i>
          </div>
          <div style="text-align: center; padding: 12px; background: rgba(245,158,11,0.1); border: 1px solid rgba(245,158,11,0.2); border-radius: 12px;">
            <div style="font-size: 11px; color: rgba(245,158,11,0.8); margin-bottom: 4px;">${MONTH_NAMES[month]} ${year}</div>
            <div style="font-size: 18px; font-weight: 800; color: #fff;">${currentProfit.toLocaleString('ru-RU')} ‚ÇΩ</div>
            <div style="font-size: 11px; color: rgba(148,163,184,0.6);">${currentCount} —Å–æ–±—ã—Ç–∏–π</div>
          </div>
        </div>

        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px;">
          <div style="padding: 12px; background: rgba(0,0,0,0.3); border: 1px solid rgba(139,92,246,0.15); border-radius: 10px; text-align: center;">
            <div style="font-size: 10px; color: rgba(148,163,184,0.7); margin-bottom: 4px; text-transform: uppercase;">–î–æ—Ö–æ–¥</div>
            <div style="font-size: 14px; font-weight: 700;">${formatChange(incomeChange)}</div>
          </div>
          <div style="padding: 12px; background: rgba(0,0,0,0.3); border: 1px solid rgba(139,92,246,0.15); border-radius: 10px; text-align: center;">
            <div style="font-size: 10px; color: rgba(148,163,184,0.7); margin-bottom: 4px; text-transform: uppercase;">–ü—Ä–∏–±—ã–ª—å</div>
            <div style="font-size: 14px; font-weight: 700;">${formatChange(profitChange)}</div>
          </div>
          <div style="padding: 12px; background: rgba(0,0,0,0.3); border: 1px solid rgba(139,92,246,0.15); border-radius: 10px; text-align: center;">
            <div style="font-size: 10px; color: rgba(148,163,184,0.7); margin-bottom: 4px; text-transform: uppercase;">–°–æ–±—ã—Ç–∏—è</div>
            <div style="font-size: 14px; font-weight: 700;">${formatChange(countChange)}</div>
          </div>
        </div>

        ${currentProfit > lastProfit && lastProfit > 0 ? `
        <div style="margin-top: 12px; padding: 10px 14px; background: rgba(34,197,94,0.1); border: 1px solid rgba(34,197,94,0.2); border-radius: 10px; display: flex; align-items: center; gap: 8px;">
          <i data-lucide="trending-up" style="width: 18px; height: 18px; color: #22c55e;"></i>
          <span style="font-size: 13px; color: #22c55e; font-weight: 600;">–†–æ—Å—Ç –ø–æ —Å—Ä–∞–≤–Ω–µ–Ω–∏—é —Å –ø—Ä–æ—à–ª—ã–º –≥–æ–¥–æ–º!</span>
        </div>
        ` : ''}

        ${currentProfit < lastProfit && lastProfit > 0 ? `
        <div style="margin-top: 12px; padding: 10px 14px; background: rgba(239,68,68,0.1); border: 1px solid rgba(239,68,68,0.2); border-radius: 10px; display: flex; align-items: center; gap: 8px;">
          <i data-lucide="trending-down" style="width: 18px; height: 18px; color: #ef4444;"></i>
          <span style="font-size: 13px; color: #ef4444; font-weight: 600;">–°–Ω–∏–∂–µ–Ω–∏–µ –ø–æ —Å—Ä–∞–≤–Ω–µ–Ω–∏—é —Å –ø—Ä–æ—à–ª—ã–º –≥–æ–¥–æ–º</span>
        </div>
        ` : ''}

        ${lastYearEvents.length === 0 && currentMonthEvents.length > 0 ? `
        <div style="margin-top: 12px; padding: 10px 14px; background: rgba(139,92,246,0.1); border: 1px solid rgba(139,92,246,0.2); border-radius: 10px; display: flex; align-items: center; gap: 8px;">
          <i data-lucide="info" style="width: 18px; height: 18px; color: #8b5cf6;"></i>
          <span style="font-size: 13px; color: rgba(148,163,184,0.9);">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –∑–∞ ${MONTH_NAMES[month]} ${lastYear}</span>
        </div>
        ` : ''}
      `;
    }

    // ==========================================
    // NAVIGATION
    // ==========================================
    function changeMonth(delta) {
      currentDate.setMonth(currentDate.getMonth() + delta);
      renderCalendar();
    }

    function selectDate(date) {
      selectedDate = new Date(date);
      renderCalendar();
    }

    // ==========================================
    // SETTINGS
    // ==========================================
    function openSettingsModal() {
      document.getElementById('goal-input').value = monthlyGoal;
      renderCustomTypesList();
      updateLicenseDisplay();
      document.getElementById('settings-modal').classList.add('show');
      lucide.createIcons();
    }

    function updateLicenseDisplay() {
      const stored = localStorage.getItem('illusionist_calendar_license');
      if (stored) {
        try {
          const data = JSON.parse(atob(stored));
          storedLicenseKey = data.key || '';
          keyVisible = false;
          document.getElementById('license-key-display').textContent = '****-****-****-****';
          document.getElementById('license-status-badge').textContent = '–ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–∞ ‚úì';
          document.getElementById('license-status-badge').style.color = '#34d399';
        } catch (e) {
          storedLicenseKey = '';
          document.getElementById('license-key-display').textContent = '****-****-****-****';
          document.getElementById('license-status-badge').textContent = '–ù–µ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–∞';
          document.getElementById('license-status-badge').style.color = '#ef4444';
        }
      } else {
        storedLicenseKey = '';
        document.getElementById('license-key-display').textContent = '****-****-****-****';
        document.getElementById('license-status-badge').textContent = '–ù–µ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–∞';
        document.getElementById('license-status-badge').style.color = '#ef4444';
      }
    }

    function toggleKeyVisibility() {
      keyVisible = !keyVisible;
      document.getElementById('license-key-display').textContent = keyVisible && storedLicenseKey ? storedLicenseKey : '****-****-****-****';
      const icon = document.getElementById('key-eye-icon');
      if (icon) {
        icon.setAttribute('data-lucide', keyVisible ? 'eye-off' : 'eye');
        lucide.createIcons();
      }
    }

    function resetLicense() {
      customConfirm('–°–±—Ä–æ—Å–∏—Ç—å –∞–∫—Ç–∏–≤–∞—Ü–∏—é –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è?\n\n–ü–æ—Å–ª–µ —Å–±—Ä–æ—Å–∞ –ø–æ—Ç—Ä–µ–±—É–µ—Ç—Å—è –ø–æ–≤—Ç–æ—Ä–Ω–∞—è –∞–∫—Ç–∏–≤–∞—Ü–∏—è.', () => {
        localStorage.removeItem('illusionist_calendar_license');
        showToast('–ê–∫—Ç–∏–≤–∞—Ü–∏—è —Å–±—Ä–æ—à–µ–Ω–∞');
        updateLicenseDisplay();

        setTimeout(() => {
          location.reload();
        }, 1000);
      });
    }

    function closeSettingsModal() {
      document.getElementById('settings-modal').classList.remove('show');
    }

    function saveGoal() {
      const value = parseFloat(document.getElementById('goal-input').value);
      if (value > 0) {
        monthlyGoal = value;
        saveGoalToStorage();
        renderDashboard();
        showToast('–¶–µ–ª—å –æ–±–Ω–æ–≤–ª–µ–Ω–∞!');
      } else {
        showToast('–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ');
      }
    }

    function exportData() {
      const data = {
        events: events,
        goal: monthlyGoal,
        customTypes: customTypes,
        expenseCategories: EXPENSE_CATEGORIES,
        version: 'v3.1',
        date: new Date().toISOString()
      };

      const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `IllusionistOS_Backup_${new Date().toISOString().split('T')[0]}.json`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);

      showToast('–î–∞–Ω–Ω—ã–µ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã!');
    }

    function importData(input) {
      const file = input.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = (e) => {
        try {
          const data = JSON.parse(e.target.result);

          if (data.events) {
            events = data.events;
            saveEvents();
          }

          if (data.goal) {
            monthlyGoal = parseFloat(data.goal) || 200000;
            saveGoalToStorage();
          }

          if (data.customTypes) {
            customTypes = sanitizeImportKeys(data.customTypes);
            saveCustomTypes();
          }

          if (data.expenseCategories) {
            EXPENSE_CATEGORIES = sanitizeImportKeys(data.expenseCategories);
            saveCustomExpenseCategories();
          }

          renderCalendar();
          if (currentView === 'dashboard') {
            renderDashboard();
          }

          closeSettingsModal();
          showToast('–î–∞–Ω–Ω—ã–µ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã!');
        } catch (err) {
          showToast('–û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞ –¥–∞–Ω–Ω—ã—Ö');
        }
      };
      reader.readAsText(file);
    }

    function resetData() {
      customConfirm('–£–¥–∞–ª–∏—Ç—å –≤—Å–µ —Å–æ–±—ã—Ç–∏—è –∏ —Å–±—Ä–æ—Å–∏—Ç—å —Ü–µ–ª—å? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å!', () => {
        events = [];
        monthlyGoal = 200000;
        localStorage.removeItem('illusionist_events');
        localStorage.removeItem('illusionist_goal');

        renderCalendar();
        renderDayList();
        if (currentView === 'dashboard') {
          renderDashboard();
        }
        closeSettingsModal();
        showToast('–î–∞–Ω–Ω—ã–µ —Å–±—Ä–æ—à–µ–Ω—ã');
      });
    }

    function resetCelebrations() {
      // Remove all celebration flags
      const keys = Object.keys(localStorage);
      keys.forEach(key => {
        if (key.startsWith('goal-celebration-')) {
          localStorage.removeItem(key);
        }
      });

      closeSettingsModal();
      showToast('–ê–Ω–∏–º–∞—Ü–∏–∏ —Å–±—Ä–æ—à–µ–Ω—ã! –û—Ç–∫—Ä–æ–π—Ç–µ Dashboard');
    }

    // ==========================================
    // CUSTOM TYPES
    // ==========================================
    function openTypeEditor(typeKey = null) {
      editingTypeKey = typeKey;

      if (typeKey) {
        const type = getTypes()[typeKey];
        if (type) {
          document.getElementById('type-editor-title').textContent = '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Ç–∏–ø';
          document.getElementById('type-name').value = type.label;
          selectedColor = type.color;
          // –ò–∑–≤–ª–µ–∫–∞–µ–º –∏–º—è –∏–∫–æ–Ω–∫–∏ –∏–∑ image path (icons/events/magician.png ‚Üí magician)
          selectedIcon = type.image ? type.image.replace('icons/events/', '').replace('.png', '') : 'magician';
          document.getElementById('delete-type-btn').style.display = 'block';
        }
      } else {
        document.getElementById('type-editor-title').textContent = '–ù–æ–≤—ã–π —Ç–∏–ø —Å–æ–±—ã—Ç–∏—è';
        document.getElementById('type-name').value = '';
        selectedColor = '#f59e0b';
        selectedIcon = 'magician';
        document.getElementById('delete-type-btn').style.display = 'none';
      }

      renderIconGrid();
      updateColorSelection();
      document.getElementById('type-editor-modal').classList.add('show');
      lucide.createIcons();
    }

    function closeTypeEditor() {
      document.getElementById('type-editor-modal').classList.remove('show');
      editingTypeKey = null;
    }

    function renderIconGrid() {
      const grid = document.getElementById('icon-grid');
      grid.innerHTML = '';

      AVAILABLE_ICONS.forEach(icon => {
        const btn = document.createElement('button');
        btn.className = 'icon-btn';
        if (icon === selectedIcon) btn.classList.add('selected');
        btn.innerHTML = `<img src="icons/events/${icon}.png" style="width: 24px; height: 24px; object-fit: contain;">`;
        btn.onclick = () => {
          selectedIcon = icon;
          document.querySelectorAll('.icon-btn').forEach(b => b.classList.remove('selected'));
          btn.classList.add('selected');
        };
        grid.appendChild(btn);
      });
    }

    function selectColor(color) {
      selectedColor = color;
      updateColorSelection();
    }

    function updateColorSelection() {
      document.querySelectorAll('.color-btn').forEach(btn => {
        if (btn.dataset.color === selectedColor) {
          btn.classList.add('selected');
        } else {
          btn.classList.remove('selected');
        }
      });
    }

    function saveCustomType() {
      const name = document.getElementById('type-name').value.trim();

      if (!name) {
        showToast('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —Ç–∏–ø–∞');
        return;
      }

      const key = editingTypeKey || `custom_${Date.now()}`;

      customTypes[key] = {
        label: name,
        color: selectedColor,
        image: `icons/events/${selectedIcon}.png`
      };

      saveCustomTypes();
      closeTypeEditor();
      renderCustomTypesList();
      showToast(editingTypeKey ? '–¢–∏–ø –æ–±–Ω–æ–≤–ª—ë–Ω!' : '–¢–∏–ø —Å–æ–∑–¥–∞–Ω!');
      lucide.createIcons();
    }

    function deleteCustomType() {
      if (!editingTypeKey) return;

      const type = getTypes()[editingTypeKey];
      const key = editingTypeKey;

      customConfirm(`–£–¥–∞–ª–∏—Ç—å —Ç–∏–ø "${type.label}"?`, () => {
        // Check if any events use this type
        const eventsUsingType = events.filter(e => {
          if (e.type === key) return true;
          if (e.schedule) {
            return e.schedule.some(s => s.type === key);
          }
          return false;
        });

        const performDelete = () => {
          if (eventsUsingType.length > 0) {
            // Update events to use default type
            events.forEach(event => {
              if (event.type === key) {
                event.type = 'rabbit';
              }
              if (event.schedule) {
                event.schedule.forEach(s => {
                  if (s.type === key) {
                    s.type = 'rabbit';
                  }
                });
              }
            });
            saveEvents();
          }

          // Remove type
          if (DEFAULT_TYPES[key]) {
            if (!customTypes._hidden) customTypes._hidden = [];
            if (!customTypes._hidden.includes(key)) {
              customTypes._hidden.push(key);
            }
          } else {
            delete customTypes[key];
          }

          saveCustomTypes();
          closeTypeEditor();
          renderCustomTypesList();
          renderCalendar();
          renderDayList();
          if (currentView === 'dashboard') {
            renderDashboard();
          }
          showToast('–¢–∏–ø —É–¥–∞–ª—ë–Ω');
          lucide.createIcons();
        };

        if (eventsUsingType.length > 0) {
          customConfirm(`${eventsUsingType.length} —Å–æ–±—ã—Ç–∏–π –∏—Å–ø–æ–ª—å–∑—É—é—Ç —ç—Ç–æ—Ç —Ç–∏–ø. –û–Ω–∏ –±—É–¥—É—Ç –∏–∑–º–µ–Ω–µ–Ω—ã –Ω–∞ "–ö—Ä–æ–ª–∏–∫". –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å?`, performDelete);
        } else {
          performDelete();
        }
      });
    }

    function renderCustomTypesList() {
      const container = document.getElementById('custom-types-list');
      const allTypes = getTypes();

      container.innerHTML = '';

      Object.keys(allTypes).forEach(key => {
        const type = allTypes[key];
        const isDefault = DEFAULT_TYPES[key];

        const row = document.createElement('div');
        row.style.cssText = 'display: flex; align-items: center; gap: 12px; padding: 12px; background: linear-gradient(135deg, rgba(255,255,255,0.04), rgba(255,255,255,0.02)); border: 1px solid rgba(245,158,11,0.1); border-radius: 12px; transition: all 0.3s;';

        row.innerHTML = `
          <div style="width: 40px; height: 40px; background: ${type.color}15; border: 1px solid ${type.color}30; border-radius: 10px; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
            ${type.image ? `<img src="${type.image}" style="width: 24px; height: 24px; object-fit: contain;">` : `<img src="icons/events/magician.png" style="width: 20px; height: 20px; object-fit: contain;">`}
          </div>
          <div style="flex: 1; min-width: 0; cursor: pointer;" onclick="openTypeEditor('${escapeOnclick(key)}')">
            <div style="font-size: 14px; font-weight: 700; color: #fff;">${escapeHtml(type.label)}</div>
            <div style="font-size: 11px; color: rgba(148,163,184,0.7); margin-top: 2px;">${isDefault ? '–ü–æ —É–º–æ–ª—á–∞–Ω–∏—é' : '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π'}</div>
          </div>
          <div style="width: 24px; height: 24px; border-radius: 6px; background: ${type.color}; border: 2px solid rgba(255,255,255,0.2); flex-shrink: 0;"></div>
          <button onclick="event.stopPropagation(); deleteTypeFromList('${escapeOnclick(key)}')" style="width: 36px; height: 36px; background: rgba(239,68,68,0.1); border: 1px solid rgba(239,68,68,0.2); border-radius: 10px; display: flex; align-items: center; justify-content: center; cursor: pointer; color: #ef4444; transition: all 0.3s; flex-shrink: 0;" onmouseenter="this.style.background='rgba(239,68,68,0.2)'; this.style.transform='scale(1.05)';" onmouseleave="this.style.background='rgba(239,68,68,0.1)'; this.style.transform='scale(1)';">
            <i data-lucide="trash-2" style="width: 16px; height: 16px;"></i>
          </button>
        `;

        container.appendChild(row);
      });

      lucide.createIcons();
    }

    function deleteTypeFromList(key) {
      const type = getTypes()[key];

      customConfirm(`–£–¥–∞–ª–∏—Ç—å —Ç–∏–ø "${type.label}"?`, () => {
        // Check if any events use this type
        const eventsUsingType = events.filter(e => {
          if (e.type === key) return true;
          if (e.schedule) {
            return e.schedule.some(s => s.type === key);
          }
          return false;
        });

        const performDelete = () => {
          if (eventsUsingType.length > 0) {
            // Update events to use default type
            events.forEach(event => {
              if (event.type === key) {
                event.type = 'rabbit';
              }
              if (event.schedule) {
                event.schedule.forEach(s => {
                  if (s.type === key) {
                    s.type = 'rabbit';
                  }
                });
              }
            });
            saveEvents();
          }

          // Remove from custom types or hide default
          if (DEFAULT_TYPES[key]) {
            // For default types, we'll hide them by overriding in customTypes
            if (!customTypes._hidden) customTypes._hidden = [];
            if (!customTypes._hidden.includes(key)) {
              customTypes._hidden.push(key);
            }
          } else {
            delete customTypes[key];
          }

          saveCustomTypes();
          renderCustomTypesList();
          renderCalendar();
          renderDayList();
          if (currentView === 'dashboard') {
            renderDashboard();
          }
          showToast('–¢–∏–ø —É–¥–∞–ª—ë–Ω');
          lucide.createIcons();
        };

        if (eventsUsingType.length > 0) {
          customConfirm(`${eventsUsingType.length} —Å–æ–±—ã—Ç–∏–π –∏—Å–ø–æ–ª—å–∑—É—é—Ç —ç—Ç–æ—Ç —Ç–∏–ø. –û–Ω–∏ –±—É–¥—É—Ç –∏–∑–º–µ–Ω–µ–Ω—ã –Ω–∞ "–ö—Ä–æ–ª–∏–∫". –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å?`, performDelete);
        } else {
          performDelete();
        }
      });
    }

    // ==========================================
    // MONTH PICKER
    // ==========================================
    function openMonthPicker() {
      pickerYear = currentDate.getFullYear();
      document.getElementById('picker-year').textContent = pickerYear;
      highlightCurrentMonth();
      document.getElementById('month-picker-modal').classList.add('show');
      lucide.createIcons();
    }

    function closeMonthPicker() {
      document.getElementById('month-picker-modal').classList.remove('show');
    }

    function changePickerYear(delta) {
      pickerYear += delta;
      document.getElementById('picker-year').textContent = pickerYear;
      highlightCurrentMonth();
    }

    function selectMonth(monthIndex) {
      currentDate = new Date(pickerYear, monthIndex, 1);
      selectedDate = new Date(pickerYear, monthIndex, 1);
      renderCalendar();
      if (currentView === 'dashboard') {
        renderDashboard();
      }
      closeMonthPicker();
    }

    function highlightCurrentMonth() {
      const buttons = document.querySelectorAll('.month-btn');
      const currentMonth = currentDate.getMonth();
      const currentYear = currentDate.getFullYear();

      buttons.forEach((btn, index) => {
        if (pickerYear === currentYear && index === currentMonth) {
          btn.classList.add('active');
        } else {
          btn.classList.remove('active');
        }
      });
    }

    // ==========================================
    // EVENT MODAL
    // ==========================================
    function openEventModal(date = null) {
      editingEventId = null;
      document.getElementById('modal-title').textContent = '–ù–æ–≤–æ–µ —Å–æ–±—ã—Ç–∏–µ';
      document.getElementById('delete-btn').style.display = 'none';
      document.getElementById('copy-btn').style.display = 'none';

      resetForm();
      resetSectionStates();
      updateExpenseCategorySelect();

      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–µ–∫—Ü–∏—é –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏—è –¥–ª—è –Ω–æ–≤—ã—Ö —Å–æ–±—ã—Ç–∏–π
      const repeatSection = document.getElementById('section-repeat');
      if (repeatSection) {
        repeatSection.style.display = 'block';
      }

      const dateInput = document.getElementById('event-date');
      if (date) {
        dateInput.value = formatDateInput(date);
      } else {
        dateInput.value = formatDateInput(selectedDate);
      }

      document.getElementById('event-modal').classList.add('show');
      lucide.createIcons();
      formDirty = false;
    }

    function editEvent(eventId) {
      const event = events.find(e => e.id === eventId);
      if (!event) return;

      editingEventId = eventId;

      // –§–æ—Ä–º–∏—Ä—É–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ —Å–µ—Ä–∏–∏
      let title = '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å';
      if (event.seriesId) {
        title = `–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å (${event.seriesIndex}/${event.seriesTotal})`;
      }
      document.getElementById('modal-title').textContent = title;
      document.getElementById('delete-btn').style.display = 'block';
      document.getElementById('copy-btn').style.display = 'block';

      resetSectionStates();
      updateExpenseCategorySelect();

      // –°–∫—Ä—ã–≤–∞–µ–º —Å–µ–∫—Ü–∏—é –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏—è –ø—Ä–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏
      const repeatSection = document.getElementById('section-repeat');
      if (repeatSection) {
        repeatSection.style.display = 'none';
      }

      document.getElementById('event-title').value = event.title || '';
      document.getElementById('event-date').value = event.date || '';
      document.getElementById('event-status').value = event.status || 'pending';
      document.getElementById('event-location').value = event.location || '';
      document.getElementById('event-address').value = event.address || '';
      document.getElementById('event-client').value = event.client || '';
      document.getElementById('event-phone').value = event.phone || '';
      document.getElementById('event-guests').value = event.guests || '';
      document.getElementById('event-income').value = event.income || '';
      document.getElementById('event-prepay').value = event.prepay || '';
      document.getElementById('event-tax').value = event.tax || '';
      document.getElementById('event-notes').value = event.notes || '';

      schedule = event.schedule || [{ type: 'rabbit', time: '19:00', duration: 60 }];
      renderSchedule();

      expenses = event.expenses || [];
      renderExpenses();

      calculateBalance();

      document.getElementById('event-modal').classList.add('show');
      lucide.createIcons();
      formDirty = false;
    }

    // === –°–í–û–†–ê–ß–ò–í–ê–ù–ò–ï –°–ï–ö–¶–ò–ô –í –§–û–†–ú–ï ===
    function toggleSection(sectionId) {
      const section = document.getElementById(sectionId);
      if (section) {
        section.classList.toggle('collapsed');
        // –û–±–Ω–æ–≤–ª—è–µ–º –∏–∫–æ–Ω–∫—É –ø–æ—Å–ª–µ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è
        setTimeout(() => lucide.createIcons(), 10);
      }
    }

    // –°–±—Ä–æ—Å–∏—Ç—å —Å–µ–∫—Ü–∏–∏ –∫ –Ω–∞—á–∞–ª—å–Ω–æ–º—É —Å–æ—Å—Ç–æ—è–Ω–∏—é (–û—Å–Ω–æ–≤–Ω–æ–µ –æ—Ç–∫—Ä—ã—Ç–æ, –æ—Å—Ç–∞–ª—å–Ω—ã–µ –∑–∞–∫—Ä—ã—Ç—ã)
    function resetSectionStates() {
      const basicSection = document.getElementById('section-basic');
      const repeatSection = document.getElementById('section-repeat');
      const scheduleSection = document.getElementById('section-schedule');
      const financeSection = document.getElementById('section-finance');
      const notesSection = document.getElementById('section-notes');

      if (basicSection) basicSection.classList.remove('collapsed');
      if (repeatSection) repeatSection.classList.add('collapsed');
      if (scheduleSection) scheduleSection.classList.add('collapsed');
      if (financeSection) financeSection.classList.add('collapsed');
      if (notesSection) notesSection.classList.add('collapsed');

      setTimeout(() => lucide.createIcons(), 10);
    }

    function tryCloseEventModal() {
      if (!formDirty) {
        closeEventModal();
        return;
      }
      const dlg = document.createElement('div');
      dlg.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.75);z-index:10001;display:flex;align-items:center;justify-content:center;padding:20px;';
      dlg.innerHTML = `
        <div style="width:100%;max-width:320px;background:rgba(15,15,20,0.98);backdrop-filter:blur(40px);-webkit-backdrop-filter:blur(40px);border:1.5px solid rgba(245,158,11,0.35);border-radius:24px;padding:24px;">
          <p style="color:#fff;font-size:15px;font-weight:700;text-align:center;margin:0 0 6px;">–ù–µ—Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è</p>
          <p style="color:rgba(255,255,255,0.55);font-size:13px;text-align:center;margin:0 0 20px;">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø–µ—Ä–µ–¥ –≤—ã—Ö–æ–¥–æ–º?</p>
          <div style="display:flex;flex-direction:column;gap:10px;">
            <button id="dlg-save" style="height:48px;border-radius:14px;font-size:14px;font-weight:700;background:linear-gradient(135deg,#f59e0b,#fbbf24);border:none;color:#0a0a0f;cursor:pointer;">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            <button id="dlg-discard" style="height:48px;border-radius:14px;font-size:14px;font-weight:700;background:rgba(239,68,68,0.12);border:1.5px solid rgba(239,68,68,0.3);color:#ef4444;cursor:pointer;">–°–±—Ä–æ—Å–∏—Ç—å</button>
            <button id="dlg-back" style="height:48px;border-radius:14px;font-size:14px;font-weight:700;background:rgba(255,255,255,0.07);border:1.5px solid rgba(255,255,255,0.15);color:#fff;cursor:pointer;">–û—Ç–º–µ–Ω–∞</button>
          </div>
        </div>
      `;
      document.body.appendChild(dlg);
      dlg.querySelector('#dlg-save').onclick = () => { dlg.remove(); saveEvent(); };
      dlg.querySelector('#dlg-discard').onclick = () => { dlg.remove(); closeEventModal(); };
      dlg.querySelector('#dlg-back').onclick = () => { dlg.remove(); };
    }

    function closeEventModal() {
      document.getElementById('event-modal').classList.remove('show');
      resetForm();
      formDirty = false;
    }

    function resetForm() {
      document.getElementById('event-title').value = '';
      document.getElementById('event-status').value = 'pending';
      document.getElementById('event-location').value = '';
      document.getElementById('event-address').value = '';
      document.getElementById('event-client').value = '';
      document.getElementById('event-phone').value = '';
      document.getElementById('event-guests').value = '';
      document.getElementById('event-income').value = '';
      document.getElementById('event-prepay').value = '';
      document.getElementById('event-tax').value = '';
      expenses = [];
      renderExpenses();
      document.getElementById('event-notes').value = '';
      calculateBalance();

      const customExpenseForm = document.getElementById('custom-expense-form');
      if (customExpenseForm) customExpenseForm.style.display = 'none';

      schedule = [{ type: 'rabbit', time: '19:00', duration: 60 }];
      renderSchedule();

      // –°–±—Ä–æ—Å –ø–æ–ª–µ–π –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏—è
      document.getElementById('event-repeat-type').value = 'none';
      document.getElementById('event-repeat-count').value = '4';
      document.getElementById('repeat-options').style.display = 'none';
    }

    // ==========================================
    // REPEAT (RECURRING EVENTS)
    // ==========================================
    function toggleRepeatOptions() {
      const repeatType = document.getElementById('event-repeat-type').value;
      const repeatOptions = document.getElementById('repeat-options');

      if (repeatType === 'none') {
        repeatOptions.style.display = 'none';
      } else {
        repeatOptions.style.display = 'block';
        updateRepeatPreview();
      }
    }

    function updateRepeatPreview() {
      const repeatType = document.getElementById('event-repeat-type').value;
      const repeatCount = parseInt(document.getElementById('event-repeat-count').value) || 4;
      const startDate = document.getElementById('event-date').value;

      if (!startDate || repeatType === 'none') return;

      const dates = generateRepeatDates(startDate, repeatType, repeatCount);
      const previewText = document.getElementById('repeat-preview-text');

      const typeLabels = {
        'daily': '–µ–∂–µ–¥–Ω–µ–≤–Ω–æ',
        'weekly': '–µ–∂–µ–Ω–µ–¥–µ–ª—å–Ω–æ',
        'biweekly': '–∫–∞–∂–¥—ã–µ 2 –Ω–µ–¥–µ–ª–∏',
        'monthly': '–µ–∂–µ–º–µ—Å—è—á–Ω–æ'
      };

      previewText.innerHTML = `<b>${dates.length}</b> —Å–æ–±—ã—Ç–∏–π (${typeLabels[repeatType]})<br><span style="font-size: 11px; opacity: 0.7;">–¥–æ ${formatDateRu(dates[dates.length - 1])}</span>`;
    }

    function generateRepeatDates(startDate, repeatType, count) {
      const dates = [];
      const [sy, sm, sd] = startDate.split('-').map(Number);
      let current = new Date(sy, sm - 1, sd);
      const originalDay = current.getDate();

      for (let i = 0; i < count; i++) {
        dates.push(formatDateInput(current));

        switch (repeatType) {
          case 'daily':
            current.setDate(current.getDate() + 1);
            break;
          case 'weekly':
            current.setDate(current.getDate() + 7);
            break;
          case 'biweekly':
            current.setDate(current.getDate() + 14);
            break;
          case 'monthly': {
            let nextMonth = current.getMonth() + 1;
            let nextYear = current.getFullYear();
            if (nextMonth > 11) { nextMonth = 0; nextYear++; }
            const lastDayOfMonth = new Date(nextYear, nextMonth + 1, 0).getDate();
            current = new Date(nextYear, nextMonth, Math.min(originalDay, lastDayOfMonth));
            break;
          }
        }
      }

      return dates;
    }

    function formatDateRu(dateStr) {
      const [y, m, d] = dateStr.split('-').map(Number);
      const months = ['—è–Ω–≤', '—Ñ–µ–≤', '–º–∞—Ä', '–∞–ø—Ä', '–º–∞–π', '–∏—é–Ω', '–∏—é–ª', '–∞–≤–≥', '—Å–µ–Ω', '–æ–∫—Ç', '–Ω–æ—è', '–¥–µ–∫'];
      return `${d} ${months[m - 1]} ${y}`;
    }

    // –°–ª—É—à–∞—Ç–µ–ª—å –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø—Ä–µ–≤—å—é –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –¥–∞—Ç—ã –∏–ª–∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞
    document.addEventListener('DOMContentLoaded', function () {
      const dateInput = document.getElementById('event-date');
      const countInput = document.getElementById('event-repeat-count');

      if (dateInput) {
        dateInput.addEventListener('change', updateRepeatPreview);
      }
      if (countInput) {
        countInput.addEventListener('input', updateRepeatPreview);
      }
    });

    // ==========================================
    // SCHEDULE MANAGEMENT
    // ==========================================
    function addScheduleItem() {
      schedule.push({
        type: currentType || 'rabbit',
        time: '19:00',
        duration: 60
      });
      renderSchedule();
      lucide.createIcons();
    }

    function removeScheduleItem(index) {
      if (schedule.length === 1) {
        showToast('–î–æ–ª–∂–µ–Ω –±—ã—Ç—å —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω –≤—ã—Ö–æ–¥');
        return;
      }
      schedule.splice(index, 1);
      renderSchedule();
      lucide.createIcons();
    }

    let typePickerIndex = null;

    function openTypePicker(index) {
      typePickerIndex = index;
      const allTypes = getTypes();
      const currentType = schedule[index].type;
      const container = document.getElementById('type-picker-list');
      container.innerHTML = '';

      Object.keys(allTypes).forEach(key => {
        const type = allTypes[key];
        const isActive = key === currentType;
        const btn = document.createElement('div');
        btn.style.cssText = `
          width: 100%; aspect-ratio: 1; border-radius: 18px; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
          background: ${isActive ? `linear-gradient(135deg, ${type.color}30, ${type.color}15)` : 'rgba(255,255,255,0.04)'};
          border: 2px solid ${isActive ? type.color : 'rgba(255,255,255,0.08)'};
          box-shadow: ${isActive ? `0 0 20px ${type.color}30, inset 0 0 15px ${type.color}10` : 'none'};
        `;
        btn.innerHTML = type.image
          ? `<img src="${type.image}" style="width: 26px; height: 26px; object-fit: contain;">`
          : `<img src="icons/events/magician.png" style="width: 26px; height: 26px; object-fit: contain;">`;
        btn.addEventListener('click', () => selectScheduleType(key));
        container.appendChild(btn);
      });

      const modal = document.getElementById('type-picker-modal');
      modal.classList.add('show');
      setTimeout(() => {
        document.getElementById('type-picker-sheet').style.transform = 'scale(1)';
        document.getElementById('type-picker-sheet').style.opacity = '1';
      }, 10);
      lucide.createIcons();
    }

    function selectScheduleType(typeKey) {
      if (typePickerIndex !== null) {
        schedule[typePickerIndex].type = typeKey;
        renderSchedule();
        lucide.createIcons();
      }
      closeTypePicker();
    }

    function closeTypePicker() {
      const sheet = document.getElementById('type-picker-sheet');
      sheet.style.transform = 'scale(0.9)';
      sheet.style.opacity = '0';
      setTimeout(() => {
        document.getElementById('type-picker-modal').classList.remove('show');
      }, 200);
      typePickerIndex = null;
    }

    function updateScheduleTime(index, time) {
      schedule[index].time = time;
    }

    function updateScheduleDuration(index, duration) {
      schedule[index].duration = parseInt(duration) || 60;
    }


    // ==========================================
    // EXPENSE CATEGORIES
    // ==========================================
    function saveCustomExpenseCategory() {
      const name = document.getElementById('custom-expense-name').value.trim();
      const emoji = document.getElementById('custom-expense-emoji').value.trim();

      if (!name) {
        showToast('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏');
        return;
      }

      if (!emoji) {
        showToast('–í—ã–±–µ—Ä–∏—Ç–µ —ç–º–æ–¥–∑–∏');
        return;
      }

      const key = 'custom_' + Date.now();
      EXPENSE_CATEGORIES[key] = {
        label: name,
        emoji: emoji,
        color: '#64748b'
      };

      saveCustomExpenseCategories();

      document.getElementById('custom-expense-form').style.display = 'none';
      document.getElementById('custom-expense-name').value = '';
      document.getElementById('custom-expense-emoji').value = '';

      // –û–±–Ω–æ–≤–ª—è–µ–º –≤—Å–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ select –≤ —Å–ø–∏—Å–∫–µ —Ä–∞—Å—Ö–æ–¥–æ–≤
      renderExpenses();

      showToast('–ö–∞—Ç–µ–≥–æ—Ä–∏—è —Å–æ–∑–¥–∞–Ω–∞!');
    }

    function updateExpenseCategorySelect() {
      // –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ —Ç–µ–ø–µ—Ä—å –≤ select –≤–Ω—É—Ç—Ä–∏ –∫–∞–∂–¥–æ–π —Å—Ç—Ä–æ–∫–∏ —Ä–∞—Å—Ö–æ–¥–æ–≤ ‚Äî –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –Ω–µ –Ω—É–∂–Ω–æ
      return;
    }

    function openCategoryManager() {
      renderCategoryManager();
      document.getElementById('category-manager-modal').classList.add('show');
      lucide.createIcons();
    }

    function closeCategoryManager() {
      document.getElementById('category-manager-modal').classList.remove('show');
      updateExpenseCategorySelect();
    }

    function renderCategoryManager() {
      const content = document.getElementById('category-manager-content');

      let html = `
        <div style="margin-bottom: 16px;">
          <div style="font-size: 14px; color: rgba(148,163,184,0.9); margin-bottom: 12px;">–í—Å–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</div>
          <div style="display: flex; flex-direction: column; gap: 8px;">
            ${Object.entries(EXPENSE_CATEGORIES).map(([key, cat]) => `
              <div style="display: flex; align-items: center; gap: 12px; padding: 12px; background: rgba(0,0,0,0.2); border: 1px solid rgba(148,163,184,0.1); border-radius: 10px;">
                <div style="width: 32px; height: 32px; border-radius: 8px; background: ${cat.color}20; border: 1px solid ${cat.color}40; display: flex; align-items: center; justify-content: center; font-size: 18px;">
                  ${escapeHtml(cat.emoji)}
                </div>
                <div style="flex: 1; font-size: 14px; color: #fff; font-weight: 600;">${escapeHtml(cat.label)}</div>
                <button onclick="deleteExpenseCategory('${escapeOnclick(key)}')" style="padding: 6px 10px; background: rgba(239,68,68,0.2); border: 1px solid rgba(239,68,68,0.3); border-radius: 8px; font-size: 12px; font-weight: 600; color: #ef4444; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; gap: 4px;">
                  <i data-lucide="trash-2" style="width: 14px; height: 14px;"></i>
                  –£–¥–∞–ª–∏—Ç—å
                </button>
              </div>
            `).join('')}
          </div>
        </div>
      `;

      if (Object.keys(EXPENSE_CATEGORIES).length === 0) {
        html = `
          <div style="padding: 20px; text-align: center; background: rgba(0,0,0,0.2); border: 1px solid rgba(148,163,184,0.1); border-radius: 10px;">
            <div style="font-size: 14px; color: rgba(148,163,184,0.7);">–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∫–∞—Ç–µ–≥–æ—Ä–∏–π</div>
          </div>
        `;
      }

      content.innerHTML = html;
    }

    function deleteExpenseCategory(key) {
      const category = EXPENSE_CATEGORIES[key];
      if (!category) return;

      customConfirm(`–£–¥–∞–ª–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é "${category.label}"?`, () => {
        delete EXPENSE_CATEGORIES[key];
        saveCustomExpenseCategories();
        renderCategoryManager();
        updateExpenseCategorySelect();
        showToast('–ö–∞—Ç–µ–≥–æ—Ä–∏—è —É–¥–∞–ª–µ–Ω–∞');
        lucide.createIcons();
      });
    }

    function renderSchedule() {
      const container = document.getElementById('schedule-list');
      container.innerHTML = '';

      schedule.forEach((item, index) => {
        const allTypes = getTypes();
        const typeInfo = allTypes[item.type] || allTypes[Object.keys(allTypes)[0]];

        const div = document.createElement('div');
        div.className = 'schedule-item';

        div.innerHTML = `
          <button type="button" class="schedule-type-btn" onclick="openTypePicker(${index})" style="color: ${typeInfo.color};" title="${escapeHtml(typeInfo.label)}">
            ${typeInfo.image ? `<img src="${typeInfo.image}" style="width: 24px; height: 24px; object-fit: contain;">` : `<img src="icons/events/magician.png" style="width: 24px; height: 24px; object-fit: contain;">`}
          </button>

          <div class="schedule-inputs">
            <input type="time" value="${escapeHtml(item.time || '')}" onchange="updateScheduleTime(${index}, this.value)" style="flex: 1;">
          </div>

          <input type="number" class="schedule-duration" value="${escapeHtml(String(item.duration || ''))}" onchange="updateScheduleDuration(${index}, this.value)" placeholder="–º–∏–Ω" min="1">

          <button type="button" class="schedule-remove" onclick="removeScheduleItem(${index})">
            <i data-lucide="x"></i>
          </button>
        `;

        container.appendChild(div);

        if (!item.checklist) item.checklist = [];

        const checklistDiv = document.createElement('div');
        checklistDiv.style.cssText = 'margin-top: 8px; padding-left: 48px;';

        item.checklist.forEach((check, checkIndex) => {
          const checkItem = document.createElement('div');
          checkItem.style.cssText = 'display: flex; align-items: center; gap: 8px; margin-bottom: 6px;';
          checkItem.innerHTML = `
            <input type="checkbox" ${check.done ? 'checked' : ''} onchange="toggleChecklistItem(${index}, ${checkIndex})" style="width: 22px; height: 22px; cursor: pointer; accent-color: #f59e0b; flex-shrink: 0;">
            <input type="text" value="${escapeHtml(check.text)}" onchange="updateChecklistItem(${index}, ${checkIndex}, this.value)" placeholder="–ü—É–Ω–∫—Ç –ø—Ä–æ–≥—Ä–∞–º–º—ã" style="flex: 1; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; padding: 6px 10px; color: #e2e8f0; font-size: 13px;">
            <button type="button" onclick="removeChecklistItem(${index}, ${checkIndex})" style="width: 28px; height: 28px; border-radius: 6px; background: rgba(239,68,68,0.1); border: 1px solid rgba(239,68,68,0.2); color: #ef4444; display: flex; align-items: center; justify-content: center; cursor: pointer;">
              <i data-lucide="x" style="width: 14px; height: 14px;"></i>
            </button>
          `;
          checklistDiv.appendChild(checkItem);
        });

        const addBtn = document.createElement('button');
        addBtn.type = 'button';
        addBtn.onclick = () => addChecklistItem(index);
        addBtn.style.cssText = 'margin-top: 6px; padding: 6px 12px; background: rgba(245,158,11,0.1); border: 1px solid rgba(245,158,11,0.2); color: #f59e0b; border-radius: 8px; font-size: 12px; cursor: pointer; display: flex; align-items: center; gap: 6px;';
        addBtn.innerHTML = '<i data-lucide="plus" style="width: 14px; height: 14px;"></i> –î–æ–±–∞–≤–∏—Ç—å –ø—É–Ω–∫—Ç';
        checklistDiv.appendChild(addBtn);

        container.appendChild(checklistDiv);
      });

      lucide.createIcons();
    }

    function renderExpenses() {
      const container = document.getElementById('expenses-list');
      container.innerHTML = '';

      expenses.forEach((item, index) => {
        const catInfo = EXPENSE_CATEGORIES[item.category] || { emoji: 'üìå', label: '–î—Ä—É–≥–æ–µ', color: '#64748b' };

        const div = document.createElement('div');
        div.style.cssText = 'margin-bottom: 10px; background: rgba(255,255,255,0.03); padding: 12px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.06);';

        div.innerHTML = `
          <div style="display: flex; align-items: center; gap: 8px;">
            <div style="width: 36px; height: 36px; border-radius: 10px; background: ${catInfo.color}20; border: 1px solid ${catInfo.color}40; display: flex; align-items: center; justify-content: center; font-size: 18px; flex-shrink: 0;">
              ${escapeHtml(catInfo.emoji)}
            </div>
            <select onchange="updateExpenseCategory(${index}, this.value)" style="flex: 1; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; padding: 8px 10px; color: #e2e8f0; font-size: 14px; min-width: 0;">
              ${getExpenseCategoryOptions(item.category)}
            </select>
            <input type="number" value="${escapeHtml(String(item.amount))}" oninput="updateExpenseAmount(${index}, this.value)" placeholder="0" min="0" inputmode="decimal" style="width: 80px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; padding: 8px 10px; color: #e2e8f0; font-size: 14px; text-align: right; flex-shrink: 0;">
            <span style="color: rgba(148,163,184,0.6); font-size: 13px; flex-shrink: 0;">‚ÇΩ</span>
            <button type="button" onclick="removeExpense(${index})" style="width: 32px; height: 32px; border-radius: 8px; background: rgba(239,68,68,0.1); border: 1px solid rgba(239,68,68,0.2); color: #ef4444; display: flex; align-items: center; justify-content: center; cursor: pointer; flex-shrink: 0;">
              <i data-lucide="x" style="width: 14px; height: 14px;"></i>
            </button>
          </div>
          <input type="text" value="${escapeHtml(item.note)}" oninput="updateExpenseNote(${index}, this.value)" placeholder="–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)" style="width: 100%; margin-top: 8px; background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.08); border-radius: 8px; padding: 8px 12px; color: rgba(226,232,240,0.8); font-size: 13px;">
        `;

        container.appendChild(div);
      });

      lucide.createIcons();
    }

    function getExpenseCategoryOptions(selected) {
      return Object.keys(EXPENSE_CATEGORIES).map(key => {
        const cat = EXPENSE_CATEGORIES[key];
        return `<option value="${escapeHtml(key)}" ${key === selected ? 'selected' : ''}>${escapeHtml(cat.emoji)} ${escapeHtml(cat.label)}</option>`;
      }).join('');
    }

    function addExpenseRow() {
      expenses.push({ amount: 0, category: '', note: '' });
      renderExpenses();
      calculateBalance();
    }

    function removeExpense(index) {
      expenses.splice(index, 1);
      renderExpenses();
      calculateBalance();
    }

    function updateExpenseAmount(index, value) {
      expenses[index].amount = parseFloat(value) || 0;
      calculateBalance();
    }

    function updateExpenseCategory(index, value) {
      expenses[index].category = value;
      renderExpenses();
    }

    function updateExpenseNote(index, value) {
      expenses[index].note = value;
    }

    function addChecklistItem(scheduleIndex) {
      if (!schedule[scheduleIndex].checklist) schedule[scheduleIndex].checklist = [];
      schedule[scheduleIndex].checklist.push({ text: '', done: false });
      renderSchedule();
    }

    function removeChecklistItem(scheduleIndex, checkIndex) {
      schedule[scheduleIndex].checklist.splice(checkIndex, 1);
      renderSchedule();
    }

    function updateChecklistItem(scheduleIndex, checkIndex, text) {
      schedule[scheduleIndex].checklist[checkIndex].text = text;
    }

    function toggleChecklistItem(scheduleIndex, checkIndex) {
      schedule[scheduleIndex].checklist[checkIndex].done = !schedule[scheduleIndex].checklist[checkIndex].done;
    }

    // ==========================================
    // EVENT SAVE/DELETE
    // ==========================================
    function calculateBalance() {
      const income = parseFloat(document.getElementById('event-income').value) || 0;
      const prepay = parseFloat(document.getElementById('event-prepay').value) || 0;
      const tax = parseFloat(document.getElementById('event-tax').value) || 0;

      const totalExpenses = expenses.reduce((sum, e) => sum + (e.amount || 0), 0);
      const taxAmount = Math.round((income * tax) / 100);
      const profit = income - totalExpenses - taxAmount;
      const toReceive = income - prepay;

      document.getElementById('balance-to-receive').textContent = `${toReceive.toLocaleString('ru-RU')} ‚ÇΩ`;
      document.getElementById('balance-expenses').textContent = `${totalExpenses.toLocaleString('ru-RU')} ‚ÇΩ`;
      document.getElementById('balance-tax').textContent = `${taxAmount.toLocaleString('ru-RU')} ‚ÇΩ`;

      const profitEl = document.getElementById('balance-display');
      profitEl.textContent = `${profit.toLocaleString('ru-RU')} ‚ÇΩ`;
      profitEl.style.color = profit >= 0 ? '#22c55e' : '#ef4444';
    }

    function saveEvent() {
      const title = document.getElementById('event-title').value.trim();
      const date = document.getElementById('event-date').value;

      if (!title) {
        showToast('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏—è');
        return;
      }

      if (!date) {
        showToast('–í—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É');
        return;
      }

      const phone = document.getElementById('event-phone').value.trim();
      if (phone && !/^[\d\s\+\-\(\)]+$/.test(phone)) {
        showToast('–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç —Ç–µ–ª–µ—Ñ–æ–Ω–∞');
        return;
      }

      const income = parseFloat(document.getElementById('event-income').value) || 0;
      const prepay = parseFloat(document.getElementById('event-prepay').value) || 0;
      const tax = parseFloat(document.getElementById('event-tax').value) || 0;

      if (income < 0 || prepay < 0 || tax < 0) {
        showToast('–°—É–º–º—ã –Ω–µ –º–æ–≥—É—Ç –±—ã—Ç—å –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–º–∏');
        return;
      }

      if (prepay > income) {
        showToast('–ü—Ä–µ–¥–æ–ø–ª–∞—Ç–∞ –Ω–µ –º–æ–∂–µ—Ç –ø—Ä–µ–≤—ã—à–∞—Ç—å –¥–æ—Ö–æ–¥');
        return;
      }

      if (tax > 100) {
        showToast('–ù–∞–ª–æ–≥ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –±–æ–ª—å—à–µ 100%');
        return;
      }

      const sortedSchedule = schedule.length > 0 ? [...schedule].sort((a, b) => {
        return (a.time || '').localeCompare(b.time || '');
      }) : [];
      const mainTime = sortedSchedule.length > 0 ? sortedSchedule[0].time : '';
      const mainType = sortedSchedule.length > 0 ? sortedSchedule[0].type : 'rabbit';

      const eventData = {
        type: mainType,
        title: title,
        date: date,
        time: mainTime,
        status: document.getElementById('event-status').value || 'pending',
        schedule: schedule.map(item => ({
          type: item.type,
          time: item.time,
          duration: parseInt(item.duration) || 60,
          checklist: item.checklist || []
        })),
        location: document.getElementById('event-location').value.trim(),
        address: document.getElementById('event-address').value.trim(),
        client: document.getElementById('event-client').value.trim(),
        phone: phone,
        guests: parseInt(document.getElementById('event-guests').value) || 0,
        income: income,
        prepay: prepay,
        expenses: expenses.filter(e => e.amount > 0).map(e => ({ amount: e.amount, category: e.category, note: e.note })),
        tax: tax,
        notes: document.getElementById('event-notes').value.trim()
      };

      if (editingEventId) {
        const index = events.findIndex(e => e.id === editingEventId);
        if (index !== -1) {
          events[index] = { ...events[index], ...eventData };
          showToast('–°–æ–±—ã—Ç–∏–µ –æ–±–Ω–æ–≤–ª–µ–Ω–æ!');
        }
      } else {
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏–µ
        const repeatType = document.getElementById('event-repeat-type').value;
        const repeatCount = parseInt(document.getElementById('event-repeat-count').value) || 4;

        if (repeatType !== 'none') {
          // –°–æ–∑–¥–∞—ë–º —Å–µ—Ä–∏—é –ø–æ–≤—Ç–æ—Ä—è—é—â–∏—Ö—Å—è —Å–æ–±—ã—Ç–∏–π
          const seriesId = Date.now();
          const dates = generateRepeatDates(date, repeatType, repeatCount);

          dates.forEach((eventDate, index) => {
            events.push({
              id: seriesId + index,
              seriesId: seriesId,
              seriesIndex: index + 1,
              seriesTotal: dates.length,
              ...eventData,
              date: eventDate
            });
          });

          showToast(`–°–æ–∑–¥–∞–Ω–æ ${dates.length} —Å–æ–±—ã—Ç–∏–π!`);
        } else {
          // –û–¥–∏–Ω–æ—á–Ω–æ–µ —Å–æ–±—ã—Ç–∏–µ
          events.push({ id: Date.now(), ...eventData });
          showToast('–°–æ–±—ã—Ç–∏–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ!');
        }

        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç—É–ª—Ç–∏–ø –ø—Ä–∏ –ø–µ—Ä–≤–æ–º —Å–æ–∑–¥–∞–Ω–∏–∏
        if (!localStorage.getItem('tooltip_shown')) {
          setTimeout(() => showEventTooltip(), 500);
        }
      }

      saveEvents();
      closeEventModal();
      renderCalendar();

      if (currentView === 'dashboard') {
        renderDashboard();
      }
    }

    function showEventTooltip() {
      const firstEvent = document.querySelector('.day-list-row');
      if (!firstEvent) return;

      const tooltip = document.createElement('div');
      tooltip.id = 'event-tooltip';
      tooltip.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        z-index: 9999;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 20px;
        padding-bottom: max(20px, env(safe-area-inset-bottom));
      `;
      tooltip.innerHTML = `
        <div style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.75);" onclick="hideEventTooltip()"></div>
        <div style="position: relative; background: linear-gradient(135deg, rgba(245,158,11,0.98), rgba(251,146,60,0.98)); padding: 20px 24px; border-radius: 20px; box-shadow: 0 12px 40px rgba(0,0,0,0.5); max-width: 300px; text-align: center; margin: auto;">
          <div style="font-size: 16px; font-weight: 800; color: #000; margin-bottom: 14px;">üí° –ü–æ–¥—Å–∫–∞–∑–∫–∞</div>
          <div style="font-size: 14px; color: rgba(0,0,0,0.85); line-height: 1.6;">
            <b>–¢–∞–ø –Ω–∞ –∫–∞—Ä—Ç–æ—á–∫—É</b> ‚Üí –Ω–∞–≤–∏–≥–∞—Ç–æ—Ä<br>
            <b>–¢–∞–ø –Ω–∞ –∏–∫–æ–Ω–∫—É</b> ‚Üí –ø—Ä–æ—Å–º–æ—Ç—Ä<br>
            <b>–°–≤–∞–π–ø ‚Üê</b> —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å/—É–¥–∞–ª–∏—Ç—å<br>
            <b>–°–≤–∞–π–ø ‚Üí</b> –ø–æ–∑–≤–æ–Ω–∏—Ç—å
          </div>
          <button onclick="hideEventTooltip()" style="margin-top: 16px; padding: 12px 28px; background: #000; color: #f59e0b; border: none; border-radius: 12px; font-size: 14px; font-weight: 700; cursor: pointer;">–ü–æ–Ω—è—Ç–Ω–æ!</button>
        </div>
      `;
      document.body.appendChild(tooltip);
    }

    function hideEventTooltip() {
      const tooltip = document.getElementById('event-tooltip');
      if (tooltip) tooltip.remove();
      localStorage.setItem('tooltip_shown', 'true');
    }

    function copyEvent() {
      if (!editingEventId) return;

      const original = events.find(e => e.id === editingEventId);
      if (!original) return;

      // –ö–æ–ø–∏—Ä—É–µ–º –≤—Å–µ –¥–∞–Ω–Ω—ã–µ –∫—Ä–æ–º–µ id –∏ –¥–∞—Ç—ã
      const copy = {
        id: Date.now(),
        type: original.type,
        title: original.title + ' (–∫–æ–ø–∏—è)',
        date: formatDate(selectedDate), // –ò—Å–ø–æ–ª—å–∑—É–µ–º –≤—ã–±—Ä–∞–Ω–Ω—É—é –¥–∞—Ç—É
        time: original.time,
        status: 'pending', // –ù–æ–≤–æ–µ —Å–æ–±—ã—Ç–∏–µ –≤—Å–µ–≥–¥–∞ "–æ–∂–∏–¥–∞–Ω–∏–µ"
        schedule: original.schedule ? JSON.parse(JSON.stringify(original.schedule)) : [],
        location: original.location,
        address: original.address,
        client: original.client,
        phone: original.phone,
        guests: original.guests,
        income: original.income,
        prepay: 0, // –ü—Ä–µ–¥–æ–ø–ª–∞—Ç–∞ —Å–±—Ä–∞—Å—ã–≤–∞–µ—Ç—Å—è
        expenses: original.expenses ? JSON.parse(JSON.stringify(original.expenses)) : [],
        tax: original.tax,
        notes: original.notes
      };

      events.push(copy);
      saveEvents();
      closeEventModal();
      renderCalendar();

      if (currentView === 'dashboard') {
        renderDashboard();
      }

      showToast('–°–æ–±—ã—Ç–∏–µ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!');

      // –û—Ç–∫—Ä—ã–≤–∞–µ–º –∫–æ–ø–∏—é –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
      setTimeout(() => editEvent(copy.id), 300);
    }

    function deleteEvent() {
      if (!editingEventId) return;

      const event = events.find(e => e.id === editingEventId);
      if (!event) return;

      // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —ç—Ç–æ —á–∞—Å—Ç—å—é —Å–µ—Ä–∏–∏
      if (event.seriesId) {
        const seriesEvents = events.filter(e => e.seriesId === event.seriesId);
        showSeriesDeleteModal(event, seriesEvents.length);
      } else {
        customConfirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ —Å–æ–±—ã—Ç–∏–µ?', () => {
          const eventIdToDelete = editingEventId;
          events = events.filter(e => e.id !== editingEventId);
          saveEvents();
          deleteEventFromFirebase(eventIdToDelete); // –£–¥–∞–ª—è–µ–º –∏–∑ Firebase
          closeEventModal();
          renderCalendar();
          renderDayList();

          if (currentView === 'dashboard') {
            renderDashboard();
          }

          showToast('–°–æ–±—ã—Ç–∏–µ —É–¥–∞–ª–µ–Ω–æ');
        });
      }
    }

    function showSeriesDeleteModal(event, seriesCount) {
      const modal = document.createElement('div');
      modal.id = 'series-delete-modal';
      modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); z-index: 10000; display: flex; align-items: center; justify-content: center; padding: 20px;';
      modal.innerHTML = `
        <div style="width: 100%; max-width: 340px; background: rgba(15,15,20,0.98); backdrop-filter: blur(40px); border: 1.5px solid rgba(239,68,68,0.3); border-radius: 24px; padding: 24px;">
          <div style="text-align: center; margin-bottom: 16px;">
            <div style="width: 56px; height: 56px; margin: 0 auto 16px; background: rgba(239,68,68,0.15); border: 1.5px solid rgba(239,68,68,0.3); border-radius: 16px; display: flex; align-items: center; justify-content: center;">
              <i data-lucide="repeat" style="width: 28px; height: 28px; color: #ef4444;"></i>
            </div>
            <h2 style="font-size: 18px; font-weight: 800; color: #fff; margin: 0;">–£–¥–∞–ª–µ–Ω–∏–µ —Å–µ—Ä–∏–∏</h2>
          </div>
          <p style="color: rgba(255,255,255,0.7); font-size: 14px; line-height: 1.6; text-align: center; margin: 0 0 20px;">
            –≠—Ç–æ —Å–æ–±—ã—Ç–∏–µ –∏–∑ —Å–µ—Ä–∏–∏ (${seriesCount} —Å–æ–±—ã—Ç–∏–π).<br>–ß—Ç–æ –≤—ã —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å?
          </p>
          <div style="display: flex; flex-direction: column; gap: 10px;">
            <button id="delete-single" style="width: 100%; height: 48px; border-radius: 14px; font-size: 14px; font-weight: 700; background: rgba(239,68,68,0.2); border: 1.5px solid rgba(239,68,68,0.4); color: #ef4444; cursor: pointer;">–¢–æ–ª—å–∫–æ —ç—Ç–æ —Å–æ–±—ã—Ç–∏–µ</button>
            <button id="delete-series" style="width: 100%; height: 48px; border-radius: 14px; font-size: 14px; font-weight: 700; background: rgba(239,68,68,0.4); border: 1.5px solid rgba(239,68,68,0.6); color: #fff; cursor: pointer;">–í—Å—é —Å–µ—Ä–∏—é (${seriesCount})</button>
            <button id="delete-cancel" style="width: 100%; height: 48px; border-radius: 14px; font-size: 14px; font-weight: 700; background: rgba(255,255,255,0.08); border: 1.5px solid rgba(255,255,255,0.15); color: #fff; cursor: pointer;">–û—Ç–º–µ–Ω–∞</button>
          </div>
        </div>
      `;
      document.body.appendChild(modal);
      lucide.createIcons();

      const closeModal = () => modal.remove();

      modal.querySelector('#delete-single').onclick = () => {
        const eventIdToDelete = event.id;
        events = events.filter(e => e.id !== event.id);
        saveEvents();
        deleteEventFromFirebase(eventIdToDelete); // –£–¥–∞–ª—è–µ–º –∏–∑ Firebase
        closeEventModal();
        renderCalendar();
        renderDayList();
        if (currentView === 'dashboard') renderDashboard();
        showToast('–°–æ–±—ã—Ç–∏–µ —É–¥–∞–ª–µ–Ω–æ');
        closeModal();
      };

      modal.querySelector('#delete-series').onclick = () => {
        // –°–æ–±–∏—Ä–∞–µ–º ID –≤—Å–µ—Ö —Å–æ–±—ã—Ç–∏–π —Å–µ—Ä–∏–∏ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è –∏–∑ Firebase
        const seriesEventIds = events.filter(e => e.seriesId === event.seriesId).map(e => e.id);
        events = events.filter(e => e.seriesId !== event.seriesId);
        saveEvents();
        deleteMultipleEventsFromFirebase(seriesEventIds); // –£–¥–∞–ª—è–µ–º –≤—Å—é —Å–µ—Ä–∏—é –∏–∑ Firebase
        closeEventModal();
        renderCalendar();
        renderDayList();
        if (currentView === 'dashboard') renderDashboard();
        showToast(`–£–¥–∞–ª–µ–Ω–æ ${seriesCount} —Å–æ–±—ã—Ç–∏–π`);
        closeModal();
      };

      modal.querySelector('#delete-cancel').onclick = closeModal;
      modal.onclick = (e) => { if (e.target === modal) closeModal(); };
    }

    // ==========================================
    // SPLASH SCREEN
    // ==========================================
    function showSplashScreen() {
      const splash = document.getElementById('splash-screen');

      // Hide splash after 2 seconds
      setTimeout(() => {
        splash.classList.add('hide');

        // Remove from DOM after fade out
        setTimeout(() => {
          splash.remove();
        }, 600);
      }, 2000);
    }

    function showToast(message) {
      const toast = document.getElementById('toast');
      const msg = document.getElementById('toast-msg');

      msg.textContent = message;
      toast.classList.add('show');

      clearTimeout(window.toastTimer);
      window.toastTimer = setTimeout(() => {
        toast.classList.remove('show');
      }, 2500);
    }

    // ==========================================
    // NAVIGATION
    // ==========================================
    async function openNavigation(address, event) {
      if (event) {
        event.stopPropagation();
        event.preventDefault();
      }

      if (!address || address.trim() === '') {
        showToast('–ê–¥—Ä–µ—Å –Ω–µ —É–∫–∞–∑–∞–Ω');
        return;
      }

      const cleanAddress = address.trim();
      const encodedAddress = encodeURIComponent(cleanAddress);

      // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–∞
      if (!navigator.onLine) {
        // Fallback: –æ—Ç–∫—Ä—ã–≤–∞–µ–º –Ø–Ω–¥–µ–∫—Å.–ö–∞—Ä—Ç—ã —Å –ø–æ–∏—Å–∫–æ–º –ø–æ –∞–¥—Ä–µ—Å—É
        const yandexMapsUrl = `yandexmaps://maps.yandex.ru/?text=${encodedAddress}`;
        window.location.href = yandexMapsUrl;
        showToast('–û—Ñ–ª–∞–π–Ω: –æ—Ç–∫—Ä—ã–≤–∞–µ–º –∫–∞—Ä—Ç—ã —Å –ø–æ–∏—Å–∫–æ–º');
        return;
      }

      showToast('‚è≥ –ü–æ–∏—Å–∫ –∞–¥—Ä–µ—Å–∞...');

      try {
        // –ì–µ–æ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏–µ —á–µ—Ä–µ–∑ Nominatim (–±–µ—Å–ø–ª–∞—Ç–Ω–æ, –±–µ–∑ –∫–ª—é—á–∞)
        const geocodeUrl = `https://nominatim.openstreetmap.org/search?format=json&q=${encodedAddress}&limit=1&accept-language=ru`;

        const response = await fetch(geocodeUrl, {
          headers: {
            'User-Agent': 'CalendarApp/1.0'
          }
        });

        if (!response.ok) {
          throw new Error('Network error');
        }

        const data = await response.json();

        if (data && data.length > 0) {
          const lat = data[0].lat;
          const lon = data[0].lon;

          // –û—Ç–∫—Ä—ã–≤–∞–µ–º –Ø–Ω–¥–µ–∫—Å.–ù–∞–≤–∏–≥–∞—Ç–æ—Ä —Å –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞–º–∏
          const yandexNaviUrl = `yandexnavi://build_route_on_map?lat_to=${lat}&lon_to=${lon}`;
          window.location.href = yandexNaviUrl;

        } else {
          throw new Error('–ê–¥—Ä–µ—Å –Ω–µ –Ω–∞–π–¥–µ–Ω');
        }

      } catch (error) {
        // Fallback: –æ—Ç–∫—Ä—ã–≤–∞–µ–º –Ø–Ω–¥–µ–∫—Å.–ö–∞—Ä—Ç—ã —Å –ø–æ–∏—Å–∫–æ–º
        const yandexMapsUrl = `yandexmaps://maps.yandex.ru/?text=${encodedAddress}`;
        window.location.href = yandexMapsUrl;
        showToast('–û—Ç–∫—Ä—ã–≤–∞–µ–º –∫–∞—Ä—Ç—ã');
      }
    }

    // ==========================================
    // SWIPE TO CALL
    // ==========================================
    function addSwipeToCall(element, event) {
      let startX = 0;
      let startY = 0;
      let currentX = 0;
      let isSwiping = false;
      let swipeDirection = null;
      let callIcon = null;
      let previewIcon = null;
      let deleteIcon = null;
      const SWIPE_THRESHOLD = 5; // –£–º–µ–Ω—å—à–µ–Ω –ø–æ—Ä–æ–≥ –¥–ª—è –±–æ–ª–µ–µ –±—ã—Å—Ç—Ä–æ–π —Ä–µ–∞–∫—Ü–∏–∏

      element.style.position = 'relative';
      element.style.overflow = 'hidden';
      element.style.transition = 'transform 0.25s cubic-bezier(0.4, 0, 0.2, 1)';

      const handleTouchStart = (e) => {
        // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –µ—Å–ª–∏ —Ç–∞–ø –Ω–∞ –∏–∫–æ–Ω–∫—É —Ç–∏–ø–∞
        if (e.target.closest('.event-type-icon')) return;

        startX = e.touches[0].clientX;
        startY = e.touches[0].clientY;
        currentX = startX;
        isSwiping = false;
        swipeDirection = null;
        element.style.transition = 'none';
      };

      const handleTouchMove = (e) => {
        if (startX === 0) return;

        currentX = e.touches[0].clientX;
        const currentY = e.touches[0].clientY;
        const diffX = currentX - startX;
        const diffY = currentY - startY;

        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–≤–∞–π–ø–∞ —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —Ä–∞–∑
        if (!isSwiping && Math.abs(diffX) > SWIPE_THRESHOLD) {
          // –ï—Å–ª–∏ –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ã–π —Å–≤–∞–π–ø –±–æ–ª—å—à–µ —á–µ–º –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—ã–π –≤ 1.5 —Ä–∞–∑–∞ - –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º
          if (Math.abs(diffY) > Math.abs(diffX) * 1.5) {
            startX = 0;
            return;
          }
          isSwiping = true;
          swipeDirection = diffX > 0 ? 'right' : 'left';
        }

        if (!isSwiping) return;

        // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º —Å–∫—Ä–æ–ª–ª –ø—Ä–∏ —Å–≤–∞–π–ø–µ
        if (Math.abs(diffX) > Math.abs(diffY)) {
          e.preventDefault();
        }

        const diff = currentX - startX;

        // –°–≤–∞–π–ø –≤–ø—Ä–∞–≤–æ - –∑–≤–æ–Ω–æ–∫
        if (swipeDirection === 'right' && event.phone && event.phone.trim() !== '') {
          element.style.transform = `translateX(${Math.min(diff, 110)}px)`;

          if (!callIcon) {
            callIcon = document.createElement('div');
            callIcon.style.cssText = `
              position: absolute;
              left: 8px;
              top: 50%;
              transform: translateY(-50%);
              width: 60px;
              height: 60px;
              background: linear-gradient(135deg, #22c55e, #16a34a);
              border-radius: 16px;
              display: flex;
              align-items: center;
              justify-content: center;
              opacity: 0;
              transition: opacity 0.2s ease-out;
              z-index: 0;
              pointer-events: none;
              box-shadow: 0 8px 24px rgba(34, 197, 94, 0.6);
            `;
            callIcon.innerHTML = '<i data-lucide="phone" style="width: 28px; height: 28px; color: white;"></i>';
            element.insertBefore(callIcon, element.firstChild);
            refreshIcons();
          }
          if (callIcon) callIcon.style.opacity = Math.min(diff / 50, 1);
        }

        // –°–≤–∞–π–ø –≤–ø—Ä–∞–≤–æ –±–µ–∑ —Ç–µ–ª–µ—Ñ–æ–Ω–∞ - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç
        if (swipeDirection === 'right' && (!event.phone || event.phone.trim() === '')) {
          element.style.transform = `translateX(${Math.min(diff * 0.3, 30)}px)`;
        }

        // –°–≤–∞–π–ø –≤–ª–µ–≤–æ - —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ (–∫–æ—Ä–æ—Ç–∫–∏–π) –∏–ª–∏ —É–¥–∞–ª–µ–Ω–∏–µ (–¥–ª–∏–Ω–Ω—ã–π)
        if (swipeDirection === 'left') {
          element.style.transform = `translateX(${Math.max(diff, -160)}px)`;

          // –ò–∫–æ–Ω–∫–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
          if (!previewIcon) {
            previewIcon = document.createElement('div');
            previewIcon.style.cssText = `
              position: absolute;
              right: 8px;
              top: 50%;
              transform: translateY(-50%);
              width: 56px;
              height: 56px;
              background: linear-gradient(135deg, #f59e0b, #d97706);
              border-radius: 16px;
              display: flex;
              align-items: center;
              justify-content: center;
              opacity: 0;
              transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
              z-index: 0;
              pointer-events: none;
              box-shadow: 0 6px 20px rgba(245, 158, 11, 0.5);
            `;
            previewIcon.innerHTML = '<i data-lucide="edit-3" style="width: 26px; height: 26px; color: white;"></i>';
            element.insertBefore(previewIcon, element.firstChild);
            refreshIcons();
          }

          // –ò–∫–æ–Ω–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è (–ø–æ—è–≤–ª—è–µ—Ç—Å—è –ø—Ä–∏ –¥–ª–∏–Ω–Ω–æ–º —Å–≤–∞–π–ø–µ)
          if (!deleteIcon) {
            deleteIcon = document.createElement('div');
            deleteIcon.style.cssText = `
              position: absolute;
              right: 72px;
              top: 50%;
              transform: translateY(-50%);
              width: 56px;
              height: 56px;
              background: linear-gradient(135deg, #ef4444, #dc2626);
              border-radius: 16px;
              display: flex;
              align-items: center;
              justify-content: center;
              opacity: 0;
              transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
              z-index: 0;
              pointer-events: none;
              box-shadow: 0 6px 20px rgba(239, 68, 68, 0.5);
            `;
            deleteIcon.innerHTML = '<i data-lucide="trash-2" style="width: 26px; height: 26px; color: white;"></i>';
            element.insertBefore(deleteIcon, element.firstChild);
            refreshIcons();
          }

          const absDiff = Math.abs(diff);
          if (previewIcon) previewIcon.style.opacity = Math.min(absDiff / 60, 1);
          if (deleteIcon) deleteIcon.style.opacity = absDiff > 100 ? Math.min((absDiff - 100) / 40, 1) : 0;
        }
      };

      const handleTouchEnd = () => {
        if (!isSwiping) {
          startX = 0;
          return;
        }

        const diff = currentX - startX;
        element.style.transition = 'transform 0.25s cubic-bezier(0.4, 0, 0.2, 1)';

        // –£–º–µ–Ω—å—à–µ–Ω –ø–æ—Ä–æ–≥ –¥–ª—è —Å–≤–∞–π–ø–∞ –≤–ø—Ä–∞–≤–æ (–∑–≤–æ–Ω–æ–∫)
        if (diff > 60 && event.phone && swipeDirection === 'right') {
          makeCall(event.phone);
        } else if (diff < -130 && swipeDirection === 'left') {
          // –î–ª–∏–Ω–Ω—ã–π —Å–≤–∞–π–ø –≤–ª–µ–≤–æ - —É–¥–∞–ª–µ–Ω–∏–µ
          customConfirm(`–£–¥–∞–ª–∏—Ç—å "${event.title}"?`, () => {
            const eventIdToDelete = event.id;
            events = events.filter(e => e.id !== event.id);
            saveEvents();
            deleteEventFromFirebase(eventIdToDelete); // –£–¥–∞–ª—è–µ–º –∏–∑ Firebase
            renderCalendar();
            showToast('–°–æ–±—ã—Ç–∏–µ —É–¥–∞–ª–µ–Ω–æ');
          });
        } else if (diff < -70 && swipeDirection === 'left') {
          // –ö–æ—Ä–æ—Ç–∫–∏–π —Å–≤–∞–π–ø –≤–ª–µ–≤–æ - —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
          editEvent(event.id);
        }

        element.style.transform = 'translateX(0)';

        if (callIcon) {
          callIcon.style.opacity = '0';
          setTimeout(() => {
            if (callIcon && callIcon.parentElement) callIcon.remove();
            callIcon = null;
          }, 300);
        }

        if (previewIcon) {
          previewIcon.style.opacity = '0';
          setTimeout(() => {
            if (previewIcon && previewIcon.parentElement) previewIcon.remove();
            previewIcon = null;
          }, 300);
        }

        if (deleteIcon) {
          deleteIcon.style.opacity = '0';
          setTimeout(() => {
            if (deleteIcon && deleteIcon.parentElement) deleteIcon.remove();
            deleteIcon = null;
          }, 300);
        }

        isSwiping = false;
        swipeDirection = null;
        startX = 0;
        startY = 0;
        currentX = 0;
      };

      element.addEventListener('touchstart', handleTouchStart);
      element.addEventListener('touchmove', handleTouchMove);
      element.addEventListener('touchend', handleTouchEnd);
      element.addEventListener('touchcancel', handleTouchEnd);
    }

    function makeCall(phoneNumber) {
      if (!phoneNumber || phoneNumber.trim() === '') {
        showToast('–ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –Ω–µ —É–∫–∞–∑–∞–Ω');
        return;
      }

      const cleanPhone = phoneNumber.replace(/[^\d+]/g, '');
      window.location.href = `tel:${cleanPhone}`;
      showToast('–ó–≤–æ–Ω–æ–∫...');
    }

    function showEventPreview(event) {
      const typeInfo = TYPES[event.type] || TYPES.rabbit;
      const statusMap = {
        'confirmed': { text: '–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–æ', color: '#22c55e' },
        'pending': { text: '–û–∂–∏–¥–∞–Ω–∏–µ', color: '#f59e0b' },
        'completed': { text: '–í—ã–ø–æ–ª–Ω–µ–Ω–æ', color: '#3b82f6' },
        'rehearsal': { text: '–†–µ–ø–µ—Ç–∏—Ü–∏—è', color: '#94a3b8' },
        'cancelled': { text: '–û—Ç–º–µ–Ω–µ–Ω–æ', color: '#ef4444' }
      };
      const statusInfo = statusMap[event.status] || statusMap['pending'];
      const statusText = statusInfo.text;
      const statusColor = statusInfo.color;

      let content = `
        <div style="display: flex; flex-direction: column; gap: 16px;">
          <div style="display: flex; align-items: center; gap: 12px; padding: 16px; background: linear-gradient(135deg, ${typeInfo.color}15, ${typeInfo.color}08); border: 1px solid ${typeInfo.color}30; border-radius: 12px;">
            ${typeInfo.image ? `<img src="${typeInfo.image}" style="width: 32px; height: 32px; object-fit: contain;">` : `<img src="icons/events/magician.png" style="width: 28px; height: 28px; object-fit: contain;">`}
            <div>
              <div style="font-size: 18px; font-weight: 700; color: #fff;">${escapeHtml(event.title)}</div>
              <div style="font-size: 13px; color: rgba(148,163,184,0.8);">${escapeHtml(typeInfo.label)}</div>
            </div>
          </div>

          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
            <div style="padding: 12px; background: rgba(0,0,0,0.3); border: 1px solid rgba(245,158,11,0.1); border-radius: 10px;">
              <div style="font-size: 11px; color: rgba(148,163,184,0.7); margin-bottom: 4px;">–î–∞—Ç–∞</div>
              <div style="font-size: 14px; font-weight: 600; color: #fff;">${parseEventDate(event.date).toLocaleDateString('ru-RU')}</div>
            </div>
            <div style="padding: 12px; background: rgba(0,0,0,0.3); border: 1px solid rgba(245,158,11,0.1); border-radius: 10px;">
              <div style="font-size: 11px; color: rgba(148,163,184,0.7); margin-bottom: 4px;">–í—Ä–µ–º—è</div>
              <div style="font-size: 14px; font-weight: 600; color: #fff;">${escapeHtml(event.time) || '‚Äî'}</div>
            </div>
          </div>

          ${event.location ? `
          <div style="padding: 12px; background: rgba(0,0,0,0.3); border: 1px solid rgba(245,158,11,0.1); border-radius: 10px;">
            <div style="font-size: 11px; color: rgba(148,163,184,0.7); margin-bottom: 4px;">üìç –õ–æ–∫–∞—Ü–∏—è</div>
            <div style="font-size: 14px; color: #fff;">${escapeHtml(event.location)}</div>
          </div>
          ` : ''}

          ${event.address ? `
          <div style="padding: 12px; background: rgba(0,0,0,0.3); border: 1px solid rgba(245,158,11,0.1); border-radius: 10px;">
            <div style="font-size: 11px; color: rgba(148,163,184,0.7); margin-bottom: 4px;">üó∫Ô∏è –ê–¥—Ä–µ—Å</div>
            <div style="font-size: 14px; color: #fff;">${escapeHtml(event.address)}</div>
          </div>
          ` : ''}

          ${event.client ? `
          <div style="padding: 12px; background: rgba(0,0,0,0.3); border: 1px solid rgba(245,158,11,0.1); border-radius: 10px;">
            <div style="font-size: 11px; color: rgba(148,163,184,0.7); margin-bottom: 4px;">üë§ –ö–ª–∏–µ–Ω—Ç</div>
            <div style="font-size: 14px; color: #fff;">${escapeHtml(event.client)}</div>
            ${event.phone ? `
            <a href="tel:${escapeHtml(event.phone)}" style="display: inline-flex; align-items: center; gap: 6px; margin-top: 8px; padding: 8px 14px; background: linear-gradient(135deg, rgba(34,197,94,0.2), rgba(34,197,94,0.1)); border: 1px solid rgba(34,197,94,0.3); border-radius: 10px; font-size: 14px; font-weight: 600; color: #22c55e; text-decoration: none; transition: all 0.2s;">
              <i data-lucide="phone" style="width: 16px; height: 16px;"></i>
              ${escapeHtml(event.phone)}
            </a>
            ` : ''}
          </div>
          ` : ''}

          <div style="padding: 12px; background: rgba(0,0,0,0.3); border: 1px solid rgba(245,158,11,0.1); border-radius: 10px;">
            <div style="font-size: 11px; color: rgba(148,163,184,0.7); margin-bottom: 4px;">–°—Ç–∞—Ç—É—Å</div>
            <div style="display: inline-block; padding: 6px 12px; background: ${statusColor}20; border: 1px solid ${statusColor}40; border-radius: 8px; font-size: 13px; font-weight: 600; color: ${statusColor};">${statusText}</div>
          </div>

          ${event.income || (event.expenses && event.expenses.length > 0) ? `
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
            ${event.income ? `
            <div style="padding: 12px; background: rgba(34,197,94,0.1); border: 1px solid rgba(34,197,94,0.2); border-radius: 10px;">
              <div style="font-size: 11px; color: rgba(34,197,94,0.8); margin-bottom: 4px;">üí∞ –î–æ—Ö–æ–¥</div>
              <div style="font-size: 16px; font-weight: 700; color: #22c55e;">${event.income.toLocaleString('ru-RU')} ‚ÇΩ</div>
            </div>
            ` : ''}
            ${event.expenses && event.expenses.length > 0 ? `
            <div style="padding: 12px; background: rgba(239,68,68,0.1); border: 1px solid rgba(239,68,68,0.2); border-radius: 10px;">
              <div style="font-size: 11px; color: rgba(239,68,68,0.8); margin-bottom: 4px;">üí∏ –†–∞—Å—Ö–æ–¥—ã</div>
              <div style="font-size: 16px; font-weight: 700; color: #ef4444;">${event.expenses.reduce((sum, e) => sum + (e.amount || 0), 0).toLocaleString('ru-RU')} ‚ÇΩ</div>
            </div>
            ` : ''}
          </div>
          ` : ''}

          ${event.notes ? `
          <div style="padding: 12px; background: rgba(0,0,0,0.3); border: 1px solid rgba(245,158,11,0.1); border-radius: 10px;">
            <div style="font-size: 11px; color: rgba(148,163,184,0.7); margin-bottom: 6px;">üìù –ó–∞–º–µ—Ç–∫–∏</div>
            <div style="font-size: 13px; color: rgba(255,255,255,0.9); line-height: 1.5;">${escapeHtml(event.notes)}</div>
          </div>
          ` : ''}
        </div>
      `;

      document.getElementById('preview-content').innerHTML = content;
      document.getElementById('preview-modal').classList.add('show');
      lucide.createIcons();
    }

    function closePreview() {
      document.getElementById('preview-modal').classList.remove('show');
    }

    // ==========================================
    // MONTH SUMMARY
    // ==========================================
    function showMonthSummary(year, month) {
      const monthEvents = events.filter(e => {
        const eventDate = parseEventDate(e.date);
        return eventDate.getFullYear() === year && eventDate.getMonth() === month;
      });

      const totalIncome = monthEvents.reduce((sum, e) => sum + (e.income || 0), 0);
      const totalExpense = monthEvents.reduce((sum, e) => {
        const expensesSum = e.expenses ? e.expenses.reduce((s, exp) => s + (exp.amount || 0), 0) : 0;
        return sum + expensesSum;
      }, 0);
      const totalPrepay = monthEvents.reduce((sum, e) => sum + (e.prepay || 0), 0);
      // –†–µ–ø–µ—Ç–∏—Ü–∏–∏ –Ω–µ —Å—á–∏—Ç–∞—é—Ç—Å—è –∑–∞ —à–æ—É
      const totalShows = monthEvents.filter(e => e.status !== 'rehearsal').reduce((sum, e) => sum + (e.schedule?.length || 1), 0);
      const totalTax = monthEvents.reduce((sum, e) => {
        const taxAmount = ((e.income || 0) * (e.tax || 0)) / 100;
        return sum + taxAmount;
      }, 0);
      const profit = totalIncome - totalExpense;
      const netProfit = totalIncome - totalExpense - totalTax;
      const avgCheck = monthEvents.length > 0 ? Math.round(totalIncome / monthEvents.length) : 0;

      // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ —Ç–∏–ø–∞–º
      const typeStats = {};
      monthEvents.forEach(event => {
        let mainType = 'rabbit';
        if (event.schedule && event.schedule.length > 0) {
          mainType = event.schedule[0].type || 'rabbit';
        } else {
          mainType = event.type || 'rabbit';
        }
        if (!typeStats[mainType]) {
          typeStats[mainType] = { count: 0, income: 0 };
        }
        typeStats[mainType].count++;
        typeStats[mainType].income += event.income || 0;
      });

      const typeStatsHTML = Object.entries(typeStats)
        .sort((a, b) => b[1].income - a[1].income)
        .map(([type, stats]) => {
          const typeInfo = TYPES[type] || TYPES.rabbit;
          return `
            <div style="display: flex; align-items: center; gap: 12px; padding: 12px; background: rgba(0,0,0,0.3); border: 1px solid ${typeInfo.color}30; border-radius: 10px;">
              <div style="width: 36px; height: 36px; border-radius: 10px; background: ${typeInfo.color}20; border: 1px solid ${typeInfo.color}40; display: flex; align-items: center; justify-content: center;">
                ${typeInfo.image ? `<img src="${typeInfo.image}" style="width: 22px; height: 22px; object-fit: contain;">` : `<img src="icons/events/magician.png" style="width: 22px; height: 22px; object-fit: contain;">`}
              </div>
              <div style="flex: 1;">
                <div style="font-size: 13px; color: #fff; font-weight: 600;">${escapeHtml(typeInfo.label)}</div>
                <div style="font-size: 11px; color: rgba(148,163,184,0.7);">${stats.count} —Å–æ–±—ã—Ç–∏–π</div>
              </div>
              <div style="font-size: 15px; font-weight: 700; color: ${typeInfo.color};">${stats.income.toLocaleString('ru-RU')} ‚ÇΩ</div>
            </div>
          `;
        }).join('');

      const content = `
        <div style="display: flex; flex-direction: column; gap: 16px;">
          <div style="text-align: center; padding: 20px; background: linear-gradient(135deg, rgba(245,158,11,0.2), rgba(245,158,11,0.1)); border: 1px solid rgba(245,158,11,0.3); border-radius: 16px;">
            <div style="font-size: 14px; color: rgba(245,158,11,0.9); margin-bottom: 8px;">–ò—Ç–æ–≥–æ –∑–∞ ${MONTH_NAMES[month]} ${year}</div>
            <div style="font-size: 32px; font-weight: 900; color: ${netProfit >= 0 ? '#22c55e' : '#ef4444'};">${netProfit.toLocaleString('ru-RU')} ‚ÇΩ</div>
            <div style="font-size: 12px; color: rgba(148,163,184,0.7); margin-top: 4px;">–ß–∏—Å—Ç–∞—è –ø—Ä–∏–±—ã–ª—å</div>
          </div>

          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
            <div style="padding: 14px; background: rgba(34,197,94,0.1); border: 1px solid rgba(34,197,94,0.2); border-radius: 12px;">
              <div style="font-size: 11px; color: rgba(34,197,94,0.8); margin-bottom: 4px;">üí∞ –î–æ—Ö–æ–¥</div>
              <div style="font-size: 18px; font-weight: 700; color: #22c55e;">${totalIncome.toLocaleString('ru-RU')} ‚ÇΩ</div>
            </div>
            <div style="padding: 14px; background: rgba(239,68,68,0.1); border: 1px solid rgba(239,68,68,0.2); border-radius: 12px;">
              <div style="font-size: 11px; color: rgba(239,68,68,0.8); margin-bottom: 4px;">üí∏ –†–∞—Å—Ö–æ–¥</div>
              <div style="font-size: 18px; font-weight: 700; color: #ef4444;">${totalExpense.toLocaleString('ru-RU')} ‚ÇΩ</div>
            </div>
          </div>

          <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px;">
            <div style="padding: 12px; background: rgba(0,0,0,0.3); border: 1px solid rgba(245,158,11,0.1); border-radius: 10px; text-align: center;">
              <div style="font-size: 11px; color: rgba(148,163,184,0.7); margin-bottom: 4px;">–°–æ–±—ã—Ç–∏—è</div>
              <div style="font-size: 16px; font-weight: 700; color: #fff;">${monthEvents.length}</div>
            </div>
            <div style="padding: 12px; background: rgba(0,0,0,0.3); border: 1px solid rgba(245,158,11,0.1); border-radius: 10px; text-align: center;">
              <div style="font-size: 11px; color: rgba(148,163,184,0.7); margin-bottom: 4px;">–ü–æ–∫–∞–∑—ã</div>
              <div style="font-size: 16px; font-weight: 700; color: #fff;">${totalShows}</div>
            </div>
            <div style="padding: 12px; background: rgba(0,0,0,0.3); border: 1px solid rgba(245,158,11,0.1); border-radius: 10px; text-align: center;">
              <div style="font-size: 11px; color: rgba(148,163,184,0.7); margin-bottom: 4px;">–°—Ä–µ–¥–Ω–∏–π —á–µ–∫</div>
              <div style="font-size: 16px; font-weight: 700; color: #fff;">${avgCheck.toLocaleString('ru-RU')} ‚ÇΩ</div>
            </div>
          </div>

          ${totalTax > 0 ? `
          <div style="padding: 14px; background: rgba(245,158,11,0.1); border: 1px solid rgba(245,158,11,0.2); border-radius: 12px;">
            <div style="font-size: 11px; color: rgba(245,158,11,0.8); margin-bottom: 4px;">üìä –ù–∞–ª–æ–≥–∏</div>
            <div style="font-size: 18px; font-weight: 700; color: #f59e0b;">${totalTax.toLocaleString('ru-RU')} ‚ÇΩ</div>
          </div>
          ` : ''}

          ${(() => {
          const expenseByCategory = {};
          monthEvents.forEach(e => {
            if (e.expenses && e.expenses.length > 0) {
              e.expenses.forEach(exp => {
                if (exp.amount > 0 && exp.category) {
                  if (!expenseByCategory[exp.category]) {
                    expenseByCategory[exp.category] = 0;
                  }
                  expenseByCategory[exp.category] += exp.amount;
                }
              });
            }
          });

          if (Object.keys(expenseByCategory).length > 0) {
            const expenseHTML = Object.entries(expenseByCategory)
              .sort((a, b) => b[1] - a[1])
              .map(([cat, amount]) => {
                const catInfo = EXPENSE_CATEGORIES[cat] || EXPENSE_CATEGORIES.other;
                return `
                    <div style="display: flex; align-items: center; gap: 12px; padding: 10px; background: rgba(239,68,68,0.05); border: 1px solid rgba(239,68,68,0.15); border-radius: 10px;">
                      <div style="width: 32px; height: 32px; border-radius: 8px; background: ${catInfo.color}20; border: 1px solid ${catInfo.color}40; display: flex; align-items: center; justify-content: center; font-size: 18px;">
                        ${escapeHtml(catInfo.emoji)}
                      </div>
                      <div style="flex: 1;">
                        <div style="font-size: 13px; color: #fff; font-weight: 600;">${escapeHtml(catInfo.label)}</div>
                      </div>
                      <div style="font-size: 14px; font-weight: 700; color: #ef4444;">${amount.toLocaleString('ru-RU')} ‚ÇΩ</div>
                    </div>
                  `;
              }).join('');

            return `
                <div style="margin-top: 8px;">
                  <div style="font-size: 13px; color: rgba(239,68,68,0.9); font-weight: 700; margin-bottom: 12px;">üí∏ –†–∞—Å—Ö–æ–¥—ã –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º</div>
                  <div style="display: flex; flex-direction: column; gap: 8px;">
                    ${expenseHTML}
                  </div>
                </div>
              `;
          }
          return '';
        })()}

          <div style="margin-top: 8px;">
            <div style="font-size: 13px; color: rgba(245,158,11,0.9); font-weight: 700; margin-bottom: 12px;">üìä –ü–æ —Ç–∏–ø–∞–º —Å–æ–±—ã—Ç–∏–π</div>
            <div style="display: flex; flex-direction: column; gap: 8px;">
              ${typeStatsHTML}
            </div>
          </div>
        </div>
      `;

      document.getElementById('preview-content').innerHTML = content;
      document.getElementById('preview-modal').classList.add('show');
      lucide.createIcons();
    }

    // ==========================================
    // YEAR SUMMARY
    // ==========================================
    function showYearSummary(year) {
      const yearEvents = events.filter(e => {
        const eventDate = parseEventDate(e.date);
        return eventDate.getFullYear() === year;
      });

      const totalIncome = yearEvents.reduce((sum, e) => sum + (e.income || 0), 0);
      const totalExpense = yearEvents.reduce((sum, e) => {
        const expensesSum = e.expenses ? e.expenses.reduce((s, exp) => s + (exp.amount || 0), 0) : 0;
        return sum + expensesSum;
      }, 0);
      // –†–µ–ø–µ—Ç–∏—Ü–∏–∏ –Ω–µ —Å—á–∏—Ç–∞—é—Ç—Å—è –∑–∞ —à–æ—É
      const totalShows = yearEvents.filter(e => e.status !== 'rehearsal').reduce((sum, e) => sum + (e.schedule?.length || 1), 0);
      const totalTax = yearEvents.reduce((sum, e) => {
        const taxAmount = ((e.income || 0) * (e.tax || 0)) / 100;
        return sum + taxAmount;
      }, 0);
      const profit = totalIncome - totalExpense;
      const netProfit = totalIncome - totalExpense - totalTax;
      const avgCheck = yearEvents.length > 0 ? Math.round(totalIncome / yearEvents.length) : 0;

      // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –º–µ—Å—è—Ü–∞–º
      const monthStats = {};
      for (let m = 0; m < 12; m++) {
        const monthEvents = yearEvents.filter(e => parseEventDate(e.date).getMonth() === m);
        const income = monthEvents.reduce((sum, e) => sum + (e.income || 0), 0);
        if (monthEvents.length > 0 || income > 0) {
          monthStats[m] = { count: monthEvents.length, income };
        }
      }

      const monthStatsHTML = Object.keys(monthStats).length > 0
        ? Object.entries(monthStats)
          .sort((a, b) => b[1].income - a[1].income)
          .map(([m, stats]) => `
              <div style="display: flex; align-items: center; gap: 12px; padding: 12px; background: rgba(0,0,0,0.3); border: 1px solid rgba(147,51,234,0.2); border-radius: 10px;">
                <div style="flex: 1;">
                  <div style="font-size: 13px; color: #fff; font-weight: 600;">${MONTH_NAMES[parseInt(m)]}</div>
                  <div style="font-size: 11px; color: rgba(148,163,184,0.7);">${stats.count} —Å–æ–±—ã—Ç–∏–π</div>
                </div>
                <div style="font-size: 15px; font-weight: 700; color: #9333ea;">${stats.income.toLocaleString('ru-RU')} ‚ÇΩ</div>
              </div>
            `).join('')
        : '<div style="color: rgba(148,163,184,0.5); text-align: center; padding: 20px;">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</div>';

      // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ —Ç–∏–ø–∞–º
      const typeStats = {};
      yearEvents.forEach(event => {
        let mainType = 'rabbit';
        if (event.schedule && event.schedule.length > 0) {
          mainType = event.schedule[0].type || 'rabbit';
        } else {
          mainType = event.type || 'rabbit';
        }
        if (!typeStats[mainType]) {
          typeStats[mainType] = { count: 0, income: 0 };
        }
        typeStats[mainType].count++;
        typeStats[mainType].income += event.income || 0;
      });

      const typeStatsHTML = Object.entries(typeStats)
        .sort((a, b) => b[1].income - a[1].income)
        .slice(0, 5)
        .map(([type, stats]) => {
          const typeInfo = TYPES[type] || TYPES.rabbit;
          return `
            <div style="display: flex; align-items: center; gap: 12px; padding: 12px; background: rgba(0,0,0,0.3); border: 1px solid ${typeInfo.color}30; border-radius: 10px;">
              <div style="width: 36px; height: 36px; border-radius: 10px; background: ${typeInfo.color}20; border: 1px solid ${typeInfo.color}40; display: flex; align-items: center; justify-content: center;">
                ${typeInfo.image ? `<img src="${typeInfo.image}" style="width: 22px; height: 22px; object-fit: contain;">` : `<img src="icons/events/magician.png" style="width: 22px; height: 22px; object-fit: contain;">`}
              </div>
              <div style="flex: 1;">
                <div style="font-size: 13px; color: #fff; font-weight: 600;">${escapeHtml(typeInfo.label)}</div>
                <div style="font-size: 11px; color: rgba(148,163,184,0.7);">${stats.count} —Å–æ–±—ã—Ç–∏–π</div>
              </div>
              <div style="font-size: 15px; font-weight: 700; color: ${typeInfo.color};">${stats.income.toLocaleString('ru-RU')} ‚ÇΩ</div>
            </div>
          `;
        }).join('');

      const content = `
        <div style="display: flex; flex-direction: column; gap: 16px;">
          <div style="text-align: center; padding: 24px; background: linear-gradient(135deg, rgba(147,51,234,0.2), rgba(147,51,234,0.1)); border: 1px solid rgba(147,51,234,0.4); border-radius: 16px;">
            <div style="font-size: 16px; color: rgba(147,51,234,0.9); margin-bottom: 8px;">üèÜ –ò—Ç–æ–≥–∏ –∑–∞ ${year} –≥–æ–¥</div>
            <div style="font-size: 36px; font-weight: 900; color: ${netProfit >= 0 ? '#22c55e' : '#ef4444'};">${netProfit.toLocaleString('ru-RU')} ‚ÇΩ</div>
            <div style="font-size: 12px; color: rgba(148,163,184,0.7); margin-top: 4px;">–ß–∏—Å—Ç–∞—è –ø—Ä–∏–±—ã–ª—å</div>
          </div>

          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
            <div style="padding: 14px; background: rgba(34,197,94,0.1); border: 1px solid rgba(34,197,94,0.2); border-radius: 12px;">
              <div style="font-size: 11px; color: rgba(34,197,94,0.8); margin-bottom: 4px;">üí∞ –î–æ—Ö–æ–¥</div>
              <div style="font-size: 18px; font-weight: 700; color: #22c55e;">${totalIncome.toLocaleString('ru-RU')} ‚ÇΩ</div>
            </div>
            <div style="padding: 14px; background: rgba(239,68,68,0.1); border: 1px solid rgba(239,68,68,0.2); border-radius: 12px;">
              <div style="font-size: 11px; color: rgba(239,68,68,0.8); margin-bottom: 4px;">üí∏ –†–∞—Å—Ö–æ–¥</div>
              <div style="font-size: 18px; font-weight: 700; color: #ef4444;">${totalExpense.toLocaleString('ru-RU')} ‚ÇΩ</div>
            </div>
          </div>

          <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px;">
            <div style="padding: 12px; background: rgba(0,0,0,0.3); border: 1px solid rgba(147,51,234,0.2); border-radius: 10px; text-align: center;">
              <div style="font-size: 11px; color: rgba(148,163,184,0.7); margin-bottom: 4px;">–°–æ–±—ã—Ç–∏—è</div>
              <div style="font-size: 16px; font-weight: 700; color: #fff;">${yearEvents.length}</div>
            </div>
            <div style="padding: 12px; background: rgba(0,0,0,0.3); border: 1px solid rgba(147,51,234,0.2); border-radius: 10px; text-align: center;">
              <div style="font-size: 11px; color: rgba(148,163,184,0.7); margin-bottom: 4px;">–ü–æ–∫–∞–∑—ã</div>
              <div style="font-size: 16px; font-weight: 700; color: #fff;">${totalShows}</div>
            </div>
            <div style="padding: 12px; background: rgba(0,0,0,0.3); border: 1px solid rgba(147,51,234,0.2); border-radius: 10px; text-align: center;">
              <div style="font-size: 11px; color: rgba(148,163,184,0.7); margin-bottom: 4px;">–°—Ä–µ–¥–Ω–∏–π —á–µ–∫</div>
              <div style="font-size: 16px; font-weight: 700; color: #fff;">${avgCheck.toLocaleString('ru-RU')} ‚ÇΩ</div>
            </div>
          </div>

          ${totalTax > 0 ? `
          <div style="padding: 14px; background: rgba(245,158,11,0.1); border: 1px solid rgba(245,158,11,0.2); border-radius: 12px;">
            <div style="font-size: 11px; color: rgba(245,158,11,0.8); margin-bottom: 4px;">üìä –ù–∞–ª–æ–≥–∏ –∑–∞ –≥–æ–¥</div>
            <div style="font-size: 18px; font-weight: 700; color: #f59e0b;">${totalTax.toLocaleString('ru-RU')} ‚ÇΩ</div>
          </div>
          ` : ''}

          <div style="margin-top: 8px;">
            <div style="font-size: 13px; color: rgba(147,51,234,0.9); font-weight: 700; margin-bottom: 12px;">üìÖ –ü–æ –º–µ—Å—è—Ü–∞–º</div>
            <div style="display: flex; flex-direction: column; gap: 8px;">
              ${monthStatsHTML}
            </div>
          </div>

          <div style="margin-top: 8px;">
            <div style="font-size: 13px; color: rgba(147,51,234,0.9); font-weight: 700; margin-bottom: 12px;">üé≠ –¢–æ–ø-5 —Ç–∏–ø–æ–≤ —Å–æ–±—ã—Ç–∏–π</div>
            <div style="display: flex; flex-direction: column; gap: 8px;">
              ${typeStatsHTML}
            </div>
          </div>
        </div>
      `;

      document.getElementById('preview-content').innerHTML = content;
      document.getElementById('preview-modal').classList.add('show');
      lucide.createIcons();
    }

    // ==========================================
    // MAGIC HAT CELEBRATION
    // ==========================================
    function triggerMagicHatCelebration() {
      const container = document.getElementById('celebration-container');
      const hat = document.getElementById('magic-hat');
      const message = document.getElementById('goal-message');

      // Show container
      container.classList.add('show');

      // Show hat with animation
      setTimeout(() => {
        hat.classList.add('show');
      }, 100);

      // Start fountain effect after hat appears
      setTimeout(() => {
        startSparkFountain();
      }, 1000);

      // Show message
      setTimeout(() => {
        message.classList.add('show');
      }, 2000);

      // Hide everything
      setTimeout(() => {
        message.classList.remove('show');
      }, 5000);

      setTimeout(() => {
        hat.classList.remove('show');
      }, 5500);

      setTimeout(() => {
        container.classList.remove('show');
      }, 6000);
    }

    function startSparkFountain() {
      const hat = document.getElementById('magic-hat');
      const particleCount = 120;
      const duration = 3000; // 3 seconds of fountain

      let particlesCreated = 0;

      const interval = setInterval(() => {
        if (particlesCreated >= particleCount) {
          clearInterval(interval);
          return;
        }

        // Create sparkles
        for (let i = 0; i < 3; i++) {
          createSparkle(hat);
        }

        // Create stars occasionally
        if (Math.random() > 0.7) {
          createStar(hat);
        }

        particlesCreated++;
      }, 25);
    }

    function createSparkle(hat) {
      const sparkle = document.createElement('div');
      sparkle.className = 'sparkle';

      // Random direction upward (fountain effect)
      const angle = (Math.random() * 60 - 30) * Math.PI / 180; // -30 to +30 degrees from vertical
      const velocity = 150 + Math.random() * 200;
      const duration = 0.8 + Math.random() * 0.6;

      const tx = Math.sin(angle) * velocity;
      const ty = -Math.cos(angle) * velocity;

      sparkle.style.left = '100px';
      sparkle.style.bottom = '170px';
      sparkle.style.setProperty('--tx', `${tx}px`);
      sparkle.style.setProperty('--ty', `${ty}px`);
      sparkle.style.animationDuration = `${duration}s`;

      hat.appendChild(sparkle);

      setTimeout(() => {
        sparkle.remove();
      }, duration * 1000);
    }

    function createStar(hat) {
      const star = document.createElement('div');
      star.className = 'star-particle';

      const stars = ['‚≠ê', '‚ú®', 'üí´', 'üåü'];
      star.textContent = stars[Math.floor(Math.random() * stars.length)];
      star.style.color = Math.random() > 0.5 ? '#f59e0b' : '#f59e0b';

      // Random direction upward
      const angle = (Math.random() * 80 - 40) * Math.PI / 180;
      const velocity = 180 + Math.random() * 180;
      const duration = 1.2 + Math.random() * 0.8;
      const rotation = (Math.random() - 0.5) * 720;

      const tx = Math.sin(angle) * velocity;
      const ty = -Math.cos(angle) * velocity;

      star.style.left = '100px';
      star.style.bottom = '170px';
      star.style.setProperty('--tx', `${tx}px`);
      star.style.setProperty('--ty', `${ty}px`);
      star.style.setProperty('--rotate', `${rotation}deg`);
      star.style.animationDuration = `${duration}s`;

      hat.appendChild(star);

      setTimeout(() => {
        star.remove();
      }, duration * 1000);
    }

    // ==========================================
    // BOTTOM NAV AUTO-HIDE ON SCROLL
    // ==========================================
    const bottomNav = document.getElementById('bottom-nav');
    let scrollTimeout = null;

    function debounce(func, delay) {
      return function (...args) {
        clearTimeout(scrollTimeout);
        scrollTimeout = setTimeout(() => func.apply(this, args), delay);
      };
    }

    function showBottomNav() {
      if (bottomNav) {
        bottomNav.classList.add('visible');
      }
    }

    function hideBottomNav() {
      if (bottomNav) {
        bottomNav.classList.remove('visible');
      }
    }

    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–∑–∏—Ü–∏–∏ —Å–∫—Ä–æ–ª–ª–∞ –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —Ç–∞–±–∞
    function checkScrollPosition(tabName) {
      let container = null;

      if (tabName === 'calendar') {
        container = document.querySelector('.calendar-container');
      } else if (tabName === 'dashboard') {
        container = document.querySelector('.dashboard-container');
      }

      if (!container) return;

      const scrollTop = container.scrollTop;
      const scrollHeight = container.scrollHeight;
      const clientHeight = container.clientHeight;

      // –ï—Å–ª–∏ –∫–æ–Ω—Ç–µ–Ω—Ç –ø–æ–º–µ—â–∞–µ—Ç—Å—è –±–µ–∑ —Å–∫—Ä–æ–ª–ª–∞ –∏–ª–∏ –º—ã –≤–Ω–∏–∑—É - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –º–µ–Ω—é
      const hasNoScroll = scrollHeight <= clientHeight + 10;
      const isAtBottom = scrollTop + clientHeight >= scrollHeight - 20;

      if (hasNoScroll || isAtBottom) {
        showBottomNav();
      } else {
        hideBottomNav();
      }
    }

    let scrollTicking = false;

    function handleScrollImmediate(e) {
      if (scrollTicking) return;

      scrollTicking = true;

      requestAnimationFrame(() => {
        const scrollTop = e.target.scrollTop;
        const scrollHeight = e.target.scrollHeight;
        const clientHeight = e.target.clientHeight;

        // –ï—Å–ª–∏ –∫–æ–Ω—Ç–µ–Ω—Ç –ø–æ–º–µ—â–∞–µ—Ç—Å—è –±–µ–∑ —Å–∫—Ä–æ–ª–ª–∞ - –≤—Å–µ–≥–¥–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º
        const hasNoScroll = scrollHeight <= clientHeight + 10;
        const isAtBottom = scrollTop + clientHeight >= scrollHeight - 30;

        if (hasNoScroll || isAtBottom) {
          showBottomNav();
        } else {
          hideBottomNav();
        }

        scrollTicking = false;
      });
    }

    // ==========================================
    // HELPERS
    // ==========================================
    function formatDate(date) {
      if (typeof date === 'string') {
        // –£–∂–µ —Å—Ç—Ä–æ–∫–∞ —Ñ–æ—Ä–º–∞—Ç–∞ YYYY-MM-DD
        return date;
      }
      const year = date.getFullYear();
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const day = String(date.getDate()).padStart(2, '0');
      return `${year}-${month}-${day}`;
    }

    function formatDateInput(date) {
      return formatDate(date);
    }

    function parseEventDate(dateStr) {
      // –ü–∞—Ä—Å–∏–º –¥–∞—Ç—É –∫–∞–∫ –ª–æ–∫–∞–ª—å–Ω—É—é, –∞ –Ω–µ UTC
      const [y, m, d] = dateStr.split('-').map(Number);
      return new Date(y, m - 1, d);
    }

    // ==========================================
    // EXPORT FUNCTIONS TO WINDOW FOR ONCLICK
    // ==========================================
    window.changeMonth = changeMonth;
    window.openMonthPicker = openMonthPicker;
    window.openSettingsModal = openSettingsModal;
    window.switchTab = switchTab;
    window.closeEventModal = closeEventModal;
    window.toggleKeyVisibility = toggleKeyVisibility;
    window.tryCloseEventModal = tryCloseEventModal;
    window.closePreview = closePreview;
    window.openEventModal = openEventModal;
    window.toggleRepeatOptions = toggleRepeatOptions;

    // ==========================================
    // INIT
    // ==========================================

    // –§—É–Ω–∫—Ü–∏—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ (–±–µ–∑ –ø–æ–∫–∞–∑–∞)
    function initializeApp() {
      DOM.init();
      loadEvents();
      renderCalendar();
      renderSchedule();
      setupCalendarSwipe();

      // –ò–º–ø–æ—Ä—Ç —Å–æ–±—ã—Ç–∏–π –∏–∑ –ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä–∞ (–∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ, –Ω–µ –±–ª–æ–∫–∏—Ä—É–µ—Ç UI)
      setTimeout(function () { importEventsFromFirebase(); }, 2000);

      // –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π —Ñ–æ—Ä–º—ã —Å–æ–±—ã—Ç–∏—è
      const eventModalBody = document.querySelector('#event-modal .modal-body');
      if (eventModalBody) {
        eventModalBody.addEventListener('input', () => { formDirty = true; });
        eventModalBody.addEventListener('change', () => { formDirty = true; });
      }

      // –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–∫—Ä–æ–ª–ª–∞ –¥–ª—è bottom-nav
      const dashContainer = document.querySelector('.dashboard-container');
      const calContainer = document.querySelector('.calendar-container');

      if (dashContainer) {
        dashContainer.addEventListener('scroll', handleScrollImmediate, { passive: true });
      }
      if (calContainer) {
        calContainer.addEventListener('scroll', handleScrollImmediate, { passive: true });
      }
    }

    // –§—É–Ω–∫—Ü–∏—è —Ä–µ–Ω–¥–µ—Ä–∞ –∏–∫–æ–Ω–æ–∫ —Å –æ–∂–∏–¥–∞–Ω–∏–µ–º
    function renderIconsAndShow(callback) {
      if (typeof lucide !== 'undefined') {
        lucide.createIcons();
        // –î–∞—ë–º –≤—Ä–µ–º—è –Ω–∞ —Ä–µ–Ω–¥–µ—Ä –∏–∫–æ–Ω–æ–∫
        setTimeout(() => {
          lucide.createIcons();
          setTimeout(() => {
            lucide.createIcons();
            // –¢–µ–ø–µ—Ä—å –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–æ–Ω—Ç–µ–Ω—Ç
            document.body.classList.add('app-ready');
            if (callback) callback();
          }, 150);
        }, 100);
      } else {
        document.body.classList.add('app-ready');
        if (callback) callback();
      }
    }

    document.addEventListener('DOMContentLoaded', async () => {
      const splash = document.getElementById('splash-screen');

      // Register Service Worker for PWA
      if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('./sw.js', { scope: './' }).catch(() => { });
      }

      // Auto block/unblock body scroll when any modal is open
      const modalObserver = new MutationObserver(() => {
        const anyOpen = [...document.querySelectorAll('.modal-overlay')].some(m => m.classList.contains('show'));
        document.body.classList.toggle('modal-open', anyOpen);
      });
      document.querySelectorAll('.modal-overlay').forEach(m => {
        modalObserver.observe(m, { attributes: true, attributeFilter: ['class'] });
      });

      // Handle Android/iOS back button for modals (priority: top layer first)
      window.addEventListener('popstate', () => {
        const modals = [
          { id: 'type-picker-modal', close: () => closeTypePicker() },
          { id: 'confirm-modal', close: () => document.getElementById('confirm-modal').classList.remove('show') },
          { id: 'preview-modal', close: () => closePreview() },
          { id: 'type-editor-modal', close: () => closeTypeEditor() },
          { id: 'category-manager-modal', close: () => closeCategoryManager() },
          { id: 'month-picker-modal', close: () => closeMonthPicker() },
          { id: 'settings-modal', close: () => closeSettingsModal() },
          { id: 'event-modal', close: () => tryCloseEventModal() }
        ];

        for (const modal of modals) {
          const el = document.getElementById(modal.id);
          if (el && el.classList.contains('show')) {
            modal.close();
            history.pushState(null, '', location.href);
            return;
          }
        }
      });
      history.pushState(null, '', location.href);

      // Check license
      try {
        const hasLicense = await checkActivation();

        if (!hasLicense || hasLicense === 'expired') {
          // –°–∫—Ä—ã–≤–∞–µ–º splash, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É –∞–∫—Ç–∏–≤–∞—Ü–∏–∏
          if (splash) splash.classList.add('hidden');
          showLicensePrompt(hasLicense === 'expired' ? 'expired' : 'first');
          return;
        }

        // ===== –ü–û–í–¢–û–†–ù–´–ô –ó–ê–ü–£–°–ö (—É–∂–µ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω) =====
        // –ó–∞–ø–∏—Å—ã–≤–∞–µ–º –º–∞—Ä–∫–µ—Ä –≤ Firebase ‚Äî –ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –Ω–∞–ª–∏—á–∏–µ –ö–∞–ª–µ–Ω–¥–∞—Ä—è
        if (window.firebaseEnabled && window.firebaseDB) {
          try {
            var fp = getBrowserFingerprint();
            window.firebaseDB.ref('sync/devices/' + fp).set({ calendar_active: true });
          } catch (e) { }
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –ø–æ–∫–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è splash
        initializeApp();

        // –ñ–¥—ë–º –º–∏–Ω–∏–º—É–º 1.8 —Å–µ–∫ –¥–ª—è splash + —Ä–µ–Ω–¥–µ—Ä –∏–∫–æ–Ω–æ–∫
        setTimeout(() => {
          // –†–µ–Ω–¥–µ—Ä–∏–º –∏–∫–æ–Ω–∫–∏
          if (typeof lucide !== 'undefined') {
            lucide.createIcons();
          }

          // –ï—â—ë –Ω–µ–º–Ω–æ–≥–æ –∂–¥—ë–º –¥–ª—è –ø–æ–ª–Ω–æ–≥–æ —Ä–µ–Ω–¥–µ—Ä–∞
          setTimeout(() => {
            if (typeof lucide !== 'undefined') {
              lucide.createIcons();
            }

            // –ü–ª–∞–≤–Ω–æ —Å–∫—Ä—ã–≤–∞–µ–º splash
            splash.classList.add('hide');

            // –ü–æ—Å–ª–µ fade-out –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–æ–Ω—Ç–µ–Ω—Ç
            setTimeout(() => {
              splash.classList.add('hidden');
              document.body.classList.add('app-ready');

              // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–∑–∏—Ü–∏—é —Å–∫—Ä–æ–ª–ª–∞ –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ —Ç–∞–±–∞
              setTimeout(() => checkScrollPosition('calendar'), 100);

              // –§–∏–Ω–∞–ª—å–Ω—ã–π —Ä–µ–Ω–¥–µ—Ä –∏–∫–æ–Ω–æ–∫
              setTimeout(() => {
                if (typeof lucide !== 'undefined') {
                  lucide.createIcons();
                }
              }, 100);
            }, 500);
          }, 200);
        }, 1800);

      } catch (error) {
        if (splash) splash.classList.add('hidden');
        showLicensePrompt("first");
      }
    });

    // ============================================
    // –¢–ê–ö–¢–ò–õ–¨–ù–ê–Ø –û–ë–†–ê–¢–ù–ê–Ø –°–í–Ø–ó–¨ (–≤–∏–±—Ä–∞—Ü–∏—è + –≤–∏–∑—É–∞–ª—å–Ω—ã–π fallback –¥–ª—è iOS)
    // ============================================
    (function () {
      const isVibrationSupported = 'vibrate' in navigator;

      // CSS –¥–ª—è –≤–∏–∑—É–∞–ª—å–Ω–æ–≥–æ fallback (iOS –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç navigator.vibrate)
      const hapticStyle = document.createElement('style');
      hapticStyle.textContent = `
        @keyframes haptic-tap { 0% { transform: scale(1); } 50% { transform: scale(0.95); } 100% { transform: scale(1); } }
        @keyframes haptic-success { 0% { box-shadow: 0 0 0 0 rgba(34,197,94,0.4); } 100% { box-shadow: 0 0 0 8px rgba(34,197,94,0); } }
        @keyframes haptic-shake { 0%,100% { transform: translateX(0); } 20% { transform: translateX(-3px); } 40% { transform: translateX(3px); } 60% { transform: translateX(-2px); } 80% { transform: translateX(2px); } }
        .haptic-tap { animation: haptic-tap 0.12s ease-out; }
        .haptic-success { animation: haptic-success 0.4s ease-out; }
        .haptic-shake { animation: haptic-shake 0.3s ease-out; }
      `;
      document.head.appendChild(hapticStyle);

      let lastTappedEl = null;
      document.addEventListener('pointerdown', function (e) {
        lastTappedEl = e.target.closest('button, .day-cell, .nav-item, [role="button"], .btn-primary, .btn-secondary, .btn-danger, .modal-close');
      }, true);

      const HAPTIC = {
        light: 15,
        medium: 25,
        strong: 35,
        date: [20, 30, 20],
        success: [15, 50, 15],
        error: [10, 50, 10, 50, 10]
      };

      function visualFeedback(type) {
        var el = lastTappedEl;
        if (!el) return;
        var cls = (type === 'success') ? 'haptic-success' : (type === 'error') ? 'haptic-shake' : 'haptic-tap';
        el.classList.remove('haptic-tap', 'haptic-success', 'haptic-shake');
        void el.offsetWidth;
        el.classList.add(cls);
        setTimeout(function () { el.classList.remove(cls); }, 400);
      }

      window.hapticFeedback = function (type) {
        type = type || 'medium';
        if (isVibrationSupported) {
          var pattern = HAPTIC[type] || HAPTIC.medium;
          navigator.vibrate(pattern);
        } else {
          visualFeedback(type);
        }
      };

      // –ñ–¥–µ–º –∑–∞–≥—Ä—É–∑–∫–∏ DOM
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initHaptics);
      } else {
        initHaptics();
      }

      function initHaptics() {
        console.log('‚úÖ Calendar Haptic feedback initialized', { supported: isVibrationSupported });

        // ============================================
        // –ö–õ–ò–ö –ü–û –î–ê–¢–ê–ú –ö–ê–õ–ï–ù–î–ê–†–Ø (–û–°–û–ë–ï–ù–ù–û –í–ê–ñ–ù–û!)
        // ============================================
        // –ü–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞–µ–º —Ñ—É–Ω–∫—Ü–∏—é selectDate –¥–ª—è –≤–∏–±—Ä–∞—Ü–∏–∏
        if (window.selectDate) {
          const originalSelectDate = window.selectDate;

          window.selectDate = function (date) {
            // –°–ò–õ–¨–ù–ê–Ø –í–ò–ë–†–ê–¶–ò–Ø –° –î–í–û–ô–ù–´–ú –ò–ú–ü–£–õ–¨–°–û–ú –¥–ª—è –≤—ã–±–æ—Ä–∞ –¥–∞—Ç—ã!
            hapticFeedback('date');

            // –í—ã–∑—ã–≤–∞–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é
            return originalSelectDate.call(this, date);
          };
        }

        // –ü–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞–µ–º saveEvent - —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å–æ–±—ã—Ç–∏—è
        if (window.saveEvent) {
          const originalSaveEvent = window.saveEvent;

          window.saveEvent = function () {
            hapticFeedback('success');
            return originalSaveEvent.call(this);
          };
        }

        // –ü–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞–µ–º deleteEvent - —É–¥–∞–ª–µ–Ω–∏–µ —Å–æ–±—ã—Ç–∏—è
        if (window.deleteEvent) {
          const originalDeleteEvent = window.deleteEvent;

          window.deleteEvent = function () {
            hapticFeedback('medium');
            return originalDeleteEvent.call(this);
          };
        }

        // –ü–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞–µ–º openEventModal - –æ—Ç–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
        if (window.openEventModal) {
          const originalOpenEventModal = window.openEventModal;

          window.openEventModal = function (date) {
            hapticFeedback('light');
            return originalOpenEventModal.call(this, date);
          };
        }

        // –ü–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª—è–µ–º showToast –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –≤–∏–±—Ä–∞—Ü–∏–∏
        if (window.showToast) {
          const originalShowToast = window.showToast;

          window.showToast = function (message) {
            if (message.includes('—Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ') || message.includes('–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ') || message.includes('—É–¥–∞–ª–µ–Ω–æ') || message.includes('–£–¥–∞–ª–µ–Ω–æ')) {
              hapticFeedback('success');
            } else if (message.includes('–æ—à–∏–±–∫–∞') || message.includes('–û—à–∏–±–∫–∞') || message.includes('‚ùå')) {
              hapticFeedback('error');
            } else {
              hapticFeedback('light');
            }

            return originalShowToast.call(this, message);
          };
        }

        // –î–æ–±–∞–≤–ª—è–µ–º –≤–∏–±—Ä–∞—Ü–∏—é –Ω–∞ –∫–Ω–æ–ø–∫–∏
        document.querySelectorAll('[onclick*="changeMonth"]').forEach(btn => {
          btn.addEventListener('click', () => {
            hapticFeedback('light');
          });
        });

        document.querySelectorAll('.nav-item').forEach(btn => {
          btn.addEventListener('click', () => {
            hapticFeedback('medium');
          });
        });

        document.querySelectorAll('.btn-primary').forEach(btn => {
          btn.addEventListener('click', () => {
            hapticFeedback('medium');
          });
        });

        document.querySelectorAll('.btn-secondary').forEach(btn => {
          btn.addEventListener('click', () => {
            hapticFeedback('light');
          });
        });

        document.querySelectorAll('.btn-danger').forEach(btn => {
          btn.addEventListener('click', () => {
            hapticFeedback('medium');
          });
        });

        document.querySelectorAll('[onclick*="toggleSection"]').forEach(btn => {
          btn.addEventListener('click', () => {
            hapticFeedback('light');
          });
        });

        document.querySelectorAll('.modal-close').forEach(btn => {
          btn.addEventListener('click', () => {
            hapticFeedback('light');
          });
        });

        // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
        window.hapticError = function () {
          hapticFeedback('error');
        };

        window.hapticSuccess = function () {
          hapticFeedback('success');
        };

        window.hapticDateSelect = function () {
          hapticFeedback('date');
        };
      }

      console.log('üì≥ Calendar Haptic feedback module loaded');
    })();
  </script>
</body>

</html>