<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
  <title>Illusionist OS</title>

  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="Illusionist OS" />
  <link rel="apple-touch-icon" href="icon.png" />
  <link rel="icon" type="image/png" href="icon.png" />

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;800&family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">

  <style>
    :root{
      --gold-primary:#f59e0b;
      --dark-bg:#050507;
      --card-surface:rgba(255,255,255,.03);
      --card-border:rgba(255,255,255,.06);

      /* Навигация снизу на мобиле */
      --bottom-nav-h: 72px;
      --bottom-nav-gap: 14px; /* визуальный отступ от края */
    }

    body{
      font-family:'Inter',sans-serif;
      background-color:var(--dark-bg);
      color:#e2e8f0;
      overflow:hidden;
      overscroll-behavior:none;
      min-height:100dvh;
      position:fixed;
      width:100%;
      height:100%;
    }

    h1,h2,h3,.font-display{font-family:'Cinzel',serif;}

    .noise-overlay{
      position:fixed;top:0;left:0;width:100%;height:100%;
      pointer-events:none;z-index:0;opacity:.03;
      background-image:url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.65' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)'/%3E%3C/svg%3E");
    }

    .glass-panel{
      background:linear-gradient(180deg,rgba(30,41,59,.7) 0%,rgba(15,23,42,.6) 100%);
      backdrop-filter:blur(24px);
      -webkit-backdrop-filter:blur(24px);
      border:1px solid rgba(255,255,255,.08);
      box-shadow:0 4px 30px rgba(0,0,0,.5), inset 0 0 0 1px rgba(255,255,255,.05);
    }

    ::-webkit-scrollbar{width:4px}
    ::-webkit-scrollbar-track{background:transparent}
    ::-webkit-scrollbar-thumb{background:rgba(255,255,255,.1);border-radius:10px}

    .tab-active{
      background-color:rgba(51,65,85,.5);
      color:white;
      box-shadow:0 0 10px rgba(255,255,255,.05);
      border:1px solid rgba(255,255,255,.1);
    }

    #bg-canvas{position:fixed;top:0;left:0;width:100%;height:100%;z-index:-1}

    input[type="time"]::-webkit-calendar-picker-indicator,
    input[type="date"]::-webkit-calendar-picker-indicator{
      filter:invert(1);opacity:.5;cursor:pointer;
    }

    .no-hor-scroll{overflow-x:hidden;max-width:100vw}

    .calendar-cell{
      position:relative;background:var(--card-surface);
      border:1px solid var(--card-border);
      border-radius:12px;
      overflow:hidden;
      transition:all .2s ease;
      display:flex;flex-direction:column;align-items:center;justify-content:flex-start;
      padding-top:6px;gap:4px;
    }
    .calendar-cell:hover{border-color:rgba(255,255,255,.15);background:rgba(255,255,255,.05);transform:translateY(-1px)}
    .calendar-cell.selected{border-color:rgba(245,158,11,.4);box-shadow:0 0 15px rgba(245,158,11,.1);background:rgba(245,158,11,.05)}
    .calendar-cell.today .date-number{background:linear-gradient(135deg,#fbbf24,#d97706);color:#000;font-weight:700;box-shadow:0 2px 5px rgba(245,158,11,.3)}

    .date-number{
      font-size:11px;font-weight:500;color:rgba(255,255,255,.6);
      width:20px;height:20px;display:flex;align-items:center;justify-content:center;
      border-radius:6px;transition:all .2s;
    }

    .calendar-cell-content{width:100%;display:flex;flex-direction:column;gap:2px;padding:0 3px;align-items:center}
    .event-label{
      font-size:8px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
      border-radius:3px;padding:2px 4px;text-align:center;cursor:pointer;
      transition:all .2s;color:rgba(255,255,255,.9);font-weight:600;
      letter-spacing:.03em;text-transform:uppercase;width:90%;
      border:1px solid transparent;
    }
    .event-label:hover{transform:scale(1.02);filter:brightness(1.1);z-index:10}

    .event-stage{background:rgba(245,158,11,.15);border-color:rgba(245,158,11,.3);color:#fbbf24}
    .event-closeup{background:rgba(168,85,247,.15);border-color:rgba(168,85,247,.3);color:#c084fc}
    .event-kids{background:rgba(16,185,129,.15);border-color:rgba(16,185,129,.3);color:#34d399}
    .event-concert{background:rgba(59,130,246,.15);border-color:rgba(59,130,246,.3);color:#60a5fa}
    .event-rehearsal{background:rgba(148,163,184,.15);border-color:rgba(148,163,184,.3);color:#cbd5e1}

    .month-summary{
      margin-top:auto;margin-bottom:4px;
      background:linear-gradient(90deg,transparent,rgba(245,158,11,.1),transparent);
      border-top:1px solid rgba(245,158,11,.2);
      border-bottom:1px solid rgba(245,158,11,.2);
      padding:2px 0;font-size:7px;width:80%;text-align:center;
      text-transform:uppercase;font-weight:700;color:#fbbf24;letter-spacing:1.5px;
    }

    .confetti{position:absolute;width:8px;height:8px;background-color:#f59e0b;animation:fall linear forwards;z-index:9999}
    @keyframes fall{to{transform:translateY(100vh) rotate(720deg);opacity:0}}

    .pb-safe{padding-bottom:env(safe-area-inset-bottom,20px)}
    .pt-safe{padding-top:env(safe-area-inset-top,20px)}

    @media (max-width:1024px){
      .mobile-hidden{display:none!important}
      button{min-height:44px}
    }

    .type-btn{position:relative;overflow:hidden}
    .type-btn.selected{background-color:rgba(255,255,255,.1);border-color:rgba(255,255,255,.3)}
    .type-btn.selected i{transform:scale(1.1)}
    .type-btn#type-stage.selected{border-color:#f59e0b;background-color:rgba(245,158,11,.1)}
    .type-btn#type-closeup.selected{border-color:#a855f7;background-color:rgba(168,85,247,.1)}
    .type-btn#type-kids.selected{border-color:#10b981;background-color:rgba(16,185,129,.1)}
    .type-btn#type-concert.selected{border-color:#3b82f6;background-color:rgba(59,130,246,.1)}
    .type-btn#type-rehearsal.selected{border-color:#94a3b8;background-color:rgba(148,163,184,.1)}

    /* Список таймингов: добавили длительность */
    .act-row{
      display:grid;
      grid-template-columns:40px 1fr 76px 30px;
      gap:8px;
      align-items:center;
      background:rgba(255,255,255,.03);
      border:1px solid rgba(255,255,255,.05);
      border-radius:8px;
      padding:6px;
      margin-bottom:6px;
    }
    .act-dur{
      display:flex;
      align-items:center;
      justify-content:center;
      gap:6px;
      background:rgba(255,255,255,.03);
      border:1px solid rgba(255,255,255,.08);
      border-radius:8px;
      padding:6px 8px;
      height:32px;
    }
    .act-dur input{
      width:44px;
      background:transparent;
      color:#fff;
      outline:none;
      text-align:center;
      font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size:12px;
    }
    .act-dur span{
      font-size:10px;
      color:rgba(245,158,11,.9);
      font-weight:700;
      letter-spacing:.08em;
      text-transform:uppercase;
    }

    /* Нижняя навигация: учитывать safe-area */
    .bottom-nav-safe{
      bottom: calc(env(safe-area-inset-bottom, 0px) + var(--bottom-nav-gap));
      height: var(--bottom-nav-h);
      padding-bottom: env(safe-area-inset-bottom, 0px);
    }

    /* Чтобы контент дашборда не прятался за нижним меню */
    .dash-safe-pad{
      padding-bottom: calc(env(safe-area-inset-bottom, 0px) + var(--bottom-nav-h) + 28px);
    }

    /* Плавающая кнопка на десктопе — пусть не лезет в safe-area */
    .fab-safe{
      bottom: calc(env(safe-area-inset-bottom, 0px) + 32px);
    }
  </style>
</head>

<body class="h-screen flex flex-col text-sm md:text-base no-hor-scroll pt-safe">
  <div class="noise-overlay"></div>
  <div class="fixed inset-0 bg-gradient-to-br from-indigo-900/20 via-transparent to-amber-900/10 pointer-events-none z-[-1]"></div>
  <canvas id="bg-canvas"></canvas>
  <div id="confetti-container" class="fixed inset-0 pointer-events-none z-[200]"></div>

  <!-- Toast (чтобы showToast не ломал приложение) -->
  <div id="toast" class="fixed top-4 left-1/2 -translate-x-1/2 z-[300] opacity-0 -translate-y-4 transition-all duration-300 pointer-events-none">
    <div class="glass-panel rounded-2xl px-4 py-3 border border-amber-500/20 shadow-2xl">
      <div class="flex items-center gap-2">
        <i data-lucide="sparkles" class="w-4 h-4 text-amber-400"></i>
        <span id="toast-msg" class="text-sm text-slate-200 font-semibold"></span>
      </div>
    </div>
  </div>

  <!-- App Container -->
  <div class="relative z-10 w-full h-full flex flex-col max-w-7xl mx-auto p-4 pb-24 lg:p-6 lg:pb-6 no-hor-scroll">
    <!-- HEADER -->
    <header class="flex justify-between items-center mb-4 shrink-0 gap-2">
      <div class="flex items-center gap-2 md:gap-3 overflow-hidden">
        <div class="relative w-9 h-9 md:w-11 md:h-11 flex-shrink-0 flex items-center justify-center rounded-2xl bg-[#0f0f13] border border-amber-500/20 shadow-[0_4px_12px_rgba(0,0,0,0.5)]">
          <div class="absolute inset-0 rounded-2xl bg-gradient-to-tr from-amber-500/10 to-transparent opacity-50"></div>
          <i data-lucide="calendar" class="relative z-10 w-4 h-4 md:w-6 md:h-6 text-amber-500 drop-shadow-[0_2px_4px_rgba(245,158,11,0.25)]"></i>
        </div>

        <div class="min-w-0 flex flex-col justify-center">
          <h1 class="text-[8px] md:text-[10px] font-bold text-transparent bg-clip-text bg-gradient-to-r from-amber-200 to-amber-600 truncate leading-tight tracking-widest font-display">ILLUSIONIST OS</h1>
          <span class="text-[6px] md:text-[8px] text-slate-500 font-bold tracking-[0.2em] uppercase leading-none mt-0.5">Calendar</span>
        </div>
      </div>

      <div class="flex items-center gap-2 flex-shrink-0">
        <div class="flex items-center glass-panel p-0.5 rounded-lg h-8 md:h-10">
          <button onclick="window.changeMonth(-1)" class="w-8 md:w-10 h-full flex items-center justify-center hover:bg-white/10 rounded-md text-slate-400 hover:text-white transition">
            <i data-lucide="chevron-left" class="w-4 h-4"></i>
          </button>
          <button onclick="window.openMonthPicker()" id="current-month-display" class="px-2 md:px-4 text-center font-display font-bold text-xs md:text-sm whitespace-nowrap min-w-[70px] hover:text-amber-400 transition cursor-pointer"></button>
          <button onclick="window.changeMonth(1)" class="w-8 md:w-10 h-full flex items-center justify-center hover:bg-white/10 rounded-md text-slate-400 hover:text-white transition">
            <i data-lucide="chevron-right" class="w-4 h-4"></i>
          </button>
        </div>

        <button onclick="window.goToToday()" class="w-8 h-8 md:w-10 md:h-10 flex items-center justify-center glass-panel rounded-lg text-slate-400 hover:text-amber-400 hover:border-amber-500/30 transition flex-shrink-0" title="Сегодня">
          <i data-lucide="calendar-clock" class="w-4 h-4"></i>
        </button>

        <button onclick="window.openSettings()" class="w-8 h-8 md:w-10 md:h-10 flex items-center justify-center glass-panel rounded-lg text-slate-400 hover:text-amber-400 hover:border-amber-500/30 transition flex-shrink-0">
          <i data-lucide="settings" class="w-4 h-4"></i>
        </button>
      </div>
    </header>

    <!-- MAIN CONTENT AREA -->
    <div class="flex-1 overflow-hidden relative">
      <!-- VIEW: CALENDAR -->
      <div id="view-calendar" class="h-full flex flex-col lg:grid lg:grid-cols-12 lg:gap-6 w-full absolute inset-0 transition-opacity duration-300">
        <div class="lg:col-span-8 glass-panel rounded-2xl p-2 md:p-4 flex flex-col h-full relative overflow-hidden">
          <div class="grid grid-cols-7 mb-1 border-b border-white/5 pb-1">
            <div class="text-center text-slate-500 text-[10px] font-bold uppercase">Пн</div>
            <div class="text-center text-slate-500 text-[10px] font-bold uppercase">Вт</div>
            <div class="text-center text-slate-500 text-[10px] font-bold uppercase">Ср</div>
            <div class="text-center text-slate-500 text-[10px] font-bold uppercase">Чт</div>
            <div class="text-center text-slate-500 text-[10px] font-bold uppercase">Пт</div>
            <div class="text-center text-slate-500 text-[10px] font-bold uppercase">Сб</div>
            <div class="text-center text-slate-500 text-[10px] font-bold uppercase">Вс</div>
          </div>
          <div id="calendar-grid" class="grid grid-cols-7 gap-1 lg:gap-2 flex-1 auto-rows-fr overflow-y-auto custom-scrollbar pb-4"></div>
        </div>

        <div class="hidden lg:flex lg:col-span-4 flex-col gap-6 h-full overflow-hidden"></div>
      </div>

      <!-- VIEW: DASHBOARD -->
      <div id="view-dashboard" class="h-full flex flex-col lg:absolute lg:top-0 lg:right-0 lg:w-[32%] lg:h-full mobile-hidden">
        <div class="flex flex-col gap-4 h-full dash-safe-pad">
          <!-- Stats -->
          <div class="glass-panel rounded-2xl p-4 shrink-0">
            <div class="flex justify-between items-center mb-3">
              <h3 class="text-xs font-bold text-amber-500 uppercase tracking-widest flex items-center gap-2">
                <i data-lucide="layout-dashboard" class="w-4 h-4"></i> Финансы
              </h3>
            </div>

            <div class="text-center mb-3 relative">
              <span id="stat-profit" class="text-3xl font-display font-bold text-white tracking-tight">0</span>
              <span class="text-lg text-slate-500 font-display ml-1">₽</span>
              <div id="goal-badge" class="hidden absolute -top-2 -right-2 bg-gradient-to-r from-amber-400 to-yellow-300 text-black text-[9px] font-bold px-2 py-0.5 rounded-full shadow-lg animate-bounce">
                ЦЕЛЬ!
              </div>
            </div>

            <div class="mb-3">
              <div class="flex justify-between text-xs mb-1 text-slate-400">
                <span>Цель</span>
                <span id="goal-amount" class="relative z-[2] pointer-events-auto cursor-pointer hover:text-white border-b border-dashed border-slate-600" onclick="window.editGoal()">200k ₽</span>
              </div>
              <div class="h-1.5 w-full bg-slate-800 rounded-full overflow-hidden relative">
                <div id="goal-progress" class="h-full bg-gradient-to-r from-amber-700 to-yellow-400 transition-all duration-1000" style="width:0%"></div>
              </div>
            </div>

            <div class="grid grid-cols-2 gap-2 text-center">
              <div class="bg-white/5 p-2 rounded-lg">
                <p class="text-[9px] text-slate-500 uppercase">Доход</p>
                <p id="stat-income" class="text-xs font-bold text-emerald-400">0</p>
              </div>
              <div class="bg-white/5 p-2 rounded-lg">
                <p class="text-[9px] text-slate-500 uppercase">Расход</p>
                <p id="stat-expense" class="text-xs font-bold text-red-400">0</p>
              </div>
            </div>
          </div>

          <!-- Event List (ПЕРЕМЕЩЕНО ВМЕСТО "ПОПУЛЯРНОСТИ") -->
          <div class="glass-panel rounded-2xl flex-1 flex flex-col min-h-0 relative overflow-hidden">
            <div class="p-4 border-b border-white/5 bg-slate-900/30 shrink-0 flex justify-between items-center">
              <div>
                <h2 id="selected-date-big" class="text-2xl font-display font-bold text-white"></h2>
                <p id="selected-weekday" class="text-amber-500 text-[10px] uppercase font-bold tracking-widest"></p>
              </div>
            </div>
            <div id="events-list" class="flex-1 overflow-y-auto p-3 space-y-3 custom-scrollbar pb-16"></div>
          </div>

          <!-- Popularity Analytics (ОПУЩЕНО ВНИЗ) -->
          <div class="glass-panel rounded-2xl p-4 shrink-0">
            <div class="flex justify-between items-center mb-3">
              <h3 class="text-xs font-bold text-amber-500 uppercase tracking-widest flex items-center gap-2">
                <i data-lucide="bar-chart-2" class="w-4 h-4"></i> Популярность
              </h3>
            </div>
            <div id="analytics-list" class="space-y-3"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- MAIN ADD BUTTON -->
  <button onclick="window.openModal()" class="hidden lg:flex fixed left-1/2 -translate-x-1/2 w-16 h-16 rounded-full bg-gradient-to-r from-amber-500 to-orange-600 text-white shadow-2xl shadow-orange-500/40 items-center justify-center z-50 transform hover:scale-110 transition duration-300 fab-safe">
    <i data-lucide="plus" class="w-8 h-8"></i>
  </button>

  <!-- MOBILE BOTTOM NAV -->
  <div class="lg:hidden fixed left-4 right-4 bg-[#0f172a]/90 backdrop-blur-xl border border-white/10 rounded-2xl z-40 shadow-2xl flex items-center justify-between px-6 pb-0 bottom-nav-safe">
    <button onclick="window.switchMobileTab('calendar')" id="nav-calendar" class="flex flex-col items-center justify-center gap-1 text-amber-400 w-16 transition-all duration-300">
      <i data-lucide="calendar" class="w-5 h-5"></i>
      <span class="text-[9px] font-bold tracking-wide">Календарь</span>
    </button>

    <button onclick="window.openModal()" class="relative -top-6 w-14 h-14 rounded-full bg-gradient-to-br from-amber-400 to-orange-600 text-white shadow-lg shadow-orange-500/40 flex items-center justify-center transform active:scale-95 transition border-4 border-[#050507]">
      <i data-lucide="plus" class="w-7 h-7"></i>
    </button>

    <button onclick="window.switchMobileTab('dashboard')" id="nav-dashboard" class="flex flex-col items-center justify-center gap-1 text-slate-500 w-16 transition-all duration-300">
      <i data-lucide="layout-list" class="w-5 h-5"></i>
      <span class="text-[9px] font-bold tracking-wide">Дашборд</span>
    </button>
  </div>

  <!-- EVENT MODAL -->
  <div id="event-modal" class="fixed inset-0 z-[100] hidden no-hor-scroll">
    <div class="absolute inset-0 bg-slate-950/90 backdrop-blur-sm" onclick="window.closeModal()"></div>

    <div class="absolute bottom-0 md:top-1/2 md:left-1/2 md:-translate-x-1/2 md:-translate-y-1/2 w-full md:w-[420px] h-[90vh] md:h-auto md:max-h-[85vh] bg-[#0f172a] md:border border-amber-500/20 md:rounded-2xl rounded-t-3xl shadow-2xl flex flex-col overflow-hidden animate-enter">
      <div class="p-4 border-b border-white/5 flex justify-between items-center bg-white/5 shrink-0">
        <h3 class="text-lg font-display font-bold text-white text-center w-full ml-8" id="modal-title">Новое Событие</h3>
        <button onclick="window.closeModal()" class="p-2 bg-white/5 rounded-full hover:bg-white/10 transition">
          <i data-lucide="x" class="w-5 h-5 text-slate-400"></i>
        </button>
      </div>

      <div class="flex p-2 bg-black/20 gap-1 mx-4 mt-4 rounded-lg shrink-0 justify-center">
        <button onclick="window.switchTab('info')" id="tab-btn-info" class="tab-active flex-1 py-2 text-[10px] font-bold uppercase rounded transition">Инфо</button>
        <button onclick="window.switchTab('setlist')" id="tab-btn-setlist" class="flex-1 py-2 text-[10px] font-bold uppercase text-slate-500 rounded transition">Шоу</button>
        <button onclick="window.switchTab('finance')" id="tab-btn-finance" class="flex-1 py-2 text-[10px] font-bold uppercase text-slate-500 rounded transition">Касса</button>
        <button onclick="window.switchTab('notes')" id="tab-btn-notes" class="flex-1 py-2 text-[10px] font-bold uppercase text-slate-500 rounded transition">Заметки</button>
      </div>

      <div class="p-5 overflow-y-auto overflow-x-hidden custom-scrollbar flex-1">
        <div id="tab-info" class="space-y-4 max-w-xs mx-auto">
          <!-- Event Types -->
          <div class="grid grid-cols-3 sm:grid-cols-5 gap-3">
            <button onclick="window.setType('stage')" id="type-stage" class="type-btn group relative p-3 rounded-2xl border border-amber-500 bg-amber-500/10 text-amber-400 flex flex-col items-center gap-2 overflow-hidden transition-all selected">
              <i data-lucide="star" class="w-5 h-5"></i>
              <span class="text-[9px] font-bold uppercase tracking-wider">Сцена</span>
            </button>

            <button onclick="window.setType('closeup')" id="type-closeup" class="type-btn group relative p-3 rounded-2xl border border-white/5 bg-white/5 text-slate-500 hover:bg-white/10 flex flex-col items-center gap-2 overflow-hidden transition-all">
              <i data-lucide="sparkles" class="w-5 h-5"></i>
              <span class="text-[9px] font-bold uppercase tracking-wider">Микро</span>
            </button>

            <button onclick="window.setType('kids')" id="type-kids" class="type-btn group relative p-3 rounded-2xl border border-white/5 bg-white/5 text-slate-500 hover:bg-white/10 flex flex-col items-center gap-2 overflow-hidden transition-all">
              <i data-lucide="rabbit" class="w-5 h-5"></i>
              <span class="text-[9px] font-bold uppercase tracking-wider">Дети</span>
            </button>

            <button onclick="window.setType('concert')" id="type-concert" class="type-btn group relative p-3 rounded-2xl border border-white/5 bg-white/5 text-slate-500 hover:bg-white/10 flex flex-col items-center gap-2 overflow-hidden transition-all">
              <i data-lucide="mic-2" class="w-5 h-5"></i>
              <span class="text-[9px] font-bold uppercase tracking-wider">Концерт</span>
            </button>

            <button onclick="window.setType('rehearsal')" id="type-rehearsal" class="type-btn group relative p-3 rounded-2xl border border-white/5 bg-white/5 text-slate-500 hover:bg-white/10 flex flex-col items-center gap-2 overflow-hidden transition-all">
              <i data-lucide="hourglass" class="w-5 h-5"></i>
              <span class="text-[9px] font-bold uppercase tracking-wider">Реп</span>
            </button>
          </div>

          <input type="text" id="inp-title" placeholder="Название (напр. Свадьба)" class="w-full bg-black/30 border border-white/10 rounded-xl p-4 text-white text-lg focus:border-amber-500/50 outline-none transition-colors text-center font-bold">

          <div>
            <label class="text-[10px] text-slate-500 uppercase font-bold mb-1 block pl-1 text-center">Дата</label>
            <input type="date" id="inp-date" class="w-full bg-black/30 border border-white/10 rounded-xl p-3 text-white outline-none transition-colors focus:border-amber-500/50 text-center text-sm">
          </div>

          <!-- Schedule/Timing List -->
          <div class="bg-white/5 rounded-xl border border-white/10 p-3">
            <label class="text-[10px] text-amber-500 uppercase font-bold mb-2 block text-center">Тайминг Выступлений</label>
            <div id="schedule-list" class="space-y-2 mb-3"></div>
            <button onclick="window.addAct()" class="w-full py-2 rounded-lg bg-white/5 border border-white/10 text-xs text-slate-300 hover:bg-white/10 transition flex items-center justify-center gap-2">
              <i data-lucide="plus" class="w-3 h-3"></i> Добавить выход
            </button>
          </div>

          <div>
            <label class="text-[10px] text-slate-500 uppercase font-bold mb-1 block pl-1 text-center">Локация</label>
            <input type="text" id="inp-location" placeholder="Ресторан..." class="w-full bg-black/30 border border-white/10 rounded-xl p-3 text-white outline-none transition-colors focus:border-amber-500/50 text-center text-sm">
          </div>

          <div class="grid grid-cols-1 gap-3 pt-2 border-t border-white/5">
            <input type="text" id="inp-client-name" placeholder="Имя Клиента" class="w-full bg-black/30 border border-white/10 rounded-xl p-3 text-white outline-none transition-colors focus:border-amber-500/50 text-center text-sm">
            <input type="tel" id="inp-client-phone" placeholder="Телефон" class="w-full bg-black/30 border border-white/10 rounded-xl p-3 text-white outline-none transition-colors focus:border-amber-500/50 text-center text-sm">
          </div>
        </div>

        <div id="tab-setlist" class="hidden space-y-3 max-w-xs mx-auto">
          <div class="flex gap-2">
            <input type="text" id="inp-trick" placeholder="Трюк..." class="flex-1 bg-black/30 border border-white/10 rounded-xl p-3 text-white outline-none">
            <button onclick="window.addTrick()" class="bg-amber-600 px-4 rounded-xl text-white">
              <i data-lucide="plus"></i>
            </button>
          </div>
          <ul id="setlist-container" class="space-y-2 text-sm text-slate-300 pb-4"></ul>
        </div>

        <div id="tab-finance" class="hidden space-y-4 max-w-xs mx-auto">
          <!-- Income -->
          <div class="p-3 bg-emerald-500/5 border border-emerald-500/20 rounded-xl text-center">
            <label class="text-[10px] text-emerald-400 font-bold uppercase block mb-1">Общая стоимость</label>
            <input type="number" id="inp-income" placeholder="0" class="w-full bg-transparent text-2xl font-mono text-white outline-none text-center" oninput="window.calcBalanceFromAmount()">
          </div>

          <!-- Prepay & Balance -->
          <div class="grid grid-cols-2 gap-3">
            <!-- Prepay Amount -->
            <div class="p-3 bg-white/5 border border-white/10 rounded-xl text-center relative group">
              <label class="text-[10px] text-slate-400 font-bold uppercase block mb-1">Предоплата</label>
              <input type="number" id="inp-prepay" placeholder="0" class="w-full bg-transparent text-lg font-mono text-white outline-none text-center" oninput="window.calcBalanceFromAmount()">
            </div>

            <!-- Prepay Percent -->
            <div class="p-3 bg-white/5 border border-white/10 rounded-xl text-center">
              <label class="text-[10px] text-slate-400 font-bold uppercase block mb-1">%</label>
              <input type="number" id="inp-prepay-percent" placeholder="0" class="w-full bg-transparent text-lg font-mono text-amber-400 outline-none text-center" oninput="window.calcBalanceFromPercent()">
            </div>
          </div>

          <!-- Balance Display -->
          <div class="p-3 bg-white/5 border border-white/10 rounded-xl text-center flex flex-col justify-center">
            <label class="text-[10px] text-slate-400 font-bold uppercase block mb-0.5">Остаток</label>
            <span id="txt-balance" class="text-lg font-mono text-slate-500 font-bold">0</span>
          </div>

          <!-- Expense -->
          <div class="p-3 bg-red-500/5 border border-red-500/20 rounded-xl text-center">
            <label class="text-[10px] text-red-400 font-bold uppercase block mb-1">Расход</label>
            <input type="number" id="inp-expense" placeholder="0" class="w-full bg-transparent text-xl font-mono text-white outline-none text-center">
          </div>
        </div>

        <div id="tab-notes" class="hidden max-w-xs mx-auto">
          <textarea id="inp-notes" placeholder="Заметки..." class="w-full h-40 bg-black/30 border border-white/10 rounded-xl p-3 text-white resize-none outline-none text-sm"></textarea>
        </div>
      </div>

      <div class="p-5 border-t border-white/5 bg-slate-900/80 pb-8 md:pb-5 shrink-0 flex flex-col gap-3 items-center">
        <button onclick="window.saveEvent()" class="w-full max-w-xs py-3 rounded-xl bg-gradient-to-r from-amber-500 to-orange-600 text-white font-bold shadow-lg text-lg hover:scale-[1.02] transition">
          Сохранить
        </button>
        <button id="btn-delete" onclick="window.deleteEventFromModal()" class="w-full max-w-xs py-3 rounded-xl border border-red-500/30 text-red-400 font-bold hover:bg-red-500/10 transition hidden">
          Удалить
        </button>
      </div>
    </div>
  </div>

  <!-- SETTINGS MODAL (чтобы кнопка шестерёнки не ломала всё) -->
  <div id="settings-modal" class="fixed inset-0 z-[140] hidden no-hor-scroll flex items-center justify-center p-4">
    <div class="absolute inset-0 bg-slate-950/90 backdrop-blur-sm" onclick="window.closeSettings()"></div>
    <div class="relative w-full max-w-sm bg-[#0f172a] border border-amber-500/20 rounded-2xl shadow-2xl p-6 animate-enter">
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-sm font-bold text-amber-400 uppercase tracking-widest flex items-center gap-2">
          <i data-lucide="settings" class="w-4 h-4"></i> Настройки
        </h3>
        <button onclick="window.closeSettings()" class="p-2 bg-white/5 rounded-full hover:bg-white/10 transition">
          <i data-lucide="x" class="w-4 h-4 text-slate-400"></i>
        </button>
      </div>

      <div class="space-y-3">
        <button onclick="window.editGoal()" class="w-full py-3 rounded-xl bg-white/5 border border-white/10 text-slate-200 hover:bg-white/10 transition font-bold">
          Изменить цель
        </button>

        <button onclick="window.exportData()" class="w-full py-3 rounded-xl bg-white/5 border border-white/10 text-slate-200 hover:bg-white/10 transition font-bold">
          Экспорт данных
        </button>

        <label class="block w-full">
          <input type="file" accept="application/json" class="hidden" id="import-file" onchange="window.importData(this)" />
          <div class="w-full py-3 rounded-xl bg-white/5 border border-white/10 text-slate-200 hover:bg-white/10 transition font-bold text-center cursor-pointer">
            Импорт данных
          </div>
        </label>

        <p class="text-[11px] text-slate-500 leading-snug">
          Экспорт/импорт — чтобы не потерять магию, если Safari решит «а давай всё забудем».
        </p>
      </div>
    </div>
  </div>

  <!-- MONTH PICKER MODAL -->
  <div id="month-picker-modal" class="fixed inset-0 z-[130] hidden no-hor-scroll flex items-center justify-center p-4">
    <div class="absolute inset-0 bg-slate-950/90 backdrop-blur-sm" onclick="window.closeMonthPicker()"></div>
    <div class="relative w-full max-w-sm bg-[#0f172a] border border-amber-500/20 rounded-2xl shadow-2xl p-6 animate-enter flex flex-col items-center">
      <div class="flex items-center justify-between w-full mb-6">
        <button onclick="window.changePickerYear(-1)" class="p-2 hover:bg-white/10 rounded-lg text-slate-400 hover:text-white transition">
          <i data-lucide="chevron-left" class="w-6 h-6"></i>
        </button>
        <span id="picker-year-display" class="text-2xl font-display font-bold text-white tracking-widest">2024</span>
        <button onclick="window.changePickerYear(1)" class="p-2 hover:bg-white/10 rounded-lg text-slate-400 hover:text-white transition">
          <i data-lucide="chevron-right" class="w-6 h-6"></i>
        </button>
      </div>

      <div class="grid grid-cols-3 gap-3 w-full">
        <button onclick="window.selectMonth(0)" class="month-btn p-3 rounded-xl border border-white/5 bg-white/5 text-slate-300 hover:bg-amber-500/20 hover:border-amber-500/50 hover:text-amber-400 transition font-bold text-sm">ЯНВ</button>
        <button onclick="window.selectMonth(1)" class="month-btn p-3 rounded-xl border border-white/5 bg-white/5 text-slate-300 hover:bg-amber-500/20 hover:border-amber-500/50 hover:text-amber-400 transition font-bold text-sm">ФЕВ</button>
        <button onclick="window.selectMonth(2)" class="month-btn p-3 rounded-xl border border-white/5 bg-white/5 text-slate-300 hover:bg-amber-500/20 hover:border-amber-500/50 hover:text-amber-400 transition font-bold text-sm">МАР</button>
        <button onclick="window.selectMonth(3)" class="month-btn p-3 rounded-xl border border-white/5 bg-white/5 text-slate-300 hover:bg-amber-500/20 hover:border-amber-500/50 hover:text-amber-400 transition font-bold text-sm">АПР</button>
        <button onclick="window.selectMonth(4)" class="month-btn p-3 rounded-xl border border-white/5 bg-white/5 text-slate-300 hover:bg-amber-500/20 hover:border-amber-500/50 hover:text-amber-400 transition font-bold text-sm">МАЙ</button>
        <button onclick="window.selectMonth(5)" class="month-btn p-3 rounded-xl border border-white/5 bg-white/5 text-slate-300 hover:bg-amber-500/20 hover:border-amber-500/50 hover:text-amber-400 transition font-bold text-sm">ИЮН</button>
        <button onclick="window.selectMonth(6)" class="month-btn p-3 rounded-xl border border-white/5 bg-white/5 text-slate-300 hover:bg-amber-500/20 hover:border-amber-500/50 hover:text-amber-400 transition font-bold text-sm">ИЮЛ</button>
        <button onclick="window.selectMonth(7)" class="month-btn p-3 rounded-xl border border-white/5 bg-white/5 text-slate-300 hover:bg-amber-500/20 hover:border-amber-500/50 hover:text-amber-400 transition font-bold text-sm">АВГ</button>
        <button onclick="window.selectMonth(8)" class="month-btn p-3 rounded-xl border border-white/5 bg-white/5 text-slate-300 hover:bg-amber-500/20 hover:border-amber-500/50 hover:text-amber-400 transition font-bold text-sm">СЕН</button>
        <button onclick="window.selectMonth(9)" class="month-btn p-3 rounded-xl border border-white/5 bg-white/5 text-slate-300 hover:bg-amber-500/20 hover:border-amber-500/50 hover:text-amber-400 transition font-bold text-sm">ОКТ</button>
        <button onclick="window.selectMonth(10)" class="month-btn p-3 rounded-xl border border-white/5 bg-white/5 text-slate-300 hover:bg-amber-500/20 hover:border-amber-500/50 hover:text-amber-400 transition font-bold text-sm">НОЯ</button>
        <button onclick="window.selectMonth(11)" class="month-btn p-3 rounded-xl border border-white/5 bg-white/5 text-slate-300 hover:bg-amber-500/20 hover:border-amber-500/50 hover:text-amber-400 transition font-bold text-sm">ДЕК</button>
      </div>

      <button onclick="window.closeMonthPicker()" class="mt-8 text-slate-500 text-xs hover:text-white transition">Закрыть</button>
    </div>
  </div>

  <script>
    // --- CONSTANTS ---
    const MONTHS = ["Январь","Февраль","Март","Апрель","Май","Июнь","Июль","Август","Сентябрь","Октябрь","Ноябрь","Декабрь"];
    const TYPES = {
      'stage':    { label:'Сцена',      color:'event-stage',    text:'text-amber-100',  icon:'star',      border:'border-amber-500',   bar:'bg-amber-500' },
      'closeup':  { label:'Микромагия', color:'event-closeup',  text:'text-purple-100', icon:'sparkles',  border:'border-purple-500',  bar:'bg-purple-500' },
      'kids':     { label:'Детское шоу',color:'event-kids',     text:'text-emerald-100',icon:'rabbit',    border:'border-emerald-500', bar:'bg-emerald-500' },
      'concert':  { label:'Концерт',    color:'event-concert',  text:'text-blue-100',   icon:'mic-2',     border:'border-blue-500',    bar:'bg-blue-500' },
      'rehearsal':{ label:'Репетиция',  color:'event-rehearsal',text:'text-slate-200',  icon:'hourglass', border:'border-slate-500',   bar:'bg-slate-500' }
    };
    const pad2 = (n)=>String(n).padStart(2,'0');
    const toISODateLocal = (d)=>`${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;

    // --- STATE ---
    let currentDate = new Date();
    let selectedDate = new Date();
    let pickerYear = new Date().getFullYear();
    let events = [];
    let monthlyGoal = 200000;
    let goalCelebrated = false;

    let currentType = 'stage';
    let currentSetlist = [];
    let currentSchedule = [];
    let editingId = null;

    // --- RENDER FUNCTIONS ---
    function renderApp(){
      renderCalendar();
      renderSidebar();
      renderStats();
      renderAnalytics();
      lucide.createIcons();
    }

    function renderCalendar(){
      const year = currentDate.getFullYear();
      const month = currentDate.getMonth();
      document.getElementById('current-month-display').innerText = `${MONTHS[month]} ${year}`;

      const daysInMonth = new Date(year, month+1, 0).getDate();
      const firstDayIndex = new Date(year, month, 1).getDay();
      const adjustedFirstDay = firstDayIndex === 0 ? 6 : firstDayIndex - 1;

      const grid = document.getElementById('calendar-grid');
      grid.innerHTML = '';

      for(let i=0;i<adjustedFirstDay;i++) grid.innerHTML += `<div></div>`;

      const selectedISO = toISODateLocal(selectedDate);
      const todayISO = toISODateLocal(new Date());

      for(let d=1; d<=daysInMonth; d++){
        const dateISO = `${year}-${pad2(month+1)}-${pad2(d)}`;
        const isSelected = dateISO === selectedISO;
        const isToday = dateISO === todayISO;
        const isLastDay = d === daysInMonth;

        const dayEvents = events.filter(e => e.dateISO === dateISO);
        const dayProfit = dayEvents.reduce((acc, curr) => acc + (Number(curr.income)||0), 0);

        let eventLabels = '';
        const sliceCount = isLastDay ? 2 : 3;
        dayEvents.slice(0, sliceCount).forEach(e=>{
          const primaryType = (e.schedule && e.schedule[0]) ? e.schedule[0].type : (e.type || 'stage');
          const typeConfig = TYPES[primaryType] || TYPES.stage;
          eventLabels += `<div onclick="event.stopPropagation(); window.editEvent(${e.id})" class="event-label ${typeConfig.color} ${typeConfig.text} border-b ${typeConfig.border}/20 shadow-sm">${typeConfig.label}</div>`;
        });

        let profitHtml = dayProfit > 0
          ? `<span class="hidden md:block absolute top-1 right-1 text-[8px] text-emerald-400 bg-emerald-500/10 px-1 rounded font-mono">+${(dayProfit/1000).toFixed(0)}k</span>`
          : '';

        let summaryHtml = '';
        if (isLastDay){
          summaryHtml = `<div class="month-summary">ИТОГ</div>`;
        }

        const cell = document.createElement('div');
        cell.className = `calendar-cell relative cursor-pointer aspect-[4/5] md:aspect-[3/4] min-h-[70px] ${isSelected ? 'selected' : ''} ${isToday ? 'today' : ''}`;
        cell.onclick = ()=>{
          selectedDate = new Date(year, month, d);
          renderCalendar();
          renderSidebar();
          window.openModal(false);
        };

        cell.innerHTML = `
          <div class="date-number">${d}</div>
          ${profitHtml}
          <div class="calendar-cell-content">${eventLabels}</div>
          ${summaryHtml}
        `;
        grid.appendChild(cell);
      }
    }

    function renderSidebar(){
      const dateISO = toISODateLocal(selectedDate);
      document.getElementById('selected-date-big').innerText = selectedDate.getDate();
      document.getElementById('selected-weekday').innerText = selectedDate.toLocaleDateString('ru-RU',{weekday:'long',month:'long'});

      const list = document.getElementById('events-list');
      list.innerHTML = '';

      const dayEvents = events
        .filter(e => e.dateISO === dateISO)
        .sort((a,b)=>(a.time||'').localeCompare(b.time||''));

      if(dayEvents.length===0){
        list.innerHTML = `<div class="h-40 flex flex-col items-center justify-center text-slate-600 space-y-2 opacity-50">
          <i data-lucide="wand-2" class="w-10 h-10"></i><p class="text-sm">Нет шоу</p>
        </div>`;
      } else {
        dayEvents.forEach(e=>{
          const primaryType = (e.schedule && e.schedule[0]) ? e.schedule[0].type : (e.type || 'stage');
          const profit = Number(e.income) > 0
            ? `<div class="flex items-center gap-1 text-emerald-400 text-xs font-mono font-bold"><i data-lucide="banknote" class="w-3 h-3"></i> +${Number(e.income).toLocaleString('ru-RU')}</div>`
            : '';

          const el = document.createElement('div');
          el.className = 'group relative bg-white/5 rounded-xl p-3 border border-white/5 hover:border-amber-500/30 transition animate-enter cursor-pointer';
          el.onclick = ()=>window.editEvent(e.id);

          // Schedule List (с длительностью)
          let scheduleBlock = '<div class="flex flex-col gap-1 mb-2">';
          if (e.schedule && e.schedule.length > 0){
            e.schedule.forEach(act=>{
              const actConfig = TYPES[act.type] || TYPES.stage;
              const dur = Number(act.duration)||0;
              scheduleBlock += `
                <div class="flex justify-between items-center text-xs">
                  <span class="flex items-center gap-1 text-slate-300">
                    <i data-lucide="${actConfig.icon}" class="w-3 h-3 text-slate-500"></i> ${actConfig.label}
                  </span>
                  <span class="font-mono text-amber-500">${act.time}${dur>0 ? ` • ${dur}м` : ''}</span>
                </div>
              `;
            });
          }
          scheduleBlock += '</div>';

          let clientBlock = '';
          if(e.clientName || e.clientPhone){
            clientBlock = `<div class="mt-2 pt-2 border-t border-white/5 flex flex-col gap-1">`;
            if(e.clientName) clientBlock += `<div class="flex items-center gap-2 text-xs text-slate-300"><i data-lucide="user" class="w-3 h-3 text-slate-500"></i> ${e.clientName}</div>`;
            if(e.clientPhone) clientBlock += `<a href="tel:${e.clientPhone}" onclick="event.stopPropagation()" class="flex items-center gap-2 text-xs text-amber-400 hover:text-amber-300"><i data-lucide="phone" class="w-3 h-3"></i> ${e.clientPhone}</a>`;
            clientBlock += `</div>`;
          }

          let notesBlock = '';
          if(e.notes){
            notesBlock = `<div class="mt-2 text-xs text-slate-500 italic line-clamp-2 pl-4 border-l-2 border-white/10">${e.notes}</div>`;
          }

          let balanceBlock = '';
          const income = Number(e.income) || 0;
          const prepay = Number(e.prepay) || 0;
          if(income>0){
            const bal = income - prepay;
            if(bal>0) balanceBlock = `<div class="text-[9px] text-amber-500/80 font-mono mt-1 text-right">Остаток: ${bal.toLocaleString('ru-RU')}</div>`;
            else if(prepay>0) balanceBlock = `<div class="text-[9px] text-slate-500/80 font-mono mt-1 text-right">Оплачено</div>`;
          }

          const stripColor =
            primaryType==='stage' ? 'bg-amber-500' :
            primaryType==='closeup' ? 'bg-purple-500' :
            primaryType==='kids' ? 'bg-emerald-500' :
            primaryType==='concert' ? 'bg-blue-500' : 'bg-slate-500';

          el.innerHTML = `
            <div class="absolute left-0 top-3 bottom-3 w-1 rounded-r ${stripColor}"></div>
            <div class="pl-3">
              ${scheduleBlock}
              <h4 class="text-white font-display font-semibold text-base leading-tight mb-1">${e.title}</h4>
              ${e.location ? `<div class="text-xs text-slate-400 flex items-center gap-1 mb-1"><i data-lucide="map-pin" class="w-3 h-3"></i> ${e.location}</div>` : ''}
              ${clientBlock}
              ${notesBlock}
              <div class="flex justify-between items-center pt-2 border-t border-white/5 mt-2">
                <div>
                  ${profit}
                  ${balanceBlock}
                </div>
                <button onclick="event.stopPropagation(); window.deleteEvent('${e.id}')" class="text-slate-600 hover:text-red-400 p-1">
                  <i data-lucide="trash-2" class="w-4 h-4"></i>
                </button>
              </div>
            </div>
          `;
          list.appendChild(el);
        });
      }
      lucide.createIcons();
    }

    function renderSetlist(){
      const ul = document.getElementById('setlist-container');
      if(currentSetlist.length===0){
        ul.innerHTML = '<li class="text-center text-slate-600 text-xs italic py-4">Список пуст</li>';
        return;
      }
      ul.innerHTML = '';
      currentSetlist.forEach((t,i)=>{
        ul.innerHTML += `<li class="flex justify-between bg-white/5 p-2 rounded border border-white/5">
          <span><span class="text-amber-500 mr-2">${i+1}.</span>${t}</span>
          <button onclick="currentSetlist.splice(${i},1); renderSetlist()" class="text-red-400 hover:text-white"><i data-lucide="x" class="w-3 h-3"></i></button>
        </li>`;
      });
      lucide.createIcons();
    }

    function renderStats(){
      const year = currentDate.getFullYear();
      const month = currentDate.getMonth() + 1;

      const monthEvents = events.filter(e=>{
        if(!e.dateISO) return false;
        const [y,m] = e.dateISO.split('-').map(Number);
        return y===year && m===month;
      });

      const income = monthEvents.reduce((acc,c)=>acc+(Number(c.income)||0),0);
      const expense = monthEvents.reduce((acc,c)=>acc+(Number(c.expense)||0),0);
      const profit = income - expense;

      document.getElementById('stat-profit').innerText = profit.toLocaleString('ru-RU');
      document.getElementById('stat-income').innerText = `+${income.toLocaleString('ru-RU')}`;
      document.getElementById('stat-expense').innerText = `-${expense.toLocaleString('ru-RU')}`;
      document.getElementById('goal-amount').innerText = `${(monthlyGoal/1000).toFixed(0)}k ₽`;

      const pct = monthlyGoal>0 ? Math.min(100, Math.round((profit/monthlyGoal)*100)) : 0;
      const goalBar = document.getElementById('goal-progress');

      if(pct>=100){
        goalBar.className = "h-full bg-gradient-to-r from-emerald-400 to-green-500 transition-all duration-1000 animate-pulse";
        document.getElementById('goal-badge').classList.remove('hidden');
        if(!goalCelebrated){
          window.celebrateGoal();
          goalCelebrated = true;
        }
      } else {
        goalBar.className = "h-full bg-gradient-to-r from-amber-700 to-yellow-400 transition-all duration-1000";
        document.getElementById('goal-badge').classList.add('hidden');
        goalCelebrated = false;
      }
      goalBar.style.width = `${pct}%`;
    }

    function renderAnalytics(){
      const container = document.getElementById('analytics-list');
      if(!container) return;

      const year = currentDate.getFullYear();
      const month = currentDate.getMonth() + 1;

      const monthEvents = events.filter(e=>{
        if(!e.dateISO) return false;
        const [y,m] = e.dateISO.split('-').map(Number);
        return y===year && m===month;
      });

      const stats = {};
      Object.keys(TYPES).forEach(k=>stats[k] = { count:0, income:0, ...TYPES[k] });
      let totalCount = 0;

      monthEvents.forEach(e=>{
        const inc = Number(e.income)||0;
        if(e.schedule && e.schedule.length>0){
          const prim = e.schedule[0].type;
          if(stats[prim]) stats[prim].income += inc;
          e.schedule.forEach(act=>{
            if(stats[act.type]){ stats[act.type].count++; totalCount++; }
          });
        }
      });

      container.innerHTML = '';
      if(totalCount===0){
        container.innerHTML = '<div class="text-center text-slate-500 text-xs py-2">Нет данных за этот месяц</div>';
        return;
      }

      const sorted = Object.entries(stats).map(([k,v])=>({key:k,...v})).sort((a,b)=>b.count-a.count);
      sorted.forEach(item=>{
        if(item.count===0) return;
        const pct = Math.round((item.count/totalCount)*100);
        container.innerHTML += `
          <div class="flex flex-col gap-1">
            <div class="flex justify-between text-[10px] text-slate-300">
              <span class="flex items-center gap-1"><i data-lucide="${item.icon}" class="w-3 h-3 text-slate-400"></i> ${item.label}</span>
              <span class="font-mono opacity-80">${item.count} (${pct}%)</span>
            </div>
            <div class="h-1.5 w-full bg-white/5 rounded-full overflow-hidden">
              <div class="h-full ${item.bar || 'bg-slate-500'}" style="width:${pct}%"></div>
            </div>
            <div class="text-[8px] text-slate-500 text-right">
              ${item.income>0 ? '+' + item.income.toLocaleString('ru-RU') + ' ₽' : ''}
            </div>
          </div>
        `;
      });

      lucide.createIcons();
    }

    // --- SCHEDULE LOGIC (добавили duration) ---
    window.renderSchedule = () => {
      const list = document.getElementById('schedule-list');
      list.innerHTML = '';

      currentSchedule.forEach((item,index)=>{
        const row = document.createElement('div');
        row.className = 'act-row';

        const typeKeys = Object.keys(TYPES);
        const currentTypeIdx = typeKeys.indexOf(item.type);
        const nextType = typeKeys[(currentTypeIdx + 1) % typeKeys.length];
        const tConfig = TYPES[item.type] || TYPES.stage;

        const dur = Number(item.duration)||60;

        row.innerHTML = `
          <button onclick="window.updateActType(${index}, '${nextType}')" class="w-8 h-8 rounded-lg bg-white/5 border border-white/10 flex items-center justify-center hover:bg-white/10 transition" title="${tConfig.label}">
            <i data-lucide="${tConfig.icon}" class="w-4 h-4 ${tConfig.text}"></i>
          </button>

          <input type="time" value="${item.time}" onchange="window.updateActTime(${index}, this.value)" class="bg-transparent text-white text-sm font-mono text-center outline-none w-full">

          <div class="act-dur" title="Длительность (мин)">
            <input type="number" min="1" max="600" value="${dur}" onchange="window.updateActDuration(${index}, this.value)" />
            <span>мин</span>
          </div>

          <button onclick="window.removeAct(${index})" class="text-red-400 hover:text-white flex items-center justify-center">
            <i data-lucide="x" class="w-4 h-4"></i>
          </button>
        `;
        list.appendChild(row);
      });

      lucide.createIcons();
    };

    window.addAct = () => {
      currentSchedule.push({ type: 'stage', time: '19:00', duration: 60 });
      window.renderSchedule();
    };

    window.removeAct = (index) => {
      currentSchedule.splice(index,1);
      window.renderSchedule();
    };

    window.updateActType = (index, newType) => {
      currentSchedule[index].type = newType;
      window.renderSchedule();
    };

    window.updateActTime = (index, newTime) => {
      currentSchedule[index].time = newTime;
    };

    window.updateActDuration = (index, newDuration) => {
      const n = Number(newDuration);
      currentSchedule[index].duration = (Number.isFinite(n) && n > 0) ? Math.round(n) : 60;
    };

    // --- MONTH PICKER LOGIC ---
    window.openMonthPicker = () => {
      pickerYear = currentDate.getFullYear();
      document.getElementById('picker-year-display').innerText = pickerYear;
      document.getElementById('month-picker-modal').classList.remove('hidden');
      window.highlightCurrentMonth();
    };

    window.closeMonthPicker = () => {
      document.getElementById('month-picker-modal').classList.add('hidden');
    };

    window.changePickerYear = (delta) => {
      pickerYear += delta;
      document.getElementById('picker-year-display').innerText = pickerYear;
      window.highlightCurrentMonth();
    };

    window.selectMonth = (monthIndex) => {
      currentDate = new Date(pickerYear, monthIndex, 1);
      selectedDate = new Date(pickerYear, monthIndex, 1);
      renderApp();
      window.closeMonthPicker();
    };

    window.highlightCurrentMonth = () => {
      const btns = document.querySelectorAll('.month-btn');
      btns.forEach((btn, idx) => {
        if (pickerYear === currentDate.getFullYear() && idx === currentDate.getMonth()) {
          btn.classList.add('bg-amber-500','text-black','border-amber-500');
          btn.classList.remove('bg-white/5','text-slate-300','border-white/5');
        } else {
          btn.classList.remove('bg-amber-500','text-black','border-amber-500');
          btn.classList.add('bg-white/5','text-slate-300','border-white/5');
        }
      });
    };

    // --- HELPERS ---
    function migrateEventsToISO(list){
      let changed = false;
      const out = (Array.isArray(list) ? list : []).map(ev=>{
        const e = { ...ev };

        e.income = Number(e.income) || 0;
        e.expense = Number(e.expense) || 0;
        e.prepay = Number(e.prepay) || 0;

        // schedule обязателен, теперь ещё и duration
        if(!e.schedule){
          e.schedule = [{
            type: e.type || 'stage',
            time: e.time || '19:00',
            duration: (Number(e.duration)||60)
          }];
          changed = true;
        } else {
          // добить duration, если старые события без него
          e.schedule = e.schedule.map(a=>({
            type: a.type || 'stage',
            time: a.time || '19:00',
            duration: Number(a.duration) || 60
          }));
        }

        if(e.dateISO && /^\d{4}-\d{2}-\d{2}$/.test(e.dateISO)) return e;

        if(typeof e.date === 'string'){
          if(/^\d{4}-\d{2}-\d{2}$/.test(e.date)){
            e.dateISO = e.date;
            changed = true;
            return e;
          }
          const parsed = new Date(e.date);
          if(!isNaN(parsed)){
            e.dateISO = toISODateLocal(parsed);
            changed = true;
            return e;
          }
        }

        e.dateISO = e.dateISO || toISODateLocal(new Date());
        changed = true;
        return e;
      });
      return { out, changed };
    }

    function loadLocalData(){
      try{
        const rawEvents = JSON.parse(localStorage.getItem('illusionist_events') || '[]');
        const mig = migrateEventsToISO(rawEvents);
        events = mig.out;
        monthlyGoal = Number(JSON.parse(localStorage.getItem('illusionist_goal') || '200000')) || 200000;
        if(mig.changed) localStorage.setItem('illusionist_events', JSON.stringify(events));
      } catch(e){
        events = [];
      }
      renderApp();
    }

    // --- SETTINGS ---
    window.openSettings = () => document.getElementById('settings-modal').classList.remove('hidden');
    window.closeSettings = () => document.getElementById('settings-modal').classList.add('hidden');

    window.exportData = () => {
      const dateStr = new Date().toISOString().split('T')[0];
      const data = { events, goal: monthlyGoal, version: '1.5' };
      const blob = new Blob([JSON.stringify(data, null, 2)], {type:'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `IllusionistOS_Calendar_Backup_${dateStr}.json`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      window.showToast('Архив скачан!');
    };

    window.importData = (input) => {
      const file = input.files[0];
      if(!file) return;
      const reader = new FileReader();
      reader.onload = (e) => {
        try{
          const data = JSON.parse(e.target.result);
          if(data.events){
            const mig = migrateEventsToISO(data.events);
            events = mig.out;
            localStorage.setItem('illusionist_events', JSON.stringify(events));
          }
          if(data.goal !== undefined){
            monthlyGoal = Number(data.goal) || monthlyGoal;
            localStorage.setItem('illusionist_goal', JSON.stringify(monthlyGoal));
          }
          renderApp();
          window.closeSettings();
          window.showToast('Данные восстановлены!');
        } catch(err){
          window.showToast('Ошибка файла');
        }
      };
      reader.readAsText(file);
    };

    // --- NAV / MONTH ---
    window.changeMonth = (delta) => {
      const y = currentDate.getFullYear();
      const m = currentDate.getMonth();
      currentDate = new Date(y, m + delta, 1);

      // чтобы всё синхронно и на всех устройствах
      selectedDate = new Date(currentDate.getFullYear(), currentDate.getMonth(), 1);
      renderApp();
    };

    window.goToToday = () => {
      const now = new Date();
      currentDate = new Date(now.getFullYear(), now.getMonth(), 1);
      selectedDate = now;
      renderApp();
    };

    window.switchMobileTab = (tab) => {
      const calView = document.getElementById('view-calendar');
      const dashView = document.getElementById('view-dashboard');
      const calNav = document.getElementById('nav-calendar');
      const dashNav = document.getElementById('nav-dashboard');

      if(tab === 'calendar'){
        calView.classList.remove('mobile-hidden');
        dashView.classList.add('mobile-hidden');
        calNav.classList.add('text-amber-400');
        calNav.classList.remove('text-slate-500');
        dashNav.classList.remove('text-amber-400');
        dashNav.classList.add('text-slate-500');
      } else {
        calView.classList.add('mobile-hidden');
        dashView.classList.remove('mobile-hidden');
        dashNav.classList.add('text-amber-400');
        dashNav.classList.remove('text-slate-500');
        calNav.classList.remove('text-amber-400');
        calNav.classList.add('text-slate-500');
      }
    };

    // --- MODAL ---
    window.openModal = (isEdit=false) => {
      document.getElementById('event-modal').classList.remove('hidden');
      document.getElementById('modal-title').innerText = isEdit ? 'Редактировать' : 'Новое Событие';
      const dateInput = document.getElementById('inp-date');

      if(!isEdit){
        editingId = null;
        document.getElementById('btn-delete').classList.add('hidden');

        document.getElementById('inp-title').value = '';
        document.getElementById('inp-location').value = '';
        document.getElementById('inp-client-name').value = '';
        document.getElementById('inp-client-phone').value = '';
        document.getElementById('inp-income').value = '';
        document.getElementById('inp-prepay').value = '';
        document.getElementById('inp-prepay-percent').value = '';
        document.getElementById('inp-expense').value = '';
        document.getElementById('inp-notes').value = '';
        document.getElementById('txt-balance').innerText = '0';

        currentSetlist = [];
        currentSchedule = [{ type:'stage', time:'19:00', duration:60 }];
        currentType = 'stage';
        dateInput.value = toISODateLocal(selectedDate);
      } else {
        document.getElementById('btn-delete').classList.remove('hidden');
      }

      window.renderSetlist();
      window.renderSchedule();
      window.switchTab('info');
      window.setType(currentType || 'stage');
    };

    window.closeModal = () => document.getElementById('event-modal').classList.add('hidden');

    window.switchTab = (tab) => {
      ['info','setlist','finance','notes'].forEach(t=>{
        document.getElementById(`tab-${t}`).classList.add('hidden');
        document.getElementById(`tab-btn-${t}`).className = "flex-1 py-2 text-[10px] font-bold uppercase text-slate-500 rounded transition";
      });
      document.getElementById(`tab-${tab}`).classList.remove('hidden');
      document.getElementById(`tab-btn-${tab}`).className = "tab-active flex-1 py-2 text-[10px] font-bold uppercase rounded transition";
    };

    window.setType = (type) => {
      currentType = type;
      document.querySelectorAll('.type-btn').forEach(b=>{
        b.classList.remove('selected');
        b.classList.remove('border-amber-500','bg-amber-500/10','text-amber-400');
        b.classList.remove('border-purple-500','bg-purple-500/10','text-purple-400');
        b.classList.remove('border-emerald-500','bg-emerald-500/10','text-emerald-400');
        b.classList.remove('border-blue-500','bg-blue-500/10','text-blue-400');
        b.classList.remove('border-slate-500','bg-slate-500/10','text-slate-300');
        b.classList.add('border-white/5','bg-white/5','text-slate-500');
      });
      const activeBtn = document.getElementById(`type-${type}`);
      if(activeBtn){
        activeBtn.classList.add('selected');
        activeBtn.classList.remove('border-white/5','bg-white/5','text-slate-500');
        if(type==='stage') activeBtn.classList.add('border-amber-500','bg-amber-500/10','text-amber-400');
        else if(type==='closeup') activeBtn.classList.add('border-purple-500','bg-purple-500/10','text-purple-400');
        else if(type==='kids') activeBtn.classList.add('border-emerald-500','bg-emerald-500/10','text-emerald-400');
        else if(type==='concert') activeBtn.classList.add('border-blue-500','bg-blue-500/10','text-blue-400');
        else if(type==='rehearsal') activeBtn.classList.add('border-slate-500','bg-slate-500/10','text-slate-300');
      }
    };

    window.addTrick = () => {
      const val = document.getElementById('inp-trick').value;
      if(val){
        currentSetlist.push(val);
        document.getElementById('inp-trick').value = '';
        window.renderSetlist();
      }
    };

    window.editEvent = (id) => {
      const ev = events.find(e=>e.id===id);
      if(!ev) return;

      editingId = id;
      document.getElementById('inp-title').value = ev.title || '';
      document.getElementById('inp-location').value = ev.location || '';
      document.getElementById('inp-client-name').value = ev.clientName || '';
      document.getElementById('inp-client-phone').value = ev.clientPhone || '';
      document.getElementById('inp-income').value = ev.income || '';
      document.getElementById('inp-prepay').value = ev.prepay || '';
      document.getElementById('inp-expense').value = ev.expense || '';
      document.getElementById('inp-notes').value = ev.notes || '';

      currentSetlist = ev.setlist || [];
      currentSchedule = (ev.schedule && ev.schedule.length)
        ? ev.schedule.map(a=>({ type:a.type||'stage', time:a.time||'19:00', duration:Number(a.duration)||60 }))
        : [{ type: ev.type || 'stage', time: ev.time || '19:00', duration: 60 }];

      currentType = currentSchedule[0].type;
      document.getElementById('inp-date').value = ev.dateISO || toISODateLocal(new Date());

      window.calcBalanceFromAmount();
      window.renderSchedule();
      window.openModal(true);
    };

    window.saveEvent = async () => {
      const title = document.getElementById('inp-title').value.trim();
      const dateISO = document.getElementById('inp-date').value;

      if(!title){ window.showToast('Введите название!'); return; }
      if(!dateISO){ window.showToast('Выберите дату!'); return; }
      if(currentSchedule.length===0){ window.showToast('Добавьте хотя бы один выход!'); return; }

      const [y,m,d] = dateISO.split('-').map(Number);
      const eventDateObj = new Date(y, m-1, d);
      const primary = currentSchedule[0];

      const eventData = {
        title,
        time: primary.time,
        type: primary.type,
        schedule: currentSchedule.map(a=>({
          type: a.type || 'stage',
          time: a.time || '19:00',
          duration: Number(a.duration) || 60
        })),
        location: document.getElementById('inp-location').value,
        clientName: document.getElementById('inp-client-name').value,
        clientPhone: document.getElementById('inp-client-phone').value,
        income: Number(document.getElementById('inp-income').value) || 0,
        prepay: Number(document.getElementById('inp-prepay').value) || 0,
        expense: Number(document.getElementById('inp-expense').value) || 0,
        notes: document.getElementById('inp-notes').value,
        setlist: currentSetlist,
        dateISO
      };

      if(editingId){
        events = events.map(e=>e.id===editingId ? { ...e, ...eventData } : e);
        window.showToast('Обновлено!');
      } else {
        events.push({ id: Date.now(), ...eventData });
        window.showToast('Магия создана!');
      }

      localStorage.setItem('illusionist_events', JSON.stringify(events));
      selectedDate = eventDateObj;
      currentDate = new Date(selectedDate.getFullYear(), selectedDate.getMonth(), 1);
      window.closeModal();
      renderApp();
    };

    window.deleteEvent = (id) => {
      const numId = Number(id);
      if(!confirm('Удалить событие?')) return;
      events = events.filter(e=>e.id!==numId);
      localStorage.setItem('illusionist_events', JSON.stringify(events));
      renderApp();
      window.showToast('Удалено');
    };

    window.deleteEventFromModal = () => {
      if(editingId){
        if(!confirm('Удалить это событие?')) return;
        events = events.filter(e=>e.id!==editingId);
        localStorage.setItem('illusionist_events', JSON.stringify(events));
        renderApp();
        window.closeModal();
        window.showToast('Событие удалено');
      }
    };

    // --- TOAST ---
    window.showToast = (msg) => {
      const t = document.getElementById('toast');
      const m = document.getElementById('toast-msg');
      if(!t || !m) return;

      m.innerText = msg;
      t.classList.remove('opacity-0','-translate-y-4');
      t.classList.add('translate-y-0','opacity-100');

      clearTimeout(window.__toastTimer);
      window.__toastTimer = setTimeout(()=>{
        t.classList.add('opacity-0','-translate-y-4');
        t.classList.remove('translate-y-0','opacity-100');
      }, 2800);
    };

    window.celebrateGoal = () => {
      const container = document.getElementById('confetti-container');
      const colors = ['#f59e0b','#10b981','#3b82f6','#8b5cf6','#f43f5e'];
      for(let i=0;i<50;i++){
        const el = document.createElement('div');
        el.className = 'confetti';
        el.style.left = (Math.random()*100)+'vw';
        el.style.top = '-10px';
        el.style.backgroundColor = colors[Math.floor(Math.random()*colors.length)];
        el.style.animationDuration = (Math.random()*3 + 2) + 's';
        el.style.opacity = Math.random();
        container.appendChild(el);
        setTimeout(()=>el.remove(), 5000);
      }
      window.showToast('🎉 Цель достигнута! Так держать!');
    };

    // --- FIX: Goal editing + prepay% balance (на айфоне кликается и считается) ---
    function _num(v){
      if(v===null || v===undefined) return 0;
      const s = String(v).replace(/\s/g,'').replace(',','.');
      const n = Number(s);
      return Number.isFinite(n) ? n : 0;
    }
    function _clamp(n,a,b){ return Math.max(a, Math.min(b,n)); }

    window.editGoal = () => {
      const current = Number(monthlyGoal) || 0;
      const input = prompt('Цель на месяц (₽). Можно: 200000 или 200k', current ? String(current) : '200000');
      if(input===null) return;

      const raw = String(input).trim().toLowerCase();
      let value = 0;
      if(raw.endsWith('k')) value = _num(raw.slice(0,-1)) * 1000;
      else if(raw.endsWith('m')) value = _num(raw.slice(0,-1)) * 1000000;
      else value = _num(raw);

      value = Math.round(value);
      if(!Number.isFinite(value) || value < 0) return;

      monthlyGoal = value;
      localStorage.setItem('illusionist_goal', JSON.stringify(monthlyGoal));
      goalCelebrated = false;
      renderStats();
      window.showToast('Цель обновлена');
    };

    window.updateBalanceDisplay = (total, prepay) => {
      const balance = total - prepay;
      const balEl = document.getElementById('txt-balance');
      if(!balEl) return;

      if(balance <= 0 && total > 0){
        balEl.innerText = "Оплачено";
        balEl.className = "text-lg font-mono text-slate-500 font-bold";
      } else {
        balEl.innerText = balance.toLocaleString('ru-RU') + ' ₽';
        balEl.className = "text-lg font-mono text-amber-400 font-bold";
      }
    };

    window.calcBalanceFromAmount = () => {
      const total = Math.max(0, Math.round(_num(document.getElementById('inp-income').value)));
      const prepay = Math.max(0, Math.round(_num(document.getElementById('inp-prepay').value)));

      const percentEl = document.getElementById('inp-prepay-percent');
      if(total > 0){
        const pct = _clamp((prepay / total) * 100, 0, 100);
        percentEl.value = Math.round(pct * 10) / 10;
      } else {
        percentEl.value = '';
      }
      window.updateBalanceDisplay(total, prepay);
    };

    window.calcBalanceFromPercent = () => {
      const total = Math.max(0, Math.round(_num(document.getElementById('inp-income').value)));
      const pct = _clamp(_num(document.getElementById('inp-prepay-percent').value), 0, 100);

      const prepay = total > 0 ? Math.round(total * (pct/100)) : 0;
      document.getElementById('inp-prepay').value = prepay ? String(prepay) : '';

      window.updateBalanceDisplay(total, prepay);
    };

    // --- PARTICLES ---
    let particleRAF = null;
    let particleState = { running:false, ctx:null, canvas:null, particles:[] };

    function initParticles(){
      const reduce = window.matchMedia && window.matchMedia('(prefers-reduced-motion: reduce)').matches;
      if(reduce) return;

      const canvas = document.getElementById('bg-canvas');
      const ctx = canvas.getContext('2d');
      particleState.canvas = canvas;
      particleState.ctx = ctx;

      function resize(){
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
      }
      window.addEventListener('resize', resize);
      resize();

      particleState.particles = [];
      for(let i=0;i<60;i++){
        particleState.particles.push({
          x: Math.random()*canvas.width,
          y: Math.random()*canvas.height,
          size: Math.random()*2,
          speedX: Math.random()*0.5-0.25,
          speedY: Math.random()*0.5-0.25,
          color: Math.random()>0.5 ? '245,158,11' : '139,92,246',
          opacity: Math.random()*0.5
        });
      }

      function step(){
        if(!particleState.running) return;
        ctx.clearRect(0,0,canvas.width,canvas.height);

        particleState.particles.forEach(p=>{
          p.x += p.speedX; p.y += p.speedY;
          if(p.x < 0 || p.x > canvas.width) p.speedX *= -1;
          if(p.y < 0 || p.y > canvas.height) p.speedY *= -1;

          ctx.beginPath();
          ctx.arc(p.x,p.y,p.size,0,Math.PI*2);
          ctx.fillStyle = `rgba(${p.color}, ${p.opacity})`;
          ctx.fill();
        });

        particleRAF = requestAnimationFrame(step);
      }

      function start(){
        if(particleState.running) return;
        particleState.running = true;
        step();
      }
      function stop(){
        particleState.running = false;
        if(particleRAF) cancelAnimationFrame(particleRAF);
        particleRAF = null;
      }

      document.addEventListener('visibilitychange', ()=>{
        if(document.hidden) stop();
        else start();
      });

      start();
    }

    document.addEventListener('DOMContentLoaded', ()=>{
      loadLocalData();
      initParticles();
      lucide.createIcons();

      // Десктоп: показываем дашборд справа
      if(window.innerWidth >= 1024) document.getElementById('view-dashboard').classList.remove('mobile-hidden');
    });
  </script>
</body>
</html>
