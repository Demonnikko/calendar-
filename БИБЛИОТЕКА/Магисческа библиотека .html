<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
  <title>Illusionist Library ‚Äî –ú–∞–≥–∏—á–µ—Å–∫–∞—è –±–∞–∑–∞ –∑–Ω–∞–Ω–∏–π</title>

  <!-- PWA -->
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="Illusionist Library" />
  <meta name="theme-color" content="#050507" />

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;800&family=Inter:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet" />

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Lucide Icons -->
  <script src="https://unpkg.com/lucide@latest"></script>

  <!-- PDF.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <script>
    // Configure PDF.js worker
    if (typeof pdfjsLib !== 'undefined') {
      pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    }
  </script>

  <!-- Tesseract.js for OCR -->
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js"></script>

  <style>
:root{--bg:#050507;--panel:rgba(255,255,255,.10);--stroke:rgba(255,255,255,.15);--gold:#f59e0b;--muted:#94a3b8;--text:#f1f5f9;--safe-top:env(safe-area-inset-top);--safe-bottom:env(safe-area-inset-bottom);--safe-left:env(safe-area-inset-left);--safe-right:env(safe-area-inset-right);}

html,body{height:100%;background:var(--bg);color:var(--text);overflow-x:hidden;max-width:100vw;height:-webkit-fill-available;scroll-behavior:smooth;font-size:16px;margin:0;padding:0;}

*,*::before,*::after{box-sizing:border-box;}

body{font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;overflow-x:hidden;min-height:100vh;min-height:-webkit-fill-available;min-height:100dvh;padding-top:var(--safe-top);padding-bottom:var(--safe-bottom);padding-left:var(--safe-left);padding-right:var(--safe-right);overscroll-behavior:none;}

.font-cinzel{font-family:Cinzel,serif;}
.mono{font-family:"JetBrains Mono",ui-monospace,monospace;}

.glass{background:var(--panel);border:1px solid var(--stroke);backdrop-filter:blur(16px);-webkit-backdrop-filter:blur(16px);box-shadow:0 4px 24px rgba(0,0,0,0.2),0 0 0 1px rgba(255,255,255,0.05) inset;overflow-x:hidden;}

/* Main search container */
.search-container{max-width:800px;margin:0 auto;padding:20px;}

.search-box{background:rgba(255,255,255,0.08);border:2px solid rgba(245,158,11,0.3);border-radius:24px;padding:16px 24px;display:flex;align-items:center;gap:16px;transition:all 0.3s ease;min-height:64px;}

.search-box:focus-within{border-color:rgba(245,158,11,0.6);box-shadow:0 0 0 4px rgba(245,158,11,0.15),0 8px 32px rgba(245,158,11,0.2);background:rgba(255,255,255,0.12);}

.search-input{flex:1;background:transparent;border:none;outline:none;color:#f1f5f9;font-size:16px;font-weight:500;}

.search-input::placeholder{color:#94a3b8;}

.btn-icon{width:48px;height:48px;display:flex;align-items:center;justify-content:center;border-radius:14px;background:rgba(255,255,255,.08);border:1.5px solid rgba(255,255,255,.12);flex-shrink:0;transition:all 0.2s;cursor:pointer;}

.btn-icon:hover{background:rgba(255,255,255,.14);border-color:rgba(255,255,255,.22);transform:translateY(-1px);box-shadow:0 4px 12px rgba(0,0,0,0.15);}

.btn-icon:active{transform:translateY(0);}

.btn-send{background:linear-gradient(135deg,rgba(245,158,11,.95),rgba(245,158,11,.75));border-color:rgba(245,158,11,.4);animation:goldGlow 4s ease-in-out infinite;}

.btn-send:hover{filter:brightness(1.08);box-shadow:0 8px 24px rgba(245,158,11,0.3);}

.btn-send:disabled{opacity:0.5;cursor:not-allowed;animation:none;}

@keyframes goldGlow{0%,100%{box-shadow:0 4px 16px rgba(245,158,11,.2);}50%{box-shadow:0 6px 24px rgba(245,158,11,.35);}}

/* Chat messages */
.chat-container{max-width:800px;margin:0 auto;padding:20px;display:flex;flex-direction:column;gap:16px;}

.message{display:flex;gap:12px;align-items:flex-start;animation:slideIn 0.3s ease;}

@keyframes slideIn{from{opacity:0;transform:translateY(12px);}to{opacity:1;transform:translateY(0);}}

.message.user{flex-direction:row-reverse;}

.message-avatar{width:40px;height:40px;border-radius:12px;display:flex;align-items:center;justify-content:center;flex-shrink:0;font-size:20px;}

.message.user .message-avatar{background:linear-gradient(135deg,rgba(245,158,11,0.2),rgba(245,158,11,0.1));border:1px solid rgba(245,158,11,0.3);}

.message.assistant .message-avatar{background:rgba(255,255,255,0.08);border:1px solid rgba(255,255,255,0.12);}

.message-content{flex:1;background:rgba(255,255,255,0.06);border:1px solid rgba(255,255,255,0.1);border-radius:16px;padding:14px 18px;font-size:15px;line-height:1.6;white-space:pre-wrap;word-wrap:break-word;}

.message.user .message-content{background:rgba(245,158,11,0.12);border-color:rgba(245,158,11,0.25);}

.message.assistant .message-content{background:rgba(255,255,255,0.06);border-color:rgba(255,255,255,0.1);}

/* Typing indicator */
.typing-indicator{display:flex;gap:4px;align-items:center;padding:12px;}

.typing-dot{width:8px;height:8px;background:rgba(245,158,11,0.8);border-radius:50%;animation:typing 1.4s ease-in-out infinite;}

.typing-dot:nth-child(2){animation-delay:0.2s;}

.typing-dot:nth-child(3){animation-delay:0.4s;}

@keyframes typing{0%,60%,100%{transform:translateY(0);opacity:0.7;}30%{transform:translateY(-10px);opacity:1;}}

/* Settings modal */
#settings-modal{position:fixed;inset:0;background:rgba(0,0,0,.75);display:none;z-index:40;overflow:hidden;padding:env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);}

#settings-modal.active{display:flex;align-items:center;justify-content:center;}

.settings-panel{position:fixed;left:0;right:0;top:env(safe-area-inset-top);bottom:env(safe-area-inset-bottom);width:100%;max-width:100%;max-height:none;margin:0;border-radius:0;overflow-y:auto;overflow-x:hidden;-webkit-overflow-scrolling:touch;}

@media (min-width:768px){.settings-panel{position:absolute;left:50%;top:50%;right:auto;bottom:auto;transform:translate(-50%,-50%);width:min(920px,calc(100% - 48px));max-width:min(920px,calc(100% - 48px));max-height:calc(100vh - 48px - env(safe-area-inset-top) - env(safe-area-inset-bottom));border-radius:24px;}}

/* Library items */
.library-item{background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);border-radius:14px;padding:14px 16px;display:flex;justify-content:between;align-items:center;gap:12px;transition:all 0.2s;}

.library-item:hover{background:rgba(255,255,255,0.08);border-color:rgba(245,158,11,0.3);transform:translateY(-1px);}

.btn-delete{background:rgba(239,68,68,0.12);border:1.5px solid rgba(239,68,68,0.22);color:rgba(239,68,68,0.95);border-radius:10px;padding:8px 12px;font-size:13px;font-weight:600;transition:all 0.2s;}

.btn-delete:hover{background:rgba(239,68,68,0.2);border-color:rgba(239,68,68,0.35);}

.btn-add{background:rgba(245,158,11,.16);border:1.5px solid rgba(245,158,11,.30);color:rgba(245,158,11,1);border-radius:14px;padding:12px 18px;font-size:14px;font-weight:700;letter-spacing:0.02em;display:flex;align-items:center;justify-content:center;gap:8px;transition:all 0.2s;width:100%;}

.btn-add:hover{background:rgba(245,158,11,.24);border-color:rgba(245,158,11,.45);transform:translateY(-1px);box-shadow:0 4px 12px rgba(245,158,11,0.2);}

/* Toast */
#toast{position:fixed;top:calc(20px+env(safe-area-inset-top));left:20px;right:20px;z-index:60;opacity:0;transform:translateY(-12px);transition:opacity .3s ease,transform .3s ease;pointer-events:none;}

#toast.show{opacity:1;transform:translateY(0);pointer-events:auto;}

@media (min-width:640px){#toast{left:50%;right:auto;width:450px;max-width:calc(100vw - 40px);transform:translateX(-50%) translateY(-12px);}#toast.show{transform:translateX(-50%) translateY(0);}}

.hidden{display:none!important;}

/* File input */
#file-input{display:none;}

/* Animations */
@keyframes spin{from{transform:rotate(0deg);}to{transform:rotate(360deg);}}
.animate-spin{animation:spin 1s linear infinite;}

/* Category Pills */
.category-pill{display:inline-flex;align-items:center;gap:6px;padding:6px 12px;border-radius:999px;font-size:12px;font-weight:700;border:1.5px solid rgba(255,255,255,0.15);background:rgba(255,255,255,0.05);color:rgba(226,232,240,0.9);cursor:pointer;transition:all 0.2s;user-select:none;}

.category-pill:hover{background:rgba(255,255,255,0.1);border-color:rgba(245,158,11,0.4);transform:translateY(-1px);}

.category-pill.active{background:rgba(245,158,11,0.15);border-color:rgba(245,158,11,0.5);color:rgba(245,158,11,1);}

.category-badge{display:inline-block;padding:2px 8px;border-radius:999px;font-size:10px;font-weight:700;background:rgba(245,158,11,0.15);border:1px solid rgba(245,158,11,0.3);color:rgba(245,158,11,0.95);margin-left:8px;}

/* AI Mode Buttons */
.ai-mode-btn{display:flex;align-items:center;gap:6px;padding:8px 14px;border-radius:12px;font-size:13px;font-weight:700;border:1.5px solid rgba(255,255,255,0.15);background:rgba(255,255,255,0.05);color:rgba(226,232,240,0.8);cursor:pointer;transition:all 0.2s;user-select:none;flex:1;}

.ai-mode-btn:hover{background:rgba(255,255,255,0.1);border-color:rgba(245,158,11,0.3);transform:translateY(-1px);}

.ai-mode-btn.active{background:rgba(245,158,11,0.15);border-color:rgba(245,158,11,0.5);color:rgba(245,158,11,1);}
</style>
</head>

<body class="min-h-screen">

<!-- –ó–ê–°–¢–ê–í–ö–ê -->
<div id="splash-screen" style="position:fixed;inset:0;background:#050507;display:flex;align-items:center;justify-content:center;z-index:999999;">
  <div style="text-align:center;">
    <div style="font-size:80px;margin-bottom:20px;animation:pulse 2s ease-in-out infinite;">üìö</div>
    <h1 style="font-family:'Cinzel',serif;font-size:36px;background:linear-gradient(135deg,#f59e0b,#fbbf24);-webkit-background-clip:text;-webkit-text-fill-color:transparent;margin:0 0 6px 0;letter-spacing:3px;">ILLUSIONIST LIBRARY</h1>
    <p style="font-family:'Inter',sans-serif;font-size:11px;color:rgba(148,163,184,0.75);letter-spacing:1.5px;text-transform:uppercase;margin:0;">–¢–≤–æ—è –º–∞–≥–∏—á–µ—Å–∫–∞—è –±–∞–∑–∞ –∑–Ω–∞–Ω–∏–π</p>
  </div>
</div>

<style>
@keyframes pulse{0%,100%{transform:scale(1);opacity:1}50%{transform:scale(1.05);opacity:0.9}}
</style>

<!-- TOAST -->
<div id="toast">
  <div class="glass rounded-2xl px-5 py-4 shadow-xl">
    <div class="flex items-center gap-3">
      <i data-lucide="bell" class="w-5 h-5 text-amber-400"></i>
      <div id="toast-msg" class="text-base text-slate-200 font-semibold"></div>
    </div>
  </div>
</div>

<!-- HEADER -->
<header class="relative z-10 p-4">
  <div class="max-w-5xl mx-auto flex items-center justify-between">
    <div class="flex items-center gap-3">
      <div class="w-12 h-12 rounded-2xl glass flex items-center justify-center" style="animation:iconPulse 3s ease-in-out infinite;">
        <span style="font-size:24px;">üìö</span>
      </div>
      <div>
        <div class="font-cinzel text-white tracking-wide text-lg">Illusionist Library</div>
        <div class="text-sm text-slate-400 font-semibold">–ú–∞–≥–∏—á–µ—Å–∫–∞—è –±–∞–∑–∞ –∑–Ω–∞–Ω–∏–π</div>
      </div>
    </div>

    <button id="btn-settings" class="btn-icon" aria-label="–ù–∞—Å—Ç—Ä–æ–π–∫–∏">
      <i data-lucide="settings" class="w-6 h-6 text-slate-200"></i>
    </button>
  </div>
</header>

<style>
@keyframes iconPulse{0%,100%{transform:scale(1);}50%{transform:scale(1.05);}}
</style>

<!-- MAIN CONTENT -->
<main class="relative z-10 px-4" style="padding-bottom:200px;">
  <!-- Chat Messages -->
  <div id="chat-container" class="chat-container" style="padding-bottom:20px;"></div>
</main>

<!-- Search Box (fixed at bottom) -->
<div style="position:fixed;bottom:0;left:0;right:0;z-index:50;background:linear-gradient(to top, rgba(5,5,7,1) 70%, transparent);padding:20px;padding-bottom:calc(20px + env(safe-area-inset-bottom));">
  <div style="max-width:800px;margin:0 auto;">
    <!-- AI Mode Selector -->
    <div class="flex gap-2 mb-3" id="ai-mode-selector">
      <button class="ai-mode-btn active" data-mode="search" title="–ë—ã—Å—Ç—Ä—ã–π –ø–æ–∏—Å–∫ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏">
        <i data-lucide="search" class="w-4 h-4"></i>
        <span>–ü–æ–∏—Å–∫</span>
      </button>
      <button class="ai-mode-btn" data-mode="generate" title="–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –Ω–æ–≤—ã—Ö –∏–¥–µ–π">
        <i data-lucide="lightbulb" class="w-4 h-4"></i>
        <span>–ò–¥–µ–∏</span>
      </button>
      <button class="ai-mode-btn" data-mode="analyze" title="–ì–ª—É–±–æ–∫–∏–π –∞–Ω–∞–ª–∏–∑">
        <i data-lucide="microscope" class="w-4 h-4"></i>
        <span>–ê–Ω–∞–ª–∏–∑</span>
      </button>
    </div>
    
    <!-- Search History Dropdown -->
    <div id="search-history" class="hidden mb-3 glass rounded-xl p-3 space-y-2" style="max-height:200px;overflow-y:auto;"></div>
    
    <div class="search-box">
      <i data-lucide="sparkles" class="w-6 h-6 text-amber-400 flex-shrink-0"></i>
      <input 
        type="text" 
        id="search-input" 
        class="search-input" 
        placeholder="–°–ø—Ä–æ—Å–∏ —á—Ç–æ-—É–≥–æ–¥–Ω–æ –æ —Å–≤–æ–µ–π –±–∏–±–ª–∏–æ—Ç–µ–∫–µ..."
        autocomplete="off"
      />
      <button id="btn-history" class="btn-icon" aria-label="–ò—Å—Ç–æ—Ä–∏—è" title="–ò—Å—Ç–æ—Ä–∏—è –ø–æ–∏—Å–∫–∞">
        <i data-lucide="clock" class="w-5 h-5 text-slate-400"></i>
      </button>
      <button id="btn-send" class="btn-icon btn-send" aria-label="–û—Ç–ø—Ä–∞–≤–∏—Ç—å">
        <i data-lucide="send" class="w-5 h-5 text-slate-900"></i>
      </button>
    </div>
  </div>
</div>

<!-- SETTINGS MODAL -->
<div id="settings-modal" aria-hidden="true">
  <div class="settings-panel glass p-6">
    <div class="flex items-center justify-between mb-6">
      <div>
        <div class="font-cinzel text-white text-xl mb-1">–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏</div>
        <div class="text-sm text-slate-400 font-semibold">–ó–∞–≥—Ä—É–∑–∏ —Å–≤–æ–∏ –∫–Ω–∏–≥–∏ –∏ –º–∞—Ç–µ—Ä–∏–∞–ª—ã</div>
      </div>
      <button id="btn-close-settings" class="btn-icon" aria-label="–ó–∞–∫—Ä—ã—Ç—å">
        <i data-lucide="x" class="w-6 h-6 text-slate-400"></i>
      </button>
    </div>

    <!-- API Key -->
    <div class="glass rounded-2xl p-5 mb-6 border-2 border-amber-500/20">
      <div class="flex items-center gap-3 mb-4">
        <i data-lucide="key" class="w-6 h-6 text-amber-400"></i>
        <span class="text-lg font-extrabold text-white">OpenAI API –∫–ª—é—á</span>
      </div>
      <input 
        type="password" 
        id="api-key-input" 
        class="w-full bg-black/20 border border-amber-500/30 rounded-xl px-4 py-3 text-white font-mono text-sm"
        placeholder="sk-proj-..."
      />
      <div class="text-xs text-slate-500 mt-2">
        –ü–æ–ª—É—á–∏ –∫–ª—é—á –Ω–∞ <a href="https://platform.openai.com/api-keys" target="_blank" class="text-amber-400 hover:underline">platform.openai.com</a>
      </div>
    </div>

    <!-- Library -->
    <div class="glass rounded-2xl p-5 mb-6">
      <div class="flex items-center justify-between mb-4">
        <div class="flex items-center gap-3">
          <i data-lucide="library" class="w-6 h-6 text-purple-400"></i>
          <span class="text-lg font-extrabold text-white">–¢–≤–æ—è –±–∏–±–ª–∏–æ—Ç–µ–∫–∞</span>
        </div>
        <span class="text-sm text-slate-400" id="library-count">0 —Ñ–∞–π–ª–æ–≤</span>
      </div>

      <button id="btn-add-file" class="btn-add mb-3">
        <i data-lucide="plus" class="w-5 h-5"></i>
        <span>–î–æ–±–∞–≤–∏—Ç—å —Ñ–∞–π–ª</span>
      </button>
      
      <!-- YouTube Link Input -->
      <div class="mb-3 p-4 bg-red-500/5 border border-red-500/20 rounded-xl">
        <div class="flex items-center gap-2 mb-2">
          <i data-lucide="youtube" class="w-5 h-5 text-red-400"></i>
          <span class="text-sm font-bold text-white">YouTube –≤–∏–¥–µ–æ</span>
        </div>
        <div class="flex gap-2">
          <input 
            type="text" 
            id="youtube-link-input" 
            class="flex-1 bg-black/20 border border-red-500/30 rounded-xl px-4 py-3 text-white text-sm"
            placeholder="https://youtube.com/watch?v=..."
          />
          <button id="btn-add-youtube" class="btn-icon" style="background:rgba(239,68,68,0.15);border-color:rgba(239,68,68,0.3);">
            <i data-lucide="plus" class="w-5 h-5 text-red-400"></i>
          </button>
        </div>
        <div class="text-xs text-slate-500 mt-2">
          –í—Å—Ç–∞–≤—å —Å—Å—ã–ª–∫—É –Ω–∞ YouTube (–º–æ–∂–Ω–æ unlisted/private). AI –∏–∑–≤–ª–µ—á—ë—Ç —Å—É–±—Ç–∏—Ç—Ä—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.
        </div>
      </div>
      
      <!-- Export/Import -->
      <div class="grid grid-cols-2 gap-3 mb-3">
        <button id="btn-export-library" class="flex items-center justify-center gap-2 px-4 py-2 rounded-xl bg-emerald-500/10 border border-emerald-500/30 text-emerald-400 hover:bg-emerald-500/20 transition text-sm font-bold">
          <i data-lucide="download" class="w-4 h-4"></i>
          <span>–≠–∫—Å–ø–æ—Ä—Ç</span>
        </button>
        <button id="btn-import-library" class="flex items-center justify-center gap-2 px-4 py-2 rounded-xl bg-blue-500/10 border border-blue-500/30 text-blue-400 hover:bg-blue-500/20 transition text-sm font-bold">
          <i data-lucide="upload" class="w-4 h-4"></i>
          <span>–ò–º–ø–æ—Ä—Ç</span>
        </button>
      </div>
      
      <!-- Category Filter Pills -->
      <div class="mb-3">
        <div class="flex items-center gap-2 mb-2">
          <i data-lucide="tag" class="w-4 h-4 text-amber-400"></i>
          <span class="text-sm font-bold text-slate-300">–ö–∞—Ç–µ–≥–æ—Ä–∏–∏:</span>
          <button id="btn-manage-categories" class="text-xs text-amber-400 hover:underline">
            —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
          </button>
        </div>
        <div id="category-pills" class="flex flex-wrap gap-2"></div>
      </div>

      <div id="library-list" class="space-y-2"></div>
    </div>

    <!-- Info -->
    <div class="bg-white/5 rounded-xl p-4 text-sm text-slate-400">
      <div class="flex items-start gap-3">
        <i data-lucide="info" class="w-5 h-5 text-amber-400 flex-shrink-0 mt-0.5"></i>
        <div>
          <p class="font-bold text-white mb-2">–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã:</p>
          <ul class="space-y-1 text-slate-400">
            <li>‚Ä¢ PDF –¥–æ–∫—É–º–µ–Ω—Ç—ã</li>
            <li>‚Ä¢ –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å —Ç–µ–∫—Å—Ç–æ–º (JPG, PNG) + OCR</li>
            <li>‚Ä¢ –¢–µ–∫—Å—Ç–æ–≤—ã–µ —Ñ–∞–π–ª—ã (TXT, MD)</li>
            <li>‚Ä¢ Word –¥–æ–∫—É–º–µ–Ω—Ç—ã (DOCX)</li>
            <li>‚Ä¢ YouTube –≤–∏–¥–µ–æ (—Å—É–±—Ç–∏—Ç—Ä—ã)</li>
          </ul>
        </div>
      </div>
    </div>
    
    <!-- Favorites -->
    <div class="glass rounded-2xl p-5 mt-6">
      <div class="flex items-center justify-between mb-4">
        <div class="flex items-center gap-3">
          <i data-lucide="star" class="w-6 h-6 text-yellow-400"></i>
          <span class="text-lg font-extrabold text-white">–ò–∑–±—Ä–∞–Ω–Ω–æ–µ</span>
        </div>
        <span class="text-sm text-slate-400" id="favorites-count">0 —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ</span>
      </div>
      
      <div id="favorites-list" class="space-y-2"></div>
    </div>
    
    <!-- Statistics -->
    <div class="glass rounded-2xl p-5 mt-6 border-2 border-purple-500/20">
      <div class="flex items-center gap-3 mb-4">
        <i data-lucide="bar-chart-3" class="w-6 h-6 text-purple-400"></i>
        <span class="text-lg font-extrabold text-white">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏</span>
      </div>
      
      <div class="grid grid-cols-2 gap-3">
        <div class="bg-white/5 rounded-xl p-3">
          <div class="text-xs text-slate-400 mb-1">–í—Å–µ–≥–æ —Ñ–∞–π–ª–æ–≤</div>
          <div class="text-2xl font-extrabold text-white" id="stat-files">0</div>
        </div>
        <div class="bg-white/5 rounded-xl p-3">
          <div class="text-xs text-slate-400 mb-1">–í—Å–µ–≥–æ —Ç–µ–∫—Å—Ç–∞</div>
          <div class="text-2xl font-extrabold text-amber-400" id="stat-chars">0</div>
        </div>
        <div class="bg-white/5 rounded-xl p-3">
          <div class="text-xs text-slate-400 mb-1">PDF –∫–Ω–∏–≥</div>
          <div class="text-2xl font-extrabold text-purple-400" id="stat-pdfs">0</div>
        </div>
        <div class="bg-white/5 rounded-xl p-3">
          <div class="text-xs text-slate-400 mb-1">–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π</div>
          <div class="text-2xl font-extrabold text-emerald-400" id="stat-images">0</div>
        </div>
      </div>
      
      <div class="mt-4 bg-white/5 rounded-xl p-3">
        <div class="text-xs text-slate-400 mb-2">–¢–æ–ø-3 –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</div>
        <div id="stat-top-categories" class="text-sm text-slate-200"></div>
      </div>
    </div>
  </div>
</div>

<input type="file" id="file-input" accept=".pdf,.txt,.md,.docx,.jpg,.jpeg,.png" multiple />
<input type="file" id="import-input" accept=".json" style="display:none;" />

<script>
'use strict';

// ============================================
// STORAGE & STATE
// ============================================
const STORAGE_KEY = 'illusionist_library';

let State = {
  apiKey: '',
  library: [],
  messages: [],
  searchHistory: [], // New: last 10 searches
  categories: ['–ú–∏–∫—Ä–æ–º–∞–≥–∏—è', '–ö–∞—Ä—Ç—ã', '–õ–µ–≤–∏—Ç–∞—Ü–∏—è', '–ú–µ–Ω—Ç–∞–ª–∏—Ç–µ—Ç', '–°—Ü–µ–Ω–∏—á–µ—Å–∫–∞—è –º–∞–≥–∏—è', '–¢–µ–æ—Ä–∏—è'], // Default categories
  activeCategory: 'all', // Current filter
  favorites: [], // Saved AI answers
  aiMode: 'search' // AI modes: search, generate, analyze
};

function saveState() {
  try {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(State));
    return true;
  } catch (err) {
    console.error('Save error:', err);
    return false;
  }
}

function loadState() {
  try {
    const stored = localStorage.getItem(STORAGE_KEY);
    if (stored) {
      const parsed = JSON.parse(stored);
      State = { ...State, ...parsed };
    }
    return true;
  } catch (err) {
    console.error('Load error:', err);
    return false;
  }
}

// ============================================
// TOAST
// ============================================
let toastTimer = null;

function showToast(msg) {
  const toast = document.getElementById('toast');
  const msgEl = document.getElementById('toast-msg');
  if (!toast || !msgEl) return;

  msgEl.textContent = msg;
  toast.classList.add('show');

  clearTimeout(toastTimer);
  toastTimer = setTimeout(() => toast.classList.remove('show'), 3000);
}

// ============================================
// FILE PROCESSING
// ============================================
async function processFile(file, onProgress) {
  const fileName = file.name;
  const fileType = file.type;
  const fileExt = fileName.split('.').pop().toLowerCase();

  let content = '';

  try {
    // Text files
    if (fileType.startsWith('text/') || fileExt === 'txt' || fileExt === 'md') {
      content = await file.text();
    }
    // PDF with PDF.js
    else if (fileExt === 'pdf') {
      content = await extractPdfText(file);
    }
    // Images with OCR
    else if (fileType.startsWith('image/')) {
      content = await extractImageText(file, onProgress);
    }
    // DOCX (placeholder - will add later)
    else if (fileExt === 'docx') {
      content = `[DOCX: ${fileName}]\n\n‚è≥ –û–±—Ä–∞–±–æ—Ç–∫–∞ Word –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ –±—É–¥–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω–∞ –ø–æ–∑–∂–µ...`;
    }
    else {
      content = `[–§–∞–π–ª: ${fileName}]\n\n–§–æ—Ä–º–∞—Ç –ø–æ–∫–∞ –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è`;
    }

    return {
      id: Date.now() + '_' + Math.random().toString(36).slice(2),
      name: fileName,
      type: fileType || 'unknown',
      size: file.size,
      content: content.slice(0, 100000), // Limit to 100k chars
      addedAt: new Date().toISOString(),
      category: '', // New: category/tag
      tags: [] // New: multiple tags
    };
  } catch (err) {
    console.error('File processing error:', err);
    return null;
  }
}

// Extract text from PDF using PDF.js
async function extractPdfText(file) {
  try {
    const arrayBuffer = await file.arrayBuffer();
    const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
    
    let fullText = '';
    
    for (let pageNum = 1; pageNum <= pdf.numPages; pageNum++) {
      const page = await pdf.getPage(pageNum);
      const textContent = await page.getTextContent();
      const pageText = textContent.items.map(item => item.str).join(' ');
      fullText += `\n\n=== –°—Ç—Ä–∞–Ω–∏—Ü–∞ ${pageNum} ===\n\n${pageText}`;
    }
    
    return fullText || '[PDF –ø—É—Å—Ç –∏–ª–∏ –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç —Ç–µ–∫—Å—Ç–∞]';
  } catch (err) {
    console.error('PDF extraction error:', err);
    return `[–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è PDF: ${err.message}]`;
  }
}

// Extract text from image using Tesseract.js OCR
async function extractImageText(file, onProgress) {
  try {
    const worker = await Tesseract.createWorker('rus', 1, {
      logger: m => {
        if (onProgress && m.status === 'recognizing text') {
          onProgress(Math.round(m.progress * 100));
        }
      }
    });
    
    const { data: { text } } = await worker.recognize(file);
    await worker.terminate();
    
    return text || '[–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç —Ç–µ–∫—Å—Ç–∞]';
  } catch (err) {
    console.error('OCR error:', err);
    return `[–û—à–∏–±–∫–∞ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è: ${err.message}]`;
  }
}

// Extract YouTube video ID from URL
function extractYouTubeID(url) {
  const patterns = [
    /(?:youtube\.com\/watch\?v=|youtu\.be\/|youtube\.com\/embed\/)([^&\n?#]+)/,
    /^([a-zA-Z0-9_-]{11})$/
  ];
  
  for (const pattern of patterns) {
    const match = url.match(pattern);
    if (match) return match[1];
  }
  
  return null;
}

// Get YouTube transcript using API
async function getYouTubeTranscript(videoId) {
  try {
    // Using a public API for YouTube transcripts
    const response = await fetch(`https://youtube-transcript-api.vercel.app/api/transcript?videoId=${videoId}`);
    
    if (!response.ok) {
      throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Å—É–±—Ç–∏—Ç—Ä—ã');
    }
    
    const data = await response.json();
    
    if (!data || !Array.isArray(data)) {
      throw new Error('–°—É–±—Ç–∏—Ç—Ä—ã –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã –¥–ª—è —ç—Ç–æ–≥–æ –≤–∏–¥–µ–æ');
    }
    
    // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ç —Å —Ç–∞–π–º–∫–æ–¥–∞–º–∏
    let transcript = '';
    data.forEach(item => {
      const minutes = Math.floor(item.offset / 60000);
      const seconds = Math.floor((item.offset % 60000) / 1000);
      const timestamp = `[${minutes}:${seconds.toString().padStart(2, '0')}]`;
      transcript += `${timestamp} ${item.text}\n`;
    });
    
    return transcript || '[–°—É–±—Ç–∏—Ç—Ä—ã –ø—É—Å—Ç—ã–µ]';
  } catch (err) {
    console.error('YouTube transcript error:', err);
    
    // Fallback: –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
    return `[–ù–µ —É–¥–∞–ª–æ—Å—å –∏–∑–≤–ª–µ—á—å —Å—É–±—Ç–∏—Ç—Ä—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏]

–†–ï–®–ï–ù–ò–ï:
1. –û—Ç–∫—Ä–æ–π –≤–∏–¥–µ–æ –Ω–∞ YouTube
2. –í–∫–ª—é—á–∏ —Å—É–±—Ç–∏—Ç—Ä—ã (CC)
3. –ù–∞–∂–º–∏ ... ‚Üí –ü–æ–∫–∞–∑–∞—Ç—å —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ç
4. –°–∫–æ–ø–∏—Ä—É–π —Ç–µ–∫—Å—Ç
5. –°–æ–∑–¥–∞–π .txt —Ñ–∞–π–ª –∏ –∑–∞–≥—Ä—É–∑–∏ —Å—é–¥–∞

–ò–ª–∏ —É–±–µ–¥–∏—Å—å —á—Ç–æ:
- –í–∏–¥–µ–æ –ø—É–±–ª–∏—á–Ω–æ–µ/unlisted (–Ω–µ private)
- –£ –≤–∏–¥–µ–æ –µ—Å—Ç—å —Å—É–±—Ç–∏—Ç—Ä—ã
- –°—Å—ã–ª–∫–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è`;
  }
}

// ============================================
// LIBRARY MANAGEMENT
// ============================================
function renderLibrary() {
  const list = document.getElementById('library-list');
  const count = document.getElementById('library-count');
  if (!list || !count) return;

  list.innerHTML = '';
  
  // Filter by active category
  let filtered = State.library;
  if (State.activeCategory !== 'all') {
    filtered = State.library.filter(item => 
      item.category === State.activeCategory || 
      (item.tags && item.tags.includes(State.activeCategory))
    );
  }
  
  count.textContent = `${filtered.length} –∏–∑ ${State.library.length} —Ñ–∞–π–ª–æ–≤`;

  if (filtered.length === 0) {
    list.innerHTML = State.activeCategory === 'all' 
      ? '<div class="text-sm text-slate-500">–ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ –ø—É—Å—Ç–∞. –î–æ–±–∞–≤—å –ø–µ—Ä–≤—ã–π —Ñ–∞–π–ª!</div>'
      : '<div class="text-sm text-slate-500">–ù–µ—Ç —Ñ–∞–π–ª–æ–≤ –≤ —ç—Ç–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</div>';
    return;
  }

  filtered.forEach(item => {
    const div = document.createElement('div');
    div.className = 'library-item';

    const icon = getFileIcon(item.type);
    const size = formatSize(item.size);
    const categoryBadge = item.category 
      ? `<span class="category-badge">${escapeHtml(item.category)}</span>` 
      : '';
    
    // YouTube video link button
    const youtubeBtn = item.youtubeUrl 
      ? `<button class="btn-icon" style="width:40px;height:40px;" data-youtube="${item.youtubeUrl}" title="–û—Ç–∫—Ä—ã—Ç—å –Ω–∞ YouTube">
          <i data-lucide="external-link" class="w-4 h-4 text-red-400"></i>
         </button>`
      : '';

    div.innerHTML = `
      <div class="flex items-center gap-3 flex-1 min-w-0">
        <span style="font-size:24px;">${icon}</span>
        <div class="flex-1 min-w-0">
          <div class="font-bold text-white text-sm truncate">${escapeHtml(item.name)}${categoryBadge}</div>
          <div class="text-xs text-slate-400">${size}</div>
        </div>
      </div>
      <div class="flex items-center gap-2">
        ${youtubeBtn}
        <button class="btn-icon" style="width:40px;height:40px;" data-category="${item.id}" title="–ö–∞—Ç–µ–≥–æ—Ä–∏—è">
          <i data-lucide="tag" class="w-4 h-4"></i>
        </button>
        <button class="btn-delete" data-delete="${item.id}">
          <i data-lucide="trash-2" class="w-4 h-4"></i>
        </button>
      </div>
    `;
    
    // YouTube button handler
    const ytBtn = div.querySelector('[data-youtube]');
    if (ytBtn) {
      ytBtn.addEventListener('click', () => {
        window.open(item.youtubeUrl, '_blank');
      });
    }

    const catBtn = div.querySelector('[data-category]');
    if (catBtn) {
      catBtn.addEventListener('click', () => setFileCategory(item.id));
    }

    const delBtn = div.querySelector('[data-delete]');
    if (delBtn) {
      delBtn.addEventListener('click', () => {
        State.library = State.library.filter(i => i.id !== item.id);
        saveState();
        renderLibrary();
        renderCategoryPills();
        showToast('–§–∞–π–ª —É–¥–∞–ª—ë–Ω');
      });
    }

    list.appendChild(div);
  });

  if (window.lucide) lucide.createIcons();
}

function getFileIcon(type) {
  if (type.includes('youtube')) return 'üé¨';
  if (type.includes('pdf')) return 'üìÑ';
  if (type.includes('image')) return 'üñºÔ∏è';
  if (type.includes('text')) return 'üìù';
  if (type.includes('word') || type.includes('docx')) return 'üìò';
  return 'üì¶';
}

function formatSize(bytes) {
  if (bytes < 1024) return bytes + ' B';
  if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
  return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
}

function escapeHtml(text) {
  const map = {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'};
  return String(text).replace(/[&<>"']/g, m => map[m]);
}

// ============================================
// CATEGORIES
// ============================================
function renderCategoryPills() {
  const container = document.getElementById('category-pills');
  if (!container) return;
  
  container.innerHTML = '';
  
  // "–í—Å–µ" pill
  const allPill = document.createElement('div');
  allPill.className = `category-pill ${State.activeCategory === 'all' ? 'active' : ''}`;
  allPill.innerHTML = `<span>–í—Å–µ</span><span class="text-xs opacity-60">(${State.library.length})</span>`;
  allPill.addEventListener('click', () => {
    State.activeCategory = 'all';
    renderCategoryPills();
    renderLibrary();
  });
  container.appendChild(allPill);
  
  // Category pills
  State.categories.forEach(cat => {
    const count = State.library.filter(item => item.category === cat || (item.tags && item.tags.includes(cat))).length;
    
    const pill = document.createElement('div');
    pill.className = `category-pill ${State.activeCategory === cat ? 'active' : ''}`;
    pill.innerHTML = `<span>${escapeHtml(cat)}</span><span class="text-xs opacity-60">(${count})</span>`;
    pill.addEventListener('click', () => {
      State.activeCategory = cat;
      renderCategoryPills();
      renderLibrary();
    });
    container.appendChild(pill);
  });
  
  if (window.lucide) lucide.createIcons();
}

async function manageCategories() {
  const current = State.categories.join(', ');
  const result = prompt('–ö–∞—Ç–µ–≥–æ—Ä–∏–∏ (—á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é):\n\n–ù–∞–ø—Ä–∏–º–µ—Ä: –ú–∏–∫—Ä–æ–º–∞–≥–∏—è, –ö–∞—Ä—Ç—ã, –õ–µ–≤–∏—Ç–∞—Ü–∏—è', current);
  
  if (result === null) return;
  
  const newCategories = result
    .split(',')
    .map(c => c.trim())
    .filter(c => c.length > 0);
  
  if (newCategories.length === 0) {
    showToast('–ù—É–∂–Ω–∞ —Ö–æ—Ç—è –±—ã –æ–¥–Ω–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏—è');
    return;
  }
  
  State.categories = newCategories;
  saveState();
  renderCategoryPills();
  showToast('‚úÖ –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ –æ–±–Ω–æ–≤–ª–µ–Ω—ã');
}

async function setFileCategory(fileId) {
  const file = State.library.find(f => f.id === fileId);
  if (!file) return;
  
  const options = State.categories.map((c, i) => `${i + 1}. ${c}`).join('\n');
  const result = prompt(`–í—ã–±–µ—Ä–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏—é –¥–ª—è "${file.name}":\n\n${options}\n\n–í–≤–µ–¥–∏ –Ω–æ–º–µ—Ä –∏–ª–∏ –Ω–∞–∑–≤–∞–Ω–∏–µ:`, file.category || '');
  
  if (result === null) return;
  
  // Check if it's a number
  const num = parseInt(result);
  if (!isNaN(num) && num > 0 && num <= State.categories.length) {
    file.category = State.categories[num - 1];
  } else {
    file.category = result.trim();
  }
  
  saveState();
  renderLibrary();
  renderCategoryPills();
  showToast('‚úÖ –ö–∞—Ç–µ–≥–æ—Ä–∏—è —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞');
}

// ============================================
// EXPORT / IMPORT LIBRARY
// ============================================
function exportLibrary() {
  if (State.library.length === 0) {
    showToast('–ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ –ø—É—Å—Ç–∞!');
    return;
  }
  
  const exportData = {
    version: '1.0',
    exportedAt: new Date().toISOString(),
    library: State.library,
    searchHistory: State.searchHistory,
    categories: State.categories
  };
  
  const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  
  const a = document.createElement('a');
  a.href = url;
  a.download = `illusionist-library-${new Date().toISOString().slice(0, 10)}.json`;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
  
  showToast('‚úÖ –ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–∞!');
}

function importLibrary(file) {
  const reader = new FileReader();
  
  reader.onload = (e) => {
    try {
      const imported = JSON.parse(e.target.result);
      
      if (!imported.library || !Array.isArray(imported.library)) {
        showToast('‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç —Ñ–∞–π–ª–∞');
        return;
      }
      
      const confirmMsg = `–ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å ${imported.library.length} —Ñ–∞–π–ª–æ–≤?\n\n–¢–µ–∫—É—â–∞—è –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ (${State.library.length} —Ñ–∞–π–ª–æ–≤) –±—É–¥–µ—Ç –∑–∞–º–µ–Ω–µ–Ω–∞!`;
      
      if (!confirm(confirmMsg)) return;
      
      State.library = imported.library;
      State.searchHistory = imported.searchHistory || [];
      State.categories = imported.categories || State.categories;
      saveState();
      renderLibrary();
      renderCategoryPills();
      
      showToast(`‚úÖ –ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–æ: ${imported.library.length} —Ñ–∞–π–ª–æ–≤`);
    } catch (err) {
      console.error('Import error:', err);
      showToast('‚ùå –û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞');
    }
  };
  
  reader.readAsText(file);
}

// ============================================
// SEARCH HISTORY
// ============================================
function addToSearchHistory(query) {
  if (!query || !query.trim()) return;
  
  // Remove duplicates
  State.searchHistory = State.searchHistory.filter(q => q !== query);
  
  // Add to beginning
  State.searchHistory.unshift(query);
  
  // Keep only last 10
  if (State.searchHistory.length > 10) {
    State.searchHistory = State.searchHistory.slice(0, 10);
  }
  
  saveState();
}

function renderSearchHistory() {
  const historyDiv = document.getElementById('search-history');
  if (!historyDiv) return;
  
  if (State.searchHistory.length === 0) {
    historyDiv.classList.add('hidden');
    return;
  }
  
  historyDiv.innerHTML = '';
  historyDiv.classList.remove('hidden');
  
  State.searchHistory.forEach(query => {
    const item = document.createElement('div');
    item.className = 'flex items-center gap-2 px-3 py-2 rounded-lg bg-white/5 hover:bg-white/10 cursor-pointer transition';
    item.innerHTML = `
      <i data-lucide="history" class="w-4 h-4 text-slate-400 flex-shrink-0"></i>
      <span class="text-sm text-slate-200 flex-1 truncate">${escapeHtml(query)}</span>
    `;
    
    item.addEventListener('click', () => {
      document.getElementById('search-input').value = query;
      historyDiv.classList.add('hidden');
    });
    
    historyDiv.appendChild(item);
  });
  
  if (window.lucide) lucide.createIcons();
}

function toggleSearchHistory() {
  const historyDiv = document.getElementById('search-history');
  if (!historyDiv) return;
  
  if (historyDiv.classList.contains('hidden')) {
    renderSearchHistory();
  } else {
    historyDiv.classList.add('hidden');
  }
}

// ============================================
// CHAT
// ============================================
function addMessage(role, content, messageId = null) {
  const container = document.getElementById('chat-container');
  if (!container) return;

  const msg = document.createElement('div');
  msg.className = `message ${role}`;
  
  const id = messageId || Date.now() + '_' + Math.random().toString(36).slice(2);

  const avatar = role === 'user' ? 'üé©' : 'üìö';
  
  // Check if already in favorites
  const isFavorite = State.favorites.some(f => f.id === id);
  
  const starButton = role === 'assistant' 
    ? `<button class="btn-icon ml-2" style="width:36px;height:36px;" data-star="${id}" title="${isFavorite ? '–£–±—Ä–∞—Ç—å –∏–∑ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ' : '–î–æ–±–∞–≤–∏—Ç—å –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ'}">
        <i data-lucide="${isFavorite ? 'star' : 'star'}" class="w-4 h-4 ${isFavorite ? 'text-yellow-400 fill-yellow-400' : 'text-slate-400'}"></i>
       </button>`
    : '';
  
  msg.innerHTML = `
    <div class="message-avatar">${avatar}</div>
    <div class="flex-1">
      <div class="message-content">${escapeHtml(content)}</div>
    </div>
    ${starButton}
  `;
  
  // Star button handler
  if (role === 'assistant') {
    const starBtn = msg.querySelector('[data-star]');
    if (starBtn) {
      starBtn.addEventListener('click', () => toggleFavorite(id, content));
    }
  }

  container.appendChild(msg);
  
  // –£–ª—É—á—à–µ–Ω–Ω—ã–π scroll - –ø—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º –ø–ª–∞–≤–Ω–æ –∏ —Å –∑–∞–¥–µ—Ä–∂–∫–æ–π
  setTimeout(() => {
    window.scrollTo({
      top: document.documentElement.scrollHeight,
      behavior: 'smooth'
    });
  }, 100);

  State.messages.push({ role, content, timestamp: new Date().toISOString(), id });
  saveState();
  
  if (window.lucide) lucide.createIcons();
}

function showTypingIndicator() {
  const container = document.getElementById('chat-container');
  if (!container) return;

  const typing = document.createElement('div');
  typing.className = 'message assistant';
  typing.id = 'typing-indicator';
  
  typing.innerHTML = `
    <div class="message-avatar">üìö</div>
    <div class="message-content">
      <div class="typing-indicator">
        <div class="typing-dot"></div>
        <div class="typing-dot"></div>
        <div class="typing-dot"></div>
      </div>
    </div>
  `;

  container.appendChild(typing);
  
  // –ü—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º –≤–Ω–∏–∑
  setTimeout(() => {
    window.scrollTo({
      top: document.documentElement.scrollHeight,
      behavior: 'smooth'
    });
  }, 100);
}

function removeTypingIndicator() {
  const typing = document.getElementById('typing-indicator');
  if (typing) typing.remove();
}

// ============================================
// STATISTICS
// ============================================
function calculateStats() {
  const stats = {
    totalFiles: State.library.length,
    totalChars: 0,
    pdfCount: 0,
    imageCount: 0,
    categoryCount: {}
  };
  
  State.library.forEach(file => {
    // Count characters
    if (file.content) {
      stats.totalChars += file.content.length;
    }
    
    // Count file types
    if (file.name.toLowerCase().endsWith('.pdf')) {
      stats.pdfCount++;
    } else if (file.type && file.type.startsWith('image/')) {
      stats.imageCount++;
    }
    
    // Count categories
    if (file.category) {
      stats.categoryCount[file.category] = (stats.categoryCount[file.category] || 0) + 1;
    }
  });
  
  return stats;
}

function renderStats() {
  const stats = calculateStats();
  
  // Update numbers
  const filesEl = document.getElementById('stat-files');
  if (filesEl) filesEl.textContent = stats.totalFiles;
  
  // Format characters count
  const chars = stats.totalChars;
  let charsText = chars.toLocaleString('ru-RU');
  if (chars > 1000000) {
    charsText = (chars / 1000000).toFixed(1) + 'M';
  } else if (chars > 1000) {
    charsText = (chars / 1000).toFixed(1) + 'K';
  }
  const charsEl = document.getElementById('stat-chars');
  if (charsEl) charsEl.textContent = charsText;
  
  const pdfsEl = document.getElementById('stat-pdfs');
  if (pdfsEl) pdfsEl.textContent = stats.pdfCount;
  
  const imagesEl = document.getElementById('stat-images');
  if (imagesEl) imagesEl.textContent = stats.imageCount;
  
  // Top categories
  const topCatsEl = document.getElementById('stat-top-categories');
  if (topCatsEl) {
    const sortedCats = Object.entries(stats.categoryCount)
      .sort((a, b) => b[1] - a[1])
      .slice(0, 3);
    
    if (sortedCats.length === 0) {
      topCatsEl.textContent = '–ù–µ—Ç –∫–∞—Ç–µ–≥–æ—Ä–∏–π';
    } else {
      topCatsEl.innerHTML = sortedCats
        .map(([cat, count]) => `<span class="category-badge">${escapeHtml(cat)}: ${count}</span>`)
        .join(' ');
    }
  }
}

// ============================================
// FAVORITES
// ============================================
function toggleFavorite(messageId, content) {
  const index = State.favorites.findIndex(f => f.id === messageId);
  
  if (index >= 0) {
    // Remove from favorites
    State.favorites.splice(index, 1);
    showToast('–£–±—Ä–∞–Ω–æ –∏–∑ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ');
  } else {
    // Add to favorites
    State.favorites.unshift({
      id: messageId,
      content: content,
      addedAt: new Date().toISOString()
    });
    showToast('‚≠ê –î–æ–±–∞–≤–ª–µ–Ω–æ –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ');
  }
  
  saveState();
  renderFavorites();
  
  // Update star icon in chat
  const starBtn = document.querySelector(`[data-star="${messageId}"]`);
  if (starBtn) {
    const icon = starBtn.querySelector('i');
    if (icon) {
      const isFav = State.favorites.some(f => f.id === messageId);
      icon.className = `w-4 h-4 ${isFav ? 'text-yellow-400 fill-yellow-400' : 'text-slate-400'}`;
      starBtn.title = isFav ? '–£–±—Ä–∞—Ç—å –∏–∑ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ' : '–î–æ–±–∞–≤–∏—Ç—å –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ';
    }
  }
}

function renderFavorites() {
  const list = document.getElementById('favorites-list');
  const count = document.getElementById('favorites-count');
  if (!list || !count) return;
  
  list.innerHTML = '';
  count.textContent = `${State.favorites.length} —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ`;
  
  if (State.favorites.length === 0) {
    list.innerHTML = '<div class="text-sm text-slate-500">–ù–µ—Ç –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ. –ù–∞–∂–º–∏ ‚≠ê –Ω–∞ –≤–∞–∂–Ω—ã—Ö –æ—Ç–≤–µ—Ç–∞—Ö!</div>';
    return;
  }
  
  State.favorites.forEach(fav => {
    const div = document.createElement('div');
    div.className = 'library-item';
    
    const preview = fav.content.slice(0, 100) + (fav.content.length > 100 ? '...' : '');
    const date = new Date(fav.addedAt).toLocaleDateString('ru-RU');
    
    div.innerHTML = `
      <div class="flex-1 min-w-0">
        <div class="text-sm text-slate-200 mb-1">${escapeHtml(preview)}</div>
        <div class="text-xs text-slate-500">${date}</div>
      </div>
      <div class="flex items-center gap-2">
        <button class="btn-icon" style="width:36px;height:36px;" data-view="${fav.id}" title="–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å">
          <i data-lucide="eye" class="w-4 h-4"></i>
        </button>
        <button class="btn-delete" style="padding:6px 10px;font-size:11px;" data-unfav="${fav.id}">
          <i data-lucide="x" class="w-3 h-3"></i>
        </button>
      </div>
    `;
    
    const viewBtn = div.querySelector('[data-view]');
    if (viewBtn) {
      viewBtn.addEventListener('click', () => {
        alert(fav.content); // Simple view - can improve later
      });
    }
    
    const unfavBtn = div.querySelector('[data-unfav]');
    if (unfavBtn) {
      unfavBtn.addEventListener('click', () => {
        toggleFavorite(fav.id, fav.content);
      });
    }
    
    list.appendChild(div);
  });
  
  if (window.lucide) lucide.createIcons();
}

// ============================================
// AI PROCESSING
// ============================================
async function sendToGPT(userMessage) {
  const apiKey = State.apiKey.trim();
  
  if (!apiKey) {
    showToast('–î–æ–±–∞–≤—å API –∫–ª—é—á –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö!');
    return;
  }

  // –§–æ—Ä–º–∏—Ä—É–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç –∏–∑ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏
  let libraryContext = '';
  if (State.library.length > 0) {
    libraryContext = '\n\n=== –î–û–°–¢–£–ü–ù–´–ï –ú–ê–¢–ï–†–ò–ê–õ–´ ===\n\n';
    State.library.forEach((item, idx) => {
      libraryContext += `[–§–∞–π–ª ${idx + 1}: ${item.name}]\n${item.content.slice(0, 5000)}\n\n`;
    });
  }

  // –†–∞–∑–Ω—ã–µ —Å–∏—Å—Ç–µ–º–Ω—ã–µ –ø—Ä–æ–º–ø—Ç—ã –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Ä–µ–∂–∏–º–æ–≤
  let systemPrompt = '';
  
  if (State.aiMode === 'search') {
    systemPrompt = `–¢—ã ‚Äî AI-–ø–æ–º–æ—â–Ω–∏–∫ –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø–æ–∏—Å–∫–∞ –≤ –±–∏–±–ª–∏–æ—Ç–µ–∫–µ –∏–ª–ª—é–∑–∏–æ–Ω–∏—Å—Ç–∞.

–ó–∞–¥–∞—á–∞: –ë—ã—Å—Ç—Ä–æ –Ω–∞–π—Ç–∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –≤ –º–∞—Ç–µ—Ä–∏–∞–ª–∞—Ö.

–î–æ—Å—Ç—É–ø–Ω—ã–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã:${libraryContext || '\n(–ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ –ø—É—Å—Ç–∞)'}

–û—Ç–≤–µ—á–∞–π –∫—Ä–∞—Ç–∫–æ –∏ –ø–æ –¥–µ–ª—É. –¶–∏—Ç–∏—Ä—É–π –∏—Å—Ç–æ—á–Ω–∏–∫–∏.`;
  }
  else if (State.aiMode === 'generate') {
    systemPrompt = `–¢—ã ‚Äî –∫—Ä–µ–∞—Ç–∏–≤–Ω—ã–π AI –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –Ω–æ–≤—ã—Ö –∏–¥–µ–π –∏–ª–ª—é–∑–∏–æ–Ω–Ω—ã—Ö –Ω–æ–º–µ—Ä–æ–≤.

–ó–∞–¥–∞—á–∞: –ö–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞—Ç—å —Ç–µ—Ö–Ω–∏–∫–∏ –∏–∑ —Ä–∞–∑–Ω—ã—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ –∏ —Å–æ–∑–¥–∞–≤–∞—Ç—å –Ω–æ–≤—ã–µ –∏–¥–µ–∏.

–î–æ—Å—Ç—É–ø–Ω—ã–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã:${libraryContext || '\n(–ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ –ø—É—Å—Ç–∞)'}

–ë—É–¥—å —Ç–≤–æ—Ä—á–µ—Å–∫–∏–º! –ö–æ–º–±–∏–Ω–∏—Ä—É–π –∏–¥–µ–∏ –∏–∑ —Ä–∞–∑–Ω—ã—Ö –∫–Ω–∏–≥. –ü—Ä–µ–¥–ª–∞–≥–∞–π –Ω–µ–æ–∂–∏–¥–∞–Ω–Ω—ã–µ —Ä–µ—à–µ–Ω–∏—è.`;
  }
  else { // analyze
    systemPrompt = `–¢—ã ‚Äî –∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏–π AI –¥–ª—è –≥–ª—É–±–æ–∫–æ–≥–æ —Ä–∞–∑–±–æ—Ä–∞ –º–∞–≥–∏—á–µ—Å–∫–∏—Ö —Ç–µ—Ö–Ω–∏–∫.

–ó–∞–¥–∞—á–∞: –î–µ—Ç–∞–ª—å–Ω–æ –∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –º–µ—Ç–æ–¥—ã, –æ–±—ä—è—Å–Ω—è—Ç—å –ø—Å–∏—Ö–æ–ª–æ–≥–∏—é, —Å—Ä–∞–≤–Ω–∏–≤–∞—Ç—å –ø–æ–¥—Ö–æ–¥—ã.

–î–æ—Å—Ç—É–ø–Ω—ã–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã:${libraryContext || '\n(–ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ –ø—É—Å—Ç–∞)'}

–î–∞–π –≥–ª—É–±–æ–∫–∏–π –∞–Ω–∞–ª–∏–∑. –†–∞–∑–±–µ—Ä–∏ —Ç–µ—Ö–Ω–∏–∫—É –ø–æ —à–∞–≥–∞–º. –û–±—ä—è—Å–Ω–∏ –ø—Å–∏—Ö–æ–ª–æ–≥–∏—é –≤–æ—Å–ø—Ä–∏—è—Ç–∏—è.`;
  }

  const messages = [
    { role: 'system', content: systemPrompt },
    { role: 'user', content: userMessage }
  ];

  showTypingIndicator();

  try {
    const response = await fetch('https://api.openai.com/v1/chat/completions', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${apiKey}`
      },
      body: JSON.stringify({
        model: 'gpt-4o-mini',
        messages: messages,
        temperature: State.aiMode === 'generate' ? 0.9 : (State.aiMode === 'analyze' ? 0.5 : 0.7),
        max_tokens: 2000
      })
    });

    removeTypingIndicator();

    if (!response.ok) {
      const error = await response.json();
      throw new Error(error.error?.message || 'API Error');
    }

    const data = await response.json();
    const reply = data.choices?.[0]?.message?.content || '–ù–µ—Ç –æ—Ç–≤–µ—Ç–∞';

    addMessage('assistant', reply);

  } catch (err) {
    removeTypingIndicator();
    addMessage('assistant', `–û—à–∏–±–∫–∞: ${err.message}`);
    console.error('GPT Error:', err);
  }
}

// ============================================
// EVENT HANDLERS
// ============================================
function initEventListeners() {
  // Settings modal
  const btnSettings = document.getElementById('btn-settings');
  const btnCloseSettings = document.getElementById('btn-close-settings');
  const settingsModal = document.getElementById('settings-modal');

  if (btnSettings) {
    btnSettings.addEventListener('click', () => {
      if (settingsModal) {
        settingsModal.classList.add('active');
        renderLibrary();
        renderCategoryPills();
        renderFavorites();
        renderStats();
      }
    });
  }

  if (btnCloseSettings) {
    btnCloseSettings.addEventListener('click', () => {
      if (settingsModal) settingsModal.classList.remove('active');
    });
  }

  if (settingsModal) {
    settingsModal.addEventListener('click', (e) => {
      if (e.target === settingsModal) settingsModal.classList.remove('active');
    });
  }

  // API Key
  const apiKeyInput = document.getElementById('api-key-input');
  if (apiKeyInput) {
    apiKeyInput.value = State.apiKey;
    apiKeyInput.addEventListener('change', () => {
      State.apiKey = apiKeyInput.value.trim();
      saveState();
      showToast('API –∫–ª—é—á —Å–æ—Ö—Ä–∞–Ω—ë–Ω');
    });
  }
  
  // Manage categories
  const btnManageCategories = document.getElementById('btn-manage-categories');
  if (btnManageCategories) {
    btnManageCategories.addEventListener('click', manageCategories);
  }
  
  // YouTube link
  const btnAddYoutube = document.getElementById('btn-add-youtube');
  const youtubeInput = document.getElementById('youtube-link-input');
  
  if (btnAddYoutube && youtubeInput) {
    const processYouTube = async () => {
      const url = youtubeInput.value.trim();
      if (!url) {
        showToast('–í—Å—Ç–∞–≤—å —Å—Å—ã–ª–∫—É –Ω–∞ YouTube');
        return;
      }
      
      const videoId = extractYouTubeID(url);
      if (!videoId) {
        showToast('‚ùå –ù–µ–≤–µ—Ä–Ω–∞—è —Å—Å—ã–ª–∫–∞ –Ω–∞ YouTube');
        return;
      }
      
      // Show loading
      const originalText = btnAddYoutube.innerHTML;
      btnAddYoutube.innerHTML = '<i data-lucide="loader" class="w-5 h-5 animate-spin"></i>';
      btnAddYoutube.disabled = true;
      if (window.lucide) lucide.createIcons();
      
      showToast('‚è≥ –ü–æ–ª—É—á–∞—é —Å—É–±—Ç–∏—Ç—Ä—ã —Å YouTube...');
      
      try {
        const transcript = await getYouTubeTranscript(videoId);
        
        // –ü–æ–ª—É—á–∞–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ –≤–∏–¥–µ–æ (—É–ø—Ä–æ—â–µ–Ω–Ω–æ)
        const videoTitle = `YouTube: ${videoId}`;
        
        // –î–æ–±–∞–≤–ª—è–µ–º –≤ –±–∏–±–ª–∏–æ—Ç–µ–∫—É
        const videoItem = {
          id: Date.now() + '_' + Math.random().toString(36).slice(2),
          name: videoTitle,
          type: 'video/youtube',
          size: transcript.length,
          content: transcript,
          addedAt: new Date().toISOString(),
          category: '',
          tags: [],
          youtubeUrl: url,
          videoId: videoId
        };
        
        State.library.push(videoItem);
        saveState();
        renderLibrary();
        renderCategoryPills();
        renderStats();
        
        youtubeInput.value = '';
        showToast('‚úÖ YouTube –≤–∏–¥–µ–æ –¥–æ–±–∞–≤–ª–µ–Ω–æ!');
        
      } catch (err) {
        showToast('‚ùå –û—à–∏–±–∫–∞: ' + err.message);
      } finally {
        btnAddYoutube.innerHTML = originalText;
        btnAddYoutube.disabled = false;
        if (window.lucide) lucide.createIcons();
      }
    };
    
    btnAddYoutube.addEventListener('click', processYouTube);
    
    youtubeInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        e.preventDefault();
        processYouTube();
      }
    });
  }

  // File upload
  const btnAddFile = document.getElementById('btn-add-file');
  const fileInput = document.getElementById('file-input');

  if (btnAddFile && fileInput) {
    btnAddFile.addEventListener('click', () => fileInput.click());

    fileInput.addEventListener('change', async (e) => {
      const files = e.target.files;
      if (!files || files.length === 0) return;

      // Show loading
      const originalText = btnAddFile.innerHTML;
      btnAddFile.disabled = true;

      let successCount = 0;

      for (let i = 0; i < files.length; i++) {
        const file = files[i];
        const isImage = file.type.startsWith('image/');
        
        if (isImage) {
          // Show OCR progress
          btnAddFile.innerHTML = `<i data-lucide="loader" class="w-5 h-5 animate-spin"></i><span>OCR: ${file.name.slice(0, 15)}... (0%)</span>`;
          if (window.lucide) lucide.createIcons();
          
          const onProgress = (percent) => {
            btnAddFile.innerHTML = `<i data-lucide="loader" class="w-5 h-5 animate-spin"></i><span>OCR: (${percent}%)</span>`;
            if (window.lucide) lucide.createIcons();
          };
          
          const processed = await processFile(file, onProgress);
          if (processed) {
            State.library.push(processed);
            successCount++;
          }
        } else {
          btnAddFile.innerHTML = `<i data-lucide="loader" class="w-5 h-5 animate-spin"></i><span>–û–±—Ä–∞–±–æ—Ç–∫–∞ ${i + 1}/${files.length}</span>`;
          if (window.lucide) lucide.createIcons();
          showToast(`–û–±—Ä–∞–±–æ—Ç–∫–∞ ${i + 1}/${files.length}: ${file.name}`);
          
          const processed = await processFile(file);
          if (processed) {
            State.library.push(processed);
            successCount++;
          }
        }
      }

      saveState();
      renderLibrary();
      renderCategoryPills();
      
      // Restore button
      btnAddFile.innerHTML = originalText;
      btnAddFile.disabled = false;
      if (window.lucide) lucide.createIcons();

      showToast(`‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–æ: ${successCount} –∏–∑ ${files.length}`);

      fileInput.value = '';
    });
  }
  
  // Export/Import
  const btnExport = document.getElementById('btn-export-library');
  const btnImport = document.getElementById('btn-import-library');
  const importInput = document.getElementById('import-input');
  
  if (btnExport) {
    btnExport.addEventListener('click', exportLibrary);
  }
  
  if (btnImport && importInput) {
    btnImport.addEventListener('click', () => importInput.click());
    
    importInput.addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (file) {
        importLibrary(file);
        importInput.value = '';
      }
    });
  }
  
  // AI Mode Selector
  const modeButtons = document.querySelectorAll('.ai-mode-btn');
  modeButtons.forEach(btn => {
    btn.addEventListener('click', () => {
      const mode = btn.dataset.mode;
      State.aiMode = mode;
      saveState();
      
      // Update active class
      modeButtons.forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      
      // Update placeholder
      const searchInput = document.getElementById('search-input');
      if (searchInput) {
        if (mode === 'search') {
          searchInput.placeholder = '–ù–∞–π–¥–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –≤ –±–∏–±–ª–∏–æ—Ç–µ–∫–µ...';
        } else if (mode === 'generate') {
          searchInput.placeholder = '–ü—Ä–∏–¥—É–º–∞–π –Ω–æ–≤—É—é –∏–¥–µ—é...';
        } else {
          searchInput.placeholder = '–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π —Ç–µ—Ö–Ω–∏–∫—É...';
        }
      }
      
      showToast(`–†–µ–∂–∏–º: ${mode === 'search' ? 'üîç –ü–æ–∏—Å–∫' : mode === 'generate' ? 'üí° –ò–¥–µ–∏' : 'üî¨ –ê–Ω–∞–ª–∏–∑'}`);
    });
  });

  // Search
  const searchInput = document.getElementById('search-input');
  const btnSend = document.getElementById('btn-send');
  const btnHistory = document.getElementById('btn-history');

  const handleSend = async () => {
    const query = searchInput.value.trim();
    if (!query) return;

    addMessage('user', query);
    addToSearchHistory(query); // Save to history
    searchInput.value = '';
    
    // Hide history dropdown
    const historyDiv = document.getElementById('search-history');
    if (historyDiv) historyDiv.classList.add('hidden');

    await sendToGPT(query);
  };

  if (btnSend) {
    btnSend.addEventListener('click', handleSend);
  }
  
  if (btnHistory) {
    btnHistory.addEventListener('click', toggleSearchHistory);
  }

  if (searchInput) {
    searchInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        handleSend();
      }
    });
    
    // Hide history on focus
    searchInput.addEventListener('focus', () => {
      const historyDiv = document.getElementById('search-history');
      if (historyDiv && !historyDiv.classList.contains('hidden')) {
        historyDiv.classList.add('hidden');
      }
    });
  }
}

// ============================================
// INIT
// ============================================
function init() {
  loadState();
  initEventListeners();
  renderLibrary();
  renderCategoryPills();

  // Restore chat
  const container = document.getElementById('chat-container');
  if (container && State.messages.length > 0) {
    State.messages.forEach(msg => {
      const msgDiv = document.createElement('div');
      msgDiv.className = `message ${msg.role}`;

      const avatar = msg.role === 'user' ? 'üé©' : 'üìö';
      
      // Check if already in favorites
      const isFavorite = msg.role === 'assistant' && State.favorites.some(f => f.id === msg.id);
      
      const starButton = msg.role === 'assistant' 
        ? `<button class="btn-icon ml-2" style="width:36px;height:36px;" data-star="${msg.id}" title="${isFavorite ? '–£–±—Ä–∞—Ç—å –∏–∑ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ' : '–î–æ–±–∞–≤–∏—Ç—å –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ'}">
            <i data-lucide="${isFavorite ? 'star' : 'star'}" class="w-4 h-4 ${isFavorite ? 'text-yellow-400 fill-yellow-400' : 'text-slate-400'}"></i>
           </button>`
        : '';
      
      msgDiv.innerHTML = `
        <div class="message-avatar">${avatar}</div>
        <div class="flex-1">
          <div class="message-content">${escapeHtml(msg.content)}</div>
        </div>
        ${starButton}
      `;
      
      // Star button handler
      if (msg.role === 'assistant') {
        const starBtn = msgDiv.querySelector('[data-star]');
        if (starBtn) {
          starBtn.addEventListener('click', () => toggleFavorite(msg.id, msg.content));
        }
      }

      container.appendChild(msgDiv);
    });
    
    // –ü—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º –≤ –∫–æ–Ω–µ—Ü –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ –≤—Å–µ—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
    setTimeout(() => {
      window.scrollTo({
        top: document.documentElement.scrollHeight,
        behavior: 'auto'
      });
    }, 200);
  }

  // Init Lucide
  if (window.lucide) lucide.createIcons();

  // Hide splash
  setTimeout(() => {
    const splash = document.getElementById('splash-screen');
    if (splash) {
      splash.style.opacity = '0';
      splash.style.transition = 'opacity 0.8s';
      setTimeout(() => splash.remove(), 800);
    }
  }, 2000);
}

// Start
document.addEventListener('DOMContentLoaded', init);
</script>

</body>
</html>