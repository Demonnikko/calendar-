<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
  <title>Illusionist OS: Grimoire</title>

  <!-- iOS PWA-ish -->
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="Illusionist OS" />
  <meta name="theme-color" content="#050507" />
  <link rel="apple-touch-icon" href="./icon.png" />

  <!-- Manifest inlined via data URL -->
  <link id="dyn-manifest" rel="manifest" />

  <!-- CDNs -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;800&family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet" />

  <style>
    :root{
      --bg: #050507;
      --panel: rgba(255,255,255,.10);
      --panel2: rgba(255,255,255,.12);
      --stroke: rgba(255,255,255,.15);
      --gold: #f59e0b;
      --muted: #94a3b8;
      --text: #f1f5f9;
      --safe-top: env(safe-area-inset-top, 0px);
      --safe-bottom: env(safe-area-inset-bottom, 0px);
      --safe-left: env(safe-area-inset-left, 0px);
      --safe-right: env(safe-area-inset-right, 0px);
      --font-display: 'Cinzel', serif;
      --font-body: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Helvetica Neue', Arial, sans-serif;
      --font-mono: 'JetBrains Mono', 'SF Mono', Monaco, monospace;
    }

    *, *::before, *::after {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      max-width: 100%;
    }

    html, body {
      height: 100%;
      background: var(--bg);
      color: var(--text);
      overflow-x: hidden !important;
      max-width: 100vw !important;
      width: 100% !important;
      height: -webkit-fill-available;
      scroll-behavior: smooth;
      font-size: 16px;
    }

    body{
      font-family: var(--font-body);
      overflow-x: hidden;
      min-height: 100vh;
      min-height: -webkit-fill-available;
      min-height: 100dvh;
      padding: 0;
      margin: 0;
      overscroll-behavior: none;
      -webkit-tap-highlight-color: transparent;
      -webkit-user-select: none;
      user-select: none;
      position: relative;
    }

    * {
      -webkit-touch-callout: none;
      -webkit-tap-highlight-color: transparent;
    }

    input, textarea {
      -webkit-user-select: text;
      user-select: text;
    }

    h1,h2,h3,.font-display{
      font-family: var(--font-display);
      font-weight: 600;
      letter-spacing: 0.05em;
    }

    .noise-overlay{
      position:fixed;inset:0;
      pointer-events:none;z-index:0;opacity:.03;
      background-image:url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.65' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)'/%3E%3C/svg%3E");
    }

    .glass{
      background: transparent;
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
      border: 1.5px solid rgba(245,158,11,0.2);
      box-shadow: none;
      border-radius: 24px;
      position: relative;
      overflow-x: hidden;
    }

    ::-webkit-scrollbar{width:4px}
    ::-webkit-scrollbar-track{background:transparent}
    ::-webkit-scrollbar-thumb{background:rgba(255,255,255,.1);border-radius:10px}

    .magic-input {
      background: rgba(255,255,255,0.04);
      border: 1px solid rgba(245,158,11,0.15);
      color: var(--text);
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      border-radius: 12px;
      padding: 12px 16px;
      font-family: var(--font-body);
    }
    .magic-input:focus {
      border-color: rgba(245,158,11,0.5);
      background: rgba(255,255,255,0.06);
      box-shadow: 0 0 0 3px rgba(245,158,11,0.1), 0 8px 24px rgba(245,158,11,0.15);
      outline: none;
    }

    .notes-grid{
      display:grid;
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
      gap: 1rem;
      align-items: start;
    }
    .notes-list{
      display:flex;
      flex-direction:column;
      gap: 0.75rem;
    }

    /* Card actions */
    .card-actions{
      display:flex;
      gap:6px;
      align-items:center;
      opacity: 0.0;
      transform: translateY(-2px);
      transition: opacity .18s ease, transform .18s ease;
    }
    .note-card:hover .card-actions{ opacity: 1; transform: translateY(0); }
    @media (hover: none){
      .card-actions{ opacity: 1; transform:none; } /* mobile: always visible */
    }

    /* Teleprompter */
    .prompter-mirror { transform: scaleX(-1); }
    #prompter-scroll-area{
      scroll-behavior:auto;
      mask-image: linear-gradient(to bottom, transparent 0%, black 10%, black 90%, transparent 100%);
      -webkit-mask-image: linear-gradient(to bottom, transparent 0%, black 10%, black 90%, transparent 100%);
    }

    /* Toast */
    #toast-wrap{
      position: fixed;
      left: calc(12px + var(--safe-left));
      right: calc(12px + var(--safe-right));
      top: calc(10px + var(--safe-top));
      z-index: 1000;
      pointer-events:none;
      display:flex;
      justify-content:center;
    }
    .toast{
      pointer-events:auto;
      max-width: 760px;
      width: 100%;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(15,17,21,.85);
      backdrop-filter: blur(18px);
      -webkit-backdrop-filter: blur(18px);
      box-shadow: 0 10px 35px rgba(0,0,0,.55);
      border-radius: 14px;
      padding: 10px 12px;
      display:flex;
      gap:10px;
      align-items:flex-start;
      animation: toastIn .22s ease-out forwards;
    }
    @keyframes toastIn{from{opacity:0;transform:translateY(-8px)}to{opacity:1;transform:translateY(0)}}
    @keyframes toastOut{to{opacity:0;transform:translateY(-8px)}}
    .toast.out{animation: toastOut .18s ease-in forwards}

    /* Popover */
    .popover{
      position:absolute;
      top: calc(100% + 8px);
      right: 0;
      width: min(380px, calc(100vw - 24px));
      z-index: 200;
      border-radius: 14px;
      overflow:hidden;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(15,17,21,.92);
      backdrop-filter: blur(18px);
      -webkit-backdrop-filter: blur(18px);
      box-shadow: 0 12px 40px rgba(0,0,0,.6);
      display:none;
    }
    .popover.show{display:block}

    /* Mini checklist popover */
    .mini-pop{
      position:absolute;
      inset: auto 12px 12px 12px;
      z-index: 30;
      border-radius: 14px;
      overflow:hidden;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(10,12,16,.92);
      backdrop-filter: blur(18px);
      -webkit-backdrop-filter: blur(18px);
      box-shadow: 0 14px 46px rgba(0,0,0,.65);
      display:none;
      max-height: 260px;
    }
    .mini-pop.show{display:block}

    /* Tag chip */
    .tagchip{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
      color: rgba(226,232,240,.9);
      font-size: 10px;
      font-weight: 700;
      letter-spacing: .08em;
      text-transform: uppercase;
      cursor:pointer;
      user-select:none;
    }
    .tagchip:hover{ background: rgba(255,255,255,.07); }

    @media (prefers-reduced-motion: reduce){
      * { animation: none !important; transition: none !important; scroll-behavior: auto !important; }
    }
  </style>
</head>

<body class="flex flex-col" style="padding-top: var(--safe-top); padding-bottom: var(--safe-bottom);">
  <div class="noise-overlay"></div>
  <div class="fixed inset-0 bg-gradient-to-br from-indigo-950/30 via-transparent to-amber-950/20 pointer-events-none z-[-1]"></div>
  <canvas id="bg-canvas" class="fixed inset-0 z-[-1]"></canvas>

  <div id="toast-wrap"></div>

  <!-- Header -->
  <header class="sticky top-0 z-40 bg-[#050507]/80 backdrop-blur-md border-b border-white/5 px-4 py-3"
          style="padding-top: calc(12px + var(--safe-top)); padding-left: calc(16px + var(--safe-left)); padding-right: calc(16px + var(--safe-right));">
    <div class="max-w-7xl mx-auto flex flex-col gap-3">

      <div class="flex items-center justify-between gap-4">
        <div class="flex items-center gap-4 flex-1 min-w-0">
          <div class="relative w-12 h-12 flex-shrink-0 flex items-center justify-center rounded-2xl"
               style="background: radial-gradient(120% 120% at 30% 20%, rgba(245,158,11,.22) 0%, rgba(245,158,11,0) 55%),
                       radial-gradient(120% 120% at 70% 80%, rgba(168,85,247,.18) 0%, rgba(168,85,247,0) 55%),
                       rgba(10,10,14,.88);
                       border: 1px solid rgba(245,158,11,.22);
                       box-shadow: 0 10px 28px rgba(0,0,0,.55), inset 0 0 0 1px rgba(255,255,255,.05);">
            <i data-lucide="book-open" class="w-6 h-6 text-amber-500"></i>
          </div>
          <div class="flex-1 min-w-0">
            <div style="font-family: Georgia, 'Palatino Linotype', 'Book Antiqua', Palatino, 'Times New Roman', serif; font-weight: 600; letter-spacing: 0.05em; color: #fff; font-size: 20px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">Illusionist OS</div>
            <div style="font-size: 14px; color: #94a3b8; font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">–£–º–Ω—ã–µ –∑–∞–º–µ—Ç–∫–∏</div>
          </div>
        </div>

        <div class="flex items-center gap-2 shrink-0 relative">
          <button id="btn-view" onclick="window.toggleViewMode()"
                  class="w-12 h-12 rounded-2xl bg-white/5 border border-amber-500/20 flex items-center justify-center hover:bg-amber-500/10 hover:border-amber-500/30 transition"
                  title="–í–∏–¥">
            <i data-lucide="layout-grid" class="w-5 h-5 text-amber-400"></i>
          </button>

          <button id="btn-settings" onclick="window.openSettingsModal()"
                  class="w-12 h-12 rounded-2xl bg-white/5 border border-amber-500/20 flex items-center justify-center hover:bg-amber-500/10 hover:border-amber-500/30 transition"
                  title="–ù–∞—Å—Ç—Ä–æ–π–∫–∏">
            <i data-lucide="settings" class="w-5 h-5 text-amber-400"></i>
          </button>
        </div>
      </div>

      <!-- Search + Sort -->
      <div class="flex items-center gap-2">
        <div class="relative flex-1">
          <i data-lucide="search" class="absolute left-2.5 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-500"></i>
          <input id="search-input"
                 type="text"
                 placeholder="–ü–æ–∏—Å–∫ –ø–æ —Ç–µ–∫—Å—Ç—É –∏–ª–∏ #—Ç–µ–≥–∞–º..."
                 class="w-full bg-white/5 border border-amber-500/15 rounded-lg pl-9 pr-3 py-2.5 text-sm text-white focus:border-amber-500/50 focus:bg-white/8 outline-none transition-all placeholder:text-slate-500">
        </div>

        <select id="sort-select"
                class="bg-white/5 border border-white/10 rounded-lg px-3 py-2 text-xs text-slate-200 outline-none focus:border-amber-500/50"
                onchange="window.renderNotes()">
          <option value="pinned_then_updated_desc">–°–Ω–∞—á–∞–ª–∞ pinned, –ø–æ—Ç–æ–º –Ω–æ–≤—ã–µ</option>
          <option value="updated_desc">–°–Ω–∞—á–∞–ª–∞ –Ω–æ–≤—ã–µ</option>
          <option value="updated_asc">–°–Ω–∞—á–∞–ª–∞ —Å—Ç–∞—Ä—ã–µ</option>
          <option value="title_asc">–ü–æ –Ω–∞–∑–≤–∞–Ω–∏—é A‚Üí–Ø</option>
          <option value="title_desc">–ü–æ –Ω–∞–∑–≤–∞–Ω–∏—é –Ø‚ÜíA</option>
          <option value="type">–ü–æ —Ç–∏–ø—É</option>
        </select>
      </div>

      <!-- Filters -->
      <div class="flex gap-2 overflow-x-auto no-scrollbar pb-1">
        <button onclick="window.setFilter('all')" class="filter-btn whitespace-nowrap px-4 py-2 rounded-xl text-xs font-bold uppercase tracking-wide border border-amber-500 bg-amber-500/10 text-amber-400 transition-all" data-type="all">–í—Å–µ</button>
        <button onclick="window.setFilter('idea')" class="filter-btn whitespace-nowrap px-4 py-2 rounded-xl text-xs font-bold uppercase tracking-wide border border-white/10 bg-white/5 text-slate-300 hover:text-amber-400 hover:border-amber-500/30 transition-all" data-type="idea">–ò–¥–µ–∏</button>
        <button onclick="window.setFilter('script')" class="filter-btn whitespace-nowrap px-4 py-2 rounded-xl text-xs font-bold uppercase tracking-wide border border-white/10 bg-white/5 text-slate-300 hover:text-amber-400 hover:border-amber-500/30 transition-all" data-type="script">–°—Ü–µ–Ω–∞—Ä–∏–∏</button>
        <button onclick="window.setFilter('secret')" class="filter-btn whitespace-nowrap px-4 py-2 rounded-xl text-xs font-bold uppercase tracking-wide border border-white/10 bg-white/5 text-slate-300 hover:text-amber-400 hover:border-amber-500/30 transition-all" data-type="secret">–°–µ–∫—Ä–µ—Ç—ã</button>
        <button onclick="window.setFilter('checklist')" class="filter-btn whitespace-nowrap px-4 py-2 rounded-xl text-xs font-bold uppercase tracking-wide border border-white/10 bg-white/5 text-slate-300 hover:text-amber-400 hover:border-amber-500/30 transition-all" data-type="checklist">–ß–µ–∫-–ª–∏—Å—Ç—ã</button>
      </div>
    </div>
  </header>

  <main class="flex-1 max-w-7xl mx-auto w-full p-4" style="padding-left: calc(16px + var(--safe-left)); padding-right: calc(16px + var(--safe-right));">
    <div id="notes-grid" class="notes-grid"></div>

    <div id="empty-state" class="hidden flex flex-col items-center justify-center mt-20 opacity-40">
      <i data-lucide="file-text" class="w-16 h-16 text-slate-600 mb-4"></i>
      <p class="text-slate-500 text-sm">–ù–µ—Ç –∑–∞–º–µ—Ç–æ–∫</p>
      <p class="text-slate-600 text-xs mt-2">–ù–∞–∂–º–∏—Ç–µ + —á—Ç–æ–±—ã —Å–æ–∑–¥–∞—Ç—å</p>
    </div>
  </main>

  <!-- FAB -->
  <button onclick="window.openModal()"
          class="fixed w-14 h-14 rounded-full bg-gradient-to-r from-amber-500 to-orange-600 text-white shadow-[0_0_20px_rgba(245,158,11,0.4)] flex items-center justify-center z-30 hover:scale-110 transition-transform active:scale-95 border border-white/20"
          style="right: calc(1.5rem + var(--safe-right)); bottom: calc(1.5rem + var(--safe-bottom));">
    <i data-lucide="plus" class="w-7 h-7"></i>
  </button>

  <!-- Editor Modal -->
  <div id="editor-modal" class="fixed inset-0 z-50 hidden">
    <div class="absolute inset-0 bg-black/80 backdrop-blur-sm" onclick="window.closeModal()"></div>

    <div class="absolute inset-x-0 bottom-0 md:top-1/2 md:bottom-auto md:left-1/2 md:-translate-x-1/2 md:-translate-y-1/2 md:w-[680px] md:max-h-[85vh]
                h-[92vh] bg-[#0f1115] md:rounded-2xl rounded-t-2xl border border-white/10 shadow-2xl flex flex-col"
         style="padding-bottom: var(--safe-bottom);">

      <!-- Draft banner -->
      <div id="draft-banner" class="hidden px-4 py-3 border-b border-white/5 bg-white/[0.02]">
        <div class="flex items-center justify-between gap-3">
          <div class="text-xs text-slate-300 flex items-center gap-2">
            <i data-lucide="sparkles" class="w-4 h-4 text-amber-400"></i>
            –ù–∞–π–¥–µ–Ω —á–µ—Ä–Ω–æ–≤–∏–∫. –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å?
          </div>
          <div class="flex gap-2">
            <button onclick="window.restoreDraft()" class="px-3 py-1.5 rounded-lg bg-amber-500/15 border border-amber-500/25 text-amber-300 text-[10px] font-bold uppercase">–î–∞</button>
            <button onclick="window.discardDraft()" class="px-3 py-1.5 rounded-lg bg-white/5 border border-white/10 text-slate-300 text-[10px] font-bold uppercase">–ù–µ—Ç</button>
          </div>
        </div>
      </div>

      <!-- Modal Header -->
      <div class="flex items-center justify-between p-4 border-b border-white/5" style="background: linear-gradient(180deg, rgba(245,158,11,0.03) 0%, transparent 100%);">
        <div class="flex gap-2 overflow-x-auto no-scrollbar flex-1">
          <button onclick="window.setEditorType('idea')" class="type-sel px-4 py-2 rounded-xl text-xs font-bold uppercase border border-amber-500 bg-amber-500/10 text-amber-400 transition flex items-center gap-2" id="type-btn-idea">
            <i data-lucide="lightbulb" class="w-4 h-4"></i>–ò–î–ï–Ø
          </button>
          <button onclick="window.setEditorType('script')" class="type-sel px-4 py-2 rounded-xl text-xs font-bold uppercase border border-white/10 bg-white/5 text-slate-300 hover:text-amber-400 hover:border-amber-500/30 transition flex items-center gap-2" id="type-btn-script">
            <i data-lucide="scroll-text" class="w-4 h-4"></i>–°–¶–ï–ù–ê–†–ò–ô
          </button>
          <button onclick="window.setEditorType('secret')" class="type-sel px-4 py-2 rounded-xl text-xs font-bold uppercase border border-white/10 bg-white/5 text-slate-300 hover:text-amber-400 hover:border-amber-500/30 transition flex items-center gap-2" id="type-btn-secret">
            <i data-lucide="eye-off" class="w-4 h-4"></i>–°–ï–ö–†–ï–¢
          </button>
          <button onclick="window.setEditorType('checklist')" class="type-sel px-4 py-2 rounded-xl text-xs font-bold uppercase border border-white/10 bg-white/5 text-slate-300 hover:text-amber-400 hover:border-amber-500/30 transition flex items-center gap-2" id="type-btn-checklist">
            <i data-lucide="list-checks" class="w-4 h-4"></i>–ß–ï–ö-–õ–ò–°–¢
          </button>
        </div>

        <button onclick="window.closeModal()" class="w-11 h-11 rounded-xl bg-white/5 border border-amber-500/20 flex items-center justify-center hover:bg-amber-500/10 hover:border-amber-500/30 transition ml-3" title="–ó–∞–∫—Ä—ã—Ç—å">
          <i data-lucide="x" class="w-5 h-5 text-amber-400"></i>
        </button>
      </div>

      <!-- Modal Body -->
      <div class="flex-1 overflow-y-auto p-5 space-y-5" style="overscroll-behavior: contain;">
        <div class="space-y-3">
          <input type="text" id="inp-title" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ‚Ä¶ (–º–æ–∂–Ω–æ –ø–∏—Å–∞—Ç—å #—Ç–µ–≥–∏ –ø—Ä—è–º–æ —Ç—É—Ç)"
                 class="w-full bg-transparent border-none text-xl md:text-2xl font-display font-bold text-white placeholder:text-slate-600 outline-none p-0">

          <div class="flex items-center justify-between flex-wrap gap-3">
            <div class="flex gap-2 overflow-x-auto no-scrollbar">
              <button onclick="window.setCategory('cards')" class="cat-btn p-2.5 rounded-xl bg-white/5 border border-amber-500/15 text-slate-300 hover:text-purple-400 hover:border-purple-500/40 hover:bg-purple-500/10 transition" id="cat-cards" title="–ö–∞—Ä—Ç—ã"><i data-lucide="spade" class="w-5 h-5"></i></button>
              <button onclick="window.setCategory('coins')" class="cat-btn p-2.5 rounded-xl bg-white/5 border border-amber-500/15 text-slate-300 hover:text-yellow-400 hover:border-yellow-500/40 hover:bg-yellow-500/10 transition" id="cat-coins" title="–ú–æ–Ω–µ—Ç—ã"><i data-lucide="coins" class="w-5 h-5"></i></button>
              <button onclick="window.setCategory('mental')" class="cat-btn p-2.5 rounded-xl bg-white/5 border border-amber-500/15 text-slate-300 hover:text-emerald-400 hover:border-emerald-500/40 hover:bg-emerald-500/10 transition" id="cat-mental" title="–ú–µ–Ω—Ç–∞–ª–∏–∑–º"><i data-lucide="brain-circuit" class="w-5 h-5"></i></button>
              <button onclick="window.setCategory('stage')" class="cat-btn p-2.5 rounded-xl bg-white/5 border border-amber-500/15 text-slate-300 hover:text-amber-400 hover:border-amber-500/40 hover:bg-amber-500/10 transition" id="cat-stage" title="–°—Ü–µ–Ω–∞"><i data-lucide="curtain" class="w-5 h-5"></i></button>
              <button onclick="window.setCategory('tech')" class="cat-btn p-2.5 rounded-xl bg-white/5 border border-amber-500/15 text-slate-300 hover:text-blue-400 hover:border-blue-500/40 hover:bg-blue-500/10 transition" id="cat-tech" title="–¢–µ—Ö–Ω–∏–∫–∞"><i data-lucide="hammer" class="w-5 h-5"></i></button>
            </div>

            <div class="flex items-center gap-2 bg-black/30 px-4 py-2 rounded-xl border border-amber-500/20">
              <i data-lucide="timer" class="w-4 h-4 text-amber-500"></i>
              <span id="timer-display" class="font-mono text-sm text-amber-400 font-bold">00:00</span>
              <button onclick="window.toggleTimer()" id="timer-btn" class="text-xs uppercase font-bold text-slate-300 hover:text-amber-400 ml-2">–°–¢–ê–†–¢</button>
            </div>
          </div>
        </div>

        <hr class="border-white/5">

        <!-- IDEA -->
        <div id="area-idea" class="editor-area">
          <textarea id="inp-idea" class="magic-input w-full h-64 rounded-xl p-4 text-sm resize-none"
                    placeholder="–û–ø–∏—à–∏ –∏–¥–µ—é, –º–µ—Ç–æ–¥ –∏–ª–∏ –º—ã—Å–ª—å‚Ä¶ (–º–æ–∂–Ω–æ –¥–æ–±–∞–≤–ª—è—Ç—å #—Ç–µ–≥–∏)"></textarea>
          <div class="mt-3 flex gap-2 flex-wrap">
            <button onclick="window.applyTemplate('idea_basic')" class="px-3 py-1.5 rounded-lg bg-white/5 border border-white/10 text-[10px] font-bold uppercase text-slate-200 hover:bg-white/10">–°–∫–µ–ª–µ—Ç –∏–¥–µ–∏</button>
            <button onclick="window.applyTemplate('idea_presentation')" class="px-3 py-1.5 rounded-lg bg-white/5 border border-white/10 text-[10px] font-bold uppercase text-slate-200 hover:bg-white/10">–ü–æ–¥–∞—á–∞</button>
            <button onclick="window.applyTemplate('idea_risks')" class="px-3 py-1.5 rounded-lg bg-white/5 border border-white/10 text-[10px] font-bold uppercase text-slate-200 hover:bg-white/10">–†–∏—Å–∫–∏/–ø—Ä–æ–≤–∞–ª—ã</button>
          </div>
        </div>

        <!-- SCRIPT -->
        <div id="area-script" class="editor-area hidden h-80 flex-col gap-3">
          <div class="flex justify-between items-center">
            <div class="text-[10px] uppercase font-bold text-slate-600">–ü–∞—Ç—Ç–µ—Ä / –î–µ–π—Å—Ç–≤–∏—è</div>
            <button onclick="window.startTeleprompter()"
                    class="flex items-center gap-2 px-3 py-1.5 rounded-lg bg-emerald-500/10 border border-emerald-500/20 text-emerald-400 text-[10px] font-bold uppercase hover:bg-emerald-500/20 transition">
              <i data-lucide="play-circle" class="w-3 h-3"></i> –¢–µ–ª–µ—Å—É—Ñ–ª–µ—Ä
            </button>
          </div>

          <div class="flex-1 flex flex-col md:flex-row gap-3 min-h-0">
            <div class="flex-1 flex flex-col h-full">
              <label class="text-[10px] uppercase font-bold text-slate-500 mb-1 flex items-center gap-1"><i data-lucide="mic" class="w-3 h-3"></i> –†–µ—á—å</label>
              <textarea id="inp-script-speech" class="magic-input flex-1 w-full rounded-xl p-3 text-sm resize-none" placeholder="–¢–µ–∫—Å—Ç –¥–ª—è —Å—É—Ñ–ª—ë—Ä–∞‚Ä¶ (#—Ç–µ–≥–∏ —Ç–æ–∂–µ –º–æ–∂–Ω–æ)"></textarea>
            </div>
            <div class="flex-1 flex flex-col h-full">
              <label class="text-[10px] uppercase font-bold text-slate-500 mb-1 flex items-center gap-1"><i data-lucide="hand" class="w-3 h-3"></i> –î–µ–π—Å—Ç–≤–∏—è</label>
              <textarea id="inp-script-action" class="magic-input flex-1 w-full rounded-xl p-3 text-sm resize-none italic text-slate-300" placeholder="–ß—Ç–æ –¥–µ–ª–∞—é—Ç —Ä—É–∫–∏, –ø–∞—É–∑—ã, –≤–∑–≥–ª—è–¥—ã‚Ä¶"></textarea>
            </div>
          </div>

          <div class="mt-1 flex gap-2 flex-wrap">
            <button onclick="window.applyTemplate('script_classic')" class="px-3 py-1.5 rounded-lg bg-white/5 border border-white/10 text-[10px] font-bold uppercase text-slate-200 hover:bg-white/10">–ö–ª–∞—Å—Å–∏–∫–∞ 60‚Äì90—Å</button>
            <button onclick="window.applyTemplate('script_comedy')" class="px-3 py-1.5 rounded-lg bg-white/5 border border-white/10 text-[10px] font-bold uppercase text-slate-200 hover:bg-white/10">Comedy beat</button>
            <button onclick="window.applyTemplate('script_stage')" class="px-3 py-1.5 rounded-lg bg-white/5 border border-white/10 text-[10px] font-bold uppercase text-slate-200 hover:bg-white/10">–°—Ü–µ–Ω–∞</button>
          </div>
        </div>

        <!-- SECRET -->
        <div id="area-secret" class="editor-area hidden">
          <div class="flex items-center justify-between gap-3 mb-2">
            <div class="text-[10px] uppercase font-bold text-red-400 tracking-widest">TOP SECRET</div>
            <button onclick="window.openLockModal()"
                    class="text-[10px] uppercase font-bold text-slate-300 px-3 py-1.5 rounded-lg bg-white/5 border border-white/10 hover:bg-white/10">
              <i data-lucide="shield" class="w-3 h-3 inline mr-1"></i>PIN
            </button>
          </div>
          <textarea id="inp-secret" class="magic-input w-full h-64 rounded-xl p-4 text-sm resize-none border-red-500/20 focus:border-red-500/50"
                    placeholder="–°–µ–∫—Ä–µ—Ç. –ï—Å–ª–∏ PIN –≤–∫–ª—é—á—ë–Ω –∏ —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω ‚Äî —Å–æ—Ö—Ä–∞–Ω—é –ó–ê–®–ò–§–†–û–í–ê–ù–û. (#—Ç–µ–≥–∏ —Ç–æ–∂–µ –º–æ–∂–Ω–æ)"></textarea>
          <p class="text-[10px] text-slate-600 mt-2 flex items-center gap-1">
            <i data-lucide="shield-alert" class="w-3 h-3"></i>
            –ë–µ–∑ PIN ‚Äî —ç—Ç–æ –ø—Ä–æ—Å—Ç–æ —Ç–µ–∫—Å—Ç. –° PIN ‚Äî —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ.
          </p>

          <div class="mt-3 flex gap-2 flex-wrap">
            <button onclick="window.applyTemplate('secret_structure')" class="px-3 py-1.5 rounded-lg bg-white/5 border border-white/10 text-[10px] font-bold uppercase text-slate-200 hover:bg-white/10">–°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Å–µ–∫—Ä–µ—Ç–∞</button>
          </div>
        </div>

        <!-- CHECKLIST -->
        <div id="area-checklist" class="editor-area hidden">
          <div class="flex gap-2 mb-3">
            <input type="text" id="inp-check-item" class="magic-input flex-1 rounded-lg px-3 py-2 text-sm" placeholder="–î–æ–±–∞–≤–∏—Ç—å –ø—É–Ω–∫—Ç‚Ä¶" onkeypress="if(event.key==='Enter') window.addCheckItem()">
            <button onclick="window.addCheckItem()" class="bg-white/10 hover:bg-white/20 rounded-lg px-3 text-white transition" title="–î–æ–±–∞–≤–∏—Ç—å">
              <i data-lucide="plus" class="w-4 h-4"></i>
            </button>
          </div>

          <ul id="checklist-container" class="space-y-2 max-h-60 overflow-y-auto pr-1"></ul>

          <div class="mt-3 flex gap-2 flex-wrap">
            <button onclick="window.applyTemplate('check_micro')" class="px-3 py-1.5 rounded-lg bg-white/5 border border-white/10 text-[10px] font-bold uppercase text-slate-200 hover:bg-white/10">–ú–∏–∫—Ä–æ-—à–æ—É</button>
            <button onclick="window.applyTemplate('check_stage')" class="px-3 py-1.5 rounded-lg bg-white/5 border border-white/10 text-[10px] font-bold uppercase text-slate-200 hover:bg-white/10">–°—Ü–µ–Ω–∞</button>
            <button onclick="window.applyTemplate('check_before_go')" class="px-3 py-1.5 rounded-lg bg-white/5 border border-white/10 text-[10px] font-bold uppercase text-slate-200 hover:bg-white/10">–ü–µ—Ä–µ–¥ –≤—ã—Ö–æ–¥–æ–º</button>
          </div>
        </div>
      </div>

      <!-- Footer -->
      <div class="p-4 border-t border-white/5 bg-black/20 flex gap-3"
           style="padding-bottom: calc(1rem + var(--safe-bottom));">
        <button onclick="window.deleteNote()" id="btn-delete"
                class="px-4 py-3 rounded-xl border border-red-500/20 text-red-400 hover:bg-red-500/10 transition hidden" title="–£–¥–∞–ª–∏—Ç—å">
          <i data-lucide="trash-2" class="w-5 h-5"></i>
        </button>

        <button onclick="window.saveNote()"
                class="flex-1 py-3 rounded-xl bg-gradient-to-r from-amber-500 to-orange-600 text-white font-bold shadow-lg hover:scale-[1.02] transition uppercase tracking-wider text-sm">
          –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
        </button>
      </div>
    </div>
  </div>

  <!-- Teleprompter -->
  <div id="teleprompter" class="fixed inset-0 z-[100] bg-black hidden flex-col">
    <div id="prompter-scroll-area" class="flex-1 overflow-y-scroll no-scrollbar relative w-full" onclick="window.togglePrompterPlay()">
      <div class="max-w-3xl mx-auto px-6 py-[45vh] min-h-full">
        <div id="prompter-content" class="text-white font-display font-bold leading-[1.6] text-center transition-all origin-center"></div>
      </div>
    </div>

    <div class="bg-zinc-900/90 backdrop-blur border-t border-white/10 p-4 flex flex-col gap-3 shrink-0"
         style="padding-bottom: calc(1rem + var(--safe-bottom));">
      <div class="flex items-center justify-between gap-4">
        <div class="flex items-center gap-2 flex-1">
          <i data-lucide="rabbit" class="w-4 h-4 text-slate-400"></i>
          <input type="range" min="0" max="10" step="0.5" value="2" id="prompter-speed"
                 class="w-full accent-amber-500 h-1 bg-white/20 rounded-lg appearance-none cursor-pointer">
        </div>
        <div class="flex items-center gap-2 flex-1">
          <i data-lucide="type" class="w-4 h-4 text-slate-400"></i>
          <input type="range" min="20" max="84" step="2" value="40" id="prompter-font"
                 class="w-full accent-white h-1 bg-white/20 rounded-lg appearance-none cursor-pointer"
                 oninput="window.updatePrompterFont()">
        </div>
      </div>

      <div class="flex items-center justify-between mt-1">
        <button onclick="window.stopTeleprompter()" class="px-4 py-2 rounded-lg bg-white/10 text-xs font-bold uppercase text-slate-300 hover:text-white">–ó–∞–∫—Ä—ã—Ç—å</button>

        <div class="flex items-center gap-3">
          <button onclick="window.togglePrompterMirror()" class="p-3 rounded-full bg-white/5 hover:bg-white/10 text-slate-300" title="–ó–µ—Ä–∫–∞–ª—å–Ω–æ">
            <i data-lucide="flip-horizontal" class="w-5 h-5"></i>
          </button>

          <button onclick="window.togglePrompterPlay()" id="prompter-play-btn"
                  class="w-12 h-12 rounded-full bg-amber-500 text-black flex items-center justify-center shadow-lg hover:scale-105 transition">
            <i data-lucide="pause" class="w-6 h-6 fill-current"></i>
          </button>
        </div>
      </div>

      <div class="text-[10px] text-slate-500 text-center">
        –¢–∞–ø –ø–æ —ç–∫—Ä–∞–Ω—É ‚Äî –ø–∞—É–∑–∞/–ø–ª–µ–π. –°–∫–æ—Ä–æ—Å—Ç—å 0 = —Å—Ç–æ–ø.
      </div>
    </div>
  </div>

  <!-- Settings Modal -->
  <div id="settings-modal" class="fixed inset-0 z-50 hidden">
    <div class="absolute inset-0 bg-black/80 backdrop-blur-sm" onclick="window.closeSettingsModal()"></div>

    <div class="absolute inset-x-0 bottom-0 md:top-1/2 md:bottom-auto md:left-1/2 md:-translate-x-1/2 md:-translate-y-1/2 md:w-[560px] md:max-h-[85vh]
                h-[85vh] bg-[#0f1115] md:rounded-2xl rounded-t-2xl border border-amber-500/20 shadow-2xl flex flex-col">

      <!-- Header -->
      <div class="flex items-center justify-between p-4 border-b border-white/5" style="background: linear-gradient(180deg, rgba(245,158,11,0.03) 0%, transparent 100%);">
        <h2 class="text-xl font-display font-bold text-white flex items-center gap-3">
          <i data-lucide="settings" class="w-6 h-6 text-amber-500"></i>
          –ù–∞—Å—Ç—Ä–æ–π–∫–∏
        </h2>
        <button onclick="window.closeSettingsModal()" class="w-11 h-11 rounded-xl bg-white/5 border border-amber-500/20 flex items-center justify-center hover:bg-amber-500/10 hover:border-amber-500/30 transition">
          <i data-lucide="x" class="w-5 h-5 text-amber-400"></i>
        </button>
      </div>

      <!-- Body -->
      <div class="flex-1 overflow-y-auto p-5 space-y-4">

        <!-- –®–∞–±–ª–æ–Ω—ã -->
        <div class="glass p-4 rounded-2xl border border-amber-500/20">
          <div class="flex items-center gap-3 mb-3">
            <div class="w-10 h-10 rounded-xl bg-amber-500/10 border border-amber-500/20 flex items-center justify-center">
              <i data-lucide="wand-2" class="w-5 h-5 text-amber-500"></i>
            </div>
            <div>
              <div class="font-bold text-white">–®–∞–±–ª–æ–Ω—ã</div>
              <div class="text-xs text-slate-400">–ì–æ—Ç–æ–≤—ã–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –¥–ª—è –∑–∞–º–µ—Ç–æ–∫</div>
            </div>
          </div>
          <button onclick="window.toggleTemplatePopover(); window.closeSettingsModal();" class="w-full py-3 rounded-xl bg-white/5 border border-amber-500/20 hover:bg-amber-500/10 hover:border-amber-500/30 transition text-white font-semibold">
            –û—Ç–∫—Ä—ã—Ç—å —à–∞–±–ª–æ–Ω—ã
          </button>
        </div>

        <!-- –ó–∞—â–∏—Ç–∞ PIN -->
        <div class="glass p-4 rounded-2xl border border-amber-500/20">
          <div class="flex items-center gap-3 mb-3">
            <div class="w-10 h-10 rounded-xl bg-amber-500/10 border border-amber-500/20 flex items-center justify-center">
              <i data-lucide="shield" class="w-5 h-5 text-amber-500"></i>
            </div>
            <div>
              <div class="font-bold text-white">–ó–∞—â–∏—Ç–∞ PIN</div>
              <div class="text-xs text-slate-400">–®–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ —Å–µ–∫—Ä–µ—Ç–Ω—ã—Ö –∑–∞–º–µ—Ç–æ–∫</div>
            </div>
          </div>
          <div id="pin-status-settings" class="text-sm text-slate-300 mb-3 px-3 py-2 bg-black/20 rounded-lg">
            PIN: –≤—ã–∫–ª—é—á–µ–Ω
          </div>
          <button onclick="window.openLockModal(); window.closeSettingsModal();" class="w-full py-3 rounded-xl bg-white/5 border border-amber-500/20 hover:bg-amber-500/10 hover:border-amber-500/30 transition text-white font-semibold">
            –ù–∞—Å—Ç—Ä–æ–∏—Ç—å PIN
          </button>
        </div>

        <!-- –†–µ–∑–µ—Ä–≤–Ω–æ–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ -->
        <div class="glass p-4 rounded-2xl border border-amber-500/20">
          <div class="flex items-center gap-3 mb-4">
            <div class="w-10 h-10 rounded-xl bg-amber-500/10 border border-amber-500/20 flex items-center justify-center">
              <i data-lucide="database" class="w-5 h-5 text-amber-500"></i>
            </div>
            <div>
              <div class="font-bold text-white">–†–µ–∑–µ—Ä–≤–Ω–æ–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ</div>
              <div class="text-xs text-slate-400">–≠–∫—Å–ø–æ—Ä—Ç –∏ –∏–º–ø–æ—Ä—Ç –≤—Å–µ—Ö –∑–∞–º–µ—Ç–æ–∫</div>
            </div>
          </div>
          <div class="flex gap-2">
            <button onclick="window.exportData(); window.closeSettingsModal();" class="flex-1 py-3 rounded-xl bg-white/5 border border-amber-500/20 hover:bg-amber-500/10 hover:border-amber-500/30 transition text-white font-semibold flex items-center justify-center gap-2">
              <i data-lucide="download" class="w-4 h-4"></i>
              –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
            </button>
            <label class="flex-1 py-3 rounded-xl bg-white/5 border border-amber-500/20 hover:bg-amber-500/10 hover:border-amber-500/30 transition text-white font-semibold flex items-center justify-center gap-2 cursor-pointer">
              <i data-lucide="upload" class="w-4 h-4"></i>
              –ó–∞–≥—Ä—É–∑–∏—Ç—å
              <input id="import-file" type="file" accept="application/json" class="hidden" onchange="window.importData(event); window.closeSettingsModal();">
            </label>
          </div>
        </div>

        <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
        <div class="glass p-4 rounded-2xl border border-amber-500/20">
          <div class="flex items-center gap-3 mb-3">
            <div class="w-10 h-10 rounded-xl bg-amber-500/10 border border-amber-500/20 flex items-center justify-center">
              <i data-lucide="bar-chart-2" class="w-5 h-5 text-amber-500"></i>
            </div>
            <div>
              <div class="font-bold text-white">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</div>
              <div class="text-xs text-slate-400">–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∑–∞–º–µ—Ç–∫–∞—Ö</div>
            </div>
          </div>
          <div class="grid grid-cols-2 gap-3">
            <div class="bg-black/20 p-3 rounded-lg">
              <div class="text-2xl font-bold text-amber-400" id="stats-total">0</div>
              <div class="text-xs text-slate-400">–í—Å–µ–≥–æ –∑–∞–º–µ—Ç–æ–∫</div>
            </div>
            <div class="bg-black/20 p-3 rounded-lg">
              <div class="text-2xl font-bold text-amber-400" id="stats-secrets">0</div>
              <div class="text-xs text-slate-400">–°–µ–∫—Ä–µ—Ç–Ω—ã—Ö</div>
            </div>
          </div>
        </div>

      </div>
    </div>
  </div>

  <!-- PIN Modal -->
  <div id="lock-modal" class="fixed inset-0 z-[200] hidden">
    <div class="absolute inset-0 bg-black/80 backdrop-blur-sm" onclick="window.closeLockModal()"></div>

    <div class="absolute inset-x-0 bottom-0 md:top-1/2 md:bottom-auto md:left-1/2 md:-translate-x-1/2 md:-translate-y-1/2 md:w-[560px]
                bg-[#0f1115] md:rounded-2xl rounded-t-2xl border border-white/10 shadow-2xl"
         style="padding-bottom: var(--safe-bottom);">
      <div class="p-4 border-b border-white/5 flex items-center justify-between">
        <div class="flex items-center gap-2">
          <i data-lucide="shield" class="w-5 h-5 text-amber-400"></i>
          <div class="font-display font-bold">PIN / –®–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ ‚Äú–°–µ–∫—Ä–µ—Ç–æ–≤‚Äù</div>
        </div>
        <button onclick="window.closeLockModal()" class="w-9 h-9 rounded-xl bg-white/5 border border-white/10 flex items-center justify-center hover:bg-white/10 transition">
          <i data-lucide="x" class="w-4 h-4 text-slate-300"></i>
        </button>
      </div>

      <div class="p-5 space-y-4">
        <div class="text-xs text-slate-400 leading-relaxed">
          PIN –≤–∫–ª—é—á—ë–Ω ‚Üí —Å–µ–∫—Ä–µ—Ç—ã —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è <span class="text-slate-200 font-semibold">–∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω–æ</span>.
          PIN –≤—ã–∫–ª—é—á–µ–Ω ‚Üí —ç—Ç–æ –ø—Ä–æ—Å—Ç–æ —Ç–µ–∫—Å—Ç (blur –Ω–µ –∑–∞—â–∏—Ç–∞).
        </div>

        <div class="glass rounded-xl p-4 space-y-2">
          <div class="text-[10px] uppercase font-bold tracking-wider text-slate-500">–°—Ç–∞—Ç—É—Å</div>
          <div class="flex items-center justify-between gap-3">
            <div id="pin-status" class="text-sm text-slate-200">‚Äî</div>
            <div id="unlock-status" class="text-xs text-slate-400">‚Äî</div>
          </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
          <div class="space-y-2">
            <div class="text-[10px] uppercase font-bold tracking-wider text-slate-500">–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å / —Å–º–µ–Ω–∏—Ç—å PIN</div>
            <input id="pin-new" type="password" inputmode="numeric" placeholder="–ù–æ–≤—ã–π PIN" class="magic-input w-full rounded-lg px-3 py-2 text-sm">
            <input id="pin-new2" type="password" inputmode="numeric" placeholder="–ü–æ–≤—Ç–æ—Ä–∏ PIN" class="magic-input w-full rounded-lg px-3 py-2 text-sm">
            <button onclick="window.setPin()"
                    class="w-full py-2.5 rounded-lg bg-amber-500/15 border border-amber-500/25 text-amber-300 text-xs font-bold uppercase hover:bg-amber-500/20">
              –°–æ—Ö—Ä–∞–Ω–∏—Ç—å PIN
            </button>
          </div>

          <div class="space-y-2">
            <div class="text-[10px] uppercase font-bold tracking-wider text-slate-500">–†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å</div>
            <input id="pin-enter" type="password" inputmode="numeric" placeholder="–í–≤–µ–¥–∏—Ç–µ PIN" class="magic-input w-full rounded-lg px-3 py-2 text-sm">
            <button onclick="window.unlockPin()"
                    class="w-full py-2.5 rounded-lg bg-white/10 border border-white/10 text-slate-200 text-xs font-bold uppercase hover:bg-white/15">
              –†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å
            </button>

            <div class="pt-2">
              <button onclick="window.clearPin()"
                      class="w-full py-2.5 rounded-lg bg-red-500/10 border border-red-500/20 text-red-300 text-xs font-bold uppercase hover:bg-red-500/15">
                –û—Ç–∫–ª—é—á–∏—Ç—å PIN
              </button>
            </div>
          </div>
        </div>

        <div class="text-[10px] text-slate-600">
          –í–∞–∂–Ω–æ: –µ—Å–ª–∏ –æ—Ç–∫–ª—é—á–∏—Ç—å PIN ‚Äî —É–∂–µ –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω—ã–µ —Å–µ–∫—Ä–µ—Ç—ã –Ω–µ ‚Äú—Ä–∞—Å–∫—Ä–æ—é—Ç—Å—è —Å–∞–º–∏‚Äù.
        </div>
      </div>
    </div>
  </div>

  <script>
    /**********************
     * MANIFEST
     **********************/
    (function setManifest(){
      const icon = "./icon.png";
      const manifest = {
        name: "Illusionist OS: Grimoire",
        short_name: "Illusionist OS",
        start_url: "./index.html",
        display: "standalone",
        background_color: "#050507",
        theme_color: "#050507",
        icons: [
          { src: icon, sizes: "192x192", type: "image/png" },
          { src: icon, sizes: "512x512", type: "image/png" }
        ]
      };
      const json = JSON.stringify(manifest);
      const href = "data:application/manifest+json;charset=utf-8," + encodeURIComponent(json);
      document.getElementById("dyn-manifest").setAttribute("href", href);
    })();

    /**********************
     * CONSTANTS / STORAGE
     **********************/
    const STORAGE_KEY = "illusionist_grimoire_onefile_v2";
    const DRAFT_KEY   = "illusionist_grimoire_draft_onefile_v2";
    const PIN_KEY     = "illusionist_grimoire_pin_onefile_v1";
    const PREF_VIEW   = "illusionist_grimoire_viewmode_v1";

    const CAT_ICONS = {
      cards: "spade",
      coins: "coins",
      mental: "brain-circuit",
      stage: "curtain",
      tech: "hammer",
      general: "sparkles"
    };
    const CAT_COLORS = {
      cards: "text-purple-400",
      coins: "text-yellow-400",
      mental: "text-emerald-400",
      stage: "text-amber-400",
      tech: "text-blue-400",
      general: "text-slate-400"
    };
    const TYPE_LABEL = { idea: '–ò–¥–µ—è', script: '–°—Ü–µ–Ω–∞—Ä–∏–π', secret: '–°–µ–∫—Ä–µ—Ç', checklist: '–ß–µ–∫-–ª–∏—Å—Ç' };

    /**********************
     * STATE
     **********************/
    let notes = [];
    let currentFilter = "all";
    let editingId = null;

    let editorType = "idea";
    let editorCategory = "cards";
    let tempChecklist = [];

    let timerInterval = null;
    let timerSeconds = 0;
    let isTimerRunning = false;

    let prompterRAF = null;
    let prompterPlaying = false;
    let prompterLastTs = 0;
    let isMirrored = false;

    let searchDebounce = null;
    let draftDebounce = null;

    let viewMode = "grid";

    let pinMeta = null;
    let sessionKey = null;
    let isUnlocked = false;

    // open mini checklist popover (only one)
    let openMiniId = null;

    /**********************
     * UTIL
     **********************/
    function escapeHtml(str){
      return String(str ?? "").replace(/[&<>"']/g, s => ({
        "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
      }[s]));
    }
    function haptic(pattern = 10){
      try{ if(navigator.vibrate) navigator.vibrate(pattern); }catch(e){}
    }
    function toast(message, kind="info", timeout=2200){
      const wrap = document.getElementById("toast-wrap");
      const el = document.createElement("div");
      el.className = "toast";
      const icon = kind==="ok" ? "check-circle-2" : kind==="warn" ? "triangle-alert" : kind==="err" ? "x-circle" : "sparkles";
      const tint = kind==="ok" ? "text-emerald-300" : kind==="warn" ? "text-amber-300" : kind==="err" ? "text-red-300" : "text-slate-200";
      el.innerHTML = `
        <i data-lucide="${icon}" class="w-5 h-5 ${tint} mt-[1px] shrink-0"></i>
        <div class="text-xs text-slate-200 leading-relaxed">${message}</div>
      `;
      wrap.innerHTML = "";
      wrap.appendChild(el);
      lucide.createIcons();
      setTimeout(() => {
        el.classList.add("out");
        setTimeout(()=>{ if(wrap.contains(el)) wrap.removeChild(el); }, 220);
      }, timeout);
    }
    function safeConfirm(text){ return confirm(text); }

    async function copyToClipboard(text){
      try{
        await navigator.clipboard.writeText(text);
        toast("–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ.", "ok");
        haptic(8);
        return true;
      }catch(e){
        try{
          const ta = document.createElement("textarea");
          ta.value = text;
          ta.style.position = "fixed";
          ta.style.left = "-9999px";
          document.body.appendChild(ta);
          ta.focus(); ta.select();
          const ok = document.execCommand("copy");
          ta.remove();
          if(ok){
            toast("–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ.", "ok");
            haptic(8);
            return true;
          }
        }catch(_){}
        toast("–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å.", "err");
        haptic([40,40,40]);
        return false;
      }
    }

    /**********************
     * TAGS
     **********************/
    // tags like #—Å—Ü–µ–Ω–∞ #cards #show-1 #—Ç–µ—Å—Ç_2
    const TAG_RE = /(^|\s)#([a-zA-Z–∞-—è–ê-–Ø0-9_\-]{2,32})/g;

    function extractTagsFromText(text){
      const tags = [];
      if(!text) return tags;
      const s = String(text);
      let m;
      while((m = TAG_RE.exec(s)) !== null){
        tags.push(m[2].toLowerCase());
      }
      return tags;
    }
    function uniq(arr){
      return Array.from(new Set(arr.filter(Boolean)));
    }
    function computeTagsForDraft(type, title, contentObj){
      let bag = [];
      bag.push(...extractTagsFromText(title));
      if(type === "idea"){
        bag.push(...extractTagsFromText(contentObj?.text));
      }else if(type === "script"){
        bag.push(...extractTagsFromText(contentObj?.speech));
        bag.push(...extractTagsFromText(contentObj?.action));
      }else if(type === "checklist"){
        const items = contentObj?.items || [];
        items.forEach(i => bag.push(...extractTagsFromText(i.text)));
      }else if(type === "secret"){
        // plain only (when editing before encrypt)
        bag.push(...extractTagsFromText(contentObj?.text));
      }
      // also allow tag by category/type (optional): no, leave it clean
      return uniq(bag).slice(0, 12);
    }

    function parseSearchQuery(q){
      const parts = String(q||"").trim().split(/\s+/).filter(Boolean);
      const tags = [];
      const rest = [];
      parts.forEach(p => {
        if(p.startsWith("#") && p.length > 2){
          tags.push(p.slice(1).toLowerCase());
        }else{
          rest.push(p);
        }
      });
      return { tags: uniq(tags), text: rest.join(" ").toLowerCase() };
    }

    /**********************
     * CRYPTO (PIN)
     **********************/
    function b64FromBytes(bytes){
      let bin=""; bytes.forEach(b=>bin+=String.fromCharCode(b));
      return btoa(bin);
    }
    function bytesFromB64(b64){
      const bin = atob(b64);
      const out = new Uint8Array(bin.length);
      for(let i=0;i<bin.length;i++) out[i]=bin.charCodeAt(i);
      return out;
    }
    async function deriveKeyFromPin(pin, saltBytes, iter=150000){
      const enc = new TextEncoder();
      const baseKey = await crypto.subtle.importKey("raw", enc.encode(pin), "PBKDF2", false, ["deriveKey"]);
      return crypto.subtle.deriveKey(
        { name:"PBKDF2", salt: saltBytes, iterations: iter, hash:"SHA-256" },
        baseKey,
        { name:"AES-GCM", length: 256 },
        false,
        ["encrypt","decrypt"]
      );
    }
    async function encryptText(plain, key){
      const enc = new TextEncoder();
      const iv = crypto.getRandomValues(new Uint8Array(12));
      const cipher = await crypto.subtle.encrypt({name:"AES-GCM", iv}, key, enc.encode(plain));
      const c = new Uint8Array(cipher);
      const payload = new Uint8Array(iv.length + c.length);
      payload.set(iv,0); payload.set(c, iv.length);
      return b64FromBytes(payload);
    }
    async function decryptText(payloadB64, key){
      const payload = bytesFromB64(payloadB64);
      const iv = payload.slice(0,12);
      const data = payload.slice(12);
      const plainBuf = await crypto.subtle.decrypt({name:"AES-GCM", iv}, key, data);
      return new TextDecoder().decode(plainBuf);
    }

    function loadPinMeta(){
      try{
        const raw = localStorage.getItem(PIN_KEY);
        pinMeta = raw ? JSON.parse(raw) : null;
      }catch(e){
        pinMeta = null;
      }
      updateLockUI();
    }
    function updateLockUI(){
      const status = document.getElementById("pin-status");
      const ustatus = document.getElementById("unlock-status");
      if(status && ustatus){
        if(!pinMeta){
          status.textContent = "PIN: –≤—ã–∫–ª—é—á–µ–Ω";
          ustatus.textContent = "–°–µ–∫—Ä–µ—Ç—ã –Ω–µ —à–∏—Ñ—Ä—É—é—Ç—Å—è";
          document.getElementById("btn-lock")?.classList.remove("ring-2","ring-amber-500/50");
        }else{
          status.textContent = "PIN: –≤–∫–ª—é—á–µ–Ω";
          ustatus.textContent = isUnlocked ? "–†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ ‚úÖ" : "–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ üîí";
          document.getElementById("btn-lock")?.classList.add("ring-2","ring-amber-500/50");
        }
      }
      lucide.createIcons();
    }

    window.openLockModal = () => {
      closeTemplatePopover();
      loadPinMeta();
      document.getElementById("lock-modal").classList.remove("hidden");
      lucide.createIcons();
      haptic(8);
    }
    window.closeLockModal = () => document.getElementById("lock-modal").classList.add("hidden");

    window.setPin = async () => {
      const a = document.getElementById("pin-new").value.trim();
      const b = document.getElementById("pin-new2").value.trim();
      if(a.length < 4){ toast("PIN —Å–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–∏–π. –ú–∏–Ω–∏–º—É–º 4 —Å–∏–º–≤–æ–ª–∞.", "warn"); haptic([10,30,10]); return; }
      if(a !== b){ toast("PIN –Ω–µ —Å–æ–≤–ø–∞–¥–∞–µ—Ç.", "warn"); haptic([10,30,10]); return; }

      const salt = crypto.getRandomValues(new Uint8Array(16));
      const iter = 150000;
      const key  = await deriveKeyFromPin(a, salt, iter);
      const checkEnc = await encryptText("OK_ILLUSIONIST", key);

      pinMeta = { saltB64: b64FromBytes(salt), checkEnc, iter };
      localStorage.setItem(PIN_KEY, JSON.stringify(pinMeta));

      sessionKey = key;
      isUnlocked = true;

      document.getElementById("pin-new").value = "";
      document.getElementById("pin-new2").value = "";
      document.getElementById("pin-enter").value = "";

      updateLockUI();
      toast("PIN —Å–æ—Ö—Ä–∞–Ω—ë–Ω. –¢–µ–ø–µ—Ä—å —Å–µ–∫—Ä–µ—Ç—ã —à–∏—Ñ—Ä—É—é—Ç—Å—è.", "ok");
      haptic([10,20,10,20]);
    }

    window.unlockPin = async () => {
      if(!pinMeta){ toast("PIN –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω.", "warn"); return; }
      const pin = document.getElementById("pin-enter").value.trim();
      if(!pin){ toast("–í–≤–µ–¥–∏—Ç–µ PIN.", "warn"); return; }

      try{
        const salt = bytesFromB64(pinMeta.saltB64);
        const key  = await deriveKeyFromPin(pin, salt, pinMeta.iter || 150000);
        const chk  = await decryptText(pinMeta.checkEnc, key);
        if(chk !== "OK_ILLUSIONIST") throw new Error("bad");
        sessionKey = key;
        isUnlocked = true;
        updateLockUI();
        toast("–†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ.", "ok");
        haptic(12);
      }catch(e){
        toast("–ù–µ–≤–µ—Ä–Ω—ã–π PIN.", "err");
        haptic([40,40,40]);
      }
    }

    window.clearPin = () => {
      if(!safeConfirm("–û—Ç–∫–ª—é—á–∏—Ç—å PIN? –ù–æ–≤—ã–µ —Å–µ–∫—Ä–µ—Ç—ã –ø–µ—Ä–µ—Å—Ç–∞–Ω—É—Ç —à–∏—Ñ—Ä–æ–≤–∞—Ç—å—Å—è.")) return;
      localStorage.removeItem(PIN_KEY);
      pinMeta = null;
      sessionKey = null;
      isUnlocked = false;
      updateLockUI();
      toast("PIN –æ—Ç–∫–ª—é—á—ë–Ω.", "warn");
      haptic([10,30,10]);
    }

    /**********************
     * VIEW MODE
     **********************/
    function loadViewMode(){
      const v = localStorage.getItem(PREF_VIEW);
      viewMode = (v === "list" || v === "grid") ? v : "grid";
      applyViewMode();
    }
    function applyViewMode(){
      const grid = document.getElementById("notes-grid");
      const btn  = document.getElementById("btn-view");
      grid.classList.remove("notes-grid","notes-list");
      grid.classList.add(viewMode === "list" ? "notes-list" : "notes-grid");

      btn.innerHTML = viewMode === "list"
        ? `<i data-lucide="list" class="w-5 h-5 text-slate-300"></i>`
        : `<i data-lucide="layout-grid" class="w-5 h-5 text-slate-300"></i>`;
      lucide.createIcons();
    }
    window.toggleViewMode = () => {
      viewMode = viewMode === "grid" ? "list" : "grid";
      localStorage.setItem(PREF_VIEW, viewMode);
      applyViewMode();
      window.renderNotes();
      haptic(8);
    }

    window.openSettingsModal = () => {
      document.getElementById('settings-modal').classList.remove('hidden');
      updateSettingsStats();
      updatePinStatusInSettings();
      lucide.createIcons();
      haptic(8);
    }

    window.closeSettingsModal = () => {
      document.getElementById('settings-modal').classList.add('hidden');
    }

    function updateSettingsStats() {
      const total = notes.length;
      const secrets = notes.filter(n => n.type === 'secret').length;
      document.getElementById('stats-total').textContent = total;
      document.getElementById('stats-secrets').textContent = secrets;
    }

    function updatePinStatusInSettings() {
      const status = document.getElementById('pin-status-settings');
      if (!status) return;
      if (!pinMeta) {
        status.textContent = 'PIN: –≤—ã–∫–ª—é—á–µ–Ω';
        status.style.color = '#94a3b8';
      } else {
        status.textContent = isUnlocked ? 'PIN: –∞–∫—Ç–∏–≤–µ–Ω, —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ ‚úÖ' : 'PIN: –∞–∫—Ç–∏–≤–µ–Ω, –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ üîí';
        status.style.color = isUnlocked ? '#34d399' : '#f59e0b';
      }
    }

    /**********************
     * NOTES STORAGE
     **********************/
    function loadNotes(){
      try{
        const raw = localStorage.getItem(STORAGE_KEY);
        notes = raw ? JSON.parse(raw) : [];
        if(!Array.isArray(notes)) notes = [];
      }catch(e){
        notes = [];
      }
      // normalize tags & pinned
      notes = notes.map(n => ({
        pinned: !!n.pinned,
        tags: Array.isArray(n.tags) ? n.tags : computeTagsFallback(n),
        ...n
      }));
      window.renderNotes();
    }
    function saveNotes(){
      localStorage.setItem(STORAGE_KEY, JSON.stringify(notes));
    }

    function computeTagsFallback(note){
      // best-effort for old notes
      try{
        const type = note.type;
        const title = note.title || "";
        let content = note.content || {};
        if(type === "secret" && note.content?.enc){
          // can't extract
          return [];
        }
        if(type === "secret" && note.content?.text){
          content = { text: note.content.text };
        }
        return computeTagsForDraft(type, title, content);
      }catch(e){ return []; }
    }

    /**********************
     * SEARCHABLE TEXT
     **********************/
    function searchableText(note){
      const title = String(note.title || "");
      const type  = note.type;
      let parts = [title];

      if(type === "idea") parts.push(String(note.content?.text || ""));
      else if(type === "script"){
        parts.push(String(note.content?.speech || ""));
        parts.push(String(note.content?.action || ""));
      }
      else if(type === "checklist"){
        const items = note.content?.items || [];
        parts.push(items.map(i=>i.text).join(" "));
      }
      else if(type === "secret"){
        if(note.content?.text) parts.push(String(note.content.text));
      }
      // include tags too (so text search finds them even without #)
      if(Array.isArray(note.tags) && note.tags.length) parts.push(note.tags.join(" "));
      return parts.join(" ").toLowerCase();
    }

    /**********************
     * RENDER
     **********************/
    window.renderNotes = () => {
      closeMiniChecklist();
      const grid = document.getElementById("notes-grid");
      const { tags: qTags, text: qText } = parseSearchQuery(document.getElementById("search-input").value);
      const sort = document.getElementById("sort-select").value;

      grid.innerHTML = "";

      let filtered = notes.filter(n => {
        if(currentFilter !== "all" && n.type !== currentFilter) return false;

        // tag filter (AND)
        if(qTags.length){
          const nt = Array.isArray(n.tags) ? n.tags : [];
          for(const t of qTags){
            if(!nt.includes(t)) return false;
          }
        }

        // text filter
        if(qText){
          if(!searchableText(n).includes(qText)) return false;
        }
        return true;
      });

      filtered.sort((a,b) => {
        const au = new Date(a.updated || a.created || 0).getTime();
        const bu = new Date(b.updated || b.created || 0).getTime();
        const at = String(a.title||"").toLowerCase();
        const bt = String(b.title||"").toLowerCase();

        if(sort === "pinned_then_updated_desc"){
          if(!!a.pinned !== !!b.pinned) return (b.pinned ? 1 : 0) - (a.pinned ? 1 : 0);
          return bu - au;
        }
        if(sort === "updated_desc") return bu - au;
        if(sort === "updated_asc")  return au - bu;
        if(sort === "title_asc")    return at.localeCompare(bt, "ru");
        if(sort === "title_desc")   return bt.localeCompare(at, "ru");
        if(sort === "type")         return String(a.type||"").localeCompare(String(b.type||""), "ru");
        return 0;
      });

      if(filtered.length === 0){
        document.getElementById("empty-state").classList.remove("hidden");
      }else{
        document.getElementById("empty-state").classList.add("hidden");
        const frag = document.createDocumentFragment();
        filtered.forEach(note => frag.appendChild(createNoteCard(note)));
        grid.appendChild(frag);
      }

      lucide.createIcons();
    }

    function renderTagsChips(note){
      const tags = Array.isArray(note.tags) ? note.tags : [];
      if(!tags.length) return "";
      const shown = tags.slice(0, 3);
      const more = tags.length > 3 ? tags.length - 3 : 0;

      const chips = shown.map(t => `
        <span class="tagchip" onclick="event.stopPropagation(); window.searchTag('${t}')">
          <i data-lucide="hash" class="w-3 h-3 text-amber-300"></i>${escapeHtml(t)}
        </span>
      `).join(" ");

      return `
        <div class="mt-2 flex flex-wrap gap-2">
          ${chips}
          ${more ? `<span class="tagchip" onclick="event.stopPropagation(); window.searchTag('${tags[3]}')"><i data-lucide="plus" class="w-3 h-3 text-slate-300"></i>+${more}</span>` : ``}
        </div>
      `;
    }

    function createNoteCard(note){
      const el = document.createElement("div");
      el.className = "note-card glass rounded-xl p-4 relative group hover:border-amber-500/30 transition-all cursor-pointer";
      el.onclick = () => window.editNote(note.id);

      const icon = CAT_ICONS[note.category] || "sparkles";
      const colorClass = CAT_COLORS[note.category] || "text-slate-400";

      // card top actions
      const pinnedIcon = note.pinned ? "star" : "star-off";

      let contentHTML = "";
      let footerMeta = "";

      if(note.type === "idea"){
        const text = escapeHtml(note.content?.text || "");
        contentHTML = viewMode === "list"
          ? `<p class="text-slate-300 text-sm line-clamp-2 leading-relaxed">${text}</p>`
          : `<p class="text-slate-300 text-sm line-clamp-4 leading-relaxed">${text}</p>`;
      }
      else if(note.type === "script"){
        const speech = escapeHtml(note.content?.speech || "‚Ä¶");
        const action = escapeHtml(note.content?.action || "‚Ä¶");
        contentHTML = `
          <div class="flex gap-2 text-xs mb-1">
            <div class="flex-1 pl-2 border-l-2 border-amber-500/50">
              <span class="text-[9px] uppercase text-slate-500 font-bold block">–ü–∞—Ç—Ç–µ—Ä</span>
              <p class="text-slate-300 line-clamp-${viewMode==="list" ? "2" : "3"}">${speech}</p>
            </div>
            <div class="flex-1 pl-2 border-l-2 border-white/10">
              <span class="text-[9px] uppercase text-slate-500 font-bold block">–î–µ–π—Å—Ç–≤–∏–µ</span>
              <p class="text-slate-400 italic line-clamp-${viewMode==="list" ? "2" : "3"}">${action}</p>
            </div>
          </div>
        `;
      }
      else if(note.type === "checklist"){
        const items = note.content?.items || [];
        const done = items.filter(i=>i.checked).length;
        const pct = items.length ? (done/items.length)*100 : 0;

        const previewCount = viewMode === "list" ? 2 : 3;
        const previewList = items.slice(0, previewCount).map(i => `
          <li class="flex items-center gap-2 text-xs ${i.checked ? 'text-slate-500 line-through' : 'text-slate-300'}">
            <i data-lucide="${i.checked ? 'check-circle-2' : 'circle'}" class="w-3 h-3 ${i.checked ? 'text-emerald-500' : 'text-slate-600'}"></i>
            ${escapeHtml(i.text)}
          </li>
        `).join("");

        contentHTML = `
          <div class="mb-2">
            <div class="w-full bg-white/5 h-1 rounded-full overflow-hidden mb-2">
              <div class="bg-emerald-500 h-full" style="width:${pct}%"></div>
            </div>
            <ul class="space-y-1">${previewList || `<li class="text-xs text-slate-500">–ü—É—Å—Ç–æ‚Ä¶</li>`}</ul>
            <div class="mt-2 flex items-center justify-between gap-2">
              <div class="text-[10px] text-slate-500 font-bold uppercase tracking-wider">${done}/${items.length}</div>
              <button class="px-3 py-1.5 rounded-lg bg-white/5 border border-white/10 text-[10px] font-bold uppercase text-slate-200 hover:bg-white/10"
                      onclick="event.stopPropagation(); window.toggleMiniChecklist(${note.id})">
                <i data-lucide="list-checks" class="w-3 h-3 inline mr-1"></i>–ë—ã—Å—Ç—Ä–æ
              </button>
            </div>
          </div>

          <div id="mini-${note.id}" class="mini-pop">
            <div class="px-4 py-3 border-b border-white/10 flex items-center justify-between">
              <div class="text-xs font-bold uppercase tracking-wider text-slate-300">–ß–µ–∫-–ª–∏—Å—Ç</div>
              <button onclick="event.stopPropagation(); window.toggleMiniChecklist(${note.id}, true)" class="w-8 h-8 rounded-lg bg-white/5 border border-white/10 flex items-center justify-center hover:bg-white/10">
                <i data-lucide="x" class="w-4 h-4 text-slate-300"></i>
              </button>
            </div>
            <div class="p-3 max-h-[210px] overflow-y-auto">
              ${(items.length ? items.map((it, idx) => `
                <button class="w-full text-left flex items-center gap-3 px-2 py-2 rounded-lg hover:bg-white/5 transition"
                        onclick="event.stopPropagation(); window.quickToggleChecklistItem(${note.id}, ${idx})">
                  <i data-lucide="${it.checked ? 'check-square' : 'square'}" class="w-4 h-4 ${it.checked ? 'text-emerald-500' : 'text-slate-500'}"></i>
                  <span class="text-sm ${it.checked ? 'text-slate-500 line-through' : 'text-slate-200'}">${escapeHtml(it.text)}</span>
                </button>
              `).join("") : `<div class="text-xs text-slate-500 px-2 py-2">–ü—É—Å—Ç–æ‚Ä¶</div>`)}
            </div>
            <div class="px-3 py-3 border-t border-white/10 flex gap-2">
              <button class="flex-1 px-3 py-2 rounded-lg bg-white/5 border border-white/10 text-[10px] font-bold uppercase text-slate-200 hover:bg-white/10"
                      onclick="event.stopPropagation(); window.copyNote(${note.id})">
                <i data-lucide="copy" class="w-3 h-3 inline mr-1"></i>Copy
              </button>
              <button class="flex-1 px-3 py-2 rounded-lg bg-white/5 border border-white/10 text-[10px] font-bold uppercase text-slate-200 hover:bg-white/10"
                      onclick="event.stopPropagation(); window.duplicateNote(${note.id})">
                <i data-lucide="copy-plus" class="w-3 h-3 inline mr-1"></i>Duplicate
              </button>
            </div>
          </div>
        `;
      }
      else if(note.type === "secret"){
        const isEncrypted = !!note.content?.enc;
        const locked = !!pinMeta && !isUnlocked;
        contentHTML = `
          <div class="rounded-lg bg-black/20 p-3 border border-white/10">
            <div class="text-[10px] uppercase tracking-widest font-bold text-red-300 flex items-center gap-2">
              <i data-lucide="eye-off" class="w-4 h-4"></i>
              ${isEncrypted ? "–ó–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–æ" : "–ë–µ–∑ PIN (–Ω–µ–±–µ–∑–æ–ø–∞—Å–Ω–æ)"}
            </div>
            <div class="mt-2 text-xs text-slate-400">
              ${isEncrypted ? (locked ? "–†–∞–∑–±–ª–æ–∫–∏—Ä—É–π PIN, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å." : "–ú–æ–∂–Ω–æ –ø–æ–∫–∞–∑–∞—Ç—å/–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å.") : "–õ—É—á—à–µ –≤–∫–ª—é—á–∏—Ç—å PIN."}
            </div>
            <div class="mt-3 flex gap-2 flex-wrap">
              <button class="px-3 py-1.5 rounded-lg bg-white/5 border border-white/10 text-[10px] font-bold uppercase text-slate-200 hover:bg-white/10"
                      onclick="event.stopPropagation(); window.quickRevealSecret(${note.id})">
                <i data-lucide="eye" class="w-3 h-3 inline mr-1"></i>–ü–æ–∫–∞–∑–∞—Ç—å
              </button>
              <button class="px-3 py-1.5 rounded-lg bg-white/5 border border-white/10 text-[10px] font-bold uppercase text-slate-200 hover:bg-white/10"
                      onclick="event.stopPropagation(); window.copyNote(${note.id})">
                <i data-lucide="copy" class="w-3 h-3 inline mr-1"></i>Copy
              </button>
              <button class="px-3 py-1.5 rounded-lg bg-white/5 border border-white/10 text-[10px] font-bold uppercase text-slate-300 hover:bg-white/10"
                      onclick="event.stopPropagation(); window.openLockModal()">
                <i data-lucide="shield" class="w-3 h-3 inline mr-1"></i>PIN
              </button>
            </div>
          </div>
        `;
      }

      if(note.duration > 0){
        const mins = Math.floor(note.duration/60).toString().padStart(2,"0");
        const secs = (note.duration%60).toString().padStart(2,"0");
        footerMeta += `<span class="flex items-center gap-1 text-[10px] text-amber-500 font-mono bg-amber-500/10 px-1.5 py-0.5 rounded"><i data-lucide="timer" class="w-3 h-3"></i>${mins}:${secs}</span>`;
      }

      const tagsHTML = renderTagsChips(note);

      el.innerHTML = `
        <div class="flex justify-between items-start mb-2 gap-2">
          <div class="min-w-0 flex-1">
            <h3 class="font-display font-bold text-base text-white leading-tight flex-1 truncate">${escapeHtml(note.title || "–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è")}</h3>
          </div>

          <div class="flex items-center gap-2 shrink-0">
            <i data-lucide="${icon}" class="w-4 h-4 ${colorClass}"></i>

            <div class="card-actions">
              <button class="w-9 h-9 rounded-xl bg-white/5 border border-white/10 flex items-center justify-center hover:bg-white/10 transition"
                      title="Pin"
                      onclick="event.stopPropagation(); window.togglePin(${note.id})">
                <i data-lucide="${pinnedIcon}" class="w-4 h-4 ${note.pinned ? 'text-amber-300' : 'text-slate-300'}"></i>
              </button>
              <button class="w-9 h-9 rounded-xl bg-white/5 border border-white/10 flex items-center justify-center hover:bg-white/10 transition"
                      title="Copy"
                      onclick="event.stopPropagation(); window.copyNote(${note.id})">
                <i data-lucide="copy" class="w-4 h-4 text-slate-300"></i>
              </button>
              <button class="w-9 h-9 rounded-xl bg-white/5 border border-white/10 flex items-center justify-center hover:bg-white/10 transition"
                      title="Duplicate"
                      onclick="event.stopPropagation(); window.duplicateNote(${note.id})">
                <i data-lucide="copy-plus" class="w-4 h-4 text-slate-300"></i>
              </button>
              <button class="w-9 h-9 rounded-xl bg-white/5 border border-white/10 flex items-center justify-center hover:bg-white/10 transition"
                      title="Delete"
                      onclick="event.stopPropagation(); window.deleteNoteQuick(${note.id})">
                <i data-lucide="trash-2" class="w-4 h-4 text-red-300"></i>
              </button>
            </div>
          </div>
        </div>

        ${contentHTML}
        ${tagsHTML}

        <div class="flex items-center justify-between mt-3 pt-3 border-t border-white/5">
          <div class="flex gap-2">${footerMeta}</div>
          <span class="text-[10px] text-slate-500 uppercase font-bold tracking-wider">${TYPE_LABEL[note.type] || "–ó–∞–º–µ—Ç–∫–∞"}</span>
        </div>
      `;

      return el;
    }

    /**********************
     * Quick actions
     **********************/
    window.searchTag = (tag) => {
      const input = document.getElementById("search-input");
      const current = input.value.trim();
      const t = "#" + tag.toLowerCase();
      // if tag already present, keep; else add
      const parts = current.split(/\s+/).filter(Boolean);
      if(!parts.includes(t)) parts.unshift(t);
      input.value = parts.join(" ");
      window.renderNotes();
      toast(`–§–∏–ª—å—Ç—Ä: ${t}`, "ok", 1600);
      haptic(8);
    }

    window.togglePin = (id) => {
      notes = notes.map(n => n.id === id ? { ...n, pinned: !n.pinned, updated: new Date().toISOString() } : n);
      saveNotes();
      window.renderNotes();
      haptic(8);
    }

    window.deleteNoteQuick = (id) => {
      if(!safeConfirm("–£–¥–∞–ª–∏—Ç—å –∑–∞–º–µ—Ç–∫—É?")) return;
      notes = notes.filter(n => n.id !== id);
      saveNotes();
      window.renderNotes();
      toast("–£–¥–∞–ª–µ–Ω–æ.", "ok");
      haptic([10,20,10]);
    }

    window.duplicateNote = (id) => {
      const src = notes.find(n => n.id === id);
      if(!src) return;
      const now = new Date().toISOString();
      const copy = JSON.parse(JSON.stringify(src));
      copy.id = Date.now();
      copy.created = now;
      copy.updated = now;
      copy.pinned = false;
      copy.title = (src.title || "–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è") + " (–∫–æ–ø–∏—è)";
      // tags remain
      notes.unshift(copy);
      saveNotes();
      window.renderNotes();
      toast("–î—É–±–ª–∏–∫–∞—Ç —Å–æ–∑–¥–∞–Ω.", "ok");
      haptic(10);
    }

    window.copyNote = async (id) => {
      const note = notes.find(n => n.id === id);
      if(!note) return;

      loadPinMeta();

      let text = `ü™Ñ ${note.title || "–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è"}\n–¢–∏–ø: ${TYPE_LABEL[note.type] || note.type}\n`;
      if(note.tags?.length) text += `–¢–µ–≥–∏: ${note.tags.map(t => "#"+t).join(" ")}\n`;
      text += "\n";

      if(note.type === "idea"){
        text += (note.content?.text || "");
      }else if(note.type === "script"){
        text += `–ü–∞—Ç—Ç–µ—Ä:\n${note.content?.speech || ""}\n\n–î–µ–π—Å—Ç–≤–∏—è:\n${note.content?.action || ""}`;
      }else if(note.type === "checklist"){
        const items = note.content?.items || [];
        text += items.map(i => `${i.checked ? "[x]" : "[ ]"} ${i.text}`).join("\n");
      }else if(note.type === "secret"){
        if(note.content?.enc){
          if(!pinMeta || !isUnlocked || !sessionKey){
            toast("–°–µ–∫—Ä–µ—Ç –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω. –†–∞–∑–±–ª–æ–∫–∏—Ä—É–π PIN –¥–ª—è –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è.", "warn");
            haptic([10,30,10]);
            return;
          }
          try{
            const plain = await decryptText(note.content.enc, sessionKey);
            text += plain;
          }catch(e){
            toast("–ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∞—Ç—å. –ü—Ä–æ–≤–µ—Ä—å PIN.", "err");
            haptic([40,40,40]);
            return;
          }
        }else{
          text += (note.content?.text || "");
        }
      }

      await copyToClipboard(text);
    }

    window.toggleMiniChecklist = (id, forceClose=false) => {
      // close previously open
      if(openMiniId && openMiniId !== id){
        const prev = document.getElementById(`mini-${openMiniId}`);
        prev?.classList.remove("show");
      }

      const el = document.getElementById(`mini-${id}`);
      if(!el) return;

      if(forceClose){
        el.classList.remove("show");
        openMiniId = null;
        return;
      }

      const willOpen = !el.classList.contains("show");
      el.classList.toggle("show", willOpen);
      openMiniId = willOpen ? id : null;
      lucide.createIcons();
      haptic(6);
    }

    function closeMiniChecklist(){
      if(!openMiniId) return;
      document.getElementById(`mini-${openMiniId}`)?.classList.remove("show");
      openMiniId = null;
    }

    document.addEventListener("click", (e) => {
      // close mini when click outside any mini pop
      if(!openMiniId) return;
      const mini = document.getElementById(`mini-${openMiniId}`);
      if(!mini) { openMiniId = null; return; }
      if(mini.contains(e.target)) return;
      // if clicked on button that opens it, let it handle
      if(String(e.target?.outerHTML || "").includes("toggleMiniChecklist")) return;
      mini.classList.remove("show");
      openMiniId = null;
    });

    window.quickToggleChecklistItem = (noteId, idx) => {
      const note = notes.find(n => n.id === noteId);
      if(!note || note.type !== "checklist") return;
      const items = note.content?.items || [];
      if(!items[idx]) return;
      items[idx].checked = !items[idx].checked;
      note.updated = new Date().toISOString();
      // tags might change if item text has tags (rare) ‚Äì keep current
      saveNotes();
      window.renderNotes();
      // reopen popover after rerender
      setTimeout(() => {
        window.toggleMiniChecklist(noteId);
        window.toggleMiniChecklist(noteId);
      }, 0);
      haptic(6);
    }

    /**********************
     * FILTERS
     **********************/
    window.setFilter = (type) => {
      currentFilter = type;
      document.querySelectorAll(".filter-btn").forEach(btn => {
        if(btn.dataset.type === type){
          btn.classList.add("border-amber-500","bg-amber-500/10","text-amber-400");
          btn.classList.remove("border-white/5","bg-white/5","text-slate-400");
        }else{
          btn.classList.remove("border-amber-500","bg-amber-500/10","text-amber-400");
          btn.classList.add("border-white/5","bg-white/5","text-slate-400");
        }
      });
      window.renderNotes();
      haptic(8);
    }

    /**********************
     * EDITOR / MODAL
     **********************/
    window.openModal = () => {
      resetEditor();
      document.getElementById("editor-modal").classList.remove("hidden");
      checkDraftBanner();
      lucide.createIcons();
      haptic(8);
    }
    window.closeModal = () => {
      stopTimer();
      document.getElementById("editor-modal").classList.add("hidden");
    }

    function resetEditor(){
      editingId = null;
      document.getElementById("btn-delete").classList.add("hidden");
      document.getElementById("inp-title").value = "";
      document.getElementById("inp-idea").value = "";
      document.getElementById("inp-script-speech").value = "";
      document.getElementById("inp-script-action").value = "";
      document.getElementById("inp-secret").value = "";
      tempChecklist = [];
      renderChecklist();

      timerSeconds = 0;
      updateTimerDisplay();
      stopTimer();

      window.setEditorType("idea");
      window.setCategory("cards");
    }

    window.setEditorType = (type) => {
      editorType = type;

      document.querySelectorAll(".type-sel").forEach(btn => {
        btn.classList.remove("border-amber-500","bg-amber-500/20","text-amber-400");
        btn.classList.add("border-white/10","bg-white/5","text-slate-400");
      });
      const active = document.getElementById(`type-btn-${type}`);
      active.classList.add("border-amber-500","bg-amber-500/20","text-amber-400");
      active.classList.remove("border-white/10","bg-white/5","text-slate-400");

      document.querySelectorAll(".editor-area").forEach(el => el.classList.add("hidden"));
      const area = document.getElementById(`area-${type}`);
      area.classList.remove("hidden");
      if(type === "script") area.classList.add("flex");

      buildTemplatePopover();
      scheduleDraftSave();
      haptic(6);
    }

    window.setCategory = (cat) => {
      editorCategory = cat;
      document.querySelectorAll('.cat-btn').forEach(btn => {
        btn.classList.remove('border-amber-500','text-amber-400','bg-amber-500/10','border-purple-500','text-purple-400','bg-purple-500/10','border-yellow-500','text-yellow-400','bg-yellow-500/10','border-emerald-500','text-emerald-400','bg-emerald-500/10','border-blue-500','text-blue-400','bg-blue-500/10');
        btn.classList.add('bg-white/5','border-white/5','text-slate-400');
      });

      const active = document.getElementById(`cat-${cat}`);
      const map = {
        cards: ['border-purple-500','text-purple-400','bg-purple-500/10'],
        coins: ['border-yellow-500','text-yellow-400','bg-yellow-500/10'],
        mental:['border-emerald-500','text-emerald-400','bg-emerald-500/10'],
        stage: ['border-amber-500','text-amber-400','bg-amber-500/10'],
        tech:  ['border-blue-500','text-blue-400','bg-blue-500/10']
      };
      if(map[cat]){
        active.classList.remove('bg-white/5','border-white/5','text-slate-400');
        active.classList.add(...map[cat]);
      }

      scheduleDraftSave();
      haptic(6);
    }

    /**********************
     * DRAFT
     **********************/
    function checkDraftBanner(){
      const raw = localStorage.getItem(DRAFT_KEY);
      const banner = document.getElementById("draft-banner");
      if(!banner) return;
      if(raw && !editingId) banner.classList.remove("hidden");
      else banner.classList.add("hidden");
      lucide.createIcons();
    }

    function scheduleDraftSave(){
      clearTimeout(draftDebounce);
      draftDebounce = setTimeout(async () => {
        if(editingId) return;

        const title = document.getElementById("inp-title").value || "";
        let content = {};

        if(editorType === "idea") content.text = document.getElementById("inp-idea").value || "";
        else if(editorType === "script"){
          content.speech = document.getElementById("inp-script-speech").value || "";
          content.action = document.getElementById("inp-script-action").value || "";
        }
        else if(editorType === "checklist"){
          content.items = tempChecklist || [];
        }
        else if(editorType === "secret"){
          loadPinMeta();
          if(pinMeta && (!isUnlocked || !sessionKey)) return;
          content.text = document.getElementById("inp-secret").value || "";
        }

        const draft = {
          title,
          type: editorType,
          category: editorCategory,
          content,
          duration: timerSeconds,
          updated: new Date().toISOString()
        };
        localStorage.setItem(DRAFT_KEY, JSON.stringify(draft));
        checkDraftBanner();
      }, 650);
    }

    window.restoreDraft = () => {
      const raw = localStorage.getItem(DRAFT_KEY);
      if(!raw) return;
      try{
        const d = JSON.parse(raw);

        document.getElementById("inp-title").value = d.title || "";
        window.setEditorType(d.type || "idea");
        window.setCategory(d.category || "cards");

        timerSeconds = d.duration || 0;
        updateTimerDisplay();

        if(d.type === "idea") document.getElementById("inp-idea").value = d.content?.text || "";
        if(d.type === "script"){
          document.getElementById("inp-script-speech").value = d.content?.speech || "";
          document.getElementById("inp-script-action").value = d.content?.action || "";
        }
        if(d.type === "secret") document.getElementById("inp-secret").value = d.content?.text || "";
        if(d.type === "checklist"){
          tempChecklist = Array.isArray(d.content?.items) ? d.content.items : [];
          renderChecklist();
        }

        localStorage.removeItem(DRAFT_KEY);
        checkDraftBanner();
        toast("–ß–µ—Ä–Ω–æ–≤–∏–∫ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω.", "ok");
        haptic(10);
      }catch(e){
        localStorage.removeItem(DRAFT_KEY);
        checkDraftBanner();
      }
    }

    window.discardDraft = () => {
      localStorage.removeItem(DRAFT_KEY);
      checkDraftBanner();
      toast("–ß–µ—Ä–Ω–æ–≤–∏–∫ —É–¥–∞–ª—ë–Ω.", "warn");
      haptic(8);
    }

    document.addEventListener("input", () => {
      const modal = document.getElementById("editor-modal");
      if(!modal || modal.classList.contains("hidden")) return;
      scheduleDraftSave();
    });

    /**********************
     * CHECKLIST (editor)
     **********************/
    window.addCheckItem = () => {
      const inp = document.getElementById("inp-check-item");
      const val = inp.value.trim();
      if(!val) return;
      tempChecklist.push({ text: val, checked: false });
      inp.value = "";
      renderChecklist();
      scheduleDraftSave();
      haptic(8);
    }
    window.toggleCheckItem = (idx) => {
      tempChecklist[idx].checked = !tempChecklist[idx].checked;
      renderChecklist();
      scheduleDraftSave();
      haptic(6);
    }
    window.removeCheckItem = (idx) => {
      tempChecklist.splice(idx, 1);
      renderChecklist();
      scheduleDraftSave();
      haptic(6);
    }
    function renderChecklist(){
      const ul = document.getElementById("checklist-container");
      if(!ul) return;
      ul.innerHTML = "";
      tempChecklist.forEach((item, idx) => {
        const li = document.createElement("li");
        li.className = "flex items-center justify-between bg-white/5 p-2 rounded-lg border border-white/5";
        li.innerHTML = `
          <button onclick="toggleCheckItem(${idx})" class="flex items-center gap-3 flex-1 text-left">
            <i data-lucide="${item.checked ? 'check-square' : 'square'}" class="w-4 h-4 ${item.checked ? 'text-emerald-500' : 'text-slate-500'}"></i>
            <span class="text-sm ${item.checked ? 'text-slate-500 line-through' : 'text-slate-200'}">${escapeHtml(item.text)}</span>
          </button>
          <button onclick="removeCheckItem(${idx})" class="text-slate-600 hover:text-red-400" title="–£–¥–∞–ª–∏—Ç—å">
            <i data-lucide="x" class="w-4 h-4"></i>
          </button>
        `;
        ul.appendChild(li);
      });
      lucide.createIcons();
    }

    /**********************
     * TIMER
     **********************/
    window.toggleTimer = () => {
      if(isTimerRunning) stopTimer();
      else startTimer();
      haptic(8);
    }
    function startTimer(){
      isTimerRunning = true;
      const btn = document.getElementById("timer-btn");
      btn.textContent = "–°—Ç–æ–ø";
      btn.classList.add("text-red-400");
      timerInterval = setInterval(() => {
        timerSeconds++;
        updateTimerDisplay();
        scheduleDraftSave();
      }, 1000);
    }
    function stopTimer(){
      isTimerRunning = false;
      clearInterval(timerInterval);
      const btn = document.getElementById("timer-btn");
      if(btn){
        btn.textContent = "–°—Ç–∞—Ä—Ç";
        btn.classList.remove("text-red-400");
      }
    }
    function updateTimerDisplay(){
      const m = Math.floor(timerSeconds/60).toString().padStart(2,"0");
      const s = (timerSeconds%60).toString().padStart(2,"0");
      document.getElementById("timer-display").textContent = `${m}:${s}`;
    }

    /**********************
     * TELEPROMPTER
     **********************/
    window.startTeleprompter = () => {
      const text = document.getElementById("inp-script-speech").value;
      if(!text){ toast("–°–Ω–∞—á–∞–ª–∞ –≤–≤–µ–¥–∏ —Ç–µ–∫—Å—Ç —Ä–µ—á–∏.", "warn"); haptic([10,30,10]); return; }

      const contentEl = document.getElementById("prompter-content");
      contentEl.innerText = text;

      document.getElementById("prompter-speed").value = 2;
      document.getElementById("prompter-font").value = 40;
      window.updatePrompterFont();

      document.getElementById("teleprompter").classList.remove("hidden");
      document.getElementById("teleprompter").classList.add("flex");

      const area = document.getElementById("prompter-scroll-area");
      area.scrollTop = 0;

      prompterPlaying = true;
      prompterLastTs = 0;
      updatePrompterButton();
      prompterLoop(0);

      haptic(10);
    }
    window.stopTeleprompter = () => {
      prompterPlaying = false;
      cancelAnimationFrame(prompterRAF);
      document.getElementById("teleprompter").classList.add("hidden");
      document.getElementById("teleprompter").classList.remove("flex");
      haptic(8);
    }
    window.togglePrompterPlay = () => {
      prompterPlaying = !prompterPlaying;
      updatePrompterButton();
      if(prompterPlaying){
        prompterLastTs = 0;
        prompterLoop(0);
      }
      haptic(6);
    }
    function updatePrompterButton(){
      const btn = document.getElementById("prompter-play-btn");
      btn.innerHTML = prompterPlaying
        ? `<i data-lucide="pause" class="w-6 h-6 fill-current"></i>`
        : `<i data-lucide="play" class="w-6 h-6 fill-current ml-1"></i>`;
      lucide.createIcons();
    }
    window.togglePrompterMirror = () => {
      isMirrored = !isMirrored;
      const el = document.getElementById("prompter-content");
      if(isMirrored) el.classList.add("prompter-mirror");
      else el.classList.remove("prompter-mirror");
      haptic(6);
    }
    window.updatePrompterFont = () => {
      const size = document.getElementById("prompter-font").value;
      document.getElementById("prompter-content").style.fontSize = size + "px";
    }
    function prompterLoop(ts){
      if(!prompterPlaying) return;

      const area = document.getElementById("prompter-scroll-area");
      const speed = parseFloat(document.getElementById("prompter-speed").value);

      if(!prompterLastTs) prompterLastTs = ts;
      const dt = Math.min(48, ts - prompterLastTs);
      prompterLastTs = ts;

      if(speed > 0){
        const pxPerSec = speed * 40;
        area.scrollTop += (pxPerSec * dt) / 1000;
      }

      if(area.scrollTop < (area.scrollHeight - area.clientHeight - 1)){
        prompterRAF = requestAnimationFrame(prompterLoop);
      }else{
        prompterPlaying = false;
        updatePrompterButton();
        toast("–ö–æ–Ω–µ—Ü —Ç–µ–∫—Å—Ç–∞.", "ok");
        haptic(10);
      }
    }
    document.addEventListener("visibilitychange", () => {
      if(document.hidden && prompterPlaying){
        prompterPlaying = false;
        updatePrompterButton();
      }
    });

    /**********************
     * SECRETS: quick reveal
     **********************/
    window.quickRevealSecret = async (id) => {
      const note = notes.find(n => n.id === id);
      if (!note) return;

      loadPinMeta();

      if(note.content?.enc){
        if(!pinMeta || !isUnlocked || !sessionKey){
          toast("–ù—É–∂–Ω–æ —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å PIN (—â–∏—Ç —Å–≤–µ—Ä—Ö—É).", "warn");
          haptic([10,30,10]);
          return;
        }
        try{
          const text = await decryptText(note.content.enc, sessionKey);
          toast(`<span class="font-bold">–°–µ–∫—Ä–µ—Ç:</span> ${escapeHtml(text)}`, "ok", 4500);
          haptic(10);
        }catch(e){
          toast("–ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∞—Ç—å. –ü—Ä–æ–≤–µ—Ä—å PIN.", "err");
          haptic([40,40,40]);
        }
      }else{
        const text = note.content?.text || "";
        toast(`<span class="font-bold">–°–µ–∫—Ä–µ—Ç:</span> ${escapeHtml(text)}`, "ok", 4500);
        haptic(10);
      }
    }

    /**********************
     * CRUD
     **********************/
    window.saveNote = async () => {
      const title = document.getElementById("inp-title").value.trim() || "–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è";
      const now = new Date().toISOString();

      let content = {};
      if(editorType === "idea"){
        content.text = document.getElementById("inp-idea").value || "";
      }
      else if(editorType === "script"){
        content.speech = document.getElementById("inp-script-speech").value || "";
        content.action = document.getElementById("inp-script-action").value || "";
      }
      else if(editorType === "checklist"){
        content.items = tempChecklist;
      }
      else if(editorType === "secret"){
        const secretText = document.getElementById("inp-secret").value || "";
        loadPinMeta();
        if(pinMeta){
          if(!isUnlocked || !sessionKey){
            toast("PIN –≤–∫–ª—é—á—ë–Ω. –°–Ω–∞—á–∞–ª–∞ —Ä–∞–∑–±–ª–æ–∫–∏—Ä—É–π, —á—Ç–æ–±—ã —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —Å–µ–∫—Ä–µ—Ç –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω–æ.", "warn");
            haptic([10,30,10]);
            return;
          }
          content.enc = await encryptText(secretText, sessionKey);
          // NOTE: tags can be computed from plaintext before encrypt:
          content._plain_for_tags = secretText; // temporary, will delete below
        }else{
          content.text = secretText;
        }
      }

      // compute tags
      let tagContentForCompute = content;
      if(editorType === "secret" && content._plain_for_tags){
        tagContentForCompute = { text: content._plain_for_tags };
      }
      const tags = computeTagsForDraft(editorType, title, tagContentForCompute);

      // remove temp
      if(content._plain_for_tags) delete content._plain_for_tags;

      const noteData = {
        title,
        type: editorType,
        category: editorCategory,
        content,
        duration: timerSeconds,
        updated: now,
        tags
      };

      if (editingId) {
        notes = notes.map(n => n.id === editingId ? { ...n, ...noteData } : n);
      } else {
        notes.unshift({ id: Date.now(), created: now, pinned:false, ...noteData });
      }

      saveNotes();
      localStorage.removeItem(DRAFT_KEY);
      window.renderNotes();
      window.closeModal();

      toast("–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ.", "ok");
      haptic([8,12,8]);
    }

    window.editNote = async (id) => {
      const note = notes.find(n => n.id === id);
      if(!note) return;

      editingId = id;
      document.getElementById("btn-delete").classList.remove("hidden");
      document.getElementById("editor-modal").classList.remove("hidden");

      document.getElementById("inp-title").value = note.title || "";
      window.setEditorType(note.type);
      window.setCategory(note.category || "cards");

      if(note.type === "idea") document.getElementById("inp-idea").value = note.content?.text || "";
      if(note.type === "script"){
        document.getElementById("inp-script-speech").value = note.content?.speech || "";
        document.getElementById("inp-script-action").value = note.content?.action || "";
      }
      if(note.type === "checklist"){
        tempChecklist = JSON.parse(JSON.stringify(note.content?.items || []));
        renderChecklist();
      }
      if(note.type === "secret"){
        loadPinMeta();
        if(note.content?.enc){
          if(!pinMeta || !isUnlocked || !sessionKey){
            toast("–°–µ–∫—Ä–µ—Ç –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω. –†–∞–∑–±–ª–æ–∫–∏—Ä—É–π PIN, —á—Ç–æ–±—ã —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å.", "warn");
            document.getElementById("inp-secret").value = "";
          }else{
            try{
              const text = await decryptText(note.content.enc, sessionKey);
              document.getElementById("inp-secret").value = text;
            }catch(e){
              toast("–ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∞—Ç—å. –ü—Ä–æ–≤–µ—Ä—å PIN.", "err");
              document.getElementById("inp-secret").value = "";
            }
          }
        }else{
          document.getElementById("inp-secret").value = note.content?.text || "";
        }
      }

      timerSeconds = note.duration || 0;
      updateTimerDisplay();
      stopTimer();

      checkDraftBanner();
      lucide.createIcons();
      haptic(8);
    }

    window.deleteNote = () => {
      if(!safeConfirm("–£–¥–∞–ª–∏—Ç—å —ç—Ç—É –∑–∞–º–µ—Ç–∫—É?")) return;
      notes = notes.filter(n => n.id !== editingId);
      saveNotes();
      localStorage.removeItem(DRAFT_KEY);
      window.renderNotes();
      window.closeModal();
      toast("–£–¥–∞–ª–µ–Ω–æ.", "ok");
      haptic([10,20,10]);
    }

    /**********************
     * EXPORT / IMPORT
     **********************/
    window.exportData = () => {
      const payload = {
        version: 2,
        exportedAt: new Date().toISOString(),
        pinEnabled: !!pinMeta,
        notes
      };
      const blob = new Blob([JSON.stringify(payload, null, 2)], {type:"application/json"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = `illusionist-grimoire-${new Date().toISOString().slice(0,10)}.json`;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
      toast("–≠–∫—Å–ø–æ—Ä—Ç –≥–æ—Ç–æ–≤.", "ok");
      haptic(10);
    }

    window.importData = async (event) => {
      const file = event.target.files?.[0];
      event.target.value = "";
      if(!file) return;
      try{
        const text = await file.text();
        const data = JSON.parse(text);
        const incoming = Array.isArray(data?.notes) ? data.notes : Array.isArray(data) ? data : null;
        if(!incoming){ toast("–ò–º–ø–æ—Ä—Ç: —Ñ–∞–π–ª –Ω–µ –ø–æ—Ö–æ–∂ –Ω–∞ —ç–∫—Å–ø–æ—Ä—Ç Grimoire.", "err"); haptic([40,40,40]); return; }

        const normalized = incoming.map(n => {
          const type = ["idea","script","secret","checklist"].includes(n.type) ? n.type : "idea";
          const title = String(n.title || "–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è");
          const content = (n && typeof n.content === "object") ? n.content : {};
          const tags = Array.isArray(n.tags) ? n.tags : computeTagsFallback({type, title, content});
          return {
            id: Number(n.id) || Date.now() + Math.floor(Math.random()*9999),
            created: n.created || n.updated || new Date().toISOString(),
            updated: n.updated || new Date().toISOString(),
            pinned: !!n.pinned,
            title,
            type,
            category: ["cards","coins","mental","stage","tech","general"].includes(n.category) ? n.category : "cards",
            duration: Number(n.duration) || 0,
            content,
            tags
          };
        });

        const map = new Map(notes.map(n => [n.id, n]));
        normalized.forEach(n => {
          const prev = map.get(n.id);
          if(!prev) map.set(n.id, n);
          else{
            const pu = new Date(prev.updated||0).getTime();
            const nu = new Date(n.updated||0).getTime();
            map.set(n.id, nu >= pu ? n : prev);
          }
        });

        notes = Array.from(map.values());
        saveNotes();
        window.renderNotes();
        toast("–ò–º–ø–æ—Ä—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω.", "ok");
        haptic([8,12,8]);
      }catch(e){
        toast("–ò–º–ø–æ—Ä—Ç –Ω–µ —É–¥–∞–ª—Å—è: –±–∏—Ç—ã–π JSON.", "err");
        haptic([40,40,40]);
      }
    }

    /**********************
     * TEMPLATES
     **********************/
    const TEMPLATES = {
      idea_basic: {
        title: "–°–∫–µ–ª–µ—Ç –∏–¥–µ–∏",
        apply: () => ({
          title: "–ò–¥–µ—è: ‚Ä¶",
          field: "inp-idea",
          text:
`# –≠—Ñ—Ñ–µ–∫—Ç (—á—Ç–æ –≤–∏–¥–∏—Ç –∑—Ä–∏—Ç–µ–ª—å)
‚Äî ‚Ä¶

# –£—Å–ª–æ–≤–∏—è
‚Äî –ì–¥–µ/–∫–æ–≥–¥–∞/–∫–∞–∫–∞—è –∞—É–¥–∏—Ç–æ—Ä–∏—è: ‚Ä¶

# –ú–µ—Ç–æ–¥ (—á–µ—Ä–Ω–æ–≤–∏–∫, –±–µ–∑ –¥–µ—Ç–∞–ª–µ–π)
‚Äî ‚Ä¶

# ‚Äú–ö—Ä—é—á–æ–∫‚Äù
‚Äî –ü–æ—á–µ–º—É —ç—Ç–æ –∑–∞–ø–æ–º–Ω—è—Ç: ‚Ä¶

# –†–µ–∫–≤–∏–∑–∏—Ç
‚Äî ‚Ä¶

# –†–µ–ø–µ—Ç–∏—Ü–∏—è
‚Äî 1) ‚Ä¶ 2) ‚Ä¶ 3) ‚Ä¶`
        })
      },
      idea_presentation: {
        title: "–ü–æ–¥–∞—á–∞",
        apply: () => ({
          title: "–ü–æ–¥–∞—á–∞: ‚Ä¶",
          field: "inp-idea",
          text:
`# –ò–Ω—Ç—Ä–æ (5‚Äì10 —Å–µ–∫)
‚Äî ‚Ä¶

# –õ–∏–Ω–∏—è —ç–º–æ—Ü–∏–π
‚Äî 1) –ò–Ω—Ç–µ—Ä–µ—Å ‚Üí 2) –°–æ–º–Ω–µ–Ω–∏–µ ‚Üí 3) –í–ê–£ ‚Üí 4) –¢–∏—à–∏–Ω–∞ ‚Üí 5) –ê–ø–ª–æ–¥–∏—Å–º–µ–Ω—Ç—ã

# –†–µ–ø–ª–∏–∫–∏-–∫–ª—é—á–∏ (3 —à—Ç)
1) ‚Ä¶
2) ‚Ä¶
3) ‚Ä¶

# –§–∏–Ω–∞–ª—å–Ω–∞—è —Ç–æ—á–∫–∞ (–∫–∞–∫ –∑–∞–∫—Ä—ã–≤–∞—é)
‚Äî ‚Ä¶`
        })
      },
      idea_risks: {
        title: "–†–∏—Å–∫–∏/–ø—Ä–æ–≤–∞–ª—ã",
        apply: () => ({
          title: "–†–∏—Å–∫–∏: ‚Ä¶",
          field: "inp-idea",
          text:
`# –ì–¥–µ –º–æ–∂–µ—Ç —Å–ª–æ–º–∞—Ç—å—Å—è
‚Äî ‚Ä¶

# –ü–ª–∞–Ω B (–µ—Å–ª–∏ –∑—Ä–∏—Ç–µ–ª—å –¥–µ–ª–∞–µ—Ç –Ω–µ —Ç–æ)
‚Äî ‚Ä¶

# –ü–ª–∞–Ω C (–µ—Å–ª–∏ —Ä–µ–∫–≤–∏–∑–∏—Ç –ø–æ–¥–≤—ë–ª)
‚Äî ‚Ä¶

# –°–∫—Ä—ã—Ç—ã–µ –¥–æ–ø—É—â–µ–Ω–∏—è
‚Äî ‚Ä¶

# –ß—Ç–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –Ω–∞ —Ä–µ–ø–µ—Ç–∏—Ü–∏–∏
‚Äî ‚Ä¶`
        })
      },
      script_classic: {
        title: "–ö–ª–∞—Å—Å–∏–∫–∞ 60‚Äì90—Å",
        apply: () => ({
          title: "–°—Ü–µ–Ω–∞—Ä–∏–π: ‚Ä¶",
          fields: { speech: "inp-script-speech", action: "inp-script-action" },
          speech:
`[–ò–Ω—Ç—Ä–æ]
–î–∞–º –≤–∞–º –æ–¥–Ω—É –º–∞–ª–µ–Ω—å–∫—É—é –∑–∞–≥–∞–¥–∫—É‚Ä¶

[–£—Å–ª–æ–≤–∏—è]
–í–∞–∂–Ω–æ: –≤—ã –≤—Å—ë –∫–æ–Ω—Ç—Ä–æ–ª–∏—Ä—É–µ—Ç–µ. –Ø ‚Äî –Ω–µ—Ç.

[–ù–∞—Ä–∞—â–∏–≤–∞–Ω–∏–µ]
–°–º–æ—Ç—Ä–∏—Ç–µ –≤–Ω–∏–º–∞—Ç–µ–ª—å–Ω–æ‚Ä¶ —Å–µ–π—á–∞—Å –±—É–¥–µ—Ç –º–æ–º–µ–Ω—Ç, –≥–¥–µ –º–æ–∑–≥ —Å–¥–∞—ë—Ç—Å—è.

[–ö—É–ª—å–º–∏–Ω–∞—Ü–∏—è]
–°–µ–π—á–∞—Å. –ü—Ä—è–º–æ. –ó–¥–µ—Å—å.

[–§–∏–Ω–∞–ª]
–í–æ—Ç –ø–æ—á–µ–º—É –º–∞–≥–∏—è ‚Äî —ç—Ç–æ –Ω–µ —Ç—Ä—é–∫. –≠—Ç–æ –≤—ã–±–æ—Ä –≤–∏–¥–µ—Ç—å –Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ–µ.`,
          action:
`[–ò–Ω—Ç—Ä–æ]
‚Äî –í—ã—Ö–æ–∂—É –≤ —Ü–µ–Ω—Ç—Ä. –ü–∞—É–∑–∞ 1 —Å–µ–∫. –ö–æ–Ω—Ç–∞–∫—Ç –≥–ª–∞–∑–∞–º–∏.

[–£—Å–ª–æ–≤–∏—è]
‚Äî –ú–µ–¥–ª–µ–Ω–Ω–æ –ø–æ–∫–∞–∑—ã–≤–∞—é —Ä–µ–∫–≤–∏–∑–∏—Ç. –ß–∏—Å—Ç—ã–µ —Ä—É–∫–∏.

[–ù–∞—Ä–∞—â–∏–≤–∞–Ω–∏–µ]
‚Äî –¢–µ–º–ø 70%. –ü–∞—É–∑—ã –ø–æ—Å–ª–µ –∫–∞–∂–¥–æ–π —Ñ—Ä–∞–∑—ã.

[–ö—É–ª—å–º–∏–Ω–∞—Ü–∏—è]
‚Äî –†–µ–∑–∫–∏–π ‚Äú–∫–ª–∏–∫‚Äù –¥–µ–π—Å—Ç–≤–∏–µ–º + —Ç–∏—à–∏–Ω–∞.

[–§–∏–Ω–∞–ª]
‚Äî –£–ª—ã–±–∫–∞. –®–∞–≥ –Ω–∞–∑–∞–¥. –î–∞—Ç—å –∑—Ä–∏—Ç–µ–ª—è–º —Å–µ–∫—É–Ω–¥—É ‚Äú–ø–µ—Ä–µ–≤–∞—Ä–∏—Ç—å‚Äù.`
        })
      },
      script_comedy: {
        title: "Comedy beat",
        apply: () => ({
          title: "Comedy: ‚Ä¶",
          fields: { speech: "inp-script-speech", action: "inp-script-action" },
          speech:
`[Setup]
–Ø —Å–µ–π—á–∞—Å –ø–æ–∫–∞–∂—É —Ñ–æ–∫—É—Å. –û–Ω –±–µ–∑–æ–ø–∞—Å–Ω—ã–π‚Ä¶ –ø–æ—á—Ç–∏.

[First laugh]
–ï—Å–ª–∏ —á—Ç–æ ‚Äî –¥–µ–ª–∞–µ–º –≤–∏–¥, —á—Ç–æ —Ç–∞–∫ –∏ –±—ã–ª–æ –∑–∞–¥—É–º–∞–Ω–æ.

[Escalation]
–°–º–æ—Ç—Ä–∏—Ç–µ: –≤—ã –¥—É–º–∞–µ—Ç–µ, —á—Ç–æ –∫–æ–Ω—Ç—Ä–æ–ª–∏—Ä—É–µ—Ç–µ —Å–∏—Ç—É–∞—Ü–∏—é‚Ä¶

[Twist]
‚Ä¶–∞ —Å–∏—Ç—É–∞—Ü–∏—è –¥—É–º–∞–µ—Ç –∏–Ω–∞—á–µ.

[Tag]
–ê–ø–ª–æ–¥–∏—Å–º–µ–Ω—Ç—ã ‚Äî —ç—Ç–æ –∫–∞–∫ —á–∞–µ–≤—ã–µ. –ù–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ, –Ω–æ –ø—Ä–∏—è—Ç–Ω–æ.`,
          action:
`‚Äî –£–≤–µ—Ä–µ–Ω–Ω–∞—è —Å—Ç–æ–π–∫–∞.
‚Äî –ù–∞ ‚Äú–ø–æ—á—Ç–∏‚Äù ‚Äî –º–∏–∫—Ä–æ-–ø–∞—É–∑–∞ –∏ –≤–∑–≥–ª—è–¥ –≤ –∑–∞–ª.
‚Äî –ù–∞ ‚Äú–∏–Ω–∞—á–µ‚Äù ‚Äî —Ñ–∏–∑–∏—á–µ—Å–∫–∏–π –∞–∫—Ü–µ–Ω—Ç (–∂–µ—Å—Ç/–ø–æ–≤–æ—Ä–æ—Ç/—Å–º–µ–Ω–∞ –ø–ª–∞–Ω–∞).
‚Äî –í —Ñ–∏–Ω–∞–ª–µ ‚Äî –ø–∞—É–∑–∞, –¥–∞—Ç—å —Å–º–µ—Ö—É –ø—Ä–æ–π—Ç–∏.`
        })
      },
      script_stage: {
        title: "–°—Ü–µ–Ω–∞ (—Å—Ç—Ä—É–∫—Ç—É—Ä–∞)",
        apply: () => ({
          title: "–°—Ü–µ–Ω–∞: ‚Ä¶",
          fields: { speech: "inp-script-speech", action: "inp-script-action" },
          speech:
`[–û—Ç–∫—Ä—ã—Ç–∏–µ]
–î–æ–±—Ä—ã–π –≤–µ—á–µ—Ä! –°–µ–≥–æ–¥–Ω—è –º—ã –ø—Ä–æ–≤–µ—Ä–∏–º: —Ä–µ–∞–ª—å–Ω–æ—Å—Ç—å ‚Äî —ç—Ç–æ –¥–æ–≥–æ–≤–æ—Ä.

[–í–æ–≤–ª–µ—á–µ–Ω–∏–µ]
–ú–Ω–µ –Ω—É–∂–µ–Ω –æ–¥–∏–Ω —Å–º–µ–ª—ã–π —á–µ–ª–æ–≤–µ–∫‚Ä¶ (–∏ –æ–¥–∏–Ω —Ç–µ—Ä–ø–µ–ª–∏–≤—ã–π).

[–ü—Ä–∞–≤–∏–ª–∞]
–ù–∏—á–µ–≥–æ –Ω–µ –ø—Ä—è—á–µ–º. –í—ã –≤—Å—ë –≤–∏–¥–∏—Ç–µ. –ò –≤—Å—ë —Ä–∞–≤–Ω–æ ‚Äî –Ω–µ –ø–æ–π–º—ë—Ç–µ.

[–ú–æ–º–µ–Ω—Ç]
–°–µ–π—á–∞—Å –±—É–¥–µ—Ç —Ç–æ, —á—Ç–æ –ø–æ—Ç–æ–º –≤—ã –±—É–¥–µ—Ç–µ –≤—Å–ø–æ–º–∏–Ω–∞—Ç—å –Ω–æ—á—å—é.

[–ó–∞–∫—Ä—ã—Ç–∏–µ]
–ï—Å–ª–∏ –≤–∞–º –∫–∞–∂–µ—Ç—Å—è, —á—Ç–æ —ç—Ç–æ –Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ ‚Äî –≤—ã –ø—Ä–∞–≤—ã.`,
          action:
`‚Äî –°–≤–µ—Ç: —Ü–µ–Ω—Ç—Ä.
‚Äî –í—ã–∑–æ–≤ –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞: —É–≤–µ—Ä–µ–Ω–Ω–æ, –±–µ–∑ —Å—É–µ—Ç—ã.
‚Äî –ü—Ä–∞–≤–∏–ª–∞: —Ç–µ–º–ø –º–µ–¥–ª–µ–Ω–Ω—ã–π, —è—Å–Ω—ã–µ –∂–µ—Å—Ç—ã.
‚Äî ‚Äú–ú–æ–º–µ–Ω—Ç‚Äù: –ø–∞—É–∑–∞, –∞–∫—Ü–µ–Ω—Ç, –ø–æ–≤–æ—Ä–æ—Ç –∫ –∑–∞–ª—É.
‚Äî –ó–∞–∫—Ä—ã—Ç–∏–µ: –ø–æ–∫–ª–æ–Ω, —à–∞–≥ –Ω–∞–∑–∞–¥.`
        })
      },
      secret_structure: {
        title: "–°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Å–µ–∫—Ä–µ—Ç–∞",
        apply: () => ({
          title: "–°–µ–∫—Ä–µ—Ç: ‚Ä¶",
          field: "inp-secret",
          text:
`# –ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç (—Å—É—Ö–æ)
‚Äî ‚Ä¶

# –ö–ª—é—á–µ–≤–æ–π –ø—Ä–∏–Ω—Ü–∏–ø
‚Äî ‚Ä¶

# –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞
‚Äî ‚Ä¶

# –ò—Å–ø–æ–ª–Ω–µ–Ω–∏–µ (–ø–æ —à–∞–≥–∞–º)
1) ‚Ä¶
2) ‚Ä¶
3) ‚Ä¶

# –£–≥–ª—ã / —Å–≤–µ—Ç / –¥–∏—Å—Ç–∞–Ω—Ü–∏—è
‚Äî ‚Ä¶

# Fail-safe (–µ—Å–ª–∏ –ø–æ—à–ª–æ –Ω–µ —Ç–∞–∫)
‚Äî ‚Ä¶

# –ß—Ç–æ –ù–ï –≥–æ–≤–æ—Ä–∏—Ç—å –∑—Ä–∏—Ç–µ–ª—é
‚Äî ‚Ä¶`
        })
      },
      check_micro: {
        title: "–ß–µ–∫-–ª–∏—Å—Ç: –ú–∏–∫—Ä–æ-—à–æ—É",
        applyChecklist: () => ([
          { text:"–ö–æ–ª–æ–¥–∞/–ø–æ–¥–≥–æ—Ç–æ–≤–∫–∞ (—Å—Ç–µ–∫/—Ñ–æ—Ä—Å/–¥—É–ø–ª–∏–∫–∞—Ç—ã)", checked:false },
          { text:"–ú–æ–Ω–µ—Ç—ã/–≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ/–º–∞–≥–Ω–∏—Ç (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)", checked:false },
          { text:"–†–µ–∑–∏–Ω–∫–∏/–Ω–∏—Ç—å/–∫–ª–∏–ø—Å–∞", checked:false },
          { text:"–°–∞–ª—Ñ–µ—Ç–∫–∏/–º–∞—Ä–∫–µ—Ä/–±–ª–æ–∫–Ω–æ—Ç", checked:false },
          { text:"–ó–∞–ø–∞—Å–Ω–æ–π ‚Äú–±—ã—Å—Ç—Ä—ã–π —ç—Ñ—Ñ–µ–∫—Ç‚Äù (–Ω–∞ –æ—Ç–∫–∞–∑ –∑—Ä–∏—Ç–µ–ª—è)", checked:false },
          { text:"–ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–∞—Ä–º–∞–Ω–æ–≤: –ø–æ—Ä—è–¥–æ–∫ —Å–ª–µ–≤–∞‚Üí–ø—Ä–∞–≤–æ", checked:false }
        ])
      },
      check_stage: {
        title: "–ß–µ–∫-–ª–∏—Å—Ç: –°—Ü–µ–Ω–∞",
        applyChecklist: () => ([
          { text:"–ó–≤—É–∫: –º–∏–∫—Ä–æ—Ñ–æ–Ω/–ø–µ—Ç–ª—è/–∑–∞–ø–∞—Å –±–∞—Ç–∞—Ä–µ–π–∫–∏", checked:false },
          { text:"–°–≤–µ—Ç: –∫–æ–Ω—Ç—Ä–æ–ª—å –±–ª–∏–∫–æ–≤/—Ç–µ–Ω–µ–π", checked:false },
          { text:"–†–µ–∫–≤–∏–∑–∏—Ç: –æ—Å–Ω–æ–≤–Ω–æ–π + –¥—É–±–ª—å –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö –¥–µ—Ç–∞–ª–µ–π", checked:false },
          { text:"–¢–æ—á–∫–∞ –≤—ã—Ö–æ–¥–∞/—É—Ö–æ–¥–∞ —Å–æ —Å—Ü–µ–Ω—ã", checked:false },
          { text:"–ê—Å—Å–∏—Å—Ç–µ–Ω—Ç/–≤–æ–ª–æ–Ω—Ç—ë—Ä: —Å—Ü–µ–Ω–∞—Ä–∏–π –æ–±—â–µ–Ω–∏—è", checked:false },
          { text:"–ú—É–∑—ã–∫–∞/—Ç–∞–π–º–∏–Ω–≥: —Å—Ç–∞—Ä—Ç/—Å—Ç–æ–ø/—Ñ–∏–Ω–∞–ª", checked:false }
        ])
      },
      check_before_go: {
        title: "–ß–µ–∫-–ª–∏—Å—Ç: –ü–µ—Ä–µ–¥ –≤—ã—Ö–æ–¥–æ–º",
        applyChecklist: () => ([
          { text:"–í–æ–¥–∞/–¥—ã—Ö–∞–Ω–∏–µ 10 —Ü–∏–∫–ª–æ–≤", checked:false },
          { text:"–†—É–∫–∏: —Å—É—Ö–∏–µ/—á–∏—Å—Ç—ã–µ", checked:false },
          { text:"–ö–∞—Ä–º–∞–Ω—ã: –ø–æ—Ä—è–¥–æ–∫ 1‚Äì2‚Äì3", checked:false },
          { text:"–§–∏–Ω–∞–ª—å–Ω–∞—è —Ñ—Ä–∞–∑–∞/–ø–æ—Å–ª–µ–¥–Ω–∏–π –±–∏—Ç –≤ –≥–æ–ª–æ–≤–µ", checked:false },
          { text:"–ü–ª–∞–Ω B –Ω–∞ —Å–ª—É—á–∞–π —Å–±–æ—è", checked:false }
        ])
      }
    };

    function currentTemplateKeys(){
      if(editorType === "idea") return ["idea_basic","idea_presentation","idea_risks"];
      if(editorType === "script") return ["script_classic","script_comedy","script_stage"];
      if(editorType === "secret") return ["secret_structure"];
      if(editorType === "checklist") return ["check_micro","check_stage","check_before_go"];
      return [];
    }

    function buildTemplatePopover(){
      const list = document.getElementById("templates-list");
      if(!list) return;
      list.innerHTML = "";

      const keys = currentTemplateKeys();
      keys.forEach(k => {
        const t = TEMPLATES[k];
        const btn = document.createElement("button");
        btn.className = "w-full text-left px-3 py-2 rounded-xl hover:bg-white/5 transition";
        btn.innerHTML = `
          <div class="flex items-start gap-2">
            <i data-lucide="sparkles" class="w-4 h-4 text-amber-400 mt-[2px]"></i>
            <div>
              <div class="text-xs font-semibold text-slate-200">${escapeHtml(t.title)}</div>
              <div class="text-[10px] text-slate-500">–í—Å—Ç–∞–≤–∏—Ç—å</div>
            </div>
          </div>
        `;
        btn.onclick = () => { window.applyTemplate(k); closeTemplatePopover(); };
        list.appendChild(btn);
      });

      lucide.createIcons();
    }

    window.toggleTemplatePopover = () => {
      const pop = document.getElementById("templates-popover");
      const isOpen = pop.classList.contains("show");
      if(isOpen) closeTemplatePopover();
      else {
        buildTemplatePopover();
        pop.classList.add("show");
      }
      haptic(6);
    }

    function closeTemplatePopover(){
      document.getElementById("templates-popover").classList.remove("show");
    }

    window.applyTemplateQuick = () => {
      const keys = currentTemplateKeys();
      if(!keys.length){ toast("–î–ª—è —ç—Ç–æ–≥–æ —Ç–∏–ø–∞ –Ω–µ—Ç —à–∞–±–ª–æ–Ω–æ–≤.", "warn"); return; }
      window.applyTemplate(keys[0]);
    }

    window.applyTemplate = (key) => {
      const tpl = TEMPLATES[key];
      if(!tpl) return;

      if(editorType === "checklist"){
        const items = tpl.applyChecklist ? tpl.applyChecklist() : [];
        const hasData = tempChecklist.length > 0;
        if(hasData && !safeConfirm("–ß–µ–∫-–ª–∏—Å—Ç –Ω–µ –ø—É—Å—Ç–æ–π. –ó–∞–º–µ–Ω–∏—Ç—å —à–∞–±–ª–æ–Ω–æ–º?")) return;
        tempChecklist = items;
        renderChecklist();
        scheduleDraftSave();
        toast("–®–∞–±–ª–æ–Ω —á–µ–∫-–ª–∏—Å—Ç–∞ –ø—Ä–∏–º–µ–Ω—ë–Ω.", "ok");
        haptic(10);
        return;
      }

      if(tpl.apply){
        const pack = tpl.apply();

        const titleEl = document.getElementById("inp-title");
        if(titleEl.value.trim() === "" && pack.title) titleEl.value = pack.title;

        if(pack.field){
          const el = document.getElementById(pack.field);
          const hasText = (el.value || "").trim().length > 0;
          if(hasText && !safeConfirm("–ü–æ–ª–µ —É–∂–µ –∑–∞–ø–æ–ª–Ω–µ–Ω–æ. –ó–∞–º–µ–Ω–∏—Ç—å —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ —à–∞–±–ª–æ–Ω–æ–º?")) return;
          el.value = pack.text || "";
        }

        if(pack.fields){
          const sEl = document.getElementById(pack.fields.speech);
          const aEl = document.getElementById(pack.fields.action);

          const has = ((sEl.value||"").trim().length>0) || ((aEl.value||"").trim().length>0);
          if(has && !safeConfirm("–°—Ü–µ–Ω–∞—Ä–∏–π —É–∂–µ –∑–∞–ø–æ–ª–Ω–µ–Ω. –ó–∞–º–µ–Ω–∏—Ç—å —à–∞–±–ª–æ–Ω–æ–º?")) return;

          sEl.value = pack.speech || "";
          aEl.value = pack.action || "";
        }

        scheduleDraftSave();
        toast("–®–∞–±–ª–æ–Ω –ø—Ä–∏–º–µ–Ω—ë–Ω.", "ok");
        haptic(10);
      }
    }

    document.addEventListener("click", (e) => {
      const pop = document.getElementById("templates-popover");
      const btn = document.getElementById("btn-templates");
      if(!pop.classList.contains("show")) return;
      if(pop.contains(e.target) || btn.contains(e.target)) return;
      closeTemplatePopover();
    });

    /**********************
     * SEARCH bind
     **********************/
    function bindSearch(){
      const inp = document.getElementById("search-input");
      inp.addEventListener("input", () => {
        clearTimeout(searchDebounce);
        searchDebounce = setTimeout(() => window.renderNotes(), 120);
      });
    }

    /**********************
     * BG particles
     **********************/
    function initParticles(){
      const canvas = document.getElementById("bg-canvas");
      const ctx = canvas.getContext("2d");

      const resize = () => { canvas.width = innerWidth; canvas.height = innerHeight; };
      resize();
      addEventListener("resize", resize);

      let particles = [];
      for(let i=0;i<44;i++){
        particles.push({
          x:Math.random()*canvas.width,
          y:Math.random()*canvas.height,
          size:Math.random()*2.2+0.2,
          spX:Math.random()*0.35-0.175,
          spY:Math.random()*0.35-0.175,
          op:Math.random()*0.45+0.05
        });
      }

      function animate(){
        ctx.clearRect(0,0,canvas.width,canvas.height);
        particles.forEach(p=>{
          p.x+=p.spX; p.y+=p.spY;
          if(p.x<0||p.x>canvas.width) p.spX*=-1;
          if(p.y<0||p.y>canvas.height) p.spY*=-1;
          ctx.beginPath(); ctx.arc(p.x,p.y,p.size,0,Math.PI*2);
          ctx.fillStyle=`rgba(245,158,11,${p.op})`;
          ctx.fill();
        });
        requestAnimationFrame(animate);
      }
      animate();
    }

    /**********************
     * INIT
     **********************/
    document.addEventListener("DOMContentLoaded", () => {
      loadPinMeta();
      loadViewMode();
      loadNotes();
      initParticles();
      bindSearch();
      buildTemplatePopover();

      window.setCategory("cards");
      lucide.createIcons();
    });
  </script>
</body>
</html>