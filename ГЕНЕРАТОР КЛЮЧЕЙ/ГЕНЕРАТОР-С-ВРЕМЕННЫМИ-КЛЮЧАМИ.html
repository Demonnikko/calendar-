<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>üîë –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä –∫–ª—é—á–µ–π Firebase - Illusionist OS</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, sans-serif;
      background: linear-gradient(135deg, #0a0a0f 0%, #1a1a2e 100%);
      color: #f8fafc;
      min-height: 100vh;
      padding: 20px;
    }
    
    .container {
      max-width: 1400px;
      margin: 0 auto;
    }
    
    .header {
      background: rgba(26,26,46,0.95);
      border: 2px solid rgba(245,158,11,0.3);
      border-radius: 16px;
      padding: 24px;
      margin-bottom: 20px;
      text-align: center;
    }
    
    h1 {
      font-size: 32px;
      background: linear-gradient(135deg, #f59e0b, #fbbf24);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      margin-bottom: 8px;
    }
    
    .subtitle {
      color: rgba(148,163,184,0.8);
      font-size: 14px;
    }
    
    .main-grid {
      display: grid;
      grid-template-columns: 400px 1fr;
      gap: 20px;
    }
    
    @media (max-width: 1024px) {
      .main-grid {
        grid-template-columns: 1fr;
      }
    }
    
    .panel {
      background: rgba(26,26,46,0.95);
      border: 2px solid rgba(245,158,11,0.3);
      border-radius: 16px;
      padding: 24px;
    }
    
    .panel-title {
      color: #f59e0b;
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .form-group {
      margin-bottom: 16px;
    }
    
    label {
      display: block;
      color: rgba(148,163,184,0.9);
      font-size: 13px;
      margin-bottom: 6px;
      font-weight: 500;
    }
    
    input {
      width: 100%;
      padding: 12px;
      background: rgba(0,0,0,0.3);
      border: 1px solid rgba(245,158,11,0.2);
      border-radius: 8px;
      color: #fff;
      font-size: 14px;
    }
    
    input:focus {
      outline: none;
      border-color: rgba(245,158,11,0.5);
    }
    
    input:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    button {
      width: 100%;
      padding: 14px;
      background: linear-gradient(135deg, #f59e0b, #fbbf24);
      border: none;
      border-radius: 8px;
      color: #0a0a0f;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.2s;
      margin-bottom: 12px;
    }
    
    button:active {
      transform: scale(0.98);
    }
    
    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none !important;
    }
    
    button.secondary {
      background: rgba(245,158,11,0.2);
      color: #f59e0b;
    }
    
    button.danger {
      background: rgba(239,68,68,0.2);
      color: #ef4444;
    }
    
    .key-display {
      background: rgba(0,0,0,0.3);
      border: 1px solid rgba(245,158,11,0.3);
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 16px;
      min-height: 80px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-family: 'Courier New', monospace;
      font-size: 20px;
      font-weight: bold;
      color: #f59e0b;
      letter-spacing: 2px;
      word-break: break-all;
      text-align: center;
    }
    
    .stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 12px;
      margin-bottom: 20px;
    }
    
    .stat-card {
      background: rgba(0,0,0,0.3);
      border: 1px solid rgba(245,158,11,0.2);
      border-radius: 8px;
      padding: 16px;
      text-align: center;
    }
    
    .stat-value {
      font-size: 32px;
      font-weight: bold;
      color: #f59e0b;
      margin-bottom: 4px;
    }
    
    .stat-label {
      font-size: 12px;
      color: rgba(148,163,184,0.7);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
    }
    
    th {
      background: rgba(0,0,0,0.3);
      padding: 12px;
      text-align: left;
      color: #f59e0b;
      font-size: 13px;
      border-bottom: 2px solid rgba(245,158,11,0.3);
      position: sticky;
      top: 0;
    }
    
    td {
      padding: 12px;
      border-bottom: 1px solid rgba(245,158,11,0.1);
      font-size: 13px;
    }
    
    tr:hover {
      background: rgba(245,158,11,0.05);
    }
    
    .status-badge {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 600;
    }
    
    .status-active {
      background: rgba(34,197,94,0.2);
      color: #22c55e;
    }
    
    .status-pending {
      background: rgba(234,179,8,0.2);
      color: #eab308;
    }
    
    .alert {
      background: rgba(245,158,11,0.1);
      border: 2px solid rgba(245,158,11,0.3);
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 20px;
    }
    
    .alert.error {
      background: rgba(239,68,68,0.1);
      border-color: rgba(239,68,68,0.3);
    }
    
    .alert.success {
      background: rgba(34,197,94,0.1);
      border-color: rgba(34,197,94,0.3);
    }
    
    .alert-title {
      color: #f59e0b;
      font-weight: 600;
      margin-bottom: 8px;
      font-size: 15px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .alert.error .alert-title {
      color: #ef4444;
    }
    
    .alert.success .alert-title {
      color: #22c55e;
    }
    
    .alert-text {
      color: rgba(148,163,184,0.9);
      font-size: 13px;
      line-height: 1.5;
    }
    
    .table-container {
      max-height: 600px;
      overflow-y: auto;
      border-radius: 8px;
    }
    
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: rgba(148,163,184,0.5);
    }
    
    .empty-state-icon {
      font-size: 48px;
      margin-bottom: 16px;
    }
    
    code {
      background: rgba(0,0,0,0.5);
      padding: 2px 6px;
      border-radius: 4px;
      font-family: 'Courier New', monospace;
      font-size: 12px;
      color: #fbbf24;
    }
    
    hr {
      border: none;
      border-top: 1px solid rgba(245,158,11,0.2);
      margin: 24px 0;
    }
  </style>
  
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>üîë –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä –∫–ª—é—á–µ–π Firebase</h1>
      <div class="subtitle">–°–æ–∑–¥–∞–Ω–∏–µ –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ª–∏—Ü–µ–Ω–∑–∏–æ–Ω–Ω—ã–º–∏ –∫–ª—é—á–∞–º–∏ –¥–ª—è Illusionist OS</div>
    </div>

    <!-- –°—Ç–∞—Ç—É—Å Firebase -->
    <div class="alert" id="firebase-status">
      <div class="alert-title">‚öôÔ∏è –°—Ç–∞—Ç—É—Å Firebase</div>
      <div class="alert-text" id="firebase-status-text">
        –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è...
      </div>
    </div>

    <div class="main-grid">
      <!-- –õ–µ–≤–∞—è –ø–∞–Ω–µ–ª—å - —Å–æ–∑–¥–∞–Ω–∏–µ –∫–ª—é—á–∞ -->
      <div>
        <div class="panel">
          <div class="panel-title">üìù –ù–æ–≤—ã–π –∫–ª—é—á</div>
          
          <div class="form-group">
            <label>–ò–º—è –ø–æ–∫—É–ø–∞—Ç–µ–ª—è *</label>
            <input type="text" id="buyerName" placeholder="–ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤">
          </div>

          <div class="form-group">
            <label>–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ *</label>
            <input type="text" id="appName" placeholder="–ö–∞–ª–µ–Ω–¥–∞—Ä—å Premium">
          </div>

          <div class="form-group">
            <label>Email</label>
            <input type="email" id="buyerEmail" placeholder="ivan@example.com">
          </div>
          
          <div class="form-group">
            <label>–¢–µ–ª–µ—Ñ–æ–Ω</label>
            <input type="tel" id="buyerPhone" placeholder="+7 900 123-45-67">
          </div>
          
          <div class="form-group">
            <label>–°—É–º–º–∞ –æ–ø–ª–∞—Ç—ã</label>
            <input type="text" id="paymentAmount" placeholder="3500" value="3500">
          </div>
          
          <div class="form-group">
            <label>‚è∞ –°—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è –∫–ª—é—á–∞</label>
            <select id="licenseExpiry" style="width: 100%; padding: 12px; background: rgba(0,0,0,0.3); border: 1px solid rgba(245,158,11,0.2); border-radius: 8px; color: #fff; font-size: 14px;">
              <option value="30">30 –¥–Ω–µ–π (–º–µ—Å—è—Ü)</option>
              <option value="90">90 –¥–Ω–µ–π (3 –º–µ—Å—è—Ü–∞)</option>
              <option value="180">180 –¥–Ω–µ–π (6 –º–µ—Å—è—Ü–µ–≤)</option>
              <option value="365" selected>365 –¥–Ω–µ–π (–≥–æ–¥)</option>
              <option value="730">730 –¥–Ω–µ–π (2 –≥–æ–¥–∞)</option>
              <option value="999999">–ë–µ—Å—Å—Ä–æ—á–Ω—ã–π</option>
            </select>
          </div>
          
          <button onclick="generateKey()" id="generateBtn">üéØ –°–æ–∑–¥–∞—Ç—å –∫–ª—é—á</button>
          
          <div class="key-display" id="keyDisplay">–ö–ª—é—á –ø–æ—è–≤–∏—Ç—Å—è –∑–¥–µ—Å—å</div>
          
          <button class="secondary" id="copyKeyBtn" style="display:none;" onclick="copyKey()">üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å –∫–ª—é—á</button>
          
          <hr>
          
          <div class="panel-title" style="font-size: 15px; margin-top: 0;">üíæ –†–µ–∑–µ—Ä–≤–Ω–æ–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ</div>
          <button class="secondary" onclick="exportDatabase()">üì§ –≠–∫—Å–ø–æ—Ä—Ç –±–∞–∑—ã (JSON)</button>
          <button class="secondary" onclick="importDatabase()">üì• –ò–º–ø–æ—Ä—Ç –±–∞–∑—ã</button>
          <input type="file" id="importFile" accept=".json" style="display:none;" onchange="handleImportFile(event)">
        </div>
      </div>

      <!-- –ü—Ä–∞–≤–∞—è –ø–∞–Ω–µ–ª—å - —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏ —Å–ø–∏—Å–æ–∫ -->
      <div>
        <div class="stats">
          <div class="stat-card">
            <div class="stat-value" id="totalCount">-</div>
            <div class="stat-label">–í—Å–µ–≥–æ –∫–ª—é—á–µ–π</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="activeCount">-</div>
            <div class="stat-label">–ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–æ</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="pendingCount">-</div>
            <div class="stat-label">–û–∂–∏–¥–∞—é—Ç</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="totalRevenue">-</div>
            <div class="stat-label">–û–±—â–∏–π –¥–æ—Ö–æ–¥</div>
          </div>
        </div>

        <div class="panel">
          <div class="panel-title">
            üìä –õ–∏—Ü–µ–Ω–∑–∏–∏
            <button class="secondary" onclick="refreshLicenses()" style="width: auto; padding: 8px 16px; margin: 0 0 0 auto; font-size: 13px;">üîÑ –û–±–Ω–æ–≤–∏—Ç—å</button>
          </div>

          <div class="form-group" style="margin-bottom: 20px;">
            <label>üîç –ü–æ–∏—Å–∫ –ø–æ —Ñ–∞–º–∏–ª–∏–∏</label>
            <input type="text" id="searchInput" placeholder="–í–≤–µ–¥–∏—Ç–µ —Ñ–∞–º–∏–ª–∏—é –ø–æ–∫—É–ø–∞—Ç–µ–ª—è..." oninput="filterLicenses()">
          </div>

          <div class="table-container">
            <table>
              <thead>
                <tr>
                  <th>–î–∞—Ç–∞</th>
                  <th>–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ</th>
                  <th>–ü–æ–∫—É–ø–∞—Ç–µ–ª—å</th>
                  <th>–ö–ª—é—á</th>
                  <th>–°—Ä–æ–∫</th>
                  <th>–¶–µ–Ω–∞</th>
                  <th>–°—Ç–∞—Ç—É—Å</th>
                  <th>Device ID</th>
                  <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                </tr>
              </thead>
              <tbody id="licensesTable">
                <tr>
                  <td colspan="6" class="empty-state">
                    <div class="empty-state-icon">üîë</div>
                    <div>–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</div>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <!-- –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –ø–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è–º -->
        <div class="panel" style="margin-top: 20px;">
          <div class="panel-title">üìà –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –ø–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è–º</div>
          <div id="appStats" style="display: flex; flex-direction: column; gap: 12px;">
            <div style="color: rgba(148,163,184,0.5); text-align: center; padding: 20px;">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ============================================
    // FIREBASE CONFIGURATION
    // ============================================
    const FIREBASE_CONFIG = {
      apiKey: "AIzaSyBEL4XCzjmHaqu4RbTqNzEKPi2Vfc4LXSI",
      authDomain: "calc76.firebaseapp.com",
      databaseURL: "https://calc76-default-rtdb.firebaseio.com",
      projectId: "calc76",
      storageBucket: "calc76.firebasestorage.app",
      messagingSenderId: "972929668805",
      appId: "1:972929668805:web:de4aa4097f03b97d39c2ac"
    };
    
    let firebaseDB = null;
    let firebaseEnabled = false;
    let currentKey = '';
    let allLicenses = [];
    
    // ============================================
    // –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø
    // ============================================
    async function initFirebase() {
      const statusEl = document.getElementById('firebase-status');
      const statusText = document.getElementById('firebase-status-text');
      
      if (FIREBASE_CONFIG.apiKey === "YOUR_API_KEY_HERE") {
        statusEl.className = 'alert error';
        statusText.innerHTML = `
          <strong>‚ùå Firebase –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω!</strong><br><br>
          –ó–∞–º–µ–Ω–∏—Ç–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –≤ –∫–æ–¥–µ (—Å—Ç—Ä–æ–∫–∏ 333-340).<br>
          –°–º–æ—Ç—Ä–∏—Ç–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—é: <code>–ò–ù–°–¢–†–£–ö–¶–ò–Ø-FIREBASE.md</code>
        `;
        document.getElementById('generateBtn').disabled = true;
        return;
      }
      
      try {
        firebase.initializeApp(FIREBASE_CONFIG);
        firebaseDB = firebase.database();
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ
        await firebaseDB.ref('.info/connected').once('value');
        
        firebaseEnabled = true;
        statusEl.className = 'alert success';
        statusText.innerHTML = `
          <strong>‚úÖ Firebase –ø–æ–¥–∫–ª—é—á—ë–Ω!</strong><br>
          –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö —Ä–∞–±–æ—Ç–∞–µ—Ç. –ú–æ–∂–Ω–æ —Å–æ–∑–¥–∞–≤–∞—Ç—å –∫–ª—é—á–∏.
        `;
        
        // –ó–∞–≥—Ä—É–∂–∞–µ–º –ª–∏—Ü–µ–Ω–∑–∏–∏
        await refreshLicenses();
        
      } catch (error) {
        console.error('Firebase init error:', error);
        statusEl.className = 'alert error';
        statusText.innerHTML = `
          <strong>‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ Firebase!</strong><br>
          ${error.message}<br><br>
          –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∏ –ø—Ä–∞–≤–∏–ª–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏.
        `;
        document.getElementById('generateBtn').disabled = true;
      }
    }
    
    // ============================================
    // –ì–ï–ù–ï–†–ê–¶–ò–Ø –ö–õ–Æ–ß–ê
    // ============================================
    function generateLicenseKey() {
      const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
      let key = '';
      
      for (let i = 0; i < 3; i++) {
        for (let j = 0; j < 4; j++) {
          key += chars[Math.floor(Math.random() * chars.length)];
        }
        if (i < 2) key += '-';
      }
      
      let sum = 0;
      const data = key.replace(/-/g, '');
      for (let i = 0; i < data.length; i++) {
        sum += data.charCodeAt(i);
      }
      
      const check = (sum % 10000).toString(36).toUpperCase().padStart(4, '0');
      key += '-' + check;
      
      return key;
    }
    
    // ============================================
    // –°–û–ó–î–ê–ù–ò–ï –ö–õ–Æ–ß–ê
    // ============================================
    async function generateKey() {
      const name = document.getElementById('buyerName').value.trim();
      const appName = document.getElementById('appName').value.trim();

      if (!name) {
        alert('‚ö†Ô∏è –í–≤–µ–¥–∏—Ç–µ –∏–º—è –ø–æ–∫—É–ø–∞—Ç–µ–ª—è!');
        document.getElementById('buyerName').focus();
        return;
      }

      if (!appName) {
        alert('‚ö†Ô∏è –£–∫–∞–∂–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è!');
        document.getElementById('appName').focus();
        return;
      }

      if (!firebaseEnabled) {
        alert('‚ùå Firebase –Ω–µ –ø–æ–¥–∫–ª—é—á—ë–Ω!\n–ù–∞—Å—Ç—Ä–æ–π—Ç–µ Firebase –¥–ª—è —Ä–∞–±–æ—Ç—ã –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä–∞.');
        return;
      }

      const btn = document.getElementById('generateBtn');
      btn.disabled = true;
      btn.textContent = '‚è≥ –°–æ–∑–¥–∞–Ω–∏–µ...';

      try {
        currentKey = generateLicenseKey();

        const licenseData = {
          key: currentKey,
          appName: appName,
          buyer: {
            name: name,
            email: document.getElementById('buyerEmail').value.trim(),
            phone: document.getElementById('buyerPhone').value.trim()
          },
          payment: document.getElementById('paymentAmount').value.trim() || '3500',
          expiryDays: parseInt(document.getElementById('licenseExpiry').value) || 365,
          created: new Date().toISOString(),
          activated: false,
          deviceId: null,
          installId: null,
          activatedDate: null,
          lastCheck: null
        };
        
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ Firebase
        const keyRef = firebaseDB.ref('licenses/' + currentKey.replace(/[\.#$\[\]]/g, '-'));
        await keyRef.set(licenseData);
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–ª—é—á
        document.getElementById('keyDisplay').textContent = currentKey;
        document.getElementById('copyKeyBtn').style.display = 'block';
        
        // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫
        await refreshLicenses();
        
        // –£—Å–ø–µ—Ö
        btn.textContent = '‚úÖ –ö–ª—é—á —Å–æ–∑–¥–∞–Ω!';
        btn.style.background = 'linear-gradient(135deg, #10b981, #34d399)';
        
        setTimeout(() => {
          btn.textContent = 'üéØ –°–æ–∑–¥–∞—Ç—å –∫–ª—é—á';
          btn.style.background = 'linear-gradient(135deg, #f59e0b, #fbbf24)';
        }, 2000);
        
      } catch (error) {
        console.error('Generate key error:', error);
        alert('‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∫–ª—é—á–∞:\n' + error.message);
        btn.textContent = 'üéØ –°–æ–∑–¥–∞—Ç—å –∫–ª—é—á';
      } finally {
        btn.disabled = false;
      }
    }
    
    // ============================================
    // –ö–û–ü–ò–†–û–í–ê–ù–ò–ï –ö–õ–Æ–ß–ê
    // ============================================
    function copyKey() {
      navigator.clipboard.writeText(currentKey).then(() => {
        const btn = document.getElementById('copyKeyBtn');
        const originalText = btn.textContent;
        btn.textContent = '‚úÖ –°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!';
        setTimeout(() => {
          btn.textContent = originalText;
        }, 2000);
      });
    }
    
    // ============================================
    // –û–ë–ù–û–í–õ–ï–ù–ò–ï –°–ü–ò–°–ö–ê –õ–ò–¶–ï–ù–ó–ò–ô
    // ============================================
    async function refreshLicenses() {
      if (!firebaseEnabled) return;

      try {
        const snapshot = await firebaseDB.ref('licenses').once('value');
        const licenses = snapshot.val() || {};

        const licensesArray = Object.values(licenses);
        allLicenses = licensesArray;
        
        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
        document.getElementById('totalCount').textContent = licensesArray.length;
        document.getElementById('activeCount').textContent = licensesArray.filter(l => l.activated).length;
        document.getElementById('pendingCount').textContent = licensesArray.filter(l => !l.activated).length;

        // –ü–æ–¥—Å—á–∏—Ç—ã–≤–∞–µ–º –æ–±—â–∏–π –¥–æ—Ö–æ–¥
        const totalRevenue = licensesArray.reduce((sum, l) => sum + (parseInt(l.payment) || 0), 0);
        document.getElementById('totalRevenue').textContent = `${totalRevenue.toLocaleString('ru-RU')} ‚ÇΩ`;

        // –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –ø–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è–º
        const appStatsData = {};
        licensesArray.forEach(l => {
          const appName = l.appName || '–ù–µ —É–∫–∞–∑–∞–Ω–æ';
          if(!appStatsData[appName]) {
            appStatsData[appName] = { count: 0, revenue: 0, activated: 0 };
          }
          appStatsData[appName].count++;
          appStatsData[appName].revenue += parseInt(l.payment) || 0;
          if(l.activated) appStatsData[appName].activated++;
        });

        const appStatsHTML = Object.keys(appStatsData).length > 0
          ? Object.entries(appStatsData)
              .sort((a, b) => b[1].revenue - a[1].revenue)
              .map(([app, stats]) => `
                <div style="background: rgba(0,0,0,0.3); border: 1px solid rgba(245,158,11,0.2); border-radius: 12px; padding: 16px;">
                  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                    <div style="font-weight: 600; color: #f59e0b; font-size: 15px;">${app}</div>
                    <div style="font-weight: 700; color: #22c55e; font-size: 16px;">${stats.revenue.toLocaleString('ru-RU')} ‚ÇΩ</div>
                  </div>
                  <div style="display: flex; gap: 16px; font-size: 13px; color: rgba(148,163,184,0.8);">
                    <div>–ü—Ä–æ–¥–∞–Ω–æ: <span style="color: #fff; font-weight: 600;">${stats.count}</span></div>
                    <div>–ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–æ: <span style="color: #22c55e; font-weight: 600;">${stats.activated}</span></div>
                  </div>
                </div>
              `).join('')
          : '<div style="color: rgba(148,163,184,0.5); text-align: center; padding: 20px;">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</div>';

        document.getElementById('appStats').innerHTML = appStatsHTML;

        // –û—Ç—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º —Ç–∞–±–ª–∏—Ü—É
        renderLicensesTable(licensesArray);

      } catch (error) {
        console.error('Refresh licenses error:', error);
        alert('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ª–∏—Ü–µ–Ω–∑–∏–π:\n' + error.message);
      }
    }

    function renderLicensesTable(licensesArray) {
      const tbody = document.getElementById('licensesTable');

      if (licensesArray.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="9" class="empty-state">
              <div class="empty-state-icon">üîë</div>
              <div>–ö–ª—é—á–µ–π –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</div>
              <div style="font-size: 12px; margin-top: 8px;">–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–æ–∏—Å–∫–∞</div>
            </td>
          </tr>
        `;
        return;
      }

      // –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –¥–∞—Ç–µ —Å–æ–∑–¥–∞–Ω–∏—è (–Ω–æ–≤—ã–µ —Å–≤–µ—Ä—Ö—É)
      licensesArray.sort((a, b) => new Date(b.created) - new Date(a.created));

      tbody.innerHTML = licensesArray.map(license => {
        const date = new Date(license.created);
        const dateStr = date.toLocaleDateString('ru-RU') + ' ' +
                       date.toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' });

        // –§–æ—Ä–º–∏—Ä—É–µ–º —Å—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è
        const expiryDays = license.expiryDays || 365;
        let expiryText = '';
        if (expiryDays >= 999999) {
          expiryText = '‚àû –ë–µ—Å—Å—Ä–æ—á–Ω—ã–π';
        } else if (expiryDays >= 365) {
          const years = Math.floor(expiryDays / 365);
          expiryText = years === 1 ? '1 –≥–æ–¥' : `${years} –≥–æ–¥–∞`;
        } else if (expiryDays >= 30) {
          const months = Math.floor(expiryDays / 30);
          expiryText = `${months} –º–µ—Å`;
        } else {
          expiryText = `${expiryDays} –¥–Ω`;
        }

        const status = license.activated
          ? '<span class="status-badge status-active">‚úÖ –ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω</span>'
          : '<span class="status-badge status-pending">‚è≥ –û–∂–∏–¥–∞–µ—Ç</span>';

        const deviceId = license.deviceId
          ? `<code style="font-size: 10px;">${license.deviceId.substring(0, 12)}...</code>`
          : '<span style="color: rgba(148,163,184,0.5);">-</span>';

        const appName = license.appName || '<span style="color: rgba(148,163,184,0.5);">-</span>';
        const price = license.payment ? `${parseInt(license.payment).toLocaleString('ru-RU')} ‚ÇΩ` : '<span style="color: rgba(148,163,184,0.5);">-</span>';

        return `
          <tr>
            <td style="white-space: nowrap;">${dateStr}</td>
            <td>${appName}</td>
            <td>${license.buyer.name}</td>
            <td style="font-family: monospace; font-size: 11px;">${license.key}</td>
            <td style="white-space: nowrap;">${expiryText}</td>
            <td style="color: #22c55e; font-weight: 600;">${price}</td>
            <td>${status}</td>
            <td>${deviceId}</td>
            <td>
              <button class="secondary" onclick="editLicense('${license.key}')" style="width: auto; padding: 6px 12px; margin: 0 4px 0 0; font-size: 12px;">‚úèÔ∏è</button>
              <button class="danger" onclick="deleteLicense('${license.key}')" style="width: auto; padding: 6px 12px; margin: 0; font-size: 12px;">üóëÔ∏è</button>
            </td>
          </tr>
        `;
      }).join('');
    }

    function filterLicenses() {
      const searchValue = document.getElementById('searchInput').value.toLowerCase().trim();

      if (!searchValue) {
        // –ï—Å–ª–∏ –ø–æ–∏—Å–∫ –ø—É—Å—Ç–æ–π - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—Å–µ
        renderLicensesTable(allLicenses);
        return;
      }

      // –§–∏–ª—å—Ç—Ä—É–µ–º –ø–æ —Ñ–∞–º–∏–ª–∏–∏
      const filtered = allLicenses.filter(license => {
        const buyerName = (license.buyer && license.buyer.name) ? license.buyer.name.toLowerCase() : '';
        return buyerName.includes(searchValue);
      });

      renderLicensesTable(filtered);
    }
    
    // ============================================
    // –≠–ö–°–ü–û–†–¢/–ò–ú–ü–û–†–¢ (–ª–æ–∫–∞–ª—å–Ω—ã–π –±—ç–∫–∞–ø)
    // ============================================
    async function exportDatabase() {
      if (!firebaseEnabled) {
        alert('‚ùå Firebase –Ω–µ –ø–æ–¥–∫–ª—é—á—ë–Ω!');
        return;
      }
      
      try {
        const snapshot = await firebaseDB.ref('licenses').once('value');
        const licenses = snapshot.val() || {};
        
        if (Object.keys(licenses).length === 0) {
          alert('‚ö†Ô∏è –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –ø—É—Å—Ç–∞! –ù–µ—á–µ–≥–æ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å.');
          return;
        }
        
        const exportData = {
          version: '2.0-firebase',
          exported: new Date().toISOString(),
          totalLicenses: Object.keys(licenses).length,
          licenses: licenses
        };
        
        const jsonStr = JSON.stringify(exportData, null, 2);
        const blob = new Blob([jsonStr], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        
        const a = document.createElement('a');
        a.href = url;
        a.download = `illusionist-firebase-backup-${new Date().toISOString().split('T')[0]}.json`;
        a.click();
        
        URL.revokeObjectURL(url);
        
        alert(`‚úÖ –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–∞!\n\n–í—Å–µ–≥–æ –∑–∞–ø–∏—Å–µ–π: ${Object.keys(licenses).length}\n\n–§–∞–π–ª —Å–æ—Ö—Ä–∞–Ω—ë–Ω –≤ Downloads.`);
        
      } catch (error) {
        console.error('Export error:', error);
        alert('‚ùå –û—à–∏–±–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞:\n' + error.message);
      }
    }
    
    function importDatabase() {
      alert('‚ö†Ô∏è –ò–º–ø–æ—Ä—Ç –¥–ª—è Firebase –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω.\n\n–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ Firebase Console –¥–ª—è –∏–º–ø–æ—Ä—Ç–∞ –¥–∞–Ω–Ω—ã—Ö.');
    }
    
    function handleImportFile(event) {
      // Reserved for future implementation
    }

    // ============================================
    // –†–ï–î–ê–ö–¢–ò–†–û–í–ê–ù–ò–ï –õ–ò–¶–ï–ù–ó–ò–ò
    // ============================================
    async function editLicense(key) {
      if (!firebaseEnabled) {
        alert('‚ùå Firebase –Ω–µ –ø–æ–¥–∫–ª—é—á—ë–Ω!');
        return;
      }

      try {
        const keyRef = firebaseDB.ref('licenses/' + key.replace(/[\.#$\[\]]/g, '-'));
        const snapshot = await keyRef.once('value');
        const license = snapshot.val();

        if (!license) {
          alert('‚ùå –õ–∏—Ü–µ–Ω–∑–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞!');
          return;
        }

        const newAppName = prompt('–ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è:', license.appName || '');
        if (newAppName === null) return;

        const newName = prompt('–ò–º—è –ø–æ–∫—É–ø–∞—Ç–µ–ª—è:', license.buyer.name);
        if (newName === null) return;

        const newEmail = prompt('Email:', license.buyer.email || '');
        if (newEmail === null) return;

        const newPhone = prompt('–¢–µ–ª–µ—Ñ–æ–Ω:', license.buyer.phone || '');
        if (newPhone === null) return;

        await keyRef.update({
          'appName': newAppName.trim() || license.appName,
          'buyer/name': newName.trim() || license.buyer.name,
          'buyer/email': newEmail.trim(),
          'buyer/phone': newPhone.trim()
        });

        await refreshLicenses();
        alert('‚úÖ –î–∞–Ω–Ω—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω—ã!');

      } catch (error) {
        console.error('Edit license error:', error);
        alert('‚ùå –û—à–∏–±–∫–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:\n' + error.message);
      }
    }

    // ============================================
    // –£–î–ê–õ–ï–ù–ò–ï –õ–ò–¶–ï–ù–ó–ò–ò
    // ============================================
    async function deleteLicense(key) {
      if (!firebaseEnabled) {
        alert('‚ùå Firebase –Ω–µ –ø–æ–¥–∫–ª—é—á—ë–Ω!');
        return;
      }

      if (!confirm(`‚ö†Ô∏è –£–¥–∞–ª–∏—Ç—å –∫–ª—é—á ${key}?\n\n–≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å!`)) {
        return;
      }

      try {
        const keyRef = firebaseDB.ref('licenses/' + key.replace(/[\.#$\[\]]/g, '-'));
        await keyRef.remove();
        await refreshLicenses();
        alert('‚úÖ –ö–ª—é—á —É–¥–∞–ª—ë–Ω!');
      } catch (error) {
        console.error('Delete license error:', error);
        alert('‚ùå –û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è:\n' + error.message);
      }
    }

    // ============================================
    // –ó–ê–ü–£–°–ö
    // ============================================
    window.addEventListener('load', () => {
      initFirebase();
    });
  </script>
</body>
</html>
