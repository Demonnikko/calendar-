const { Telegraf, Markup } = require("telegraf");
const { initializeApp } = require("firebase/app");
const { getDatabase, ref, set, get, child } = require("firebase/database");
const fs = require("fs");
const path = require("path");
const { FIREBASE_CONFIG, token, ADMIN_ID } = require("./config");

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Firebase
const firebaseApp = initializeApp(FIREBASE_CONFIG);
const firebaseDB = getDatabase(firebaseApp);

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–æ—Ç–∞
const bot = new Telegraf(token);

// –¢–û–ö–ï–ù –ü–õ–ê–¢–ï–ñ–ù–û–ô –°–ò–°–¢–ï–ú–´ (–ü–æ–ª—É—á–∏—Ç—å –≤ @BotFather -> Payments)
const PAYMENT_TOKEN = "YOUR_PAYMENT_TOKEN_FROM_BOTFATHER";

if (PAYMENT_TOKEN === "YOUR_PAYMENT_TOKEN_FROM_BOTFATHER") {
  console.warn(
    "‚ö†Ô∏è –ü–†–ï–î–£–ü–†–ï–ñ–î–ï–ù–ò–ï: –í—ã –Ω–µ –∑–∞–º–µ–Ω–∏–ª–∏ PAYMENT_TOKEN! –û–ø–ª–∞—Ç–∞ –Ω–µ –±—É–¥–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å, –Ω–æ –±–æ—Ç –∑–∞–ø—É—Å—Ç–∏—Ç—Å—è.",
  );
}

// –°–°–´–õ–ö–ê –ù–ê –í–ê–® MINI APP (–í—Å—Ç–∞–≤—å—Ç–µ —Å—é–¥–∞ —Å—Å—ã–ª–∫—É –∏–∑ GitHub Pages)
const WEB_APP_URL = "https://demonnikko.github.io/botos/";

// --- –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π ---
// –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–∞—Ç–∞–ª–æ–≥ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π –∏–∑ JSON-—Ñ–∞–π–ª–∞
const apps = JSON.parse(
  fs.readFileSync(path.join(__dirname, "products.json"), "utf-8"),
);

// --- –§—É–Ω–∫—Ü–∏—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∫–ª—é—á–∞ ---
function generateLicenseKey() {
  const chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789";
  let key = "";
  for (let i = 0; i < 3; i++) {
    for (let j = 0; j < 4; j++) {
      key += chars[Math.floor(Math.random() * chars.length)];
    }
    if (i < 2) key += "-";
  }
  let sum = 0;
  const data = key.replace(/-/g, "");
  for (let i = 0; i < data.length; i++) {
    sum += data.charCodeAt(i);
  }
  const check = (sum % 10000).toString(36).toUpperCase().padStart(4, "0");
  key += "-" + check;
  return key;
}

// --- –ö–ª–∞–≤–∏–∞—Ç—É—Ä—ã ---
const getMainMenu = () =>
  Markup.inlineKeyboard([
    [Markup.button.webApp("‚ú® –û—Ç–∫—Ä—ã—Ç—å –º–∞–≥–∞–∑–∏–Ω (Mini App)", WEB_APP_URL)],
    [Markup.button.callback("üë§ –ú–æ–π –ø—Ä–æ—Ñ–∏–ª—å", "profile")],
    [Markup.button.callback("üÜò –ü–æ–¥–¥–µ—Ä–∂–∫–∞", "support")],
  ]);

// --- –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–æ–º–∞–Ω–¥ ---
bot.start((ctx) => {
  ctx.replyWithMarkdown(
    "üé© *–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ Illusionist OS*\n\n–≠—Ç–æ —ç–∫–æ—Å–∏—Å—Ç–µ–º–∞ –¥–ª—è –∞—Ä—Ç–∏—Å—Ç–æ–≤.\n\n–í—ã–±–µ—Ä–∏—Ç–µ —Ä–∞–∑–¥–µ–ª:",
    getMainMenu(),
  );
});

// ============================================
// –°–ò–°–¢–ï–ú–ê –£–í–ï–î–û–ú–õ–ï–ù–ò–ô –û–ë –û–®–ò–ë–ö–ê–•
// ============================================
// –°–ø–µ—Ü–∏–∞–ª—å–Ω–∞—è –∫–æ–º–∞–Ω–¥–∞ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –æ—à–∏–±–æ–∫ –∏–∑ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π
// –§–æ—Ä–º–∞—Ç: /app_error <JSON —Å –¥–∞–Ω–Ω—ã–º–∏ –æ—à–∏–±–∫–∏>
bot.command("app_error", async (ctx) => {
  try {
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ —ç—Ç–æ –Ω–µ –ø—Ä–æ—Å—Ç–æ–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—ã—Ç–∞–µ—Ç—Å—è –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –æ—à–∏–±–∫—É –≤—Ä—É—á–Ω—É—é
    const text = ctx.message.text;
    if (!text.includes("{") || !text.includes("}")) {
      return; // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –µ—Å–ª–∏ —ç—Ç–æ –Ω–µ JSON
    }

    // –ü–∞—Ä—Å–∏–º JSON –∏–∑ —Å–æ–æ–±—â–µ–Ω–∏—è
    const jsonMatch = text.match(/\{.*\}/s);
    if (!jsonMatch) return;

    const errorData = JSON.parse(jsonMatch[0]);

    // –§–æ—Ä–º–∏—Ä—É–µ–º –∫—Ä–∞—Å–∏–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è –∞–¥–º–∏–Ω–∞
    let message = "üö® <b>–û–®–ò–ë–ö–ê –í –ö–ê–õ–¨–ö–£–õ–Ø–¢–û–†–ï</b>\n\n";

    if (errorData.type === "js_error") {
      message += `<b>–¢–∏–ø:</b> JavaScript Error\n`;
      message += `<b>–û—à–∏–±–∫–∞:</b> ${errorData.message || "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞"}\n`;
      if (errorData.file) message += `<b>–§–∞–π–ª:</b> ${errorData.file}\n`;
      if (errorData.line) message += `<b>–°—Ç—Ä–æ–∫–∞:</b> ${errorData.line}\n`;
    } else if (errorData.type === "promise_error") {
      message += `<b>–¢–∏–ø:</b> Promise Rejection\n`;
      message += `<b>–ü—Ä–∏—á–∏–Ω–∞:</b> ${errorData.reason || "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ"}\n`;
    }

    if (errorData.userAgent) {
      message += `<b>–£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ:</b> ${errorData.userAgent.substring(0, 100)}...\n`;
    }

    if (errorData.url) {
      message += `<b>URL:</b> ${errorData.url}\n`;
    }

    if (errorData.timestamp) {
      const date = new Date(errorData.timestamp);
      message += `<b>–í—Ä–µ–º—è:</b> ${date.toLocaleString("ru-RU")}\n`;
    }

    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –¢–û–õ–¨–ö–û –∞–¥–º–∏–Ω—É
    if (ADMIN_ID && ADMIN_ID !== 0) {
      await ctx.telegram.sendMessage(ADMIN_ID, message, { parse_mode: "HTML" });
      console.log("‚úÖ Error notification sent to admin:", errorData.message);
    } else {
      console.warn("‚ö†Ô∏è ADMIN_ID –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –≤ config.js! –û—à–∏–±–∫–∞ –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞.");
    }

  } catch (error) {
    console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ app_error:", error);
  }
});

// –ö–æ–º–∞–Ω–¥–∞ –¥–ª—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è —Å–æ–±—ã—Ç–∏–π (–∞–∫—Ç–∏–≤–∞—Ü–∏—è, —Å–æ–∑–¥–∞–Ω–∏–µ –ö–ü –∏ —Ç.–¥.)
bot.command("app_event", async (ctx) => {
  try {
    const text = ctx.message.text;
    if (!text.includes("{") || !text.includes("}")) {
      return;
    }

    const jsonMatch = text.match(/\{.*\}/s);
    if (!jsonMatch) return;

    const eventData = JSON.parse(jsonMatch[0]);

    let message = "üìä <b>–°–û–ë–´–¢–ò–ï –í –ö–ê–õ–¨–ö–£–õ–Ø–¢–û–†–ï</b>\n\n";
    message += `<b>–°–æ–±—ã—Ç–∏–µ:</b> ${eventData.event || "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ"}\n`;

    if (eventData.data) {
      message += `<b>–î–∞–Ω–Ω—ã–µ:</b>\n`;
      Object.entries(eventData.data).forEach(([key, value]) => {
        message += `  ‚Ä¢ ${key}: ${value}\n`;
      });
    }

    if (eventData.timestamp) {
      const date = new Date(eventData.timestamp);
      message += `<b>–í—Ä–µ–º—è:</b> ${date.toLocaleString("ru-RU")}\n`;
    }

    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –¢–û–õ–¨–ö–û –∞–¥–º–∏–Ω—É
    if (ADMIN_ID && ADMIN_ID !== 0) {
      await ctx.telegram.sendMessage(ADMIN_ID, message, { parse_mode: "HTML" });
      console.log("‚úÖ Event notification sent to admin:", eventData.event);
    }

  } catch (error) {
    console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ app_event:", error);
  }
});

// ============================================
// –ê–î–ú–ò–ù –ü–ê–ù–ï–õ–¨
// ============================================

// –ü—Ä–æ–≤–µ—Ä–∫–∞ —á—Ç–æ —ç—Ç–æ –∞–¥–º–∏–Ω
function isAdmin(ctx) {
  return ctx.from.id === ADMIN_ID && ADMIN_ID !== 0;
}

// –°–æ—Å—Ç–æ—è–Ω–∏–µ –¥–ª—è multi-step –¥–∏–∞–ª–æ–≥–æ–≤ –∞–¥–º–∏–Ω–∫–∏
const adminState = {};

// Middleware –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∞–¥–º–∏–Ω–∞
bot.use(async (ctx, next) => {
  // –ï—Å–ª–∏ –∫–æ–º–∞–Ω–¥–∞ –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å admin_ –∏–ª–∏ /admin
  if (ctx.message?.text?.startsWith('/admin') ||
      ctx.callbackQuery?.data?.startsWith('admin_')) {
    if (!isAdmin(ctx)) {
      if (ctx.callbackQuery) {
        await ctx.answerCbQuery('‚ùå –î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω');
      } else {
        await ctx.reply('‚ùå –î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω. –≠—Ç–∞ —Ñ—É–Ω–∫—Ü–∏—è —Ç–æ–ª—å–∫–æ –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞.');
      }
      return;
    }
  }
  return next();
});

// –ö–æ–º–∞–Ω–¥–∞ /admin - –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é
bot.command('admin', async (ctx) => {
  const keyboard = Markup.inlineKeyboard([
    [Markup.button.callback('üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞', 'admin_stats')],
    [Markup.button.callback('üîë –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ª–∏—Ü–µ–Ω–∑–∏—è–º–∏', 'admin_licenses')],
    [Markup.button.callback('üë• –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏', 'admin_users')],
    [Markup.button.callback('üì® –†–∞—Å—Å—ã–ª–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π', 'admin_broadcast')],
  ]);

  await ctx.reply(
    'üîê *–ê–î–ú–ò–ù –ü–ê–ù–ï–õ–¨*\n\n–í—ã–±–µ—Ä–∏—Ç–µ —Ä–∞–∑–¥–µ–ª:',
    { ...keyboard, parse_mode: 'Markdown' }
  );
});

// –í–æ–∑–≤—Ä–∞—Ç –≤ –∞–¥–º–∏–Ω –º–µ–Ω—é
bot.action('admin_menu', async (ctx) => {
  await ctx.answerCbQuery();

  const keyboard = Markup.inlineKeyboard([
    [Markup.button.callback('üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞', 'admin_stats')],
    [Markup.button.callback('üîë –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ª–∏—Ü–µ–Ω–∑–∏—è–º–∏', 'admin_licenses')],
    [Markup.button.callback('üë• –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏', 'admin_users')],
    [Markup.button.callback('üì® –†–∞—Å—Å—ã–ª–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π', 'admin_broadcast')],
  ]);

  await ctx.editMessageText(
    'üîê *–ê–î–ú–ò–ù –ü–ê–ù–ï–õ–¨*\n\n–í—ã–±–µ—Ä–∏—Ç–µ —Ä–∞–∑–¥–µ–ª:',
    { ...keyboard, parse_mode: 'Markdown' }
  );
});

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–∞–Ω–Ω—ã—Ö –æ—Ç Web App
bot.on("web_app_data", async (ctx) => {
  await ctx.replyWithChatAction("typing");
  try {
    const data = JSON.parse(ctx.message.web_app_data.data);
    if (data.action === "buy") {
      const app = apps.find((a) => a.id === data.id);
      if (app) {
        if (PAYMENT_TOKEN === "YOUR_PAYMENT_TOKEN_FROM_BOTFATHER") {
          return ctx.reply(
            "‚ö†Ô∏è –û—à–∏–±–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏: –¢–æ–∫–µ–Ω –æ–ø–ª–∞—Ç—ã –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –≤ –∫–æ–¥–µ –±–æ—Ç–∞. –ó–∞–º–µ–Ω–∏—Ç–µ YOUR_PAYMENT_TOKEN_FROM_BOTFATHER –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã–π —Ç–æ–∫–µ–Ω.",
          );
        }
        return ctx.replyWithInvoice({
          title: app.name,
          description: "–õ–∏—Ü–µ–Ω–∑–∏–æ–Ω–Ω—ã–π –∫–ª—é—á –¥–æ—Å—Ç—É–ø–∞ –∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—é Illusionist OS",
          payload: app.id,
          provider_token: PAYMENT_TOKEN,
          currency: "RUB",
          prices: [{ label: app.name, amount: app.price * 100 }],
        });
      }
    }
  } catch (e) {
    console.error("–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –¥–∞–Ω–Ω—ã—Ö Web App", e);
    ctx.reply(`‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Å—á–µ—Ç–∞: ${e.message}`);
  }
});

// --- –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–Ω–æ–ø–æ–∫ ---
bot.action("menu", (ctx) => {
  ctx.editMessageText(
    "üé© *–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ Illusionist OS*\n\n–≠—Ç–æ —ç–∫–æ—Å–∏—Å—Ç–µ–º–∞ –¥–ª—è –∞—Ä—Ç–∏—Å—Ç–æ–≤.\n\n–í—ã–±–µ—Ä–∏—Ç–µ —Ä–∞–∑–¥–µ–ª:",
    { ...getMainMenu(), parse_mode: "Markdown" },
  );
});

bot.action("catalog", (ctx) => {
  const keyboard = apps.map((app) => [
    Markup.button.callback(app.name, `view_${app.id}`),
  ]);
  keyboard.push([Markup.button.callback("üîô –ù–∞–∑–∞–¥ –≤ –º–µ–Ω—é", "menu")]);
  ctx.editMessageText(
    "üì± *–ö–∞—Ç–∞–ª–æ–≥ Illusionist OS*\n\n–í—ã–±–µ—Ä–∏—Ç–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –¥–ª—è –≤–∞—à–µ–≥–æ –≤—ã—Å—Ç—É–ø–ª–µ–Ω–∏—è:",
    {
      reply_markup: { inline_keyboard: keyboard },
      parse_mode: "Markdown",
    },
  );
});

bot.action(/view_(.+)/, (ctx) => {
  const appId = ctx.match[1];
  const app = apps.find((a) => a.id === appId);
  if (app) {
    // –ë–µ—Ä—ë–º –º–∏–Ω–∏–º–∞–ª—å–Ω—É—é —Ü–µ–Ω—É –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è "–æ—Ç..."
    const minPrice = Math.min(...app.plans.map(p => p.price));

    const text = `*${app.name}*\n\n${app.description}\n\nüíé *–°—Ç–æ–∏–º–æ—Å—Ç—å:* –æ—Ç ${minPrice} ‚ÇΩ`;
    ctx.editMessageText(text, {
      parse_mode: "Markdown",
      reply_markup: {
        inline_keyboard: [
          [Markup.button.callback("üí≥ –ö—É–ø–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É", `plans_${app.id}`)],
          [Markup.button.callback("üîô –ö —Å–ø–∏—Å–∫—É", "catalog")],
        ],
      },
    });
  }
});

// –í—ã–±–æ—Ä –ø–ª–∞–Ω–∞ –ø–æ–¥–ø–∏—Å–∫–∏
bot.action(/plans_(.+)/, (ctx) => {
  const appId = ctx.match[1];
  const app = apps.find((a) => a.id === appId);

  if (app) {
    const buttons = app.plans.map(plan => [
      Markup.button.callback(`${plan.label} ‚Äî ${plan.price} ‚ÇΩ`, `buy_${app.id}_${plan.id}`)
    ]);
    buttons.push([Markup.button.callback("üîô –ù–∞–∑–∞–¥", `view_${app.id}`)]);

    ctx.editMessageText(`üìã *–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∞—Ä–∏—Ñ –¥–ª—è "${app.name}":*`, {
      parse_mode: "Markdown",
      reply_markup: {
        inline_keyboard: buttons
      }
    });
  }
});

bot.action("profile", async (ctx) => {
  const userId = ctx.from.id;
  const dbRef = ref(getDatabase());

  try {
    await ctx.answerCbQuery("–ó–∞–≥—Ä—É–∂–∞—é –≤–∞—à –ø—Ä–æ—Ñ–∏–ª—å...");
    await ctx.replyWithChatAction("typing");

    const snapshot = await get(child(dbRef, `users/${userId}/purchases`));

    let message = `üë§ *–ü—Ä–æ—Ñ–∏–ª—å –∏–ª–ª—é–∑–∏–æ–Ω–∏—Å—Ç–∞*\n\n–ò–º—è: ${ctx.from.first_name}\nID: \`${userId}\`\n\n---`;

    if (snapshot.exists()) {
      message += "\n\n*üõí –í–∞—à–∏ –ø–æ–∫—É–ø–∫–∏:*\n";
      const purchases = snapshot.val();
      Object.values(purchases).forEach((purchase) => {
        message += `\n*${purchase.appName}* (${purchase.planLabel || '–ë–µ–∑ —Ç–∞—Ä–∏—Ñ–∞'})\nüîë –ö–ª—é—á: \`${purchase.key}\`\n*–î–∞—Ç–∞:* ${new Date(purchase.purchaseDate).toLocaleDateString(
          "ru-RU",
        )}\n`;
      });
    } else {
      message += "\n\n–í—ã –µ—â–µ –Ω–∏—á–µ–≥–æ –Ω–µ –ø—Ä–∏–æ–±—Ä–µ–ª–∏. –í—Ä–µ–º—è —ç—Ç–æ –∏—Å–ø—Ä–∞–≤–∏—Ç—å! üòâ";
    }

    await ctx.editMessageText(message, {
      parse_mode: "Markdown",
      reply_markup: {
        inline_keyboard: [[Markup.button.callback("üîô –ù–∞–∑–∞–¥ –≤ –º–µ–Ω—é", "menu")]],
      },
    });
  } catch (error) {
    console.error("Firebase profile read error:", error);
    await ctx.editMessageText("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –≤–∞—à –ø—Ä–æ—Ñ–∏–ª—å. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.", {
      reply_markup: {
        inline_keyboard: [[Markup.button.callback("üîô –ù–∞–∑–∞–¥ –≤ –º–µ–Ω—é", "menu")]],
      },
    });
  }
});

bot.action("support", (ctx) => {
  ctx.editMessageText(
    "üÜò *–ü–æ–¥–¥–µ—Ä–∂–∫–∞*\n\n–ï—Å–ª–∏ —É –≤–∞—Å –≤–æ–∑–Ω–∏–∫–ª–∏ –≤–æ–ø—Ä–æ—Å—ã –ø–æ —É—Å—Ç–∞–Ω–æ–≤–∫–µ –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π, —Å–≤—è–∂–∏—Ç–µ—Å—å —Å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º: @admin_username",
    {
      parse_mode: "Markdown",
      reply_markup: {
        inline_keyboard: [[Markup.button.callback("üîô –ù–∞–∑–∞–¥", "menu")]],
      },
    },
  );
});

bot.action(/buy_(.+)_(.+)/, async (ctx) => {
  await ctx.replyWithChatAction("typing");
  const appId = ctx.match[1];
  const planId = ctx.match[2];

  const app = apps.find((a) => a.id === appId);
  const plan = app ? app.plans.find(p => p.id === planId) : null;

  if (app && plan) {
    if (PAYMENT_TOKEN === "YOUR_PAYMENT_TOKEN_FROM_BOTFATHER") {
      return ctx.reply("‚ö†Ô∏è –ü–†–ï–î–£–ü–†–ï–ñ–î–ï–ù–ò–ï: –û–ø–ª–∞—Ç–∞ –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∞ (—Ç–µ—Å—Ç–æ–≤—ã–π —Ä–µ–∂–∏–º).");
    }

    return ctx.replyWithInvoice({
      title: `${app.name} (${plan.label})`,
      description: `–õ–∏—Ü–µ–Ω–∑–∏–æ–Ω–Ω—ã–π –∫–ª—é—á –¥–æ—Å—Ç—É–ø–∞ –Ω–∞ ${plan.label}`,
      payload: `${app.id}_${plan.id}`, // –ü–µ—Ä–µ–¥–∞–µ–º ID –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –∏ ID –ø–ª–∞–Ω–∞
      provider_token: PAYMENT_TOKEN,
      currency: "RUB",
      prices: [{ label: `${app.name} - ${plan.label}`, amount: plan.price * 100 }],
    });
  }
});


// --- –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–ª–∞—Ç–µ–∂–µ–π ---
bot.on("pre_checkout_query", (ctx) => ctx.answerPreCheckoutQuery(true));

bot.on("successful_payment", async (ctx) => {
  await ctx.replyWithChatAction("typing");
  const payment = ctx.message.successful_payment;

  // –ü–∞—Ä—Å–∏–º payload: "appId_planId"
  const [appId, planId] = payment.invoice_payload.split('_');
  const userId = ctx.from.id;

  const app = apps.find((a) => a.id === appId);
  const plan = app ? app.plans.find(p => p.id === planId) : null;

  if (app && plan) {
    const newKey = generateLicenseKey();
    const purchaseDate = new Date().toISOString();

    // –î–∞–Ω–Ω—ã–µ –¥–ª—è –æ–±—â–µ–π —Ç–∞–±–ª–∏—Ü—ã –ª–∏—Ü–µ–Ω–∑–∏–π
    const licenseData = {
      key: newKey,
      appName: app.name,
      buyer: {
        id: userId,
        firstName: ctx.from.first_name,
        lastName: ctx.from.last_name || "",
        username: ctx.from.username || "",
      },
      payment: payment.total_amount / 100,
      currency: payment.currency,
      expiryDays: plan.duration, // –ë–µ—Ä–µ–º —Å—Ä–æ–∫ –∏–∑ –ø–ª–∞–Ω–∞
      created: purchaseDate,
      activated: false,
      deviceId: null,
      installId: null,
      activatedDate: null,
      lastCheck: null,
      planLabel: plan.label // –°–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ —Ç–∞—Ä–∏—Ñ–∞
    };

    // –î–∞–Ω–Ω—ã–µ –¥–ª—è –ø—Ä–æ—Ñ–∏–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    const userPurchaseData = {
      appName: app.name,
      appId: app.id,
      key: newKey,
      purchaseDate: purchaseDate,
      price: payment.total_amount / 100,
      currency: payment.currency,
      expiryDays: plan.duration,
      planLabel: plan.label
    };

    try {
      // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –≤ –æ–±–µ —Ç–∞–±–ª–∏—Ü—ã –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ
      await Promise.all([
        set(ref(firebaseDB, "licenses/" + newKey.replace(/[.#$[]]/g, "-")), licenseData),
        set(ref(firebaseDB, `users/${userId}/purchases/${newKey.replace(/[.#$[]]/g, "-")}`), userPurchaseData) // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø–æ –∫–ª—é—á—É, —á—Ç–æ–±—ã –º–æ–∂–Ω–æ –±—ã–ª–æ –∏–º–µ—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –ª–∏—Ü–µ–Ω–∑–∏–π –æ–¥–Ω–æ–≥–æ –ø—Ä–æ–¥—É–∫—Ç–∞
      ]);

      let successMessage = `‚úÖ *–û–ø–ª–∞—Ç–∞ –ø—Ä–æ—à–ª–∞ —É—Å–ø–µ—à–Ω–æ!*\n\n`;
      successMessage += `–¢–∞—Ä–∏—Ñ: *${plan.label}*\n`;
      successMessage += `–°–ø–∞—Å–∏–±–æ –∑–∞ –ø–æ–∫—É–ø–∫—É *${app.name}*.\n\n`;
      successMessage += `üîë –í–∞—à –∫–ª—é—á –∞–∫—Ç–∏–≤–∞—Ü–∏–∏:\n\`${newKey}\`\n\n`;
      successMessage += `(–ù–∞–∂–º–∏—Ç–µ –Ω–∞ –∫–ª—é—á, —á—Ç–æ–±—ã —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å)\n\n`;
      successMessage += `‚¨áÔ∏è *–ß—Ç–æ –¥–µ–ª–∞—Ç—å –¥–∞–ª—å—à–µ?*`;

      const keyboard = [];

      // –°—Å—ã–ª–∫–∞ –Ω–∞ –≤–∏–¥–µ–æ-–æ–±—É—á–µ–Ω–∏–µ
      if (app.videoUrl) {
        keyboard.push([Markup.button.url("üéì –°–º–æ—Ç—Ä–µ—Ç—å –æ–±—É—á–µ–Ω–∏–µ", app.videoUrl)]);
      }

      // –°—Å—ã–ª–∫–∞ –Ω–∞ Web App (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ —Å—Ä–∞–∑—É –æ—Ç–∫—Ä—ã—Ç—å)
      if (app.appUrl) {
        keyboard.push([Markup.button.url("üöÄ –û—Ç–∫—Ä—ã—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ", app.appUrl)]);
      } else {
        keyboard.push([Markup.button.webApp("üöÄ –û—Ç–∫—Ä—ã—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ", WEB_APP_URL)]);
      }

      await ctx.replyWithMarkdown(successMessage, Markup.inlineKeyboard(keyboard));

      // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç–æ–≤—É—é –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—é, –µ—Å–ª–∏ –µ—Å—Ç—å
      if (app.training) {
        await ctx.replyWithMarkdown("üìã *–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è:*\n\n" + app.training);
      }

    } catch (error) {
      console.error("Firebase save error:", error);
      ctx.reply("‚ö†Ô∏è –û–ø–ª–∞—Ç–∞ –ø—Ä–æ—à–ª–∞, –Ω–æ –≤–æ–∑–Ω–∏–∫–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∫–ª—é—á–∞. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –Ω–∞–ø–∏—à–∏—Ç–µ –≤ –ø–æ–¥–¥–µ—Ä–∂–∫—É (@admin_username), –º—ã –≤—ã–¥–∞–¥–∏–º –∫–ª—é—á –≤—Ä—É—á–Ω—É—é.");
    }
  }
});


// –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞
bot.launch();
console.log("–ë–æ—Ç —É—Å–ø–µ—à–Ω–æ –∑–∞–ø—É—â–µ–Ω –Ω–∞ Telegraf!");

// –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
bot.catch((err, ctx) => {
  console.log(`Ooops, encountered an error for ${ctx.updateType}`, err);
});

// –í–∫–ª—é—á–∞–µ–º graceful stop
process.once("SIGINT", () => bot.stop("SIGINT"));
process.once("SIGTERM", () => bot.stop("SIGTERM"));